public void start if _resource start
_keystoreSetupPath Script findScript KeyStoreUtils KS_SETUP_SCRIPT if _keystoreSetupPath null throw new CloudRuntimeException String format KeyStoreUtils KS_SETUP_SCRIPT _keystoreCertImportPath Script findScript KeyStoreUtils KS_IMPORT_SCRIPT if _keystoreCertImportPath null throw new CloudRuntimeException String format KeyStoreUtils KS_IMPORT_SCRIPT try _connection start catch final NioConnectionException e s_logger warn e s_logger info while _connection isStartup final String host _shell getNextHost _shell getBackoffAlgorithm waitBeforeRetry _connection new NioClient host _shell getPort _shell getWorkers this
_connection start catch final NioConnectionException e s_logger warn e s_logger info while _connection isStartup final String host _shell getNextHost _shell getBackoffAlgorithm waitBeforeRetry _connection new NioClient host _shell getPort _shell getWorkers this s_logger info host try _connection start catch final NioConnectionException e _connection stop try _connection cleanUp
public void stop final String reason final String detail
public void setId final Long id
setLink null cancelTasks _resource disconnected s_logger info _shell getConnectedHost _inProgress get _connection stop try _connection cleanUp catch final IOException e s_logger warn e while _connection isStartup _shell getBackoffAlgorithm waitBeforeRetry do final String host _shell getNextHost _connection new NioClient host _shell getPort _shell getWorkers this s_logger info host
catch final IOException e s_logger warn e while _connection isStartup _shell getBackoffAlgorithm waitBeforeRetry do final String host _shell getNextHost _connection new NioClient host _shell getPort _shell getWorkers this s_logger info host try _connection start catch final NioConnectionException e s_logger info e _connection stop try _connection cleanUp
boolean requestLogged false Response response null try final Command cmds request getCommands final Answer answers new Answer cmds length for int i i cmds length i final Command cmd cmds i Answer answer try if cmd getContextParam null MDC put cmd getContextParam if s_logger isDebugEnabled if requestLogged final String requestMsg request toString if requestMsg null
if cmd getContextParam null MDC put cmd getContextParam if s_logger isDebugEnabled if requestLogged final String requestMsg request toString if requestMsg null s_logger debug requestMsg requestLogged true s_logger debug cmd toString if cmd CronCommand final CronCommand watch CronCommand cmd scheduleWatch link request long watch getInterval watch getInterval answer new Answer cmd true null else if cmd ShutdownCommand final ShutdownCommand shutdown ShutdownCommand cmd
answer listener processControlRequest request AgentControlCommand cmd if answer null break if answer null s_logger warn cmd toString answer new AgentControlAnswer cmd else if cmd SetupKeyStoreCommand SetupKeyStoreCommand cmd isHandleByAgent answer setupAgentKeystore SetupKeyStoreCommand cmd else if cmd SetupCertificateCommand SetupCertificateCommand cmd isHandleByAgent answer setupAgentCertificate SetupCertificateCommand cmd if Host Type Routing equals _resource getType scheduleServicesRestartTask else if cmd SetupMSListCommand answer setupManagementServerList SetupMSListCommand cmd else
private Answer setupAgentCertificate final SetupCertificateCommand cmd final String certificate cmd getCertificate final String privateKey cmd getPrivateKey final String caCertificates cmd getCaCertificates s_logger debug final File agentFile PropertiesUtil findConfigFile if agentFile null return new Answer cmd false final String keyStoreFile agentFile getParent KeyStoreUtils KS_FILENAME final String certFile agentFile getParent KeyStoreUtils CERT_FILENAME final String privateKeyFile agentFile getParent KeyStoreUtils PKEY_FILENAME final String caCertFile agentFile getParent KeyStoreUtils CACERT_FILENAME try FileUtils writeStringToFile new File certFile certificate Charset defaultCharset FileUtils writeStringToFile new File caCertFile caCertificates Charset defaultCharset
private void processManagementServerList final List String msList final String lbAlgorithm final Long lbCheckInterval if CollectionUtils isNotEmpty msList Strings isNullOrEmpty lbAlgorithm try final String newMSHosts String format StringUtils toCSVList msList IAgentShell hostLbAlgorithmSeparator lbAlgorithm _shell setPersistentProperty null newMSHosts _shell setHosts newMSHosts _shell resetHostCounter
public void processResponse final Response response final Link link final Answer answer response getAnswer if s_logger isDebugEnabled
if null file DOMConfigurator configureAndWatch file getAbsolutePath s_logger info else s_logger error final Class c this getClass _version c getPackage getImplementationVersion if _version null throw new CloudRuntimeException s_logger info _version loadProperties parseCommand args if s_logger isDebugEnabled List String properties Collections list Enumeration String _properties propertyNames for String property properties
Override public void cleanup String macAddr String vmName try if macAddr null return InetAddress inetAddr _vmIpMap remove vmName String ipAddr inetAddr getHostName for Map Entry String String entry _macIpMap entrySet if entry getValue equalsIgnoreCase ipAddr macAddr entry getKey break ipAddr _macIpMap remove macAddr s_logger info macAddr ipAddr inetAddr if ipAddr null _ipAddresses offer ipAddr catch Exception e
Override public boolean validateChecksum if StringUtils isNotBlank checksum int retry boolean valid false try while valid retry retry
Override public boolean validateChecksum if StringUtils isBlank getChecksum CollectionUtils isNotEmpty metalinkChecksums String chk metalinkChecksums get random nextInt metalinkChecksums size setChecksum chk
Override public String startVM String vmName String vnetId String gateway String dns String privateIP String privateMac String privateMask String publicIP String publicMac String publicMask int cpuCount int cpuUtilization long ramSize String localPath String vncPassword if s_logger isInfoEnabled StringBuffer sb new StringBuffer sb append vmName vnetId dns sb append privateIP privateMac privateMask sb append publicIP publicMac publicMask sb append cpuCount cpuUtilization ramSize sb append localPath
private void addRouteToInternalIpOrCidr String localgw String eth1ip String eth1mask String destIpOrCidr
if destIpOrCidr null s_logger debug return if NetUtils isValidIp4 destIpOrCidr NetUtils isValidIp4Cidr destIpOrCidr s_logger warn destIpOrCidr return boolean inSameSubnet false if NetUtils isValidIp4 destIpOrCidr if eth1ip null eth1mask null inSameSubnet NetUtils sameSubnet eth1ip destIpOrCidr eth1mask else s_logger warn eth1ip destIpOrCidr eth1mask else inSameSubnet NetUtils isNetworkAWithinNetworkB destIpOrCidr NetUtils ipAndNetMaskToCidr eth1ip eth1mask if inSameSubnet
else s_logger warn eth1ip destIpOrCidr eth1mask else inSameSubnet NetUtils isNetworkAWithinNetworkB destIpOrCidr NetUtils ipAndNetMaskToCidr eth1ip eth1mask if inSameSubnet s_logger debug destIpOrCidr eth1ip return Script command new Script s_logger command add command add destIpOrCidr command execute command new Script s_logger command add command add destIpOrCidr localgw String result command execute
private void launchConsoleProxy final byte ksBits final String ksPassword final String encryptorPassword final Object resource this s_logger info if _consoleProxyMain null
s_logger info if _consoleProxyMain null s_logger info encryptorPassword _consoleProxyMain new Thread new ManagedContextRunnable Override protected void runInContext try Class consoleProxyClazz Class forName try s_logger info Method method consoleProxyClazz getMethod Properties class Object class byte class String class String class method invoke null _properties resource ksBits ksPassword encryptorPassword catch SecurityException e s_logger error e System exit ExitStatus Error value catch NoSuchMethodException e
_consoleProxyMain new Thread new ManagedContextRunnable Override protected void runInContext try Class consoleProxyClazz Class forName try s_logger info Method method consoleProxyClazz getMethod Properties class Object class byte class String class String class method invoke null _properties resource ksBits ksPassword encryptorPassword catch SecurityException e s_logger error e System exit ExitStatus Error value catch NoSuchMethodException e s_logger error e System exit ExitStatus Error value catch IllegalArgumentException e
Class consoleProxyClazz Class forName try s_logger info Method method consoleProxyClazz getMethod Properties class Object class byte class String class String class method invoke null _properties resource ksBits ksPassword encryptorPassword catch SecurityException e s_logger error e System exit ExitStatus Error value catch NoSuchMethodException e s_logger error e System exit ExitStatus Error value catch IllegalArgumentException e s_logger error e System exit ExitStatus Error value catch IllegalAccessException e
Method method consoleProxyClazz getMethod Properties class Object class byte class String class String class method invoke null _properties resource ksBits ksPassword encryptorPassword catch SecurityException e s_logger error e System exit ExitStatus Error value catch NoSuchMethodException e s_logger error e System exit ExitStatus Error value catch IllegalArgumentException e s_logger error e System exit ExitStatus Error value catch IllegalAccessException e s_logger error e System exit ExitStatus Error value catch InvocationTargetException e
catch IllegalAccessException e s_logger error e System exit ExitStatus Error value catch InvocationTargetException e s_logger error e getTargetException toString e System exit ExitStatus Error value catch final ClassNotFoundException e s_logger error System exit ExitStatus Error value _consoleProxyMain setDaemon true _consoleProxyMain start else s_logger info try
catch InvocationTargetException e s_logger error e getTargetException toString e System exit ExitStatus Error value catch final ClassNotFoundException e s_logger error System exit ExitStatus Error value _consoleProxyMain setDaemon true _consoleProxyMain start else s_logger info try Class consoleProxyClazz Class forName Method methodSetup consoleProxyClazz getMethod String class methodSetup invoke null encryptorPassword
System exit ExitStatus Error value catch final ClassNotFoundException e s_logger error System exit ExitStatus Error value _consoleProxyMain setDaemon true _consoleProxyMain start else s_logger info try Class consoleProxyClazz Class forName Method methodSetup consoleProxyClazz getMethod String class methodSetup invoke null encryptorPassword catch SecurityException e s_logger error e
catch final ClassNotFoundException e s_logger error System exit ExitStatus Error value _consoleProxyMain setDaemon true _consoleProxyMain start else s_logger info try Class consoleProxyClazz Class forName Method methodSetup consoleProxyClazz getMethod String class methodSetup invoke null encryptorPassword catch SecurityException e s_logger error e System exit ExitStatus Error value
_consoleProxyMain setDaemon true _consoleProxyMain start else s_logger info try Class consoleProxyClazz Class forName Method methodSetup consoleProxyClazz getMethod String class methodSetup invoke null encryptorPassword catch SecurityException e s_logger error e System exit ExitStatus Error value catch NoSuchMethodException e s_logger error e System exit ExitStatus Error value
_consoleProxyMain setDaemon true _consoleProxyMain start else s_logger info try Class consoleProxyClazz Class forName Method methodSetup consoleProxyClazz getMethod String class methodSetup invoke null encryptorPassword catch SecurityException e s_logger error e System exit ExitStatus Error value catch NoSuchMethodException e s_logger error e System exit ExitStatus Error value
ConsoleAccessAuthenticationCommand cmd new ConsoleAccessAuthenticationCommand host port vmId sid ticket cmd setReauthenticating isReauthentication ConsoleProxyAuthenticationResult result new ConsoleProxyAuthenticationResult result setSuccess false result setReauthentication isReauthentication try AgentControlAnswer answer getAgentControl sendRequest cmd if answer null ConsoleAccessAuthenticationAnswer authAnswer ConsoleAccessAuthenticationAnswer answer result setSuccess authAnswer succeeded result setHost authAnswer getHost result setPort authAnswer getPort result setTunnelUrl authAnswer getTunnelUrl result setTunnelSession authAnswer getTunnelSession else
ConsoleProxyAuthenticationResult result new ConsoleProxyAuthenticationResult result setSuccess false result setReauthentication isReauthentication try AgentControlAnswer answer getAgentControl sendRequest cmd if answer null ConsoleAccessAuthenticationAnswer authAnswer ConsoleAccessAuthenticationAnswer answer result setSuccess authAnswer succeeded result setHost authAnswer getHost result setPort authAnswer getPort result setTunnelUrl authAnswer getTunnelUrl result setTunnelSession authAnswer getTunnelSession else s_logger error vmId sid catch AgentControlChannelException e
final List Field validFields new ArrayList Field final Account caller CallContext current getCallingAccount for final Field field allFields final Parameter parameterAnnotation field getAnnotation Parameter class final RoleType allowedRoles parameterAnnotation authorized boolean roleIsAllowed true if allowedRoles length roleIsAllowed false for final RoleType allowedRole allowedRoles if allowedRole getAccountType caller getType roleIsAllowed true break if roleIsAllowed validFields add field else
try IpAddress ip null if isPortable ip _networkService allocateIP _accountService getAccount getEntityOwnerId getZoneId getNetworkId getDisplayIp ipAddress else ip _networkService allocatePortableIP _accountService getAccount getEntityOwnerId getZoneId getNetworkId getVpcId if ip null setEntityId ip getId setEntityUuid ip getUuid else throw new ServerApiException ApiErrorCode INTERNAL_ERROR catch ConcurrentOperationException ex s_logger warn ex throw new ServerApiException ApiErrorCode INTERNAL_ERROR ex getMessage catch InsufficientAddressCapacityException ex
Override public void execute s_logger info getVMSnapshotId getEntityId System currentTimeMillis CallContext current setEventDetails this _uuidMgr getUuid VMSnapshot class getVMSnapshotId Snapshot snapshot null try snapshot _snapshotService backupSnapshotFromVmSnapshot getEntityId getVmId getVolumeId getVMSnapshotId if snapshot null SnapshotResponse response _responseGenerator createSnapshotResponse snapshot response setResponseName getCommandName this setResponseObject response else throw new ServerApiException ApiErrorCode INTERNAL_ERROR getVMSnapshotId catch InvalidParameterValueException ex throw ex catch Exception e
catch ResourceUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch ResourceAllocationException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_ALLOCATION_ERROR ex getMessage catch ConcurrentOperationException ex s_logger warn ex throw new ServerApiException ApiErrorCode INTERNAL_ERROR ex getMessage catch InsufficientCapacityException ex StringBuilder message new StringBuilder ex getMessage if ex InsufficientServerCapacityException if InsufficientServerCapacityException ex isAffinityApplied message append s_logger info ex
catch StorageUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch ExecutionException ex s_logger warn ex throw new ServerApiException ApiErrorCode INTERNAL_ERROR ex getMessage catch ResourceUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch ResourceAllocationException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_ALLOCATION_ERROR ex getMessage catch InsufficientCapacityException ex StringBuilder message new StringBuilder ex getMessage if ex InsufficientServerCapacityException
catch StorageUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch ExecutionException ex s_logger warn ex throw new ServerApiException ApiErrorCode INTERNAL_ERROR ex getMessage catch ResourceUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch ResourceAllocationException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_ALLOCATION_ERROR ex getMessage catch InsufficientCapacityException ex StringBuilder message new StringBuilder ex getMessage if ex InsufficientServerCapacityException
Override public void execute Vpc vpc null try if isStart _vpcService startVpc getEntityId true else s_logger debug ApiConstants START vpc _entityMgr findById Vpc class getEntityId catch ResourceUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch ConcurrentOperationException ex s_logger warn ex throw new ServerApiException ApiErrorCode INTERNAL_ERROR ex getMessage catch InsufficientCapacityException ex
Override public void execute try final boolean result _vpcService restartVpc this if result final SuccessResponse response new SuccessResponse getCommandName setResponseObject response else throw new ServerApiException ApiErrorCode INTERNAL_ERROR catch final ResourceUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch final ConcurrentOperationException ex s_logger warn ex throw new ServerApiException ApiErrorCode INTERNAL_ERROR ex getMessage catch final InsufficientCapacityException ex
setContextPath properties getProperty CONTEXT_PATH setHttpEnable Boolean valueOf properties getProperty HTTP_ENABLE setHttpPort Integer valueOf properties getProperty HTTP_PORT setHttpsEnable Boolean valueOf properties getProperty HTTPS_ENABLE setHttpsPort Integer valueOf properties getProperty HTTPS_PORT setKeystoreFile properties getProperty KEYSTORE_FILE setKeystorePassword properties getProperty KEYSTORE_PASSWORD setWebAppLocation properties getProperty WEBAPP_DIR setAccessLogFile properties getProperty ACCESS_LOG setSessionTimeout Integer valueOf properties getProperty SESSION_TIMEOUT catch final IOException e LOG warn e finally if httpEnable httpsEnable setHttpEnable true
String lines executionResult trim split boolean readingFailedChecks false readingMonitorResults false for String line lines line line trim if line contains readingFailedChecks true readingMonitorResults false else if line contains readingFailedChecks false readingMonitorResults true else if readingFailedChecks readingMonitorResults failingChecks addAll getFailingChecks line else if readingFailedChecks readingMonitorResults monitorResults append line else
private GetRouterMonitorResultsAnswer execute GetRouterMonitorResultsCommand cmd String routerIp cmd getAccessDetail NetworkElementCommand ROUTER_IP String args cmd shouldPerformFreshChecks
public boolean configureHostParams final Map String String params if _params get null String value String params get _eachTimeout Duration standardSeconds NumbersUtil parseLong value if s_logger isDebugEnabled
public boolean configure final String name final Map String Object params throws ConfigurationException _name name _params params String value String params get _sleep NumbersUtil parseInt value value String params get _retry NumbersUtil parseInt value value String params get _port NumbersUtil parseInt value value String params get _eachTimeout Duration standardSeconds NumbersUtil parseInt value int VRScripts VR_SCRIPT_EXEC_TIMEOUT getStandardSeconds if s_logger isDebugEnabled
public boolean connect final String ipAddress int retry int sleep for int i i retry i SocketChannel sch null try if s_logger isDebugEnabled
sch configureBlocking true final InetSocketAddress addr new InetSocketAddress ipAddress _port sch connect addr return true catch final IOException e if s_logger isDebugEnabled s_logger debug ipAddress finally if sch null try sch close catch final IOException e try Thread sleep sleep catch final InterruptedException e
protected List ConfigItem generateConfigItems final ConfigBase configuration final List ConfigItem cfg new LinkedList final String remoteFilename appendUuidToJsonFiles destinationFile if s_logger isDebugEnabled
ByteArrayInputStream byteIn if buffer hasArray byteIn new ByteArrayInputStream buffer array buffer position buffer arrayOffset buffer remaining else byte array new byte buffer limit buffer position buffer get array byteIn new ByteArrayInputStream array ByteBuffer retBuff ByteBuffer allocate length int len try GZIPInputStream in new GZIPInputStream byteIn while len in read byteArrayIn retBuff put byteArrayIn len in close catch IOException e
public void logD String msg boolean logContent if s_logger isDebugEnabled String log log msg logContent Level DEBUG if log null
Override public String generateConfiguration final LoadBalancerConfigCommand lbCmd final List String result new ArrayList String final List String gSection Arrays asList globalSection gSection set lbCmd maxconn final String pipesLine Long toString Long parseLong lbCmd maxconn gSection set pipesLine if s_logger isDebugEnabled for final String s gSection
final List String result new ArrayList String final List String gSection Arrays asList globalSection gSection set lbCmd maxconn final String pipesLine Long toString Long parseLong lbCmd maxconn gSection set pipesLine if s_logger isDebugEnabled for final String s gSection s_logger debug s result addAll gSection result add blankLine final List String dSection Arrays asList defaultsSection if lbCmd keepAliveEnabled dSection set if s_logger isDebugEnabled for final String s dSection
Long bytesRcvd new Long st nextToken long bytesSentAndReceived new long bytesSentAndReceived bytesSent bytesSentAndReceived bytesRcvd answer put publicIp bytesSentAndReceived catch MalformedURLException e1 s_logger info e1 throw new ExecutionException e1 getMessage catch IOException e s_logger debug e throw new ExecutionException e getMessage finally if os null os close if in null
_storageNic2 getNetworkInterface storageNic2 if _privateNic null s_logger warn Enumeration NetworkInterface nics null try nics NetworkInterface getNetworkInterfaces if nics null nics hasMoreElements throw new ConfigurationException catch final SocketException e throw new ConfigurationException while nics hasMoreElements final NetworkInterface nic nics nextElement final String nicName nic getName if nic isVirtual nicName startsWith nicName startsWith nicName startsWith nicName startsWith nicName startsWith nicName contains final String info NetUtils getNicParams nicName
Enumeration NetworkInterface nics null try nics NetworkInterface getNetworkInterfaces if nics null nics hasMoreElements throw new ConfigurationException catch final SocketException e throw new ConfigurationException while nics hasMoreElements final NetworkInterface nic nics nextElement final String nicName nic getName if nic isVirtual nicName startsWith nicName startsWith nicName startsWith nicName startsWith nicName startsWith nicName contains final String info NetUtils getNicParams nicName if info null info null _privateNic nic s_logger info nicName
protected NetworkInterface getNetworkInterface String nicName
status TemplateUploader Status IN_PROGRESS int bytes byte block new byte CHUNK_SIZE boolean done false while done status Status ABORTED if bytes inputStream read block CHUNK_SIZE outputStream write block bytes totalBytes bytes else done true status TemplateUploader Status UPLOAD_FINISHED return totalBytes catch MalformedURLException e status TemplateUploader Status UNRECOVERABLE_ERROR errorString e getMessage
while done status Status ABORTED if bytes inputStream read block CHUNK_SIZE outputStream write block bytes totalBytes bytes else done true status TemplateUploader Status UPLOAD_FINISHED return totalBytes catch MalformedURLException e status TemplateUploader Status UNRECOVERABLE_ERROR errorString e getMessage s_logger error errorString catch IOException e status TemplateUploader Status UNRECOVERABLE_ERROR errorString e getMessage
private void checkCredentials String user String password try Pair String Integer hostAndPort UriUtils validateUrl downloadUrl if user null password null client getParams setAuthenticationPreemptive true Credentials defaultcreds new UsernamePasswordCredentials user password client getState setCredentials new AuthScope hostAndPort first hostAndPort second AuthScope ANY_REALM defaultcreds
Override public long download boolean resume DownloadCompleteCallback callback if skipDownloadOnStatus return int bytes File file new File toFile try long localFileSize checkLocalFileSizeForResume resume file Date start new Date if checkServerResponse localFileSize return if tryAndGetRemoteSize return if canHandleDownloadSize return checkAndSetDownloadSize try InputStream in request getResponseBodyAsStream RandomAccessFile out new RandomAccessFile file out seek localFileSize
private boolean canHandleDownloadSize if remoteSize maxTemplateSizeInBytes
private long checkLocalFileSizeForResume boolean resume File file long localFileSize if file exists resume localFileSize file length
Override public FormatInfo process String templatePath ImageFormat format String templateName long processTimeout if format null
Override public FormatInfo process String templatePath ImageFormat format String templateName long processTimeout throws InternalErrorException if format null if s_logger isInfoEnabled
s_logger info templatePath templateName String templateFilePath templatePath File separator templateName ImageFormat OVA getFileExtension if _storage exists templateFilePath if s_logger isInfoEnabled s_logger info templateFilePath return null s_logger info templatePath templateName String templateFileFullPath templatePath File separator templateName ImageFormat OVA getFileExtension File templateFile new File templateFileFullPath Script command new Script processTimeout s_logger command add command add command add templateFileFullPath command setWorkDir templateFile getParent String result command execute
s_logger warn templatePath result command new Script s_logger command add templatePath result command execute if result null s_logger warn templatePath result FormatInfo info new FormatInfo info format ImageFormat OVA info filename templateName ImageFormat OVA getFileExtension info size _storage getSize templateFilePath info virtualSize getTemplateVirtualSize templatePath info filename String ovfFile getOVFFilePath templateFileFullPath try OVFHelper ovfHelper new OVFHelper List DatadiskTO disks ovfHelper getOVFVolumeInfo ovfFile
public long getTemplateVirtualSize String templatePath String templateName throws InternalErrorException long virtualSize String templateFileFullPath templatePath endsWith File separator templatePath templatePath File separator templateFileFullPath templateName endsWith ImageFormat OVA getFileExtension templateName templateName ImageFormat OVA getFileExtension String ovfFileName getOVFFilePath templateFileFullPath if ovfFileName null String msg templatePath
String ovfFileName getOVFFilePath templateFileFullPath if ovfFileName null String msg templatePath s_logger error msg throw new InternalErrorException msg try Document ovfDoc null ovfDoc DocumentBuilderFactory newInstance newDocumentBuilder parse new File ovfFileName Element disk Element ovfDoc getElementsByTagName item virtualSize Long parseLong disk getAttribute String allocationUnits disk getAttribute virtualSize OVFHelper getDiskVirtualSize virtualSize allocationUnits ovfFileName return virtualSize catch Exception e String msg templatePath templateName e
Element file Element files item j if file getAttribute equals diskName fileSize Long parseLong file getAttribute fileId file getAttribute break for int i i disks getLength i Element disk Element disks item i if disk getAttribute equals fileId virtualSize Long parseLong disk getAttribute String allocationUnits disk getAttribute virtualSize OVFHelper getDiskVirtualSize virtualSize allocationUnits ovfFilePath break return new Pair Long Long virtualSize fileSize catch Exception e String msg ovfFilePath diskName e
Override public FormatInfo process String templatePath ImageFormat format String templateName long processTimeout throws InternalErrorException if format null
if format null s_logger debug format return null String qcow2Path templatePath File separator templateName ImageFormat QCOW2 getFileExtension if _storage exists qcow2Path s_logger debug qcow2Path return null FormatInfo info new FormatInfo info format ImageFormat QCOW2 info filename templateName ImageFormat QCOW2 getFileExtension File qcow2File _storage getFile qcow2Path info size _storage getSize qcow2Path try info virtualSize getTemplateVirtualSize qcow2File catch IOException e
Override public FormatInfo process String templatePath ImageFormat format String templateName long processTimeout throws InternalErrorException if format null
status Status UNRECOVERABLE_ERROR return else remoteSize Long parseLong contentLengthHeader getValue if remoteSize maxTemplateSizeInByte errorString downloadUrl remoteSize maxTemplateSizeInByte LOGGER warn errorString status Status UNRECOVERABLE_ERROR return InputStream inputStream try inputStream new BufferedInputStream getMethod getResponseBodyAsStream catch IOException e errorString downloadUrl LOGGER warn errorString
PutObjectRequest putObjectRequest new PutObjectRequest s3TO getBucketName s3Key inputStream objectMetadata if s3TO isEnableRRS putObjectRequest withStorageClass StorageClass ReducedRedundancy Upload upload S3Utils putObject s3TO putObjectRequest upload addProgressListener new ProgressListener Override public void progressChanged ProgressEvent progressEvent totalBytes progressEvent getBytesTransferred LOGGER trace downloadUrl s3TO getBucketName toHumanReadableSize totalBytes new Date getTime start getTime if progressEvent getEventType ProgressEventType TRANSFER_STARTED_EVENT status Status IN_PROGRESS else if progressEvent getEventType ProgressEventType TRANSFER_COMPLETED_EVENT status Status DOWNLOAD_FINISHED else if progressEvent getEventType ProgressEventType TRANSFER_CANCELED_EVENT status Status ABORTED else if progressEvent getEventType ProgressEventType TRANSFER_FAILED_EVENT
Override public FormatInfo process String templatePath ImageFormat format String templateName long processTimeout if format null
try FileInputStream strm new FileInputStream _file _props load strm catch IOException e s_logger warn _file e for ImageFormat format ImageFormat values String currentExtension format getFileExtension String ext _props getProperty currentExtension if ext null if s_logger isDebugEnabled s_logger debug currentExtension _file FormatInfo info new FormatInfo info format format info filename _props getProperty currentExtension if info filename null if s_logger isDebugEnabled
catch IOException e s_logger warn _file e for ImageFormat format ImageFormat values String currentExtension format getFileExtension String ext _props getProperty currentExtension if ext null if s_logger isDebugEnabled s_logger debug currentExtension _file FormatInfo info new FormatInfo info format format info filename _props getProperty currentExtension if info filename null if s_logger isDebugEnabled s_logger debug currentExtension _file continue
FormatInfo info new FormatInfo info format format info filename _props getProperty currentExtension if info filename null if s_logger isDebugEnabled s_logger debug currentExtension _file continue if s_logger isDebugEnabled s_logger debug currentExtension _file info size NumbersUtil parseLong _props getProperty currentExtension _props setProperty Long toString info size info virtualSize NumbersUtil parseLong _props getProperty currentExtension _formats add info if checkFormatValidity info _isCorrupted true
if info filename null if s_logger isDebugEnabled s_logger debug currentExtension _file continue if s_logger isDebugEnabled s_logger debug currentExtension _file info size NumbersUtil parseLong _props getProperty currentExtension _props setProperty Long toString info size info virtualSize NumbersUtil parseLong _props getProperty currentExtension _formats add info if checkFormatValidity info _isCorrupted true s_logger warn format else if s_logger isDebugEnabled
public boolean addFormat FormatInfo newInfo deleteFormat newInfo format if checkFormatValidity newInfo s_logger warn
Override public FormatInfo process String templatePath ImageFormat format String templateName long processTimeout throws InternalErrorException if format null
if format null s_logger debug format return null String vhdPath templatePath File separator templateName ImageFormat VHD getFileExtension if _storage exists vhdPath s_logger debug vhdPath return null File vhdFile _storage getFile vhdPath FormatInfo info new FormatInfo info format ImageFormat VHD info filename templateName ImageFormat VHD getFileExtension info size _storage getSize vhdPath try info virtualSize getTemplateVirtualSize vhdFile catch IOException e
Override public FormatInfo process String templatePath ImageFormat format String templateName long processTimeout throws InternalErrorException if format null if s_logger isInfoEnabled
public long getTemplateVirtualSize String templatePath String templateName throws InternalErrorException long virtualSize String templateFileFullPath templatePath endsWith File separator templatePath templatePath File separator templateFileFullPath templateName endsWith ImageFormat VMDK getFileExtension templateName templateName ImageFormat VMDK getFileExtension try FileReader fileReader new FileReader templateFileFullPath BufferedReader bufferedReader new BufferedReader fileReader Pattern regex Pattern compile String line null while line bufferedReader readLine null Matcher m regex matcher line if m find long sectors Long parseLong m group virtualSize sectors break catch FileNotFoundException ex String msg templateFileFullPath ex toString
try FileReader fileReader new FileReader templateFileFullPath BufferedReader bufferedReader new BufferedReader fileReader Pattern regex Pattern compile String line null while line bufferedReader readLine null Matcher m regex matcher line if m find long sectors Long parseLong m group virtualSize sectors break catch FileNotFoundException ex String msg templateFileFullPath ex toString s_logger error msg throw new InternalErrorException msg catch IOException ex String msg templateFileFullPath ex toString
public void testLogging s_logger info GetHostStatsCommand cmd3 new GetHostStatsCommand Request sreq new Request new Command cmd3 true true sreq setSequence Logger logger Logger getLogger GsonHelper class Level level logger getLevel logger setLevel Level DEBUG String log sreq log true Level DEBUG assert log null log sreq log false Level DEBUG assert log null logger setLevel Level TRACE log sreq log true Level TRACE assert log contains GetHostStatsCommand class getSimpleName
protected synchronized void cancel final long seq if s_logger isDebugEnabled
protected void cancelAllCommands final Status state final boolean cancelActive if cancelActive final Set Map Entry Long Listener entries _waitForList entrySet final Iterator Map Entry Long Listener it entries iterator while it hasNext final Map Entry Long Listener entry it next it remove final Listener monitor entry getValue if s_logger isDebugEnabled
s_logger debug log seq req getManagementServerId synchronized this try if isClosed throw new AgentUnavailableException _name _id if req executeInSequence _currentSequence null req logD _currentSequence true addRequest req return req logD true send req if req executeInSequence _currentSequence null _currentSequence seq if s_logger isTraceEnabled s_logger trace log seq
catch final InterruptedException e s_logger debug log seq if answers null if s_logger isDebugEnabled new Response req answers logD false return answers answers sl getAnswers if answers null if s_logger isDebugEnabled new Response req answers logD true _agentMgr notifyAnswersToMonitors _id seq answers return answers final Long current _currentSequence if current null seq current if s_logger isDebugEnabled
if answers null if s_logger isDebugEnabled new Response req answers logD false return answers answers sl getAnswers if answers null if s_logger isDebugEnabled new Response req answers logD true _agentMgr notifyAnswersToMonitors _id seq answers return answers final Long current _currentSequence if current null seq current if s_logger isDebugEnabled s_logger debug log seq throw new OperationTimedoutException req getCommands _id seq wait false
protected synchronized void sendNext final long seq _currentSequence null if _requests isEmpty if s_logger isDebugEnabled
Override public boolean configure final String name final Map String Object params throws ConfigurationException s_logger info mgmtServiceConf getPingTimeout final int threads DirectAgentLoadSize value _nodeId ManagementServerNode getManagementServerId
Override public boolean configure final String name final Map String Object params throws ConfigurationException s_logger info mgmtServiceConf getPingTimeout final int threads DirectAgentLoadSize value _nodeId ManagementServerNode getManagementServerId s_logger info _nodeId final long lastPing System currentTimeMillis mgmtServiceConf getTimeout _hostDao markHostsAsDisconnected _nodeId lastPing registerForHostEvents new BehindOnPingListener true true false registerForHostEvents new SetHostParamsListener true true false _executor new ThreadPoolExecutor threads threads 60l TimeUnit SECONDS new LinkedBlockingQueue Runnable new NamedThreadFactory _connectExecutor new ThreadPoolExecutor 60l TimeUnit SECONDS new LinkedBlockingQueue Runnable new NamedThreadFactory _connectExecutor allowCoreThreadTimeOut true _connection new NioServer Port value Workers value this caService
s_logger info mgmtServiceConf getPingTimeout final int threads DirectAgentLoadSize value _nodeId ManagementServerNode getManagementServerId s_logger info _nodeId final long lastPing System currentTimeMillis mgmtServiceConf getTimeout _hostDao markHostsAsDisconnected _nodeId lastPing registerForHostEvents new BehindOnPingListener true true false registerForHostEvents new SetHostParamsListener true true false _executor new ThreadPoolExecutor threads threads 60l TimeUnit SECONDS new LinkedBlockingQueue Runnable new NamedThreadFactory _connectExecutor new ThreadPoolExecutor 60l TimeUnit SECONDS new LinkedBlockingQueue Runnable new NamedThreadFactory _connectExecutor allowCoreThreadTimeOut true _connection new NioServer Port value Workers value this caService s_logger info Port value Workers value _directAgentExecutor new ScheduledThreadPoolExecutor DirectAgentPoolSize value new NamedThreadFactory _cronJobExecutor new ScheduledThreadPoolExecutor DirectAgentPoolSize value new NamedThreadFactory
Override public void unregisterForHostEvents final int id
protected Status investigate final AgentAttache agent final Long hostId agent getId final HostVO host _hostDao findById hostId if host null host getType null host getType isVirtual if s_logger isDebugEnabled
public void removeAgent final AgentAttache attache final Status nextState if attache null return final long hostId attache getId if s_logger isDebugEnabled s_logger debug hostId AgentAttache removed null boolean conflict false synchronized _agents removed _agents remove hostId if removed null removed attache conflict true _agents put hostId removed removed attache if conflict
final HostVO host _hostDao findById hostId for final Pair Integer Listener monitor _hostMonitors if s_logger isDebugEnabled s_logger debug monitor second getClass getSimpleName for int i i cmd length i try monitor second processConnect host cmd i forRebalance catch final Exception e if e ConnectionException final ConnectionException ce ConnectionException e if ce isSetupError s_logger warn monitor second getClass getSimpleName hostId e getMessage handleDisconnectWithoutInvestigation attache Event AgentDisconnected true true throw ce else
monitor second processConnect host cmd i forRebalance catch final Exception e if e ConnectionException final ConnectionException ce ConnectionException e if ce isSetupError s_logger warn monitor second getClass getSimpleName hostId e getMessage handleDisconnectWithoutInvestigation attache Event AgentDisconnected true true throw ce else s_logger info monitor second getClass getSimpleName hostId e getMessage handleDisconnectWithoutInvestigation attache Event ShutdownRequested true true return attache else if e HypervisorVersionChangedException handleDisconnectWithoutInvestigation attache Event ShutdownRequested true true throw new CloudRuntimeException attache getId e
protected boolean loadDirectlyConnectedHost final HostVO host final boolean forRebalance boolean initialized false ServerResource resource null try final Discoverer discoverer _resourceMgr getMatchingDiscover host getHypervisorType if discoverer null
protected AgentAttache createAttacheForDirectConnect final Host host final ServerResource resource throws ConnectionException
protected boolean handleDisconnectWithoutInvestigation final AgentAttache attache final Status Event event final boolean transitState final boolean removeAgent final long hostId attache getId
final HostVO host _hostDao findById hostId if host null s_logger warn hostId nextStatus Status Removed else final Status currentStatus host getStatus if currentStatus Status Down currentStatus Status Alert currentStatus Status Removed if s_logger isDebugEnabled s_logger debug hostId currentStatus nextStatus currentStatus else try nextStatus currentStatus getNextStatus event catch final NoTransitionException e final String err event currentStatus hostId
nextStatus Status Removed else final Status currentStatus host getStatus if currentStatus Status Down currentStatus Status Alert currentStatus Status Removed if s_logger isDebugEnabled s_logger debug hostId currentStatus nextStatus currentStatus else try nextStatus currentStatus getNextStatus event catch final NoTransitionException e final String err event currentStatus hostId s_logger debug err throw new CloudRuntimeException err if s_logger isDebugEnabled
final Status currentStatus host getStatus if currentStatus Status Down currentStatus Status Alert currentStatus Status Removed if s_logger isDebugEnabled s_logger debug hostId currentStatus nextStatus currentStatus else try nextStatus currentStatus getNextStatus event catch final NoTransitionException e final String err event currentStatus hostId s_logger debug err throw new CloudRuntimeException err if s_logger isDebugEnabled s_logger debug hostId nextStatus currentStatus caService purgeHostCertificate host
try nextStatus host getStatus getNextStatus event catch final NoTransitionException ne s_logger debug ne if nextStatus Status Alert s_logger info hostId event Status determinedState investigate attache if determinedState null if System currentTimeMillis host getLastPinged AlertWait value s_logger warn hostId AlertWait AlertWait value determinedState Status Alert else s_logger warn hostId return false final Status currentStatus host getStatus
final Status currentStatus host getStatus s_logger info hostId determinedState if determinedState Status Down final String message host getId host getName s_logger error message if host getType Host Type SecondaryStorage host getType Host Type ConsoleProxy _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_HOST host getDataCenterId host getPodId host getId message event Status Event HostDown else if determinedState Status Up s_logger info agentStatusTransitTo host Status Event Ping _nodeId return false else if determinedState Status Disconnected s_logger warn host getId host getName if currentStatus Status Disconnected
else if determinedState Status Disconnected s_logger warn host getId host getName if currentStatus Status Disconnected if System currentTimeMillis host getLastPinged AlertWait value s_logger warn host getId event Status Event WaitedTooLong else s_logger debug host getId return false else if currentStatus Status Up final DataCenterVO dcVO _dcDao findById host getDataCenterId final HostPodVO podVO _podDao findById host getPodId final String hostDesc host getName host getId dcVO getName podVO getName if host getType Host Type SecondaryStorage host getType Host Type ConsoleProxy _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_HOST host getDataCenterId host getPodId hostDesc hostDesc AlertWait
Override public Answer easySend final Long hostId final Command cmd try final Host h _hostDao findById hostId if h null h getRemoved null
Override public Answer easySend final Long hostId final Command cmd try final Host h _hostDao findById hostId if h null h getRemoved null s_logger debug hostId return null final Status status h getStatus if status equals Status Up status equals Status Connecting s_logger debug cmd hostId return null final Answer answer send hostId cmd if answer null s_logger warn return null if s_logger isDebugEnabled answer getDetails null
public boolean executeUserRequest final long hostId final Event event throws AgentUnavailableException if event Event AgentDisconnected if s_logger isDebugEnabled
protected AgentAttache createAttacheForConnect final HostVO host final Link link throws ConnectionException
ReadyCommand ready null try final List String agentMSHostList new ArrayList if startup null startup length final String agentMSHosts startup getMsHostList if Strings isNullOrEmpty agentMSHosts agentMSHostList addAll Arrays asList agentMSHosts split final HostVO host _resourceMgr createHostVOForConnectedAgent startup if host null ready new ReadyCommand host getDataCenterId host getId NumbersUtil enableHumanReadableSizes if indirectAgentLB compareManagementServerList host getId host getDataCenterId agentMSHostList final List String newMSList indirectAgentLB getManagementServerList host getId host getDataCenterId null ready setMsHostList newMSList ready setLbAlgorithm indirectAgentLB getLBAlgorithmName ready setLbCheckInterval indirectAgentLB getLBPreferredHostCheckInterval host getClusterId
final String agentMSHosts startup getMsHostList if Strings isNullOrEmpty agentMSHosts agentMSHostList addAll Arrays asList agentMSHosts split final HostVO host _resourceMgr createHostVOForConnectedAgent startup if host null ready new ReadyCommand host getDataCenterId host getId NumbersUtil enableHumanReadableSizes if indirectAgentLB compareManagementServerList host getId host getDataCenterId agentMSHostList final List String newMSList indirectAgentLB getManagementServerList host getId host getDataCenterId null ready setMsHostList newMSList ready setLbAlgorithm indirectAgentLB getLBAlgorithmName ready setLbCheckInterval indirectAgentLB getLBPreferredHostCheckInterval host getClusterId s_logger debug newMSList attache createAttacheForConnect host link attache notifyMonitorsOfConnection attache startup false catch final Exception e
s_logger debug newMSList attache createAttacheForConnect host link attache notifyMonitorsOfConnection attache startup false catch final Exception e s_logger debug e ready new ReadyCommand null ready setDetails e toString finally if ready null ready new ReadyCommand null try if attache null final Request readyRequest new Request ready false link send readyRequest getBytes else
Override public boolean agentStatusTransitTo final HostVO host final Status Event e final long msId try _agentStatusLock lock if s_logger isDebugEnabled final ResourceState state host getResourceState final StringBuilder msg new StringBuilder msg append append state msg append append e toString msg append append host getId append host getName append
public void pingBy final long agentId if _pingMap replace agentId InaccurateClock getTimeInSeconds null
private void sendCommandToAgents Map Long List Long hostsPerZone Map String String params SetHostParamsCommand cmds new SetHostParamsCommand params for Long zoneId hostsPerZone keySet List Long hostIds hostsPerZone get zoneId for Long hostId hostIds Answer answer easySend hostId cmds if answer null answer getResult
Override public void cancel final long seq if forForward Listener listener getListener seq if listener null listener SynchronousListener SynchronousListener synchronous SynchronousListener listener String peerName synchronous getPeer if peerName null if s_clusteredAgentMgr null
Override public void routeToAgent final byte data throws AgentUnavailableException if s_logger isDebugEnabled
Override public void routeToAgent final byte data throws AgentUnavailableException if s_logger isDebugEnabled s_logger debug log Request getSequence data Request getManagementServerId data if _link null if s_logger isDebugEnabled s_logger debug log Request getSequence data throw new AgentUnavailableException _id try _link send data catch ClosedChannelException e if s_logger isDebugEnabled s_logger debug log Request getSequence data throw new AgentUnavailableException _id catch NullPointerException e if s_logger isDebugEnabled
s_logger debug log seq synchronized this addRequestToTransfer req return if s_clusteredAgentMgr null throw new AgentUnavailableException _id int i SocketChannel ch null boolean error true try while i String peerName s_clusteredAgentMgr findPeer _id if peerName null throw new AgentUnavailableException _id ch s_clusteredAgentMgr connectToPeer peerName ch
if s_clusteredAgentMgr null throw new AgentUnavailableException _id int i SocketChannel ch null boolean error true try while i String peerName s_clusteredAgentMgr findPeer _id if peerName null throw new AgentUnavailableException _id ch s_clusteredAgentMgr connectToPeer peerName ch if ch null if s_logger isDebugEnabled s_logger debug log seq req toString continue
if peerName null throw new AgentUnavailableException _id ch s_clusteredAgentMgr connectToPeer peerName ch if ch null if s_logger isDebugEnabled s_logger debug log seq req toString continue SSLEngine sslEngine s_clusteredAgentMgr getSSLEngine peerName if sslEngine null throw new AgentUnavailableException peerName _id try if s_logger isDebugEnabled s_logger debug log seq req toString peerName if req executeInSequence listener null listener SynchronousListener SynchronousListener synchronous SynchronousListener listener
ch s_clusteredAgentMgr connectToPeer peerName ch if ch null if s_logger isDebugEnabled s_logger debug log seq req toString continue SSLEngine sslEngine s_clusteredAgentMgr getSSLEngine peerName if sslEngine null throw new AgentUnavailableException peerName _id try if s_logger isDebugEnabled s_logger debug log seq req toString peerName if req executeInSequence listener null listener SynchronousListener SynchronousListener synchronous SynchronousListener listener synchronous setPeer peerName Link write ch req toBytes sslEngine
Override public boolean configure final String name final Map String Object xmlParams throws ConfigurationException _peers new HashMap String SocketChannel _sslEngines new HashMap String SSLEngine _nodeId ManagementServerNode getManagementServerId
if s_logger isTraceEnabled s_logger trace final long cutSeconds System currentTimeMillis mgmtServiceConf getTimeout final List HostVO hosts _hostDao findAndUpdateDirectAgentToLoad cutSeconds LoadSize value longValue _nodeId final List HostVO appliances _hostDao findAndUpdateApplianceToLoad cutSeconds _nodeId if hosts null hosts addAll appliances if hosts size s_logger debug hosts size for final HostVO host hosts try final AgentAttache agentattache findAttache host getId if agentattache null if agentattache forForward if s_logger isInfoEnabled
final List HostVO appliances _hostDao findAndUpdateApplianceToLoad cutSeconds _nodeId if hosts null hosts addAll appliances if hosts size s_logger debug hosts size for final HostVO host hosts try final AgentAttache agentattache findAttache host getId if agentattache null if agentattache forForward if s_logger isInfoEnabled s_logger info host removeAgent agentattache Status Disconnected else continue
protected AgentAttache createAttache final long id
Override protected AgentAttache createAttacheForConnect final HostVO host final Link link
Override protected AgentAttache createAttacheForDirectConnect final Host host final ServerResource resource
Override public boolean executeUserRequest final long hostId final Event event throws AgentUnavailableException if event Event AgentDisconnected if s_logger isDebugEnabled
protected static void logD final byte bytes final String msg
protected static void logI final byte bytes final String msg
addr InetAddress getByName ip catch final UnknownHostException e throw new CloudRuntimeException ip SocketChannel ch1 null try ch1 SocketChannel open new InetSocketAddress addr port ch1 configureBlocking false ch1 socket setKeepAlive true ch1 socket setSoTimeout try SSLContext sslContext Link initManagementSSLContext caService sslEngine sslContext createSSLEngine ip port sslEngine setUseClientMode true sslEngine setEnabledProtocols SSLUtils getSupportedProtocols sslEngine getEnabledProtocols sslEngine beginHandshake
SocketChannel ch1 null try ch1 SocketChannel open new InetSocketAddress addr port ch1 configureBlocking false ch1 socket setKeepAlive true ch1 socket setSoTimeout try SSLContext sslContext Link initManagementSSLContext caService sslEngine sslContext createSSLEngine ip port sslEngine setUseClientMode true sslEngine setEnabledProtocols SSLUtils getSupportedProtocols sslEngine getEnabledProtocols sslEngine beginHandshake if Link doHandshake ch1 sslEngine ch1 close throw new IOException String format peerName ip port
Override public boolean stop if _peers null for final SocketChannel ch _peers values try
Override public void onManagementNodeLeft final List extends ManagementServerHost nodeList final long selfNodeId for final ManagementServerHost vo nodeList
Override public void onManagementNodeLeft final List extends ManagementServerHost nodeList final long selfNodeId for final ManagementServerHost vo nodeList s_logger info vo getMsid final long lastPing System currentTimeMillis mgmtServiceConf getTimeout _hostDao markHostsAsDisconnected vo getMsid lastPing outOfBandManagementDao expireServerOwnership vo getMsid haConfigDao expireServerOwnership vo getMsid
else if s_logger isDebugEnabled s_logger debug allMS size allManagedAgents size return if avLoad 0L if s_logger isDebugEnabled s_logger debug avLoad for final ManagementServerHostVO node allMS if node getMsid _nodeId List HostVO hostsToRebalance new ArrayList HostVO for final AgentLoadBalancerPlanner lbPlanner _lbPlanners hostsToRebalance lbPlanner getHostsToRebalance node getMsid avLoad if hostsToRebalance null hostsToRebalance isEmpty break
s_logger debug allMS size allManagedAgents size return if avLoad 0L if s_logger isDebugEnabled s_logger debug avLoad for final ManagementServerHostVO node allMS if node getMsid _nodeId List HostVO hostsToRebalance new ArrayList HostVO for final AgentLoadBalancerPlanner lbPlanner _lbPlanners hostsToRebalance lbPlanner getHostsToRebalance node getMsid avLoad if hostsToRebalance null hostsToRebalance isEmpty break else s_logger debug lbPlanner getName node getMsid
if avLoad 0L if s_logger isDebugEnabled s_logger debug avLoad for final ManagementServerHostVO node allMS if node getMsid _nodeId List HostVO hostsToRebalance new ArrayList HostVO for final AgentLoadBalancerPlanner lbPlanner _lbPlanners hostsToRebalance lbPlanner getHostsToRebalance node getMsid avLoad if hostsToRebalance null hostsToRebalance isEmpty break else s_logger debug lbPlanner getName node getMsid if hostsToRebalance null hostsToRebalance isEmpty s_logger debug hostsToRebalance size node getMsid
s_logger debug node getMsid hostId boolean result true if _hostTransferDao findById hostId null s_logger warn hostId continue HostTransferMapVO transfer null try transfer _hostTransferDao startAgentTransfering hostId node getMsid _nodeId final Answer answer sendRebalanceCommand node getMsid hostId node getMsid _nodeId Event RequestAgentRebalance if answer null s_logger warn hostId node getMsid result false catch final Exception ex s_logger warn hostId node getMsid ex result false
private Answer sendRebalanceCommand final long peer final long agentId final long currentOwnerId final long futureOwnerId final Event event final TransferAgentCommand transfer new TransferAgentCommand agentId currentOwnerId futureOwnerId event final Commands commands new Commands Command OnError Stop commands addCommand transfer final Command cmds commands toCommands try if s_logger isDebugEnabled
private Runnable getTransferScanTask return new ManagedContextRunnable Override protected void runInContext try if s_logger isTraceEnabled s_logger trace _nodeId synchronized _agentToTransferIds if _agentToTransferIds size s_logger debug _agentToTransferIds size for final Iterator Long iterator _agentToTransferIds iterator iterator hasNext final Long hostId iterator next final AgentAttache attache findAttache hostId final Date cutTime DateUtil currentGMTTime final HostTransferMapVO transferMap _hostTransferDao findActiveHostTransferMapByHostId hostId new Date cutTime getTime rebalanceTimeOut if transferMap null
s_logger trace _nodeId synchronized _agentToTransferIds if _agentToTransferIds size s_logger debug _agentToTransferIds size for final Iterator Long iterator _agentToTransferIds iterator iterator hasNext final Long hostId iterator next final AgentAttache attache findAttache hostId final Date cutTime DateUtil currentGMTTime final HostTransferMapVO transferMap _hostTransferDao findActiveHostTransferMapByHostId hostId new Date cutTime getTime rebalanceTimeOut if transferMap null s_logger debug hostId iterator remove _hostTransferDao completeAgentTransfer hostId continue if transferMap getInitialOwner _nodeId attache null attache forForward
final Long hostId iterator next final AgentAttache attache findAttache hostId final Date cutTime DateUtil currentGMTTime final HostTransferMapVO transferMap _hostTransferDao findActiveHostTransferMapByHostId hostId new Date cutTime getTime rebalanceTimeOut if transferMap null s_logger debug hostId iterator remove _hostTransferDao completeAgentTransfer hostId continue if transferMap getInitialOwner _nodeId attache null attache forForward s_logger debug _nodeId hostId iterator remove _hostTransferDao completeAgentTransfer hostId continue final ManagementServerHostVO ms _mshostDao findByMsid transferMap getFutureOwner
iterator remove _hostTransferDao completeAgentTransfer hostId continue final ManagementServerHostVO ms _mshostDao findByMsid transferMap getFutureOwner if ms null ms getState ManagementServerHost State Up s_logger debug hostId ms iterator remove _hostTransferDao completeAgentTransfer hostId continue if attache getQueueSize attache getNonRecurringListenersSize iterator remove try _executor execute new RebalanceTask hostId transferMap getInitialOwner transferMap getFutureOwner catch final RejectedExecutionException ex s_logger warn hostId
private boolean setToWaitForRebalance final long hostId final long currentOwnerId final long futureOwnerId
protected boolean rebalanceHost final long hostId final long currentOwnerId final long futureOwnerId throws AgentUnavailableException boolean result true if currentOwnerId _nodeId if startRebalance hostId s_logger debug finishRebalance hostId futureOwnerId Event RebalanceFailed return false try final Answer answer sendRebalanceCommand futureOwnerId hostId currentOwnerId futureOwnerId Event StartAgentRebalance if answer null answer getResult result false catch final Exception ex s_logger warn hostId futureOwnerId ex result false if result
final Answer answer sendRebalanceCommand futureOwnerId hostId currentOwnerId futureOwnerId Event StartAgentRebalance if answer null answer getResult result false catch final Exception ex s_logger warn hostId futureOwnerId ex result false if result s_logger debug hostId futureOwnerId finishRebalance hostId futureOwnerId Event RebalanceCompleted else s_logger warn hostId futureOwnerId finishRebalance hostId futureOwnerId Event RebalanceFailed else if futureOwnerId _nodeId final HostVO host _hostDao findById hostId try
s_logger warn hostId futureOwnerId ex result false if result s_logger debug hostId futureOwnerId finishRebalance hostId futureOwnerId Event RebalanceCompleted else s_logger warn hostId futureOwnerId finishRebalance hostId futureOwnerId Event RebalanceFailed else if futureOwnerId _nodeId final HostVO host _hostDao findById hostId try if s_logger isDebugEnabled s_logger debug host getId host getName final AgentAttache attache findAttache hostId if attache null
s_logger warn hostId futureOwnerId finishRebalance hostId futureOwnerId Event RebalanceFailed else if futureOwnerId _nodeId final HostVO host _hostDao findById hostId try if s_logger isDebugEnabled s_logger debug host getId host getName final AgentAttache attache findAttache hostId if attache null result handleDisconnect attache Event AgentDisconnected false false true if result if s_logger isDebugEnabled s_logger debug host getId host getName _nodeId result loadDirectlyConnectedHost host true else
protected void finishRebalance final long hostId final long futureOwnerId final Event event final boolean success event Event RebalanceCompleted true false if s_logger isDebugEnabled
final AgentAttache attache findAttache hostId if attache null attache ClusteredAgentAttache s_logger debug hostId _hostTransferDao completeAgentTransfer hostId return final ClusteredAgentAttache forwardAttache ClusteredAgentAttache attache if success forwardAttache setTransferMode false Request requestToTransfer forwardAttache getRequestToTransfer while requestToTransfer null s_logger debug requestToTransfer getSequence hostId _nodeId futureOwnerId final boolean routeResult routeToPeer Long toString futureOwnerId requestToTransfer getBytes if routeResult logD requestToTransfer getBytes requestToTransfer forwardAttache getRequestToTransfer
_hostTransferDao completeAgentTransfer hostId return final ClusteredAgentAttache forwardAttache ClusteredAgentAttache attache if success forwardAttache setTransferMode false Request requestToTransfer forwardAttache getRequestToTransfer while requestToTransfer null s_logger debug requestToTransfer getSequence hostId _nodeId futureOwnerId final boolean routeResult routeToPeer Long toString futureOwnerId requestToTransfer getBytes if routeResult logD requestToTransfer getBytes requestToTransfer forwardAttache getRequestToTransfer s_logger debug _nodeId hostId futureOwnerId else failRebalance hostId
protected void failRebalance final long hostId try
private String handleScheduleHostScanTaskCommand final ScheduleHostScanTaskCommand cmd if s_logger isDebugEnabled
if s_logger isTraceEnabled s_logger trace _nodeId if _agentLbHappened QueryBuilder HostVO sc QueryBuilder create HostVO class sc and sc entity getManagementServerId Op NNULL sc and sc entity getType Op EQ Host Type Routing final List HostVO allManagedRoutingAgents sc list sc QueryBuilder create HostVO class sc and sc entity getType Op EQ Host Type Routing final List HostVO allAgents sc list final double allHostsCount allAgents size final double managedHostsCount allManagedRoutingAgents size if allHostsCount final double load managedHostsCount allHostsCount if load ConnectedAgentThreshold value
QueryBuilder HostVO sc QueryBuilder create HostVO class sc and sc entity getManagementServerId Op NNULL sc and sc entity getType Op EQ Host Type Routing final List HostVO allManagedRoutingAgents sc list sc QueryBuilder create HostVO class sc and sc entity getType Op EQ Host Type Routing final List HostVO allAgents sc list final double allHostsCount allAgents size final double managedHostsCount allManagedRoutingAgents size if allHostsCount final double load managedHostsCount allHostsCount if load ConnectedAgentThreshold value s_logger debug load ConnectedAgentThreshold value scheduleRebalanceAgents _agentLbHappened true
Override public void process Answer answers if answers null answers StartupAnswer StartupAnswer startup StartupAnswer answers int interval startup getPingInterval
Override public List HostVO getHostsToRebalance long msId int avLoad QueryBuilder HostVO sc QueryBuilder create HostVO class sc and sc entity getType Op EQ Host Type Routing sc and sc entity getManagementServerId Op EQ msId List HostVO allHosts sc list if allHosts size avLoad
return null Map Long List HostVO hostToClusterMap new HashMap Long List HostVO for HostVO directHost directHosts Long clusterId directHost getClusterId List HostVO directHostsPerCluster null if hostToClusterMap containsKey clusterId directHostsPerCluster new ArrayList HostVO else directHostsPerCluster hostToClusterMap get clusterId directHostsPerCluster add directHost hostToClusterMap put clusterId directHostsPerCluster hostToClusterMap sortByClusterSize hostToClusterMap int hostsToGive allHosts size avLoad int hostsLeftToGive hostsToGive int hostsLeft directHosts size
List HostVO directHostsPerCluster null if hostToClusterMap containsKey clusterId directHostsPerCluster new ArrayList HostVO else directHostsPerCluster hostToClusterMap get clusterId directHostsPerCluster add directHost hostToClusterMap put clusterId directHostsPerCluster hostToClusterMap sortByClusterSize hostToClusterMap int hostsToGive allHosts size avLoad int hostsLeftToGive hostsToGive int hostsLeft directHosts size List HostVO hostsToReturn new ArrayList HostVO s_logger debug msId hostsToGive allHosts size avLoad for Long cluster hostToClusterMap keySet List HostVO hostsInCluster hostToClusterMap get cluster
directHostsPerCluster new ArrayList HostVO else directHostsPerCluster hostToClusterMap get clusterId directHostsPerCluster add directHost hostToClusterMap put clusterId directHostsPerCluster hostToClusterMap sortByClusterSize hostToClusterMap int hostsToGive allHosts size avLoad int hostsLeftToGive hostsToGive int hostsLeft directHosts size List HostVO hostsToReturn new ArrayList HostVO s_logger debug msId hostsToGive allHosts size avLoad for Long cluster hostToClusterMap keySet List HostVO hostsInCluster hostToClusterMap get cluster hostsLeft hostsLeft hostsInCluster size if hostsToReturn size hostsToGive
hostToClusterMap put clusterId directHostsPerCluster hostToClusterMap sortByClusterSize hostToClusterMap int hostsToGive allHosts size avLoad int hostsLeftToGive hostsToGive int hostsLeft directHosts size List HostVO hostsToReturn new ArrayList HostVO s_logger debug msId hostsToGive allHosts size avLoad for Long cluster hostToClusterMap keySet List HostVO hostsInCluster hostToClusterMap get cluster hostsLeft hostsLeft hostsInCluster size if hostsToReturn size hostsToGive s_logger debug cluster if hostsInCluster size hostsLeftToGive s_logger debug cluster hostsInCluster size hostsLeftToGive if hostsLeft hostsLeftToGive
List HostVO hostsToReturn new ArrayList HostVO s_logger debug msId hostsToGive allHosts size avLoad for Long cluster hostToClusterMap keySet List HostVO hostsInCluster hostToClusterMap get cluster hostsLeft hostsLeft hostsInCluster size if hostsToReturn size hostsToGive s_logger debug cluster if hostsInCluster size hostsLeftToGive s_logger debug cluster hostsInCluster size hostsLeftToGive if hostsLeft hostsLeftToGive continue else break else s_logger debug hostsInCluster size hostsInCluster cluster
protected void advanceExpunge VMInstanceVO vm throws ResourceUnavailableException OperationTimedoutException ConcurrentOperationException if vm null vm getRemoved null if s_logger isDebugEnabled
protected void advanceExpunge VMInstanceVO vm throws ResourceUnavailableException OperationTimedoutException ConcurrentOperationException if vm null vm getRemoved null if s_logger isDebugEnabled s_logger debug vm return advanceStop vm getUuid VmDestroyForcestop value vm _vmDao findByUuid vm getUuid try if stateTransitTo vm VirtualMachine Event ExpungeOperation vm getHostId s_logger debug vm throw new CloudRuntimeException vm catch final NoTransitionException e s_logger debug vm throw new CloudRuntimeException vm e if s_logger isDebugEnabled
if hostId null volumeMgr revokeAccess vm getId hostId volumeMgr cleanupVolumes vm getId if hostId null CollectionUtils isNotEmpty targets removeDynamicTargets hostId targets final VirtualMachineGuru guru getVmGuru vm guru finalizeExpunge vm userVmDetailsDao removeDetails vm getId final List Command finalizeExpungeCommands hvGuru finalizeExpunge vm if finalizeExpungeCommands null finalizeExpungeCommands size if hostId null final Commands cmds new Commands Command OnError Stop for final Command command finalizeExpungeCommands cmds addCommand command if nicExpungeCommands null
protected boolean checkWorkItems final VMInstanceVO vm final State state throws ConcurrentOperationException while true final ItWorkVO vo _workDao findByOutstandingWork vm getId state if vo null if s_logger isDebugEnabled
return true if vo getStep Step Done if s_logger isDebugEnabled s_logger debug vm vo getStep return true final VMInstanceVO instance _vmDao findById vm getId if instance null instance getState State Running if s_logger isDebugEnabled s_logger debug vm return true if vo getSecondsTaskIsInactive VmOpCancelInterval value s_logger warn vm vo getSecondsTaskIsInactive return false try Thread sleep VmOpWaitInterval value
if s_logger isDebugEnabled s_logger debug vm vo getStep return true final VMInstanceVO instance _vmDao findById vm getId if instance null instance getState State Running if s_logger isDebugEnabled s_logger debug vm return true if vo getSecondsTaskIsInactive VmOpCancelInterval value s_logger warn vm vo getSecondsTaskIsInactive return false try Thread sleep VmOpWaitInterval value catch final InterruptedException e s_logger info vm
DB protected Ternary VMInstanceVO ReservationContext ItWorkVO changeToStartState final VirtualMachineGuru vmGuru final VMInstanceVO vm final User caller final Account account throws ConcurrentOperationException final long vmId vm getId ItWorkVO work new ItWorkVO UUID randomUUID toString _nodeId State Starting vm getType vm getId int retry VmOpLockStateRetry value while retry try final ItWorkVO workFinal work final Ternary VMInstanceVO ReservationContext ItWorkVO result Transaction execute new TransactionCallbackWithException Ternary VMInstanceVO ReservationContext ItWorkVO NoTransitionException Override public Ternary VMInstanceVO ReservationContext ItWorkVO doInTransaction final TransactionStatus status throws NoTransitionException final Journal journal new Journal LogJournal vm s_logger final ItWorkVO work _workDao persist workFinal final ReservationContextImpl context new ReservationContextImpl work getId journal caller account if stateTransitTo vm Event StartRequested null work getId if s_logger isDebugEnabled
Override public Ternary VMInstanceVO ReservationContext ItWorkVO doInTransaction final TransactionStatus status throws NoTransitionException final Journal journal new Journal LogJournal vm s_logger final ItWorkVO work _workDao persist workFinal final ReservationContextImpl context new ReservationContextImpl work getId journal caller account if stateTransitTo vm Event StartRequested null work getId if s_logger isDebugEnabled s_logger debug vm work getId return new Ternary VMInstanceVO ReservationContext ItWorkVO vm context work return new Ternary VMInstanceVO ReservationContext ItWorkVO null null work work result third if result first null return result catch final NoTransitionException e if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug vm work getId return new Ternary VMInstanceVO ReservationContext ItWorkVO vm context work return new Ternary VMInstanceVO ReservationContext ItWorkVO null null work work result third if result first null return result catch final NoTransitionException e if s_logger isDebugEnabled s_logger debug e getMessage final VMInstanceVO instance _vmDao findById vmId if instance null throw new ConcurrentOperationException vm if s_logger isDebugEnabled
return new Ternary VMInstanceVO ReservationContext ItWorkVO null null work work result third if result first null return result catch final NoTransitionException e if s_logger isDebugEnabled s_logger debug e getMessage final VMInstanceVO instance _vmDao findById vmId if instance null throw new ConcurrentOperationException vm if s_logger isDebugEnabled s_logger debug instance retry final State state instance getState if state State Running
catch final NoTransitionException e if s_logger isDebugEnabled s_logger debug e getMessage final VMInstanceVO instance _vmDao findById vmId if instance null throw new ConcurrentOperationException vm if s_logger isDebugEnabled s_logger debug instance retry final State state instance getState if state State Running if s_logger isDebugEnabled s_logger debug vm return null if state isTransitional if checkWorkItems vm state
private void setupAgentSecurity final Host vmHost final Map String String sshAccessDetails final VirtualMachine vm throws AgentUnavailableException OperationTimedoutException final String csr caManager generateKeyStoreAndCsr vmHost sshAccessDetails if Strings isNullOrEmpty csr final Map String String ipAddressDetails new HashMap sshAccessDetails ipAddressDetails remove NetworkElementCommand ROUTER_NAME final Certificate certificate caManager issueCertificate csr Arrays asList vm getHostName vm getInstanceName new ArrayList ipAddressDetails values CAManager CertValidityPeriod value null final boolean result caManager deployCertificate vmHost certificate false sshAccessDetails if result
final User caller cctxt getCallingUser VMInstanceVO vm _vmDao findByUuid vmUuid final VirtualMachineGuru vmGuru getVmGuru vm final Ternary VMInstanceVO ReservationContext ItWorkVO start changeToStartState vmGuru vm caller account if start null return vm start first final ReservationContext ctx start second ItWorkVO work start third VMInstanceVO startedVm null final ServiceOfferingVO offering _offeringDao findById vm getId vm getServiceOfferingId final VirtualMachineTemplate template _entityMgr findByIdIncludingRemoved VirtualMachineTemplate class vm getTemplateId DataCenterDeployment plan new DataCenterDeployment vm getDataCenterId vm getPodIdToDeployIn null null null null ctx if planToDeploy null planToDeploy getDataCenterId if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug planToDeploy getDataCenterId planToDeploy getPodId planToDeploy getClusterId planToDeploy getHostId planToDeploy getPoolId plan new DataCenterDeployment planToDeploy getDataCenterId planToDeploy getPodId planToDeploy getClusterId planToDeploy getHostId planToDeploy getPoolId planToDeploy getPhysicalNetworkId ctx final HypervisorGuru hvGuru _hvGuruMgr getGuru vm getHypervisorType final Account owner _entityMgr findById Account class vm getAccountId if VirtualMachine Type User equals vm type ResoureCountRunningVMsonly value resourceCountIncrement owner getAccountId new Long offering getCpu new Long offering getRamSize boolean canRetry true ExcludeList avoids null try final Journal journal start second getJournal if planToDeploy null avoids planToDeploy getAvoids if avoids null avoids new ExcludeList
try final Journal journal start second getJournal if planToDeploy null avoids planToDeploy getAvoids if avoids null avoids new ExcludeList if s_logger isDebugEnabled s_logger debug avoids getPodsToAvoid avoids getClustersToAvoid avoids getHostsToAvoid boolean planChangedByVolume false boolean reuseVolume true final DataCenterDeployment originalPlan plan int retry StartRetry value while retry if reuseVolume final List VolumeVO vols _volsDao findReadyRootVolumesByInstance vm getId
if volTemplateId null volTemplateId longValue template getId if s_logger isDebugEnabled s_logger debug vol vm continue final StoragePool pool StoragePool dataStoreMgr getPrimaryDataStore vol getPoolId if pool isInMaintenance if s_logger isDebugEnabled s_logger debug final long rootVolDcId pool getDataCenterId final Long rootVolPodId pool getPodId final Long rootVolClusterId pool getClusterId if planToDeploy null planToDeploy getDataCenterId final Long clusterIdSpecified planToDeploy getClusterId if clusterIdSpecified null rootVolClusterId null if rootVolClusterId longValue clusterIdSpecified longValue
vmProfile setMemoryOvercommitRatio Float parseFloat cluster_detail_ram getValue StartAnswer startAnswer null try if changeState vm Event OperationRetry destHostId work Step Prepare throw new ConcurrentOperationException vm getUuid vm getState Event OperationRetry catch final NoTransitionException e1 throw new ConcurrentOperationException e1 getMessage try resetVmNicsDeviceId vm getId _networkMgr prepare vmProfile new DeployDestination dest getDataCenter dest getPod null null dest getStorageForDisks ctx if vm getHypervisorType HypervisorType BareMetal volumeMgr prepare vmProfile dest if reuseVolume reuseVolume true Commands cmds null
try resetVmNicsDeviceId vm getId _networkMgr prepare vmProfile new DeployDestination dest getDataCenter dest getPod null null dest getStorageForDisks ctx if vm getHypervisorType HypervisorType BareMetal volumeMgr prepare vmProfile dest if reuseVolume reuseVolume true Commands cmds null vmGuru finalizeVirtualMachineProfile vmProfile dest ctx final VirtualMachineTO vmTO hvGuru implement vmProfile checkAndSetEnterSetupMode vmTO params handlePath vmTO getDisks vm getHypervisorType cmds new Commands Command OnError Stop cmds addCommand new StartCommand vmTO dest getHost getExecuteInSequence vm getHypervisorType vmGuru finalizeDeployment cmds vmProfile dest ctx
Commands cmds null vmGuru finalizeVirtualMachineProfile vmProfile dest ctx final VirtualMachineTO vmTO hvGuru implement vmProfile checkAndSetEnterSetupMode vmTO params handlePath vmTO getDisks vm getHypervisorType cmds new Commands Command OnError Stop cmds addCommand new StartCommand vmTO dest getHost getExecuteInSequence vm getHypervisorType vmGuru finalizeDeployment cmds vmProfile dest ctx addExtraConfig vmTO work _workDao findById work getId if work null work getStep Step Prepare throw new ConcurrentOperationException work _workDao updateStep work Step Starting _agentMgr send destHostId cmds _workDao updateStep work Step Started
handlePath vmTO getDisks vm getHypervisorType cmds new Commands Command OnError Stop cmds addCommand new StartCommand vmTO dest getHost getExecuteInSequence vm getHypervisorType vmGuru finalizeDeployment cmds vmProfile dest ctx addExtraConfig vmTO work _workDao findById work getId if work null work getStep Step Prepare throw new ConcurrentOperationException work _workDao updateStep work Step Starting _agentMgr send destHostId cmds _workDao updateStep work Step Started startAnswer cmds getAnswer StartAnswer class if startAnswer null startAnswer getResult handlePath vmTO getDisks startAnswer getIqnToData final String host_guid startAnswer getHost_guid
if vmGuru finalizeStart vmProfile destHostId cmds ctx syncDiskChainChange startAnswer if changeState vm Event OperationSucceeded destHostId work Step Done s_logger error vm getUuid vm getState Event OperationSucceeded throw new ConcurrentOperationException vm getUuid final GPUDeviceTO gpuDevice startAnswer getVirtualMachine getGpuDevice if gpuDevice null _resourceMgr updateGPUDetails destHostId gpuDevice getGroupDetails if userVmDetailsDao findDetail vm getId VmDetailConstants DEPLOY_VM null userVmDetailsDao removeDetail vm getId VmDetailConstants DEPLOY_VM startedVm vm if s_logger isDebugEnabled s_logger debug vm final Host vmHost _hostDao findById destHostId if vmHost null VirtualMachine Type ConsoleProxy equals vm getType VirtualMachine Type SecondaryStorageVm equals vm getType caManager canProvisionCertificates
startedVm vm if s_logger isDebugEnabled s_logger debug vm final Host vmHost _hostDao findById destHostId if vmHost null VirtualMachine Type ConsoleProxy equals vm getType VirtualMachine Type SecondaryStorageVm equals vm getType caManager canProvisionCertificates final Map String String sshAccessDetails _networkMgr getSystemVMAccessDetails vm for int retries retries retries try setupAgentSecurity vmHost sshAccessDetails vm return catch final Exception e s_logger error vm getId e throw new CloudRuntimeException vm getId return else
for int retries retries retries try setupAgentSecurity vmHost sshAccessDetails vm return catch final Exception e s_logger error vm getId e throw new CloudRuntimeException vm getId return else if s_logger isDebugEnabled s_logger info vm StopCommand stopCmd new StopCommand vm getExecuteInSequence vm getHypervisorType false stopCmd setControlIp getControlNicIpForVM vm final StopCommand cmd stopCmd final Answer answer _agentMgr easySend destHostId cmd
return catch final Exception e s_logger error vm getId e throw new CloudRuntimeException vm getId return else if s_logger isDebugEnabled s_logger info vm StopCommand stopCmd new StopCommand vm getExecuteInSequence vm getHypervisorType false stopCmd setControlIp getControlNicIpForVM vm final StopCommand cmd stopCmd final Answer answer _agentMgr easySend destHostId cmd if answer null answer StopAnswer final StopAnswer stopAns StopAnswer answer if vm getType VirtualMachine Type User
StringBuffer msgBuf new StringBuffer boolean log false if params get VirtualMachineProfile Param UefiFlag null msgBuf append String format params get VirtualMachineProfile Param UefiFlag log true if params get VirtualMachineProfile Param BootType null msgBuf append String format params get VirtualMachineProfile Param BootType log true if params get VirtualMachineProfile Param BootMode null msgBuf append String format params get VirtualMachineProfile Param BootMode log true if params get VirtualMachineProfile Param BootIntoSetup null msgBuf append String format params get VirtualMachineProfile Param BootIntoSetup log true if log
String msg vm getId s_logger info msg throw new ConcurrentOperationException msg Boolean result Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status if s_logger isDebugEnabled s_logger debug vm final VirtualMachineProfile profile new VirtualMachineProfileImpl vm final HypervisorGuru hvGuru _hvGuruMgr getGuru vm getHypervisorType final VirtualMachineGuru guru getVmGuru vm try unmanageVMSnapshots vm unmanageVMNics profile vm unmanageVMVolumes vm guru finalizeUnmanage vm
answer _agentMgr send vm getHostId stop if answer null answer StopAnswer final StopAnswer stopAns StopAnswer answer if vm getType VirtualMachine Type User final String platform stopAns getPlatform if platform null final UserVmVO userVm _userVmDao findById vm getId _userVmDao loadDetails userVm userVm setDetail VmDetailConstants PLATFORM platform _userVmDao saveDetails userVm final GPUDeviceTO gpuDevice stop getGpuDevice if gpuDevice null _resourceMgr updateGPUDetails vm getHostId gpuDevice getGroupDetails if answer getResult final String details answer getDetails
final UserVmVO userVm _userVmDao findById vm getId _userVmDao loadDetails userVm userVm setDetail VmDetailConstants PLATFORM platform _userVmDao saveDetails userVm final GPUDeviceTO gpuDevice stop getGpuDevice if gpuDevice null _resourceMgr updateGPUDetails vm getHostId gpuDevice getGroupDetails if answer getResult final String details answer getDetails s_logger debug details return false guru finalizeStop profile answer final UserVmVO userVm _userVmDao findById vm getId userVm setPowerState PowerState PowerOff _userVmDao update userVm getId userVm
protected boolean cleanup final VirtualMachineGuru guru final VirtualMachineProfile profile final ItWorkVO work final Event event final boolean cleanUpEvenIfUnableToStop final VirtualMachine vm profile getVirtualMachine final State state vm getState
final State state vm getState s_logger debug vm state try if state State Starting if work null final Step step work getStep if step Step Starting cleanUpEvenIfUnableToStop s_logger warn vm step return false if step Step Started step Step Starting step Step Release if vm getHostId null if sendStop guru profile cleanUpEvenIfUnableToStop false s_logger warn vm State Starting return false if step Step Release step Step Prepare step Step Started step Step Starting
else if state State Stopping if vm getHostId null if sendStop guru profile cleanUpEvenIfUnableToStop false s_logger warn vm State Stopping return false else if state State Migrating if vm getHostId null if sendStop guru profile cleanUpEvenIfUnableToStop false s_logger warn vm State Migrating return false if vm getLastHostId null if sendStop guru profile cleanUpEvenIfUnableToStop false s_logger warn vm State Migrating return false else if state State Running
else if state State Stopping if vm getHostId null if sendStop guru profile cleanUpEvenIfUnableToStop false s_logger warn vm State Stopping return false else if state State Migrating if vm getHostId null if sendStop guru profile cleanUpEvenIfUnableToStop false s_logger warn vm State Migrating return false if vm getLastHostId null if sendStop guru profile cleanUpEvenIfUnableToStop false s_logger warn vm State Migrating return false else if state State Running
private void advanceStop final VMInstanceVO vm final boolean cleanUpEvenIfUnableToStop throws AgentUnavailableException OperationTimedoutException ConcurrentOperationException final State state vm getState if state State Stopped if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug vm return if state State Destroyed state State Expunging state State Error if s_logger isDebugEnabled s_logger debug vm state return final ItWorkVO work _workDao findByOutstandingWork vm getId vm getState if work null if s_logger isDebugEnabled s_logger debug vm vm getState work getId final Long hostId vm getHostId if hostId null if cleanUpEvenIfUnableToStop if s_logger isDebugEnabled
return final ItWorkVO work _workDao findByOutstandingWork vm getId vm getState if work null if s_logger isDebugEnabled s_logger debug vm vm getState work getId final Long hostId vm getHostId if hostId null if cleanUpEvenIfUnableToStop if s_logger isDebugEnabled s_logger debug vm vm getState throw new CloudRuntimeException vm try stateTransitTo vm Event AgentReportStopped null null catch final NoTransitionException e s_logger warn e getMessage
final Long hostId vm getHostId if hostId null if cleanUpEvenIfUnableToStop if s_logger isDebugEnabled s_logger debug vm vm getState throw new CloudRuntimeException vm try stateTransitTo vm Event AgentReportStopped null null catch final NoTransitionException e s_logger warn e getMessage if work null if s_logger isDebugEnabled s_logger debug work getId work setStep Step Done _workDao update work getId work
if s_logger isDebugEnabled s_logger debug work getId work setStep Step Done _workDao update work getId work return else HostVO host _hostDao findById hostId if cleanUpEvenIfUnableToStop vm getState State Running host getResourceState ResourceState PrepareForMaintenance s_logger debug vm getId throw new CloudRuntimeException vm getId final VirtualMachineGuru vmGuru getVmGuru vm final VirtualMachineProfile profile new VirtualMachineProfileImpl vm try if stateTransitTo vm Event StopRequested vm getHostId throw new ConcurrentOperationException
else HostVO host _hostDao findById hostId if cleanUpEvenIfUnableToStop vm getState State Running host getResourceState ResourceState PrepareForMaintenance s_logger debug vm getId throw new CloudRuntimeException vm getId final VirtualMachineGuru vmGuru getVmGuru vm final VirtualMachineProfile profile new VirtualMachineProfileImpl vm try if stateTransitTo vm Event StopRequested vm getHostId throw new ConcurrentOperationException catch final NoTransitionException e1 if cleanUpEvenIfUnableToStop throw new CloudRuntimeException vm vm getState final boolean doCleanup true if s_logger isDebugEnabled
vmGuru prepareStop profile final StopCommand stop new StopCommand vm getExecuteInSequence vm getHypervisorType false cleanUpEvenIfUnableToStop stop setControlIp getControlNicIpForVM vm boolean stopped false Answer answer null try answer _agentMgr send vm getHostId stop if answer null if answer StopAnswer final StopAnswer stopAns StopAnswer answer if vm getType VirtualMachine Type User final String platform stopAns getPlatform if platform null final UserVmVO userVm _userVmDao findById vm getId _userVmDao loadDetails userVm
stop setControlIp getControlNicIpForVM vm boolean stopped false Answer answer null try answer _agentMgr send vm getHostId stop if answer null if answer StopAnswer final StopAnswer stopAns StopAnswer answer if vm getType VirtualMachine Type User final String platform stopAns getPlatform if platform null final UserVmVO userVm _userVmDao findById vm getId _userVmDao loadDetails userVm userVm setDetail VmDetailConstants PLATFORM platform _userVmDao saveDetails userVm
if answer StopAnswer final StopAnswer stopAns StopAnswer answer if vm getType VirtualMachine Type User final String platform stopAns getPlatform if platform null final UserVmVO userVm _userVmDao findById vm getId _userVmDao loadDetails userVm userVm setDetail VmDetailConstants PLATFORM platform _userVmDao saveDetails userVm stopped answer getResult if stopped throw new CloudRuntimeException answer getDetails vmGuru finalizeStop profile answer final GPUDeviceTO gpuDevice stop getGpuDevice if gpuDevice null
Override public void destroy final String vmUuid final boolean expunge throws AgentUnavailableException OperationTimedoutException ConcurrentOperationException VMInstanceVO vm _vmDao findByUuid vmUuid if vm null vm getState State Destroyed vm getState State Expunging vm getRemoved null if s_logger isDebugEnabled
Override public void destroy final String vmUuid final boolean expunge throws AgentUnavailableException OperationTimedoutException ConcurrentOperationException VMInstanceVO vm _vmDao findByUuid vmUuid if vm null vm getState State Destroyed vm getState State Expunging vm getRemoved null if s_logger isDebugEnabled s_logger debug vm return if s_logger isDebugEnabled s_logger debug vm expunge advanceStop vmUuid VmDestroyForcestop value deleteVMSnapshots vm expunge Transaction execute new TransactionCallbackWithExceptionNoReturn CloudRuntimeException Override public void doInTransactionWithoutResult final TransactionStatus status throws CloudRuntimeException VMInstanceVO vm _vmDao findByUuid vmUuid try if stateTransitTo vm VirtualMachine Event DestroyRequested vm getHostId
return if s_logger isDebugEnabled s_logger debug vm expunge advanceStop vmUuid VmDestroyForcestop value deleteVMSnapshots vm expunge Transaction execute new TransactionCallbackWithExceptionNoReturn CloudRuntimeException Override public void doInTransactionWithoutResult final TransactionStatus status throws CloudRuntimeException VMInstanceVO vm _vmDao findByUuid vmUuid try if stateTransitTo vm VirtualMachine Event DestroyRequested vm getHostId s_logger debug vm throw new CloudRuntimeException vm else if expunge if stateTransitTo vm VirtualMachine Event ExpungeOperation vm getHostId
private void deleteVMSnapshots VMInstanceVO vm boolean expunge if vm getHypervisorType equals HypervisorType VMware if _vmSnapshotMgr deleteAllVMSnapshots vm getId null
final VMInstanceVO vm _vmDao findByUuid vmUuid preStorageMigrationStateCheck destPool vm try if s_logger isDebugEnabled s_logger debug String format vm getHypervisorType toString vm getInstanceName migrateThroughHypervisorOrStorage destPool vm catch ConcurrentOperationException InsufficientCapacityException StorageUnavailableException e String msg String format vmUuid s_logger debug msg throw new CloudRuntimeException msg e finally try stateTransitTo vm Event AgentReportStopped null catch final NoTransitionException e String anotherMEssage String format vmUuid
private Answer attemptHypervisorMigration StoragePool destPool VMInstanceVO vm final HypervisorGuru hvGuru _hvGuruMgr getGuru vm getHypervisorType List Command commandsToSend hvGuru finalizeMigrate vm destPool Long hostId vm getHostId if hostId null hostId vm getLastHostId if s_logger isDebugEnabled
private void afterHypervisorMigrationCleanup StoragePool destPool VMInstanceVO vm HostVO srcHost Long srcClusterId Answer hypervisorMigrationResults throws InsufficientCapacityException boolean isDebugEnabled s_logger isDebugEnabled if isDebugEnabled String msg String format vm getInstanceName vm getUuid destPool getName destPool getUuid
private void markVolumesInPool VMInstanceVO vm StoragePool destPool Answer hypervisorMigrationResults MigrateVmToPoolAnswer relevantAnswer null for Answer answer hypervisorMigrationResults if s_logger isTraceEnabled s_logger trace String format answer getClass getSimpleName answer if answer MigrateVmToPoolAnswer relevantAnswer MigrateVmToPoolAnswer answer if relevantAnswer null throw new CloudRuntimeException List VolumeVO volumes _volsDao findUsableVolumesForInstance vm getId if s_logger isDebugEnabled String msg String format volumes size vm getInstanceName vm getUuid vm getId s_logger debug msg for VolumeObjectTO result relevantAnswer getVolumeTos if s_logger isDebugEnabled
private void setDestinationPoolAndReallocateNetwork StoragePool destPool VMInstanceVO vm throws InsufficientCapacityException if destPool getPodId null destPool getPodId equals vm getPodIdToDeployIn if s_logger isDebugEnabled String msg String format vm getInstanceName
private void removeStaleVmFromSource VMInstanceVO vm HostVO srcHost
private void orchestrateMigrate final String vmUuid final long srcHostId final DeployDestination dest throws ResourceUnavailableException ConcurrentOperationException final VMInstanceVO vm _vmDao findByUuid vmUuid if vm null if s_logger isDebugEnabled
protected void migrate final VMInstanceVO vm final long srcHostId final DeployDestination dest throws ResourceUnavailableException ConcurrentOperationException
protected void migrate final VMInstanceVO vm final long srcHostId final DeployDestination dest throws ResourceUnavailableException ConcurrentOperationException s_logger info vm dest final UserVmVO userVm _userVmDao findById vm getId final long dstHostId dest getHost getId final Host fromHost _hostDao findById srcHostId if fromHost null
final UserVmVO userVm _userVmDao findById vm getId final long dstHostId dest getHost getId final Host fromHost _hostDao findById srcHostId if fromHost null s_logger info srcHostId throw new CloudRuntimeException srcHostId if fromHost getClusterId longValue dest getCluster getId final List VolumeVO volumes _volsDao findCreatedByInstance vm getId for final VolumeVO volume volumes if _storagePoolDao findById volume getPoolId getScope equals ScopeType ZONE s_logger info dest getHost getId throw new CloudRuntimeException dest getHost getId final VirtualMachineGuru vmGuru getVmGuru vm if vm getState State Running if s_logger isDebugEnabled
ItWorkVO work new ItWorkVO UUID randomUUID toString _nodeId State Migrating vm getType vm getId work setStep Step Prepare work setResourceType ItWorkVO ResourceType Host work setResourceId dstHostId work _workDao persist work Answer pfma null try pfma _agentMgr send dstHostId pfmc if pfma null pfma getResult final String details pfma null pfma getDetails final String msg details pfma null throw new AgentUnavailableException msg dstHostId catch final OperationTimedoutException e1 throw new AgentUnavailableException dstHostId
work _workDao persist work Answer pfma null try pfma _agentMgr send dstHostId pfmc if pfma null pfma getResult final String details pfma null pfma getDetails final String msg details pfma null throw new AgentUnavailableException msg dstHostId catch final OperationTimedoutException e1 throw new AgentUnavailableException dstHostId finally if pfma null _networkMgr rollbackNicForMigration vmSrc profile work setStep Step Done
stateTransitTo vm Event OperationFailed srcHostId catch final NoTransitionException e3 s_logger warn e3 getMessage throw new CloudRuntimeException e2 getMessage boolean migrated false Map String DpdkTO dpdkInterfaceMapping null try final boolean isWindows _guestOsCategoryDao findById _guestOsDao findById vm getGuestOSId getCategoryId getName equalsIgnoreCase final MigrateCommand mc new MigrateCommand vm getInstanceName dest getHost getPrivateIpAddress isWindows to getExecuteInSequence vm getHypervisorType boolean kvmAutoConvergence StorageManager KvmAutoConvergence value mc setAutoConvergence kvmAutoConvergence mc setHostGuid dest getHost getGuid dpdkInterfaceMapping PrepareForMigrationAnswer pfma getDpdkInterfaceMapping if MapUtils isNotEmpty dpdkInterfaceMapping mc setDpdkInterfaceMapping dpdkInterfaceMapping
Map String DpdkTO dpdkInterfaceMapping null try final boolean isWindows _guestOsCategoryDao findById _guestOsDao findById vm getGuestOSId getCategoryId getName equalsIgnoreCase final MigrateCommand mc new MigrateCommand vm getInstanceName dest getHost getPrivateIpAddress isWindows to getExecuteInSequence vm getHypervisorType boolean kvmAutoConvergence StorageManager KvmAutoConvergence value mc setAutoConvergence kvmAutoConvergence mc setHostGuid dest getHost getGuid dpdkInterfaceMapping PrepareForMigrationAnswer pfma getDpdkInterfaceMapping if MapUtils isNotEmpty dpdkInterfaceMapping mc setDpdkInterfaceMapping dpdkInterfaceMapping try final Answer ma _agentMgr send vm getLastHostId mc if ma null ma getResult final String details ma null ma getDetails throw new CloudRuntimeException details
boolean kvmAutoConvergence StorageManager KvmAutoConvergence value mc setAutoConvergence kvmAutoConvergence mc setHostGuid dest getHost getGuid dpdkInterfaceMapping PrepareForMigrationAnswer pfma getDpdkInterfaceMapping if MapUtils isNotEmpty dpdkInterfaceMapping mc setDpdkInterfaceMapping dpdkInterfaceMapping try final Answer ma _agentMgr send vm getLastHostId mc if ma null ma getResult final String details ma null ma getDetails throw new CloudRuntimeException details catch final OperationTimedoutException e if e isActive s_logger warn vm _haMgr scheduleRestart vm true
private T extends VMInstanceVO void moveVmToMigratingState final T vm final Long hostId final ItWorkVO work throws ConcurrentOperationException try if changeState vm Event MigrationRequested hostId work Step Migrating
private T extends VMInstanceVO void moveVmOutofMigratingStateOnSuccess final T vm final Long hostId final ItWorkVO work throws ConcurrentOperationException try if changeState vm Event OperationSucceeded hostId work Step Started
UserVmVO userVm _userVmDao findById vm getId Map String String details userVmDetailsDao listDetailsKeyPairs vm getId userVm setDetails details Network network _networkModel getNetwork defaultNic getNetworkId if _networkModel isSharedNetworkWithoutServices network getId final String serviceOffering _serviceOfferingDao findByIdIncludingRemoved vm getId vm getServiceOfferingId getDisplayText boolean isWindows _guestOSCategoryDao findById _guestOSDao findById vm getGuestOSId getCategoryId getName equalsIgnoreCase vmData _networkModel generateVmData userVm getUserData serviceOffering vm getDataCenterId vm getInstanceName vm getHostName vm getId vm getUuid defaultNic getMacAddress userVm getDetail String profile getParameter VirtualMachineProfile Param VmPassword isWindows VirtualMachineManager getHypervisorHostname destination getHost getName String vmName vm getInstanceName String configDriveIsoRootFolder String isoFile configDriveIsoRootFolder vmName vmName profile setVmData vmData profile setConfigDriveLabel VmConfigDriveLabel value profile setConfigDriveIsoRootFolder configDriveIsoRootFolder profile setConfigDriveIsoFile isoFile
vmData _networkModel generateVmData userVm getUserData serviceOffering vm getDataCenterId vm getInstanceName vm getHostName vm getId vm getUuid defaultNic getMacAddress userVm getDetail String profile getParameter VirtualMachineProfile Param VmPassword isWindows VirtualMachineManager getHypervisorHostname destination getHost getName String vmName vm getInstanceName String configDriveIsoRootFolder String isoFile configDriveIsoRootFolder vmName vmName profile setVmData vmData profile setConfigDriveLabel VmConfigDriveLabel value profile setConfigDriveIsoRootFolder configDriveIsoRootFolder profile setConfigDriveIsoFile isoFile AttachOrDettachConfigDriveCommand dettachCommand new AttachOrDettachConfigDriveCommand vm getInstanceName vmData VmConfigDriveLabel value false try _agentMgr send srcHost getId dettachCommand s_logger debug vm getInstanceName srcHost catch OperationTimedoutException e s_logger debug e getMessage volumeMgr migrateVolumes vm to srcHost destHost volumeToPoolMap
catch OperationTimedoutException e s_logger debug e getMessage volumeMgr migrateVolumes vm to srcHost destHost volumeToPoolMap moveVmOutofMigratingStateOnSuccess vm destHost getId work try if checkVmOnHost vm destHostId s_logger error vm try _agentMgr send srcHostId new Commands cleanup vm getInstanceName null catch final AgentUnavailableException e s_logger error srcHostId cleanup vmGuru new VirtualMachineProfileImpl vm work Event AgentReportStopped true throw new CloudRuntimeException vm catch final OperationTimedoutException e s_logger warn vm destHost e
if checkVmOnHost vm destHostId s_logger error vm try _agentMgr send srcHostId new Commands cleanup vm getInstanceName null catch final AgentUnavailableException e s_logger error srcHostId cleanup vmGuru new VirtualMachineProfileImpl vm work Event AgentReportStopped true throw new CloudRuntimeException vm catch final OperationTimedoutException e s_logger warn vm destHost e migrated true finally if migrated s_logger info vm _alertMgr sendAlert alertType srcHost getDataCenterId srcHost getPodId vm getInstanceName srcHost getName dc getName dc getName
protected void cancelWorkItems final long nodeId final GlobalLock scanLock GlobalLock getInternLock try if scanLock lock try final List ItWorkVO works _workDao listWorkInProgressFor nodeId for final ItWorkVO work works
if work getType State Starting _haMgr scheduleRestart vm true work setManagementServerId _nodeId work setStep Step Done _workDao update work getId work else if work getType State Stopping _haMgr scheduleStop vm vm getHostId WorkType CheckStop work setManagementServerId _nodeId work setStep Step Done _workDao update work getId work else if work getType State Migrating _haMgr scheduleMigration vm work setStep Step Done _workDao update work getId work catch final Exception e
private void orchestrateMigrateAway final String vmUuid final long srcHostId final DeploymentPlanner planner throws InsufficientServerCapacityException final VMInstanceVO vm _vmDao findByUuid vmUuid if vm null
for final VolumeVO rootVolumeOfVm vols final StoragePoolVO rootDiskPool _storagePoolDao findById rootVolumeOfVm getPoolId if rootDiskPool null poolId rootDiskPool getId final DataCenterDeployment plan new DataCenterDeployment host getDataCenterId host getPodId host getClusterId null poolId null final ExcludeList excludes new ExcludeList excludes addHost hostId DeployDestination dest null while true try plan setMigrationPlan true dest _dpMgr planDeployment profile plan excludes planner catch final AffinityConflictException e2 s_logger warn e2 throw new CloudRuntimeException
poolId rootDiskPool getId final DataCenterDeployment plan new DataCenterDeployment host getDataCenterId host getPodId host getClusterId null poolId null final ExcludeList excludes new ExcludeList excludes addHost hostId DeployDestination dest null while true try plan setMigrationPlan true dest _dpMgr planDeployment profile plan excludes planner catch final AffinityConflictException e2 s_logger warn e2 throw new CloudRuntimeException if dest null if s_logger isDebugEnabled s_logger debug dest
while true try plan setMigrationPlan true dest _dpMgr planDeployment profile plan excludes planner catch final AffinityConflictException e2 s_logger warn e2 throw new CloudRuntimeException if dest null if s_logger isDebugEnabled s_logger debug dest else if s_logger isDebugEnabled s_logger debug profile throw new InsufficientServerCapacityException host getClusterId excludes addHost dest getHost getId
throw new CloudRuntimeException if dest null if s_logger isDebugEnabled s_logger debug dest else if s_logger isDebugEnabled s_logger debug profile throw new InsufficientServerCapacityException host getClusterId excludes addHost dest getHost getId try migrate vm srcHostId dest return catch final ResourceUnavailableException e s_logger debug dest catch final ConcurrentOperationException e
if s_logger isDebugEnabled s_logger debug dest else if s_logger isDebugEnabled s_logger debug profile throw new InsufficientServerCapacityException host getClusterId excludes addHost dest getHost getId try migrate vm srcHostId dest return catch final ResourceUnavailableException e s_logger debug dest catch final ConcurrentOperationException e s_logger debug e getMessage try
else if s_logger isDebugEnabled s_logger debug profile throw new InsufficientServerCapacityException host getClusterId excludes addHost dest getHost getId try migrate vm srcHostId dest return catch final ResourceUnavailableException e s_logger debug dest catch final ConcurrentOperationException e s_logger debug e getMessage try advanceStop vmUuid true throw new CloudRuntimeException vm
private void orchestrateReboot final String vmUuid final Map VirtualMachineProfile Param Object params throws InsufficientCapacityException ConcurrentOperationException ResourceUnavailableException final VMInstanceVO vm _vmDao findByUuid vmUuid if _vmSnapshotMgr hasActiveVMSnapshotTasks vm getId
final DeployDestination dest new DeployDestination dc pod cluster host try final Commands cmds new Commands Command OnError Stop RebootCommand rebootCmd new RebootCommand vm getInstanceName getExecuteInSequence vm getHypervisorType VirtualMachineTO vmTo getVmTO vm getId checkAndSetEnterSetupMode vmTo params rebootCmd setVirtualMachine vmTo cmds addCommand rebootCmd _agentMgr send host getId cmds final Answer rebootAnswer cmds getAnswer RebootAnswer class if rebootAnswer null rebootAnswer getResult if dc isSecurityGroupEnabled vm getType VirtualMachine Type User List Long affectedVms new ArrayList Long affectedVms add vm getId _securityGroupManager scheduleRulesetUpdateToHosts affectedVms true null
Override public void processConnect final Host agent final StartupCommand cmd final boolean forRebalance throws ConnectionException if cmd StartupRoutingCommand return if s_logger isDebugEnabled s_logger debug agent getId _syncMgr resetHostSyncState agent getId if forRebalance s_logger debug this return final Long clusterId agent getClusterId final long agentId agent getId if agent getHypervisorType HypervisorType XenServer final ClusterVMMetaDataSyncCommand syncVMMetaDataCmd new ClusterVMMetaDataSyncCommand ClusterVMMetaDataSyncInterval value clusterId try final long seq_no _agentMgr send agentId new Commands syncVMMetaDataCmd this
return if s_logger isDebugEnabled s_logger debug agent getId _syncMgr resetHostSyncState agent getId if forRebalance s_logger debug this return final Long clusterId agent getClusterId final long agentId agent getId if agent getHypervisorType HypervisorType XenServer final ClusterVMMetaDataSyncCommand syncVMMetaDataCmd new ClusterVMMetaDataSyncCommand ClusterVMMetaDataSyncInterval value clusterId try final long seq_no _agentMgr send agentId new Commands syncVMMetaDataCmd this s_logger debug seq_no catch final AgentUnavailableException e
private NicProfile orchestrateAddVmToNetwork final VirtualMachine vm final Network network final NicProfile requested throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException final CallContext cctx CallContext current
final VirtualMachineTO vmTO hvGuru implement vmProfile final NicTO nicTO toNicTO nic vmProfile getVirtualMachine getHypervisorType if network null final Map NetworkOffering Detail String details networkOfferingDetailsDao getNtwkOffDetails network getNetworkOfferingId if details null details putIfAbsent NetworkOffering Detail PromiscuousMode NetworkOrchestrationService PromiscuousMode value toString details putIfAbsent NetworkOffering Detail MacAddressChanges NetworkOrchestrationService MacAddressChanges value toString details putIfAbsent NetworkOffering Detail ForgedTransmits NetworkOrchestrationService ForgedTransmits value toString nicTO setDetails details s_logger debug vm network boolean result false try result plugNic network nicTO vmTO context dest if result _userVmMgr setupVmForPvlan true vm getHostId nic
s_logger debug vm network boolean result false try result plugNic network nicTO vmTO context dest if result _userVmMgr setupVmForPvlan true vm getHostId nic s_logger debug vm network final long isDefault nic isDefaultNic if VirtualMachine Type User equals vmVO getType UsageEventUtils publishUsageEvent EventTypes EVENT_NETWORK_OFFERING_ASSIGN vmVO getAccountId vmVO getDataCenterId vmVO getId Long toString nic getId network getNetworkOfferingId null isDefault VirtualMachine class getName vmVO getUuid vm isDisplay return nic else s_logger warn vm network return null finally
private boolean orchestrateRemoveNicFromVm final VirtualMachine vm final Nic nic throws ConcurrentOperationException ResourceUnavailableException final CallContext cctx CallContext current final VMInstanceVO vmVO _vmDao findById vm getId final NetworkVO network _networkDao findById nic getNetworkId final ReservationContext context new ReservationContextImpl null null cctx getCallingUser cctx getCallingAccount final VirtualMachineProfileImpl vmProfile new VirtualMachineProfileImpl vmVO null null null null final DataCenter dc _entityMgr findById DataCenter class network getDataCenterId final Host host _hostDao findById vm getHostId final DeployDestination dest new DeployDestination dc null null host final HypervisorGuru hvGuru _hvGuruMgr getGuru vmProfile getVirtualMachine getHypervisorType final VirtualMachineTO vmTO hvGuru implement vmProfile final NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri _networkModel getNetworkRate network getId vm getId _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vmProfile getVirtualMachine getHypervisorType network if vm getState State Running final NicTO nicTO toNicTO nicProfile vmProfile getVirtualMachine getHypervisorType
final NetworkVO network _networkDao findById nic getNetworkId final ReservationContext context new ReservationContextImpl null null cctx getCallingUser cctx getCallingAccount final VirtualMachineProfileImpl vmProfile new VirtualMachineProfileImpl vmVO null null null null final DataCenter dc _entityMgr findById DataCenter class network getDataCenterId final Host host _hostDao findById vm getHostId final DeployDestination dest new DeployDestination dc null null host final HypervisorGuru hvGuru _hvGuruMgr getGuru vmProfile getVirtualMachine getHypervisorType final VirtualMachineTO vmTO hvGuru implement vmProfile final NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri _networkModel getNetworkRate network getId vm getId _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vmProfile getVirtualMachine getHypervisorType network if vm getState State Running final NicTO nicTO toNicTO nicProfile vmProfile getVirtualMachine getHypervisorType s_logger debug nic vm network final boolean result unplugNic network nicTO vmTO context dest if result _userVmMgr setupVmForPvlan false vm getHostId nicProfile
final NicTO nicTO toNicTO nicProfile vmProfile getVirtualMachine getHypervisorType s_logger debug nic vm network final boolean result unplugNic network nicTO vmTO context dest if result _userVmMgr setupVmForPvlan false vm getHostId nicProfile s_logger debug vm network final long isDefault nic isDefaultNic UsageEventUtils publishUsageEvent EventTypes EVENT_NETWORK_OFFERING_REMOVE vm getAccountId vm getDataCenterId vm getId Long toString nic getId network getNetworkOfferingId null isDefault VirtualMachine class getName vm getUuid vm isDisplay else s_logger warn vm network return false else if vm getState State Stopped s_logger warn vm network throw new ResourceUnavailableException vm DataCenter class vm getDataCenterId _networkMgr releaseNic vmProfile nic
Nic nic null if broadcastUri null nic _nicsDao findByNetworkIdInstanceIdAndBroadcastUri network getId vm getId broadcastUri toString else nic _networkModel getNicInNetwork vm getId network getId if nic null s_logger warn network return false if nic isDefaultNic vm getType VirtualMachine Type User s_logger warn vm network throw new CloudRuntimeException vm network final Nic lock _nicsDao acquireInLockTable nic getId if lock null if _nicsDao findById nic getId null if s_logger isDebugEnabled
else nic _networkModel getNicInNetwork vm getId network getId if nic null s_logger warn network return false if nic isDefaultNic vm getType VirtualMachine Type User s_logger warn vm network throw new CloudRuntimeException vm network final Nic lock _nicsDao acquireInLockTable nic getId if lock null if _nicsDao findById nic getId null if s_logger isDebugEnabled s_logger debug vm network return true throw new ConcurrentOperationException nic getId
return false if nic isDefaultNic vm getType VirtualMachine Type User s_logger warn vm network throw new CloudRuntimeException vm network final Nic lock _nicsDao acquireInLockTable nic getId if lock null if _nicsDao findById nic getId null if s_logger isDebugEnabled s_logger debug vm network return true throw new ConcurrentOperationException nic getId if s_logger isDebugEnabled s_logger debug lock getId vm network try final NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri _networkModel getNetworkRate network getId vm getId _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vmProfile getVirtualMachine getHypervisorType network
s_logger warn vm network throw new CloudRuntimeException vm network final Nic lock _nicsDao acquireInLockTable nic getId if lock null if _nicsDao findById nic getId null if s_logger isDebugEnabled s_logger debug vm network return true throw new ConcurrentOperationException nic getId if s_logger isDebugEnabled s_logger debug lock getId vm network try final NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri _networkModel getNetworkRate network getId vm getId _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vmProfile getVirtualMachine getHypervisorType network if vm getState State Running final NicTO nicTO toNicTO nicProfile vmProfile getVirtualMachine getHypervisorType
return true throw new ConcurrentOperationException nic getId if s_logger isDebugEnabled s_logger debug lock getId vm network try final NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri _networkModel getNetworkRate network getId vm getId _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vmProfile getVirtualMachine getHypervisorType network if vm getState State Running final NicTO nicTO toNicTO nicProfile vmProfile getVirtualMachine getHypervisorType s_logger debug vm network final boolean result unplugNic network nicTO vmTO context dest if result s_logger debug vm network else s_logger warn vm network return false
try final NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri _networkModel getNetworkRate network getId vm getId _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vmProfile getVirtualMachine getHypervisorType network if vm getState State Running final NicTO nicTO toNicTO nicProfile vmProfile getVirtualMachine getHypervisorType s_logger debug vm network final boolean result unplugNic network nicTO vmTO context dest if result s_logger debug vm network else s_logger warn vm network return false else if vm getState State Stopped s_logger warn vm network throw new ResourceUnavailableException vm DataCenter class vm getDataCenterId _networkMgr releaseNic vmProfile nic
final VirtualMachineProfile profile new VirtualMachineProfileImpl vm null newServiceOffering null null final Long srcHostId vm getHostId final Long oldSvcOfferingId vm getServiceOfferingId if srcHostId null throw new CloudRuntimeException final Host host _hostDao findById srcHostId final DataCenterDeployment plan new DataCenterDeployment host getDataCenterId host getPodId host getClusterId null null null excludes addHost vm getHostId vm setServiceOfferingId newSvcOfferingId DeployDestination dest null try dest _dpMgr planDeployment profile plan excludes null catch final AffinityConflictException e2 s_logger warn e2 throw new CloudRuntimeException
final DataCenterDeployment plan new DataCenterDeployment host getDataCenterId host getPodId host getClusterId null null null excludes addHost vm getHostId vm setServiceOfferingId newSvcOfferingId DeployDestination dest null try dest _dpMgr planDeployment profile plan excludes null catch final AffinityConflictException e2 s_logger warn e2 throw new CloudRuntimeException if dest null if s_logger isDebugEnabled s_logger debug dest if dest null throw new InsufficientServerCapacityException host getClusterId excludes addHost dest getHost getId
DeployDestination dest null try dest _dpMgr planDeployment profile plan excludes null catch final AffinityConflictException e2 s_logger warn e2 throw new CloudRuntimeException if dest null if s_logger isDebugEnabled s_logger debug dest if dest null throw new InsufficientServerCapacityException host getClusterId excludes addHost dest getHost getId try migrateForScale vm getUuid srcHostId dest oldSvcOfferingId catch final ResourceUnavailableException e
private void orchestrateMigrateForScale final String vmUuid final long srcHostId final DeployDestination dest final Long oldSvcOfferingId throws ResourceUnavailableException ConcurrentOperationException VMInstanceVO vm _vmDao findByUuid vmUuid
private void orchestrateMigrateForScale final String vmUuid final long srcHostId final DeployDestination dest final Long oldSvcOfferingId throws ResourceUnavailableException ConcurrentOperationException VMInstanceVO vm _vmDao findByUuid vmUuid s_logger info vm dest vm getServiceOfferingId final long dstHostId dest getHost getId final Host fromHost _hostDao findById srcHostId if fromHost null
s_logger info vm dest vm getServiceOfferingId final long dstHostId dest getHost getId final Host fromHost _hostDao findById srcHostId if fromHost null s_logger info srcHostId throw new CloudRuntimeException srcHostId if fromHost getClusterId longValue dest getCluster getId s_logger info dstHostId throw new CloudRuntimeException dest getHost getId final VirtualMachineGuru vmGuru getVmGuru vm final long vmId vm getId vm _vmDao findByUuid vmUuid if vm null if s_logger isDebugEnabled
if fromHost null s_logger info srcHostId throw new CloudRuntimeException srcHostId if fromHost getClusterId longValue dest getCluster getId s_logger info dstHostId throw new CloudRuntimeException dest getHost getId final VirtualMachineGuru vmGuru getVmGuru vm final long vmId vm getId vm _vmDao findByUuid vmUuid if vm null if s_logger isDebugEnabled s_logger debug vm throw new CloudRuntimeException vmId if vm getState State Running if s_logger isDebugEnabled
final PrepareForMigrationCommand pfmc new PrepareForMigrationCommand to ItWorkVO work new ItWorkVO UUID randomUUID toString _nodeId State Migrating vm getType vm getId work setStep Step Prepare work setResourceType ItWorkVO ResourceType Host work setResourceId dstHostId work _workDao persist work Answer pfma null try pfma _agentMgr send dstHostId pfmc if pfma null pfma getResult final String details pfma null pfma getDetails final String msg details pfma null throw new AgentUnavailableException msg dstHostId catch final OperationTimedoutException e1
work setResourceType ItWorkVO ResourceType Host work setResourceId dstHostId work _workDao persist work Answer pfma null try pfma _agentMgr send dstHostId pfmc if pfma null pfma getResult final String details pfma null pfma getDetails final String msg details pfma null throw new AgentUnavailableException msg dstHostId catch final OperationTimedoutException e1 throw new AgentUnavailableException dstHostId finally if pfma null
throw new ConcurrentOperationException e1 getMessage boolean migrated false try final boolean isWindows _guestOsCategoryDao findById _guestOsDao findById vm getGuestOSId getCategoryId getName equalsIgnoreCase final MigrateCommand mc new MigrateCommand vm getInstanceName dest getHost getPrivateIpAddress isWindows to getExecuteInSequence vm getHypervisorType boolean kvmAutoConvergence StorageManager KvmAutoConvergence value mc setAutoConvergence kvmAutoConvergence mc setHostGuid dest getHost getGuid try final Answer ma _agentMgr send vm getLastHostId mc if ma null ma getResult final String details ma null ma getDetails final String msg details s_logger error msg throw new CloudRuntimeException msg
mc setHostGuid dest getHost getGuid try final Answer ma _agentMgr send vm getLastHostId mc if ma null ma getResult final String details ma null ma getDetails final String msg details s_logger error msg throw new CloudRuntimeException msg catch final OperationTimedoutException e if e isActive s_logger warn vm _haMgr scheduleRestart vm true throw new AgentUnavailableException vm dstHostId try final long newServiceOfferingId vm getServiceOfferingId
final String details ma null ma getDetails final String msg details s_logger error msg throw new CloudRuntimeException msg catch final OperationTimedoutException e if e isActive s_logger warn vm _haMgr scheduleRestart vm true throw new AgentUnavailableException vm dstHostId try final long newServiceOfferingId vm getServiceOfferingId vm setServiceOfferingId oldSvcOfferingId if changeState vm VirtualMachine Event OperationSucceeded dstHostId work Step Started throw new ConcurrentOperationException vm vm setServiceOfferingId newServiceOfferingId
public boolean plugNic final Network network final NicTO nic final VirtualMachineTO vm final ReservationContext context final DeployDestination dest throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException boolean result true final VMInstanceVO router _vmDao findById vm getId if router getState State Running try NetworkDetailVO pvlanTypeDetail networkDetailsDao findDetail network getId ApiConstants ISOLATED_PVLAN_TYPE if pvlanTypeDetail null Map NetworkOffering Detail String nicDetails nic getDetails null new HashMap nic getDetails
UserVmVO userVm _userVmDao findById vm getId if userVm null userVm getType VirtualMachine Type User _userVmService collectVmNetworkStatistics userVm try final Commands cmds new Commands Command OnError Stop final UnPlugNicCommand unplugNicCmd new UnPlugNicCommand nic vm getName cmds addCommand unplugNicCmd _agentMgr send dest getHost getId cmds final UnPlugNicAnswer unplugNicAnswer cmds getAnswer UnPlugNicAnswer class if unplugNicAnswer null unplugNicAnswer getResult s_logger warn router result false catch final OperationTimedoutException e throw new AgentUnavailableException router network dest getHost getId e else if router getState State Stopped router getState State Stopping
s_logger info vm getInstanceName _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_SYNC vm getDataCenterId vm getPodIdToDeployIn VM_SYNC_ALERT_SUBJECT vm getHostName vm getInstanceName break case Running try if vm getHostId null vm getHostId longValue vm getPowerHostId longValue s_logger info vm getHostId vm getPowerHostId stateTransitTo vm VirtualMachine Event FollowAgentPowerOnReport vm getPowerHostId catch final NoTransitionException e s_logger warn e break case Stopping case Stopped s_logger info vm getInstanceName vm getState try stateTransitTo vm VirtualMachine Event FollowAgentPowerOnReport vm getPowerHostId catch final NoTransitionException e s_logger warn e
catch final NoTransitionException e s_logger warn e break case Stopping case Stopped s_logger info vm getInstanceName vm getState try stateTransitTo vm VirtualMachine Event FollowAgentPowerOnReport vm getPowerHostId catch final NoTransitionException e s_logger warn e _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_SYNC vm getDataCenterId vm getPodIdToDeployIn VM_SYNC_ALERT_SUBJECT vm getHostName vm getInstanceName vm getState s_logger info vm getInstanceName break case Destroyed case Expunging s_logger info vm getId vm getState break case Migrating s_logger info vm getInstanceName vm getState try
private void handlePowerOffReportWithNoPendingJobsOnVM final VMInstanceVO vm switch vm getState case Starting case Stopping case Running case Stopped case Migrating if s_logger isInfoEnabled
s_logger info vm getInstanceName if _haMgr hasPendingHaWork vm getId _haMgr scheduleRestart vm true else s_logger info vm getInstanceName return if PowerState PowerOff equals vm getPowerState final VirtualMachineGuru vmGuru getVmGuru vm final VirtualMachineProfile profile new VirtualMachineProfileImpl vm if sendStop vmGuru profile true true return try stateTransitTo vm VirtualMachine Event FollowAgentPowerOffReport null catch final NoTransitionException e s_logger warn e
ReflectionUse private Pair JobInfo Status String orchestrateStop final VmWorkStop work throws Exception final VMInstanceVO vm _entityMgr findById VMInstanceVO class work getVmId if vm null
private UserVm orchestrateRestoreVirtualMachine final long vmId final Long newTemplateId throws ResourceUnavailableException InsufficientCapacityException
private Boolean orchestrateUpdateDefaultNicForVM final VirtualMachine vm final Nic nic final Nic defaultNic
Override public void resetHostSyncState long hostId
Override public void processHostVmStateReport long hostId Map String HostVmStateReportEntry report
private void processReport long hostId Map Long VirtualMachine PowerState translatedInfo if s_logger isDebugEnabled
if _instanceDao updatePowerState entry getKey hostId entry getValue DateUtil currentGMTTime if s_logger isInfoEnabled s_logger debug hostId entry getKey entry getValue _messageBus publish null VirtualMachineManager Topics VM_POWER_STATE PublishScope GLOBAL entry getKey else if s_logger isTraceEnabled s_logger trace entry getKey Date startTime DateUtil currentGMTTime List VMInstanceVO vmsThatAreMissingReport _instanceDao findByHostInStates hostId VirtualMachine State Running VirtualMachine State Stopping VirtualMachine State Starting java util Iterator VMInstanceVO it vmsThatAreMissingReport iterator while it hasNext VMInstanceVO instance it next if translatedInfo get instance getId null it remove if vmsThatAreMissingReport size Date currentTime DateUtil currentGMTTime
Date currentTime DateUtil currentGMTTime if s_logger isDebugEnabled s_logger debug currentTime getTime long milliSecondsGracefullPeriod mgmtServiceConf getPingInterval 2000L for VMInstanceVO instance vmsThatAreMissingReport try if _instanceDao isPowerStateUpToDate instance getId s_logger warn instance getId _instanceDao resetVmPowerStateTracking instance getId continue catch CloudRuntimeException e s_logger warn e continue Date vmStateUpdateTime instance getPowerStateUpdateTime if vmStateUpdateTime null
long milliSecondsGracefullPeriod mgmtServiceConf getPingInterval 2000L for VMInstanceVO instance vmsThatAreMissingReport try if _instanceDao isPowerStateUpToDate instance getId s_logger warn instance getId _instanceDao resetVmPowerStateTracking instance getId continue catch CloudRuntimeException e s_logger warn e continue Date vmStateUpdateTime instance getPowerStateUpdateTime if vmStateUpdateTime null s_logger warn instance getId vmStateUpdateTime instance getUpdateTime if vmStateUpdateTime null
try if _instanceDao isPowerStateUpToDate instance getId s_logger warn instance getId _instanceDao resetVmPowerStateTracking instance getId continue catch CloudRuntimeException e s_logger warn e continue Date vmStateUpdateTime instance getPowerStateUpdateTime if vmStateUpdateTime null s_logger warn instance getId vmStateUpdateTime instance getUpdateTime if vmStateUpdateTime null s_logger warn instance getId vmStateUpdateTime instance getCreated
continue catch CloudRuntimeException e s_logger warn e continue Date vmStateUpdateTime instance getPowerStateUpdateTime if vmStateUpdateTime null s_logger warn instance getId vmStateUpdateTime instance getUpdateTime if vmStateUpdateTime null s_logger warn instance getId vmStateUpdateTime instance getCreated if s_logger isInfoEnabled String lastTime new SimpleDateFormat format vmStateUpdateTime s_logger debug String format hostId instance getId instance getUuid VirtualMachine PowerState PowerReportMissing lastTime long milliSecondsSinceLastStateUpdate currentTime getTime vmStateUpdateTime getTime
catch CloudRuntimeException e s_logger warn e continue Date vmStateUpdateTime instance getPowerStateUpdateTime if vmStateUpdateTime null s_logger warn instance getId vmStateUpdateTime instance getUpdateTime if vmStateUpdateTime null s_logger warn instance getId vmStateUpdateTime instance getCreated if s_logger isInfoEnabled String lastTime new SimpleDateFormat format vmStateUpdateTime s_logger debug String format hostId instance getId instance getUuid VirtualMachine PowerState PowerReportMissing lastTime long milliSecondsSinceLastStateUpdate currentTime getTime vmStateUpdateTime getTime if milliSecondsSinceLastStateUpdate milliSecondsGracefullPeriod
Class workClz null try workClz Class forName job getCmd catch ClassNotFoundException e s_logger error cmd job getRelated e _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED e getMessage return work VmWorkSerializer deserialize workClz job getCmdInfo if work null s_logger error job getCmd job getCmdInfo job getRelated _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED return if s_logger isDebugEnabled s_logger debug cmd work getVmId job getRelated try if _handlers null _handlers isEmpty
s_logger error cmd job getRelated e _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED e getMessage return work VmWorkSerializer deserialize workClz job getCmdInfo if work null s_logger error job getCmd job getCmdInfo job getRelated _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED return if s_logger isDebugEnabled s_logger debug cmd work getVmId job getRelated try if _handlers null _handlers isEmpty s_logger error job getCmd job getCmdInfo job getRelated _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED return VmWorkJobHandler handler _handlers get work getHandlerName
if _handlers null _handlers isEmpty s_logger error job getCmd job getCmdInfo job getRelated _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED return VmWorkJobHandler handler _handlers get work getHandlerName if handler null s_logger error work getHandlerName job getCmd job getCmdInfo job getRelated _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED return CallContext register work getUserId work getAccountId try Pair JobInfo Status String result handler handleVmWorkJob work _asyncJobMgr completeAsyncJob job getId result first result second finally CallContext unregister
return VmWorkJobHandler handler _handlers get work getHandlerName if handler null s_logger error work getHandlerName job getCmd job getCmdInfo job getRelated _asyncJobMgr completeAsyncJob job getId JobInfo Status FAILED return CallContext register work getUserId work getAccountId try Pair JobInfo Status String result handler handleVmWorkJob work _asyncJobMgr completeAsyncJob job getId result first result second finally CallContext unregister finally if s_logger isDebugEnabled s_logger debug cmd work getVmId job getRelated catch InvalidParameterValueException e
catch ClassNotFoundException e s_logger error job getCmd e return VmWork work VmWorkSerializer deserialize workClz joinedJob getCmdInfo assert work null AccountVO account _accountDao findById work getAccountId assert account null VMInstanceVO vm _instanceDao findById work getVmId assert vm null CallContext register work getUserId work getAccountId job getRelated try Method handler getHandler joinRecord getWakeupHandler if handler null handler invoke _vmMgr else
SearchCriteria EngineClusterVO sc StateChangeSearch create sc setParameters vo getId sc setParameters currentState UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update vo sc if rows s_logger isDebugEnabled EngineClusterVO dbCluster findByIdIncludingRemoved vo getId if dbCluster null StringBuilder str new StringBuilder append vo toString str append append dbCluster getId append append dbCluster getState append append dbCluster getLastUpdated str append append vo getId append append nextState append append event append append vo getLastUpdated str append append vo getId append append currentState append append event append append oldUpdatedTime else
SearchCriteria EngineDataCenterVO sc StateChangeSearch create sc setParameters vo getId sc setParameters currentState UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update vo sc if rows s_logger isDebugEnabled EngineDataCenterVO dbDC findByIdIncludingRemoved vo getId if dbDC null StringBuilder str new StringBuilder append vo toString str append append dbDC getId append append dbDC getState append append dbDC getLastUpdated str append append vo getId append append nextState append append event append append vo getLastUpdated str append append vo getId append append currentState append append event append append oldUpdatedTime else
SearchCriteria EngineHostVO sc StateChangeSearch create sc setParameters hostEntity getId sc setParameters currentState UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update vo sc if rows s_logger isDebugEnabled EngineHostVO dbHost findByIdIncludingRemoved vo getId if dbHost null StringBuilder str new StringBuilder append vo toString str append append dbHost getId append append dbHost getState append append dbHost getLastUpdated str append append vo getId append append nextState append append event append append vo getLastUpdated str append append vo getId append append currentState append append event append append oldUpdatedTime else
SearchCriteria EngineHostPodVO sc StateChangeSearch create sc setParameters vo getId sc setParameters currentState UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update vo sc if rows s_logger isDebugEnabled EngineHostPodVO dbDC findByIdIncludingRemoved vo getId if dbDC null StringBuilder str new StringBuilder append vo toString str append append dbDC getId append append dbDC getState append append dbDC getLastUpdated str append append vo getId append append nextState append append event append append vo getLastUpdated str append append vo getId append append currentState append append event append append oldUpdatedTime else
Override public boolean start final int netGcInterval NumbersUtil parseInt _configDao getValue NetworkGcInterval key
DB Override public Pair NicProfile Integer allocateNic final NicProfile requested final Network network final Boolean isDefaultNic int deviceId final VirtualMachineProfile vm throws InsufficientVirtualNetworkCapacityException InsufficientAddressCapacityException ConcurrentOperationException final NetworkVO ntwkVO _networksDao findById network getId
Override DB public Pair NetworkGuru NetworkVO implementNetwork final long networkId final DeployDestination dest final ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException final Pair NetworkGuru NetworkVO implemented new Pair NetworkGuru NetworkVO null null NetworkVO network _networksDao findById networkId final NetworkGuru guru AdapterBase getAdapterByName networkGurus network getGuruName if isNetworkImplemented network
NetworkVO network _networksDao findById networkId final NetworkGuru guru AdapterBase getAdapterByName networkGurus network getGuruName if isNetworkImplemented network s_logger debug networkId implemented set guru network return implemented network _networksDao acquireInLockTable networkId NetworkLockTimeout value if network null final ConcurrentOperationException ex new ConcurrentOperationException ex addProxyObject _entityMgr findById Network class networkId getUuid throw ex if s_logger isDebugEnabled s_logger debug networkId try if isNetworkImplemented network
implemented set guru network return implemented network _networksDao acquireInLockTable networkId NetworkLockTimeout value if network null final ConcurrentOperationException ex new ConcurrentOperationException ex addProxyObject _entityMgr findById Network class networkId getUuid throw ex if s_logger isDebugEnabled s_logger debug networkId try if isNetworkImplemented network s_logger debug networkId implemented set guru network return implemented if s_logger isDebugEnabled
network setBroadcastUri result getBroadcastUri network setGateway result getGateway network setMode result getMode network setPhysicalNetworkId result getPhysicalNetworkId _networksDao update networkId network implementNetworkElementsAndResources dest context network offering if isSharedNetworkWithServices network network setState Network State Implemented else stateTransitTo network Event OperationSucceeded network setRestartRequired false _networksDao update network getId network implemented set guru network return implemented catch final NoTransitionException e
else stateTransitTo network Event OperationSucceeded network setRestartRequired false _networksDao update network getId network implemented set guru network return implemented catch final NoTransitionException e s_logger error e getMessage return null catch final CloudRuntimeException e s_logger error e getMessage return null finally if implemented first null s_logger debug network
network setRestartRequired false _networksDao update network getId network implemented set guru network return implemented catch final NoTransitionException e s_logger error e getMessage return null catch final CloudRuntimeException e s_logger error e getMessage return null finally if implemented first null s_logger debug network try if isSharedNetworkWithServices network
return implemented catch final NoTransitionException e s_logger error e getMessage return null catch final CloudRuntimeException e s_logger error e getMessage return null finally if implemented first null s_logger debug network try if isSharedNetworkWithServices network network setState Network State Shutdown _networksDao update networkId network else
Override public void implementNetworkElementsAndResources final DeployDestination dest final ReservationContext context final Network network final NetworkOffering offering throws ConcurrentOperationException InsufficientAddressCapacityException ResourceUnavailableException InsufficientCapacityException final boolean sharedSourceNat offering isSharedSourceNat final DataCenter zone _dcDao findById network getDataCenterId if sharedSourceNat _networkModel areServicesSupportedInNetwork network getId Service SourceNat network getGuestType Network GuestType Isolated network getGuestType Network GuestType Shared zone getNetworkType NetworkType Advanced List IPAddressVO ips null final Account owner _entityMgr findById Account class network getAccountId if network getVpcId null ips _ipAddressDao listByAssociatedVpc network getVpcId true if ips isEmpty final Vpc vpc _vpcMgr getActiveVpc network getVpcId
Override public void implementNetworkElementsAndResources final DeployDestination dest final ReservationContext context final Network network final NetworkOffering offering throws ConcurrentOperationException InsufficientAddressCapacityException ResourceUnavailableException InsufficientCapacityException final boolean sharedSourceNat offering isSharedSourceNat final DataCenter zone _dcDao findById network getDataCenterId if sharedSourceNat _networkModel areServicesSupportedInNetwork network getId Service SourceNat network getGuestType Network GuestType Isolated network getGuestType Network GuestType Shared zone getNetworkType NetworkType Advanced List IPAddressVO ips null final Account owner _entityMgr findById Account class network getAccountId if network getVpcId null ips _ipAddressDao listByAssociatedVpc network getVpcId true if ips isEmpty final Vpc vpc _vpcMgr getActiveVpc network getVpcId s_logger debug vpc _vpcMgr assignSourceNatIpAddressToVpc owner vpc else ips _ipAddressDao listByAssociatedNetwork network getId true if ips isEmpty
else ips _ipAddressDao listByAssociatedNetwork network getId true if ips isEmpty s_logger debug network _ipAddrMgr assignSourceNatIpAddressToGuestNetwork owner network final List Provider providersToImplement getNetworkProviders network getId implementNetworkElements dest context network offering providersToImplement List NicVO nicVOs _nicDao listByNetworkId network getId for NicVO nicVO nicVOs if nicVO getState Nic State Reserved configureExtraDhcpOptions network nicVO getId for final NetworkElement element networkElements if element AggregatedCommandExecutor providersToImplement contains element getProvider AggregatedCommandExecutor element prepareAggregatedExecution network dest try
Override public void cleanupConfigForServicesInNetwork List String services final Network network long networkId network getId Account caller _accountDao findById Account ACCOUNT_ID_SYSTEM long userId User UID_SYSTEM
Override public void cleanupConfigForServicesInNetwork List String services final Network network long networkId network getId Account caller _accountDao findById Account ACCOUNT_ID_SYSTEM long userId User UID_SYSTEM s_logger info services network getUuid network getNetworkOfferingId if services contains Service StaticNat getName services contains Service PortForwarding getName try if _rulesMgr revokeAllPFStaticNatRulesForNetwork networkId userId caller
ip setOneToOneNat false ip setAssociatedWithVmId null ip setVmIp null _ipAddressDao update ip getId ip catch ResourceUnavailableException ex s_logger warn networkId ex if services contains Service SourceNat getName Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status List IPAddressVO ips _ipAddressDao listByAssociatedNetwork network getId true for IPAddressVO ip ips ip setSourceNat false _ipAddressDao update ip getId ip
catch ResourceUnavailableException ex s_logger warn networkId ex if services contains Service SourceNat getName Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status List IPAddressVO ips _ipAddressDao listByAssociatedNetwork network getId true for IPAddressVO ip ips ip setSourceNat false _ipAddressDao update ip getId ip if services contains Service Lb getName if _lbMgr removeAllLoadBalanacersForNetwork networkId caller userId s_logger debug networkId else
DB protected void updateNic final NicVO nic final long networkId final int count Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status _nicDao update nic getId nic if nic getVmType VirtualMachine Type User
nic setIPv4Netmask profile getIPv4Netmask nic setIPv4Gateway profile getIPv4Gateway if profile getReservationStrategy null nic setReservationStrategy profile getReservationStrategy updateNic nic network getId else profile new NicProfile nic network nic getBroadcastUri nic getIsolationUri networkRate _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vmProfile getHypervisorType network guru updateNicProfile profile network nic setState Nic State Reserved updateNic nic network getId final List Provider providersToImplement getNetworkProviders network getId for final NetworkElement element networkElements if providersToImplement contains element getProvider if _networkModel isProviderEnabledInPhysicalNetwork _networkModel getPhysicalNetworkId network element getProvider getName throw new CloudRuntimeException element getProvider getName network getPhysicalNetworkId
final NetworkVO network _networksDao findById nic getNetworkId final Integer networkRate _networkModel getNetworkRate network getId vm getId final NetworkGuru guru AdapterBase getAdapterByName networkGurus network getGuruName final NicProfile profile new NicProfile nic network nic getBroadcastUri nic getIsolationUri networkRate _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vm getHypervisorType network if guru NetworkMigrationResponder if NetworkMigrationResponder guru prepareMigration profile network vm dest context s_logger error guru if network getGuestType Network GuestType L2 vm getType VirtualMachine Type User _userVmMgr setupVmForPvlan false vm getVirtualMachine getHostId profile final List Provider providersToImplement getNetworkProviders network getId for final NetworkElement element networkElements if providersToImplement contains element getProvider if _networkModel isProviderEnabledInPhysicalNetwork _networkModel getPhysicalNetworkId network element getProvider getName throw new CloudRuntimeException element getProvider getName network getPhysicalNetworkId if element NetworkMigrationResponder
if network getTrafficType equals TrafficType Guest network getGuestType equals GuestType Isolated guestNetworkId network getId final Integer networkRate _networkModel getNetworkRate network getId vm getId final NetworkGuru guru AdapterBase getAdapterByName networkGurus network getGuruName final NicProfile profile new NicProfile nic network nic getBroadcastUri nic getIsolationUri networkRate _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vm getHypervisorType network if guru NetworkMigrationResponder if NetworkMigrationResponder guru prepareMigration profile network vm dest context s_logger error guru final List Provider providersToImplement getNetworkProviders network getId for final NetworkElement element networkElements if providersToImplement contains element getProvider if _networkModel isProviderEnabledInPhysicalNetwork _networkModel getPhysicalNetworkId network element getProvider getName throw new CloudRuntimeException element getProvider getName network getPhysicalNetworkId if element NetworkMigrationResponder if NetworkMigrationResponder element prepareMigration profile network vm dest context
for final NetworkElement element networkElements if providersToImplement contains element getProvider if _networkModel isProviderEnabledInPhysicalNetwork _networkModel getPhysicalNetworkId network element getProvider getName throw new CloudRuntimeException element getProvider getName network getPhysicalNetworkId if element NetworkMigrationResponder if NetworkMigrationResponder element prepareMigration profile network vm dest context s_logger error element guru updateNicProfile profile network vm addNic profile final List String addedURIs new ArrayList String if guestNetworkId null final List IPAddressVO publicIps _ipAddressDao listByAssociatedNetwork guestNetworkId null for final IPAddressVO userIp publicIps final PublicIp publicIp PublicIp createFromAddrAndVlan userIp _vlanDao findById userIp getVlanId final URI broadcastUri BroadcastDomainType Vlan toUri publicIp getVlanTag
else nic setState Nic State Allocated updateNic nic network getId return null if vmProfile getType equals VirtualMachine Type User final NicVO nic _nicDao findById nicId if nic null final NetworkVO vmNetwork _networksDao findById nic getNetworkId final VMNetworkMapVO vno _vmNetworkMapDao findByVmAndNetworkId vmProfile getVirtualMachine getId vmNetwork getId if vno null _vmNetworkMapDao remove vno getId if networkToRelease null final Network network networkToRelease first final NicProfile profile networkToRelease second
Override public void cleanupNics final VirtualMachineProfile vm if s_logger isDebugEnabled
final NetworkVO network _networksDao findById nic getNetworkId if network null network getTrafficType TrafficType Guest final String nicIp Strings isNullOrEmpty nic getIPv4Address nic getIPv6Address nic getIPv4Address if Strings isNullOrEmpty nicIp NicProfile nicProfile new NicProfile nic getIPv4Address nic getIPv6Address nic getMacAddress nicProfile setId nic getId cleanupNicDhcpDnsEntry network vm nicProfile Boolean preserveNics Boolean vm getParameter VirtualMachineProfile Param PreserveNics if BooleanUtils isNotTrue preserveNics nic setState Nic State Deallocating _nicDao update nic getId nic final NicProfile profile new NicProfile nic network null null null _networkModel isSecurityGroupSupportedInNetwork network _networkModel getNetworkTag vm getHypervisorType network if nic getReservationStrategy Nic ReservationStrategy Create final List Provider providersToImplement getNetworkProviders network getId for final NetworkElement element networkElements
catch final ConcurrentOperationException ex s_logger warn nic toString ex catch final ResourceUnavailableException ex s_logger warn nic toString ex if vm getType Type User network getTrafficType TrafficType Guest network getGuestType GuestType Shared isLastNicInSubnet nic if _networkModel areServicesSupportedInNetwork network getId Service Dhcp final DhcpServiceProvider dhcpServiceProvider getDhcpServiceProvider network if dhcpServiceProvider null isDhcpAccrossMultipleSubnetsSupported dhcpServiceProvider removeDhcpServiceInSubnet nic if _networkModel areServicesSupportedInNetwork network getId Service Dns final DnsServiceProvider dnsServiceProvider getDnsServiceProvider network if dnsServiceProvider null try if dnsServiceProvider removeDnsSupportForSubnet network s_logger warn
catch final ConcurrentOperationException ex s_logger warn nic toString ex catch final ResourceUnavailableException ex s_logger warn nic toString ex if vm getType Type User network getTrafficType TrafficType Guest network getGuestType GuestType Shared isLastNicInSubnet nic if _networkModel areServicesSupportedInNetwork network getId Service Dhcp final DhcpServiceProvider dhcpServiceProvider getDhcpServiceProvider network if dhcpServiceProvider null isDhcpAccrossMultipleSubnetsSupported dhcpServiceProvider removeDhcpServiceInSubnet nic if _networkModel areServicesSupportedInNetwork network getId Service Dns final DnsServiceProvider dnsServiceProvider getDnsServiceProvider network if dnsServiceProvider null try if dnsServiceProvider removeDnsSupportForSubnet network s_logger warn
Override DB public boolean shutdownNetwork final long networkId final ReservationContext context final boolean cleanupElements NetworkVO network _networksDao findById networkId if network getState Network State Allocated
NetworkVO network _networksDao findById networkId if network getState Network State Allocated s_logger debug network return true if network getState Network State Implemented network getState Network State Shutdown s_logger debug network return false try network _networksDao acquireInLockTable networkId NetworkLockTimeout value if network null s_logger warn network return false if s_logger isDebugEnabled s_logger debug network if network getState Network State Allocated
return true if network getState Network State Implemented network getState Network State Shutdown s_logger debug network return false try network _networksDao acquireInLockTable networkId NetworkLockTimeout value if network null s_logger warn network return false if s_logger isDebugEnabled s_logger debug network if network getState Network State Allocated s_logger debug network return true if network getState Network State Implemented network getState Network State Shutdown
if provider cleanupNeededOnShutdown cleanupNeeded true break if cleanupNeeded cleanupResult shutdownNetworkResources network getId context getAccount context getCaller getId catch final Exception ex s_logger warn network ex finally if cleanupResult s_logger warn network getId boolean success true for final NetworkElement element networkElements if providersToShutdown contains element getProvider try if s_logger isDebugEnabled
Override DB public boolean destroyNetwork final long networkId final ReservationContext context final boolean forced final Account callerAccount context getAccount NetworkVO network _networksDao findById networkId if network null
if vm getState VirtualMachine State Expunging vm getRemoved null s_logger warn vm vm getState return false final int nicCount getActiveNicsInNetwork networkId if nicCount s_logger debug networkId _networksDao changeActiveNicsBy networkId nicCount final DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Basic final List VMInstanceVO systemVms _vmDao listNonRemovedVmsByTypeAndNetwork network getId Type ConsoleProxy Type SecondaryStorageVm if systemVms null systemVms isEmpty s_logger warn return false shutdownNetwork networkId context false network _networksDao findById networkId
s_logger warn networkId return false final List Provider providersToDestroy getNetworkProviders network getId for final NetworkElement element networkElements if providersToDestroy contains element getProvider try if s_logger isDebugEnabled s_logger debug element if element destroy network context success false s_logger warn element getName catch final ResourceUnavailableException e s_logger warn element getName e success false catch final ConcurrentOperationException e
catch final ResourceUnavailableException e s_logger warn element getName e success false catch final ConcurrentOperationException e s_logger warn element getName e success false catch final Exception e s_logger warn element getName e success false if success if s_logger isDebugEnabled s_logger debug networkId final NetworkVO networkFinal network try Transaction execute new TransactionCallbackNoReturn
final NetworkVO networkFinal network try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final NetworkGuru guru AdapterBase getAdapterByName networkGurus networkFinal getGuruName if guru trash networkFinal _networkOfferingDao findById networkFinal getNetworkOfferingId throw new CloudRuntimeException if deleteVlansInNetwork networkFinal getId context getCaller getId callerAccount s_logger warn networkFinal throw new CloudRuntimeException networkFinal else try stateTransitTo networkFinal Event DestroyNetwork catch final NoTransitionException e s_logger debug e getMessage
Override public boolean restartNetwork final Long networkId final Account callerAccount final User callerUser final boolean cleanup throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException boolean status true boolean restartRequired false final NetworkVO network _networksDao findById networkId
Override public void destroyExpendableRouters final List extends VirtualRouter routers final ReservationContext context throws ResourceUnavailableException final List VirtualRouter remainingRouters new ArrayList for final VirtualRouter router routers if router getState VirtualMachine State Stopped router getState VirtualMachine State Error router getState VirtualMachine State Shutdown router getState VirtualMachine State Unknown
Override public boolean areRoutersRunning final List extends VirtualRouter routers for final VirtualRouter router routers if router getState VirtualMachine State Running
private void setRestartRequired final NetworkVO network final boolean restartRequired
Override public UserDataServiceProvider getPasswordResetProvider final Network network final String passwordProvider _ntwkSrvcDao getProviderForServiceInNetwork network getId Service UserData if passwordProvider null
Override public UserDataServiceProvider getSSHKeyResetProvider final Network network final String SSHKeyProvider _ntwkSrvcDao getProviderForServiceInNetwork network getId Service UserData if SSHKeyProvider null
Override public DhcpServiceProvider getDhcpServiceProvider final Network network final String DhcpProvider _ntwkSrvcDao getProviderForServiceInNetwork network getId Service Dhcp if DhcpProvider null
Override public DnsServiceProvider getDnsServiceProvider final Network network final String dnsProvider _ntwkSrvcDao getProviderForServiceInNetwork network getId Service Dns if dnsProvider null
private boolean shutdownNetworkResources final long networkId final Account caller final long callerUserId boolean success true final Network network _networksDao findById networkId final List PortForwardingRuleVO pfRules _portForwardingRulesDao listByNetwork networkId if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug pfRules size networkId for final PortForwardingRuleVO pfRule pfRules s_logger trace pfRule pfRule setState FirewallRule State Revoke try if _firewallMgr applyRules pfRules true false s_logger warn success false catch final ResourceUnavailableException ex s_logger warn ex success false final List FirewallRuleVO firewallStaticNatRules _firewallDao listByNetworkAndPurpose networkId Purpose StaticNat final List StaticNatRule staticNatRules new ArrayList StaticNatRule if s_logger isDebugEnabled
try if _firewallMgr applyRules staticNatRules true false s_logger warn success false catch final ResourceUnavailableException ex s_logger warn ex success false try if _lbMgr revokeLoadBalancersForNetwork networkId Scheme Public s_logger warn success false catch final ResourceUnavailableException ex s_logger warn ex success false try
success false catch final ResourceUnavailableException ex s_logger warn ex success false try if _lbMgr revokeLoadBalancersForNetwork networkId Scheme Internal s_logger warn success false catch final ResourceUnavailableException ex s_logger warn ex success false final List FirewallRuleVO firewallRules _firewallDao listByNetworkPurposeTrafficType networkId Purpose Firewall FirewallRule TrafficType Ingress if s_logger isDebugEnabled s_logger debug firewallRules size networkId for final FirewallRuleVO firewallRule firewallRules
for final FirewallRuleVO firewallRule firewallRules s_logger trace firewallRule firewallRule setState FirewallRule State Revoke try if _firewallMgr applyRules firewallRules true false s_logger warn success false catch final ResourceUnavailableException ex s_logger warn ex success false final List FirewallRuleVO firewallEgressRules _firewallDao listByNetworkPurposeTrafficType networkId Purpose Firewall FirewallRule TrafficType Egress if s_logger isDebugEnabled s_logger debug firewallEgressRules size networkId try final DataCenter zone _dcDao findById network getDataCenterId
final long hostId host getId final StartupRoutingCommand startup StartupRoutingCommand cmd final String dataCenter startup getDataCenter long dcId DataCenterVO dc _dcDao findByName dataCenter if dc null try dcId Long parseLong dataCenter dc _dcDao findById dcId catch final NumberFormatException e if dc null throw new IllegalArgumentException startup getPrivateIpAddress dataCenter dcId dc getId final HypervisorType hypervisorType startup getHypervisorType if s_logger isDebugEnabled
if nic null vmProfile getType VirtualMachine Type User final int deviceId _nicDao getFreeDeviceId vm getId nic allocateNic requested network false deviceId vmProfile first if nic null throw new CloudRuntimeException vm network if vmProfile getType VirtualMachine Type User final VMNetworkMapVO vno new VMNetworkMapVO vm getId network getId _vmNetworkMapDao persist vno s_logger debug vm network if prepare final Pair NetworkGuru NetworkVO implemented implementNetwork nic getNetworkId dest context vmProfile getVirtualMachine getType Type DomainRouter if implemented null implemented first null s_logger warn nic getNetworkId nic getId throw new CloudRuntimeException nic getNetworkId nic getId nic prepareNic vmProfile dest context nic getId implemented second
protected List NetworkElement getElementForServiceInNetwork final Network network final Service service final List NetworkElement elements new ArrayList NetworkElement final List Provider providers getProvidersForServiceInNetwork network service if providers null
DB Override public Pair NicProfile Integer importNic final String macAddress int deviceId final Network network final Boolean isDefaultNic final VirtualMachine vm final Network IpAddresses ipAddresses final boolean forced throws ConcurrentOperationException InsufficientVirtualNetworkCapacityException InsufficientAddressCapacityException
existingNic setRemoved new Date _nicDao update existingNic getId existingNic NicVO vo new NicVO network getGuruName vm getId network getId vm getType vo setMacAddress macAddress vo setAddressFormat Networks AddressFormat Ip4 if NetUtils isValidIp4 finalGuestIp Strings isNullOrEmpty network getGateway vo setIPv4Address finalGuestIp vo setIPv4Gateway network getGateway if Strings isNullOrEmpty network getCidr vo setIPv4Netmask NetUtils cidr2Netmask network getCidr vo setBroadcastUri network getBroadcastUri vo setMode network getMode vo setState Nic State Reserved vo setReservationStrategy ReservationStrategy Start vo setReservationId UUID randomUUID toString
Override public void unmanageNics VirtualMachineProfile vm if s_logger isDebugEnabled
if vm getState State Running hostId vm getHostId if hostId null Host vmHost _entityMgr findById Host class hostId clusterId vmHost getClusterId else List VolumeVO rootVolumesOfVm _volsDao findByInstanceAndType vm getId Volume Type ROOT if rootVolumesOfVm size throw new CloudRuntimeException vm getHostName else VolumeVO rootVolumeOfVm rootVolumesOfVm get StoragePoolVO rootDiskPool _storagePoolDao findById rootVolumeOfVm getPoolId clusterId rootDiskPool null null rootDiskPool getClusterId while pool findStoragePool dskCh dc pod first clusterId hostId vm poolsToAvoid null break
else VolumeVO rootVolumeOfVm rootVolumesOfVm get StoragePoolVO rootDiskPool _storagePoolDao findById rootVolumeOfVm getPoolId clusterId rootDiskPool null null rootDiskPool getClusterId while pool findStoragePool dskCh dc pod first clusterId hostId vm poolsToAvoid null break if pool null if s_logger isDebugEnabled s_logger debug vm getUuid StringBuilder addDetails new StringBuilder msg addDetails append addDetails append vm getUuid msg addDetails toString else while pod findPod null null dc account getId podsToAvoid null
clusterId rootDiskPool null null rootDiskPool getClusterId while pool findStoragePool dskCh dc pod first clusterId hostId vm poolsToAvoid null break if pool null if s_logger isDebugEnabled s_logger debug vm getUuid StringBuilder addDetails new StringBuilder msg addDetails append addDetails append vm getUuid msg addDetails toString else while pod findPod null null dc account getId podsToAvoid null podsToAvoid add pod first getId while pool findStoragePool dskCh dc pod first null null null poolsToAvoid null break
DiskProfile dskCh createDiskCharacteristics volume template dc diskOffering dskCh setHyperType vm getHypervisorType storageMgr setDiskProfileThrottling dskCh null diskOffering StoragePool destPool findStoragePool dskCh dc pod clusterId null vm avoidPools if destPool null throw new CloudRuntimeException vm getUuid DataStore destStore dataStoreMgr getDataStore destPool getId DataStoreRole Primary AsyncCallFuture VolumeApiResult future volService copyVolume volume destStore try VolumeApiResult result future get if result isFailed s_logger debug result getResult throw new CloudRuntimeException result getResult return result getVolume catch InterruptedException e
StoragePool destPool findStoragePool dskCh dc pod clusterId null vm avoidPools if destPool null throw new CloudRuntimeException vm getUuid DataStore destStore dataStoreMgr getDataStore destPool getId DataStoreRole Primary AsyncCallFuture VolumeApiResult future volService copyVolume volume destStore try VolumeApiResult result future get if result isFailed s_logger debug result getResult throw new CloudRuntimeException result getResult return result getVolume catch InterruptedException e s_logger debug volume getId e throw new CloudRuntimeException e catch ExecutionException e
if volume getVolumeType Type ROOT Storage ImageFormat ISO template getFormat dskCh createDiskCharacteristics volume template dc offering storageMgr setDiskProfileThrottling dskCh offering diskOffering else dskCh createDiskCharacteristics volume template dc diskOffering storageMgr setDiskProfileThrottling dskCh null diskOffering if diskOffering null diskOffering isCustomized dskCh setSize size dskCh setHyperType hyperType final HashSet StoragePool avoidPools new HashSet StoragePool avoids pool findStoragePool dskCh dc pod clusterId vm getHostId vm avoidPools if pool null s_logger warn volume getName throw new CloudRuntimeException volume getName if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug volume pool DataStore store dataStoreMgr getDataStore pool getId DataStoreRole Primary for int i i i AsyncCallFuture VolumeApiResult future null boolean isNotCreatedFromTemplate volume getTemplateId null true false if isNotCreatedFromTemplate future volService createVolumeAsync volume store else TemplateInfo templ tmplFactory getTemplate template getId DataStoreRole Image future volService createVolumeFromTemplateAsync volume store getId templ try VolumeApiResult result future get if result isFailed if result getResult contains i
DB protected VolumeVO switchVolume final VolumeVO existingVolume final VirtualMachineProfile vm throws StorageUnavailableException Long templateIdToUse null Long volTemplateId existingVolume getTemplateId long vmTemplateId vm getTemplateId if volTemplateId null volTemplateId longValue vmTemplateId if s_logger isDebugEnabled
DB protected VolumeVO switchVolume final VolumeVO existingVolume final VirtualMachineProfile vm throws StorageUnavailableException Long templateIdToUse null Long volTemplateId existingVolume getTemplateId long vmTemplateId vm getTemplateId if volTemplateId null volTemplateId longValue vmTemplateId if s_logger isDebugEnabled s_logger debug volTemplateId vmTemplateId templateIdToUse vmTemplateId final Long templateIdToUseFinal templateIdToUse return Transaction execute new TransactionCallback VolumeVO Override public VolumeVO doInTransaction TransactionStatus status VolumeVO newVolume allocateDuplicateVolumeVO existingVolume templateIdToUseFinal try stateTransitTo existingVolume Volume Event DestroyRequested catch NoTransitionException e
Long volTemplateId existingVolume getTemplateId long vmTemplateId vm getTemplateId if volTemplateId null volTemplateId longValue vmTemplateId if s_logger isDebugEnabled s_logger debug volTemplateId vmTemplateId templateIdToUse vmTemplateId final Long templateIdToUseFinal templateIdToUse return Transaction execute new TransactionCallback VolumeVO Override public VolumeVO doInTransaction TransactionStatus status VolumeVO newVolume allocateDuplicateVolumeVO existingVolume templateIdToUseFinal try stateTransitTo existingVolume Volume Event DestroyRequested catch NoTransitionException e s_logger debug e toString if vm getHypervisorType HypervisorType VMware
templateIdToUse vmTemplateId final Long templateIdToUseFinal templateIdToUse return Transaction execute new TransactionCallback VolumeVO Override public VolumeVO doInTransaction TransactionStatus status VolumeVO newVolume allocateDuplicateVolumeVO existingVolume templateIdToUseFinal try stateTransitTo existingVolume Volume Event DestroyRequested catch NoTransitionException e s_logger debug e toString if vm getHypervisorType HypervisorType VMware s_logger info existingVolume getId AsyncCallFuture VolumeApiResult future volService expungeVolumeAsync volFactory getVolume existingVolume getId try future get catch Exception e
Override DB public void cleanupVolumes long vmId throws ConcurrentOperationException if s_logger isDebugEnabled
s_logger debug vmId final List VolumeVO volumesForVm _volsDao findByInstance vmId final List VolumeVO toBeExpunged new ArrayList VolumeVO Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status for VolumeVO vol volumesForVm if vol getVolumeType equals Type ROOT boolean volumeAlreadyDestroyed vol getState Volume State Destroy vol getState Volume State Expunged vol getState Volume State Expunging if volumeAlreadyDestroyed volService destroyVolume vol getId else s_logger debug vol vol getState toString toBeExpunged add vol else if s_logger isDebugEnabled
if volumeAlreadyDestroyed volService destroyVolume vol getId else s_logger debug vol vol getState toString toBeExpunged add vol else if s_logger isDebugEnabled s_logger debug vol _volsDao detachVolume vol getId AsyncCallFuture VolumeApiResult future null for VolumeVO expunge toBeExpunged future volService expungeVolumeAsync volFactory getVolume expunge getId try future get
else s_logger debug vol vol getState toString toBeExpunged add vol else if s_logger isDebugEnabled s_logger debug vol _volsDao detachVolume vol getId AsyncCallFuture VolumeApiResult future null for VolumeVO expunge toBeExpunged future volService expungeVolumeAsync volFactory getVolume expunge getId try future get catch InterruptedException e s_logger debug expunge getId e
checkConcurrentJobsPerDatastoreThreshhold destPool DataStore dataStoreTarget dataStoreMgr getDataStore destPool getId DataStoreRole Primary AsyncCallFuture VolumeApiResult future volService copyVolume vol dataStoreTarget try VolumeApiResult result future get if result isFailed s_logger error result getResult throw new StorageUnavailableException result getResult destPool getId else if _snapshotDao listByVolumeId vol getId isEmpty _snapshotDao updateVolumeIds vol getId result getVolume getId _snapshotDataStoreDao updateVolumeIds vol getId result getVolume getId return result getVolume catch InterruptedException e s_logger debug e
Override DB public Volume liveMigrateVolume Volume volume StoragePool destPool VolumeInfo vol volFactory getVolume volume getId DataStore dataStoreTarget dataStoreMgr getDataStore destPool getId DataStoreRole Primary AsyncCallFuture VolumeApiResult future volService migrateVolume vol dataStoreTarget try VolumeApiResult result future get if result isFailed
Override public void migrateVolumes VirtualMachine vm VirtualMachineTO vmTo Host srcHost Host destHost Map Volume StoragePool volumeToPool Map VolumeInfo DataStore volumeMap new HashMap VolumeInfo DataStore for Map Entry Volume StoragePool entry volumeToPool entrySet Volume volume entry getKey StoragePool storagePool entry getValue StoragePool destPool StoragePool dataStoreMgr getDataStore storagePool getId DataStoreRole Primary if volume getInstanceId vm getId throw new CloudRuntimeException volume vm if destPool null throw new CloudRuntimeException storagePool getId volumeMap put volFactory getVolume volume getId DataStore destPool AsyncCallFuture CommandResult future volService migrateVolumes volumeMap vmTo srcHost destHost try CommandResult result future get if result isFailed
Volume volume entry getKey StoragePool storagePool entry getValue StoragePool destPool StoragePool dataStoreMgr getDataStore storagePool getId DataStoreRole Primary if volume getInstanceId vm getId throw new CloudRuntimeException volume vm if destPool null throw new CloudRuntimeException storagePool getId volumeMap put volFactory getVolume volume getId DataStore destPool AsyncCallFuture CommandResult future volService migrateVolumes volumeMap vmTo srcHost destHost try CommandResult result future get if result isFailed s_logger debug vm result getResult throw new CloudRuntimeException vm catch InterruptedException e
StoragePool destPool StoragePool dataStoreMgr getDataStore storagePool getId DataStoreRole Primary if volume getInstanceId vm getId throw new CloudRuntimeException volume vm if destPool null throw new CloudRuntimeException storagePool getId volumeMap put volFactory getVolume volume getId DataStore destPool AsyncCallFuture CommandResult future volService migrateVolumes volumeMap vmTo srcHost destHost try CommandResult result future get if result isFailed s_logger debug vm result getResult throw new CloudRuntimeException vm catch InterruptedException e s_logger debug vm e catch ExecutionException e
Override public boolean storageMigration VirtualMachineProfile vm StoragePool destPool throws StorageUnavailableException List VolumeVO vols _volsDao findUsableVolumesForInstance vm getId List Volume volumesNeedToMigrate new ArrayList Volume for VolumeVO volume vols if volume getState Volume State Ready
Override public void prepareForMigration VirtualMachineProfile vm DeployDestination dest List VolumeVO vols _volsDao findUsableVolumesForInstance vm getId if s_logger isDebugEnabled
StoragePoolVO assignedPool null if destVols null StoragePool pool destVols get vol if pool null assignedPool _storagePoolDao findById pool getId if assignedPool null recreate assignedPool _storagePoolDao findById vol getPoolId if assignedPool null Volume State state vol getState if state Volume State Allocated state Volume State Creating VolumeTask task new VolumeTask VolumeTaskType RECREATE vol null tasks add task else if vol isRecreatable if s_logger isDebugEnabled
if assignedPool null recreate assignedPool _storagePoolDao findById vol getPoolId if assignedPool null Volume State state vol getState if state Volume State Allocated state Volume State Creating VolumeTask task new VolumeTask VolumeTaskType RECREATE vol null tasks add task else if vol isRecreatable if s_logger isDebugEnabled s_logger debug vol assignedPool VolumeTask task new VolumeTask VolumeTaskType RECREATE vol null tasks add task else if assignedPool getId vol getPoolId
if assignedPool null Volume State state vol getState if state Volume State Allocated state Volume State Creating VolumeTask task new VolumeTask VolumeTaskType RECREATE vol null tasks add task else if vol isRecreatable if s_logger isDebugEnabled s_logger debug vol assignedPool VolumeTask task new VolumeTask VolumeTaskType RECREATE vol null tasks add task else if assignedPool getId vol getPoolId if s_logger isDebugEnabled s_logger debug assignedPool vol
VolumeTask task new VolumeTask VolumeTaskType RECREATE vol null tasks add task else if assignedPool getId vol getPoolId if s_logger isDebugEnabled s_logger debug assignedPool vol DiskOffering diskOffering _entityMgr findById DiskOffering class vol getDiskOfferingId if diskOffering isUseLocalStorage if s_logger isDebugEnabled s_logger debug vol assignedPool throw new CloudRuntimeException vol assignedPool else Boolean isHAOperation Boolean vm getParameter VirtualMachineProfile Param HaOperation Boolean storageMigrationEnabled true if isHAOperation null isHAOperation
throw new CloudRuntimeException vol assignedPool else Boolean isHAOperation Boolean vm getParameter VirtualMachineProfile Param HaOperation Boolean storageMigrationEnabled true if isHAOperation null isHAOperation storageMigrationEnabled StorageHAMigrationEnabled value else storageMigrationEnabled StorageMigrationEnabled value if storageMigrationEnabled if s_logger isDebugEnabled s_logger debug vol assignedPool VolumeTask task new VolumeTask VolumeTaskType MIGRATE vol assignedPool tasks add task else throw new CloudRuntimeException
private Pair VolumeVO DataStore recreateVolume VolumeVO vol VirtualMachineProfile vm DeployDestination dest throws StorageUnavailableException VolumeVO newVol boolean recreate RecreatableSystemVmEnabled value DataStore destPool null if recreate dest getStorageForDisks null dest getStorageForDisks get vol null destPool dataStoreMgr getDataStore vol getPoolId DataStoreRole Primary
if recreate dest getStorageForDisks null dest getStorageForDisks get vol null destPool dataStoreMgr getDataStore vol getPoolId DataStoreRole Primary s_logger debug destPool getId else StoragePool pool dest getStorageForDisks get vol destPool dataStoreMgr getDataStore pool getId DataStoreRole Primary if vol getState Volume State Allocated vol getState Volume State Creating newVol vol else newVol switchVolume vol vm if dest getStorageForDisks null dest getStorageForDisks containsKey vol StoragePool poolWithOldVol dest getStorageForDisks get vol dest getStorageForDisks put newVol poolWithOldVol dest getStorageForDisks remove vol if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug newVol vol VolumeInfo volume volFactory getVolume newVol getId destPool Long templateId newVol getTemplateId for int i i i AsyncCallFuture VolumeApiResult future if templateId null DiskOffering diskOffering _entityMgr findById DiskOffering class volume getDiskOfferingId HypervisorType hyperType vm getVirtualMachine getHypervisorType volService updateHypervisorSnapshotReserveForVolume diskOffering volume getId hyperType volume volFactory getVolume newVol getId destPool future volService createVolumeAsync volume destPool else TemplateInfo templ tmplFactory getReadyTemplateOnImageStore templateId dest getDataCenter getId if templ null
if tmplFactory isTemplateMarkedForDirectDownload templateId templ tmplFactory getReadyBypassedTemplateOnPrimaryStore templateId destPool getId dest getHost getId else s_logger debug templateId dest getDataCenter getId throw new CloudRuntimeException templateId dest getDataCenter getId PrimaryDataStore primaryDataStore PrimaryDataStore destPool if primaryDataStore isManaged DiskOffering diskOffering _entityMgr findById DiskOffering class volume getDiskOfferingId HypervisorType hyperType vm getVirtualMachine getHypervisorType volService updateHypervisorSnapshotReserveForVolume diskOffering volume getId hyperType long hostId vm getVirtualMachine getHostId future volService createManagedStorageVolumeFromTemplateAsync volume destPool getId templ hostId else future volService createVolumeFromTemplateAsync volume destPool getId templ VolumeApiResult result
Override public void prepare VirtualMachineProfile vm DeployDestination dest throws StorageUnavailableException InsufficientStorageCapacityException ConcurrentOperationException if dest null if s_logger isDebugEnabled
private void cleanupVolumeDuringSnapshotFailure Long volumeId Long snapshotId _snapshotSrv cleanupVolumeDuringSnapshotFailure volumeId snapshotId VolumeVO volume _volsDao findById volumeId if volume getState Volume State Snapshotting
Override public void unmanageVolumes long vmId if s_logger isDebugEnabled
Override public void releaseIpAddress String ipAddress long dcId Long instanceId if s_logger isDebugEnabled
Override public void releaseIpAddress long nicId String reservationId if s_logger isDebugEnabled
Override public void releasePodIpAddress long id if s_logger isDebugEnabled
Override public void releaseIpAddress long nicId if s_logger isDebugEnabled
Override public void releaseIpAddress String ipAddress long dcId long instanceId if s_logger isDebugEnabled
throw new IllegalArgumentException else throw new IllegalArgumentException long parent Domain ROOT_DOMAIN if domain getParent null domain getParent longValue Domain ROOT_DOMAIN parent domain getParent longValue DomainVO parentDomain findById parent if parentDomain null s_logger error parent return null TransactionLegacy txn TransactionLegacy currentTxn try txn start parentDomain this lockRow parent true if parentDomain null
Override DB public boolean remove Long id if id null id longValue Domain ROOT_DOMAIN
return false DomainVO domain findById id if domain null s_logger info id return true if domain getParent null s_logger error id return false String sql id String sql1 id boolean success false TransactionLegacy txn TransactionLegacy currentTxn try txn start DomainVO parentDomain super lockRow domain getParent true
if s_logger isDebugEnabled s_logger debug sql COPY_ALL_EVENTS PreparedStatement pstmt null try txn start pstmt txn prepareAutoCloseStatement sql int i if recentEventId pstmt setLong i recentEventId pstmt setLong i maxEventId pstmt executeUpdate txn commit catch Exception ex txn rollback
PreparedStatement pstmt null try pstmt txn prepareAutoCloseStatement sql String gmtCutTime DateUtil getDateDisplayString TimeZone getTimeZone cutTime pstmt setString gmtCutTime pstmt setString gmtCutTime ResultSet rs pstmt executeQuery while rs next RunningHostCountInfo info new RunningHostCountInfo info setDcId rs getLong info setHostType rs getString info setCount rs getInt l add info catch SQLException e
Override public RouterHealthCheckResultVO getRouterHealthCheckResult long routerId String checkName String checkType SearchCriteria RouterHealthCheckResultVO sc RouterChecksSearchBuilder create sc setParameters routerId sc setParameters checkName sc setParameters checkType List RouterHealthCheckResultVO checks listBy sc if checks size
Override public void releaseIpAddress String ipAddress long networkId if s_logger isDebugEnabled
Override public void removeAccountFromProjects long accountId SearchCriteria ProjectAccountVO sc AllFieldsSearch create sc setParameters accountId int rowsRemoved remove sc if rowsRemoved
Override public void cleanupInvitations long projectId SearchCriteria ProjectInvitationVO sc AllFieldsSearch create sc setParameters projectId int numberRemoved remove sc
Override public boolean configure String name Map String Object params throws ConfigurationException boolean result super configure name params PublicSearch createSearchBuilder PublicSearch and PublicSearch entity isPublicTemplate SearchCriteria Op EQ routerTmpltName String params get
sc setParameters currentState sc setParameters vo getUpdatedCount vo incrUpdatedCount UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update VMTemplateVO vo sc if rows s_logger isDebugEnabled VMTemplateVO dbTemplate findByIdIncludingRemoved vo getId if dbTemplate null StringBuilder str new StringBuilder append vo toString str append append dbTemplate getId append append dbTemplate getState append append dbTemplate getUpdatedCount append append dbTemplate getUpdated str append append vo getId append append nextState append append event append append vo getUpdatedCount append append vo getUpdated str append append vo getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
sc setParameters currentState sc setParameters templateHost getUpdatedCount templateHost incrUpdatedCount UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update VMTemplateHostVO vo sc if rows s_logger isDebugEnabled VMTemplateHostVO dbVol findByIdIncludingRemoved templateHost getId if dbVol null StringBuilder str new StringBuilder append vo toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append templateHost getId append append nextState append append event append append templateHost getUpdatedCount append append templateHost getUpdated str append append templateHost getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
sc setParameters currentState sc setParameters templatePool getUpdatedCount templatePool incrUpdatedCount UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update VMTemplateStoragePoolVO vo sc if rows s_logger isDebugEnabled VMTemplateStoragePoolVO dbVol findByIdIncludingRemoved templatePool getId if dbVol null StringBuilder str new StringBuilder append vo toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append templatePool getId append append nextState append append event append append templatePool getUpdatedCount append append templatePool getUpdated str append append templatePool getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
sc setParameters currentState sc setParameters vo getUpdatedCount vo incrUpdatedCount UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update VolumeVO vo sc if rows s_logger isDebugEnabled VolumeVO dbVol findByIdIncludingRemoved vo getId if dbVol null StringBuilder str new StringBuilder append vo toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append vo getId append append nextState append append event append append vo getUpdatedCount append append vo getUpdated str append append vo getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
sc setParameters currentState sc setParameters volHost getUpdatedCount volHost incrUpdatedCount UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update VolumeHostVO vo sc if rows s_logger isDebugEnabled VolumeHostVO dbVol findByIdIncludingRemoved volHost getId if dbVol null StringBuilder str new StringBuilder append vo toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append volHost getId append append nextState append append event append append volHost getUpdatedCount append append volHost getUpdated str append append volHost getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
try PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery boolean noDuplicate true StringBuffer helpInfo new StringBuffer String note helpInfo append note while rs next try PreparedStatement sel_pstmt conn prepareStatement long poolId rs getLong pstmt setLong poolId try ResultSet dhrs sel_pstmt executeQuery String help formatDuplicateHostToReadText poolId dhrs helpInfo append help helpInfo append noDuplicate false catch Exception e
String note helpInfo append note while rs next try PreparedStatement sel_pstmt conn prepareStatement long poolId rs getLong pstmt setLong poolId try ResultSet dhrs sel_pstmt executeQuery String help formatDuplicateHostToReadText poolId dhrs helpInfo append help helpInfo append noDuplicate false catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e catch Exception e
pstmt setLong poolId try ResultSet dhrs sel_pstmt executeQuery String help formatDuplicateHostToReadText poolId dhrs helpInfo append help helpInfo append noDuplicate false catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e if noDuplicate s_logger debug else
helpInfo append noDuplicate false catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e if noDuplicate s_logger debug else s_logger error helpInfo toString txn commit return noDuplicate catch Exception e
catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e if noDuplicate s_logger debug else s_logger error helpInfo toString txn commit return noDuplicate catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e
throw new CloudRuntimeException e getMessage e if noDuplicate s_logger debug else s_logger error helpInfo toString txn commit return noDuplicate catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e finally try
private boolean check21to22PremiumUprage Connection conn throws SQLException try PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery int num while rs next String tableName rs getString if tableName equalsIgnoreCase tableName equalsIgnoreCase tableName equalsIgnoreCase num
private boolean isColumnExisted Connection conn String dbName String tableName String column throws SQLException try PreparedStatement pstmt conn prepareStatement String format dbName tableName ResultSet rs pstmt executeQuery boolean found false while rs next if column equalsIgnoreCase rs getString
if check221to222PremiumUprage conn s_logger error txn commit return false if check222to224PremiumUpgrade conn s_logger error txn commit return false txn commit return true catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e catch Exception e s_logger error e getMessage
protected void upgrade CloudStackVersion dbVersion CloudStackVersion currentVersion
conn txn getConnection catch SQLException e String errorMessage s_logger error errorMessage e throw new CloudRuntimeException errorMessage e InputStream scripts upgrade getPrepareScripts if scripts null for InputStream script scripts runScript conn script upgrade performDataMigration conn version new VersionVO upgrade getUpgradedVersion version _dao persist version txn commit catch CloudRuntimeException e String errorMessage
upgrade performDataMigration conn version new VersionVO upgrade getUpgradedVersion version _dao persist version txn commit catch CloudRuntimeException e String errorMessage s_logger error errorMessage e throw new CloudRuntimeException errorMessage e finally txn close txn TransactionLegacy open try s_logger info upgrade getClass getSimpleName upgrade getUpgradableVersionRange upgrade getUpgradableVersionRange upgrade getUpgradedVersion txn start Connection conn
public void dropPrimaryKey Connection conn String tableName try PreparedStatement pstmt conn prepareStatement tableName pstmt executeUpdate
public void dropColumn Connection conn String tableName String columnName try PreparedStatement pstmt conn prepareStatement tableName columnName pstmt executeUpdate
protected void upgradeDomR Connection conn long dcId long domrId Long publicNetworkId long guestNetworkId long controlNetworkId String zoneType String vnet throws SQLException
protected void upgradeSsvm Connection conn long dataCenterId long publicNetworkId long managementNetworkId long controlNetworkId String zoneType throws SQLException
protected void upgradeSsvm Connection conn long dataCenterId long publicNetworkId long managementNetworkId long controlNetworkId String zoneType throws SQLException s_logger debug dataCenterId try PreparedStatement selectInstance conn prepareStatement selectInstance setLong dataCenterId try ResultSet instanceResult selectInstance executeQuery if instanceResult next
String state instanceResult getString boolean running state equals state equals state equals String privateMac instanceResult getString String privateIp instanceResult getString String privateNetmask instanceResult getString String publicMac instanceResult getString String publicIp instanceResult getString String publicNetmask instanceResult getString String guestMac instanceResult getString String guestIp instanceResult getString String guestNetmask instanceResult getString String gateway instanceResult getString try PreparedStatement selectHost conn prepareStatement selectHost setLong dataCenterId try ResultSet hostResult selectHost executeQuery
protected void upgradeConsoleProxy Connection conn long dcId long cpId long publicNetworkId long managementNetworkId long controlNetworkId String zoneType throws SQLException
protected void upgradeDirectUserIpAddress Connection conn long dcId long networkId String vlanType throws SQLException
pstmt setString vlanType pstmt executeUpdate try PreparedStatement pstmt conn prepareStatement pstmt setLong dcId pstmt setString vlanType try ResultSet rs pstmt executeQuery ArrayList Object allocatedIps new ArrayList Object while rs next Object ip new Object ip rs getLong ip rs getString ip rs getLong ip rs getDate allocatedIps add ip s_logger debug allocatedIps size networkId
protected void upgradePublicUserIpAddress Connection conn long dcId long networkId String vlanType throws SQLException
_basicZone rs next Boolean parseBoolean rs getString updateDatacenterWithServices conn updateBasicZoneDataCenterWithVnetAndGuestCidr conn ArrayList Object dcs retrieveDataCenters conn long managementNetworkOfferingId retrieveNetworkOfferingId conn long publicNetworkOfferingId retrieveNetworkOfferingId conn long controlNetworkOfferingId retrieveNetworkOfferingId conn long storageNetworkOfferingId retrieveNetworkOfferingId conn if _basicZone for Object dc dcs updateBasicNetworkingDataCenter conn managementNetworkOfferingId controlNetworkOfferingId storageNetworkOfferingId dc else for Object dc dcs updateAdvancedNetworkingDataCenter conn managementNetworkOfferingId publicNetworkOfferingId controlNetworkOfferingId storageNetworkOfferingId dc catch SQLException e
private long retrieveNetworkOfferingId Connection conn String type throws SQLException CloudRuntimeException long networkOfferingId try PreparedStatement pstmt conn prepareStatement pstmt setString type try ResultSet rs pstmt executeQuery if rs next
private void updateRouters Connection conn Long dcId long controlNetworkId long basicDefaultDirectNetworkId ArrayList Object routers throws SQLException for Object router routers
selectDomainRouterIds setLong dataCenterId try ResultSet domainRouterIdResult selectDomainRouterIds executeQuery Long deviceId 0L if domainRouterIdResult next try PreparedStatement selectnonRemovedVms conn prepareStatement selectnonRemovedVms setLong accountId selectnonRemovedVms setLong dataCenterId try ResultSet nonRemovedVms selectnonRemovedVms executeQuery if nonRemovedVms next s_logger warn accountId dataCenterId try PreparedStatement selectNetworkType conn prepareStatement selectNetworkType setLong accountId selectNetworkType setLong dataCenterId try ResultSet userVmSet selectNetworkType executeQuery if userVmSet next
rule rs getString rule rs getString rule rs getString rules add rule if rules isEmpty s_logger debug rules size for Object rule rules long id Long rule String sourcePort String rule String protocol String rule String publicIp String rule try PreparedStatement selectUserIpAddressData conn prepareStatement selectUserIpAddressData setString publicIp try ResultSet userIpAddressData selectUserIpAddressData executeQuery if userIpAddressData next
upgradeHostMemoryCapacityInfo conn upgradeHostCpuCapacityInfo conn upgradeDomainResourceCounts conn migrateEvents conn createPortForwardingEvents conn createLoadBalancerEvents conn createNetworkOfferingEvents conn hypervisorTypeUpdate executeUpdate instanceUpdate executeUpdate updateUserStats conn deleteOrphanedTemplateRef conn cleanupVolumes conn modifyIndexes conn cleanupLbVmMaps conn catch SQLException e
s_logger debug return while rs next Long id rs getLong Long poolId rs getLong try PreparedStatement selectStoragePool conn prepareStatement selectStoragePool setLong poolId try ResultSet selectedStoragePool selectStoragePool executeQuery if selectedStoragePool next s_logger debug id try PreparedStatement delete conn prepareStatement delete setLong id delete executeUpdate s_logger debug catch Exception e
private void cleanupVolumes Connection conn try PreparedStatement selectVolumes conn prepareStatement ResultSet selectedVolumes selectVolumes executeQuery while selectedVolumes next Long id selectedVolumes getLong
try PreparedStatement selectAccounts conn prepareStatement selectAccounts setLong accountId try ResultSet selectedAccounts selectAccounts executeQuery if selectedAccounts next removeVolume true if instanceId null try PreparedStatement selectInstances conn prepareStatement selectInstances setLong instanceId try ResultSet selectedInstances selectInstances executeQuery if selectedInstances next removeVolume true if removeVolume try PreparedStatement pstmt conn prepareStatement pstmt setLong id pstmt executeUpdate
if selectedAccounts next removeVolume true if instanceId null try PreparedStatement selectInstances conn prepareStatement selectInstances setLong instanceId try ResultSet selectedInstances selectInstances executeQuery if selectedInstances next removeVolume true if removeVolume try PreparedStatement pstmt conn prepareStatement pstmt setLong id pstmt executeUpdate s_logger debug id s_logger debug catch Exception e
private void cleanupLbVmMaps Connection conn try PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery while rs next long lbId rs getLong try PreparedStatement pstmt1 conn prepareStatement pstmt1 setLong lbId try ResultSet rs1 pstmt1 executeQuery try PreparedStatement pstmt2 conn prepareStatement lbId ResultSet rs2 pstmt2 executeQuery if rs1 next rs2 next
Override public void performDataMigration Connection conn HashMap Long Long networkDomainMap new HashMap Long Long try PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery
Override public void performDataMigration Connection conn HashMap Long Long networkDomainMap new HashMap Long Long try PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery s_logger debug pstmt while rs next Long networkId rs getLong Long vlanId null Long domainId null pstmt conn prepareStatement pstmt setLong networkId
ResultSet rs pstmt executeQuery s_logger debug pstmt while rs next Long networkId rs getLong Long vlanId null Long domainId null pstmt conn prepareStatement pstmt setLong networkId s_logger debug pstmt rs pstmt executeQuery while rs next vlanId rs getLong if vlanId null pstmt conn prepareStatement pstmt setLong vlanId
rs close List Long domains new ArrayList Long pstmt conn prepareStatement rs pstmt executeQuery while rs next domains add rs getLong rs close String resourceTypes for Long accountId accounts for String resourceType resourceTypes pstmt conn prepareStatement pstmt setString resourceType pstmt setLong accountId rs pstmt executeQuery if rs next
pstmt setLong accountId rs pstmt executeQuery if rs next s_logger debug resourceType accountId pstmt conn prepareStatement pstmt setLong accountId pstmt setString resourceType pstmt executeUpdate rs close pstmt close for Long domainId domains for String resourceType resourceTypes pstmt conn prepareStatement pstmt setString resourceType pstmt setLong domainId
if rs1 next crtPbNtwk true PreparedStatement pstmt2 conn prepareStatement pstmt2Close add pstmt2 pstmt2 setLong zoneId ResultSet rsTags pstmt2 executeQuery if rsTags next s_logger debug if vnet null PreparedStatement pstmt4 conn prepareStatement pstmt2Close add pstmt4 pstmt4 setLong zoneId ResultSet rsVNet pstmt4 executeQuery if rsVNet next String message
Long nic_id rsNic getLong Long instance_id rsNic getLong if rsNic next throw new CloudRuntimeException vnetValue nic_id instance_id String freeVnet pstmtUpdate conn prepareStatement freeVnet pstmtUpdate setLong vnet_id pstmtUpdate executeUpdate pstmtUpdate close boolean isFirstPhysicalNtwk true do String guestNetworkTag rsTags getString long physicalNetworkId addPhysicalNetworkToZone conn zoneId zoneName networkType isFirstPhysicalNtwk vnet null domainId if isFirstPhysicalNtwk if crtPbNtwk
addPhysicalNtwk_To_Ntwk_IP_Vlan conn physicalNetworkId networkId pstmt3 close if isFirstPhysicalNtwk s_logger debug pstmt3 conn prepareStatement zoneId ResultSet rsPubNet pstmt3 executeQuery if rsPubNet next Long publicNetworkId rsPubNet getLong addPhysicalNtwk_To_Ntwk_IP_Vlan conn physicalNetworkId publicNetworkId pstmt3 close s_logger debug String updateVnet physicalNetworkId zoneId pstmtUpdate conn prepareStatement updateVnet pstmtUpdate executeUpdate pstmtUpdate close
String encryptedValue DBEncryptionUtil encrypt value pstmt conn prepareStatement pstmt setBytes encryptedValue getBytes pstmt setString name pstmt executeUpdate catch SQLException e throw new CloudRuntimeException e catch UnsupportedEncodingException e throw new CloudRuntimeException e finally try if rs null rs close if pstmt null pstmt close
private void updateDomainNetworkRef Connection conn List PreparedStatement pstmt2Close new ArrayList PreparedStatement PreparedStatement pstmt null ResultSet rs null try pstmt conn prepareStatement pstmt2Close add pstmt rs pstmt executeQuery while rs next boolean subdomainAccess Boolean valueOf rs getString pstmt conn prepareStatement pstmt2Close add pstmt pstmt setBoolean subdomainAccess pstmt executeUpdate
boolean subdomainAccess Boolean valueOf rs getString pstmt conn prepareStatement pstmt2Close add pstmt pstmt setBoolean subdomainAccess pstmt executeUpdate s_logger debug subdomainAccess pstmt conn prepareStatement pstmt2Close add pstmt rs pstmt executeQuery while rs next long networkId rs getLong pstmt conn prepareStatement pstmt2Close add pstmt pstmt setLong networkId pstmt executeUpdate
rs pstmt executeQuery pstmt conn prepareStatement pstmt2Close add pstmt rs1 pstmt executeQuery long ntwkOffCount while rs1 next ntwkOffCount rs1 getLong s_logger debug ntwkOffCount pstmt conn prepareStatement pstmt2Close add pstmt pstmt executeUpdate HashMap Long Long newNetworkOfferingMap new HashMap Long Long while rs next long networkId rs getLong long networkOfferingId rs getLong
pstmt conn prepareStatement newNetworkOfferingId pstmt2Close add pstmt pstmt executeUpdate pstmt conn prepareStatement pstmt2Close add pstmt pstmt setLong newNetworkOfferingId pstmt setLong networkId pstmt executeUpdate newNetworkOfferingMap put networkOfferingId ntwkOffCount else pstmt conn prepareStatement pstmt2Close add pstmt newNetworkOfferingId newNetworkOfferingMap get networkOfferingId pstmt setLong newNetworkOfferingId pstmt setLong networkId
newNetworkOfferingMap put networkOfferingId ntwkOffCount else pstmt conn prepareStatement pstmt2Close add pstmt newNetworkOfferingId newNetworkOfferingMap get networkOfferingId pstmt setLong newNetworkOfferingId pstmt setLong networkId pstmt executeUpdate s_logger debug networkId newNetworkOfferingId catch SQLException e throw new CloudRuntimeException e finally try pstmt conn prepareStatement pstmt executeUpdate
pstmt setLong networkOfferingId pstmt executeUpdate pstmt conn prepareStatement newNetworkOfferingId pstmt2Close add pstmt pstmt executeUpdate pstmt conn prepareStatement pstmt2Close add pstmt pstmt setLong newNetworkOfferingId pstmt setLong networkId pstmt executeUpdate newNetworkOfferingMap put networkOfferingId ntwkOffCount else pstmt conn prepareStatement pstmt2Close add pstmt newNetworkOfferingId newNetworkOfferingMap get networkOfferingId
pstmt2Close add pstmt newNetworkOfferingId newNetworkOfferingMap get networkOfferingId pstmt setLong newNetworkOfferingId pstmt setLong networkId pstmt executeUpdate s_logger debug networkId newNetworkOfferingId try pstmt conn prepareStatement pstmt2Close add pstmt pstmt executeUpdate catch SQLException ex s_logger debug ex catch SQLException e throw new CloudRuntimeException e finally
String newAllocAlgo if equalsIgnoreCase currentAllocationAlgo newAllocAlgo else newAllocAlgo pstmt conn prepareStatement pstmt setString newAllocAlgo pstmt executeUpdate catch SQLException e throw new CloudRuntimeException e finally try if rs null rs close if pstmt null
pstmt setLong networkOfferingId pstmt executeUpdate pstmt conn prepareStatement newNetworkOfferingId pstmt2Close add pstmt pstmt executeUpdate pstmt conn prepareStatement pstmt2Close add pstmt pstmt setLong newNetworkOfferingId pstmt setLong networkId pstmt executeUpdate newNetworkOfferingMap put networkOfferingId ntwkOffCount else pstmt conn prepareStatement pstmt2Close add pstmt newNetworkOfferingId newNetworkOfferingMap get networkOfferingId
pstmt2Close add pstmt pstmt setLong newNetworkOfferingId pstmt setLong networkId pstmt executeUpdate newNetworkOfferingMap put networkOfferingId ntwkOffCount else pstmt conn prepareStatement pstmt2Close add pstmt newNetworkOfferingId newNetworkOfferingMap get networkOfferingId pstmt setLong newNetworkOfferingId pstmt setLong networkId pstmt executeUpdate s_logger debug networkId newNetworkOfferingId catch SQLException e throw new CloudRuntimeException e
break case Capacity CAPACITY_TYPE_STORAGE case Capacity CAPACITY_TYPE_STORAGE_ALLOCATED tableName break pstmtUpdate conn prepareStatement updateSQLPrefix tableName updateSQLSuffix pstmtUpdate setLong hostId pstmtUpdate setLong hostId pstmtUpdate executeUpdate pstmtUpdate close catch SQLException e throw new CloudRuntimeException e finally if pstmtUpdate null try pstmtUpdate close catch SQLException e
pstmtUpdate setLong hostId pstmtUpdate setLong hostId pstmtUpdate executeUpdate pstmtUpdate close catch SQLException e throw new CloudRuntimeException e finally if pstmtUpdate null try pstmtUpdate close catch SQLException e s_logger info e if rs null try rs close
catch SQLException e throw new CloudRuntimeException e finally if pstmtUpdate null try pstmtUpdate close catch SQLException e s_logger info e if rs null try rs close catch SQLException e s_logger info e if pstmt null try
private void updateUserStatsWithNetwork Connection conn try PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery while rs next Long id rs getLong Long instanceId rs getLong if instanceId null instanceId longValue pstmt conn prepareStatement pstmt setLong instanceId ResultSet rs1 pstmt executeQuery if rs1 next
private void fixBasicZoneNicCount Connection conn try PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery while rs next Long zoneId rs getLong Long networkId null Long vmCount 0L
long speed rs getLong long totalCapacity cpus speed String updateSQL pstmtUpdate conn prepareStatement updateSQL pstmtUpdate setLong totalCapacity pstmtUpdate setLong hostId pstmtUpdate executeUpdate pstmtUpdate close catch SQLException e throw new CloudRuntimeException e finally if pstmtUpdate null try pstmtUpdate close catch SQLException e
pstmtUpdate setLong hostId pstmtUpdate executeUpdate pstmtUpdate close catch SQLException e throw new CloudRuntimeException e finally if pstmtUpdate null try pstmtUpdate close catch SQLException e s_logger info e if rs null try rs close catch SQLException e
catch SQLException e throw new CloudRuntimeException e finally if pstmtUpdate null try pstmtUpdate close catch SQLException e s_logger info e if rs null try rs close catch SQLException e s_logger info e if pstmt null try
keyToStatementMap put keyToStatementMap put keyToStatementMap put keyToStatementMap put keyToStatementMap put keyToStatementMap put for String key keyToTableMap keySet String tableName keyToTableMap get key pstmt conn prepareStatement pstmt setString key ResultSet rs pstmt executeQuery if rs next continue pstmt conn prepareStatement tableName key keyToStatementMap get key pstmt executeUpdate
keyToStatementMap put for String key keyToTableMap keySet String tableName keyToTableMap get key pstmt conn prepareStatement pstmt setString key ResultSet rs pstmt executeQuery if rs next continue pstmt conn prepareStatement tableName key keyToStatementMap get key pstmt executeUpdate s_logger debug key tableName rs close s_logger debug pstmt close catch SQLException e
ResultSet rs pstmt executeQuery while rs next long dcId rs getLong pstmt conn prepareStatement pstmt setLong dcId ResultSet rs1 pstmt executeQuery if rs1 next long secHostId rs1 getLong pstmt conn prepareStatement pstmt setLong secHostId pstmt setLong dcId pstmt executeUpdate pstmt conn prepareStatement pstmt executeUpdate catch SQLException e
PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery ArrayList Object networks new ArrayList Object while rs next Object network new Object network rs getLong networks add network rs close pstmt close for Object network networks Long networkId Long network pstmt conn prepareStatement pstmt setLong networkId rs pstmt executeQuery if rs next
PreparedStatement pstmt conn prepareStatement ResultSet rs pstmt executeQuery while rs next long volumeId rs getLong long accountId rs getLong long zoneId rs getLong String volumeName rs getString pstmt conn prepareStatement pstmt setLong accountId pstmt setLong zoneId pstmt setString volumeName pstmt setLong volumeId pstmt executeUpdate s_logger debug catch SQLException e
PreparedStatement pstmt try pstmt conn prepareStatement ResultSet rs pstmt executeQuery if rs next s_logger info catch Exception e insertField true if insertField s_logger debug pstmt conn prepareStatement pstmt executeUpdate s_logger debug pstmt close catch SQLException e
if rs2 next Long networkId rs2 getLong String dbs for String db dbs stmt db pstmt conn prepareStatement stmt pstmt setLong networkId pstmt setString publicIpAddress pstmt executeUpdate rs2 close rs close pstmt close s_logger debug catch SQLException e String errorMsg
long accountId rs getLong long domainId rs getLong long networkId rs getLong currentRuleId id Long firewallRuleId null pstmt conn prepareStatement pstmt setLong ipId pstmt setInt startPort pstmt setInt endPort pstmt setString protocol pstmt setLong accountId pstmt setLong domainId pstmt setLong networkId pstmt setString UUID randomUUID toString pstmt setLong id
pstmt setLong ipId pstmt setLong networkId pstmt setLong id ResultSet rs1 pstmt executeQuery if rs1 next firewallRuleId rs1 getLong else throw new CloudRuntimeException protocol startPort endPort ipId pstmt conn prepareStatement pstmt setLong id ResultSet rs2 pstmt executeQuery if rs2 next pstmt conn prepareStatement pstmt setLong firewallRuleId pstmt setLong id
firewallRuleId rs1 getLong else throw new CloudRuntimeException protocol startPort endPort ipId pstmt conn prepareStatement pstmt setLong id ResultSet rs2 pstmt executeQuery if rs2 next pstmt conn prepareStatement pstmt setLong firewallRuleId pstmt setLong id s_logger debug id firewallRuleId pstmt pstmt executeUpdate else pstmt conn prepareStatement pstmt setLong firewallRuleId
pstmt setLong id s_logger debug id firewallRuleId pstmt pstmt executeUpdate else pstmt conn prepareStatement pstmt setLong firewallRuleId s_logger debug firewallRuleId pstmt pstmt executeUpdate catch SQLException e throw new CloudRuntimeException currentRuleId e finally try if rs null rs close if pstmt null
long ntwkOffId rs getLong long mapId rs getLong pstmt conn prepareStatement pstmt setLong ntwkOffId rs1 pstmt executeQuery if rs1 next continue pstmt conn prepareStatement pstmt setLong ntwkOffId rs1 pstmt executeQuery if rs1 next continue pstmt conn prepareStatement pstmt setLong mapId pstmt executeUpdate
rs1 pstmt executeQuery if rs1 next continue pstmt conn prepareStatement pstmt setLong mapId pstmt executeUpdate s_logger debug ntwkOffId pstmt conn prepareStatement pstmt setLong ntwkOffId rs1 pstmt executeQuery while rs1 next mapId rs1 getLong long ntwkId rs1 getLong pstmt conn prepareStatement pstmt setLong mapId
private void addF5LoadBalancer Connection conn long hostId long physicalNetworkId PreparedStatement pstmtUpdate null try
private void addSrxFirewall Connection conn long hostId long physicalNetworkId PreparedStatement pstmtUpdate null try
private void addF5ServiceProvider Connection conn long physicalNetworkId long zoneId PreparedStatement pstmtUpdate null try
pstmt conn prepareStatement pstmt setLong zoneId rs pstmt executeQuery if rs next Long count rs getLong if count String xenGuestLabel getNetworkLabelFromConfig conn xenGuestLabel DBEncryptionUtil decrypt xenGuestLabel if xenGuestLabel null PreparedStatement pstmt5 conn prepareStatement pstmt5 setLong zoneId pstmt5 setString xenGuestLabel ResultSet rsSameLabel pstmt5 executeQuery if rsSameLabel next Long sameLabelcount rsSameLabel getLong
pstmt setLong zoneId rs pstmt executeQuery if rs next Long count rs getLong if count String xenGuestLabel getNetworkLabelFromConfig conn xenGuestLabel DBEncryptionUtil decrypt xenGuestLabel if xenGuestLabel null PreparedStatement pstmt5 conn prepareStatement pstmt5 setLong zoneId pstmt5 setString xenGuestLabel ResultSet rsSameLabel pstmt5 executeQuery if rsSameLabel next Long sameLabelcount rsSameLabel getLong if sameLabelcount
pstmt setString provider pstmt executeUpdate rs close pstmt close pstmt conn prepareStatement networkOfferingId pstmt setLong newNetworkOfferingId pstmt setLong physicalNetworkId pstmt executeUpdate pstmt close catch SQLException e throw new CloudRuntimeException e finally closeAutoCloseable rs try pstmt conn prepareStatement
pstmt conn prepareStatement rs pstmt executeQuery while rs next Long pNtwkId rs getLong pstmt conn prepareStatement pstmt setLong pNtwkId pstmt executeUpdate pstmt conn prepareStatement pstmt setLong pNtwkId ResultSet rs1 pstmt executeQuery rs1 next long providerId rs1 getLong pstmt conn prepareStatement pstmt setLong providerId pstmt executeUpdate
private void addF5LoadBalancer Connection conn long hostId long physicalNetworkId
private void addSrxFirewall Connection conn long hostId long physicalNetworkId
private void addF5ServiceProvider Connection conn long physicalNetworkId long zoneId
else throw new CloudRuntimeException zoneId pstmt conn prepareStatement pstmt setLong srxHostId rs pstmt executeQuery if rs first srxDevivceId rs getLong else throw new CloudRuntimeException srxHostId pstmt conn prepareStatement pstmt setLong zoneId pstmt setLong networkOfferingId rs pstmt executeQuery while rs next networkId rs getLong
pstmtUpdate executeUpdate pstmt_count_networks setLong zoneId try ResultSet rsNetworks pstmt_count_networks executeQuery if rsNetworks next Long count rsNetworks getLong if count String xenGuestLabel getNetworkLabelFromConfig conn xenGuestLabel DBEncryptionUtil decrypt xenGuestLabel if xenGuestLabel null pstmt_count_traffic_types_and_labels setLong zoneId pstmt_count_traffic_types_and_labels setString xenGuestLabel try ResultSet rsSameLabel pstmt_count_traffic_types_and_labels executeQuery if rsSameLabel next Long sameLabelcount rsSameLabel getLong if sameLabelcount
pstmt_count_networks setLong zoneId try ResultSet rsNetworks pstmt_count_networks executeQuery if rsNetworks next Long count rsNetworks getLong if count String xenGuestLabel getNetworkLabelFromConfig conn xenGuestLabel DBEncryptionUtil decrypt xenGuestLabel if xenGuestLabel null pstmt_count_traffic_types_and_labels setLong zoneId pstmt_count_traffic_types_and_labels setString xenGuestLabel try ResultSet rsSameLabel pstmt_count_traffic_types_and_labels executeQuery if rsSameLabel next Long sameLabelcount rsSameLabel getLong if sameLabelcount s_logger error xenGuestLabel
s_logger debug while rsNet next Long networkId rsNet getLong addPhysicalNtwk_To_Ntwk_IP_Vlan conn physicalNetworkId networkId boolean multiplePhysicalNetworks false pstmt_count_traffic_types setLong zoneId try ResultSet rs pstmt_count_traffic_types executeQuery if rs next Long count rs getLong if count s_logger debug count multiplePhysicalNetworks true if multiplePhysicalNetworks pstmt_select_vnets_on_different_physical_net setLong zoneId try ResultSet rsVNet pstmt_select_vnets_on_different_physical_net executeQuery
try ResultSet rs_service pstmt_select_service executeQuery while rs_service next String service rs_service getString String provider rs_service getString pstmt_insert_netofferservicemap setLong newNetworkOfferingId pstmt_insert_netofferservicemap setString service pstmt_insert_netofferservicemap setString provider pstmt_insert_netofferservicemap executeUpdate pstmt_update_networks setLong newNetworkOfferingId pstmt_update_networks setLong physicalNetworkId pstmt_update_networks setLong networkOfferingId pstmt_update_networks executeUpdate catch SQLException e throw new CloudRuntimeException e finally
pstmt conn prepareStatement rs pstmt executeQuery while rs next Long pNtwkId rs getLong pstmt conn prepareStatement pstmt setLong pNtwkId pstmt executeUpdate pstmt conn prepareStatement pstmt setLong pNtwkId ResultSet rs1 pstmt executeQuery rs1 next long providerId rs1 getLong pstmt conn prepareStatement pstmt setLong providerId pstmt executeUpdate
pstmt conn prepareStatement rs pstmt executeQuery while rs next Long routerId rs getLong Long networkId rs getLong pstmt conn prepareStatement pstmt setLong networkId ResultSet rs1 pstmt executeQuery rs1 next String networkType rs1 getString pstmt conn prepareStatement pstmt setLong routerId pstmt setLong networkId pstmt setString networkType pstmt executeUpdate
else throw new CloudRuntimeException zoneId pstmt conn prepareStatement pstmt setLong srxHostId rs pstmt executeQuery if rs first srxDevivceId rs getLong else throw new CloudRuntimeException srxHostId pstmt conn prepareStatement pstmt setLong zoneId pstmt setLong networkOfferingId rs pstmt executeQuery while rs next networkId rs getLong
private void upgradeEgressFirewallRules Connection conn PreparedStatement pstmt null ResultSet rs null ResultSet rsId null ResultSet rsNw null try pstmt conn prepareStatement
private void upgradeEgressFirewallRules Connection conn PreparedStatement pstmt null ResultSet rs null ResultSet rsId null ResultSet rsNw null try pstmt conn prepareStatement s_logger debug pstmt pstmt executeUpdate pstmt conn prepareStatement rs pstmt executeQuery while rs next long netId rs getLong pstmt conn prepareStatement pstmt setLong netId
try pstmt conn prepareStatement s_logger debug pstmt pstmt executeUpdate pstmt conn prepareStatement rs pstmt executeQuery while rs next long netId rs getLong pstmt conn prepareStatement pstmt setLong netId s_logger debug pstmt rsNw pstmt executeQuery if rsNw next long accountId rsNw getLong long domainId rsNw getLong
long netId rs getLong pstmt conn prepareStatement pstmt setLong netId s_logger debug pstmt rsNw pstmt executeQuery if rsNw next long accountId rsNw getLong long domainId rsNw getLong s_logger debug netId pstmt conn prepareStatement pstmt setString UUID randomUUID toString pstmt setLong accountId pstmt setLong domainId pstmt setLong netId pstmt setString UUID randomUUID toString
pstmt setString UUID randomUUID toString pstmt setLong accountId pstmt setLong domainId pstmt setLong netId pstmt setString UUID randomUUID toString s_logger debug pstmt pstmt executeUpdate pstmt conn prepareStatement pstmt setLong netId rsId pstmt executeQuery long firewallRuleId if rsId next firewallRuleId rsId getLong pstmt conn prepareStatement pstmt setLong firewallRuleId
private void fix22xKVMSnapshots Connection conn PreparedStatement pstmt null ResultSet rs null s_logger debug try pstmt conn prepareStatement rs pstmt executeQuery while rs next long id rs getLong String backUpPath rs getString int index backUpPath indexOf File separator if index String correctedPath File separator backUpPath substring index
pstmt setLong networkId rs1 pstmt executeQuery if rs1 next long network_offering_id rs1 getLong pstmt conn prepareStatement pstmt setLong network_offering_id rs2 pstmt executeQuery if rs2 next rs2 getInt maxconnections pstmt conn prepareStatement pstmt setInt maxconnections pstmt setLong network_offering_id pstmt executeUpdate pstmt conn prepareStatement pstmt executeUpdate catch SQLException e
try pstmt conn prepareStatement rs pstmt executeQuery while rs next accountId rs getLong pstmt conn prepareStatement pstmt setLong accountId rs1 pstmt executeQuery long count while rs1 next count rs1 getLong pstmt conn prepareStatement pstmt setLong accountId pstmt setLong count pstmt executeUpdate
s_logger debug physicalNetworkId zoneId String sql pstmtUpdate conn prepareStatement sql pstmtUpdate setLong physicalNetworkId pstmtUpdate setString uuid pstmtUpdate setLong zoneId pstmtUpdate setString vnet pstmtUpdate setString broadcastDomainRange pstmtUpdate setString zoneName zoneName physicalNetworkId pstmtUpdate setString zoneName s_logger warn pstmtUpdate toString pstmtUpdate executeUpdate pstmtUpdate close if domainId null domainId longValue
private void upgradeEgressFirewallRules Connection conn try PreparedStatement updateNwpstmt conn prepareStatement updateNwpstmt executeUpdate
try PreparedStatement updateNwpstmt conn prepareStatement updateNwpstmt executeUpdate s_logger debug updateNwpstmt catch SQLException e throw new CloudRuntimeException e try PreparedStatement vrNwpstmt conn prepareStatement ResultSet vrNwsRs vrNwpstmt executeQuery while vrNwsRs next long netId vrNwsRs getLong try PreparedStatement NwAcctDomIdpstmt conn prepareStatement NwAcctDomIdpstmt setLong netId try ResultSet NwAcctDomIdps NwAcctDomIdpstmt executeQuery s_logger debug NwAcctDomIdpstmt if NwAcctDomIdps next long accountId NwAcctDomIdps getLong long domainId NwAcctDomIdps getLong
try PreparedStatement vrNwpstmt conn prepareStatement ResultSet vrNwsRs vrNwpstmt executeQuery while vrNwsRs next long netId vrNwsRs getLong try PreparedStatement NwAcctDomIdpstmt conn prepareStatement NwAcctDomIdpstmt setLong netId try ResultSet NwAcctDomIdps NwAcctDomIdpstmt executeQuery s_logger debug NwAcctDomIdpstmt if NwAcctDomIdps next long accountId NwAcctDomIdps getLong long domainId NwAcctDomIdps getLong s_logger debug netId try PreparedStatement fwRulespstmt conn prepareStatement fwRulespstmt setString UUID randomUUID toString fwRulespstmt setLong accountId fwRulespstmt setLong domainId
fwRulespstmt setString UUID randomUUID toString fwRulespstmt setLong accountId fwRulespstmt setLong domainId fwRulespstmt setLong netId fwRulespstmt setString UUID randomUUID toString s_logger debug fwRulespstmt fwRulespstmt executeUpdate catch SQLException e throw new CloudRuntimeException e try PreparedStatement protoAllpstmt conn prepareStatement protoAllpstmt setLong netId try ResultSet protoAllRs protoAllpstmt executeQuery long firewallRuleId if protoAllRs next firewallRuleId protoAllRs getLong
if userData equals newUserData try final PreparedStatement updateStatement conn prepareStatement updateStatement setString newUserData updateStatement setLong userVmId updateStatement executeUpdate catch SQLException e LOG error userVmId e getMessage throw new CloudRuntimeException userVmId e else LOG warn userVmId LOG warn userData try final PreparedStatement updateStatement conn prepareStatement updateStatement setLong userVmId updateStatement executeUpdate catch SQLException e
clusterHypervisorType clusters getString clusterId clusters getLong if clusterHypervisorType equalsIgnoreCase if readGlobalConfigParam paramValStr getConfigurationParameter conn VSWITCH_GLOBAL_CONFIG_PARAM_CATEGORY NEXUS_GLOBAL_CONFIG_PARAM_NAME if paramValStr equalsIgnoreCase nexusEnabled true if nexusEnabled publicVswitchType NEXUS_1000V_DVSWITCH guestVswitchType NEXUS_1000V_DVSWITCH detailsList new ArrayList Pair String String detailsList add new Pair String String ApiConstants VSWITCH_TYPE_GUEST_TRAFFIC guestVswitchType detailsList add new Pair String String ApiConstants VSWITCH_TYPE_PUBLIC_TRAFFIC publicVswitchType detailsMap put clusterId detailsList updateClusterDetails conn detailsMap
if clusterHypervisorType equalsIgnoreCase if readGlobalConfigParam paramValStr getConfigurationParameter conn VSWITCH_GLOBAL_CONFIG_PARAM_CATEGORY NEXUS_GLOBAL_CONFIG_PARAM_NAME if paramValStr equalsIgnoreCase nexusEnabled true if nexusEnabled publicVswitchType NEXUS_1000V_DVSWITCH guestVswitchType NEXUS_1000V_DVSWITCH detailsList new ArrayList Pair String String detailsList add new Pair String String ApiConstants VSWITCH_TYPE_GUEST_TRAFFIC guestVswitchType detailsList add new Pair String String ApiConstants VSWITCH_TYPE_PUBLIC_TRAFFIC publicVswitchType detailsMap put clusterId detailsList updateClusterDetails conn detailsMap s_logger debug clusterId else
nexusEnabled true if nexusEnabled publicVswitchType NEXUS_1000V_DVSWITCH guestVswitchType NEXUS_1000V_DVSWITCH detailsList new ArrayList Pair String String detailsList add new Pair String String ApiConstants VSWITCH_TYPE_GUEST_TRAFFIC guestVswitchType detailsList add new Pair String String ApiConstants VSWITCH_TYPE_PUBLIC_TRAFFIC publicVswitchType detailsMap put clusterId detailsList updateClusterDetails conn detailsMap s_logger debug clusterId else s_logger debug clusterId clusterHypervisorType continue catch SQLException e String msg e getMessage
detailsList new ArrayList Pair String String detailsList add new Pair String String ApiConstants VSWITCH_TYPE_GUEST_TRAFFIC guestVswitchType detailsList add new Pair String String ApiConstants VSWITCH_TYPE_PUBLIC_TRAFFIC publicVswitchType detailsMap put clusterId detailsList updateClusterDetails conn detailsMap s_logger debug clusterId else s_logger debug clusterId clusterHypervisorType continue catch SQLException e String msg e getMessage s_logger error msg throw new CloudRuntimeException msg e if nexusEnabled setConfigurationParameter conn VSWITCH_GLOBAL_CONFIG_PARAM_CATEGORY DVS_GLOBAL_CONFIG_PARAM_NAME
private void setConfigurationParameter Connection conn String category String paramName String paramVal try PreparedStatement pstmt conn prepareStatement pstmt setString paramVal pstmt setString paramName
sel_aff_grp_pstmt setLong domainId try ResultSet rs2 sel_aff_grp_pstmt executeQuery if rs2 next affinityGroupId rs2 getLong else try PreparedStatement sel_dom_id_pstmt conn prepareStatement sel_dom_id_pstmt setLong domainId try ResultSet sel_dom_id_res sel_dom_id_pstmt executeQuery if sel_dom_id_res next domainName sel_dom_id_res getString catch SQLException e throw new CloudRuntimeException e String type String uuid UUID randomUUID toString String groupName domainName
try ResultSet rsParams pstmt executeQuery while rsParams next trafficTypeVswitchParam rsParams getString trafficTypeVswitchParamValue rsParams getString if trafficTypeVswitchParam equals trafficType else if trafficTypeVswitchParam equals trafficType else if trafficTypeVswitchParam equals trafficType try PreparedStatement sel_pstmt conn prepareStatement pstmt setString trafficType try ResultSet rsLabel sel_pstmt executeQuery newLabel getNewLabel rsLabel trafficTypeVswitchParamValue try PreparedStatement update_pstmt conn prepareStatement
tokens url split vc tokens dcName tokens dcOfPreviousCluster dcOfCurrentCluster dcOfCurrentCluster dcName vc if dcList contains dcOfCurrentCluster dcList add dcOfCurrentCluster if count if dcOfPreviousCluster equalsIgnoreCase dcOfCurrentCluster legacyZone true s_logger debug zoneId catch SQLException e throw new CloudRuntimeException e catch SQLException e throw new CloudRuntimeException e
count while clusters next if ignoreZone continue catch SQLException e throw new CloudRuntimeException e getMessage e if legacyZone listOfLegacyZones add zoneId else listOfNonLegacyZones add zoneId for String dc dcList ArrayList Long dcZones new ArrayList Long if dcToZoneMap get dc null dcZones dcToZoneMap get dc dcZones add zoneId
if ignoreZone continue catch SQLException e throw new CloudRuntimeException e getMessage e if legacyZone listOfLegacyZones add zoneId else listOfNonLegacyZones add zoneId for String dc dcList ArrayList Long dcZones new ArrayList Long if dcToZoneMap get dc null dcZones dcToZoneMap get dc dcZones add zoneId dcToZoneMap put dc dcZones for Map Entry String ArrayList Long entry dcToZoneMap entrySet
private void updateLegacyZones Connection conn List Long zones try PreparedStatement legacyZonesQuery conn prepareStatement for Long zoneId zones legacyZonesQuery setLong zoneId legacyZonesQuery executeUpdate
private void updateNonLegacyZones Connection conn List Long zones try for Long zoneId zones
private void addEgressFwRulesForSRXGuestNw Connection conn ResultSet rs null try PreparedStatement pstmt conn prepareStatement rs pstmt executeQuery while rs next long netId rs getLong try PreparedStatement sel_net_pstmt conn prepareStatement sel_net_pstmt setLong netId s_logger debug try ResultSet rsNw pstmt executeQuery if rsNw next long accountId rsNw getLong long domainId rsNw getLong
long netId rs getLong try PreparedStatement sel_net_pstmt conn prepareStatement sel_net_pstmt setLong netId s_logger debug try ResultSet rsNw pstmt executeQuery if rsNw next long accountId rsNw getLong long domainId rsNw getLong s_logger debug netId try PreparedStatement insert_pstmt conn prepareStatement insert_pstmt setString UUID randomUUID toString insert_pstmt setLong accountId insert_pstmt setLong domainId insert_pstmt setLong netId insert_pstmt setString UUID randomUUID toString
insert_pstmt setLong domainId insert_pstmt setLong netId insert_pstmt setString UUID randomUUID toString s_logger debug insert_pstmt insert_pstmt executeUpdate catch SQLException e throw new CloudRuntimeException e try PreparedStatement sel_firewall_pstmt conn prepareStatement sel_firewall_pstmt setLong netId try ResultSet rsId sel_firewall_pstmt executeQuery long firewallRuleId if rsId next firewallRuleId rsId getLong try PreparedStatement insert_pstmt conn prepareStatement insert_pstmt setLong firewallRuleId
private void updateNetworkACLs Connection conn s_logger debug long nextAclId String sqlSelectNetworkIds String sqlSelectFirewallRules String sqlInsertNetworkAcl String sqlSelectFirewallCidrs String sqlDeleteFirewallCidr String sqlInsertNetworkAclItem String sqlDeleteFirewallRules String sqlUpdateNetworks try PreparedStatement pstmtSelectNetworkIds conn prepareStatement sqlSelectNetworkIds PreparedStatement pstmtUpdate conn prepareStatement sqlUpdateNetworks PreparedStatement pstmtInsertNetworkAclItem conn prepareStatement sqlInsertNetworkAclItem PreparedStatement pstmtSelectFirewallRules conn prepareStatement sqlSelectFirewallRules PreparedStatement pstmtInsertNetworkAcl conn prepareStatement sqlInsertNetworkAcl PreparedStatement pstmtSelectFirewallCidrs conn prepareStatement sqlSelectFirewallCidrs PreparedStatement pstmtDeleteFirewallCidr conn prepareStatement sqlDeleteFirewallCidr PreparedStatement pstmtDeleteFirewallRules conn prepareStatement sqlDeleteFirewallRules ResultSet rsNetworkIds pstmtSelectNetworkIds executeQuery while rsNetworkIds next Long networkId rsNetworkIds getLong
try PreparedStatement pstmtSelectNetworkIds conn prepareStatement sqlSelectNetworkIds PreparedStatement pstmtUpdate conn prepareStatement sqlUpdateNetworks PreparedStatement pstmtInsertNetworkAclItem conn prepareStatement sqlInsertNetworkAclItem PreparedStatement pstmtSelectFirewallRules conn prepareStatement sqlSelectFirewallRules PreparedStatement pstmtInsertNetworkAcl conn prepareStatement sqlInsertNetworkAcl PreparedStatement pstmtSelectFirewallCidrs conn prepareStatement sqlSelectFirewallCidrs PreparedStatement pstmtDeleteFirewallCidr conn prepareStatement sqlDeleteFirewallCidr PreparedStatement pstmtDeleteFirewallRules conn prepareStatement sqlDeleteFirewallRules ResultSet rsNetworkIds pstmtSelectNetworkIds executeQuery while rsNetworkIds next Long networkId rsNetworkIds getLong s_logger debug networkId Long vpcId rsNetworkIds getLong String tierUuid rsNetworkIds getString pstmtSelectFirewallRules setLong networkId boolean hasAcls false Long aclId null int number try ResultSet rsAcls pstmtSelectFirewallRules executeQuery while rsAcls next if hasAcls hasAcls true aclId nextAclId
pstmtInsertNetworkAcl executeUpdate Long fwRuleId rsAcls getLong String cidr null pstmtSelectFirewallCidrs setLong fwRuleId try ResultSet rsCidr pstmtSelectFirewallCidrs executeQuery while rsCidr next Long cidrId rsCidr getLong String sourceCidr rsCidr getString if cidr null cidr sourceCidr else cidr sourceCidr pstmtDeleteFirewallCidr setLong cidrId pstmtDeleteFirewallCidr executeUpdate String aclItemUuid rsAcls getString
private void fix22xKVMSnapshots Connection conn s_logger debug try PreparedStatement pstmt conn prepareStatement try ResultSet rs pstmt executeQuery while rs next long id rs getLong String backUpPath rs getString int index backUpPath indexOf File separator if index String correctedPath backUpPath substring index
private void addF5LoadBalancer Connection conn long hostId long physicalNetworkId String insertF5 try PreparedStatement pstmtUpdate conn prepareStatement insertF5
private void addSrxFirewall Connection conn long hostId long physicalNetworkId String insertSrx try PreparedStatement pstmtUpdate conn prepareStatement insertSrx
private void addF5ServiceProvider Connection conn long physicalNetworkId long zoneId String insertPNSP try PreparedStatement pstmtUpdate conn prepareStatement insertPNSP
throw new CloudRuntimeException zoneId catch SQLException e throw new CloudRuntimeException e getMessage e catch SQLException e throw new CloudRuntimeException e getMessage e try PreparedStatement sel_id_ext_frwl_pstmt conn prepareStatement sel_id_ext_frwl_pstmt setLong srxHostId try ResultSet sel_id_ext_frwl_pstmt_rs sel_id_ext_frwl_pstmt executeQuery if sel_id_ext_frwl_pstmt_rs first srxDevivceId sel_id_ext_frwl_pstmt_rs getLong else throw new CloudRuntimeException srxHostId catch SQLException e throw new CloudRuntimeException e getMessage e catch SQLException e
private void migrateVolumeHostRef Connection conn s_logger debug try PreparedStatement volStoreInsert conn prepareStatement int rowCount volStoreInsert executeUpdate
private void migrateVolumeHostRef Connection conn s_logger debug try PreparedStatement volStoreInsert conn prepareStatement int rowCount volStoreInsert executeUpdate s_logger debug rowCount try PreparedStatement volStoreUpdate conn prepareStatement rowCount volStoreUpdate executeUpdate
private void migrateTemplateHostRef Connection conn s_logger debug try PreparedStatement tmplStoreInsert conn prepareStatement int rowCount tmplStoreInsert executeUpdate
private void migrateSnapshotStoreRef Connection conn s_logger debug try PreparedStatement snapshotStoreInsert conn prepareStatement int rowCount snapshotStoreInsert executeUpdate
private void migrateSnapshotStoreRef Connection conn s_logger debug try PreparedStatement snapshotStoreInsert conn prepareStatement int rowCount snapshotStoreInsert executeUpdate s_logger debug rowCount try PreparedStatement snapshotStoreInsert_2 conn prepareStatement rowCount snapshotStoreInsert_2 executeUpdate
tmplStoreInsert setLong s3_tmpl_id tmplStoreInsert setDate s3_created if s3_size null tmplStoreInsert setLong s3_size else tmplStoreInsert setNull Types BIGINT if s3_psize null tmplStoreInsert setLong s3_psize else tmplStoreInsert setNull Types BIGINT String path account_id s3_tmpl_id tmplStoreInsert setString path tmplStoreInsert setString path tmplStoreInsert executeUpdate catch SQLException e
tmplStoreInsert setLong s3_size else tmplStoreInsert setNull Types BIGINT if s3_psize null tmplStoreInsert setLong s3_psize else tmplStoreInsert setNull Types BIGINT String path account_id s3_tmpl_id tmplStoreInsert setString path tmplStoreInsert setString path tmplStoreInsert executeUpdate catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e catch SQLException e
tmplStoreInsert setNull Types BIGINT if s3_psize null tmplStoreInsert setLong s3_psize else tmplStoreInsert setNull Types BIGINT String path account_id s3_tmpl_id tmplStoreInsert setString path tmplStoreInsert setString path tmplStoreInsert executeUpdate catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e
snapshotStoreInsert setLong s3StoreMap get s3_id snapshotStoreInsert setLong snapshot_id snapshotStoreInsert setDate s3_created if s3_size null snapshotStoreInsert setLong s3_size else snapshotStoreInsert setNull Types BIGINT if s3_prev_id null snapshotStoreInsert setLong s3_prev_id else snapshotStoreInsert setNull Types BIGINT snapshotStoreInsert setString install_path snapshotStoreInsert setLong s3_vol_id snapshotStoreInsert executeUpdate catch SQLException e
if s3_size null snapshotStoreInsert setLong s3_size else snapshotStoreInsert setNull Types BIGINT if s3_prev_id null snapshotStoreInsert setLong s3_prev_id else snapshotStoreInsert setNull Types BIGINT snapshotStoreInsert setString install_path snapshotStoreInsert setLong s3_vol_id snapshotStoreInsert executeUpdate catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e catch SQLException e
else snapshotStoreInsert setNull Types BIGINT if s3_prev_id null snapshotStoreInsert setLong s3_prev_id else snapshotStoreInsert setNull Types BIGINT snapshotStoreInsert setString install_path snapshotStoreInsert setLong s3_vol_id snapshotStoreInsert executeUpdate catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e
Map String String detailMap new HashMap String String detailMap put ApiConstants ACCOUNT swift_account detailMap put ApiConstants USERNAME swift_username detailMap put ApiConstants KEY swift_key Iterator String keyIt detailMap keySet iterator while keyIt hasNext String key keyIt next String val detailMap get key storeDetailInsert setLong storeId storeDetailInsert setString key storeDetailInsert setString val storeDetailInsert executeUpdate swift_store_id_map put swift_id storeId catch SQLException e String msg e getMessage
tmplStoreInsert setLong tmpl_id tmplStoreInsert setDate created if size null tmplStoreInsert setLong size else tmplStoreInsert setNull Types BIGINT if psize null tmplStoreInsert setLong psize else tmplStoreInsert setNull Types BIGINT tmplStoreInsert setString path tmplStoreInsert setString path tmplStoreInsert executeUpdate catch SQLException e String msg e getMessage
Long snapshot_id rs getLong Date created rs getDate Long size rs getLong Long prev_id rs getLong String install_path rs getString Long vol_id rs getLong snapshotStoreInsert setLong swiftStoreMap get swift_id snapshotStoreInsert setLong snapshot_id snapshotStoreInsert setDate created snapshotStoreInsert setLong size snapshotStoreInsert setLong prev_id snapshotStoreInsert setString install_path snapshotStoreInsert setLong vol_id snapshotStoreInsert executeUpdate catch SQLException e
Long prev_id rs getLong String install_path rs getString Long vol_id rs getLong snapshotStoreInsert setLong swiftStoreMap get swift_id snapshotStoreInsert setLong snapshot_id snapshotStoreInsert setDate created snapshotStoreInsert setLong size snapshotStoreInsert setLong prev_id snapshotStoreInsert setString install_path snapshotStoreInsert setLong vol_id snapshotStoreInsert executeUpdate catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e catch SQLException e
snapshotStoreInsert setLong swiftStoreMap get swift_id snapshotStoreInsert setLong snapshot_id snapshotStoreInsert setDate created snapshotStoreInsert setLong size snapshotStoreInsert setLong prev_id snapshotStoreInsert setString install_path snapshotStoreInsert setLong vol_id snapshotStoreInsert executeUpdate catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e catch SQLException e s_logger error e getMessage e throw new CloudRuntimeException e getMessage e catch SQLException e
private void uncrypt Connection conn String name String value null try PreparedStatement prepSelStmt conn prepareStatement prepSelStmt setString name try ResultSet resultSet prepSelStmt executeQuery if LOG isInfoEnabled
String value null try PreparedStatement prepSelStmt conn prepareStatement prepSelStmt setString name try ResultSet resultSet prepSelStmt executeQuery if LOG isInfoEnabled LOG info name if resultSet next if equals resultSet getString value DBEncryptionUtil decrypt resultSet getString try PreparedStatement prepUpdStmt conn prepareStatement prepUpdStmt setString value prepUpdStmt setString name prepUpdStmt execute catch SQLException e if LOG isInfoEnabled
prepSelStmt setString name try ResultSet resultSet prepSelStmt executeQuery if LOG isInfoEnabled LOG info name if resultSet next if equals resultSet getString value DBEncryptionUtil decrypt resultSet getString try PreparedStatement prepUpdStmt conn prepareStatement prepUpdStmt setString value prepUpdStmt setString name prepUpdStmt execute catch SQLException e if LOG isInfoEnabled LOG info name value if LOG isDebugEnabled
switch Hypervisor HypervisorType getType rs getString case XenServer hypervisorsListInUse add Hypervisor HypervisorType XenServer break case KVM hypervisorsListInUse add Hypervisor HypervisorType KVM break case VMware hypervisorsListInUse add Hypervisor HypervisorType VMware break case Hyperv hypervisorsListInUse add Hypervisor HypervisorType Hyperv break case LXC hypervisorsListInUse add Hypervisor HypervisorType LXC break case Ovm3 hypervisorsListInUse add Hypervisor HypervisorType Ovm3 break default break catch final SQLException e
put Hypervisor HypervisorType Ovm3 final Map Hypervisor HypervisorType String newTemplateChecksum new HashMap Hypervisor HypervisorType String put Hypervisor HypervisorType KVM put Hypervisor HypervisorType XenServer put Hypervisor HypervisorType VMware put Hypervisor HypervisorType Hyperv put Hypervisor HypervisorType LXC put Hypervisor HypervisorType Ovm3 for final Map Entry Hypervisor HypervisorType String hypervisorAndTemplateName NewTemplateNameList entrySet LOG debug hypervisorAndTemplateName getKey try PreparedStatement pstmt conn prepareStatement long templateId pstmt setString hypervisorAndTemplateName getValue
put Hypervisor HypervisorType XenServer put Hypervisor HypervisorType VMware put Hypervisor HypervisorType Hyperv put Hypervisor HypervisorType LXC put Hypervisor HypervisorType Ovm3 for final Map Entry Hypervisor HypervisorType String hypervisorAndTemplateName NewTemplateNameList entrySet LOG debug hypervisorAndTemplateName getKey try PreparedStatement pstmt conn prepareStatement long templateId pstmt setString hypervisorAndTemplateName getValue try ResultSet rs pstmt executeQuery if rs next templateId rs getLong catch final SQLException e
for final Map Entry Hypervisor HypervisorType String hypervisorAndTemplateName NewTemplateNameList entrySet LOG debug hypervisorAndTemplateName getKey try PreparedStatement pstmt conn prepareStatement long templateId pstmt setString hypervisorAndTemplateName getValue try ResultSet rs pstmt executeQuery if rs next templateId rs getLong catch final SQLException e LOG error e getMessage throw new CloudRuntimeException e if templateId try PreparedStatement templ_type_pstmt conn prepareStatement templ_type_pstmt setLong templateId
if rs next templateId rs getLong catch final SQLException e LOG error e getMessage throw new CloudRuntimeException e if templateId try PreparedStatement templ_type_pstmt conn prepareStatement templ_type_pstmt setLong templateId templ_type_pstmt executeUpdate catch final SQLException e LOG error templateId e getMessage throw new CloudRuntimeException templateId e try PreparedStatement update_templ_id_pstmt conn prepareStatement update_templ_id_pstmt setLong templateId update_templ_id_pstmt setString hypervisorAndTemplateName getKey toString
try PreparedStatement update_templ_id_pstmt conn prepareStatement update_templ_id_pstmt setLong templateId update_templ_id_pstmt setString hypervisorAndTemplateName getKey toString update_templ_id_pstmt executeUpdate catch final Exception e LOG error hypervisorAndTemplateName getKey toString templateId e getMessage throw new CloudRuntimeException hypervisorAndTemplateName getKey toString templateId e try PreparedStatement update_pstmt conn prepareStatement update_pstmt setString hypervisorAndTemplateName getValue update_pstmt setString routerTemplateConfigurationNames get hypervisorAndTemplateName getKey update_pstmt executeUpdate catch final SQLException e LOG error routerTemplateConfigurationNames get hypervisorAndTemplateName getKey hypervisorAndTemplateName getValue e getMessage throw new CloudRuntimeException routerTemplateConfigurationNames get hypervisorAndTemplateName getKey hypervisorAndTemplateName getValue e try PreparedStatement update_pstmt conn prepareStatement
readOnlyAdminRules put readOnlyAdminRules put for Map Entry String String readOnlyAdminRule readOnlyAdminRules entrySet pstmt conn prepareStatement pstmt setLong readOnlyAdminRoleId pstmt setString readOnlyAdminRule getKey pstmt setString readOnlyAdminRule getValue pstmt setLong readOnlyAdminSortOrder pstmt executeUpdate if rs null rs isClosed rs close if pstmt null pstmt isClosed pstmt close LOG debug catch final SQLException e
private void moveCidrsToTheirOwnTable Connection conn s_logger debug String networkAclItemSql String networkAclItemCidrSql try PreparedStatement pstmtItem conn prepareStatement networkAclItemSql ResultSet rsItems pstmtItem executeQuery PreparedStatement pstmtCidr conn prepareStatement networkAclItemCidrSql while rsItems next long itemId rsItems getLong String cidrList rsItems getString
throw new CloudRuntimeException e try final PreparedStatement pstmt conn prepareStatement pstmt executeUpdate catch SQLException e throw new CloudRuntimeException e migrateAccountsToDefaultRoles conn if s_logger isDebugEnabled s_logger debug final String scriptFile final InputStream script Thread currentThread getContextClassLoader getResourceAsStream scriptFile if script null s_logger error return try final InputStreamReader reader new InputStreamReader script ScriptRunner runner new ScriptRunner conn false true
TransactionLegacy txn TransactionLegacy open TransactionLegacy USAGE_DB try txn start try PreparedStatement pstmt txn prepareStatement UPDATE_DELETED if pstmt null pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone eventDate pstmt setLong accountId pstmt setLong vmId pstmt executeUpdate catch SQLException e LOGGER error e getMessage e throw new CloudException e getMessage e txn commit catch Exception e txn rollback
pstmt setLong RoleType User getId else pstmt setLong acct getRoleId pstmt setLong acct getDomainId Date removed acct getRemoved if removed null pstmt setString null else pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone acct getRemoved pstmt setBoolean acct getNeedsCleanup pstmt addBatch pstmt executeBatch txn commit catch Exception ex txn rollback
PreparedStatement pstmt null pstmt txn prepareAutoCloseStatement sql for AccountVO acct accounts pstmt setString acct getAccountName Date removed acct getRemoved if removed null pstmt setString null else pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone acct getRemoved pstmt setLong acct getId pstmt addBatch pstmt executeBatch txn commit catch Exception ex txn rollback
pstmt setString userStat getDeviceType if userStat getNetworkId null pstmt setLong userStat getNetworkId else pstmt setNull Types BIGINT pstmt setLong userStat getNetBytesReceived pstmt setLong userStat getNetBytesSent pstmt setLong userStat getCurrentBytesReceived pstmt setLong userStat getCurrentBytesSent pstmt setLong userStat getAggBytesReceived pstmt setLong userStat getAggBytesSent pstmt addBatch pstmt executeBatch txn commit catch Exception ex
PreparedStatement pstmt null pstmt txn prepareAutoCloseStatement sql for UserStatisticsVO userStat userStats pstmt setLong userStat getNetBytesReceived pstmt setLong userStat getNetBytesSent pstmt setLong userStat getCurrentBytesReceived pstmt setLong userStat getCurrentBytesSent pstmt setLong userStat getAggBytesReceived pstmt setLong userStat getAggBytesSent pstmt setLong userStat getId pstmt addBatch pstmt executeBatch txn commit catch Exception ex txn rollback
pstmt setLong vmDiskStat getCurrentIOWrite pstmt setLong vmDiskStat getAggIORead pstmt setLong vmDiskStat getAggIOWrite pstmt setLong vmDiskStat getNetBytesRead pstmt setLong vmDiskStat getNetBytesWrite pstmt setLong vmDiskStat getCurrentBytesRead pstmt setLong vmDiskStat getCurrentBytesWrite pstmt setLong vmDiskStat getAggBytesRead pstmt setLong vmDiskStat getAggBytesWrite pstmt setLong vmDiskStat getId pstmt addBatch pstmt executeBatch txn commit catch Exception ex txn rollback
public Pair List extends UsageVO Integer getUsageRecordsPendingQuotaAggregation final long accountId final long domainId if s_logger isDebugEnabled
public Pair List extends UsageVO Integer getUsageRecordsPendingQuotaAggregation final long accountId final long domainId if s_logger isDebugEnabled s_logger debug accountId domainId return Transaction execute TransactionLegacy USAGE_DB new TransactionCallback Pair List extends UsageVO Integer Override public Pair List extends UsageVO Integer doInTransaction final TransactionStatus status Pair List UsageVO Integer usageRecords new Pair List UsageVO Integer new ArrayList UsageVO Filter usageFilter new Filter UsageVO class true 0L Long MAX_VALUE QueryBuilder UsageVO qb QueryBuilder create UsageVO class if accountId qb and qb entity getAccountId SearchCriteria Op EQ accountId if domainId qb and qb entity getDomainId SearchCriteria Op EQ domainId qb and qb entity getQuotaCalculated SearchCriteria Op NEQ qb and qb entity getRawUsage SearchCriteria Op GT if s_logger isDebugEnabled
TransactionLegacy txn TransactionLegacy open TransactionLegacy USAGE_DB try txn start if usage getReleased null try PreparedStatement pstmt txn prepareStatement UPDATE_RELEASED if pstmt null pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone usage getReleased pstmt setLong usage getAccountId pstmt setString usage getAddress pstmt executeUpdate catch SQLException e throw new CloudException e getMessage e txn commit catch Exception e txn rollback
TransactionLegacy txn TransactionLegacy open TransactionLegacy USAGE_DB try txn start UsageJobVO job lockRow jobId Boolean TRUE UsageJobVO jobForUpdate createForUpdate jobForUpdate setStartMillis startMillis jobForUpdate setEndMillis endMillis jobForUpdate setExecTime execTime jobForUpdate setStartDate new Date startMillis jobForUpdate setEndDate new Date endMillis jobForUpdate setSuccess success update job getId jobForUpdate txn commit catch Exception ex txn rollback
long zoneId rs getLong Long hostId rs getLong String hostType rs getString Long networkId rs getLong long bytesSent rs getLong long bytesReceived rs getLong long aggBytesReceived rs getLong long aggBytesSent rs getLong long eventTimeMillis rs getLong if hostId returnMap put zoneId accountId hostId new UsageNetworkVO accountId zoneId hostId hostType networkId bytesSent bytesReceived aggBytesReceived aggBytesSent eventTimeMillis else returnMap put zoneId accountId new UsageNetworkVO accountId zoneId hostId hostType networkId bytesSent bytesReceived aggBytesReceived aggBytesSent eventTimeMillis return returnMap catch Exception ex
pstmt setLong usageNetwork getAccountId pstmt setLong usageNetwork getZoneId pstmt setLong usageNetwork getHostId pstmt setString usageNetwork getHostType pstmt setLong usageNetwork getNetworkId pstmt setLong usageNetwork getBytesSent pstmt setLong usageNetwork getBytesReceived pstmt setLong usageNetwork getAggBytesReceived pstmt setLong usageNetwork getAggBytesSent pstmt setLong usageNetwork getEventTimeMillis pstmt addBatch pstmt executeBatch txn commit catch Exception ex txn rollback
Override public void removeBy long accountId long volId int storageType TransactionLegacy txn TransactionLegacy open TransactionLegacy USAGE_DB try txn start String sql REMOVE_BY_USERID_STORAGEID try PreparedStatement pstmt txn prepareStatement sql pstmt setLong accountId pstmt setLong volId pstmt setInt storageType pstmt executeUpdate catch SQLException e throw new CloudException e getMessage e txn commit catch Exception e txn rollback
txn start if usage getDeleted null try PreparedStatement pstmt txn prepareStatement UPDATE_DELETED if pstmt null pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone usage getDeleted pstmt setLong usage getAccountId pstmt setLong usage getId pstmt setInt usage getStorageType pstmt setLong usage getZoneId pstmt executeUpdate catch SQLException e throw new CloudException e getMessage e txn commit catch Exception e txn rollback
Override public List UsageSnapshotOnPrimaryVO getUsageRecords Long accountId Long domainId Date startDate Date endDate List UsageSnapshotOnPrimaryVO usageRecords new ArrayList UsageSnapshotOnPrimaryVO String sql GET_USAGE_RECORDS_BY_ACCOUNT TransactionLegacy txn TransactionLegacy open TransactionLegacy USAGE_DB PreparedStatement pstmt null try int i pstmt txn prepareAutoCloseStatement sql pstmt setLong i accountId pstmt setString i DateUtil getDateDisplayString TimeZone getTimeZone endDate pstmt setString i DateUtil getDateDisplayString TimeZone getTimeZone startDate pstmt setString i DateUtil getDateDisplayString TimeZone getTimeZone endDate
TransactionLegacy txn TransactionLegacy open TransactionLegacy USAGE_DB try txn start if usage getDeleted null try PreparedStatement pstmt txn prepareStatement UPDATE_DELETED if pstmt null pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone usage getDeleted pstmt setLong usage getAccountId pstmt setLong usage getUserId pstmt executeUpdate catch SQLException e throw new CloudException e getMessage e txn commit catch Exception e txn rollback
long ioRead rs getLong long ioWrite rs getLong long aggIORead rs getLong long aggIOWrite rs getLong long bytesRead rs getLong long bytesWrite rs getLong long aggBytesRead rs getLong long aggBytesWrite rs getLong long eventTimeMillis rs getLong if vmId returnMap put zoneId accountId vmId volumeId new UsageVmDiskVO accountId zoneId vmId volumeId ioRead ioWrite aggIORead aggIOWrite bytesRead bytesWrite aggBytesRead aggBytesWrite eventTimeMillis else returnMap put zoneId accountId new UsageVmDiskVO accountId zoneId vmId volumeId ioRead ioWrite aggIORead aggIOWrite bytesRead bytesWrite aggBytesRead aggBytesWrite eventTimeMillis return returnMap catch Exception ex
pstmt setLong usageVmDisk getVolumeId pstmt setLong usageVmDisk getIORead pstmt setLong usageVmDisk getIOWrite pstmt setLong usageVmDisk getAggIORead pstmt setLong usageVmDisk getAggIOWrite pstmt setLong usageVmDisk getBytesRead pstmt setLong usageVmDisk getBytesWrite pstmt setLong usageVmDisk getAggBytesRead pstmt setLong usageVmDisk getAggBytesWrite pstmt setLong usageVmDisk getEventTimeMillis pstmt addBatch pstmt executeBatch txn commit catch Exception ex txn rollback
Override public List Pair Long Integer getDatacenterStoragePoolHostInfo long dcId boolean countAllPoolTypes ArrayList Pair Long Integer l new ArrayList Pair Long Integer TransactionLegacy txn TransactionLegacy currentTxn PreparedStatement pstmt null try if countAllPoolTypes pstmt txn prepareAutoCloseStatement STORAGE_POOL_HOST_INFO else pstmt txn prepareAutoCloseStatement SHARED_STORAGE_POOL_HOST_INFO pstmt setLong dcId ResultSet rs pstmt executeQuery while rs next l add new Pair Long Integer rs getLong rs getInt catch SQLException e
private List ConsoleProxyLoadInfo getDatacenterLoadMatrix String sql ArrayList ConsoleProxyLoadInfo l new ArrayList ConsoleProxyLoadInfo TransactionLegacy txn TransactionLegacy currentTxn PreparedStatement pstmt null try pstmt txn prepareAutoCloseStatement sql ResultSet rs pstmt executeQuery while rs next ConsoleProxyLoadInfo info new ConsoleProxyLoadInfo info setId rs getLong info setName rs getString info setCount rs getInt l add info catch SQLException e
String sql if role null sql else sql pstmt txn prepareAutoCloseStatement sql if role null pstmt setLong msid else pstmt setString role toString pstmt setLong msid ResultSet rs pstmt executeQuery while rs next l add rs getLong catch SQLException e
String sql if role null sql else sql pstmt txn prepareAutoCloseStatement sql if role null pstmt setLong zoneId else pstmt setLong zoneId pstmt setString role toString ResultSet rs pstmt executeQuery while rs next l add rs getLong catch SQLException e
TransactionLegacy txn TransactionLegacy currentTxn List Long result new ArrayList Long String sql LIST_PODS_HAVING_VMS_FOR_ACCOUNT try PreparedStatement pstmt txn prepareStatement sql pstmt setLong zoneId pstmt setLong accountId try ResultSet rs pstmt executeQuery while rs next result add rs getLong catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e txn commit return result catch Exception e
while rs next result add rs getLong catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e txn commit return result catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e finally try if txn null txn close catch Exception e
List UserVmData userVmDataList new ArrayList userVmDataHash values if userVmDataList size VM_DETAILS_BATCH_SIZE try PreparedStatement pstmt txn prepareStatement VM_DETAILS getQueryBatchAppender VM_DETAILS_BATCH_SIZE while curr_index VM_DETAILS_BATCH_SIZE userVmDataList size for int k j curr_index j curr_index VM_DETAILS_BATCH_SIZE j k pstmt setLong k userVmDataList get j getId try ResultSet rs pstmt executeQuery while rs next long vm_id rs getLong UserVmData uvm userVmDataHash get vm_id if uvm null uvm new UserVmData uvm setId vm_id setUserVmData uvm rs catch Exception e
for int k j curr_index j curr_index VM_DETAILS_BATCH_SIZE j k pstmt setLong k userVmDataList get j getId try ResultSet rs pstmt executeQuery while rs next long vm_id rs getLong UserVmData uvm userVmDataHash get vm_id if uvm null uvm new UserVmData uvm setId vm_id setUserVmData uvm rs catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e curr_index VM_DETAILS_BATCH_SIZE catch Exception e
throw new CloudRuntimeException e getMessage e curr_index VM_DETAILS_BATCH_SIZE catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e if curr_index userVmDataList size int batch_size userVmDataList size curr_index try PreparedStatement vm_details_pstmt txn prepareStatement VM_DETAILS getQueryBatchAppender batch_size for int k j curr_index j curr_index batch_size j k vm_details_pstmt setLong k userVmDataList get j getId try ResultSet rs vm_details_pstmt executeQuery while rs next long vm_id rs getLong UserVmData uvm userVmDataHash get vm_id if uvm null
catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e if curr_index userVmDataList size int batch_size userVmDataList size curr_index try PreparedStatement vm_details_pstmt txn prepareStatement VM_DETAILS getQueryBatchAppender batch_size for int k j curr_index j curr_index batch_size j k vm_details_pstmt setLong k userVmDataList get j getId try ResultSet rs vm_details_pstmt executeQuery while rs next long vm_id rs getLong UserVmData uvm userVmDataHash get vm_id if uvm null uvm new UserVmData uvm setId vm_id
if curr_index userVmDataList size int batch_size userVmDataList size curr_index try PreparedStatement vm_details_pstmt txn prepareStatement VM_DETAILS getQueryBatchAppender batch_size for int k j curr_index j curr_index batch_size j k vm_details_pstmt setLong k userVmDataList get j getId try ResultSet rs vm_details_pstmt executeQuery while rs next long vm_id rs getLong UserVmData uvm userVmDataHash get vm_id if uvm null uvm new UserVmData uvm setId vm_id setUserVmData uvm rs catch Exception e s_logger error e getMessage
try ResultSet rs vm_details_pstmt executeQuery while rs next long vm_id rs getLong UserVmData uvm userVmDataHash get vm_id if uvm null uvm new UserVmData uvm setId vm_id setUserVmData uvm rs catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e catch Exception e s_logger error e getMessage throw new CloudRuntimeException e getMessage e txn commit
Override public boolean updateState State oldState Event event State newState VirtualMachine vm Object opaque if newState null if s_logger isDebugEnabled
sc setParameters vmi getHostId sc setParameters vmi getUpdated vmi incrUpdated UpdateBuilder ub getUpdateBuilder vmi ub set vmi newState ub set vmi newHostId ub set vmi vmi getPodIdToDeployIn ub set vmi _updateTimeAttr new Date int result update vmi sc if result VMInstanceVO vo findByIdIncludingRemoved vm getId if s_logger isDebugEnabled if vo null StringBuilder str new StringBuilder append vo toString str append append vo getHostId append append vo getState toString append append vo getUpdated append append vo getUpdateTime
vmi incrUpdated UpdateBuilder ub getUpdateBuilder vmi ub set vmi newState ub set vmi newHostId ub set vmi vmi getPodIdToDeployIn ub set vmi _updateTimeAttr new Date int result update vmi sc if result VMInstanceVO vo findByIdIncludingRemoved vm getId if s_logger isDebugEnabled if vo null StringBuilder str new StringBuilder append vo toString str append append vo getHostId append append vo getState toString append append vo getUpdated append append vo getUpdateTime str append append vm getHostId append append vm getState toString append append vmi getUpdated append append vo getUpdateTime str append append oldHostId append append oldState append append oldUpdated append append oldUpdateDate append
sc setParameters currentState sc setParameters vo getUpdatedCount vo incrUpdatedCount UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update VMSnapshotVO vo sc if rows s_logger isDebugEnabled VMSnapshotVO dbVol findByIdIncludingRemoved vo getId if dbVol null StringBuilder str new StringBuilder append vo toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append vo getId append append nextState append append event append append vo getUpdatedCount append append vo getUpdated str append append vo getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
Override public void expireServerOwnership long serverId final String resetOwnerSql executeExpireOwnershipSql resetOwnerSql serverId if LOG isDebugEnabled
Long newManagementServerId event getServerId if oldStatus newStatus oobmHost getManagementServerId null oobmHost getManagementServerId equals newManagementServerId return false if event OutOfBandManagement PowerState Event Disabled newManagementServerId null SearchCriteria OutOfBandManagementVO sc StateUpdateSearch create sc setParameters oldStatus sc setParameters oobmHost getId sc setParameters oobmHost getUpdateCount oobmHost incrUpdateCount UpdateBuilder ub getUpdateBuilder oobmHost ub set oobmHost PowerStateAttr newStatus ub set oobmHost UpdateTimeAttr DateUtil currentGMTTime ub set oobmHost MsIdAttr newManagementServerId int result update ub sc null
typeName else String msg throw new CloudRuntimeException msg s_logger debug typeName dataId storeId DataObject existingDataObj null synchronized lock DataObjectInStore obj objectInStoreMgr findObject data store if obj null State st obj getState long miliSeconds long timeoutSeconds long timeoutMiliSeconds timeoutSeconds Date now new Date long expiredEpoch now getTime timeoutMiliSeconds
while st ObjectInDataStoreStateMachine State Allocated st ObjectInDataStoreStateMachine State Creating st ObjectInDataStoreStateMachine State Copying s_logger debug typeName obj getObjectId lock hashCode try lock wait miliSeconds catch InterruptedException e s_logger debug s_logger debug now new Date if now after expiredDate String msg timeoutSeconds throw new CloudRuntimeException msg obj objectInStoreMgr findObject data store st obj getState if st ObjectInDataStoreStateMachine State Ready s_logger debug
s_logger debug s_logger debug now new Date if now after expiredDate String msg timeoutSeconds throw new CloudRuntimeException msg obj objectInStoreMgr findObject data store st obj getState if st ObjectInDataStoreStateMachine State Ready s_logger debug DataObject dataObj objectInStoreMgr get data store dataObj incRefCount existingDataObj dataObj if existingDataObj null s_logger debug typeName dataId storeId
static String generateAndRetrieveIsoAsBase64Iso String isoFileName String driveLabel String tempDirName throws IOException File tmpIsoStore new File tempDirName isoFileName Script command new Script getProgramToGenerateIso Duration standardSeconds LOG command add tmpIsoStore getAbsolutePath command add command add command add command add command add command add command add command add command add driveLabel command add tempDirName
static JsonObject createJsonObjectWithVmData List String vmData String tempDirName JsonObject metaData new JsonObject for String item vmData String dataType item CONFIGDATA_DIR String fileName item CONFIGDATA_FILE String content item CONFIGDATA_CONTENT
static void linkUserData String tempDirName String userDataFilePath tempDirName ConfigDrive cloudStackConfigDriveName File file new File userDataFilePath if file exists Script hardLink new Script Duration standardSeconds LOG hardLink add userDataFilePath hardLink add tempDirName ConfigDrive openStackConfigDriveName
Scope destScope pickCacheScopeForCopy srcData destData srcForCopy cacheData cacheMgr createCacheObject srcData destScope CopyCommand cmd new CopyCommand srcForCopy getTO addFullCloneFlagOnVMwareDest destData getTO primaryStorageDownloadWait VirtualMachineManager ExecuteInSequence value EndPoint ep destHost null RemoteHostEndPoint getHypervisorHostEndPoint destHost selector select srcForCopy destData if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if cacheData null final Long cacheId cacheData getId final String cacheType cacheData getType toString final String cacheUuid cacheData getUuid toString if srcData getType DataObjectType VOLUME destData getType DataObjectType VOLUME destData getType DataObjectType TEMPLATE
s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if cacheData null final Long cacheId cacheData getId final String cacheType cacheData getType toString final String cacheUuid cacheData getUuid toString if srcData getType DataObjectType VOLUME destData getType DataObjectType VOLUME destData getType DataObjectType TEMPLATE s_logger debug cacheType cacheId cacheUuid cacheMgr deleteCacheObject srcForCopy else if answer null answer getResult srcForCopy getRefCount s_logger warn ep null ep getId cacheType cacheId cacheUuid cacheMgr deleteCacheObject srcForCopy
DataObject srcData snapObj try if storTO NfsTO srcData cacheSnapshotChain snapshot new ZoneScope pool getDataCenterId String value configDao getValue Config CreateVolumeFromSnapshotWait toString int _createVolumeFromSnapshotWait NumbersUtil parseInt value Integer parseInt Config CreateVolumeFromSnapshotWait getDefaultValue EndPoint ep null if srcData getDataStore getRole DataStoreRole Primary ep selector select volObj else ep selector select srcData volObj CopyCommand cmd new CopyCommand srcData getTO addFullCloneFlagOnVMwareDest volObj getTO _createVolumeFromSnapshotWait VirtualMachineManager ExecuteInSequence value Answer answer null if ep null String errMsg
protected Answer cloneVolume DataObject template DataObject volume CopyCommand cmd new CopyCommand template getTO addFullCloneFlagOnVMwareDest volume getTO VirtualMachineManager ExecuteInSequence value try EndPoint ep selector select volume getDataStore Answer answer null if ep null String errMsg
protected Answer copyVolumeBetweenPools DataObject srcData DataObject destData String value configDao getValue Config CopyVolumeWait key int _copyvolumewait NumbersUtil parseInt value Integer parseInt Config CopyVolumeWait getDefaultValue Scope destScope getZoneScope destData getDataStore getScope DataStore cacheStore cacheMgr getCacheStorage destScope boolean bypassSecondaryStorage false if srcData VolumeInfo VolumeInfo srcData isDirectDownload bypassSecondaryStorage true if cacheStore null if bypassSecondaryStorage CopyCommand cmd new CopyCommand srcData getTO destData getTO _copyvolumewait VirtualMachineManager ExecuteInSequence value EndPoint ep selector select srcData destData Answer answer null if ep null String errMsg
String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd return answer ImageStoreEntity imageStore ImageStoreEntity dataStoreMgr getImageStoreWithFreeCapacity destScope getScopeId if imageStore null imageStore getProtocol equalsIgnoreCase imageStore getProtocol equalsIgnoreCase String errMsg Answer answer new Answer null false errMsg return answer DataObject objOnImageStore imageStore create srcData objOnImageStore processEvent Event CreateOnlyRequested Answer answer copyObject srcData objOnImageStore if answer null answer getResult
if imageStore null imageStore getProtocol equalsIgnoreCase imageStore getProtocol equalsIgnoreCase String errMsg Answer answer new Answer null false errMsg return answer DataObject objOnImageStore imageStore create srcData objOnImageStore processEvent Event CreateOnlyRequested Answer answer copyObject srcData objOnImageStore if answer null answer getResult if answer null s_logger debug answer getDetails objOnImageStore processEvent Event OperationFailed imageStore delete objOnImageStore return answer objOnImageStore processEvent Event OperationSuccessed answer objOnImageStore processEvent Event CopyingRequested
objOnImageStore processEvent Event CreateOnlyRequested Answer answer copyObject srcData objOnImageStore if answer null answer getResult if answer null s_logger debug answer getDetails objOnImageStore processEvent Event OperationFailed imageStore delete objOnImageStore return answer objOnImageStore processEvent Event OperationSuccessed answer objOnImageStore processEvent Event CopyingRequested CopyCommand cmd new CopyCommand objOnImageStore getTO addFullCloneFlagOnVMwareDest destData getTO _copyvolumewait VirtualMachineManager ExecuteInSequence value EndPoint ep selector select objOnImageStore destData if ep null String errMsg s_logger error errMsg
if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if answer null answer getResult if answer null s_logger debug answer getDetails objOnImageStore processEvent Event OperationFailed imageStore delete objOnImageStore return answer objOnImageStore processEvent Event OperationSuccessed imageStore delete objOnImageStore return answer
protected Answer migrateVolumeToPool DataObject srcData DataObject destData String value configDao getValue Config MigrateWait key int waitInterval NumbersUtil parseInt value Integer parseInt Config MigrateWait getDefaultValue VolumeInfo volume VolumeInfo srcData StoragePool destPool StoragePool dataStoreMgr getDataStore destData getDataStore getId DataStoreRole Primary MigrateVolumeCommand command new MigrateVolumeCommand volume getId volume getPath destPool volume getAttachedVmName volume getVolumeType waitInterval EndPoint ep selector select srcData StorageAction MIGRATEVOLUME Answer answer null if ep null String errMsg
int _createprivatetemplatefromsnapshotwait NumbersUtil parseInt value Integer parseInt Config CreatePrivateTemplateFromSnapshotWait getDefaultValue boolean needCache false if needCacheStorage srcData destData needCache true SnapshotInfo snapshot SnapshotInfo srcData srcData cacheSnapshotChain snapshot snapshot getDataStore getScope EndPoint ep null if srcData getDataStore getRole DataStoreRole Primary ep selector select destData else ep selector select srcData destData CopyCommand cmd new CopyCommand srcData getTO addFullCloneFlagOnVMwareDest destData getTO _createprivatetemplatefromsnapshotwait VirtualMachineManager ExecuteInSequence value Answer answer null if ep null String errMsg
if snapshotFullBackup null fullSnapshot snapshotFullBackup Map String String options new HashMap String String options put fullSnapshot toString Answer answer null try if needCacheStorage srcData destData Scope selectedScope pickCacheScopeForCopy srcData destData cacheData cacheMgr getCacheObject srcData selectedScope CopyCommand cmd new CopyCommand srcData getTO addFullCloneFlagOnVMwareDest destData getTO _backupsnapshotwait VirtualMachineManager ExecuteInSequence value cmd setCacheTO cacheData getTO cmd setOptions options EndPoint ep selector select srcData destData if ep null String errMsg
cmd setCacheTO cacheData getTO cmd setOptions options EndPoint ep selector select srcData destData if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd else addFullCloneFlagOnVMwareDest destData getTO CopyCommand cmd new CopyCommand srcData getTO destData getTO _backupsnapshotwait VirtualMachineManager ExecuteInSequence value cmd setOptions options EndPoint ep selector select srcData destData StorageAction BACKUPSNAPSHOT if ep null
Override protected void copyTemplateToTargetFilesystemStorageIfNeeded VolumeInfo srcVolumeInfo StoragePool srcStoragePool DataStore destDataStore StoragePool destStoragePool Host destHost VMTemplateStoragePoolVO sourceVolumeTemplateStoragePoolVO vmTemplatePoolDao findByPoolTemplate destStoragePool getId srcVolumeInfo getTemplateId if sourceVolumeTemplateStoragePoolVO null destStoragePool getPoolType StoragePoolType Filesystem DataStore sourceTemplateDataStore dataStoreManagerImpl getRandomImageStore srcVolumeInfo getDataCenterId if sourceTemplateDataStore null TemplateInfo sourceTemplateInfo templateDataFactory getTemplate srcVolumeInfo getTemplateId sourceTemplateDataStore TemplateObjectTO sourceTemplate new TemplateObjectTO sourceTemplateInfo
private void handleCreateManagedVolumeFromNonManagedSnapshot SnapshotInfo snapshotInfo VolumeInfo volumeInfo AsyncCompletionCallback CopyCommandResult callback String errMsg null CopyCmdAnswer copyCmdAnswer null try DiskOfferingVO diskOffering _diskOfferingDao findByIdIncludingRemoved volumeInfo getDiskOfferingId SnapshotVO snapshot _snapshotDao findById snapshotInfo getId _volumeService updateHypervisorSnapshotReserveForVolume diskOffering volumeInfo getId snapshot getHypervisorType HostVO hostVO AsyncCallFuture VolumeApiResult future _volumeService createVolumeAsync volumeInfo volumeInfo getDataStore VolumeApiResult result future get if result isFailed
_volumeDao updateUuid srcVolumeInfo getId destVolumeInfo getId VolumeVO volumeVO _volumeDao findById destVolumeInfo getId volumeVO setFormat ImageFormat QCOW2 _volumeDao update volumeVO getId volumeVO try _volumeService destroyVolume srcVolumeInfo getId srcVolumeInfo _volumeDataFactory getVolume srcVolumeInfo getId AsyncCallFuture VolumeApiResult destroyFuture _volumeService expungeVolumeAsync srcVolumeInfo if destroyFuture get isFailed LOGGER debug catch Exception e LOGGER debug e if _snapshotDao listByVolumeId srcVolumeInfo getId isEmpty _snapshotDao updateVolumeIds srcVolumeInfo getId destVolumeInfo getId _snapshotDataStoreDao updateVolumeIds srcVolumeInfo getId destVolumeInfo getId
try _volumeService destroyVolume srcVolumeInfo getId srcVolumeInfo _volumeDataFactory getVolume srcVolumeInfo getId AsyncCallFuture VolumeApiResult destroyFuture _volumeService expungeVolumeAsync srcVolumeInfo if destroyFuture get isFailed LOGGER debug catch Exception e LOGGER debug e if _snapshotDao listByVolumeId srcVolumeInfo getId isEmpty _snapshotDao updateVolumeIds srcVolumeInfo getId destVolumeInfo getId _snapshotDataStoreDao updateVolumeIds srcVolumeInfo getId destVolumeInfo getId else try disconnectHostFromVolume destHost destVolumeInfo getPoolId destVolumeInfo get_iScsiName catch Exception e
if _snapshotDao listByVolumeId srcVolumeInfo getId isEmpty _snapshotDao updateVolumeIds srcVolumeInfo getId destVolumeInfo getId _snapshotDataStoreDao updateVolumeIds srcVolumeInfo getId destVolumeInfo getId else try disconnectHostFromVolume destHost destVolumeInfo getPoolId destVolumeInfo get_iScsiName catch Exception e LOGGER debug e try _volumeService revokeAccess destVolumeInfo destHost destVolumeInfo getDataStore catch Exception e LOGGER debug e destVolumeInfo processEvent Event OperationFailed srcVolumeInfo processEvent Event OperationFailed try
private void verifyDestinationStorage Map String Storage StoragePoolType sourcePools Host destHost if MapUtils isNotEmpty sourcePools
VMTemplateVO templ imageDataDao findById templateId if store null templ isDirectDownload TemplateObject tmpl TemplateObject getTemplate templ null return tmpl boolean found false if store getRole DataStoreRole Primary VMTemplateStoragePoolVO templatePoolVO templatePoolDao findByPoolTemplate store getId templateId if templatePoolVO null found true else TemplateDataStoreVO templateStoreVO templateStoreDao findByStoreTemplate store getId templateId if templateStoreVO null found true if s_logger isDebugEnabled if found
TemplateObject tmpl TemplateObject getTemplate templ null return tmpl boolean found false if store getRole DataStoreRole Primary VMTemplateStoragePoolVO templatePoolVO templatePoolDao findByPoolTemplate store getId templateId if templatePoolVO null found true else TemplateDataStoreVO templateStoreVO templateStoreDao findByStoreTemplate store getId templateId if templateStoreVO null found true if s_logger isDebugEnabled if found s_logger debug templateId store getId store getRole else
if stores null stores isEmpty return for DataStore store stores List VMTemplateVO rtngTmplts _templateDao listAllSystemVMTemplates List VMTemplateVO defaultBuiltin _templateDao listDefaultBuiltinTemplates for VMTemplateVO rtngTmplt rtngTmplts if rtngTmplt getHypervisorType hostHyper rtngTmplt isDirectDownload toBeDownloaded add rtngTmplt for VMTemplateVO builtinTmplt defaultBuiltin if builtinTmplt getHypervisorType hostHyper builtinTmplt isDirectDownload toBeDownloaded add builtinTmplt for VMTemplateVO template toBeDownloaded TemplateDataStoreVO tmpltHost _vmTemplateStoreDao findByStoreTemplate store getId template getId if tmpltHost null associateTemplateToZone template getId dcId
if defaultBuiltin null for VMTemplateVO builtinTmplt defaultBuiltin if allTemplates contains builtinTmplt allTemplates add builtinTmplt for Iterator VMTemplateVO iter allTemplates listIterator iter hasNext VMTemplateVO child_template iter next if child_template getParentTemplateId null String uniqueName child_template getUniqueName if templateInfos containsKey uniqueName templateInfos remove uniqueName iter remove toBeDownloaded addAll allTemplates final StateMachine2 VirtualMachineTemplate State VirtualMachineTemplate Event VirtualMachineTemplate stateMachine VirtualMachineTemplate State getStateMachine for VMTemplateVO tmplt allTemplates String uniqueName tmplt getUniqueName
VMTemplateVO child_template iter next if child_template getParentTemplateId null String uniqueName child_template getUniqueName if templateInfos containsKey uniqueName templateInfos remove uniqueName iter remove toBeDownloaded addAll allTemplates final StateMachine2 VirtualMachineTemplate State VirtualMachineTemplate Event VirtualMachineTemplate stateMachine VirtualMachineTemplate State getStateMachine for VMTemplateVO tmplt allTemplates String uniqueName tmplt getUniqueName TemplateDataStoreVO tmpltStore _vmTemplateStoreDao findByStoreTemplate storeId tmplt getId if templateInfos containsKey uniqueName TemplateProp tmpltInfo templateInfos remove uniqueName toBeDownloaded remove tmplt if tmpltStore null
iter remove toBeDownloaded addAll allTemplates final StateMachine2 VirtualMachineTemplate State VirtualMachineTemplate Event VirtualMachineTemplate stateMachine VirtualMachineTemplate State getStateMachine for VMTemplateVO tmplt allTemplates String uniqueName tmplt getUniqueName TemplateDataStoreVO tmpltStore _vmTemplateStoreDao findByStoreTemplate storeId tmplt getId if templateInfos containsKey uniqueName TemplateProp tmpltInfo templateInfos remove uniqueName toBeDownloaded remove tmplt if tmpltStore null s_logger info uniqueName if tmpltStore getDownloadState Status DOWNLOADED tmpltStore setErrorString if tmpltInfo isCorrupted tmpltStore setDownloadState Status DOWNLOAD_ERROR
final StateMachine2 VirtualMachineTemplate State VirtualMachineTemplate Event VirtualMachineTemplate stateMachine VirtualMachineTemplate State getStateMachine for VMTemplateVO tmplt allTemplates String uniqueName tmplt getUniqueName TemplateDataStoreVO tmpltStore _vmTemplateStoreDao findByStoreTemplate storeId tmplt getId if templateInfos containsKey uniqueName TemplateProp tmpltInfo templateInfos remove uniqueName toBeDownloaded remove tmplt if tmpltStore null s_logger info uniqueName if tmpltStore getDownloadState Status DOWNLOADED tmpltStore setErrorString if tmpltInfo isCorrupted tmpltStore setDownloadState Status DOWNLOAD_ERROR String msg tmplt getName tmplt getId tmpltStore getId tmpltStore setErrorString msg
else if tmplt getUrl null msg tmplt tmpltInfo getInstallPath tmpltStore getDataStoreId s_logger warn msg else s_logger info tmplt getName _vmTemplateStoreDao remove tmpltStore getId toBeDownloaded add tmplt else if tmpltStore getDownloadState Status DOWNLOADED String etype EventTypes EVENT_TEMPLATE_CREATE if tmplt getFormat ImageFormat ISO etype EventTypes EVENT_ISO_CREATE if zoneId null UsageEventUtils publishUsageEvent etype tmplt getAccountId zoneId tmplt getId tmplt getName null null tmpltInfo getPhysicalSize tmpltInfo getSize VirtualMachineTemplate class getName tmplt getUuid tmpltStore setDownloadPercent
try stateMachine transitTo tmplt event null _templateDao catch NoTransitionException e s_logger error tmplt getName e getMessage if tmpltInfo getSize tmplt getAccountId Account ACCOUNT_ID_SYSTEM tmplt getUrl null long accountId tmplt getAccountId try _resourceLimitMgr checkResourceLimit _accountMgr getAccount accountId com cloud configuration Resource ResourceType secondary_storage tmpltInfo getSize UriUtils getRemoteSize tmplt getUrl catch ResourceAllocationException e s_logger warn e getMessage _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED zoneId null e getMessage e getMessage finally _resourceLimitMgr recalculateResourceCount accountId _accountMgr getAccount accountId getDomainId com cloud configuration Resource ResourceType secondary_storage getOrdinal _vmTemplateStoreDao update tmpltStore getId tmpltStore else
stateMachine transitTo tmplt event null _templateDao catch NoTransitionException e s_logger error tmplt getName e getMessage if tmpltInfo getSize tmplt getAccountId Account ACCOUNT_ID_SYSTEM tmplt getUrl null long accountId tmplt getAccountId try _resourceLimitMgr checkResourceLimit _accountMgr getAccount accountId com cloud configuration Resource ResourceType secondary_storage tmpltInfo getSize UriUtils getRemoteSize tmplt getUrl catch ResourceAllocationException e s_logger warn e getMessage _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED zoneId null e getMessage e getMessage finally _resourceLimitMgr recalculateResourceCount accountId _accountMgr getAccount accountId getDomainId com cloud configuration Resource ResourceType secondary_storage getOrdinal _vmTemplateStoreDao update tmpltStore getId tmpltStore else tmpltStore new TemplateDataStoreVO storeId tmplt getId new Date Status DOWNLOADED null null null tmpltInfo getInstallPath tmplt getUrl
s_logger error tmplt getName e getMessage if tmpltInfo getSize tmplt getAccountId Account ACCOUNT_ID_SYSTEM tmplt getUrl null long accountId tmplt getAccountId try _resourceLimitMgr checkResourceLimit _accountMgr getAccount accountId com cloud configuration Resource ResourceType secondary_storage tmpltInfo getSize UriUtils getRemoteSize tmplt getUrl catch ResourceAllocationException e s_logger warn e getMessage _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED zoneId null e getMessage e getMessage finally _resourceLimitMgr recalculateResourceCount accountId _accountMgr getAccount accountId getDomainId com cloud configuration Resource ResourceType secondary_storage getOrdinal _vmTemplateStoreDao update tmpltStore getId tmpltStore else tmpltStore new TemplateDataStoreVO storeId tmplt getId new Date Status DOWNLOADED null null null tmpltInfo getInstallPath tmplt getUrl tmpltStore setSize tmpltInfo getSize tmpltStore setPhysicalSize tmpltInfo getPhysicalSize
_vmTemplateStoreDao update tmpltStore getId tmpltStore else tmpltStore new TemplateDataStoreVO storeId tmplt getId new Date Status DOWNLOADED null null null tmpltInfo getInstallPath tmplt getUrl tmpltStore setSize tmpltInfo getSize tmpltStore setPhysicalSize tmpltInfo getPhysicalSize tmpltStore setDataStoreRole store getRole _vmTemplateStoreDao persist tmpltStore VMTemplateVO tmlpt _templateDao findById tmplt getId tmlpt setSize tmpltInfo getSize _templateDao update tmplt getId tmlpt associateTemplateToZone tmplt getId zoneId String etype EventTypes EVENT_TEMPLATE_CREATE if tmplt getFormat ImageFormat ISO etype EventTypes EVENT_ISO_CREATE UsageEventUtils publishUsageEvent etype tmplt getAccountId zoneId tmplt getId tmplt getName null null tmpltInfo getPhysicalSize tmpltInfo getSize VirtualMachineTemplate class getName tmplt getUuid
else tmpltStore new TemplateDataStoreVO storeId tmplt getId new Date Status DOWNLOADED null null null tmpltInfo getInstallPath tmplt getUrl tmpltStore setSize tmpltInfo getSize tmpltStore setPhysicalSize tmpltInfo getPhysicalSize tmpltStore setDataStoreRole store getRole _vmTemplateStoreDao persist tmpltStore VMTemplateVO tmlpt _templateDao findById tmplt getId tmlpt setSize tmpltInfo getSize _templateDao update tmplt getId tmlpt associateTemplateToZone tmplt getId zoneId String etype EventTypes EVENT_TEMPLATE_CREATE if tmplt getFormat ImageFormat ISO etype EventTypes EVENT_ISO_CREATE UsageEventUtils publishUsageEvent etype tmplt getAccountId zoneId tmplt getId tmplt getName null null tmpltInfo getPhysicalSize tmpltInfo getSize VirtualMachineTemplate class getName tmplt getUuid else if tmplt getState VirtualMachineTemplate State NotUploaded tmplt getState VirtualMachineTemplate State UploadInProgress
tmlpt setSize tmpltInfo getSize _templateDao update tmplt getId tmlpt associateTemplateToZone tmplt getId zoneId String etype EventTypes EVENT_TEMPLATE_CREATE if tmplt getFormat ImageFormat ISO etype EventTypes EVENT_ISO_CREATE UsageEventUtils publishUsageEvent etype tmplt getAccountId zoneId tmplt getId tmplt getName null null tmpltInfo getPhysicalSize tmpltInfo getSize VirtualMachineTemplate class getName tmplt getUuid else if tmplt getState VirtualMachineTemplate State NotUploaded tmplt getState VirtualMachineTemplate State UploadInProgress s_logger info uniqueName storeId toBeDownloaded remove tmplt tmpltStore setDownloadState Status DOWNLOAD_ERROR String msg tmplt getName tmplt getId tmpltStore getId tmpltStore setErrorString msg tmpltStore setState State Failed _vmTemplateStoreDao update tmpltStore getId tmpltStore
else if tmplt getState VirtualMachineTemplate State NotUploaded tmplt getState VirtualMachineTemplate State UploadInProgress s_logger info uniqueName storeId toBeDownloaded remove tmplt tmpltStore setDownloadState Status DOWNLOAD_ERROR String msg tmplt getName tmplt getId tmpltStore getId tmpltStore setErrorString msg tmpltStore setState State Failed _vmTemplateStoreDao update tmpltStore getId tmpltStore try stateMachine transitTo tmplt VirtualMachineTemplate Event OperationFailed null _templateDao catch NoTransitionException e s_logger error tmplt getName e getMessage else if tmplt isDirectDownload s_logger info tmplt getName tmplt getId toBeDownloaded remove tmplt
toBeDownloaded remove tmplt else s_logger info uniqueName storeId if tmpltStore null if _storeMgr isRegionStore store tmpltStore getDownloadState VMTemplateStorageResourceAssoc Status DOWNLOADED tmpltStore getState State Ready tmpltStore getInstallPath null s_logger info else s_logger info uniqueName _vmTemplateStoreDao remove tmpltStore getId if toBeDownloaded size List HypervisorType availHypers _clusterDao getAvailableHypervisorInZone zoneId if availHypers isEmpty availHypers add HypervisorType KVM availHypers remove HypervisorType BareMetal availHypers add HypervisorType None
private Map String TemplateProp listTemplate DataStore ssStore String nfsVersion imageStoreDetailsUtil getNfsVersion ssStore getId ListTemplateCommand cmd new ListTemplateCommand ssStore getTO nfsVersion EndPoint ep _epSelector select ssStore Answer answer null if ep null String errMsg
String nfsVersion imageStoreDetailsUtil getNfsVersion ssStore getId ListTemplateCommand cmd new ListTemplateCommand ssStore getTO nfsVersion EndPoint ep _epSelector select ssStore Answer answer null if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if answer null answer getResult ListTemplateAnswer tanswer ListTemplateAnswer answer return tanswer getTemplateInfo else if s_logger isDebugEnabled
templateVO setParentTemplateId template getId templateVO setSize dataDiskTemplate getVirtualSize templateVO _templateDao persist templateVO TemplateApiResult result null TemplateInfo dataDiskTemplateInfo imageFactory getTemplate templateVO getId imageStore AsyncCallFuture TemplateApiResult future createDatadiskTemplateAsync parentTemplate dataDiskTemplateInfo dataDiskTemplate getPath dataDiskTemplate getDiskId dataDiskTemplate getFileSize dataDiskTemplate isBootable result future get if result isSuccess if imageStore getScope getScopeType ScopeType REGION associateTemplateToZone templateId null else if imageStore getScope getScopeType ScopeType ZONE Long zoneId ImageStoreEntity imageStore getDataCenterId VMTemplateZoneVO templateZone new VMTemplateZoneVO zoneId templateId new Date _vmTemplateZoneDao persist templateZone _resourceLimitMgr incrementResourceCount template getAccountId ResourceType secondary_storage templateVO getSize
private boolean finalizeParentTemplate DatadiskTO dataDiskTemplate VMTemplateVO templateVO TemplateInfo parentTemplate DataStore imageStore int diskCount throws ExecutionException InterruptedException CloudRuntimeException TemplateInfo templateInfo imageFactory getTemplate templateVO getId imageStore AsyncCallFuture TemplateApiResult templateFuture createDatadiskTemplateAsync parentTemplate templateInfo dataDiskTemplate getPath dataDiskTemplate getDiskId dataDiskTemplate getFileSize dataDiskTemplate isBootable TemplateApiResult result null result templateFuture get if result isSuccess
private void cleanupDatadiskTemplates TemplateInfo parentTemplateInfo DataStore imageStore parentTemplateInfo getDataStore List VMTemplateVO datadiskTemplatesToDelete _templateDao listByParentTemplatetId parentTemplateInfo getId for VMTemplateVO datadiskTemplateToDelete datadiskTemplatesToDelete
Override public void syncTemplateToRegionStore long templateId DataStore store if _storeMgr isRegionStore store if s_logger isDebugEnabled
protected Void copyTemplateCrossZoneCallBack AsyncCallbackDispatcher TemplateServiceImpl CreateCmdResult callback TemplateOpContext TemplateApiResult context if s_logger isDebugEnabled s_logger debug TemplateInfo destTemplate context getTemplate CreateCmdResult result callback getResult AsyncCallFuture TemplateApiResult future context getFuture TemplateApiResult res new TemplateApiResult destTemplate try if result isFailed res setResult result getResult destTemplate processEvent Event OperationFailed else destTemplate processEvent Event OperationSuccessed result getAnswer future complete res catch Exception e
protected void loadResource Long hostId HostVO host hostDao findById hostId Map String Object params new HashMap String Object params put host getGuid params put host getPrivateIpAddress params put params put params put String valueOf host getDataCenterId params put String valueOf host getPodId ServerResource resource null if host getHypervisorType HypervisorType XenServer resource new XcpOssResource try resource configure host getName params catch ConfigurationException e
Override public boolean revertSnapshot SnapshotInfo snapshotInfo VolumeInfo volumeInfo snapshotInfo getBaseVolume ImageFormat imageFormat volumeInfo getFormat if ImageFormat RAW equals imageFormat
SnapshotInfo parentSnapshot snapshot getParent if parentSnapshot null snapshot getPath equalsIgnoreCase parentSnapshot getPath SnapshotDataStoreVO parentSnapshotOnBackupStore snapshotStoreDao findBySnapshot parentSnapshot getId DataStoreRole Image if parentSnapshotOnBackupStore null parentSnapshotOnBackupStore getState State Ready DataStore store dataStoreMgr getDataStore parentSnapshotOnBackupStore getDataStoreId parentSnapshotOnBackupStore getRole SnapshotInfo snapshotOnImageStore SnapshotInfo store create snapshot snapshotOnImageStore processEvent Event CreateOnlyRequested SnapshotObjectTO snapTO new SnapshotObjectTO snapTO setPath parentSnapshotOnBackupStore getInstallPath CreateObjectAnswer createSnapshotAnswer new CreateObjectAnswer snapTO snapshotOnImageStore processEvent Event OperationSuccessed createSnapshotAnswer SnapshotObject snapObj SnapshotObject snapshot try snapObj processEvent Snapshot Event OperationNotPerformed catch NoTransitionException e
protected boolean deleteSnapshotChain SnapshotInfo snapshot
boolean deleted false if parent null if parent getPath null parent getPath equalsIgnoreCase snapshot getPath s_logger debug snapshot processEvent Event DestroyRequested snapshot processEvent Event OperationSuccessed deleted true if resultIsSet result true resultIsSet true if deleted try boolean r snapshotSvr deleteSnapshot snapshot if r List SnapshotInfo cacheSnaps snapshotDataFactory listSnapshotOnCache snapshot getId
resultIsSet true if deleted try boolean r snapshotSvr deleteSnapshot snapshot if r List SnapshotInfo cacheSnaps snapshotDataFactory listSnapshotOnCache snapshot getId for SnapshotInfo cacheSnap cacheSnaps s_logger debug snapshot getId cacheSnap getDataStore getName cacheSnap delete if resultIsSet result r resultIsSet true catch Exception e s_logger debug e snapshot parent
return true if Snapshot State Error equals snapshotVO getState List SnapshotDataStoreVO storeRefs snapshotStoreDao findBySnapshotId snapshotId for SnapshotDataStoreVO ref storeRefs snapshotStoreDao expunge ref getId snapshotDao remove snapshotId return true if snapshotVO getState Snapshot State CreatedOnPrimary snapshotVO setState Snapshot State Destroyed snapshotDao update snapshotId snapshotVO return true if Snapshot State BackedUp equals snapshotVO getState Snapshot State Destroying equals snapshotVO getState throw new InvalidParameterValueException snapshotId snapshotVO getState Boolean deletedOnSecondary deleteOnSecondaryIfNeeded snapshotId boolean deletedOnPrimary deleteOnPrimaryIfNeeded snapshotId
if Snapshot State Error equals snapshotVO getState List SnapshotDataStoreVO storeRefs snapshotStoreDao findBySnapshotId snapshotId for SnapshotDataStoreVO ref storeRefs snapshotStoreDao expunge ref getId snapshotDao remove snapshotId return true if snapshotVO getState Snapshot State CreatedOnPrimary snapshotVO setState Snapshot State Destroyed snapshotDao update snapshotId snapshotVO return true if Snapshot State BackedUp equals snapshotVO getState Snapshot State Destroying equals snapshotVO getState throw new InvalidParameterValueException snapshotId snapshotVO getState Boolean deletedOnSecondary deleteOnSecondaryIfNeeded snapshotId boolean deletedOnPrimary deleteOnPrimaryIfNeeded snapshotId if deletedOnPrimary
for SnapshotDataStoreVO ref storeRefs snapshotStoreDao expunge ref getId snapshotDao remove snapshotId return true if snapshotVO getState Snapshot State CreatedOnPrimary snapshotVO setState Snapshot State Destroyed snapshotDao update snapshotId snapshotVO return true if Snapshot State BackedUp equals snapshotVO getState Snapshot State Destroying equals snapshotVO getState throw new InvalidParameterValueException snapshotId snapshotVO getState Boolean deletedOnSecondary deleteOnSecondaryIfNeeded snapshotId boolean deletedOnPrimary deleteOnPrimaryIfNeeded snapshotId if deletedOnPrimary s_logger debug String format snapshotId else
private Boolean deleteOnSecondaryIfNeeded Long snapshotId Boolean deletedOnSecondary null SnapshotInfo snapshotOnImage snapshotDataFactory getSnapshot snapshotId DataStoreRole Image if snapshotOnImage null
private boolean deleteSnapshotOnPrimary Long snapshotId SnapshotInfo snapshotOnPrimaryInfo SnapshotDataStoreVO snapshotOnPrimary snapshotStoreDao findBySnapshot snapshotId DataStoreRole Primary if isSnapshotOnPrimaryStorage snapshotId if s_logger isDebugEnabled
throw new CloudRuntimeException SnapshotVO snapshotVO snapshotDao acquireInLockTable snapshot getId if snapshotVO null throw new CloudRuntimeException snapshot getId try VolumeInfo volumeInfo snapshot getBaseVolume StoragePool store StoragePool volumeInfo getDataStore if store null store getStatus StoragePoolStatus Up snapshot processEvent Event OperationFailed throw new CloudRuntimeException volumeInfo stateTransit Volume Event RevertSnapshotRequested boolean result false try result snapshotSvr revertSnapshot snapshot if result
CreateSnapshotPayload createSnapshotPayload null if payload null createSnapshotPayload CreateSnapshotPayload payload if createSnapshotPayload getQuiescevm throw new InvalidParameterValueException SnapshotVO snapshotVO snapshotDao acquireInLockTable snapshot getId if snapshotVO null throw new CloudRuntimeException snapshot getId try VolumeInfo volumeInfo snapshot getBaseVolume volumeInfo stateTransit Volume Event SnapshotRequested SnapshotResult result null try result snapshotSvr takeSnapshot snapshot if result isFailed
if PrimaryDataStoreImpl primaryStore getPoolType StoragePoolType RBD Long parentSnapshotId parent getId while parentSnapshotId null parentSnapshotId 0L SnapshotDataStoreVO snapshotDataStoreVO snapshotStoreDao findByStoreSnapshot primaryStore getRole primaryStore getId parentSnapshotId if snapshotDataStoreVO null parentSnapshotId snapshotDataStoreVO getParentSnapshotId UsageEventUtils publishUsageEvent EventTypes EVENT_SNAPSHOT_OFF_PRIMARY parent getAccountId parent getDataCenterId parent getId parent getName null null 0L 0L parent getClass getName parent getUuid snapshotStoreDao remove snapshotDataStoreVO getId else parentSnapshotId null SnapshotDataStoreVO snapshotDataStoreVO snapshotStoreDao findByStoreSnapshot primaryStore getRole primaryStore getId snapshotOnPrimary getId if snapshotDataStoreVO null snapshotDataStoreVO setParentSnapshotId 0L snapshotStoreDao update snapshotDataStoreVO getId snapshotDataStoreVO catch Exception e
if answer CreateObjectAnswer SnapshotObjectTO snapshotTO SnapshotObjectTO CreateObjectAnswer answer getData snapshotStore setInstallPath snapshotTO getPath snapshotStoreDao update snapshotStore getId snapshotStore else if answer CopyCmdAnswer SnapshotObjectTO snapshotTO SnapshotObjectTO CopyCmdAnswer answer getNewData snapshotStore setInstallPath snapshotTO getPath if snapshotTO getPhysicalSize null snapshotStore setPhysicalSize snapshotTO getPhysicalSize if snapshotTO getParentSnapshotPath null snapshotStore setParentSnapshotId 0L snapshotStoreDao update snapshotStore getId snapshotStore if snapshotTO getVolume null snapshotTO getVolume getPath null VolumeVO vol volumeDao findByUuid snapshotTO getVolume getUuid if vol null
SnapshotResult snapResult new SnapshotResult snapshot result getAnswer if result isFailed s_logger debug context snapshot getName result getResult try snapshot processEvent Snapshot Event OperationFailed snapshot processEvent Event OperationFailed catch Exception e s_logger debug e getMessage snapResult setResult result getResult future complete snapResult return null try snapshot processEvent Event OperationSuccessed result getAnswer snapshot processEvent Snapshot Event OperationSucceeded catch Exception e
snapshot processEvent Event OperationFailed catch Exception e s_logger debug e getMessage snapResult setResult result getResult future complete snapResult return null try snapshot processEvent Event OperationSuccessed result getAnswer snapshot processEvent Snapshot Event OperationSucceeded catch Exception e s_logger debug e snapResult setResult e toString try snapshot processEvent Snapshot Event OperationFailed catch NoTransitionException e1
SnapshotObject snapshot SnapshotObject snap SnapshotObject snapshotOnPrimary null try snapshotOnPrimary SnapshotObject snap getDataStore create snapshot catch Exception e s_logger debug e getMessage throw new CloudRuntimeException e try snapshotOnPrimary processEvent Snapshot Event CreateRequested catch NoTransitionException e s_logger debug e toString throw new CloudRuntimeException e try snapshotOnPrimary processEvent Event CreateOnlyRequested catch Exception e
catch Exception e s_logger debug e getMessage throw new CloudRuntimeException e try snapshotOnPrimary processEvent Snapshot Event CreateRequested catch NoTransitionException e s_logger debug e toString throw new CloudRuntimeException e try snapshotOnPrimary processEvent Event CreateOnlyRequested catch Exception e s_logger debug e toString try snapshotOnPrimary processEvent Snapshot Event OperationFailed catch NoTransitionException e1
throw new CloudRuntimeException e try snapshotOnPrimary processEvent Event CreateOnlyRequested catch Exception e s_logger debug e toString try snapshotOnPrimary processEvent Snapshot Event OperationFailed catch NoTransitionException e1 s_logger debug e1 toString throw new CloudRuntimeException e AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult try CreateSnapshotContext CommandResult context new CreateSnapshotContext CommandResult null snap getBaseVolume snapshotOnPrimary future AsyncCallbackDispatcher SnapshotServiceImpl CreateCmdResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget createSnapshotAsyncCallback null null setContext context
catch Exception e s_logger debug e toString try snapshotOnPrimary processEvent Snapshot Event OperationFailed catch NoTransitionException e1 s_logger debug e1 toString throw new CloudRuntimeException e AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult try CreateSnapshotContext CommandResult context new CreateSnapshotContext CommandResult null snap getBaseVolume snapshotOnPrimary future AsyncCallbackDispatcher SnapshotServiceImpl CreateCmdResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget createSnapshotAsyncCallback null null setContext context PrimaryDataStoreDriver primaryStore PrimaryDataStoreDriver snapshotOnPrimary getDataStore getDriver primaryStore takeSnapshot snapshot caller catch Exception e
throw new CloudRuntimeException e AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult try CreateSnapshotContext CommandResult context new CreateSnapshotContext CommandResult null snap getBaseVolume snapshotOnPrimary future AsyncCallbackDispatcher SnapshotServiceImpl CreateCmdResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget createSnapshotAsyncCallback null null setContext context PrimaryDataStoreDriver primaryStore PrimaryDataStoreDriver snapshotOnPrimary getDataStore getDriver primaryStore takeSnapshot snapshot caller catch Exception e s_logger debug snapshot getId e try snapshot processEvent Snapshot Event OperationFailed snapshot processEvent Event OperationFailed catch NoTransitionException e1 s_logger debug e
try CreateSnapshotContext CommandResult context new CreateSnapshotContext CommandResult null snap getBaseVolume snapshotOnPrimary future AsyncCallbackDispatcher SnapshotServiceImpl CreateCmdResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget createSnapshotAsyncCallback null null setContext context PrimaryDataStoreDriver primaryStore PrimaryDataStoreDriver snapshotOnPrimary getDataStore getDriver primaryStore takeSnapshot snapshot caller catch Exception e s_logger debug snapshot getId e try snapshot processEvent Snapshot Event OperationFailed snapshot processEvent Event OperationFailed catch NoTransitionException e1 s_logger debug e throw new CloudRuntimeException snapshot getId SnapshotResult result
AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult SnapshotResult result new SnapshotResult snapshot null Snapshot State origState snapObj getState try snapObj processEvent Snapshot Event BackupToSecondary DataStore imageStore findSnapshotImageStore snapshot if imageStore null throw new CloudRuntimeException SnapshotInfo snapshotOnImageStore SnapshotInfo imageStore create snapshot snapshotOnImageStore processEvent Event CreateOnlyRequested CopySnapshotContext CommandResult context new CopySnapshotContext CommandResult null snapshot snapshotOnImageStore future AsyncCallbackDispatcher SnapshotServiceImpl CopyCommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget copySnapshotAsyncCallback null null setContext context motionSrv copyAsync snapshot snapshotOnImageStore caller catch Exception e
SnapshotInfo snapshotOnImageStore SnapshotInfo imageStore create snapshot snapshotOnImageStore processEvent Event CreateOnlyRequested CopySnapshotContext CommandResult context new CopySnapshotContext CommandResult null snapshot snapshotOnImageStore future AsyncCallbackDispatcher SnapshotServiceImpl CopyCommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget copySnapshotAsyncCallback null null setContext context motionSrv copyAsync snapshot snapshotOnImageStore caller catch Exception e s_logger debug e result setResult e toString try if origState equals Snapshot State BackedUp snapObj processEvent Snapshot Event OperationNotPerformed else snapObj processEvent Snapshot Event OperationFailed catch NoTransitionException e1
s_logger debug e result setResult e toString try if origState equals Snapshot State BackedUp snapObj processEvent Snapshot Event OperationNotPerformed else snapObj processEvent Snapshot Event OperationFailed catch NoTransitionException e1 s_logger debug e1 toString future complete result try SnapshotResult res future get if res isFailed throw new CloudRuntimeException res getResult SnapshotInfo destSnapshot res getSnapshot
if origState equals Snapshot State BackedUp snapObj processEvent Snapshot Event OperationNotPerformed else snapObj processEvent Snapshot Event OperationFailed catch NoTransitionException e1 s_logger debug e1 toString future complete result try SnapshotResult res future get if res isFailed throw new CloudRuntimeException res getResult SnapshotInfo destSnapshot res getSnapshot return destSnapshot catch InterruptedException e s_logger debug e
SnapshotInfo destSnapshot context destSnapshot SnapshotObject srcSnapshot SnapshotObject context srcSnapshot Object payload srcSnapshot getPayload CreateSnapshotPayload createSnapshotPayload CreateSnapshotPayload payload AsyncCallFuture SnapshotResult future context future SnapshotResult snapResult new SnapshotResult destSnapshot result getAnswer if result isFailed try if createSnapshotPayload getAsyncBackup destSnapshot processEvent Event OperationFailed throw new SnapshotBackupException srcSnapshot getId else destSnapshot processEvent Event OperationFailed cleanupOnSnapshotBackupFailure context srcSnapshot catch SnapshotBackupException e
else destSnapshot processEvent Event OperationFailed cleanupOnSnapshotBackupFailure context srcSnapshot catch SnapshotBackupException e s_logger debug e toString snapResult setResult result getResult future complete snapResult return null try CopyCmdAnswer copyCmdAnswer CopyCmdAnswer result getAnswer destSnapshot processEvent Event OperationSuccessed copyCmdAnswer srcSnapshot processEvent Snapshot Event OperationSucceeded snapResult new SnapshotResult _snapshotFactory getSnapshot destSnapshot getId destSnapshot getDataStore copyCmdAnswer future complete snapResult catch Exception e
protected Void deleteSnapshotCallback AsyncCallbackDispatcher SnapshotServiceImpl CommandResult callback DeleteSnapshotContext CommandResult context CommandResult result callback getResult AsyncCallFuture SnapshotResult future context future SnapshotInfo snapshot context snapshot SnapshotResult res null try if result isFailed
protected Void deleteSnapshotCallback AsyncCallbackDispatcher SnapshotServiceImpl CommandResult callback DeleteSnapshotContext CommandResult context CommandResult result callback getResult AsyncCallFuture SnapshotResult future context future SnapshotInfo snapshot context snapshot SnapshotResult res null try if result isFailed s_logger debug result getResult snapshot processEvent ObjectInDataStoreStateMachine Event OperationFailed res new SnapshotResult context snapshot null res setResult result getResult else snapshot processEvent ObjectInDataStoreStateMachine Event OperationSuccessed res new SnapshotResult context snapshot null catch Exception e
protected Void revertSnapshotCallback AsyncCallbackDispatcher SnapshotServiceImpl CommandResult callback RevertSnapshotContext CommandResult context CommandResult result callback getResult AsyncCallFuture SnapshotResult future context future SnapshotResult res null try if result isFailed
Override public boolean deleteSnapshot SnapshotInfo snapInfo snapInfo processEvent ObjectInDataStoreStateMachine Event DestroyRequested AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult DeleteSnapshotContext CommandResult context new DeleteSnapshotContext CommandResult null snapInfo future AsyncCallbackDispatcher SnapshotServiceImpl CommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget deleteSnapshotCallback null null setContext context DataStore store snapInfo getDataStore store getDriver deleteAsync store snapInfo caller SnapshotResult result null try result future get if result isFailed throw new CloudRuntimeException result getResult return true catch InterruptedException e
AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult DeleteSnapshotContext CommandResult context new DeleteSnapshotContext CommandResult null snapInfo future AsyncCallbackDispatcher SnapshotServiceImpl CommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget deleteSnapshotCallback null null setContext context DataStore store snapInfo getDataStore store getDriver deleteAsync store snapInfo caller SnapshotResult result null try result future get if result isFailed throw new CloudRuntimeException result getResult return true catch InterruptedException e s_logger debug e toString catch ExecutionException e
if snapshotOnPrimaryStore null throw new CloudRuntimeException snapshot getId PrimaryDataStore store PrimaryDataStore snapshotOnPrimaryStore getDataStore AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult RevertSnapshotContext CommandResult context new RevertSnapshotContext CommandResult null snapshot future AsyncCallbackDispatcher SnapshotServiceImpl CommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget revertSnapshotCallback null null setContext context PrimaryDataStoreDriver store getDriver revertSnapshot snapshot snapshotOnPrimaryStore caller SnapshotResult result null try result future get if result isFailed throw new CloudRuntimeException result getResult return true catch InterruptedException e
PrimaryDataStore store PrimaryDataStore snapshotOnPrimaryStore getDataStore AsyncCallFuture SnapshotResult future new AsyncCallFuture SnapshotResult RevertSnapshotContext CommandResult context new RevertSnapshotContext CommandResult null snapshot future AsyncCallbackDispatcher SnapshotServiceImpl CommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget revertSnapshotCallback null null setContext context PrimaryDataStoreDriver store getDriver revertSnapshot snapshot snapshotOnPrimaryStore caller SnapshotResult result null try result future get if result isFailed throw new CloudRuntimeException result getResult return true catch InterruptedException e s_logger debug e toString catch ExecutionException e
Override public void cleanupVolumeDuringSnapshotFailure Long volumeId Long snapshotId SnapshotVO snaphsot _snapshotDao findById snapshotId if snaphsot null if snaphsot getState Snapshot State BackedUp List SnapshotDataStoreVO snapshotDataStoreVOs _snapshotStoreDao findBySnapshotId snapshotId for SnapshotDataStoreVO snapshotDataStoreVO snapshotDataStoreVOs
ActionEvent eventType EventTypes EVENT_SNAPSHOT_OFF_PRIMARY eventDescription async true private boolean cleanupSnapshotOnPrimaryStore long snapshotId SnapshotObject snapshotObj SnapshotObject snapshotDataFactory getSnapshot snapshotId DataStoreRole Primary if snapshotObj null s_logger debug snapshotDao remove snapshotId return true if ObjectInDataStoreStateMachine State Copying equals snapshotObj getStatus throw new InvalidParameterValueException snapshotId try snapshotObj processEvent Snapshot Event DestroyRequested List VolumeDetailVO volumesFromSnapshot volumeDetailsDaoImpl findDetails String valueOf snapshotId null if volumesFromSnapshot size try snapshotObj processEvent Snapshot Event OperationFailed catch NoTransitionException e1
s_logger debug snapshotDao remove snapshotId return true if ObjectInDataStoreStateMachine State Copying equals snapshotObj getStatus throw new InvalidParameterValueException snapshotId try snapshotObj processEvent Snapshot Event DestroyRequested List VolumeDetailVO volumesFromSnapshot volumeDetailsDaoImpl findDetails String valueOf snapshotId null if volumesFromSnapshot size try snapshotObj processEvent Snapshot Event OperationFailed catch NoTransitionException e1 s_logger debug e1 toString throw new InvalidParameterValueException snapshotId catch NoTransitionException e
try snapshotObj processEvent Snapshot Event DestroyRequested List VolumeDetailVO volumesFromSnapshot volumeDetailsDaoImpl findDetails String valueOf snapshotId null if volumesFromSnapshot size try snapshotObj processEvent Snapshot Event OperationFailed catch NoTransitionException e1 s_logger debug e1 toString throw new InvalidParameterValueException snapshotId catch NoTransitionException e s_logger debug e return false try snapshotSvr deleteSnapshot snapshotObj snapshotObj processEvent Snapshot Event OperationSucceeded
try snapshotObj processEvent Snapshot Event OperationFailed catch NoTransitionException e1 s_logger debug e1 toString throw new InvalidParameterValueException snapshotId catch NoTransitionException e s_logger debug e return false try snapshotSvr deleteSnapshot snapshotObj snapshotObj processEvent Snapshot Event OperationSucceeded UsageEventUtils publishUsageEvent EventTypes EVENT_SNAPSHOT_OFF_PRIMARY snapshotObj getAccountId snapshotObj getDataCenterId snapshotId snapshotObj getName null null 0L snapshotObj getClass getName snapshotObj getUuid catch Exception e s_logger debug e try
Override public boolean revertSnapshot SnapshotInfo snapshotInfo VolumeInfo volumeInfo snapshotInfo getBaseVolume verifyFormat volumeInfo verifyDiskTypeAndHypervisor volumeInfo verifySnapshotType snapshotInfo SnapshotDataStoreVO snapshotStore snapshotStoreDao findBySnapshot snapshotInfo getId DataStoreRole Primary if snapshotStore null long snapshotStoragePoolId snapshotStore getDataStoreId if volumeInfo getPoolId equals snapshotStoragePoolId String errMsg
Override public boolean revertSnapshot SnapshotInfo snapshotInfo VolumeInfo volumeInfo snapshotInfo getBaseVolume verifyFormat volumeInfo verifyDiskTypeAndHypervisor volumeInfo verifySnapshotType snapshotInfo SnapshotDataStoreVO snapshotStore snapshotStoreDao findBySnapshot snapshotInfo getId DataStoreRole Primary if snapshotStore null long snapshotStoragePoolId snapshotStore getDataStoreId if volumeInfo getPoolId equals snapshotStoragePoolId String errMsg s_logger error errMsg throw new CloudRuntimeException errMsg boolean storageSystemSupportsCapability storageSystemSupportsCapability volumeInfo getPoolId DataStoreCapabilities CAN_REVERT_VOLUME_TO_SNAPSHOT toString if storageSystemSupportsCapability String errMsg
protected void executeRevertSnapshot SnapshotInfo snapshotInfo VolumeInfo volumeInfo Long hostId null boolean success false SnapshotVO snapshotVO snapshotDao acquireInLockTable snapshotInfo getId if snapshotVO null String errMsg snapshotInfo getId
String errMsg snapshotInfo getId s_logger error errMsg throw new CloudRuntimeException errMsg try volumeInfo stateTransit Volume Event RevertSnapshotRequested if getHypervisorRequiresResignature volumeInfo hostId getHostId volumeInfo if hostId null HostVO hostVO hostDao findById hostId DataStore dataStore dataStoreMgr getDataStore volumeInfo getPoolId DataStoreRole Primary volService revokeAccess volumeInfo hostVO dataStore modifyTarget false volumeInfo hostId success snapshotSvr revertSnapshot snapshotInfo if success String errMsg String format volumeInfo getName volumeInfo getFormat snapshotInfo getSnapshotId
throw new CloudRuntimeException SnapshotVO snapshotVO snapshotDao acquireInLockTable snapshotInfo getId if snapshotVO null throw new CloudRuntimeException snapshotInfo getId VMSnapshot vmSnapshot null if ImageFormat OVA equals volumeInfo getFormat setVmdk snapshotInfo volumeInfo vmSnapshot takeHypervisorSnapshot volumeInfo SnapshotResult result null SnapshotInfo snapshotOnPrimary try volumeInfo stateTransit Volume Event SnapshotRequested if canStorageSystemCreateVolumeFromSnapshot computeClusterSupportsVolumeClone SnapshotDetailsVO snapshotDetail new SnapshotDetailsVO snapshotInfo getId Boolean TRUE toString false snapshotDetailsDao persist snapshotDetail
if hostId null hostId vmInstanceVO getLastHostId if hostId null sourceDetails getSourceDetails volumeInfo else sourceDetails getSourceDetails volumeInfo HostVO hostVO null if hostId null hostVO hostDao findById hostId if hostVO null ResourceState Enabled equals hostVO getResourceState Optional HostVO optHostVO getHost volumeInfo getDataCenterId false if optHostVO isPresent hostVO optHostVO get if hostVO null final String errMsg
final String errMsg s_logger error errMsg throw new CloudRuntimeException errMsg long storagePoolId volumeVO getPoolId StoragePoolVO storagePoolVO storagePoolDao findById storagePoolId DataStore dataStore dataStoreMgr getDataStore storagePoolId DataStoreRole Primary Map String String destDetails getDestDetails storagePoolVO snapshotInfo SnapshotAndCopyCommand snapshotAndCopyCommand new SnapshotAndCopyCommand volumeInfo getPath sourceDetails destDetails SnapshotAndCopyAnswer snapshotAndCopyAnswer try if sourceDetails null volService grantAccess volumeInfo hostVO dataStore volService grantAccess snapshotInfo hostVO dataStore snapshotAndCopyAnswer SnapshotAndCopyAnswer agentMgr send hostVO getId snapshotAndCopyCommand catch Exception ex
if currentSnapshot null current vmSnapshotHelper getSnapshotWithParents currentSnapshot VMSnapshotOptions options VMSnapshotVO vmSnapshot getOptions boolean quiescevm true if options null quiescevm options needQuiesceVM VMSnapshotTO target new VMSnapshotTO vmSnapshot getId vmSnapshot getName vmSnapshot getType null vmSnapshot getDescription false current quiescevm if current null vmSnapshotVO setParent null else vmSnapshotVO setParent current getId HostVO host hostDao findById hostId GuestOSHypervisorVO guestOsMapping guestOsHypervisorDao findByOsIdAndHypervisor guestOS getId host getHypervisorType toString host getHypervisorVersion CreateVMSnapshotCommand ccmd new CreateVMSnapshotCommand userVm getInstanceName userVm getUuid target volumeTOs guestOS getDisplayName if guestOsMapping null ccmd setPlatformEmulator null else ccmd setPlatformEmulator guestOsMapping getGuestOsName ccmd setWait _wait
ccmd setPlatformEmulator guestOsMapping getGuestOsName ccmd setWait _wait answer CreateVMSnapshotAnswer agentMgr send hostId ccmd if answer null answer getResult processAnswer vmSnapshotVO userVm answer hostId s_logger debug vmSnapshot getName userVm getInstanceName result true long new_chain_size for VolumeObjectTO volumeTo answer getVolumeTOs publishUsageEvent EventTypes EVENT_VM_SNAPSHOT_CREATE vmSnapshot userVm volumeTo new_chain_size volumeTo getSize publishUsageEvent EventTypes EVENT_VM_SNAPSHOT_ON_PRIMARY vmSnapshot userVm new_chain_size prev_chain_size virtual_size return vmSnapshot else String errMsg vmSnapshot getName
answer CreateVMSnapshotAnswer agentMgr send hostId ccmd if answer null answer getResult processAnswer vmSnapshotVO userVm answer hostId s_logger debug vmSnapshot getName userVm getInstanceName result true long new_chain_size for VolumeObjectTO volumeTo answer getVolumeTOs publishUsageEvent EventTypes EVENT_VM_SNAPSHOT_CREATE vmSnapshot userVm volumeTo new_chain_size volumeTo getSize publishUsageEvent EventTypes EVENT_VM_SNAPSHOT_ON_PRIMARY vmSnapshot userVm new_chain_size prev_chain_size virtual_size return vmSnapshot else String errMsg vmSnapshot getName if answer null answer getDetails null errMsg errMsg answer getDetails s_logger error errMsg
String vmInstanceName userVm getInstanceName VMSnapshotTO parent vmSnapshotHelper getSnapshotWithParents vmSnapshotVO getParent VMSnapshotTO vmSnapshotTO new VMSnapshotTO vmSnapshot getId vmSnapshot getName vmSnapshot getType vmSnapshot getCreated getTime vmSnapshot getDescription vmSnapshot getCurrent parent true GuestOSVO guestOS guestOSDao findById userVm getGuestOSId DeleteVMSnapshotCommand deleteSnapshotCommand new DeleteVMSnapshotCommand vmInstanceName vmSnapshotTO volumeTOs guestOS getDisplayName Answer answer agentMgr send hostId deleteSnapshotCommand if answer null answer getResult DeleteVMSnapshotAnswer deleteVMSnapshotAnswer DeleteVMSnapshotAnswer answer processAnswer vmSnapshotVO userVm answer hostId long full_chain_size for VolumeObjectTO volumeTo deleteVMSnapshotAnswer getVolumeTOs publishUsageEvent EventTypes EVENT_VM_SNAPSHOT_DELETE vmSnapshot userVm volumeTo full_chain_size volumeTo getSize publishUsageEvent EventTypes EVENT_VM_SNAPSHOT_OFF_PRIMARY vmSnapshot userVm full_chain_size 0L return true
if as CreateVMSnapshotAnswer CreateVMSnapshotAnswer answer CreateVMSnapshotAnswer as finalizeCreate vmSnapshot answer getVolumeTOs vmSnapshotHelper vmSnapshotStateTransitTo vmSnapshot VMSnapshot Event OperationSucceeded else if as RevertToVMSnapshotAnswer RevertToVMSnapshotAnswer answer RevertToVMSnapshotAnswer as finalizeRevert vmSnapshot answer getVolumeTOs vmSnapshotHelper vmSnapshotStateTransitTo vmSnapshot VMSnapshot Event OperationSucceeded else if as DeleteVMSnapshotAnswer DeleteVMSnapshotAnswer answer DeleteVMSnapshotAnswer as finalizeDelete vmSnapshot answer getVolumeTOs vmSnapshotDao remove vmSnapshot getId catch Exception e String errMsg as getClass e getMessage
if guestOsMapping null revertToSnapshotCommand setPlatformEmulator null else revertToSnapshotCommand setPlatformEmulator guestOsMapping getGuestOsName RevertToVMSnapshotAnswer answer RevertToVMSnapshotAnswer agentMgr send hostId revertToSnapshotCommand if answer null answer getResult processAnswer vmSnapshotVO userVm answer hostId result true else String errMsg userVm getInstanceName vmSnapshotVO getName if answer null answer getDetails null errMsg errMsg answer getDetails s_logger error errMsg throw new CloudRuntimeException errMsg catch OperationTimedoutException e s_logger debug e
protected boolean filter ExcludeList avoid StoragePool pool DiskProfile dskCh DeploymentPlan plan if s_logger isDebugEnabled
long dcId plan getDataCenterId Long podId plan getPodId Long clusterId plan getClusterId if podId null return null if dskCh getTags null dskCh getTags length s_logger debug dcId podId clusterId Arrays toString dskCh getTags else s_logger debug dcId podId clusterId if s_logger isTraceEnabled List StoragePoolVO disabledPools storagePoolDao findDisabledPoolsByScope dcId podId clusterId ScopeType CLUSTER if disabledPools null disabledPools isEmpty for StoragePoolVO pool disabledPools s_logger trace pool List StoragePoolVO pools storagePoolDao findPoolsByTags dcId podId clusterId dskCh getTags
return null if dskCh getTags null dskCh getTags length s_logger debug dcId podId clusterId Arrays toString dskCh getTags else s_logger debug dcId podId clusterId if s_logger isTraceEnabled List StoragePoolVO disabledPools storagePoolDao findDisabledPoolsByScope dcId podId clusterId ScopeType CLUSTER if disabledPools null disabledPools isEmpty for StoragePoolVO pool disabledPools s_logger trace pool List StoragePoolVO pools storagePoolDao findPoolsByTags dcId podId clusterId dskCh getTags s_logger debug pools List StoragePoolVO allPools storagePoolDao findPoolsByTags dcId podId clusterId null allPools removeAll pools for StoragePoolVO pool allPools
List StoragePoolVO pools storagePoolDao findPoolsByTags dcId podId clusterId dskCh getTags s_logger debug pools List StoragePoolVO allPools storagePoolDao findPoolsByTags dcId podId clusterId null allPools removeAll pools for StoragePoolVO pool allPools s_logger debug pool avoid addPool pool getId if pools size if s_logger isDebugEnabled s_logger debug ServiceOffering StorageType shared toString return suitablePools for StoragePoolVO pool pools if suitablePools size returnUpTo break StoragePool storagePool StoragePool dataStoreMgr getPrimaryDataStore pool getId
s_logger debug if dskCh useLocalStorage return null if s_logger isTraceEnabled List StoragePoolVO disabledPools storagePoolDao findDisabledPoolsByScope plan getDataCenterId plan getPodId plan getClusterId ScopeType HOST if disabledPools null disabledPools isEmpty for StoragePoolVO pool disabledPools s_logger trace pool List StoragePool suitablePools new ArrayList StoragePool if plan getHostId null List StoragePoolVO hostTagsPools storagePoolDao findLocalStoragePoolsByHostAndTags plan getHostId dskCh getTags for StoragePoolVO pool hostTagsPools if pool null pool isLocal StoragePool storagePool StoragePool this dataStoreMgr getPrimaryDataStore pool getId if filter avoid storagePool dskCh plan
avoid addPool pool getId if suitablePools size returnUpTo break else if plan getPodId null return null List StoragePoolVO availablePools storagePoolDao findLocalStoragePoolsByTags plan getDataCenterId plan getPodId plan getClusterId dskCh getTags for StoragePoolVO pool availablePools if suitablePools size returnUpTo break StoragePool storagePool StoragePool this dataStoreMgr getPrimaryDataStore pool getId if filter avoid storagePool dskCh plan suitablePools add storagePool else avoid addPool pool getId
try ObjectInDataStoreStateMachine Event event null if noCopy event ObjectInDataStoreStateMachine Event CreateOnlyRequested else event ObjectInDataStoreStateMachine Event CreateRequested objectInDataStoreMgr update objInStore event catch NoTransitionException e try objectInDataStoreMgr update objInStore ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1 s_logger debug e1 CreateCmdResult result new CreateCmdResult null null result setSuccess false result setResult e toString
return null try objectInDataStoreMgr update objInStrore ObjectInDataStoreStateMachine Event OperationSuccessed catch NoTransitionException e try objectInDataStoreMgr update objInStrore ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1 s_logger debug e1 upResult setResult e toString context getParentCallback complete upResult return null catch ConcurrentOperationException e try objectInDataStoreMgr update objInStrore ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1
objectInDataStoreMgr update destData ObjectInDataStoreStateMachine Event CopyingRequested catch NoTransitionException e s_logger debug e try objectInDataStoreMgr update destData ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1 s_logger debug e1 CreateCmdResult res new CreateCmdResult null null res setResult e toString callback complete res catch ConcurrentOperationException e s_logger debug e try objectInDataStoreMgr update destData ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1
CopyCommandResult result callback getResult DataObject destObj context destObj if result isFailed try objectInDataStoreMgr update destObj Event OperationFailed catch NoTransitionException e s_logger debug e catch ConcurrentOperationException e s_logger debug e CreateCmdResult res new CreateCmdResult null null res setResult result getResult context getParentCallback complete res try objectInDataStoreMgr update destObj ObjectInDataStoreStateMachine Event OperationSuccessed catch NoTransitionException e
objectInDataStoreMgr update destObj Event OperationFailed catch NoTransitionException e s_logger debug e catch ConcurrentOperationException e s_logger debug e CreateCmdResult res new CreateCmdResult null null res setResult result getResult context getParentCallback complete res try objectInDataStoreMgr update destObj ObjectInDataStoreStateMachine Event OperationSuccessed catch NoTransitionException e s_logger debug e try objectInDataStoreMgr update destObj ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1
catch ConcurrentOperationException e s_logger debug e CreateCmdResult res new CreateCmdResult null null res setResult result getResult context getParentCallback complete res try objectInDataStoreMgr update destObj ObjectInDataStoreStateMachine Event OperationSuccessed catch NoTransitionException e s_logger debug e try objectInDataStoreMgr update destObj ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1 s_logger debug e1 CreateCmdResult res new CreateCmdResult null null res setResult e toString
res setResult result getResult context getParentCallback complete res try objectInDataStoreMgr update destObj ObjectInDataStoreStateMachine Event OperationSuccessed catch NoTransitionException e s_logger debug e try objectInDataStoreMgr update destObj ObjectInDataStoreStateMachine Event OperationFailed catch Exception e1 s_logger debug e1 CreateCmdResult res new CreateCmdResult null null res setResult e toString context getParentCallback complete res catch ConcurrentOperationException e s_logger debug e
DataObject destObj context obj CommandResult res callback getResult if res isFailed try objectInDataStoreMgr update destObj Event OperationFailed catch NoTransitionException e s_logger debug e catch ConcurrentOperationException e s_logger debug e else try objectInDataStoreMgr update destObj Event OperationSuccessed catch NoTransitionException e s_logger debug e catch ConcurrentOperationException e
else if obj getType DataObjectType SNAPSHOT SnapshotInfo snapshotInfo SnapshotInfo obj SnapshotDataStoreVO ss new SnapshotDataStoreVO ss setSnapshotId obj getId ss setDataStoreId dataStore getId ss setRole dataStore getRole ss setVolumeId snapshotInfo getVolumeId ss setSize snapshotInfo getSize ss setPhysicalSize snapshotInfo getSize SnapshotDataStoreVO snapshotDataStoreVO snapshotDataStoreDao findParent dataStore getRole dataStore getId snapshotInfo getVolumeId if snapshotDataStoreVO null SnapshotVO parentSnap snapshotDao findById snapshotDataStoreVO getSnapshotId if parentSnap null ss setParentSnapshotId snapshotDataStoreVO getSnapshotId else
Override public DataObjectInStore findObject long objId DataObjectType type long dataStoreId DataStoreRole role DataObjectInStore vo null if role DataStoreRole Image role DataStoreRole ImageCache switch type case TEMPLATE vo templateDataStoreDao findByStoreTemplate dataStoreId objId break case SNAPSHOT vo snapshotDataStoreDao findByStoreSnapshot role dataStoreId objId break case VOLUME vo volumeDataStoreDao findByStoreVolume dataStoreId objId break else if type DataObjectType TEMPLATE role DataStoreRole Primary vo templatePoolDao findByPoolTemplate dataStoreId objId else if type DataObjectType SNAPSHOT role DataStoreRole Primary vo snapshotDataStoreDao findByStoreSnapshot role dataStoreId objId else
protected boolean registerProvider DataStoreProvider provider Map String Object copyParams new HashMap String Object String providerName provider getName if providerMap get providerName null
s_logger debug provider getName providerMap put providerName provider try boolean registrationResult provider configure copyParams if registrationResult providerMap remove providerName s_logger debug providerName return false Set DataStoreProviderType types provider getTypes if types contains DataStoreProviderType PRIMARY primaryDataStoreProviderMgr registerDriver provider getName PrimaryDataStoreDriver provider getDataStoreDriver primaryDataStoreProviderMgr registerHostListener provider getName provider getHostListener else if types contains DataStoreProviderType IMAGE imageStoreProviderMgr registerDriver provider getName ImageStoreDriver provider getDataStoreDriver catch Exception e
sc setParameters currentState sc setParameters vo getUpdatedCount vo incrUpdatedCount UpdateBuilder builder getUpdateBuilder vo builder set vo nextState builder set vo new Date int rows update vo sc if rows s_logger isDebugEnabled ObjectInDataStoreVO dbVol findByIdIncludingRemoved vo getId if dbVol null StringBuilder str new StringBuilder append vo toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append vo getId append append nextState append append event append append vo getUpdatedCount append append vo getUpdated str append append vo getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
Override public EndPoint select DataObject srcData DataObject destData StorageAction action
Override public DataTO introduceObject DataTO object Scope scope Long storeId EndPoint ep selector select scope storeId IntroduceObjectCmd cmd new IntroduceObjectCmd object Answer answer null if ep null String errMsg
Override public boolean forgetObject DataTO object Scope scope Long storeId EndPoint ep selector select scope storeId ForgetObjectCmd cmd new ForgetObjectCmd object Answer answer null if ep null String errMsg
Override public void createAsync DataStore dataStore DataObject data AsyncCompletionCallback CreateCmdResult callback CreateContext CreateCmdResult context new CreateContext CreateCmdResult callback data AsyncCallbackDispatcher BaseImageStoreDriverImpl DownloadAnswer caller AsyncCallbackDispatcher create this caller setContext context if data getType DataObjectType TEMPLATE caller setCallback caller getTarget createTemplateAsyncCallback null null if s_logger isDebugEnabled
Override public void deleteAsync DataStore dataStore DataObject data AsyncCompletionCallback CommandResult callback CommandResult result new CommandResult try DeleteCommand cmd new DeleteCommand data getTO EndPoint ep _epSelector select data Answer answer null if ep null String errMsg
Override public void deleteAsync DataStore dataStore DataObject data AsyncCompletionCallback CommandResult callback CommandResult result new CommandResult try DeleteCommand cmd new DeleteCommand data getTO EndPoint ep _epSelector select data Answer answer null if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if answer null answer getResult result setResult answer getDetails catch Exception ex
Override public Void createDataDiskTemplateAsync TemplateInfo dataDiskTemplate String path String diskId boolean bootable long fileSize AsyncCompletionCallback CreateCmdResult callback Answer answer null String errMsg null if s_logger isDebugEnabled
sc setParameters currentState sc setParameters dataObj getUpdatedCount dataObj incrUpdatedCount UpdateBuilder builder getUpdateBuilder dataObj builder set dataObj nextState builder set dataObj new Date int rows update dataObj sc if rows s_logger isDebugEnabled SnapshotDataStoreVO dbVol findByIdIncludingRemoved dataObj getId if dbVol null StringBuilder str new StringBuilder append dataObj toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append dataObj getId append append nextState append append event append append dataObj getUpdatedCount append append dataObj getUpdated str append append dataObj getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
Override public void duplicateCacheRecordsOnRegionStore long storeId SearchCriteria SnapshotDataStoreVO sc storeSnapshotSearch create sc setParameters DataStoreRole ImageCache sc setParameters false List SnapshotDataStoreVO snapshots listBy sc if snapshots null
Override public void duplicateCacheRecordsOnRegionStore long storeId SearchCriteria SnapshotDataStoreVO sc storeSnapshotSearch create sc setParameters DataStoreRole ImageCache sc setParameters false List SnapshotDataStoreVO snapshots listBy sc if snapshots null s_logger info snapshots size for SnapshotDataStoreVO snap snapshots SnapshotDataStoreVO snapStore findByStoreSnapshot DataStoreRole Image storeId snap getSnapshotId if snapStore null
Override public void updateStoreRoleToCache long storeId SearchCriteria SnapshotDataStoreVO sc storeSearch create sc setParameters storeId sc setParameters false List SnapshotDataStoreVO snaps listBy sc if snaps null
dataObj incrUpdatedCount UpdateBuilder builder getUpdateBuilder dataObj builder set dataObj nextState builder set dataObj new Date if nextState State Destroyed builder set dataObj true int rows update dataObj sc if rows s_logger isDebugEnabled TemplateDataStoreVO dbVol findByIdIncludingRemoved dataObj getId if dbVol null StringBuilder str new StringBuilder append dataObj toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append dataObj getId append append nextState append append event append append dataObj getUpdatedCount append append dataObj getUpdated str append append dataObj getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
Override public void duplicateCacheRecordsOnRegionStore long storeId SearchCriteria TemplateDataStoreVO sc templateRoleSearch create sc setParameters DataStoreRole ImageCache sc setParameters false List TemplateDataStoreVO tmpls listBy sc if tmpls null
sc setParameters DataStoreRole ImageCache sc setParameters false List TemplateDataStoreVO tmpls listBy sc if tmpls null s_logger info tmpls size for TemplateDataStoreVO tmpl tmpls long templateId tmpl getTemplateId VMTemplateVO template _tmpltDao findById templateId if template null throw new CloudRuntimeException templateId if template getTemplateType TemplateType SYSTEM s_logger info continue TemplateDataStoreVO tmpStore findByStoreTemplate storeId tmpl getTemplateId if tmpStore null
Override public void updateStoreRoleToCachce long storeId SearchCriteria TemplateDataStoreVO sc storeSearch create sc setParameters storeId sc setParameters false List TemplateDataStoreVO tmpls listBy sc if tmpls null
dataObj incrUpdatedCount UpdateBuilder builder getUpdateBuilder dataObj builder set dataObj nextState builder set dataObj new Date if nextState State Destroyed builder set dataObj true int rows update dataObj sc if rows s_logger isDebugEnabled VolumeDataStoreVO dbVol findByIdIncludingRemoved dataObj getId if dbVol null StringBuilder str new StringBuilder append dataObj toString str append append dbVol getId append append dbVol getState append append dbVol getUpdatedCount append append dbVol getUpdated str append append dataObj getId append append nextState append append event append append dataObj getUpdatedCount append append dataObj getUpdated str append append dataObj getId append append currentState append append event append append oldUpdated append append oldUpdatedTime else
Override public DataObject create DataObject obj boolean createEntryInTempSpoolRef if obj getType DataObjectType TEMPLATE isManaged createEntryInTempSpoolRef canCloneVolume try String templateIdPoolIdString obj getId getId VMTemplateStoragePoolVO templateStoragePoolRef GlobalLock lock GlobalLock getInternLock templateIdPoolIdString if lock lock
String templateIdPoolIdString obj getId getId VMTemplateStoragePoolVO templateStoragePoolRef GlobalLock lock GlobalLock getInternLock templateIdPoolIdString if lock lock s_logger debug templateIdPoolIdString return null try templateStoragePoolRef templatePoolDao findByPoolTemplate getId obj getId if templateStoragePoolRef null if s_logger isDebugEnabled s_logger debug templateIdPoolIdString templateStoragePoolRef new VMTemplateStoragePoolVO getId obj getId templateStoragePoolRef templatePoolDao persist templateStoragePoolRef catch Throwable t if s_logger isDebugEnabled
try templateStoragePoolRef templatePoolDao findByPoolTemplate getId obj getId if templateStoragePoolRef null if s_logger isDebugEnabled s_logger debug templateIdPoolIdString templateStoragePoolRef new VMTemplateStoragePoolVO getId obj getId templateStoragePoolRef templatePoolDao persist templateStoragePoolRef catch Throwable t if s_logger isDebugEnabled s_logger debug templateIdPoolIdString t templateStoragePoolRef templatePoolDao findByPoolTemplate getId obj getId if templateStoragePoolRef null throw new CloudRuntimeException else if s_logger isDebugEnabled
DB Override public AsyncCallFuture VolumeApiResult expungeVolumeAsync VolumeInfo volume AsyncCallFuture VolumeApiResult future new AsyncCallFuture VolumeApiResult VolumeApiResult result new VolumeApiResult volume if volume getDataStore null s_logger info if canVolumeBeRemoved volume getId
s_logger info volume getId volDao remove volume getId future complete result return future VolumeDataStoreVO volumeStore _volumeStoreDao findByVolume volume getId if volumeStore null if volumeStore getDownloadState VMTemplateStorageResourceAssoc Status DOWNLOAD_IN_PROGRESS String msg volume getName s_logger debug msg result setSuccess false result setResult msg future complete result return future VolumeVO vol volDao findById volume getId if vol null
VolumeDataStoreVO volumeStore _volumeStoreDao findByVolume volume getId if volumeStore null if volumeStore getDownloadState VMTemplateStorageResourceAssoc Status DOWNLOAD_IN_PROGRESS String msg volume getName s_logger debug msg result setSuccess false result setResult msg future complete result return future VolumeVO vol volDao findById volume getId if vol null s_logger debug volume getId future complete result return future if volumeExistsOnPrimary vol
public Void deleteVolumeCallback AsyncCallbackDispatcher VolumeServiceImpl CommandResult callback DeleteVolumeContext VolumeApiResult context CommandResult result callback getResult VolumeObject vo context getVolume VolumeApiResult apiResult new VolumeApiResult vo try if result isSuccess vo processEvent Event OperationSuccessed if canVolumeBeRemoved vo getId
if templatePoolRef null throw new CloudRuntimeException template getUniqueName dataStore getId else if s_logger isDebugEnabled s_logger debug template getUniqueName dataStore getId templatePoolRef getId long templatePoolRefId templatePoolRef getId CreateBaseImageContext CreateCmdResult context new CreateBaseImageContext CreateCmdResult null volume dataStore template future templateOnPrimaryStoreObj templatePoolRefId AsyncCallbackDispatcher VolumeServiceImpl CopyCommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget copyBaseImageCallback null null setContext context int storagePoolMaxWaitSeconds NumbersUtil parseInt configDao getValue Config StoragePoolMaxWaitSeconds key if s_logger isDebugEnabled s_logger debug templatePoolRefId storagePoolMaxWaitSeconds templatePoolRef _tmpltPoolDao acquireInLockTable templatePoolRefId storagePoolMaxWaitSeconds if templatePoolRef null if s_logger isDebugEnabled
else if s_logger isDebugEnabled s_logger debug template getUniqueName dataStore getId templatePoolRef getId long templatePoolRefId templatePoolRef getId CreateBaseImageContext CreateCmdResult context new CreateBaseImageContext CreateCmdResult null volume dataStore template future templateOnPrimaryStoreObj templatePoolRefId AsyncCallbackDispatcher VolumeServiceImpl CopyCommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget copyBaseImageCallback null null setContext context int storagePoolMaxWaitSeconds NumbersUtil parseInt configDao getValue Config StoragePoolMaxWaitSeconds key if s_logger isDebugEnabled s_logger debug templatePoolRefId storagePoolMaxWaitSeconds templatePoolRef _tmpltPoolDao acquireInLockTable templatePoolRefId storagePoolMaxWaitSeconds if templatePoolRef null if s_logger isDebugEnabled s_logger info templatePoolRefId templatePoolRef _tmpltPoolDao findByPoolTemplate dataStore getId template getId
long templatePoolRefId templatePoolRef getId CreateBaseImageContext CreateCmdResult context new CreateBaseImageContext CreateCmdResult null volume dataStore template future templateOnPrimaryStoreObj templatePoolRefId AsyncCallbackDispatcher VolumeServiceImpl CopyCommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget copyBaseImageCallback null null setContext context int storagePoolMaxWaitSeconds NumbersUtil parseInt configDao getValue Config StoragePoolMaxWaitSeconds key if s_logger isDebugEnabled s_logger debug templatePoolRefId storagePoolMaxWaitSeconds templatePoolRef _tmpltPoolDao acquireInLockTable templatePoolRefId storagePoolMaxWaitSeconds if templatePoolRef null if s_logger isDebugEnabled s_logger info templatePoolRefId templatePoolRef _tmpltPoolDao findByPoolTemplate dataStore getId template getId if templatePoolRef null templatePoolRef getState ObjectInDataStoreStateMachine State Ready s_logger info templatePoolRefId template getUniqueName createVolumeFromBaseImageAsync volume templateOnPrimaryStoreObj dataStore future
caller setCallback caller getTarget copyBaseImageCallback null null setContext context int storagePoolMaxWaitSeconds NumbersUtil parseInt configDao getValue Config StoragePoolMaxWaitSeconds key if s_logger isDebugEnabled s_logger debug templatePoolRefId storagePoolMaxWaitSeconds templatePoolRef _tmpltPoolDao acquireInLockTable templatePoolRefId storagePoolMaxWaitSeconds if templatePoolRef null if s_logger isDebugEnabled s_logger info templatePoolRefId templatePoolRef _tmpltPoolDao findByPoolTemplate dataStore getId template getId if templatePoolRef null templatePoolRef getState ObjectInDataStoreStateMachine State Ready s_logger info templatePoolRefId template getUniqueName createVolumeFromBaseImageAsync volume templateOnPrimaryStoreObj dataStore future return throw new CloudRuntimeException templatePoolRefId if s_logger isDebugEnabled
return throw new CloudRuntimeException templatePoolRefId if s_logger isDebugEnabled s_logger info templatePoolRefId try if templatePoolRef getState ObjectInDataStoreStateMachine State Ready s_logger info template getUniqueName createVolumeFromBaseImageAsync volume templateOnPrimaryStoreObj dataStore future return templateOnPrimaryStoreObj processEvent Event CreateOnlyRequested motionSrv copyAsync template templateOnPrimaryStoreObj caller catch Throwable e s_logger debug e templateOnPrimaryStoreObj processEvent Event OperationFailed dataStore create template
Boolean storageCanCloneVolume new Boolean destPrimaryDataStore getDriver getCapabilities get DataStoreCapabilities CAN_CREATE_VOLUME_FROM_VOLUME toString boolean computeSupportsVolumeClone computeSupportsVolumeClone destHost getDataCenterId destHost getHypervisorType AsyncCallFuture VolumeApiResult future new AsyncCallFuture if storageCanCloneVolume computeSupportsVolumeClone s_logger debug destDataStoreId TemplateInfo templateOnPrimary destPrimaryDataStore getTemplate srcTemplateInfo getId if templateOnPrimary null templateOnPrimary createManagedTemplateVolume srcTemplateInfo destPrimaryDataStore if templateOnPrimary null throw new CloudRuntimeException srcTemplateInfo getUniqueName destDataStoreId VMTemplateStoragePoolVO templatePoolRef _tmpltPoolDao findByPoolTemplate destPrimaryDataStore getId templateOnPrimary getId if templatePoolRef null throw new CloudRuntimeException srcTemplateInfo getUniqueName destPrimaryDataStore getId if templatePoolRef getDownloadState Status NOT_DOWNLOADED copyTemplateToManagedTemplateVolume srcTemplateInfo templateOnPrimary templatePoolRef destPrimaryDataStore destHost
SnapshotInfo snapshot context snapshot VolumeApiResult apiResult new VolumeApiResult volume Event event null if result isFailed apiResult setResult result getResult event Event OperationFailed else event Event OperationSuccessed try if result isSuccess volume processEvent event result getAnswer else volume processEvent event _volumeDetailsDao removeDetail volume getId SNAPSHOT_ID catch Exception e
Override public AsyncCallFuture VolumeApiResult copyVolume VolumeInfo srcVolume DataStore destStore if s_logger isDebugEnabled DataStore srcStore srcVolume getDataStore String srcRole srcStore null srcStore getRole null srcVolume getDataStore getRole toString String msg String format srcVolume getName srcVolume getId srcRole destStore getName destStore getId destStore getRole
future complete res else srcVolume processEvent Event OperationSuccessed destVolume processEvent Event MigrationCopySucceeded result getAnswer volDao updateUuid srcVolume getId destVolume getId try destroyVolume srcVolume getId srcVolume volFactory getVolume srcVolume getId AsyncCallFuture VolumeApiResult destroyFuture expungeVolumeAsync srcVolume if destroyFuture get isFailed Thread sleep destroyFuture expungeVolumeAsync srcVolume destroyFuture get future complete res catch Exception e
else srcVolume processEvent Event OperationSuccessed destVolume processEvent Event MigrationCopySucceeded result getAnswer volDao updateUuid srcVolume getId destVolume getId try destroyVolume srcVolume getId srcVolume volFactory getVolume srcVolume getId AsyncCallFuture VolumeApiResult destroyFuture expungeVolumeAsync srcVolume if destroyFuture get isFailed Thread sleep destroyFuture expungeVolumeAsync srcVolume destroyFuture get future complete res catch Exception e s_logger debug e
AsyncCallFuture VolumeApiResult future new AsyncCallFuture VolumeApiResult VolumeApiResult res new VolumeApiResult srcVolume try if snapshotMgr canOperateOnVolume srcVolume s_logger debug res setResult future complete res return future VolumeInfo destVolume volFactory getVolume srcVolume getId destStore srcVolume processEvent Event MigrationRequested MigrateVolumeContext VolumeApiResult context new MigrateVolumeContext VolumeApiResult null future srcVolume destVolume destStore AsyncCallbackDispatcher VolumeServiceImpl CopyCommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget migrateVolumeCallBack null null setContext context motionSrv copyAsync srcVolume destVolume caller catch Exception e
protected Void migrateVolumeCallBack AsyncCallbackDispatcher VolumeServiceImpl CopyCommandResult callback MigrateVolumeContext VolumeApiResult context VolumeInfo srcVolume context srcVolume CopyCommandResult result callback getResult AsyncCallFuture VolumeApiResult future context future VolumeApiResult res new VolumeApiResult srcVolume try if result isFailed res setResult result getResult srcVolume processEvent Event OperationFailed future complete res else srcVolume processEvent Event OperationSuccessed snapshotMgr cleanupSnapshotsByVolume srcVolume getId future complete res catch Exception e
if snapshotMgr canOperateOnVolume volume s_logger debug res setResult future complete res for VolumeInfo volumeMigrating volumesMigrating volumeMigrating processEvent Event OperationFailed return future else volume processEvent Event MigrationRequested volumesMigrating add volume MigrateVmWithVolumesContext CommandResult context new MigrateVmWithVolumesContext CommandResult null future volumeMap AsyncCallbackDispatcher VolumeServiceImpl CopyCommandResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget migrateVmWithVolumesCallBack null null setContext context motionSrv copyAsync volumeMap vmTo srcHost destHost caller catch Exception e
CommandResult res new CommandResult try if result isFailed res setResult result getResult for Map Entry VolumeInfo DataStore entry volumeToPool entrySet VolumeInfo volume entry getKey volume processEvent Event OperationFailed future complete res else for Map Entry VolumeInfo DataStore entry volumeToPool entrySet VolumeInfo volume entry getKey snapshotMgr cleanupSnapshotsByVolume volume getId volume processEvent Event OperationSuccessed future complete res catch Exception e
AsyncCallFuture VolumeApiResult future new AsyncCallFuture VolumeApiResult VolumeApiResult result new VolumeApiResult volume try volume processEvent Event ResizeRequested catch Exception e s_logger debug e result setResult e toString future complete result return future CreateVolumeContext VolumeApiResult context new CreateVolumeContext VolumeApiResult null volume future AsyncCallbackDispatcher VolumeServiceImpl CreateCmdResult caller AsyncCallbackDispatcher create this caller setCallback caller getTarget resizeVolumeCallback caller context setContext context try volume getDataStore getDriver resize volume caller catch Exception e
CreateCmdResult result callback getResult AsyncCallFuture VolumeApiResult future context future VolumeInfo volume VolumeInfo context volume if result isFailed try volume processEvent Event OperationFailed catch Exception e s_logger debug e VolumeApiResult res new VolumeApiResult volume res setResult result getResult future complete res return null try volume processEvent Event OperationSuccessed catch Exception e
try Map Long TemplateProp volumeInfos listVolume store if volumeInfos null return List VolumeDataStoreVO dbVolumes _volumeStoreDao listByStoreId storeId List VolumeDataStoreVO toBeDownloaded new ArrayList VolumeDataStoreVO dbVolumes for VolumeDataStoreVO volumeStore dbVolumes VolumeVO volume volDao findById volumeStore getVolumeId if volume null s_logger warn volumeStore getVolumeId storeId volumeStore setDestroyed true _volumeStoreDao update volumeStore getId volumeStore continue if volumeInfos containsKey volume getId TemplateProp volInfo volumeInfos remove volume getId
if volume null s_logger warn volumeStore getVolumeId storeId volumeStore setDestroyed true _volumeStoreDao update volumeStore getId volumeStore continue if volumeInfos containsKey volume getId TemplateProp volInfo volumeInfos remove volume getId toBeDownloaded remove volumeStore s_logger info volume getUuid if volumeStore getDownloadState Status DOWNLOADED volumeStore setErrorString if volInfo isCorrupted volumeStore setDownloadState Status DOWNLOAD_ERROR String msg volume getUuid volumeStore setErrorString msg
toBeDownloaded remove volumeStore s_logger info volume getUuid if volumeStore getDownloadState Status DOWNLOADED volumeStore setErrorString if volInfo isCorrupted volumeStore setDownloadState Status DOWNLOAD_ERROR String msg volume getUuid volumeStore setErrorString msg s_logger info msg if volume getState State NotUploaded volume getState State UploadInProgress s_logger info volume getUuid storeId _volumeStoreDao update volumeStore getId volumeStore VolumeObject volObj VolumeObject volFactory getVolume volume getId volObj processEvent Event OperationFailed else if volumeStore getDownloadUrl null
volumeStore setDownloadState Status DOWNLOADED volumeStore setState ObjectInDataStoreStateMachine State Ready volumeStore setInstallPath volInfo getInstallPath volumeStore setSize volInfo getSize volumeStore setPhysicalSize volInfo getPhysicalSize volumeStore setLastUpdated new Date _volumeStoreDao update volumeStore getId volumeStore if volume getSize volume setSize volInfo getSize volDao update volumeStore getVolumeId volume if volume getState State NotUploaded volume getState State UploadInProgress VolumeObject volObj VolumeObject volFactory getVolume volume getId volObj processEvent Event OperationSuccessed if volInfo getSize try
if volume getState State NotUploaded volume getState State UploadInProgress VolumeObject volObj VolumeObject volFactory getVolume volume getId volObj processEvent Event OperationSuccessed if volInfo getSize try _resourceLimitMgr checkResourceLimit _accountMgr getAccount volume getAccountId com cloud configuration Resource ResourceType secondary_storage volInfo getSize volInfo getPhysicalSize catch ResourceAllocationException e s_logger warn e getMessage _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED volume getDataCenterId volume getPodId e getMessage e getMessage finally _resourceLimitMgr recalculateResourceCount volume getAccountId volume getDomainId com cloud configuration Resource ResourceType secondary_storage getOrdinal continue else if volume getState State NotUploaded volume getState State UploadInProgress s_logger info volume getUuid storeId toBeDownloaded remove volumeStore
if toBeDownloaded size for VolumeDataStoreVO volumeHost toBeDownloaded if volumeHost getDownloadUrl null s_logger info volumeHost getVolumeId continue if store getScope getScopeType ScopeType REGION if volumeHost getDownloadState VMTemplateStorageResourceAssoc Status DOWNLOADED volumeHost getInstallPath null s_logger info continue s_logger debug volumeHost getVolumeId store getName VolumeObject vol VolumeObject volFactory getVolume volumeHost getVolumeId vol processEvent Event OperationFailed _volumeStoreDao remove volumeHost getId vol VolumeObject volFactory getVolume volumeHost getVolumeId RegisterVolumePayload payload new RegisterVolumePayload volumeHost getDownloadUrl volumeHost getChecksum vol getFormat toString
private Map Long TemplateProp listVolume DataStore store ListVolumeCommand cmd new ListVolumeCommand store getTO store getUri EndPoint ep _epSelector select store Answer answer null if ep null String errMsg
private Map Long TemplateProp listVolume DataStore store ListVolumeCommand cmd new ListVolumeCommand store getTO store getUri EndPoint ep _epSelector select store Answer answer null if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if answer null answer getResult ListVolumeAnswer tanswer ListVolumeAnswer answer return tanswer getTemplateInfo else if s_logger isDebugEnabled
private void onSendingClusterPdu while true try final ClusterServicePdu pdu popOutgoingClusterPdu if pdu null continue ClusterService peerService null for int i i i try peerService getPeerService pdu getDestPeer catch final RemoteException e s_logger error pdu getDestPeer if peerService null try if s_logger isDebugEnabled
ClusterService peerService null for int i i i try peerService getPeerService pdu getDestPeer catch final RemoteException e s_logger error pdu getDestPeer if peerService null try if s_logger isDebugEnabled s_logger debug getSelfPeerName pdu getDestPeer pdu getAgentId pdu getSequenceId pdu getAckSequenceId pdu getJsonPackage final Profiler profiler new Profiler profiler start final String strResult peerService execute pdu profiler stop if s_logger isDebugEnabled
catch final RemoteException e s_logger error pdu getDestPeer if peerService null try if s_logger isDebugEnabled s_logger debug getSelfPeerName pdu getDestPeer pdu getAgentId pdu getSequenceId pdu getAckSequenceId pdu getJsonPackage final Profiler profiler new Profiler profiler start final String strResult peerService execute pdu profiler stop if s_logger isDebugEnabled s_logger debug getSelfPeerName pdu getDestPeer profiler getDurationInMillis pdu getAgentId pdu getSequenceId pdu getAckSequenceId pdu getJsonPackage if equals strResult break catch final RemoteException e
if peerService null try if s_logger isDebugEnabled s_logger debug getSelfPeerName pdu getDestPeer pdu getAgentId pdu getSequenceId pdu getAckSequenceId pdu getJsonPackage final Profiler profiler new Profiler profiler start final String strResult peerService execute pdu profiler stop if s_logger isDebugEnabled s_logger debug getSelfPeerName pdu getDestPeer profiler getDurationInMillis pdu getAgentId pdu getSequenceId pdu getAckSequenceId pdu getJsonPackage if equals strResult break catch final RemoteException e invalidatePeerService pdu getDestPeer if s_logger isInfoEnabled
Override public String execute final String strPeer final long agentId final String cmds final boolean stopOnError if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug getSelfPeerName strPeer agentId cmds final ClusterServiceRequestPdu pdu new ClusterServiceRequestPdu pdu setSourcePeer getSelfPeerName pdu setDestPeer strPeer pdu setAgentId agentId pdu setJsonPackage cmds pdu setStopOnError stopOnError registerRequestPdu pdu addOutgoingClusterPdu pdu synchronized pdu try pdu wait catch final InterruptedException e if s_logger isDebugEnabled
Override public void registerListener final ClusterManagerListener listener synchronized _listeners
Override public void unregisterListener final ClusterManagerListener listener synchronized _listeners
public void notifyNodeJoined final List ManagementServerHostVO nodeList if s_logger isDebugEnabled s_logger debug for final ManagementServerHostVO mshost nodeList
s_logger trace _mshostId _mshostDao update _mshostId _runId DateUtil currentGMTTime profilerHeartbeatUpdate stop profilerPeerScan start if s_logger isTraceEnabled s_logger trace _mshostId if _peerScanInited _peerScanInited true initPeerScan peerScan profilerPeerScan stop finally profiler stop if profiler getDurationInMillis HeartbeatInterval value if s_logger isDebugEnabled
peerScan profilerPeerScan stop finally profiler stop if profiler getDurationInMillis HeartbeatInterval value if s_logger isDebugEnabled s_logger debug profiler toString profilerHeartbeatUpdate toString profilerPeerScan toString catch final CloudRuntimeException e s_logger error e getCause if e getCause ClusterInvalidSessionException s_logger error queueNotification new ClusterManagerMessage ClusterManagerMessage MessageType nodeIsolated if isRootCauseConnectionRelated e getCause invalidHeartbeatConnection catch final ActiveFencingException e
private void initPeerScan final Date cutTime DateUtil currentGMTTime final List ManagementServerHostVO inactiveList _mshostDao getInactiveList new Date cutTime getTime HeartbeatThreshold value final List Long orphanList _mshostDao listOrphanMsids if orphanList size for final Long orphanMsid orphanList
private void peerScan throws ActiveFencingException final Date cutTime DateUtil currentGMTTime final Profiler profiler new Profiler profiler start final Profiler profilerQueryActiveList new Profiler profilerQueryActiveList start final List ManagementServerHostVO currentList _mshostDao getActiveList new Date cutTime getTime HeartbeatThreshold value profilerQueryActiveList stop final Profiler profilerSyncClusterInfo new Profiler profilerSyncClusterInfo start final List ManagementServerHostVO removedNodeList new ArrayList ManagementServerHostVO final List ManagementServerHostVO invalidatedNodeList new ArrayList ManagementServerHostVO if _mshostId null if _mshostPeerDao countStateSeenInPeers _mshostId _runId ManagementServerHost State Down final String msg
profilerQueryActiveList stop final Profiler profilerSyncClusterInfo new Profiler profilerSyncClusterInfo start final List ManagementServerHostVO removedNodeList new ArrayList ManagementServerHostVO final List ManagementServerHostVO invalidatedNodeList new ArrayList ManagementServerHostVO if _mshostId null if _mshostPeerDao countStateSeenInPeers _mshostId _runId ManagementServerHost State Down final String msg s_logger error msg throw new ActiveFencingException msg for final Map Entry Long ManagementServerHostVO entry _activePeers entrySet final ManagementServerHostVO current getInListById entry getKey currentList if current null if entry getKey longValue _mshostId longValue if s_logger isDebugEnabled
if _mshostPeerDao countStateSeenInPeers _mshostId _runId ManagementServerHost State Down final String msg s_logger error msg throw new ActiveFencingException msg for final Map Entry Long ManagementServerHostVO entry _activePeers entrySet final ManagementServerHostVO current getInListById entry getKey currentList if current null if entry getKey longValue _mshostId longValue if s_logger isDebugEnabled s_logger debug entry getKey entry getValue getServiceIP removedNodeList add entry getValue else if current getRunid if entry getKey longValue _mshostId longValue if s_logger isDebugEnabled
for final Map Entry Long ManagementServerHostVO entry _activePeers entrySet final ManagementServerHostVO current getInListById entry getKey currentList if current null if entry getKey longValue _mshostId longValue if s_logger isDebugEnabled s_logger debug entry getKey entry getValue getServiceIP removedNodeList add entry getValue else if current getRunid if entry getKey longValue _mshostId longValue if s_logger isDebugEnabled s_logger debug entry getKey entry getValue getServiceIP invalidatedNodeList add entry getValue else if entry getValue getRunid current getRunid
profilerSyncClusterInfo stop final Profiler profilerInvalidatedNodeList new Profiler profilerInvalidatedNodeList start if invalidatedNodeList size for final ManagementServerHostVO mshost invalidatedNodeList _activePeers remove mshost getId try JmxUtil unregisterMBean mshost getId catch final Exception e s_logger warn e toString queueNotification new ClusterManagerMessage ClusterManagerMessage MessageType nodeRemoved invalidatedNodeList profilerInvalidatedNodeList stop final Profiler profilerRemovedList new Profiler profilerRemovedList start final Iterator ManagementServerHostVO it removedNodeList iterator
JmxUtil unregisterMBean mshost getId catch final Exception e s_logger warn e toString queueNotification new ClusterManagerMessage ClusterManagerMessage MessageType nodeRemoved invalidatedNodeList profilerInvalidatedNodeList stop final Profiler profilerRemovedList new Profiler profilerRemovedList start final Iterator ManagementServerHostVO it removedNodeList iterator while it hasNext final ManagementServerHostVO mshost it next if pingManagementNode mshost s_logger warn mshost getId _activePeers remove mshost getId try JmxUtil unregisterMBean mshost getId
ManagementServerHostVO mshost _mshostDao findByMsid _msId if mshost null mshost new ManagementServerHostVO mshost setMsid _msId mshost setRunid _runId mshost setName NetUtils getCanonicalHostName mshost setVersion version mshost setServiceIP _clusterNodeIP mshost setServicePort _currentServiceAdapter getServicePort mshost setLastUpdateTime DateUtil currentGMTTime mshost setRemoved null mshost setAlertCount mshost setState ManagementServerHost State Up mshost setUuid UUID randomUUID toString _mshostDao persist mshost
mshost setRunid _runId mshost setName NetUtils getCanonicalHostName mshost setVersion version mshost setServiceIP _clusterNodeIP mshost setServicePort _currentServiceAdapter getServicePort mshost setLastUpdateTime DateUtil currentGMTTime mshost setRemoved null mshost setAlertCount mshost setState ManagementServerHost State Up mshost setUuid UUID randomUUID toString _mshostDao persist mshost if s_logger isInfoEnabled s_logger info _msId _runId else _mshostDao update mshost getId _runId NetUtils getCanonicalHostName version _clusterNodeIP _currentServiceAdapter getServicePort DateUtil currentGMTTime
mshost setLastUpdateTime DateUtil currentGMTTime mshost setRemoved null mshost setAlertCount mshost setState ManagementServerHost State Up mshost setUuid UUID randomUUID toString _mshostDao persist mshost if s_logger isInfoEnabled s_logger info _msId _runId else _mshostDao update mshost getId _runId NetUtils getCanonicalHostName version _clusterNodeIP _currentServiceAdapter getServicePort DateUtil currentGMTTime if s_logger isInfoEnabled s_logger info _msId _runId return mshost _mshostId mshost getId
Override public boolean configure final String name final Map String Object params throws ConfigurationException if s_logger isInfoEnabled
s_logger info return false int retry while retry SocketChannel sch null try s_logger info targetIp sch SocketChannel open sch configureBlocking true sch socket setSoTimeout final InetSocketAddress addr new InetSocketAddress targetIp mshost getServicePort sch connect addr return true catch final IOException e if e ConnectException
final InetSocketAddress addr new InetSocketAddress targetIp mshost getServicePort sch connect addr return true catch final IOException e if e ConnectException s_logger error targetIp mshost getServicePort e return false finally if sch null try sch close catch final IOException e try Thread sleep catch final InterruptedException ex
private void checkConflicts throws ConfigurationException final Date cutTime DateUtil currentGMTTime final List ManagementServerHostVO peers _mshostDao getActiveList new Date cutTime getTime HeartbeatThreshold value for final ManagementServerHostVO peer peers final String peerIP peer getServiceIP trim if _clusterNodeIP equals peerIP if equals _clusterNodeIP if pingManagementNode peer getMsid final String msg
final List ManagementServerHostVO peers _mshostDao getActiveList new Date cutTime getTime HeartbeatThreshold value for final ManagementServerHostVO peer peers final String peerIP peer getServiceIP trim if _clusterNodeIP equals peerIP if equals _clusterNodeIP if pingManagementNode peer getMsid final String msg s_logger error msg throw new ConfigurationException msg else final String msg s_logger info msg else if pingManagementNode peer getMsid final String msg peer getServiceIP
if equals _clusterNodeIP if pingManagementNode peer getMsid final String msg s_logger error msg throw new ConfigurationException msg else final String msg s_logger info msg else if pingManagementNode peer getMsid final String msg peer getServiceIP s_logger error msg throw new ConfigurationException msg else final String msg peer getServiceIP
Override public void handle HttpRequest request HttpResponse response HttpContext context throws HttpException IOException try if s_logger isTraceEnabled s_logger trace parseRequest request handleRequest request response if s_logger isTraceEnabled s_logger trace catch final Throwable e if s_logger isDebugEnabled s_logger debug e toString try writeResponse response HttpStatus SC_INTERNAL_SERVER_ERROR null catch final Throwable e2 if s_logger isDebugEnabled
private String handlePingMethodCall HttpRequest req final String callingPeer String req getParams getParameter if s_logger isDebugEnabled
private String executePostMethod final HttpClient client final PostMethod method int response String result null try final Profiler profiler new Profiler profiler start response client executeMethod method if response HttpStatus SC_OK result method getResponseBodyAsString profiler stop if s_logger isDebugEnabled
int response String result null try final Profiler profiler new Profiler profiler start response client executeMethod method if response HttpStatus SC_OK result method getResponseBodyAsString profiler stop if s_logger isDebugEnabled s_logger debug _serviceUrl result profiler getDurationInMillis else profiler stop s_logger error response _serviceUrl method getParameter profiler getDurationInMillis catch final HttpException e
try final Profiler profiler new Profiler profiler start response client executeMethod method if response HttpStatus SC_OK result method getResponseBodyAsString profiler stop if s_logger isDebugEnabled s_logger debug _serviceUrl result profiler getDurationInMillis else profiler stop s_logger error response _serviceUrl method getParameter profiler getDurationInMillis catch final HttpException e s_logger error _serviceUrl method getParameter catch final IOException e
profiler start response client executeMethod method if response HttpStatus SC_OK result method getResponseBodyAsString profiler stop if s_logger isDebugEnabled s_logger debug _serviceUrl result profiler getDurationInMillis else profiler stop s_logger error response _serviceUrl method getParameter profiler getDurationInMillis catch final HttpException e s_logger error _serviceUrl method getParameter catch final IOException e s_logger error _serviceUrl method getParameter catch final Throwable e
Override DB public void update long id long runid Date lastUpdate TransactionLegacy txn TransactionLegacy currentTxn PreparedStatement pstmt null try txn start pstmt txn prepareAutoCloseStatement pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone lastUpdate pstmt setLong id pstmt setLong runid int count pstmt executeUpdate txn commit if count
Override public void update long id long runId State state Date lastUpdate TransactionLegacy txn TransactionLegacy currentTxn PreparedStatement pstmt null try pstmt txn prepareAutoCloseStatement pstmt setString state toString pstmt setString DateUtil getDateDisplayString TimeZone getTimeZone lastUpdate pstmt setLong id pstmt setLong runId int count pstmt executeUpdate if count
public static Connection getConnectionForGlobalLocks String name boolean forLock synchronized s_connectionForGlobalLocks if forLock if s_connectionForGlobalLocks get name null
public static boolean getGlobalLock String name int timeoutSeconds Connection conn getConnectionForGlobalLocks name true if conn null s_logger error return false try PreparedStatement pstmt conn prepareStatement pstmt setString name pstmt setInt timeoutSeconds try ResultSet rs pstmt executeQuery if rs null rs first if rs getInt return true else if s_logger isDebugEnabled s_logger debug name catch SQLException e
if conn null s_logger error return false try PreparedStatement pstmt conn prepareStatement pstmt setString name pstmt setInt timeoutSeconds try ResultSet rs pstmt executeQuery if rs null rs first if rs getInt return true else if s_logger isDebugEnabled s_logger debug name catch SQLException e s_logger error e catch Throwable e
public static boolean releaseGlobalLock String name try Connection conn getConnectionForGlobalLocks name false if conn null s_logger error assert false return false try PreparedStatement pstmt conn prepareStatement pstmt setString name try ResultSet rs pstmt executeQuery if rs null rs first return rs getInt s_logger error catch SQLException e s_logger error e catch Throwable e
public static void loadDriver String dbDriver String driverClass DRIVERS get dbDriver if driverClass null
public static void loadDriver String dbDriver String driverClass DRIVERS get dbDriver if driverClass null LOGGER error dbDriver throw new CloudRuntimeException dbDriver if LOADED_DRIVERS contains dbDriver if LOGGER isDebugEnabled LOGGER debug driverClass return try Class forName driverClass newInstance LOADED_DRIVERS add dbDriver if LOGGER isDebugEnabled LOGGER debug driverClass catch ClassNotFoundException InstantiationException IllegalAccessException e
DB protected void createCache final Map String extends Object params final String value String params get if value null final CacheManager cm CacheManager create final int maxElements NumbersUtil parseInt value final int live NumbersUtil parseInt String params get final int idle NumbersUtil parseInt String params get _cache new Cache getName maxElements false live live Integer MAX_VALUE live idle cm addCache _cache
public static T T executeWithLock final String operationId final int lockAcquisitionTimeout final Callable T operation throws Exception final GlobalLock lock GlobalLock getInternLock operationId try if lock lock lockAcquisitionTimeout if s_logger isDebugEnabled
if s_logger isTraceEnabled s_logger trace key timeInSeconds long startTime InaccurateClock getTime while InaccurateClock getTime startTime timeInSeconds 1000l int count owns key if count return increment key threadName threadId else if count if doAcquire key threadName threadId return true try if s_logger isTraceEnabled s_logger trace key Thread sleep catch InterruptedException e
pstmt setLong _msId pstmt setString threadName pstmt setInt threadId pstmt setString DateUtil getDateDisplayString _gmtTimeZone new Date try int rows pstmt executeUpdate if rows if s_logger isTraceEnabled s_logger trace key incrCount return true catch SQLException e if e getSQLState equals e getErrorCode throw new CloudRuntimeException key InaccurateClock getTime startTime e catch SQLException e
Override public void cleanupForServer long msId
Override public void cleanupForServer long msId s_logger info msId try synchronized _concierge conn try PreparedStatement pstmt _concierge conn prepareStatement CLEANUP_MGMT_LOCKS_SQL pstmt setLong msId int rows pstmt executeUpdate
Override public boolean releaseLockAsLastResortAndIReallyKnowWhatIAmDoing String key
private void printlnError Object o
private void flush if _logBuffer length
s_logger warn e else if item type STATEMENT try if s_stmtLogger isTraceEnabled s_stmtLogger trace ref toString Statement stmt Statement ref try ResultSet rs stmt getResultSet if rs null rs close catch SQLException e s_stmtLogger trace stmt close catch final SQLException e s_stmtLogger trace item
SuppressWarnings public static void initDataSource Properties dbProps try if dbProps size return s_dbHAEnabled Boolean valueOf dbProps getProperty
else if cloudIsolationLevel equalsIgnoreCase isolationLevel Connection TRANSACTION_SERIALIZABLE else if cloudIsolationLevel equalsIgnoreCase isolationLevel Connection TRANSACTION_READ_UNCOMMITTED else s_logger warn cloudIsolationLevel final boolean cloudTestOnBorrow Boolean parseBoolean dbProps getProperty final boolean cloudTestWhileIdle Boolean parseBoolean dbProps getProperty final long cloudTimeBtwEvictionRunsMillis Long parseLong dbProps getProperty final long cloudMinEvcitableIdleTimeMillis Long parseLong dbProps getProperty final boolean cloudPoolPreparedStatements Boolean parseBoolean dbProps getProperty final String url dbProps getProperty String cloudDbHAParams null String cloudSlaves null if s_dbHAEnabled
Override public void publish String senderAddress String subject PublishScope scope Object args if noDbTxn String errMsg
String path packageName replace try Enumeration URL resources loader getResources path if resources null while resources hasMoreElements String filePath resources nextElement getFile if filePath null if filePath indexOf filePath filePath replace if filePath indexOf filePath indexOf String jarPath filePath substring filePath indexOf substring filePath indexOf if jarPath indexOf jarPath jarPath substring classes addAll getFromJARFile jarPath path else classes addAll getFromDirectory new File filePath packageName catch IOException e
Enumeration URL resources loader getResources path if resources null while resources hasMoreElements String filePath resources nextElement getFile if filePath null if filePath indexOf filePath filePath replace if filePath indexOf filePath indexOf String jarPath filePath substring filePath indexOf substring filePath indexOf if jarPath indexOf jarPath jarPath substring classes addAll getFromJARFile jarPath path else classes addAll getFromDirectory new File filePath packageName catch IOException e s_logger debug e catch ClassNotFoundException e
void testRpc SampleStoragePrepareCommand cmd new SampleStoragePrepareCommand cmd setStoragePool cmd setVolumeId _rpcProvider newCall setCommand setCommandArg cmd setTimeout addCallbackListener new RpcCallbackListener SampleStoragePrepareAnswer Override public void onSuccess SampleStoragePrepareAnswer result
RpcServiceHandler command void onStartCommand RpcServerCall call s_logger info SampleStoragePrepareCommand cmd call getCommandArgument
public void log Logger logger String journalText s_jobMgr logJobJournal _job getId AsyncJob JournalType SUCCESS journalText null
public void disjoinJob long joinedJobId throws InsufficientCapacityException ConcurrentOperationException ResourceUnavailableException assert _job null AsyncJobJoinMapVO record s_joinMapDao getJoinRecord _job getId joinedJobId s_jobMgr disjoinJob _job getId joinedJobId if record getJoinStatus JobInfo Status FAILED if record getJoinResult null Object exception JobSerializerHelper fromObjectSerializedString record getJoinResult if exception null exception Exception if exception InsufficientCapacityException
public void disjoinJob long joinedJobId throws InsufficientCapacityException ConcurrentOperationException ResourceUnavailableException assert _job null AsyncJobJoinMapVO record s_joinMapDao getJoinRecord _job getId joinedJobId s_jobMgr disjoinJob _job getId joinedJobId if record getJoinStatus JobInfo Status FAILED if record getJoinResult null Object exception JobSerializerHelper fromObjectSerializedString record getJoinResult if exception null exception Exception if exception InsufficientCapacityException s_logger error joinedJobId throw InsufficientCapacityException exception else if exception ConcurrentOperationException s_logger error joinedJobId throw ConcurrentOperationException exception else if exception ResourceUnavailableException
s_jobMgr disjoinJob _job getId joinedJobId if record getJoinStatus JobInfo Status FAILED if record getJoinResult null Object exception JobSerializerHelper fromObjectSerializedString record getJoinResult if exception null exception Exception if exception InsufficientCapacityException s_logger error joinedJobId throw InsufficientCapacityException exception else if exception ConcurrentOperationException s_logger error joinedJobId throw ConcurrentOperationException exception else if exception ResourceUnavailableException s_logger error joinedJobId throw ResourceUnavailableException exception else
Object exception JobSerializerHelper fromObjectSerializedString record getJoinResult if exception null exception Exception if exception InsufficientCapacityException s_logger error joinedJobId throw InsufficientCapacityException exception else if exception ConcurrentOperationException s_logger error joinedJobId throw ConcurrentOperationException exception else if exception ResourceUnavailableException s_logger error joinedJobId throw ResourceUnavailableException exception else s_logger error joinedJobId throw new RuntimeException Exception exception else
TransactionLegacy txn TransactionLegacy currentTxn PreparedStatement pstmt null try pstmt txn prepareAutoCloseStatement sql pstmt setInt maxItems ResultSet rs pstmt executeQuery while rs next SyncQueueItemVO item new SyncQueueItemVO item setId rs getLong item setQueueId rs getLong item setContentType rs getString item setContentId rs getLong item setCreated DateUtil parseDateString TimeZone getTimeZone rs getString l add item catch SQLException e
try pstmt txn prepareAutoCloseStatement sql pstmt setInt maxItems ResultSet rs pstmt executeQuery while rs next SyncQueueItemVO item new SyncQueueItemVO item setId rs getLong item setQueueId rs getLong item setContentType rs getString item setContentId rs getLong item setCreated DateUtil parseDateString TimeZone getTimeZone rs getString l add item catch SQLException e s_logger error e catch Throwable e
Override public void expungeLeftoverWorkJobs final long msid Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status TransactionLegacy txn TransactionLegacy currentTxn try PreparedStatement pstmt txn prepareAutoCloseStatement pstmt setLong msid pstmt execute catch SQLException e s_logger info e getLocalizedMessage catch Throwable e s_logger info e getLocalizedMessage try PreparedStatement pstmt txn prepareAutoCloseStatement pstmt setLong msid pstmt execute catch SQLException e
Override public void doInTransactionWithoutResult TransactionStatus status TransactionLegacy txn TransactionLegacy currentTxn try PreparedStatement pstmt txn prepareAutoCloseStatement pstmt setLong msid pstmt execute catch SQLException e s_logger info e getLocalizedMessage catch Throwable e s_logger info e getLocalizedMessage try PreparedStatement pstmt txn prepareAutoCloseStatement pstmt setLong msid pstmt execute catch SQLException e s_logger info e getLocalizedMessage catch Throwable e
SuppressWarnings DB public long submitAsyncJob AsyncJob job boolean scheduleJobExecutionInContext SuppressWarnings GenericDao dao GenericDaoBase getDao job getClass job setInitMsid getMsid job setSyncSource null dao persist job publishOnEventBus job scheduleExecution job scheduleJobExecutionInContext if s_logger isDebugEnabled
Override DB public void completeAsyncJob final long jobId final Status jobStatus final int resultCode final String resultObject if s_logger isDebugEnabled String resultObj obfuscatePassword resultObject HidePassword value resultObj convertHumanReadableJson resultObj
s_logger debug jobId jobStatus resultCode resultObj final AsyncJobVO job _jobDao findById jobId if job null if s_logger isDebugEnabled s_logger debug jobId jobStatus resultCode resultObject _queueMgr purgeAsyncJobQueueItemId jobId return if job getStatus JobInfo Status IN_PROGRESS if s_logger isDebugEnabled s_logger debug jobId _queueMgr purgeAsyncJobQueueItemId jobId return if resultObject null job setResult resultObject if s_logger isDebugEnabled
final AsyncJobVO job _jobDao findById jobId if job null if s_logger isDebugEnabled s_logger debug jobId jobStatus resultCode resultObject _queueMgr purgeAsyncJobQueueItemId jobId return if job getStatus JobInfo Status IN_PROGRESS if s_logger isDebugEnabled s_logger debug jobId _queueMgr purgeAsyncJobQueueItemId jobId return if resultObject null job setResult resultObject if s_logger isDebugEnabled s_logger debug jobId
_queueMgr purgeAsyncJobQueueItemId jobId return if job getStatus JobInfo Status IN_PROGRESS if s_logger isDebugEnabled s_logger debug jobId _queueMgr purgeAsyncJobQueueItemId jobId return if resultObject null job setResult resultObject if s_logger isDebugEnabled s_logger debug jobId if s_logger isDebugEnabled s_logger debug jobId final List Long wakeupList Transaction execute new TransactionCallback List Long Override public List Long doInTransaction final TransactionStatus status
if s_logger isDebugEnabled s_logger debug jobId if s_logger isDebugEnabled s_logger debug jobId final List Long wakeupList Transaction execute new TransactionCallback List Long Override public List Long doInTransaction final TransactionStatus status if s_logger isDebugEnabled s_logger debug jobId job setCompleteMsid getMsid job setStatus jobStatus job setResultCode resultCode if resultObject null job setResult resultObject else job setResult null
Override DB public void updateAsyncJobStatus final long jobId final int processStatus final String resultObject if s_logger isDebugEnabled
Override DB public void updateAsyncJobAttachment final long jobId final String instanceType final Long instanceId if s_logger isDebugEnabled
Override public void syncAsyncJobExecution AsyncJob job String syncObjType long syncObjId long queueSizeLimit if s_logger isDebugEnabled
finally NDC pop Override protected void runInContext long runNumber getJobRunNumber try try JmxUtil registerMBean job getId new AsyncJobMBeanImpl job catch Exception e if s_logger isTraceEnabled s_logger trace job getId ExceptionUtil toString e _jobMonitor registerActiveTask runNumber job getId AsyncJobExecutionContext setCurrentExecutionContext new AsyncJobExecutionContext job String related job getRelated String logContext job getShortUuid if related null related isEmpty AsyncJob relatedJob _jobDao findByIdIncludingRemoved Long parseLong related
String related job getRelated String logContext job getShortUuid if related null related isEmpty AsyncJob relatedJob _jobDao findByIdIncludingRemoved Long parseLong related if relatedJob null logContext relatedJob getShortUuid MDC put logContext if s_logger isDebugEnabled s_logger debug StringUtils cleanString job toString if getAndResetPendingSignals job AsyncJob Constants SIGNAL_MASK_WAKEUP AsyncJobDispatcher jobDispatcher findWakeupDispatcher job if jobDispatcher null jobDispatcher runJob job else if s_logger isTraceEnabled s_logger trace job
jobDispatcher runJob job else if s_logger isTraceEnabled s_logger trace job else AsyncJobDispatcher jobDispatcher getDispatcher job getDispatcher if jobDispatcher null jobDispatcher runJob job else s_logger error completeAsyncJob job getId JobInfo Status FAILED ApiErrorCode INTERNAL_ERROR getHttpCode null if s_logger isDebugEnabled s_logger debug job getCmd job getId catch Throwable e s_logger error e completeAsyncJob job getId JobInfo Status FAILED ApiErrorCode INTERNAL_ERROR getHttpCode null
private void executeQueueItem SyncQueueItemVO item boolean fromPreviousSession AsyncJobVO job _jobDao findById item getContentId if job null if s_logger isDebugEnabled
try job setExecutingMsid getMsid _jobDao update job getId job catch Exception e s_logger warn item getContentId e try _queueMgr returnItem item getId catch Throwable thr s_logger error item getContentId thr try scheduleExecution job catch RejectedExecutionException e s_logger warn job getId try _queueMgr returnItem item getId
catch Throwable thr s_logger error item getContentId thr try scheduleExecution job catch RejectedExecutionException e s_logger warn job getId try _queueMgr returnItem item getId catch Exception e2 s_logger error item getContentId e2 try job setExecutingMsid null _jobDao update job getId job catch Exception e3 s_logger warn item getContentId
private void checkQueue long queueId while true try SyncQueueItemVO item _queueMgr dequeueFromOne queueId getMsid if item null if s_logger isDebugEnabled
GlobalLock scanLock GlobalLock getInternLock try if scanLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_COOPERATION try reallyRun finally scanLock unlock finally scanLock releaseRef protected void reallyRun try List SyncQueueItemVO l _queueMgr dequeueFromAny getMsid MAX_ONETIME_SCHEDULE_SIZE if l null l size for SyncQueueItemVO item l if s_logger isDebugEnabled
if scanLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_COOPERATION try reallyRun finally scanLock unlock finally scanLock releaseRef public void reallyRun try s_logger trace List SyncQueueItemVO blockItems _queueMgr getBlockedQueueItems JobCancelThresholdMinutes value false if blockItems null blockItems size for SyncQueueItemVO item blockItems try if item getContentType equalsIgnoreCase SyncQueueItem AsyncJobContentType
try s_logger trace List SyncQueueItemVO blockItems _queueMgr getBlockedQueueItems JobCancelThresholdMinutes value false if blockItems null blockItems size for SyncQueueItemVO item blockItems try if item getContentType equalsIgnoreCase SyncQueueItem AsyncJobContentType s_logger info item getContentId item getId completeAsyncJob item getContentId JobInfo Status FAILED _jobMonitor unregisterByJobId item getContentId _queueMgr purgeItem item getId catch Throwable e s_logger error e Date cutTime new Date DateUtil currentGMTTime getTime JobExpireMinutes value List AsyncJobVO unfinishedJobs _jobDao getExpiredUnfinishedJobs cutTime
for SyncQueueItemVO item blockItems try if item getContentType equalsIgnoreCase SyncQueueItem AsyncJobContentType s_logger info item getContentId item getId completeAsyncJob item getContentId JobInfo Status FAILED _jobMonitor unregisterByJobId item getContentId _queueMgr purgeItem item getId catch Throwable e s_logger error e Date cutTime new Date DateUtil currentGMTTime getTime JobExpireMinutes value List AsyncJobVO unfinishedJobs _jobDao getExpiredUnfinishedJobs cutTime for AsyncJobVO job unfinishedJobs try s_logger info job getId _jobMonitor unregisterByJobId job getId
s_logger info item getContentId item getId completeAsyncJob item getContentId JobInfo Status FAILED _jobMonitor unregisterByJobId item getContentId _queueMgr purgeItem item getId catch Throwable e s_logger error e Date cutTime new Date DateUtil currentGMTTime getTime JobExpireMinutes value List AsyncJobVO unfinishedJobs _jobDao getExpiredUnfinishedJobs cutTime for AsyncJobVO job unfinishedJobs try s_logger info job getId _jobMonitor unregisterByJobId job getId expungeAsyncJob job catch Throwable e s_logger error job getId e
_queueMgr purgeItem item getId catch Throwable e s_logger error e Date cutTime new Date DateUtil currentGMTTime getTime JobExpireMinutes value List AsyncJobVO unfinishedJobs _jobDao getExpiredUnfinishedJobs cutTime for AsyncJobVO job unfinishedJobs try s_logger info job getId _jobMonitor unregisterByJobId job getId expungeAsyncJob job catch Throwable e s_logger error job getId e List AsyncJobVO completedJobs _jobDao getExpiredCompletedJobs cutTime for AsyncJobVO job completedJobs try
Override public boolean configure String name Map String Object params throws ConfigurationException try final Properties dbProps DbProperties getDbProperties final int cloudMaxActive Integer parseInt dbProps getProperty int apiPoolSize cloudMaxActive int workPoolSize cloudMaxActive
Override public boolean configure String name Map String Object params throws ConfigurationException try final Properties dbProps DbProperties getDbProperties final int cloudMaxActive Integer parseInt dbProps getProperty int apiPoolSize cloudMaxActive int workPoolSize cloudMaxActive s_logger info apiPoolSize _apiJobExecutor Executors newFixedThreadPool apiPoolSize new NamedThreadFactory AsyncJobManager API_JOB_POOL_THREAD_PREFIX
private void cleanupLeftOverJobs final long msid try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status _queueMgr cleanupActiveQueueItems msid true final List AsyncJobVO jobs _jobDao getResetJobs msid for final AsyncJobVO job jobs if s_logger isDebugEnabled
Override public void doInTransactionWithoutResult TransactionStatus status _queueMgr cleanupActiveQueueItems msid true final List AsyncJobVO jobs _jobDao getResetJobs msid for final AsyncJobVO job jobs if s_logger isDebugEnabled s_logger debug job getId job setStatus JobInfo Status FAILED job setResultCode ApiErrorCode INTERNAL_ERROR getHttpCode job setResult job setCompleteMsid msid final Date currentGMTTime DateUtil currentGMTTime job setLastUpdated currentGMTTime job setRemoved currentGMTTime _jobDao update job getId job if s_logger isDebugEnabled
public void registerActiveTask long runNumber long jobId synchronized this
public void unregisterActiveTask long runNumber synchronized this ActiveTaskRecord record _activeTasks get runNumber assert record null if record null
_syncQueueDao ensureQueue syncObjType syncObjId SyncQueueVO queueVO _syncQueueDao find syncObjType syncObjId if queueVO null throw new CloudRuntimeException queueVO setQueueSizeLimit queueSizeLimit _syncQueueDao update queueVO getId queueVO Date dt DateUtil currentGMTTime SyncQueueItemVO item new SyncQueueItemVO item setQueueId queueVO getId item setContentType itemType item setContentId itemId item setCreated dt _syncQueueItemDao persist item return queueVO catch Exception e
Override DB public SyncQueueItemVO dequeueFromOne final long queueId final Long msid try return Transaction execute new TransactionCallback SyncQueueItemVO Override public SyncQueueItemVO doInTransaction TransactionStatus status SyncQueueVO queueVO _syncQueueDao findById queueId if queueVO null
if processNumber null processNumber new Long else processNumber processNumber Date dt DateUtil currentGMTTime queueVO setLastProcessNumber processNumber queueVO setLastUpdated dt queueVO setQueueSize queueVO getQueueSize _syncQueueDao update queueVO getId queueVO itemVO setLastProcessMsid msid itemVO setLastProcessNumber processNumber itemVO setLastProcessTime dt _syncQueueItemDao update item getId itemVO resultList add itemVO return resultList catch Exception e
Override DB public void returnItem final long queueItemId
try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status SyncQueueItemVO itemVO _syncQueueItemDao findById queueItemId if itemVO null SyncQueueVO queueVO _syncQueueDao findById itemVO getQueueId itemVO setLastProcessMsid null itemVO setLastProcessNumber null itemVO setLastProcessTime null _syncQueueItemDao update queueItemId itemVO queueVO setQueueSize queueVO getQueueSize queueVO setLastUpdated DateUtil currentGMTTime _syncQueueDao update queueVO getId queueVO catch Exception e
Override public void cleanupActiveQueueItems Long msid boolean exclusive List SyncQueueItemVO l getActiveQueueItems msid false for SyncQueueItemVO item l if s_logger isInfoEnabled
Override public void runJob final AsyncJob job _testDashboard increaseConcurrency
log error listener t invocations push new ListenerInvocation ManagedContextListener Object listener data try if firstError null return callable call else throwException firstError return null finally Throwable lastError null while invocations isEmpty ListenerInvocation invocation invocations pop try invocation listener onLeaveContext invocation data reentry catch Throwable t
private static void validateInContext Object tl if s_validateContext ManagedContextUtils isInContext String msg tl
Override public void checkAndSendQuotaAlertEmails List DeferredQuotaEmail deferredQuotaEmailList new ArrayList DeferredQuotaEmail final BigDecimal zeroBalance new BigDecimal for final QuotaAccountVO quotaAccount _quotaAcc listAllQuotaAccount if s_logger isDebugEnabled
List DeferredQuotaEmail deferredQuotaEmailList new ArrayList DeferredQuotaEmail final BigDecimal zeroBalance new BigDecimal for final QuotaAccountVO quotaAccount _quotaAcc listAllQuotaAccount if s_logger isDebugEnabled s_logger debug quotaAccount getId BigDecimal accountBalance quotaAccount getQuotaBalance Date balanceDate quotaAccount getQuotaBalanceDate Date alertDate quotaAccount getQuotaAlertDate int lockable quotaAccount getQuotaEnforce BigDecimal thresholdBalance quotaAccount getQuotaMinBalance if accountBalance null AccountVO account _accountDao findById quotaAccount getId if account null continue if s_logger isDebugEnabled
s_logger debug quotaAccount getId BigDecimal accountBalance quotaAccount getQuotaBalance Date balanceDate quotaAccount getQuotaBalanceDate Date alertDate quotaAccount getQuotaAlertDate int lockable quotaAccount getQuotaEnforce BigDecimal thresholdBalance quotaAccount getQuotaMinBalance if accountBalance null AccountVO account _accountDao findById quotaAccount getId if account null continue if s_logger isDebugEnabled s_logger debug account getId accountBalance alertDate lockable if accountBalance compareTo zeroBalance if _lockAccountEnforcement lockable if _quotaManager isLockable account
Date balanceDate quotaAccount getQuotaBalanceDate Date alertDate quotaAccount getQuotaAlertDate int lockable quotaAccount getQuotaEnforce BigDecimal thresholdBalance quotaAccount getQuotaMinBalance if accountBalance null AccountVO account _accountDao findById quotaAccount getId if account null continue if s_logger isDebugEnabled s_logger debug account getId accountBalance alertDate lockable if accountBalance compareTo zeroBalance if _lockAccountEnforcement lockable if _quotaManager isLockable account s_logger info account getAccountName lockAccount account getId
if accountBalance null AccountVO account _accountDao findById quotaAccount getId if account null continue if s_logger isDebugEnabled s_logger debug account getId accountBalance alertDate lockable if accountBalance compareTo zeroBalance if _lockAccountEnforcement lockable if _quotaManager isLockable account s_logger info account getAccountName lockAccount account getId if alertDate null balanceDate after alertDate getDifferenceDays alertDate new Date s_logger info account getAccountName deferredQuotaEmailList add new DeferredQuotaEmail account quotaAccount QuotaConfig QuotaEmailTemplateTypes QUOTA_EMPTY else if accountBalance compareTo thresholdBalance
for UserVO user usersInAccount userNames String format user getUsername user getEmail emailRecipients add user getEmail if userNames endsWith userNames userNames substring userNames length final Map String String optionMap new HashMap String String optionMap put account getAccountName optionMap put account getUuid optionMap put userNames optionMap put accountDomain getName optionMap put accountDomain getUuid optionMap put QuotaConfig QuotaCurrencySymbol value balance toString if emailType QuotaEmailTemplateTypes QUOTA_STATEMENT optionMap put QuotaConfig QuotaCurrencySymbol value usage toString if s_logger isDebugEnabled
optionMap put account getAccountName optionMap put account getUuid optionMap put userNames optionMap put accountDomain getName optionMap put accountDomain getUuid optionMap put QuotaConfig QuotaCurrencySymbol value balance toString if emailType QuotaEmailTemplateTypes QUOTA_STATEMENT optionMap put QuotaConfig QuotaCurrencySymbol value usage toString if s_logger isDebugEnabled s_logger debug account getAccountName account getUuid userNames accountDomain getName accountDomain getUuid final StrSubstitutor templateEngine new StrSubstitutor optionMap final String subject templateEngine replace emailTemplate getTemplateSubject final String body templateEngine replace emailTemplate getTemplateBody try _emailQuotaAlert sendQuotaAlert emailRecipients subject body
optionMap put userNames optionMap put accountDomain getName optionMap put accountDomain getUuid optionMap put QuotaConfig QuotaCurrencySymbol value balance toString if emailType QuotaEmailTemplateTypes QUOTA_STATEMENT optionMap put QuotaConfig QuotaCurrencySymbol value usage toString if s_logger isDebugEnabled s_logger debug account getAccountName account getUuid userNames accountDomain getName accountDomain getUuid final StrSubstitutor templateEngine new StrSubstitutor optionMap final String subject templateEngine replace emailTemplate getTemplateSubject final String body templateEngine replace emailTemplate getTemplateBody try _emailQuotaAlert sendQuotaAlert emailRecipients subject body emailToBeSent sentSuccessfully _quotaAcc catch Exception e
optionMap put accountDomain getUuid optionMap put QuotaConfig QuotaCurrencySymbol value balance toString if emailType QuotaEmailTemplateTypes QUOTA_STATEMENT optionMap put QuotaConfig QuotaCurrencySymbol value usage toString if s_logger isDebugEnabled s_logger debug account getAccountName account getUuid userNames accountDomain getName accountDomain getUuid final StrSubstitutor templateEngine new StrSubstitutor optionMap final String subject templateEngine replace emailTemplate getTemplateSubject final String body templateEngine replace emailTemplate getTemplateBody try _emailQuotaAlert sendQuotaAlert emailRecipients subject body emailToBeSent sentSuccessfully _quotaAcc catch Exception e s_logger error String format subject body account getAccountName account getUuid emailRecipients e if s_logger isDebugEnabled
try TransactionLegacy txn TransactionLegacy open TransactionLegacy CLOUD_DB Account account _accountDao findById accountId if account null if account getState State locked return true else if account getState State enabled AccountVO acctForUpdate _accountDao createForUpdate acctForUpdate setState State locked success _accountDao update Long valueOf accountId acctForUpdate else if s_logger isInfoEnabled s_logger info account getState accountId else s_logger warn accountId catch Exception e
Date endDate quotaListForAccount get getEndDate if s_logger isDebugEnabled s_logger debug startDate endDate s_logger debug quotaListForAccount get quotaListForAccount size getStartDate quotaListForAccount get quotaListForAccount size getEndDate quotaListForAccount add new QuotaUsageVO BigDecimal aggrUsage new BigDecimal List QuotaBalanceVO creditsReceived null QuotaUsageVO lastQuotaUsage _quotaUsageDao findLastQuotaUsageEntry account getAccountId account getDomainId startDate if lastQuotaUsage null aggrUsage aggrUsage add aggregateCreditBetweenDates account new Date startDate QuotaBalanceVO firstBalance new QuotaBalanceVO account getAccountId account getDomainId aggrUsage startDate _quotaBalanceDao saveQuotaBalance firstBalance else QuotaBalanceVO lastRealBalanceEntry _quotaBalanceDao findLastBalanceEntry account getAccountId account getDomainId endDate if lastRealBalanceEntry null
if s_logger isDebugEnabled s_logger debug lastRealBalanceEntry aggrUsage aggrUsage aggrUsage add aggregateCreditBetweenDates account lastRealBalanceEntry getUpdatedOn endDate for QuotaUsageVO entry quotaListForAccount if s_logger isDebugEnabled s_logger debug entry if entry getQuotaUsed compareTo BigDecimal ZERO aggrUsage aggrUsage add aggregateCreditBetweenDates account entry getStartDate entry getEndDate continue if startDate compareTo entry getStartDate saveQuotaBalance account aggrUsage endDate aggrUsage new BigDecimal startDate entry getStartDate endDate entry getEndDate QuotaBalanceVO lastRealBalanceEntry _quotaBalanceDao findLastBalanceEntry account getAccountId account getDomainId endDate
private QuotaBalanceVO saveQuotaBalance final AccountVO account final BigDecimal aggrUsage final Date endDate QuotaBalanceVO newBalance new QuotaBalanceVO account getAccountId account getDomainId aggrUsage endDate if s_logger isDebugEnabled
private boolean saveQuotaAccount final AccountVO account final BigDecimal aggrUsage final Date endDate QuotaAccountVO quota_account _quotaAcc findByIdQuotaAccount account getAccountId if quota_account null quota_account new QuotaAccountVO account getAccountId quota_account setQuotaBalance aggrUsage quota_account setQuotaBalanceDate endDate if s_logger isDebugEnabled
private BigDecimal aggregateCreditBetweenDates final AccountVO account final Date startDate final Date endDate BigDecimal aggrUsage new BigDecimal List QuotaBalanceVO creditsReceived null creditsReceived _quotaBalanceDao findCreditBalance account getAccountId account getDomainId startDate endDate if s_logger isDebugEnabled
Override public boolean calculateQuotaUsage List AccountVO accounts _accountDao listAll for AccountVO account accounts Pair List extends UsageVO Integer usageRecords _usageDao getUsageRecordsPendingQuotaAggregation account getAccountId account getDomainId if s_logger isDebugEnabled
List DeferredQuotaEmail deferredQuotaEmailList new ArrayList DeferredQuotaEmail for final QuotaAccountVO quotaAccount _quotaAcc listAllQuotaAccount if quotaAccount getQuotaBalance null continue Calendar interval statementTime Calendar getInstance _period Date lastStatementDate quotaAccount getLastStatementDate if interval null AccountVO account _accountDao findById quotaAccount getId if account null if lastStatementDate null getDifferenceDays lastStatementDate new Date s_LAST_STATEMENT_SENT_DAYS BigDecimal quotaUsage _quotaUsage findTotalQuotaUsage account getAccountId account getDomainId null interval getTime interval getTime s_logger info quotaAccount getId quotaUsage deferredQuotaEmailList add new DeferredQuotaEmail account quotaAccount quotaUsage QuotaConfig QuotaEmailTemplateTypes QUOTA_STATEMENT else if s_logger isDebugEnabled
if quotaAccount getQuotaBalance null continue Calendar interval statementTime Calendar getInstance _period Date lastStatementDate quotaAccount getLastStatementDate if interval null AccountVO account _accountDao findById quotaAccount getId if account null if lastStatementDate null getDifferenceDays lastStatementDate new Date s_LAST_STATEMENT_SENT_DAYS BigDecimal quotaUsage _quotaUsage findTotalQuotaUsage account getAccountId account getDomainId null interval getTime interval getTime s_logger info quotaAccount getId quotaUsage deferredQuotaEmailList add new DeferredQuotaEmail account quotaAccount quotaUsage QuotaConfig QuotaEmailTemplateTypes QUOTA_STATEMENT else if s_logger isDebugEnabled s_logger debug quotaAccount getId else if lastStatementDate null
return Transaction execute TransactionLegacy USAGE_DB new TransactionCallback List QuotaBalanceVO Override public List QuotaBalanceVO doInTransaction final TransactionStatus status List QuotaBalanceVO quotaUsageRecords null List QuotaBalanceVO trimmedRecords new ArrayList QuotaBalanceVO Filter filter new Filter QuotaBalanceVO class false 0L 100L QueryBuilder QuotaBalanceVO qb QueryBuilder create QuotaBalanceVO class if accountId null qb and qb entity getAccountId SearchCriteria Op EQ accountId if domainId null qb and qb entity getDomainId SearchCriteria Op EQ domainId if pivotDate null qb and qb entity getUpdatedOn SearchCriteria Op LTEQ pivotDate quotaUsageRecords search qb create filter for QuotaBalanceVO entry quotaUsageRecords if s_logger isDebugEnabled
Override public Pair List QuotaTariffVO Integer listAllTariffPlans final Date effectiveDate final Long startIndex final Long pageSize return Transaction execute TransactionLegacy USAGE_DB new TransactionCallback Pair List QuotaTariffVO Integer Override public Pair List QuotaTariffVO Integer doInTransaction final TransactionStatus status List QuotaTariffVO tariffs new ArrayList QuotaTariffVO final Filter filter new Filter QuotaTariffVO class false 0L 1L final SearchCriteria QuotaTariffVO sc listAllIncludedUsageType create sc setParameters effectiveDate for Integer quotaType QuotaTypes listQuotaTypes keySet sc setParameters quotaType List QuotaTariffVO result search sc filter if result null result isEmpty tariffs add result get if s_logger isDebugEnabled
Override public boolean validateCertificate String certificate String key String domainSuffix if Strings isNullOrEmpty certificate Strings isNullOrEmpty key Strings isNullOrEmpty domainSuffix
protected void checkIntegrity for SystemIntegrityChecker checker getBeans SystemIntegrityChecker class
public void stopBeans with new WithComponentLifeCycle Override public void with ComponentLifecycle lifecycle
String name RegistryUtils getName item if name null exclude size exclude contains name return false if name null order length throw new RuntimeException item int i for String orderTest order if orderTest equals name registered add i item i break if registered size i break if RegistryUtils getName registered get i equals orderTest i
Override public void start Iterator Object iter beans iterator Registry Object registry lookupRegistry while iter hasNext Object next iter next if registry register next
protected void startContexts withModule new WithModule Override public void with ModuleDefinition def Stack ModuleDefinition parents try ApplicationContext context getApplicationContext def getName try Runnable runnable context getBean Runnable class
protected ApplicationContext loadContext ModuleDefinition def ApplicationContext parent ResourceApplicationContext context new ResourceApplicationContext context setApplicationName def getName Resource resources getConfigResources def getName context setConfigResources resources context setParent parent context setClassLoader def getClassLoader long start System currentTimeMillis if log isInfoEnabled for Resource resource resources
protected void printHierarchy withModule new WithModule Override public void with ModuleDefinition def Stack ModuleDefinition parents
protected void withModule ModuleDefinition def Stack ModuleDefinition parents WithModule with if def null return if shouldLoad def
Override public void process VirtualMachineProfile vmProfile DeploymentPlan plan ExcludeList avoid throws AffinityConflictException VirtualMachine vm vmProfile getVirtualMachine List AffinityGroupVMMapVO vmGroupMappings _affinityGroupVMMapDao findByVmIdType vm getId getType DataCenter dc _dcDao findById vm getDataCenterId List DedicatedResourceVO resourceList new ArrayList DedicatedResourceVO if vmGroupMappings null vmGroupMappings isEmpty for AffinityGroupVMMapVO vmGroupMapping vmGroupMappings if vmGroupMapping null if s_logger isDebugEnabled
DB Override public void handleDeleteGroup final AffinityGroup group if group null List DedicatedResourceVO dedicatedResources _dedicatedDao listByAffinityGroupId group getId if dedicatedResources isEmpty if s_logger isDebugEnabled
if dedicatedResources isEmpty if s_logger isDebugEnabled s_logger debug group Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status SearchBuilder DedicatedResourceVO listByAffinityGroup _dedicatedDao createSearchBuilder listByAffinityGroup and listByAffinityGroup entity getAffinityGroupId SearchCriteria Op EQ listByAffinityGroup done SearchCriteria DedicatedResourceVO sc listByAffinityGroup create sc setParameters group getId _dedicatedDao lockRows sc null true _dedicatedDao remove sc else if s_logger isDebugEnabled
protected void processAffinityGroup AffinityGroupVMMapVO vmGroupMapping DeploymentPlan plan VirtualMachine vm AffinityGroupVO group _affinityGroupDao findById vmGroupMapping getAffinityGroupId
Override public void process VirtualMachineProfile vmProfile DeploymentPlan plan ExcludeList avoid throws AffinityConflictException VirtualMachine vm vmProfile getVirtualMachine List AffinityGroupVMMapVO vmGroupMappings _affinityGroupVMMapDao findByVmIdType vm getId getType for AffinityGroupVMMapVO vmGroupMapping vmGroupMappings if vmGroupMapping null AffinityGroupVO group _affinityGroupDao findById vmGroupMapping getAffinityGroupId if s_logger isDebugEnabled
VirtualMachine vm vmProfile getVirtualMachine List AffinityGroupVMMapVO vmGroupMappings _affinityGroupVMMapDao findByVmIdType vm getId getType for AffinityGroupVMMapVO vmGroupMapping vmGroupMappings if vmGroupMapping null AffinityGroupVO group _affinityGroupDao findById vmGroupMapping getAffinityGroupId if s_logger isDebugEnabled s_logger debug group getName vm getId List Long groupVMIds _affinityGroupVMMapDao listVmIdsByAffinityGroup group getId groupVMIds remove vm getId for Long groupVMId groupVMIds VMInstanceVO groupVM _vmInstanceDao findById groupVMId if groupVM null groupVM isRemoved if groupVM getHostId null avoid addHost groupVM getHostId if s_logger isDebugEnabled
s_logger debug group getName vm getId List Long groupVMIds _affinityGroupVMMapDao listVmIdsByAffinityGroup group getId groupVMIds remove vm getId for Long groupVMId groupVMIds VMInstanceVO groupVM _vmInstanceDao findById groupVMId if groupVM null groupVM isRemoved if groupVM getHostId null avoid addHost groupVM getHostId if s_logger isDebugEnabled s_logger debug groupVM getHostId groupVM getId else if VirtualMachine State Stopped equals groupVM getState groupVM getLastHostId null long secondsSinceLastUpdate DateUtil currentGMTTime getTime groupVM getUpdateTime getTime if secondsSinceLastUpdate _vmCapacityReleaseInterval avoid addHost groupVM getLastHostId if s_logger isDebugEnabled
Override public boolean start if s_apiNameDiscoveryResponseMap null long startTime System nanoTime s_apiNameDiscoveryResponseMap new HashMap String ApiDiscoveryResponse Set Class cmdClasses new HashSet Class for PluggableService service _services
enabled Boolean parseBoolean isEnabled String duration _configDao getValue Config ApiLimitInterval key if duration null timeToLive Integer parseInt duration String maxReqs _configDao getValue Config ApiLimitMax key if maxReqs null maxAllowed Integer parseInt maxReqs EhcacheLimitStore cacheStore new EhcacheLimitStore int maxElements String cachesize _configDao getValue Config ApiLimitCacheSize key if cachesize null maxElements Integer parseInt cachesize CacheManager cm CacheManager create Cache cache new Cache maxElements false false timeToLive timeToLive cm addCache cache
sharesInfo setShares newShares diskUpdated true long currentLimitIops sioai getLimit null sioai getLimit Long MIN_VALUE long newLimitIops getNewLimitIopsBasedOnVolumeSize volumeVO limitIopsPerGB limitIopsTotal newLimitIops if currentLimitIops newLimitIops sioai setLimit newLimitIops diskUpdated true if diskUpdated VirtualDeviceConfigSpec vdcs new VirtualDeviceConfigSpec vdcs setDevice disk vdcs setOperation VirtualDeviceConfigSpecOperation EDIT VirtualMachineConfigSpec vmcs new VirtualMachineConfigSpec vmcs getDeviceChange add vdcs try
long currentLimitIops sioai getLimit null sioai getLimit Long MIN_VALUE long newLimitIops getNewLimitIopsBasedOnVolumeSize disk getCapacityInBytes limitIopsPerGB limitIopsTotal newLimitIops if currentLimitIops newLimitIops sioai setLimit newLimitIops diskUpdated true if diskUpdated VirtualDeviceConfigSpec vdcs new VirtualDeviceConfigSpec vdcs setDevice disk vdcs setOperation VirtualDeviceConfigSpecOperation EDIT VirtualMachineConfigSpec vmcs new VirtualMachineConfigSpec vmcs getDeviceChange add vdcs try ManagedObjectReference task VMwareUtil reconfigureVm connection morVm vmcs tasks add task
Override public boolean assignVMToBackupOffering VirtualMachine vm BackupOffering backupOffering
Override public boolean restoreVMFromBackup VirtualMachine vm Backup backup
Override public Pair Boolean String restoreBackedUpVolume Backup backup String volumeUuid String hostIp String dataStoreUuid
Override public boolean removeVMFromBackupOffering VirtualMachine vm
Override public boolean takeBackup VirtualMachine vm
Override public boolean assignVMToBackupOffering final VirtualMachine vm final BackupOffering backupOffering final VeeamClient client getClient vm getDataCenterId final Job parentJob client listJob backupOffering getExternalId final String clonedJobName getGuestBackupName vm getInstanceName vm getUuid if client cloneVeeamJob parentJob clonedJobName
private String findDCHierarchy final String vmwareDcName
private String lookupVM final String hierarchyId final String vmName
public Ref listBackupRepository final String backupServerId
public void listAllBackups LOG debug try final HttpResponse response get checkResponseOK response final ObjectMapper objectMapper new XmlMapper final EntityReferences entityReferences objectMapper readValue response getEntity getContent EntityReferences class for final Ref ref entityReferences getRefs
public Job listJob final String jobId
public boolean toggleJobSchedule final String jobId
public boolean startBackupJob final String jobId
public boolean cloneVeeamJob final Job parentJob final String clonedJobName
public boolean addVMToVeeamJob final String jobId final String vmwareInstanceName final String vmwareDcName
public boolean removeVMFromVeeamJob final String jobId final String vmwareInstanceName final String vmwareDcName
final HttpResponse response get String format jobId checkResponseOK response final ObjectMapper objectMapper new XmlMapper objectMapper configure DeserializationFeature FAIL_ON_UNKNOWN_PROPERTIES false final ObjectsInJob jobObjects objectMapper readValue response getEntity getContent ObjectsInJob class if jobObjects null jobObjects getObjects null LOG warn jobId return false for final ObjectInJob jobObject jobObjects getObjects if jobObject getName equals vmwareInstanceName jobObject getHierarchyObjRef equals veeamVmRefId final HttpResponse deleteResponse delete String format jobId jobObject getObjectInJobId return checkTaskStatus deleteResponse LOG warn vmwareInstanceName jobId return false catch final IOException e
public boolean restoreFullVM final String vmwareInstanceName final String restorePointId
if authStrictness return if certificates null certificates length certificates null throw new CertificateException clientAddress final X509Certificate primaryClientCertificate certificates final BigInteger serialNumber primaryClientCertificate getSerialNumber if serialNumber null crlDao findBySerial serialNumber null final String errorMsg String format primaryClientCertificate getSerialNumber primaryClientCertificate getSubjectDN clientAddress LOG error errorMsg throw new CertificateException errorMsg if allowExpiredCertificate try primaryClientCertificate checkValidity catch final CertificateExpiredException CertificateNotYetValidException e final String errorMsg String format primaryClientCertificate getSerialNumber primaryClientCertificate getSubjectDN clientAddress
LOG error errorMsg throw new CertificateException errorMsg if allowExpiredCertificate try primaryClientCertificate checkValidity catch final CertificateExpiredException CertificateNotYetValidException e final String errorMsg String format primaryClientCertificate getSerialNumber primaryClientCertificate getSubjectDN clientAddress LOG error errorMsg throw new CertificateException errorMsg boolean certMatchesOwnership false if primaryClientCertificate getSubjectAlternativeNames null for final List list primaryClientCertificate getSubjectAlternativeNames if list null list size list get String final String alternativeName String list get if clientAddress equals alternativeName
primaryClientCertificate checkValidity catch final CertificateExpiredException CertificateNotYetValidException e final String errorMsg String format primaryClientCertificate getSerialNumber primaryClientCertificate getSubjectDN clientAddress LOG error errorMsg throw new CertificateException errorMsg boolean certMatchesOwnership false if primaryClientCertificate getSubjectAlternativeNames null for final List list primaryClientCertificate getSubjectAlternativeNames if list null list size list get String final String alternativeName String list get if clientAddress equals alternativeName certMatchesOwnership true if certMatchesOwnership final String errorMsg clientAddress LOG error errorMsg
Override public void execute final Pair List QuotaTariffVO Integer result _responseBuilder listQuotaTariffPlans this final List QuotaTariffResponse responses new ArrayList QuotaTariffResponse for final QuotaTariffVO resource result first if s_logger isDebugEnabled
Override public int compare QuotaBalanceVO o1 QuotaBalanceVO o2 o1 o1 null new QuotaBalanceVO o1 o2 o2 null new QuotaBalanceVO o2 return o2 getUpdatedOn compareTo o1 getUpdatedOn boolean have_balance_entries false for Iterator QuotaBalanceVO it quotaBalance iterator it hasNext QuotaBalanceVO entry it next if entry isBalanceEntry have_balance_entries true break if have_balance_entries ListIterator QuotaBalanceVO li quotaBalance listIterator quotaBalance size while li hasPrevious QuotaBalanceVO entry li previous
break if have_balance_entries ListIterator QuotaBalanceVO li quotaBalance listIterator quotaBalance size while li hasPrevious QuotaBalanceVO entry li previous if s_logger isDebugEnabled s_logger debug entry if entry getCreditsId li remove else break int quota_activity quotaBalance size QuotaBalanceResponse resp new QuotaBalanceResponse BigDecimal lastCredits new BigDecimal boolean consecutive true
if s_logger isDebugEnabled s_logger debug quotaUsage get getUsageType quotaUsage get getQuotaUsed setScale RoundingMode HALF_EVEN quotaUsage get getUsageItemId quotaUsage get getStartDate quotaUsage get getEndDate Collections sort quotaUsage new Comparator QuotaUsageVO Override public int compare QuotaUsageVO o1 QuotaUsageVO o2 if o1 getUsageType o2 getUsageType return return o1 getUsageType o2 getUsageType List QuotaStatementItemResponse items new ArrayList QuotaStatementItemResponse QuotaStatementItemResponse lineitem int type BigDecimal usage new BigDecimal BigDecimal totalUsage new BigDecimal quotaUsage add new QuotaUsageVO QuotaUsageVO prev quotaUsage get
Override public Pair List QuotaTariffVO Integer listQuotaTariffPlans final QuotaTariffListCmd cmd Pair List QuotaTariffVO Integer result Date effectiveDate cmd getEffectiveDate null new Date cmd getEffectiveDate Date adjustedEffectiveDate _quotaService computeAdjustedTime effectiveDate if s_logger isDebugEnabled
if effectiveDate compareTo now throw new InvalidParameterValueException effectiveDate now QuotaTypes quotaConstant QuotaTypes listQuotaTypes get quotaType if quotaConstant null throw new InvalidParameterValueException quotaType QuotaTariffVO result null result new QuotaTariffVO quotaType result setUsageName quotaConstant getQuotaName result setUsageUnit quotaConstant getQuotaUnit result setUsageDiscriminator quotaConstant getDiscriminator result setCurrencyValue quotaCost result setEffectiveOn effectiveDate result setUpdatedOn now result setUpdatedBy cmd getEntityOwnerId if s_logger isDebugEnabled
throw new InvalidParameterValueException despositedOn QuotaCreditsVO credits new QuotaCreditsVO accountId domainId new BigDecimal amount updatedBy credits setUpdatedOn despositedOn QuotaCreditsVO result _quotaCreditsDao saveCredits credits final AccountVO account _accountDao findById accountId if account null throw new InvalidParameterValueException accountId final boolean lockAccountEnforcement equalsIgnoreCase QuotaConfig QuotaEnableEnforcement value final BigDecimal currentAccountBalance _quotaBalanceDao lastQuotaBalance accountId domainId startOfNextDay new Date despositedOn getTime if s_logger isDebugEnabled s_logger debug amount despositedOn currentAccountBalance _quotaService saveQuotaAccount account currentAccountBalance despositedOn if lockAccountEnforcement if currentAccountBalance compareTo new BigDecimal if account getState Account State locked
QuotaCreditsVO result _quotaCreditsDao saveCredits credits final AccountVO account _accountDao findById accountId if account null throw new InvalidParameterValueException accountId final boolean lockAccountEnforcement equalsIgnoreCase QuotaConfig QuotaEnableEnforcement value final BigDecimal currentAccountBalance _quotaBalanceDao lastQuotaBalance accountId domainId startOfNextDay new Date despositedOn getTime if s_logger isDebugEnabled s_logger debug amount despositedOn currentAccountBalance _quotaService saveQuotaAccount account currentAccountBalance despositedOn if lockAccountEnforcement if currentAccountBalance compareTo new BigDecimal if account getState Account State locked s_logger info account getAccountName currentAccountBalance _accountMgr enableAccount account getAccountName domainId accountId else
if _domainDao isChildDomain caller getDomainId domainId Filter filter new Filter AccountVO class Boolean FALSE null null List AccountVO accounts _accountDao listAccounts accountName domainId filter if accounts isEmpty userAccount accounts get if userAccount null accountId userAccount getId else throw new InvalidParameterValueException accountName domainId else throw new PermissionDeniedException startDate startDate null new Date startDate if endDate null Date adjustedStartDate computeAdjustedTime _respBldr startOfNextDay startDate if s_logger isDebugEnabled
if accounts isEmpty userAccount accounts get if userAccount null accountId userAccount getId else throw new InvalidParameterValueException accountName domainId else throw new PermissionDeniedException startDate startDate null new Date startDate if endDate null Date adjustedStartDate computeAdjustedTime _respBldr startOfNextDay startDate if s_logger isDebugEnabled s_logger debug accountId domainId adjustedStartDate List QuotaBalanceVO qbrecords _quotaBalanceDao lastQuotaBalanceVO accountId domainId adjustedStartDate if s_logger isDebugEnabled
if userAccount null accountId userAccount getId else throw new InvalidParameterValueException accountName domainId else throw new PermissionDeniedException startDate startDate null new Date startDate if endDate null Date adjustedStartDate computeAdjustedTime _respBldr startOfNextDay startDate if s_logger isDebugEnabled s_logger debug accountId domainId adjustedStartDate List QuotaBalanceVO qbrecords _quotaBalanceDao lastQuotaBalanceVO accountId domainId adjustedStartDate if s_logger isDebugEnabled s_logger debug qbrecords size if qbrecords isEmpty
startDate startDate null new Date startDate if endDate null Date adjustedStartDate computeAdjustedTime _respBldr startOfNextDay startDate if s_logger isDebugEnabled s_logger debug accountId domainId adjustedStartDate List QuotaBalanceVO qbrecords _quotaBalanceDao lastQuotaBalanceVO accountId domainId adjustedStartDate if s_logger isDebugEnabled s_logger debug qbrecords size if qbrecords isEmpty s_logger info adjustedStartDate return qbrecords else return qbrecords else Date adjustedStartDate computeAdjustedTime startDate
Date adjustedStartDate computeAdjustedTime _respBldr startOfNextDay startDate if s_logger isDebugEnabled s_logger debug accountId domainId adjustedStartDate List QuotaBalanceVO qbrecords _quotaBalanceDao lastQuotaBalanceVO accountId domainId adjustedStartDate if s_logger isDebugEnabled s_logger debug qbrecords size if qbrecords isEmpty s_logger info adjustedStartDate return qbrecords else return qbrecords else Date adjustedStartDate computeAdjustedTime startDate if endDate after _respBldr startOfNextDay throw new InvalidParameterValueException endDate
s_logger debug accountId domainId adjustedStartDate List QuotaBalanceVO qbrecords _quotaBalanceDao lastQuotaBalanceVO accountId domainId adjustedStartDate if s_logger isDebugEnabled s_logger debug qbrecords size if qbrecords isEmpty s_logger info adjustedStartDate return qbrecords else return qbrecords else Date adjustedStartDate computeAdjustedTime startDate if endDate after _respBldr startOfNextDay throw new InvalidParameterValueException endDate else if startDate before endDate Date adjustedEndDate computeAdjustedTime endDate
if accounts isEmpty userAccount accounts get if userAccount null accountId userAccount getId else throw new InvalidParameterValueException accountName domainId else throw new PermissionDeniedException if startDate after endDate throw new InvalidParameterValueException startDate endDate if endDate after _respBldr startOfNextDay throw new InvalidParameterValueException endDate Date adjustedEndDate computeAdjustedTime endDate Date adjustedStartDate computeAdjustedTime startDate if s_logger isDebugEnabled
Override public boolean saveQuotaAccount final AccountVO account final BigDecimal aggrUsage final Date endDate QuotaAccountVO quota_account _quotaAcc findByIdQuotaAccount account getAccountId if quota_account null quota_account new QuotaAccountVO account getAccountId quota_account setQuotaBalance aggrUsage quota_account setQuotaBalanceDate endDate if s_logger isDebugEnabled
Long accountId null List HostVO hosts null if accountName null Account caller CallContext current getCallingAccount Account owner _accountMgr finalizeOwner caller accountName domainId null accountId owner getId List Long childDomainIds getDomainChildIds domainId childDomainIds add domainId checkAccountAndDomain accountId domainId final DataCenterVO dc _zoneDao findById zoneId if dc null throw new InvalidParameterValueException zoneId else DedicatedResourceVO dedicatedZone _dedicatedDao findByZoneId zoneId if dedicatedZone null
DedicatedResourceVO dedicatedZone _dedicatedDao findByZoneId zoneId if dedicatedZone null s_logger error dc getName throw new CloudRuntimeException dc getName List HostPodVO pods _podDao listByDataCenterId dc getId List DedicatedResourceVO podsToRelease new ArrayList DedicatedResourceVO List DedicatedResourceVO clustersToRelease new ArrayList DedicatedResourceVO List DedicatedResourceVO hostsToRelease new ArrayList DedicatedResourceVO for HostPodVO pod pods DedicatedResourceVO dPod _dedicatedDao findByPodId pod getId if dPod null if childDomainIds contains dPod getDomainId throw new CloudRuntimeException pod getName dc getName if accountId null if dPod getAccountId equals accountId
podsToRelease add dPod else s_logger error pod getName dc getName throw new CloudRuntimeException pod getName dc getName else if dPod getAccountId null dPod getDomainId equals domainId podsToRelease add dPod for DedicatedResourceVO dr podsToRelease releaseDedicatedResource null dr getPodId null null List ClusterVO clusters _clusterDao listClustersByDcId dc getId for ClusterVO cluster clusters DedicatedResourceVO dCluster _dedicatedDao findByClusterId cluster getId if dCluster null if childDomainIds contains dCluster getDomainId throw new CloudRuntimeException cluster getName dc getName
List ClusterVO clusters _clusterDao listClustersByDcId dc getId for ClusterVO cluster clusters DedicatedResourceVO dCluster _dedicatedDao findByClusterId cluster getId if dCluster null if childDomainIds contains dCluster getDomainId throw new CloudRuntimeException cluster getName dc getName if accountId null if dCluster getAccountId equals accountId clustersToRelease add dCluster else s_logger error cluster getName dc getName throw new CloudRuntimeException cluster getName dc getName else if dCluster getAccountId null dCluster getDomainId equals domainId clustersToRelease add dCluster
if accountName null Account caller CallContext current getCallingAccount Account owner _accountMgr finalizeOwner caller accountName domainId null accountId owner getId List Long childDomainIds getDomainChildIds domainId childDomainIds add domainId checkAccountAndDomain accountId domainId HostPodVO pod _podDao findById podId List HostVO hosts null if pod null throw new InvalidParameterValueException podId else DedicatedResourceVO dedicatedPod _dedicatedDao findByPodId podId DedicatedResourceVO dedicatedZoneOfPod _dedicatedDao findByZoneId pod getDataCenterId if dedicatedPod null
if dedicatedZoneOfPod null boolean domainIdInChildreanList getDomainChildIds dedicatedZoneOfPod getDomainId contains domainId if dedicatedZoneOfPod getAccountId null accountId null domainIdInChildreanList accountId null dedicatedZoneOfPod getDomainId equals domainId domainIdInChildreanList DataCenterVO zone _zoneDao findById pod getDataCenterId s_logger error throw new CloudRuntimeException zone getName List ClusterVO clusters _clusterDao listByPodId pod getId List DedicatedResourceVO clustersToRelease new ArrayList DedicatedResourceVO List DedicatedResourceVO hostsToRelease new ArrayList DedicatedResourceVO for ClusterVO cluster clusters DedicatedResourceVO dCluster _dedicatedDao findByClusterId cluster getId if dCluster null if childDomainIds contains dCluster getDomainId throw new CloudRuntimeException cluster getName pod getName if accountId null
if accountId null if dCluster getAccountId equals accountId clustersToRelease add dCluster else s_logger error cluster getName pod getName throw new CloudRuntimeException cluster getName pod getName else if dCluster getAccountId null dCluster getDomainId equals domainId clustersToRelease add dCluster for DedicatedResourceVO dr clustersToRelease releaseDedicatedResource null null dr getClusterId null hosts _hostDao findByPodId pod getId for HostVO host hosts DedicatedResourceVO dHost _dedicatedDao findByHostId host getId if dHost null
if accountName null Account caller CallContext current getCallingAccount Account owner _accountMgr finalizeOwner caller accountName domainId null accountId owner getId List Long childDomainIds getDomainChildIds domainId childDomainIds add domainId checkAccountAndDomain accountId domainId ClusterVO cluster _clusterDao findById clusterId if cluster null throw new InvalidParameterValueException clusterId else DedicatedResourceVO dedicatedCluster _dedicatedDao findByClusterId clusterId DedicatedResourceVO dedicatedPodOfCluster _dedicatedDao findByPodId cluster getPodId DedicatedResourceVO dedicatedZoneOfCluster _dedicatedDao findByZoneId cluster getDataCenterId if dedicatedCluster null
throw new CloudRuntimeException pod getName if dedicatedZoneOfCluster null boolean domainIdInChildreanList getDomainChildIds dedicatedZoneOfCluster getDomainId contains domainId if dedicatedZoneOfCluster getAccountId null accountId null domainIdInChildreanList accountId null dedicatedZoneOfCluster getDomainId equals domainId domainIdInChildreanList s_logger error DataCenterVO zone _zoneDao findById cluster getDataCenterId throw new CloudRuntimeException zone getName hosts _hostDao findByClusterId cluster getId List DedicatedResourceVO hostsToRelease new ArrayList DedicatedResourceVO for HostVO host hosts DedicatedResourceVO dHost _dedicatedDao findByHostId host getId if dHost null if childDomainIds contains dHost getDomainId throw new CloudRuntimeException host getName cluster getName if accountId null
Account caller CallContext current getCallingAccount Account owner _accountMgr finalizeOwner caller accountName domainId null accountId owner getId checkAccountAndDomain accountId domainId HostVO host _hostDao findById hostId if host null throw new InvalidParameterValueException hostId else if host getType Host Type Routing throw new CloudRuntimeException host getName DedicatedResourceVO dedicatedHost _dedicatedDao findByHostId hostId DedicatedResourceVO dedicatedClusterOfHost _dedicatedDao findByClusterId host getClusterId DedicatedResourceVO dedicatedPodOfHost _dedicatedDao findByPodId host getPodId DedicatedResourceVO dedicatedZoneOfHost _dedicatedDao findByZoneId host getDataCenterId if dedicatedHost null
private boolean checkHostSuitabilityForExplicitDedication Long accountId List Long domainIds long hostId boolean suitable true List UserVmVO allVmsOnHost getVmsOnHost hostId if accountId null for UserVmVO vm allVmsOnHost if vm getAccountId accountId
private boolean checkHostSuitabilityForImplicitDedication Long accountId List VMInstanceVO allVmsOnHost boolean suitable true if allVmsOnHost isEmpty return false for VMInstanceVO vm allVmsOnHost if vm getAccountId accountId
private boolean checkIfAllVmsCreatedInStrictMode Long accountId List VMInstanceVO allVmsOnHost boolean createdByImplicitStrict true if allVmsOnHost isEmpty return false for VMInstanceVO vm allVmsOnHost if isImplicitPlannerUsedByOffering vm getServiceOfferingId
private boolean isImplicitPlannerUsedByOffering long offeringId boolean implicitPlannerUsed false ServiceOfferingVO offering serviceOfferingDao findByIdIncludingRemoved offeringId if offering null
protected List Long listPodsByUserConcentration long zoneId long accountId if s_logger isDebugEnabled
protected Pair List Long Map Long Double listClustersByUserDispersion long id boolean isZone long accountId if s_logger isDebugEnabled
protected Pair List Long Map Long Double listPodsByUserDispersion long dataCenterId long accountId if s_logger isDebugEnabled
List Long capacityOrderedIds capacityInfo first List Long vmCountOrderedIds vmCountInfo first Map Long Double capacityMap capacityInfo second Map Long Double vmCountMap vmCountInfo second if s_logger isTraceEnabled s_logger trace capacityOrderedIds capacityMap if s_logger isTraceEnabled s_logger trace vmCountOrderedIds vmCountMap List Long idsReorderedByWeights new ArrayList Long float capacityWeight _userDispersionWeight if s_logger isDebugEnabled s_logger debug _userDispersionWeight LinkedHashMap Long Double normalisedVmCountIdMap new LinkedHashMap Long Double Long totalVmsOfAccount vmInstanceDao countRunningAndStartingByAccount accountId if s_logger isDebugEnabled
else s_logger debug dcId podId clusterId if hostTag null hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId hostTag else hostsCopy retainAll _resourceMgr listAllUpAndEnabledHosts type clusterId podId dcId s_logger debug hostsCopy size if hostsCopy size return suitableHosts Collections shuffle hostsCopy for Host host hostsCopy if suitableHosts size returnUpTo break if avoid shouldAvoid host suitableHosts add host
if hostTag null hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId hostTag else hostsCopy retainAll _resourceMgr listAllUpAndEnabledHosts type clusterId podId dcId s_logger debug hostsCopy size if hostsCopy size return suitableHosts Collections shuffle hostsCopy for Host host hostsCopy if suitableHosts size returnUpTo break if avoid shouldAvoid host suitableHosts add host else if s_logger isDebugEnabled
s_logger debug dcId podId clusterId List extends Host hosts new ArrayList HostVO if hostTag null hosts _hostDao listByHostTag type clusterId podId dcId hostTag else hosts _resourceMgr listAllUpAndEnabledHosts type clusterId podId dcId s_logger debug hosts size if hosts size return suitableHosts Collections shuffle hosts for Host host hosts if suitableHosts size returnUpTo break if avoid shouldAvoid host suitableHosts add host
List extends Host hosts new ArrayList HostVO if hostTag null hosts _hostDao listByHostTag type clusterId podId dcId hostTag else hosts _resourceMgr listAllUpAndEnabledHosts type clusterId podId dcId s_logger debug hosts size if hosts size return suitableHosts Collections shuffle hosts for Host host hosts if suitableHosts size returnUpTo break if avoid shouldAvoid host suitableHosts add host else
Override public Map extends ServerResource Map String String find long dcId Long podId Long clusterId URI url String username String password List String hostTags throws DiscoveryException Map BareMetalResourceBase Map String String resources new HashMap BareMetalResourceBase Map String String Map String String details new HashMap String String if url getScheme equals String msg url
resource configure params String memCapacity String params get ApiConstants MEMORY String cpuCapacity String params get ApiConstants CPU_SPEED String cpuNum String params get ApiConstants CPU_NUMBER String mac String params get ApiConstants HOST_MAC if hostTags null hostTags size details put hostTags get details put ApiConstants MEMORY memCapacity details put ApiConstants CPU_SPEED cpuCapacity details put ApiConstants CPU_NUMBER cpuNum details put ApiConstants HOST_MAC mac details put ApiConstants USERNAME username details put ApiConstants PASSWORD password details put ApiConstants PRIVATE_IP ipmiIp String vmIp String params get ApiConstants IP_ADDRESS
Override public DeployDestination plan VirtualMachineProfile vmProfile DeploymentPlan plan ExcludeList avoid throws InsufficientServerCapacityException VirtualMachine vm vmProfile getVirtualMachine ServiceOffering offering vmProfile getServiceOffering String hostTag null String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if vm getLastHostId null haVmTag null HostVO h _hostDao findById vm getLastHostId DataCenter dc _dcDao findById h getDataCenterId Pod pod _podDao findById h getPodId Cluster c _clusterDao findById h getClusterId
if target null s_logger warn hostTag cpu_requested offering getCpu offering getSpeed ram_requested offering getRamSize 1024L 1024L else cpu_requested target getCpus target getSpeed intValue ram_requested target getTotalMemory for ClusterVO cluster clusters if haVmTag null hosts _resourceMgr listAllUpAndEnabledNonHAHosts Host Type Routing cluster getId cluster getPodId cluster getDataCenterId else s_logger warn haVmTag cluster getId cluster getPodId cluster getDataCenterId return null for HostVO h hosts long cluster_id h getClusterId
String zoneName if profile getZoneIdList null profile getZoneIdList size throw new CloudRuntimeException if template isCrossZones profile getZoneIdList null zoneName profile getZoneIdList get toString else zoneName s_logger debug template getName zoneName Account account _accountDao findByIdIncludingRemoved template getAccountId String eventType EventTypes EVENT_TEMPLATE_DELETE List TemplateDataStoreVO templateHostVOs this _tmpltStoreDao listByTemplate templateId for TemplateDataStoreVO vo templateHostVOs TemplateDataStoreVO lock null try lock _tmpltStoreDao acquireInLockTable vo getId if lock null
if lock null _tmpltStoreDao releaseFromLockTable lock getId if profile getZoneIdList null UsageEventVO usageEvent new UsageEventVO eventType account getId profile getZoneIdList get templateId null _usageEventDao persist usageEvent VMTemplateZoneVO templateZone _tmpltZoneDao findByZoneTemplate profile getZoneIdList get templateId if templateZone null _tmpltZoneDao remove templateZone getId else List DataCenterVO dcs _dcDao listAllIncludingRemoved for DataCenterVO dc dcs UsageEventVO usageEvent new UsageEventVO eventType account getId dc getId templateId null _usageEventDao persist usageEvent s_logger debug template getName zoneName if success _tmpltStoreDao listByTemplate templateId size
if templateZone null _tmpltZoneDao remove templateZone getId else List DataCenterVO dcs _dcDao listAllIncludingRemoved for DataCenterVO dc dcs UsageEventVO usageEvent new UsageEventVO eventType account getId dc getId templateId null _usageEventDao persist usageEvent s_logger debug template getName zoneName if success _tmpltStoreDao listByTemplate templateId size long accountId template getAccountId VMTemplateVO lock _tmpltDao acquireInLockTable templateId try if lock null s_logger debug templateId success false
State oldState transition getCurrentState if newState State Starting newState State Error newState State Expunging return true if vo getHypervisorType HypervisorType BareMetal return true HostVO host _hostDao findById vo getHostId if host null s_logger debug oldState newState return true _hostDao loadDetails host if newState State Starting host setDetail vo getInstanceName s_logger debug host getDetail host getId else if host getDetail null host getDetail equalsIgnoreCase vo getInstanceName
throw new CloudRuntimeException String format cmd getMac _hostDao loadDetails host String vmName host getDetail if vmName null throw new CloudRuntimeException String format cmd getMac QueryBuilder VMInstanceVO vmq QueryBuilder create VMInstanceVO class vmq and vmq entity getInstanceName SearchCriteria Op EQ vmName VMInstanceVO vm vmq find if vm null throw new CloudRuntimeException String format vmName if State Starting vm getState throw new CloudRuntimeException String format vmName vm getState vm setState State Running vm setLastHostId vm getHostId vmDao update vm getId vm
URI uri try uri new URI cmd getUrl catch Exception e s_logger debug e throw new IllegalArgumentException e getMessage String ipAddress uri getHost String guid getPxeServerGuid Long toString zoneId pod getId BaremetalPxeType PING toString ipAddress ServerResource resource null Map params new HashMap String String params put BaremetalPxeService PXE_PARAM_ZONE Long toString zoneId params put BaremetalPxeService PXE_PARAM_POD String valueOf pod getId params put BaremetalPxeService PXE_PARAM_IP ipAddress params put BaremetalPxeService PXE_PARAM_USERNAME cmd getUsername params put BaremetalPxeService PXE_PARAM_PASSWORD cmd getPassword
if _ip null throw new ConfigurationException if _mac equalsIgnoreCase throw new ConfigurationException if _mac split length throw new ConfigurationException _mac if _uuid null throw new ConfigurationException if echoScAgent null _isEchoScAgent Boolean valueOf echoScAgent String ipmiIface try ipmiIface configDao getValue Config BaremetalIpmiLanInterface key catch Exception e s_logger debug e getMessage e
throw new ConfigurationException if _mac split length throw new ConfigurationException _mac if _uuid null throw new ConfigurationException if echoScAgent null _isEchoScAgent Boolean valueOf echoScAgent String ipmiIface try ipmiIface configDao getValue Config BaremetalIpmiLanInterface key catch Exception e s_logger debug e getMessage e try ipmiRetryTimes Integer parseInt configDao getValue Config BaremetalIpmiRetryTimes key catch Exception e
return new StartAnswer cmd String format vm getNics getIp if provisionDoneNotificationOn QueryBuilder VMInstanceVO q QueryBuilder create VMInstanceVO class q and q entity getInstanceName SearchCriteria Op EQ vm getName VMInstanceVO vmvo q find if vmvo getLastHostId null long timeout System currentTimeMillis TimeUnit SECONDS toMillis isProvisionDoneNotificationTimeout while timeout System currentTimeMillis try TimeUnit SECONDS sleep catch InterruptedException e s_logger warn e getMessage e q QueryBuilder create VMInstanceVO class q and q entity getInstanceName SearchCriteria Op EQ vm getName vmvo q find
if provisionDoneNotificationOn QueryBuilder VMInstanceVO q QueryBuilder create VMInstanceVO class q and q entity getInstanceName SearchCriteria Op EQ vm getName VMInstanceVO vmvo q find if vmvo getLastHostId null long timeout System currentTimeMillis TimeUnit SECONDS toMillis isProvisionDoneNotificationTimeout while timeout System currentTimeMillis try TimeUnit SECONDS sleep catch InterruptedException e s_logger warn e getMessage e q QueryBuilder create VMInstanceVO class q and q entity getInstanceName SearchCriteria Op EQ vm getName vmvo q find if vmvo null
else final IPAddressVO ipVO _ipAddressDao findByIpAndSourceNetworkId network getId oldIp if ipVO null PodVlanMapVO mapVO _podVlanDao listPodVlanMapsByVlan ipVO getVlanId if mapVO getPodId dest getPod getId Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status _ipAddrMgr markIpAsUnavailable ipVO getId _ipAddressDao unassignIpAddress ipVO getId nic setIPv4Address null getNewIp true if getNewIp getBaremetalIp nic dest getPod vm network intentIp DataCenter dc _dcDao findById network getDataCenterId
private void getBaremetalIp NicProfile nic Pod pod VirtualMachineProfile vm Network network String requiredIp throws InsufficientAddressCapacityException ConcurrentOperationException DataCenter dc _dcDao findById pod getDataCenterId if nic getIPv4Address null
Override public boolean implement Network network NetworkOffering offering DeployDestination dest ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException if offering isSystemOnly canHandle dest offering getTrafficType network getGuestType
Long podId profile getVirtualMachine getPodIdToDeployIn List HostVO hosts _resourceMgr listAllUpAndEnabledHosts Type BaremetalDhcp null podId zoneId if hosts size throw new CloudRuntimeException zoneId podId if hosts size throw new CloudRuntimeException zoneId podId HostVO h hosts get String dns nic getIPv4Dns1 if dns null dns nic getIPv4Dns2 DhcpEntryCommand dhcpCommand new DhcpEntryCommand nic getMacAddress nic getIPv4Address profile getVirtualMachine getHostName null dns nic getIPv4Gateway null _ntwkModel getExecuteInSeqNtwkElmtCmd String errMsg String format h getPrivateIpAddress nic getIPv4Address nic getMacAddress profile getVirtualMachine getHostName try Answer ans _agentMgr send h getId dhcpCommand if ans getResult
throw new CloudRuntimeException zoneId podId if hosts size throw new CloudRuntimeException zoneId podId HostVO h hosts get String dns nic getIPv4Dns1 if dns null dns nic getIPv4Dns2 DhcpEntryCommand dhcpCommand new DhcpEntryCommand nic getMacAddress nic getIPv4Address profile getVirtualMachine getHostName null dns nic getIPv4Gateway null _ntwkModel getExecuteInSeqNtwkElmtCmd String errMsg String format h getPrivateIpAddress nic getIPv4Address nic getMacAddress profile getVirtualMachine getHostName try Answer ans _agentMgr send h getId dhcpCommand if ans getResult s_logger debug String format h getPrivateIpAddress nic getIPv4Address nic getMacAddress profile getVirtualMachine getHostName return true else
throw new CloudRuntimeException zoneId podId HostVO h hosts get String dns nic getIPv4Dns1 if dns null dns nic getIPv4Dns2 DhcpEntryCommand dhcpCommand new DhcpEntryCommand nic getMacAddress nic getIPv4Address profile getVirtualMachine getHostName null dns nic getIPv4Gateway null _ntwkModel getExecuteInSeqNtwkElmtCmd String errMsg String format h getPrivateIpAddress nic getIPv4Address nic getMacAddress profile getVirtualMachine getHostName try Answer ans _agentMgr send h getId dhcpCommand if ans getResult s_logger debug String format h getPrivateIpAddress nic getIPv4Address nic getMacAddress profile getVirtualMachine getHostName return true else s_logger debug errMsg ans getDetails throw new ResourceUnavailableException errMsg DataCenter class zoneId
sb append sb append file sb append sb append contents sb append String arg StringUtils stripEnd sb toString sshConnection connect null if sshConnection authenticateWithPassword _username _password s_logger debug throw new ConfigurationException String format _ip _username _password String script String format arg if SSHCmdHelper sshExecuteCmd sshConnection script return new Answer cmd false script return new Answer cmd true catch Exception e
if sshConnection authenticateWithPassword _username _password s_logger debug throw new ConfigurationException String format _ip _username _password String copyTo String format _tftpDir cmd getTemplateUuid String script String format cmd getKernel cmd getInitrd copyTo if SSHCmdHelper sshExecuteCmd sshConnection script return new Answer cmd false _ip script String kernelPath String format cmd getTemplateUuid String initrdPath String format cmd getTemplateUuid script String format _tftpDir cmd getMac kernelPath initrdPath cmd getKsFile cmd getMac if SSHCmdHelper sshExecuteCmd sshConnection script return new Answer cmd false _ip script s_logger debug return new Answer cmd true catch Exception e
NicVO mgmtNic null for NicVO nicvo nics if ControlNetworkGuru class getSimpleName equals nicvo getReserver mgmtNic nicvo break if mgmtNic null throw new CloudRuntimeException String format vr getId String internalServerIp _configDao getValue Config BaremetalInternalStorageServer key if internalServerIp null throw new CloudRuntimeException String format Pair Boolean String ret SshHelper sshExecute mgmtNic getIPv4Address getSystemVMKeyFile null if ret first throw new CloudRuntimeException String format vr getId List String tuple parseKickstartUrl profile String cmd String format tuple get tuple get profile getTemplate getUuid String format nic getMacAddress replaceAll toLowerCase tuple get nic getMacAddress toLowerCase
if mgmtNic null throw new CloudRuntimeException String format vr getId String internalServerIp _configDao getValue Config BaremetalInternalStorageServer key if internalServerIp null throw new CloudRuntimeException String format Pair Boolean String ret SshHelper sshExecute mgmtNic getIPv4Address getSystemVMKeyFile null if ret first throw new CloudRuntimeException String format vr getId List String tuple parseKickstartUrl profile String cmd String format tuple get tuple get profile getTemplate getUuid String format nic getMacAddress replaceAll toLowerCase tuple get nic getMacAddress toLowerCase s_logger debug String format mgmtNic getIPv4Address cmd ret SshHelper sshExecute mgmtNic getIPv4Address getSystemVMKeyFile null cmd if ret first throw new CloudRuntimeException String format vr getId ret second cmd String format mgmtNic getIPv4Address internalServerIp mgmtNic getIPv4Gateway
sb append sb append file sb append sb append contents sb append String arg org apache commons lang StringUtils stripEnd sb toString sshConnection connect null if sshConnection authenticateWithPassword _username _password s_logger debug throw new ConfigurationException String format _ip _username _password String script String format arg if SSHCmdHelper sshExecuteCmd sshConnection script return new Answer cmd false script return new Answer cmd true catch Exception e
cloudIdentifier cloudIdentifier cmd addVmData cloudIdentifier List PhysicalNetworkVO phys _phynwDao listByZone vm getDataCenterId if phys isEmpty throw new CloudRuntimeException String format vm getDataCenterId if phys size throw new CloudRuntimeException String format vm getDataCenterId phys size PhysicalNetworkVO phy phys get QueryBuilder BaremetalPxeVO sc QueryBuilder create BaremetalPxeVO class sc and sc entity getPhysicalNetworkId Op EQ phy getId BaremetalPxeVO pxeVo sc find if pxeVo null throw new CloudRuntimeException vm getPodIdToDeployIn try Answer ans _agentMgr send pxeVo getHostId cmd
throw new CloudRuntimeException String format vm getDataCenterId if phys size throw new CloudRuntimeException String format vm getDataCenterId phys size PhysicalNetworkVO phy phys get QueryBuilder BaremetalPxeVO sc QueryBuilder create BaremetalPxeVO class sc and sc entity getPhysicalNetworkId Op EQ phy getId BaremetalPxeVO pxeVo sc find if pxeVo null throw new CloudRuntimeException vm getPodIdToDeployIn try Answer ans _agentMgr send pxeVo getHostId cmd if ans getResult s_logger debug String format vm getInstanceName ans getDetails return false else
Override public void prepareVlan BaremetalVlanStruct struct String link buildLink struct getSwitchIp String format struct getVlan HttpHeaders headers createBasicAuthenticationHeader struct HttpEntity String request new HttpEntity headers ResponseEntity rsp rest exchange link HttpMethod GET request String class
Override public void prepareVlan BaremetalVlanStruct struct String link buildLink struct getSwitchIp String format struct getVlan HttpHeaders headers createBasicAuthenticationHeader struct HttpEntity String request new HttpEntity headers ResponseEntity rsp rest exchange link HttpMethod GET request String class logger debug String format link if rsp getStatusCode HttpStatus NOT_FOUND PortInfo port new PortInfo struct XmlObject xml new XmlObject putElement new XmlObject setText String valueOf struct getVlan putElement new XmlObject putElement port interfaceType new XmlObject port interfaceType putElement new XmlObject setText port port putElement new XmlObject setText request new HttpEntity xml dump headers link buildLink struct getSwitchIp String format
String link buildLink struct getSwitchIp String format struct getVlan HttpHeaders headers createBasicAuthenticationHeader struct HttpEntity String request new HttpEntity headers ResponseEntity rsp rest exchange link HttpMethod GET request String class logger debug String format link if rsp getStatusCode HttpStatus NOT_FOUND PortInfo port new PortInfo struct XmlObject xml new XmlObject putElement new XmlObject setText String valueOf struct getVlan putElement new XmlObject putElement port interfaceType new XmlObject port interfaceType putElement new XmlObject setText port port putElement new XmlObject setText request new HttpEntity xml dump headers link buildLink struct getSwitchIp String format logger debug String format link request rsp rest exchange link HttpMethod POST request String class if successHttpStatusCode contains rsp getStatusCode throw new CloudRuntimeException String format struct getVlan struct getSwitchIp rsp getStatusCode rsp getBody else
logger debug String format link request rsp rest exchange link HttpMethod POST request String class if successHttpStatusCode contains rsp getStatusCode throw new CloudRuntimeException String format struct getVlan struct getSwitchIp rsp getStatusCode rsp getBody else logger debug String format struct getVlan struct getSwitchIp struct getPort rsp getStatusCode rsp getBody else if successHttpStatusCode contains rsp getStatusCode PortInfo port new PortInfo struct XmlObject xml XmlObjectParser parseFromString String rsp getBody List XmlObject ports xml getAsList ports addAll xml XmlObject getAsList ports addAll xml XmlObject getAsList for XmlObject pxml ports XmlObject name pxml get if port port equals name getText
XmlObject name pxml get if port port equals name getText logger debug String format struct getPort struct getVlan return xml removeElement xml setText null XmlObject tag xml get if tag null tag new XmlObject xml putElement tag tag putElement port interfaceType new XmlObject port interfaceType putElement new XmlObject setText port port request new HttpEntity xml dump headers link buildLink struct getSwitchIp String format struct getVlan logger debug String format link request rsp rest exchange link HttpMethod PUT request String class
Override public void removePortFromVlan BaremetalVlanStruct struct String link buildLink struct getSwitchIp String format struct getVlan HttpHeaders headers createBasicAuthenticationHeader struct HttpEntity String request new HttpEntity headers
Override public void removePortFromVlan BaremetalVlanStruct struct String link buildLink struct getSwitchIp String format struct getVlan HttpHeaders headers createBasicAuthenticationHeader struct HttpEntity String request new HttpEntity headers logger debug String format link request ResponseEntity rsp rest exchange link HttpMethod GET request String class if rsp getStatusCode HttpStatus NOT_FOUND
continue newPorts add pxml if needRemove return xml setText null xml removeElement XmlObject tagged xml get tagged removeAllChildren for XmlObject p newPorts tagged putElement p getTag p request new HttpEntity xml dump headers logger debug String format link request rsp rest exchange link HttpMethod PUT request String class if successHttpStatusCode contains rsp getStatusCode throw new CloudRuntimeException String format struct getVlan struct getPort struct getSwitchIp rsp getStatusCode rsp getBody
public HashMap String Pair Long Long sync String vmName Long vmId String agentIp HashMap String Pair Long Long states new HashMap String Pair Long Long PostMethod post new PostMethod String format agentIp getPort try post addRequestHeader if httpClient executeMethod post
Thread sleep m count catch InterruptedException e1 logger warn e1 break PostMethod post new PostMethod String format agentIp getPort try post addRequestHeader if httpClient executeMethod post logger debug String format agentIp post getResponseBodyAsString else ret true break catch Exception e if count m l
catch InterruptedException e1 logger warn e1 break PostMethod post new PostMethod String format agentIp getPort try post addRequestHeader if httpClient executeMethod post logger debug String format agentIp post getResponseBodyAsString else ret true break catch Exception e if count m l logger debug String format agentIp TimeUnit MILLISECONDS toSeconds l count break
PostMethod post new PostMethod String format agentIp getPort try SecurityGroupVmRuleSet rset new SecurityGroupVmRuleSet rset getEgressRules addAll generateRules cmd getEgressRuleSet rset getIngressRules addAll generateRules cmd getIngressRuleSet rset setVmName cmd getVmName rset setVmIp cmd getGuestIp rset setVmMac cmd getGuestMac rset setVmId cmd getVmId rset setSignature cmd getSignature rset setSequenceNumber cmd getSeqNum Marshaller marshaller context createMarshaller StringWriter writer new StringWriter marshaller marshal rset writer String xmlContents writer toString
Override public final Map extends ServerResource Map String String find final long dcId final Long podId final Long clusterId final URI uri final String username final String password final List String hostTags throws DiscoveryException if s_logger isInfoEnabled
if podId null if s_logger isInfoEnabled s_logger info return null ClusterVO cluster _clusterDao findById clusterId if cluster null if s_logger isInfoEnabled s_logger info clusterId return null if cluster getHypervisorType HypervisorType Hyperv if s_logger isInfoEnabled s_logger info clusterId return null if uri getScheme equals String msg uri
if s_logger isInfoEnabled s_logger info clusterId return null if cluster getHypervisorType HypervisorType Hyperv if s_logger isInfoEnabled s_logger info clusterId return null if uri getScheme equals String msg uri s_logger debug msg return null try String hostname uri getHost InetAddress ia InetAddress getByName hostname String agentIp ia getHostAddress
return null if cluster getHypervisorType HypervisorType Hyperv if s_logger isInfoEnabled s_logger info clusterId return null if uri getScheme equals String msg uri s_logger debug msg return null try String hostname uri getHost InetAddress ia InetAddress getByName hostname String agentIp ia getHostAddress String uuidSeed agentIp String guidWithTail calcServerResourceGuid uuidSeed
Override public String prepareSecondaryStorageStore long zoneId String secondaryStorageUri getSecondaryStorageStoreUrl zoneId if secondaryStorageUri null
private void prepareSecondaryStorageStore String storageUrl String mountPoint getMountPoint storageUrl GlobalLock lock GlobalLock getInternLock try if lock lock try File patchFolder new File mountPoint if patchFolder exists if patchFolder mkdirs String msg patchFolder toString
private void prepareSecondaryStorageStore String storageUrl String mountPoint getMountPoint storageUrl GlobalLock lock GlobalLock getInternLock try if lock lock try File patchFolder new File mountPoint if patchFolder exists if patchFolder mkdirs String msg patchFolder toString s_logger error msg throw new CloudRuntimeException msg File srcIso getSystemVMPatchIsoFile File destIso new File mountPoint getSystemVMIsoFileNameOnDatastore if destIso exists
if lock lock try File patchFolder new File mountPoint if patchFolder exists if patchFolder mkdirs String msg patchFolder toString s_logger error msg throw new CloudRuntimeException msg File srcIso getSystemVMPatchIsoFile File destIso new File mountPoint getSystemVMIsoFileNameOnDatastore if destIso exists s_logger info srcIso getAbsolutePath destIso getAbsolutePath try FileUtil copyfile srcIso destIso catch IOException e
File patchFolder new File mountPoint if patchFolder exists if patchFolder mkdirs String msg patchFolder toString s_logger error msg throw new CloudRuntimeException msg File srcIso getSystemVMPatchIsoFile File destIso new File mountPoint getSystemVMIsoFileNameOnDatastore if destIso exists s_logger info srcIso getAbsolutePath destIso getAbsolutePath try FileUtil copyfile srcIso destIso catch IOException e s_logger error e String msg srcIso toString destIso
private void startupCleanup String parent s_logger info long mshostId ManagementServerNode getManagementServerId String mounts _storage listFiles parent File separator String valueOf mshostId if mounts null mounts length for String mountPoint mounts
private void shutdownCleanup s_logger info synchronized _storageMounts for String mountPoint _storageMounts values
Override public final StartupCommand initialize if _configureCalled final String errMsg this getClass getName
final StartupRoutingCommand defaultStartRoutCmd new StartupRoutingCommand null Hypervisor HypervisorType Hyperv RouterPrivateIpStrategy HostLocal defaultStartRoutCmd setDataCenter _zoneId defaultStartRoutCmd setPod _podId defaultStartRoutCmd setCluster _clusterId defaultStartRoutCmd setGuid _guid defaultStartRoutCmd setName _name defaultStartRoutCmd setPrivateIpAddress _agentIp defaultStartRoutCmd setStorageIpAddress _agentIp defaultStartRoutCmd setPool _clusterGuid s_logger debug _agentIp defaultStartRoutCmd setVersion this getClass getPackage getImplementationVersion final Command startCmds requestStartupCommand new Command defaultStartRoutCmd final StartupRoutingCommand startCmd StartupRoutingCommand startCmds if startCmd null final String errMsg String format _name _agentIp
defaultStartRoutCmd setCluster _clusterId defaultStartRoutCmd setGuid _guid defaultStartRoutCmd setName _name defaultStartRoutCmd setPrivateIpAddress _agentIp defaultStartRoutCmd setStorageIpAddress _agentIp defaultStartRoutCmd setPool _clusterGuid s_logger debug _agentIp defaultStartRoutCmd setVersion this getClass getPackage getImplementationVersion final Command startCmds requestStartupCommand new Command defaultStartRoutCmd final StartupRoutingCommand startCmd StartupRoutingCommand startCmds if startCmd null final String errMsg String format _name _agentIp s_logger error errMsg return null if startCmd getDataCenter equals defaultStartRoutCmd getDataCenter
defaultStartRoutCmd setStorageIpAddress _agentIp defaultStartRoutCmd setPool _clusterGuid s_logger debug _agentIp defaultStartRoutCmd setVersion this getClass getPackage getImplementationVersion final Command startCmds requestStartupCommand new Command defaultStartRoutCmd final StartupRoutingCommand startCmd StartupRoutingCommand startCmds if startCmd null final String errMsg String format _name _agentIp s_logger error errMsg return null if startCmd getDataCenter equals defaultStartRoutCmd getDataCenter final String errMsg String format defaultStartRoutCmd getDataCenter startCmd getDataCenter _name _agentIp s_logger error errMsg return null if startCmd getPod equals defaultStartRoutCmd getPod
final Command startCmds requestStartupCommand new Command defaultStartRoutCmd final StartupRoutingCommand startCmd StartupRoutingCommand startCmds if startCmd null final String errMsg String format _name _agentIp s_logger error errMsg return null if startCmd getDataCenter equals defaultStartRoutCmd getDataCenter final String errMsg String format defaultStartRoutCmd getDataCenter startCmd getDataCenter _name _agentIp s_logger error errMsg return null if startCmd getPod equals defaultStartRoutCmd getPod final String errMsg String format defaultStartRoutCmd getPod startCmd getPod _name _agentIp s_logger error errMsg return null if startCmd getCluster equals defaultStartRoutCmd getCluster
s_logger error errMsg return null if startCmd getDataCenter equals defaultStartRoutCmd getDataCenter final String errMsg String format defaultStartRoutCmd getDataCenter startCmd getDataCenter _name _agentIp s_logger error errMsg return null if startCmd getPod equals defaultStartRoutCmd getPod final String errMsg String format defaultStartRoutCmd getPod startCmd getPod _name _agentIp s_logger error errMsg return null if startCmd getCluster equals defaultStartRoutCmd getCluster final String errMsg String format defaultStartRoutCmd getCluster startCmd getCluster _name _agentIp s_logger error errMsg return null if startCmd getGuid equals defaultStartRoutCmd getGuid
final String errMsg String format defaultStartRoutCmd getDataCenter startCmd getDataCenter _name _agentIp s_logger error errMsg return null if startCmd getPod equals defaultStartRoutCmd getPod final String errMsg String format defaultStartRoutCmd getPod startCmd getPod _name _agentIp s_logger error errMsg return null if startCmd getCluster equals defaultStartRoutCmd getCluster final String errMsg String format defaultStartRoutCmd getCluster startCmd getCluster _name _agentIp s_logger error errMsg return null if startCmd getGuid equals defaultStartRoutCmd getGuid final String errMsg String format defaultStartRoutCmd getGuid startCmd getGuid _name _agentIp s_logger error errMsg return null
if startCmd getPod equals defaultStartRoutCmd getPod final String errMsg String format defaultStartRoutCmd getPod startCmd getPod _name _agentIp s_logger error errMsg return null if startCmd getCluster equals defaultStartRoutCmd getCluster final String errMsg String format defaultStartRoutCmd getCluster startCmd getCluster _name _agentIp s_logger error errMsg return null if startCmd getGuid equals defaultStartRoutCmd getGuid final String errMsg String format defaultStartRoutCmd getGuid startCmd getGuid _name _agentIp s_logger error errMsg return null if startCmd getPrivateIpAddress equals defaultStartRoutCmd getPrivateIpAddress final String errMsg String format defaultStartRoutCmd getPrivateIpAddress startCmd getPrivateIpAddress _name _agentIp s_logger error errMsg
return null if startCmd getGuid equals defaultStartRoutCmd getGuid final String errMsg String format defaultStartRoutCmd getGuid startCmd getGuid _name _agentIp s_logger error errMsg return null if startCmd getPrivateIpAddress equals defaultStartRoutCmd getPrivateIpAddress final String errMsg String format defaultStartRoutCmd getPrivateIpAddress startCmd getPrivateIpAddress _name _agentIp s_logger error errMsg return null if startCmd getName equals defaultStartRoutCmd getName final String errMsg String format startCmd getName defaultStartRoutCmd getName _name _agentIp s_logger error errMsg return null StartupStorageCommand storePoolCmd null if startCmds length
final String errMsg String format defaultStartRoutCmd getGuid startCmd getGuid _name _agentIp s_logger error errMsg return null if startCmd getPrivateIpAddress equals defaultStartRoutCmd getPrivateIpAddress final String errMsg String format defaultStartRoutCmd getPrivateIpAddress startCmd getPrivateIpAddress _name _agentIp s_logger error errMsg return null if startCmd getName equals defaultStartRoutCmd getName final String errMsg String format startCmd getName defaultStartRoutCmd getName _name _agentIp s_logger error errMsg return null StartupStorageCommand storePoolCmd null if startCmds length storePoolCmd StartupStorageCommand startCmds if storePoolCmd null
s_logger error errMsg return null if startCmd getPrivateIpAddress equals defaultStartRoutCmd getPrivateIpAddress final String errMsg String format defaultStartRoutCmd getPrivateIpAddress startCmd getPrivateIpAddress _name _agentIp s_logger error errMsg return null if startCmd getName equals defaultStartRoutCmd getName final String errMsg String format startCmd getName defaultStartRoutCmd getName _name _agentIp s_logger error errMsg return null StartupStorageCommand storePoolCmd null if startCmds length storePoolCmd StartupStorageCommand startCmds if storePoolCmd null final String frmtStr
try agentUri new URI null _agentIp _port HOST_VM_STATE_REPORT_COMMAND null null catch final URISyntaxException e final String errMsg s_logger error errMsg e return null final String incomingCmd postHttpRequest agentUri if incomingCmd null return null ArrayList Map String String result null try result s_gson fromJson incomingCmd new TypeToken ArrayList HashMap String String getType catch final Exception ex final String errMsg incomingCmd
try final String cmdName StartupCommand class getName agentUri new URI null _agentIp _port cmdName null null catch final URISyntaxException e final String errMsg s_logger error errMsg e return null final String incomingCmd postHttpRequest s_gson toJson cmd agentUri if incomingCmd null return null Command result null try result s_gson fromJson incomingCmd Command class catch final Exception ex final String errMsg incomingCmd
URI agentUri null try final String cmdName cmd getClass getName agentUri new URI null _agentIp _port cmdName null null catch final URISyntaxException e final String errMsg s_logger error errMsg e return null cleanPassword cmd getSrcTO getDataStore cleanPassword cmd getDestTO getDataStore final String ansStr postHttpRequest s_gson toJson cmd agentUri if ansStr null return Answer createUnsupportedCommandAnswer cmd final Answer result s_gson fromJson ansStr Answer class final String logResult cleanPassword s_gson toJson result
private PlugNicAnswer execute final PlugNicCommand cmd if s_logger isInfoEnabled
private UnPlugNicAnswer execute final UnPlugNicCommand cmd if s_logger isInfoEnabled
if s_logger isInfoEnabled s_logger info s_gson toJson cmd try final String vmName cmd getVmName final NicTO nic cmd getNic final URI broadcastUri nic getBroadcastUri if BroadcastDomainType getSchemeValue broadcastUri BroadcastDomainType Vlan throw new InternalErrorException nic getBroadcastUri final String vlanId BroadcastDomainType getValue broadcastUri int publicNicInfo publicNicInfo getVmNics vmName vlanId if publicNicInfo modifyNicVlan vmName publicNicInfo false return new UnPlugNicAnswer cmd true catch final Exception e
Override public ExecutionResult executeInVR final String routerIP final String script final String args final Duration timeout Pair Boolean String result if s_logger isDebugEnabled
private ExecutionResult prepareNetworkElementCommand final IpAssocCommand cmd try final IpAddressTO ips cmd getIpAddresses final String routerName cmd getAccessDetail NetworkElementCommand ROUTER_NAME final String controlIp getRouterSshControlIp cmd for final IpAddressTO ip ips final URI broadcastUri BroadcastDomainType fromString ip getBroadcastUri if BroadcastDomainType getSchemeValue broadcastUri BroadcastDomainType Vlan throw new InternalErrorException ip getBroadcastUri final String vlanId BroadcastDomainType getValue broadcastUri int publicNicInfo publicNicInfo getVmNics routerName vlanId boolean addVif false if ip isAdd publicNicInfo if s_logger isDebugEnabled
for final IpAddressTO ip ips final URI broadcastUri BroadcastDomainType fromString ip getBroadcastUri if BroadcastDomainType getSchemeValue broadcastUri BroadcastDomainType Vlan throw new InternalErrorException ip getBroadcastUri final String vlanId BroadcastDomainType getValue broadcastUri int publicNicInfo publicNicInfo getVmNics routerName vlanId if publicNicInfo if ip isAdd throw new InternalErrorException else s_logger debug continue ip setNicDevId publicNicInfo catch final Exception e
protected Answer execute final RemoteAccessVpnCfgCommand cmd final String controlIp getRouterSshControlIp cmd final StringBuffer argsBuf new StringBuffer if cmd isCreate argsBuf append append cmd getIpRange append append cmd getPresharedKey append append cmd getVpnServerIp append append cmd getLocalIp append else argsBuf append append append cmd getVpnServerIp argsBuf append append cmd getLocalCidr argsBuf append append cmd getPublicInterface try final String command String format VRScripts VPN_L2TP argsBuf toString if s_logger isDebugEnabled s_logger debug command final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first
if cmd isCreate argsBuf append append cmd getIpRange append append cmd getPresharedKey append append cmd getVpnServerIp append append cmd getLocalIp append else argsBuf append append append cmd getVpnServerIp argsBuf append append cmd getLocalCidr argsBuf append append cmd getPublicInterface try final String command String format VRScripts VPN_L2TP argsBuf toString if s_logger isDebugEnabled s_logger debug command final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error result second return new Answer cmd false result second if s_logger isInfoEnabled
argsBuf append append cmd getLocalCidr argsBuf append append cmd getPublicInterface try final String command String format VRScripts VPN_L2TP argsBuf toString if s_logger isDebugEnabled s_logger debug command final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error result second return new Answer cmd false result second if s_logger isInfoEnabled s_logger info argsBuf toString catch final Throwable e if e RemoteException s_logger warn e getMessage
if userpwd isAdd argsBuf append append userpwd getUsername else argsBuf append append userpwd getUsernamePassword try if s_logger isDebugEnabled s_logger debug final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null argsBuf toString if result first s_logger error result second return new Answer cmd false result second catch final Throwable e if e RemoteException s_logger warn e getMessage final String msg e getMessage
private SetStaticRouteAnswer execute final SetStaticRouteCommand cmd if s_logger isInfoEnabled
s_logger info s_gson toJson cmd boolean endResult true final String controlIp getRouterSshControlIp cmd String args final String results new String cmd getStaticRoutes length int i final String rules cmd generateSRouteRules final StringBuilder sb new StringBuilder for int j j rules length j sb append rules j append args sb toString final String command String format VRScripts VPC_STATIC_ROUTE args try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if s_logger isDebugEnabled
boolean endResult true final String controlIp getRouterSshControlIp cmd String args final String results new String cmd getStaticRoutes length int i final String rules cmd generateSRouteRules final StringBuilder sb new StringBuilder for int j j rules length j sb append rules j append args sb toString final String command String format VRScripts VPC_STATIC_ROUTE args try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if s_logger isDebugEnabled s_logger debug controlIp args
final StringBuilder sb new StringBuilder for int j j rules length j sb append rules j append args sb toString final String command String format VRScripts VPC_STATIC_ROUTE args try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if s_logger isDebugEnabled s_logger debug controlIp args if result first s_logger error args results i endResult false else results i null
protected CheckS2SVpnConnectionsAnswer execute final CheckS2SVpnConnectionsCommand cmd final StringBuilder cmdline new StringBuilder cmdline append cmdline append VRScripts S2SVPN_CHECK if s_logger isDebugEnabled
protected CheckS2SVpnConnectionsAnswer execute final CheckS2SVpnConnectionsCommand cmd final StringBuilder cmdline new StringBuilder cmdline append cmdline append VRScripts S2SVPN_CHECK if s_logger isDebugEnabled s_logger debug s_gson toJson cmd
protected CheckS2SVpnConnectionsAnswer execute final CheckS2SVpnConnectionsCommand cmd final StringBuilder cmdline new StringBuilder cmdline append cmdline append VRScripts S2SVPN_CHECK if s_logger isDebugEnabled s_logger debug s_gson toJson cmd s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP cmdline toString Pair Boolean String result try final String controlIp getRouterSshControlIp cmd for final String ip cmd getVpnIps cmdline append cmdline append ip result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null cmdline toString if result first
cmdline append VRScripts S2SVPN_CHECK if s_logger isDebugEnabled s_logger debug s_gson toJson cmd s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP cmdline toString Pair Boolean String result try final String controlIp getRouterSshControlIp cmd for final String ip cmd getVpnIps cmdline append cmdline append ip result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null cmdline toString if result first s_logger error cmd getAccessDetail NetworkElementCommand ROUTER_IP result second return new CheckS2SVpnConnectionsAnswer cmd false result second if s_logger isDebugEnabled
s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP cmdline toString Pair Boolean String result try final String controlIp getRouterSshControlIp cmd for final String ip cmd getVpnIps cmdline append cmdline append ip result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null cmdline toString if result first s_logger error cmd getAccessDetail NetworkElementCommand ROUTER_IP result second return new CheckS2SVpnConnectionsAnswer cmd false result second if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP catch final Throwable e final String msg e
protected Answer execute final Site2SiteVpnCfgCommand cmd if s_logger isInfoEnabled
args else args else args args args cmd getPeerGatewayIp args args cmd getLocalGuestCidr args args cmd getPeerGuestCidrList Pair Boolean String result try final String command String format VRScripts S2SVPN_IPSEC args result SshHelper sshExecute routerIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command
args else args args args cmd getPeerGatewayIp args args cmd getLocalGuestCidr args args cmd getPeerGuestCidrList Pair Boolean String result try final String command String format VRScripts S2SVPN_IPSEC args result SshHelper sshExecute routerIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error cmd getAccessDetail NetworkElementCommand ROUTER_IP result second
protected SetSourceNatAnswer execute final SetSourceNatCommand cmd if s_logger isInfoEnabled
final String routerName cmd getAccessDetail NetworkElementCommand ROUTER_NAME final String routerIp getRouterSshControlIp cmd final IpAddressTO pubIp cmd getIpAddress try final int ethDeviceNum findRouterEthDeviceIndex routerName routerIp pubIp getVifMacAddress String args args args args pubIp getPublicIp args args ethDeviceNum final String command String format VRScripts VPC_SOURCE_NAT args final Pair Boolean String result SshHelper sshExecute routerIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first final String msg routerIp result second
final int ethDeviceNum findRouterEthDeviceIndex routerName routerIp pubIp getVifMacAddress String args args args args pubIp getPublicIp args args ethDeviceNum final String command String format VRScripts VPC_SOURCE_NAT args final Pair Boolean String result SshHelper sshExecute routerIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first final String msg routerIp result second s_logger error msg return new SetSourceNatAnswer cmd false msg return new SetSourceNatAnswer cmd true catch final Exception e
protected Answer execute final SetPortForwardingRulesCommand cmd if s_logger isInfoEnabled
final String controlIp getRouterSshControlIp cmd String args final String results new String cmd getRules length int i boolean endResult true for final PortForwardingRuleTO rule cmd getRules args rule revoked args rule getProtocol toLowerCase args rule getSrcIp args rule getStringSrcPortRange args rule getDstIp args rule getStringDstPortRange try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled
String args final String results new String cmd getRules length int i boolean endResult true for final PortForwardingRuleTO rule cmd getRules args rule revoked args rule getProtocol toLowerCase args rule getSrcIp args rule getStringSrcPortRange args rule getDstIp args rule getStringDstPortRange try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled s_logger debug controlIp args
args rule getProtocol toLowerCase args rule getSrcIp args rule getStringSrcPortRange args rule getDstIp args rule getStringDstPortRange try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled s_logger debug controlIp args if result first s_logger error args results i endResult false else results i null
protected Answer execute final CheckRouterCommand cmd final String command String format VRScripts RVR_CHECK if s_logger isDebugEnabled
protected Answer execute final CheckRouterCommand cmd final String command String format VRScripts RVR_CHECK if s_logger isDebugEnabled s_logger debug s_gson toJson cmd
final String command String format VRScripts RVR_CHECK if s_logger isDebugEnabled s_logger debug s_gson toJson cmd s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP command Pair Boolean String result try final String controlIp getRouterSshControlIp cmd result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error cmd getAccessDetail NetworkElementCommand ROUTER_IP result second return new CheckRouterAnswer cmd result second if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP catch final Throwable e final String msg e getMessage
String args null final String results new String cmd getRules length int i boolean endResult true for final StaticNatRuleTO rule cmd getRules args rule revoked args rule getSrcIp args rule getDstIp if rule getProtocol null args rule getProtocol toLowerCase args rule getStringSrcPortRange args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args
final String results new String cmd getRules length int i boolean endResult true for final StaticNatRuleTO rule cmd getRules args rule revoked args rule getSrcIp args rule getDstIp if rule getProtocol null args rule getProtocol toLowerCase args rule getStringSrcPortRange args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled
args rule getDstIp if rule getProtocol null args rule getProtocol toLowerCase args rule getStringSrcPortRange args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled s_logger debug controlIp args if result first s_logger error args results i endResult false else
protected Answer execute final PingTestCommand cmd if s_logger isInfoEnabled
protected Answer execute final DeleteIpAliasCommand cmd cmd getAccessDetail NetworkElementCommand ROUTER_IP final List IpAliasTO revokedIpAliasTOs cmd getDeleteIpAliasTos final List IpAliasTO activeIpAliasTOs cmd getCreateIpAliasTos if s_logger isInfoEnabled
for final IpAliasTO ipAliasTO revokedIpAliasTOs args append ipAliasTO getAlias_count args append args append ipAliasTO getRouterip args append args append ipAliasTO getNetmask args append args append for final IpAliasTO ipAliasTO activeIpAliasTOs args append ipAliasTO getAlias_count args append args append ipAliasTO getRouterip args append args append ipAliasTO getNetmask args append
args append ipAliasTO getNetmask args append args append for final IpAliasTO ipAliasTO activeIpAliasTOs args append ipAliasTO getAlias_count args append args append ipAliasTO getRouterip args append args append ipAliasTO getNetmask args append if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args
args append for final IpAliasTO ipAliasTO activeIpAliasTOs args append ipAliasTO getAlias_count args append args append ipAliasTO getRouterip args append args append ipAliasTO getNetmask args append if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if result first s_logger error controlIp result second
protected Answer execute final SavePasswordCommand cmd if s_logger isInfoEnabled
if s_logger isInfoEnabled s_logger info cmd getVmName cmd getVmIpAddress StringUtils getMaskedPasswordForDisplay cmd getPassword final String controlIp getRouterSshControlIp cmd final String password cmd getPassword final String vmIpAddress cmd getVmIpAddress final String command String format VRScripts PASSWORD vmIpAddress password if s_logger isDebugEnabled final String debugCommand String format VRScripts PASSWORD vmIpAddress StringUtils getMaskedPasswordForDisplay cmd getPassword s_logger debug controlIp debugCommand try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error controlIp result second return new Answer cmd false result second if s_logger isInfoEnabled
final String controlIp getRouterSshControlIp cmd final String password cmd getPassword final String vmIpAddress cmd getVmIpAddress final String command String format VRScripts PASSWORD vmIpAddress password if s_logger isDebugEnabled final String debugCommand String format VRScripts PASSWORD vmIpAddress StringUtils getMaskedPasswordForDisplay cmd getPassword s_logger debug controlIp debugCommand try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error controlIp result second return new Answer cmd false result second if s_logger isInfoEnabled s_logger info controlIp catch final Throwable e
else args final StringBuilder sb new StringBuilder final String fwRules rules if fwRules length for int i i fwRules length i sb append fwRules i append args sb toString try Pair Boolean String result null if trafficType FirewallRule TrafficType Egress result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args else result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled
args final StringBuilder sb new StringBuilder final String fwRules rules if fwRules length for int i i fwRules length i sb append fwRules i append args sb toString try Pair Boolean String result null if trafficType FirewallRule TrafficType Egress result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args else result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled if trafficType FirewallRule TrafficType Egress
final StringBuilder sb new StringBuilder final String fwRules rules if fwRules length for int i i fwRules length i sb append fwRules i append args sb toString try Pair Boolean String result null if trafficType FirewallRule TrafficType Egress result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args else result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled if trafficType FirewallRule TrafficType Egress s_logger debug controlIp args
sb append fwRules i append args sb toString try Pair Boolean String result null if trafficType FirewallRule TrafficType Egress result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args else result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if s_logger isDebugEnabled if trafficType FirewallRule TrafficType Egress s_logger debug controlIp args else s_logger debug controlIp args if result first s_logger error args
protected Answer execute final VmDataCommand cmd if s_logger isInfoEnabled
if s_logger isInfoEnabled s_logger info s_gson toJson cmd final String controlIp getRouterSshControlIp cmd final Map String List String data new HashMap String List String data put cmd getVmIpAddress cmd getVmData String json new Gson toJson data s_logger debug json json Base64 encodeBase64String json getBytes Charset forName final String command String format VRScripts VMDATA json try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error controlIp result second return new Answer cmd false result second if s_logger isInfoEnabled
final String controlIp getRouterSshControlIp cmd final Map String List String data new HashMap String List String data put cmd getVmIpAddress cmd getVmData String json new Gson toJson data s_logger debug json json Base64 encodeBase64String json getBytes Charset forName final String command String format VRScripts VMDATA json try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error controlIp result second return new Answer cmd false result second if s_logger isInfoEnabled s_logger info controlIp catch final Throwable e
protected Answer execute final DhcpEntryCommand cmd if s_logger isInfoEnabled
if cmd getVmIpAddress null args cmd getVmIpAddress args cmd getVmName if cmd getDefaultRouter null args cmd getDefaultRouter if cmd getDefaultDns null args cmd getDefaultDns if cmd getStaticRoutes null args cmd getStaticRoutes if cmd getVmIp6Address null args cmd getVmIp6Address args cmd getDuid if cmd isDefault args final String command String format VRScripts DHCP args
args cmd getDefaultRouter if cmd getDefaultDns null args cmd getDefaultDns if cmd getStaticRoutes null args cmd getStaticRoutes if cmd getVmIp6Address null args cmd getVmIp6Address args cmd getDuid if cmd isDefault args final String command String format VRScripts DHCP args if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP command try final String controlIp getRouterSshControlIp cmd
args cmd getDefaultDns if cmd getStaticRoutes null args cmd getStaticRoutes if cmd getVmIp6Address null args cmd getVmIp6Address args cmd getDuid if cmd isDefault args final String command String format VRScripts DHCP args if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP command try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first
protected Answer execute final CreateIpAliasCommand cmd if s_logger isInfoEnabled
cmd getAccessDetail NetworkElementCommand ROUTER_IP final List IpAliasTO ipAliasTOs cmd getIpAliasList final StringBuilder args new StringBuilder for final IpAliasTO ipaliasto ipAliasTOs args append ipaliasto getAlias_count args append args append ipaliasto getRouterip args append args append ipaliasto getNetmask args append if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args
for final IpAliasTO ipaliasto ipAliasTOs args append ipaliasto getAlias_count args append args append ipaliasto getRouterip args append args append ipaliasto getNetmask args append if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if result first s_logger error controlIp result second return new Answer cmd false result second
args append ipaliasto getRouterip args append args append ipaliasto getNetmask args append if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP args try final String controlIp getRouterSshControlIp cmd final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if result first s_logger error controlIp result second return new Answer cmd false result second if s_logger isInfoEnabled s_logger info controlIp catch final Throwable e
private int findRouterEthDeviceIndex final String domrName final String routerIp final String mac throws Exception
private int findRouterEthDeviceIndex final String domrName final String routerIp final String mac throws Exception s_logger info mac final Pair Boolean String result SshHelper sshExecute routerIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null final long startTick System currentTimeMillis while System currentTimeMillis startTick if result first final String tokens result second split for final String token tokens if equalsIgnoreCase token equalsIgnoreCase token equalsIgnoreCase token final String cmd String format token if s_logger isDebugEnabled
private Pair Integer String findRouterFreeEthDeviceIndex final String routerIp throws Exception s_logger info final Pair Boolean String result SshHelper sshExecute routerIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null final long startTick System currentTimeMillis while System currentTimeMillis startTick if result first result second isEmpty final String tokens result second split for final String token tokens if equalsIgnoreCase token equalsIgnoreCase token equalsIgnoreCase token final String cmd String format token if s_logger isDebugEnabled
protected Answer execute final IpAssocCommand cmd if s_logger isInfoEnabled
protected Answer execute final IpAssocCommand cmd if s_logger isInfoEnabled s_logger info s_gson toJson cmd int i final String results new String cmd getIpAddresses length try final IpAddressTO ips cmd getIpAddresses final String routerName cmd getAccessDetail NetworkElementCommand ROUTER_NAME final String controlIp getRouterSshControlIp cmd for final IpAddressTO ip ips assignPublicIpAddress routerName controlIp ip getPublicIp ip isAdd ip isFirstIP ip isSourceNat ip getBroadcastUri ip getVlanGateway ip getVlanNetmask ip getVifMacAddress results i ip getPublicIp for i cmd getIpAddresses length i results i IpAssocAnswer errorResult catch final Throwable e
protected Answer execute final GetDomRVersionCmd cmd final String command String format VRScripts VERSION if s_logger isDebugEnabled
protected Answer execute final GetDomRVersionCmd cmd final String command String format VRScripts VERSION if s_logger isDebugEnabled s_logger debug s_gson toJson cmd
final String command String format VRScripts VERSION if s_logger isDebugEnabled s_logger debug s_gson toJson cmd s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP command Pair Boolean String result try final String controlIp getRouterSshControlIp cmd result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first s_logger error cmd getAccessDetail NetworkElementCommand ROUTER_IP result second return new GetDomRVersionAnswer cmd result second if s_logger isDebugEnabled s_logger debug cmd getAccessDetail NetworkElementCommand ROUTER_IP catch final Throwable e final String msg e
private static String getRouterSshControlIp final NetworkElementCommand cmd final String routerIp cmd getAccessDetail NetworkElementCommand ROUTER_IP final String routerGuestIp cmd getAccessDetail NetworkElementCommand ROUTER_GUEST_IP final String zoneNetworkType cmd getAccessDetail NetworkElementCommand ZONE_NETWORK_TYPE if routerGuestIp null zoneNetworkType null NetworkType valueOf zoneNetworkType NetworkType Basic if s_logger isDebugEnabled
protected Answer execute final SetMonitorServiceCommand cmd if s_logger isInfoEnabled
final String controlIp getRouterSshControlIp cmd final String config cmd getConfiguration if org apache commons lang StringUtils isBlank config s_logger error return new Answer cmd false final String args String format config final String command String format VRScripts MONITOR_SERVICE args try final Pair Boolean String result SshHelper sshExecute controlIp DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null command if result first final String msg controlIp result second s_logger error msg return new Answer cmd false msg return new Answer cmd catch final Throwable e
protected CheckSshAnswer execute final CheckSshCommand cmd final String vmName cmd getName final String privateIp cmd getIp final int cmdPort cmd getPort if s_logger isDebugEnabled
protected CheckSshAnswer execute final CheckSshCommand cmd final String vmName cmd getName final String privateIp cmd getIp final int cmdPort cmd getPort if s_logger isDebugEnabled s_logger debug privateIp cmdPort try final String result connect cmd getName privateIp cmdPort if result null s_logger error vmName result return new CheckSshAnswer cmd vmName result catch final Exception e s_logger error vmName return new CheckSshAnswer cmd e if s_logger isDebugEnabled
final int cmdPort cmd getPort if s_logger isDebugEnabled s_logger debug privateIp cmdPort try final String result connect cmd getName privateIp cmdPort if result null s_logger error vmName result return new CheckSshAnswer cmd vmName result catch final Exception e s_logger error vmName return new CheckSshAnswer cmd e if s_logger isDebugEnabled s_logger debug vmName if VirtualMachineName isValidRouterName vmName if s_logger isDebugEnabled
else if option equals args else if option equals args args ethName else if option equals args args ethName try if s_logger isTraceEnabled s_logger trace args privateIpAddress final Pair Boolean String result SshHelper sshExecute privateIpAddress DEFAULT_DOMR_SSHPORT getSystemVMKeyFile null args if result first return null return result second
public static String postHttpRequest final String jsonCmd final URI agentUri String logMessage StringEscapeUtils unescapeJava jsonCmd logMessage cleanPassword logMessage
String logMessage StringEscapeUtils unescapeJava jsonCmd logMessage cleanPassword logMessage s_logger debug agentUri toString logMessage HttpClient httpClient null final TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted final X509Certificate chain final String authType throws CertificateException return true try final SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier final SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_AGENT_PORT sf final ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch final KeyManagementException e
s_logger debug agentUri toString logMessage HttpClient httpClient null final TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted final X509Certificate chain final String authType throws CertificateException return true try final SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier final SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_AGENT_PORT sf final ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch final KeyManagementException e s_logger error e getMessage catch final UnrecoverableKeyException e
final TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted final X509Certificate chain final String authType throws CertificateException return true try final SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier final SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_AGENT_PORT sf final ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch final KeyManagementException e s_logger error e getMessage catch final UnrecoverableKeyException e s_logger error e getMessage catch final NoSuchAlgorithmException e
return true try final SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier final SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_AGENT_PORT sf final ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch final KeyManagementException e s_logger error e getMessage catch final UnrecoverableKeyException e s_logger error e getMessage catch final NoSuchAlgorithmException e s_logger error e getMessage catch final KeyStoreException e
registry register new Scheme DEFAULT_AGENT_PORT sf final ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch final KeyManagementException e s_logger error e getMessage catch final UnrecoverableKeyException e s_logger error e getMessage catch final NoSuchAlgorithmException e s_logger error e getMessage catch final KeyStoreException e s_logger error e getMessage String result null try final HttpPost request new HttpPost agentUri final StringEntity cmdJson new StringEntity jsonCmd
s_logger error e getMessage catch final KeyStoreException e s_logger error e getMessage String result null try final HttpPost request new HttpPost agentUri final StringEntity cmdJson new StringEntity jsonCmd request addHeader request setEntity cmdJson s_logger debug agentUri toString logMessage final HttpResponse response httpClient execute request if response getStatusLine getStatusCode HttpStatus SC_NOT_FOUND final String errMsg response getStatusLine getStatusCode s_logger error errMsg final String unsupportMsg agentUri getPath
protected String connect final String vmName final String ipAddress final int port final long startTick System currentTimeMillis int retry _retry while System currentTimeMillis startTick _opsTimeout retry
int retry _retry while System currentTimeMillis startTick _opsTimeout retry s_logger info ipAddress try SocketChannel sch SocketChannel open sch configureBlocking true sch socket setSoTimeout final InetSocketAddress addr new InetSocketAddress ipAddress port sch connect addr return null catch final IOException e s_logger info ipAddress e toString if e ConnectException try Thread sleep catch final InterruptedException ex
VolumeTO volumeTo new VolumeTO volume storagePoolDao findById volume getPoolId StorageFilerTO filerTo new StorageFilerTO StoragePool entry getValue volumeToFilerto add new Pair VolumeTO StorageFilerTO volumeTo filerTo MigrateWithStorageCommand command new MigrateWithStorageCommand to volumeToFilerto destHost getPrivateIpAddress MigrateWithStorageAnswer answer MigrateWithStorageAnswer agentMgr send srcHost getId command if answer null s_logger error vm throw new CloudRuntimeException vm destHost else if answer getResult s_logger error vm answer getDetails throw new CloudRuntimeException vm destHost answer getDetails else updateVolumePathsAfterMigration volumeToPool answer getVolumeTos return answer catch OperationTimedoutException e
if volume getId volumeTo getId VolumeVO volumeVO volDao findById volume getId Long oldPoolId volumeVO getPoolId volumeVO setPath volumeTo getPath volumeVO setPodId pool getPodId volumeVO setPoolId pool getId volumeVO setLastPoolId oldPoolId String folder pool getPath if pool getPoolType StoragePoolType SMB folder null folder contains folder folder substring folder indexOf volumeVO setFolder folder volDao update volume getId volumeVO updated true break if updated
public final void testStartupCommand StartupRoutingCommand defaultStartRoutCmd new StartupRoutingCommand null Hypervisor HypervisorType Hyperv RouterPrivateIpStrategy HostLocal defaultStartRoutCmd setDataCenter defaultStartRoutCmd setPod defaultStartRoutCmd setCluster defaultStartRoutCmd setGuid defaultStartRoutCmd setName defaultStartRoutCmd setPrivateIpAddress defaultStartRoutCmd setStorageIpAddress defaultStartRoutCmd setCpus defaultStartRoutCmd setVersion StartupCommand scmd defaultStartRoutCmd Command cmds scmd String cmdsStr s_gson toJson cmds
StartupRoutingCommand defaultStartRoutCmd new StartupRoutingCommand null Hypervisor HypervisorType Hyperv RouterPrivateIpStrategy HostLocal defaultStartRoutCmd setDataCenter defaultStartRoutCmd setPod defaultStartRoutCmd setCluster defaultStartRoutCmd setGuid defaultStartRoutCmd setName defaultStartRoutCmd setPrivateIpAddress defaultStartRoutCmd setStorageIpAddress defaultStartRoutCmd setCpus defaultStartRoutCmd setVersion StartupCommand scmd defaultStartRoutCmd Command cmds scmd String cmdsStr s_gson toJson cmds s_logger debug cmdsStr Command result s_gson fromJson cmdsStr Command class
public final void testJson StartupStorageCommand sscmd null com cloud agent api StoragePoolInfo pi new com cloud agent api StoragePoolInfo StoragePoolType Filesystem 100L 50L sscmd new StartupStorageCommand sscmd setPoolInfo pi sscmd setGuid pi getUuid sscmd setDataCenter sscmd setResourceType Storage StorageResourceType STORAGE_POOL
Test public final void testCreateStoragePoolCommand String folderName File separator StoragePoolVO pool createTestStoragePoolVO folderName CreateStoragePoolCommand cmd new CreateStoragePoolCommand true pool
private void corePrimaryStorageDownloadCommandTestCycle final PrimaryStorageDownloadCommand cmd PrimaryStorageDownloadAnswer ans PrimaryStorageDownloadAnswer s_hypervresource executeRequest cmd if ans getResult
Test public final void testCreateCommand String sample s_testLocalStoreUUID s_testLocalStorePathJSON s_testSampleTemplateURLJSON File destDir new File s_testLocalStorePath Assert assertTrue destDir isDirectory File testSampleTemplateURLFile new File s_testLocalStorePath File separator s_gson fromJson s_testSampleTemplateURLJSON String class Assert assertTrue testSampleTemplateURLFile getPath testSampleTemplateURLFile exists int fileCount destDir listFiles length
private StartAnswer simpleVmStart final String sample StartCommand cmd s_gson fromJson sample StartCommand class
Test public final void testGetStorageStatsCommand String sample s_testLocalStoreUUID s_testLocalStorePathJSON
List StoragePoolVO clusterPools _storagePoolDao listPoolsByCluster agent getClusterId boolean hasNfs false for StoragePoolVO pool clusterPools if pool getPoolType StoragePoolType NetworkFilesystem hasNfs true break if hasNfs s_logger warn agent return Status Disconnected Status hostStatus null Status neighbourStatus null CheckOnHostCommand cmd new CheckOnHostCommand agent try Answer answer _agentMgr easySend agent getId cmd if answer null
if hasNfs s_logger warn agent return Status Disconnected Status hostStatus null Status neighbourStatus null CheckOnHostCommand cmd new CheckOnHostCommand agent try Answer answer _agentMgr easySend agent getId cmd if answer null hostStatus answer getResult Status Down Status Up catch Exception e s_logger debug agent getId if hostStatus null hostStatus Status Disconnected List HostVO neighbors _resourceMgr listHostsInClusterByStatus agent getClusterId Status Up
Status hostStatus null Status neighbourStatus null CheckOnHostCommand cmd new CheckOnHostCommand agent try Answer answer _agentMgr easySend agent getId cmd if answer null hostStatus answer getResult Status Down Status Up catch Exception e s_logger debug agent getId if hostStatus null hostStatus Status Disconnected List HostVO neighbors _resourceMgr listHostsInClusterByStatus agent getClusterId Status Up for HostVO neighbor neighbors if neighbor getId agent getId neighbor getHypervisorType Hypervisor HypervisorType KVM neighbor getHypervisorType Hypervisor HypervisorType LXC continue
Answer answer _agentMgr easySend agent getId cmd if answer null hostStatus answer getResult Status Down Status Up catch Exception e s_logger debug agent getId if hostStatus null hostStatus Status Disconnected List HostVO neighbors _resourceMgr listHostsInClusterByStatus agent getClusterId Status Up for HostVO neighbor neighbors if neighbor getId agent getId neighbor getHypervisorType Hypervisor HypervisorType KVM neighbor getHypervisorType Hypervisor HypervisorType LXC continue s_logger debug agent getId neighbor getId try Answer answer _agentMgr easySend neighbor getId cmd if answer null
s_logger debug agent getId if hostStatus null hostStatus Status Disconnected List HostVO neighbors _resourceMgr listHostsInClusterByStatus agent getClusterId Status Up for HostVO neighbor neighbors if neighbor getId agent getId neighbor getHypervisorType Hypervisor HypervisorType KVM neighbor getHypervisorType Hypervisor HypervisorType LXC continue s_logger debug agent getId neighbor getId try Answer answer _agentMgr easySend neighbor getId cmd if answer null neighbourStatus answer getResult Status Down Status Up s_logger debug neighbor getId neighbourStatus agent getId if neighbourStatus Status Up break
public void getPifs final File dir new File final File netdevs dir listFiles final List String bridges new ArrayList String for File netdev netdevs final File isbridge new File netdev getAbsolutePath final String netdevName netdev getName
public void getPifs final File dir new File final File netdevs dir listFiles final List String bridges new ArrayList String for File netdev netdevs final File isbridge new File netdev getAbsolutePath final String netdevName netdev getName s_logger debug netdev getAbsolutePath if isbridge exists
s_logger debug netdev getAbsolutePath if isbridge exists s_logger debug netdevName bridges add netdevName String guestBridgeName _libvirtComputingResource getGuestBridgeName String publicBridgeName _libvirtComputingResource getPublicBridgeName for final String bridge bridges s_logger debug bridge final String pif getPif bridge if _libvirtComputingResource isPublicBridge bridge _pifs put pif if guestBridgeName null bridge equals guestBridgeName _pifs put pif _pifs put bridge pif if _pifs get null
bridges add netdevName String guestBridgeName _libvirtComputingResource getGuestBridgeName String publicBridgeName _libvirtComputingResource getPublicBridgeName for final String bridge bridges s_logger debug bridge final String pif getPif bridge if _libvirtComputingResource isPublicBridge bridge _pifs put pif if guestBridgeName null bridge equals guestBridgeName _pifs put pif _pifs put bridge pif if _pifs get null s_logger debug guestBridgeName final File dev new File guestBridgeName if dev exists
String guestBridgeName _libvirtComputingResource getGuestBridgeName String publicBridgeName _libvirtComputingResource getPublicBridgeName for final String bridge bridges s_logger debug bridge final String pif getPif bridge if _libvirtComputingResource isPublicBridge bridge _pifs put pif if guestBridgeName null bridge equals guestBridgeName _pifs put pif _pifs put bridge pif if _pifs get null s_logger debug guestBridgeName final File dev new File guestBridgeName if dev exists s_logger debug guestBridgeName
s_logger debug bridge final String pif getPif bridge if _libvirtComputingResource isPublicBridge bridge _pifs put pif if guestBridgeName null bridge equals guestBridgeName _pifs put pif _pifs put bridge pif if _pifs get null s_logger debug guestBridgeName final File dev new File guestBridgeName if dev exists s_logger debug guestBridgeName _pifs put guestBridgeName if _pifs get null s_logger debug publicBridgeName
Override public LibvirtVMDef InterfaceDef plug NicTO nic String guestOsType String nicAdapter Map String String extraConfig throws InternalErrorException LibvirtException if s_logger isDebugEnabled
Override public LibvirtVMDef InterfaceDef plug NicTO nic String guestOsType String nicAdapter Map String String extraConfig throws InternalErrorException LibvirtException if s_logger isDebugEnabled s_logger debug nic if nicAdapter null nicAdapter isEmpty
LibvirtVMDef InterfaceDef intf new LibvirtVMDef InterfaceDef String vNetId null String protocol null if isBroadcastTypeVlanOrVxlan nic vNetId Networks BroadcastDomainType getValue nic getBroadcastUri protocol Networks BroadcastDomainType getSchemeValue nic getBroadcastUri scheme else if nic getBroadcastType Networks BroadcastDomainType Lswitch throw new InternalErrorException String trafficLabel nic getName Integer networkRateKBps if libvirtVersion networkRateKBps nic getNetworkRateMbps null nic getNetworkRateMbps intValue nic getNetworkRateMbps intValue if nic getType Networks TrafficType Guest if isBroadcastTypeVlanOrVxlan nic isValidProtocolAndVnetId vNetId protocol if trafficLabel null trafficLabel isEmpty
if trafficLabel null trafficLabel isEmpty s_logger debug trafficLabel String brName createVnetBr vNetId trafficLabel protocol intf defBridgeNet brName null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps else String brName createVnetBr vNetId protocol intf defBridgeNet brName null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps else String brname if trafficLabel null trafficLabel isEmpty brname trafficLabel else brname _bridges get intf defBridgeNet brname null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps else if nic getType Networks TrafficType Control
Pattern oldStyleBrNameRegex Pattern compile Pattern brNameRegex Pattern compile Matcher oldStyleBrNameMatcher oldStyleBrNameRegex matcher brName Matcher brNameMatcher brNameRegex matcher brName String pName null String vNetId null if oldStyleBrNameMatcher find pName vNetId oldStyleBrNameMatcher group else if brNameMatcher find if brNameMatcher group null brNameMatcher group isEmpty pName brNameMatcher group else pName vNetId brNameMatcher group
else pName vNetId brNameMatcher group if vNetId null vNetId isEmpty s_logger debug brName return String scriptPath null if cmdout null cmdout contains scriptPath _modifyVxlanPath else scriptPath _modifyVlanPath final Script command new Script scriptPath _timeout s_logger command add command add vNetId command add pName
vNetId Networks BroadcastDomainType getValue nic getBroadcastUri protocol Networks BroadcastDomainType getSchemeValue nic getBroadcastUri scheme String vlanId null String logicalSwitchUuid null if nic getBroadcastType Networks BroadcastDomainType Vlan vlanId Networks BroadcastDomainType getValue nic getBroadcastUri else if nic getBroadcastType Networks BroadcastDomainType Lswitch logicalSwitchUuid Networks BroadcastDomainType getValue nic getBroadcastUri else if nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId NetUtils getPrimaryPvlanFromUri nic getBroadcastUri String trafficLabel nic getName Integer networkRateKBps nic getNetworkRateMbps null nic getNetworkRateMbps intValue nic getNetworkRateMbps intValue if nic getType Networks TrafficType Guest if nic getBroadcastType Networks BroadcastDomainType Vlan nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId equalsIgnoreCase if trafficLabel null trafficLabel isEmpty
else if nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId NetUtils getPrimaryPvlanFromUri nic getBroadcastUri String trafficLabel nic getName Integer networkRateKBps nic getNetworkRateMbps null nic getNetworkRateMbps intValue nic getNetworkRateMbps intValue if nic getType Networks TrafficType Guest if nic getBroadcastType Networks BroadcastDomainType Vlan nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId equalsIgnoreCase if trafficLabel null trafficLabel isEmpty s_logger debug trafficLabel intf defEthernet nic getUuid substring nic getMac getGuestNicModel guestOsType nicAdapter _ivsIfUpPath networkRateKBps else throw new InternalErrorException else if nic getType Networks TrafficType Control createControlNetwork intf defBridgeNet _bridges get null nic getMac getGuestNicModel guestOsType nicAdapter else if nic getType Networks TrafficType Public
Pattern oldStyleBrNameRegex Pattern compile Pattern brNameRegex Pattern compile Matcher oldStyleBrNameMatcher oldStyleBrNameRegex matcher brName Matcher brNameMatcher brNameRegex matcher brName String pName null String vNetId null if oldStyleBrNameMatcher find pName vNetId oldStyleBrNameMatcher group else if brNameMatcher find if brNameMatcher group null brNameMatcher group isEmpty pName brNameMatcher group else pName vNetId brNameMatcher group
else pName vNetId brNameMatcher group if vNetId null vNetId isEmpty s_logger debug brName return String scriptPath null if cmdout null cmdout contains scriptPath _modifyVxlanPath else scriptPath _modifyVlanPath final Script command new Script scriptPath _timeout s_logger command add command add vNetId command add pName
public static String getGuestOsName String guestOsName String guestOS s_mapper get guestOsName if guestOS null
try pool LibvirtConnection getConnection storagePoolLookupByUUIDString storagePool _poolUUID if pool null StoragePoolInfo spi pool getInfo if spi state StoragePoolState VIR_STORAGE_POOL_RUNNING pool create else poolName pool getName catch LibvirtException e s_logger debug e finally try if pool null pool free catch LibvirtException e
Override public Boolean checkingHB List Boolean results new ArrayList Boolean for NfsStoragePool pool _pools Script cmd new Script s_heartBeatPath _heartBeatCheckerTimeout s_logger cmd add pool _poolIp cmd add pool _poolMountSourcePath cmd add pool _mountDestPath cmd add _hostIP cmd add cmd add String valueOf _heartBeatUpdateFreq OutputInterpreter OneLineParser parser new OutputInterpreter OneLineParser String result cmd execute parser
Override public Boolean checkingHB List Boolean results new ArrayList Boolean for NfsStoragePool pool _pools Script cmd new Script s_heartBeatPath _heartBeatCheckerTimeout s_logger cmd add pool _poolIp cmd add pool _poolMountSourcePath cmd add pool _mountDestPath cmd add _hostIP cmd add cmd add String valueOf _heartBeatUpdateFreq OutputInterpreter OneLineParser parser new OutputInterpreter OneLineParser String result cmd execute parser s_logger debug pool _poolIp
Override public Boolean checkingHB List Boolean results new ArrayList Boolean for NfsStoragePool pool _pools Script cmd new Script s_heartBeatPath _heartBeatCheckerTimeout s_logger cmd add pool _poolIp cmd add pool _poolMountSourcePath cmd add pool _mountDestPath cmd add _hostIP cmd add cmd add String valueOf _heartBeatUpdateFreq OutputInterpreter OneLineParser parser new OutputInterpreter OneLineParser String result cmd execute parser s_logger debug pool _poolIp s_logger debug result
Override public Boolean checkingHB Script cmd new Script vmActivityCheckPath activityScriptTimeout getStandardSeconds LOG cmd add nfsStoragePool _poolIp cmd add nfsStoragePool _poolMountSourcePath cmd add nfsStoragePool _mountDestPath cmd add hostIP cmd add volumeUuidList cmd add String valueOf String valueOf System currentTimeMillis cmd add String valueOf suspectTimeInSeconds OutputInterpreter OneLineParser parser new OutputInterpreter OneLineParser String result cmd execute parser
Override public Boolean checkingHB Script cmd new Script vmActivityCheckPath activityScriptTimeout getStandardSeconds LOG cmd add nfsStoragePool _poolIp cmd add nfsStoragePool _poolMountSourcePath cmd add nfsStoragePool _mountDestPath cmd add hostIP cmd add volumeUuidList cmd add String valueOf String valueOf System currentTimeMillis cmd add String valueOf suspectTimeInSeconds OutputInterpreter OneLineParser parser new OutputInterpreter OneLineParser String result cmd execute parser LOG debug nfsStoragePool _poolIp
Override public Boolean checkingHB Script cmd new Script vmActivityCheckPath activityScriptTimeout getStandardSeconds LOG cmd add nfsStoragePool _poolIp cmd add nfsStoragePool _poolMountSourcePath cmd add nfsStoragePool _mountDestPath cmd add hostIP cmd add volumeUuidList cmd add String valueOf String valueOf System currentTimeMillis cmd add String valueOf suspectTimeInSeconds OutputInterpreter OneLineParser parser new OutputInterpreter OneLineParser String result cmd execute parser LOG debug nfsStoragePool _poolIp LOG debug result
Override public ExecutionResult createFileInVR final String routerIp final String path final String filename final String content final File permKey new File boolean success true String details routerIp filename
value String params get if null value _agentHooksLibvirtXmlScript value s_logger debug _agentHooksLibvirtXmlScript value String params get if null value _agentHooksLibvirtXmlMethod value s_logger debug _agentHooksLibvirtXmlMethod value String params get if null value _agentHooksVmOnStartScript value s_logger debug _agentHooksVmOnStartScript value String params get if null value _agentHooksVmOnStartMethod value
private void getPifs final File dir new File final File netdevs dir listFiles final List String bridges new ArrayList String for int i i netdevs length i final File isbridge new File netdevs i getAbsolutePath final String netdevName netdevs i getName s_logger debug netdevs i getAbsolutePath if isbridge exists
if isbridge exists s_logger debug netdevName bridges add netdevName for final String bridge bridges s_logger debug bridge final String pif getPif bridge if isPublicBridge bridge _pifs put pif if isGuestBridge bridge _pifs put pif _pifs put bridge pif if _pifs get null s_logger debug _guestBridgeName final File dev new File _guestBridgeName if dev exists
s_logger debug bridge final String pif getPif bridge if isPublicBridge bridge _pifs put pif if isGuestBridge bridge _pifs put pif _pifs put bridge pif if _pifs get null s_logger debug _guestBridgeName final File dev new File _guestBridgeName if dev exists s_logger debug _guestBridgeName _pifs put _guestBridgeName if _pifs get null s_logger debug _publicBridgeName
private void getOvsPifs final String cmdout Script runSimpleBashScript
private void getOvsPifs final String cmdout Script runSimpleBashScript s_logger debug cmdout final List String bridges Arrays asList cmdout split for final String bridge bridges
private boolean checkOvsNetwork final String networkName
public boolean passCmdLine final String vmName final String cmdLine throws InternalErrorException final Script command new Script _patchScriptPath s_logger String result command add vmName command add cmdLine result command execute if result null
public synchronized boolean destroyTunnelNetwork final String bridge findOrCreateTunnelNetwork bridge final Script cmd new Script _ovsTunnelPath _timeout s_logger cmd add cmd add bridge final String result cmd execute if result null
KVMPhysicalDisk templateVol null KVMStoragePool secondaryPool null try secondaryPool _storagePoolMgr getStoragePoolByURI mountpoint if templateName null secondaryPool refresh final List KVMPhysicalDisk disks secondaryPool listPhysicalDisks if disks null disks isEmpty s_logger error secondaryPool getUuid return null for final KVMPhysicalDisk disk disks if disk getName endsWith templateVol disk break if templateVol null
private String getBroadcastUriFromBridge final String brName final String pif matchPifFileInDirectory brName final Pattern pattern Pattern compile final Matcher matcher pattern matcher pif
final Pattern pattern Pattern compile final Matcher matcher pattern matcher pif s_logger debug pif brName if matcher find if brName startsWith return BroadcastDomainType Vxlan toUri matcher group toString else if matcher group isEmpty return BroadcastDomainType Vlan toUri matcher group toString else if matcher group isEmpty return BroadcastDomainType Vlan toUri matcher group toString else s_logger debug brName pif return else
for final InterfaceDef pluggedNic pluggedNics final String pluggedVlanBr pluggedNic getBrName final String pluggedVlanId getBroadcastUriFromBridge pluggedVlanBr if pubVlan equalsIgnoreCase Vlan UNTAGGED pluggedVlanBr equalsIgnoreCase _publicBridgeName break else if pluggedVlanBr equalsIgnoreCase _linkLocalBridgeName else if pluggedVlanId null return new ExecutionResult false pluggedVlanBr pubVlan routerName else if pluggedVlanId equals pubVlan break devNum pubIP setNicDevId devNum return new ExecutionResult true catch final LibvirtException e final String msg e toString
Integer devNum macAddressToNicNumPair second final IpAddressTO ips cmd getIpAddresses int nicNum for final IpAddressTO ip ips boolean newNic false if macAddressToNicNum containsKey ip getVifMacAddress VifHotPlug conn routerName ip getBroadcastUri ip getVifMacAddress macAddressToNicNum put ip getVifMacAddress devNum newNic true nicNum macAddressToNicNum get ip getVifMacAddress networkUsage routerIp nicNum ip setNicDevId nicNum ip setNewNic newNic return new ExecutionResult true null catch final LibvirtException e
for final IpAddressTO ip ips boolean newNic false if macAddressToNicNum containsKey ip getVifMacAddress VifHotPlug conn routerName ip getBroadcastUri ip getVifMacAddress macAddressToNicNum put ip getVifMacAddress devNum newNic true nicNum macAddressToNicNum get ip getVifMacAddress networkUsage routerIp nicNum ip setNicDevId nicNum ip setNewNic newNic return new ExecutionResult true null catch final LibvirtException e s_logger error e return new ExecutionResult false e getMessage catch final InternalErrorException e
Pair Map String Integer Integer macAddressToNicNumPair getMacAddressToNicNumPair conn routerName final Map String Integer macAddressToNicNum macAddressToNicNumPair first Integer devNum macAddressToNicNumPair second final IpAddressTO ips cmd getIpAddresses int nicNum for final IpAddressTO ip ips if macAddressToNicNum containsKey ip getVifMacAddress VifHotPlug conn routerName ip getBroadcastUri ip getVifMacAddress macAddressToNicNum put ip getVifMacAddress devNum nicNum macAddressToNicNum get ip getVifMacAddress if org apache commons lang StringUtils equalsIgnoreCase lastIp ip isAdd if nicNum vifHotUnPlug conn routerName ip getVifMacAddress networkUsage routerIp nicNum catch final LibvirtException e
final IpAddressTO ips cmd getIpAddresses int nicNum for final IpAddressTO ip ips if macAddressToNicNum containsKey ip getVifMacAddress VifHotPlug conn routerName ip getBroadcastUri ip getVifMacAddress macAddressToNicNum put ip getVifMacAddress devNum nicNum macAddressToNicNum get ip getVifMacAddress if org apache commons lang StringUtils equalsIgnoreCase lastIp ip isAdd if nicNum vifHotUnPlug conn routerName ip getVifMacAddress networkUsage routerIp nicNum catch final LibvirtException e s_logger error e return new ExecutionResult false e getMessage catch final InternalErrorException e
getUsage add getUsage add privateIpAddress if option equals getUsage add else if option equals getUsage add else if option equals getUsage add else if option equals getUsage add vif else if option equals getUsage add vif final OutputInterpreter OneLineParser usageParser new OutputInterpreter OneLineParser final String result getUsage execute usageParser if result null
getUsage add publicIp if option equals getUsage add else if option equals getUsage add getUsage add vpcCIDR else if option equals getUsage add else if option equals getUsage add else if option equals getUsage add final OutputInterpreter OneLineParser usageParser new OutputInterpreter OneLineParser final String result getUsage execute usageParser if result null
protected void setQuotaAndPeriod VirtualMachineTO vmTO CpuTuneDef ctd if vmTO getLimitCpuUse vmTO getCpuQuotaPercentage null Double cpuQuotaPercentage vmTO getCpuQuotaPercentage int period CpuTuneDef DEFAULT_PERIOD int quota int period cpuQuotaPercentage if quota CpuTuneDef MIN_QUOTA
protected void setQuotaAndPeriod VirtualMachineTO vmTO CpuTuneDef ctd if vmTO getLimitCpuUse vmTO getCpuQuotaPercentage null Double cpuQuotaPercentage vmTO getCpuQuotaPercentage int period CpuTuneDef DEFAULT_PERIOD int quota int period cpuQuotaPercentage if quota CpuTuneDef MIN_QUOTA s_logger info quota CpuTuneDef MIN_QUOTA vmTO getUuid quota CpuTuneDef MIN_QUOTA period int double quota cpuQuotaPercentage if period CpuTuneDef MAX_PERIOD
protected void enlightenWindowsVm VirtualMachineTO vmTO FeaturesDef features if vmTO getOs contains LibvirtVMDef HyperVEnlightenmentFeatureDef hyv new LibvirtVMDef HyperVEnlightenmentFeatureDef hyv setFeature true hyv setFeature true hyv setFeature true hyv setRetries features addHyperVFeature hyv
public boolean cleanupDisk final DiskDef disk final String path disk getDiskPath if path null
protected synchronized String attachOrDetachDevice final Connect conn final boolean attach final String vmName final String xml throws LibvirtException InternalErrorException Domain dm null try dm conn domainLookupByName vmName if attach
final HashMap String HostVmStateReportEntry vmStates new HashMap String HostVmStateReportEntry Connect conn null if _hypervisorType HypervisorType LXC try conn LibvirtConnection getConnectionByType HypervisorType LXC toString vmStates putAll getHostVmStateReport conn conn LibvirtConnection getConnectionByType HypervisorType KVM toString vmStates putAll getHostVmStateReport conn catch final LibvirtException e s_logger debug e getMessage if _hypervisorType HypervisorType KVM try conn LibvirtConnection getConnectionByType HypervisorType KVM toString vmStates putAll getHostVmStateReport conn catch final LibvirtException e
public String rebootVM final Connect conn final String vmName throws LibvirtException Domain dm null String msg null try dm conn domainLookupByName vmName String vmDef dm getXMLDesc final LibvirtDomainXMLParser parser new LibvirtDomainXMLParser parser parseDomainXML vmDef for final InterfaceDef nic parser getInterfaces if nic getNetType GuestNetType BRIDGE nic getBrName startsWith try final int vnetId Integer parseInt nic getBrName replaceFirst final String pifName getPif _guestBridgeName final String newBrName pifName vnetId vmDef vmDef replace nic getBrName newBrName
dm undefine else if dm isActive return null dm shutdown int retry _stopTimeout try while dm isActive retry Thread sleep retry catch final LibvirtException e final String error e toString if error contains s_logger debug vmName else
int retry _stopTimeout try while dm isActive retry Thread sleep retry catch final LibvirtException e final String error e toString if error contains s_logger debug vmName else s_logger debug error if retry s_logger warn vmName return Script ERR_TIMEOUT else
Thread sleep retry catch final LibvirtException e final String error e toString if error contains s_logger debug vmName else s_logger debug error if retry s_logger warn vmName return Script ERR_TIMEOUT else if persist dm undefine catch final LibvirtException e
public boolean applyDefaultNetworkRules final Connect conn final VirtualMachineTO vm final boolean checkBeforeApply NicTO nicTOs new NicTO if vm null vm getNics null
public boolean applyDefaultNetworkRules final Connect conn final VirtualMachineTO vm final boolean checkBeforeApply NicTO nicTOs new NicTO if vm null vm getNics null s_logger debug vm getName nicTOs vm getNics for NicTO nic nicTOs if vm getType VirtualMachine Type User nic setPxeDisable true boolean isFirstNic true for final NicTO nic nicTOs if nic isSecurityGroupEnabled nic getIsolationUri null nic getIsolationUri getScheme equalsIgnoreCase IsolationType Ec2 toString if vm getType VirtualMachine Type User configureDefaultNetworkRulesForSystemVm conn vm getName break if applyDefaultNetworkRulesOnNic conn vm getName vm getId nic isFirstNic checkBeforeApply
public List Ternary String Boolean String cleanVMSnapshotMetadata Domain dm throws LibvirtException
return vmsnapshots String currentSnapshotName null try DomainSnapshot snapshotCurrent dm snapshotCurrent String snapshotXML snapshotCurrent getXMLDesc snapshotCurrent free DocumentBuilder builder try builder DocumentBuilderFactory newInstance newDocumentBuilder InputSource is new InputSource is setCharacterStream new StringReader snapshotXML Document doc builder parse is Element rootElement doc getDocumentElement currentSnapshotName getTagValue rootElement catch ParserConfigurationException e
String currentSnapshotName null try DomainSnapshot snapshotCurrent dm snapshotCurrent String snapshotXML snapshotCurrent getXMLDesc snapshotCurrent free DocumentBuilder builder try builder DocumentBuilderFactory newInstance newDocumentBuilder InputSource is new InputSource is setCharacterStream new StringReader snapshotXML Document doc builder parse is Element rootElement doc getDocumentElement currentSnapshotName getTagValue rootElement catch ParserConfigurationException e s_logger debug e toString
DomainSnapshot snapshotCurrent dm snapshotCurrent String snapshotXML snapshotCurrent getXMLDesc snapshotCurrent free DocumentBuilder builder try builder DocumentBuilderFactory newInstance newDocumentBuilder InputSource is new InputSource is setCharacterStream new StringReader snapshotXML Document doc builder parse is Element rootElement doc getDocumentElement currentSnapshotName getTagValue rootElement catch ParserConfigurationException e s_logger debug e toString catch SAXException e s_logger debug e toString
public void restoreVMSnapshotMetadata Domain dm String vmName List Ternary String Boolean String vmsnapshots
public void restoreVMSnapshotMetadata Domain dm String vmName List Ternary String Boolean String vmsnapshots s_logger debug vmName for Ternary String Boolean String vmsnapshot vmsnapshots String snapshotName vmsnapshot first Boolean isCurrent vmsnapshot second String snapshotXML vmsnapshot third
static public Connect getConnection String hypervisorURI throws LibvirtException
static public Connect getConnection String hypervisorURI throws LibvirtException s_logger debug hypervisorURI Connect conn s_connections get hypervisorURI if conn null s_logger info conn new Connect hypervisorURI false
else if format null format equalsIgnoreCase int port String path getAttrValue source Element target Element rootElement getElementsByTagName item String targetPath getTagValue target String portValue getAttrValue source if portValue null portValue isEmpty port Integer parseInt portValue return new LibvirtStoragePoolDef LibvirtStoragePoolDef PoolType valueOf format toUpperCase poolName uuid host port path targetPath else String path getAttrValue source Element target Element rootElement getElementsByTagName item String targetPath getTagValue target return new LibvirtStoragePoolDef LibvirtStoragePoolDef PoolType valueOf type toUpperCase poolName uuid host path targetPath catch ParserConfigurationException e s_logger debug e toString
else if format null format equalsIgnoreCase int port String path getAttrValue source Element target Element rootElement getElementsByTagName item String targetPath getTagValue target String portValue getAttrValue source if portValue null portValue isEmpty port Integer parseInt portValue return new LibvirtStoragePoolDef LibvirtStoragePoolDef PoolType valueOf format toUpperCase poolName uuid host port path targetPath else String path getAttrValue source Element target Element rootElement getElementsByTagName item String targetPath getTagValue target return new LibvirtStoragePoolDef LibvirtStoragePoolDef PoolType valueOf type toUpperCase poolName uuid host path targetPath catch ParserConfigurationException e s_logger debug e toString
DocumentBuilder builder try builder DocumentBuilderFactory newInstance newDocumentBuilder InputSource is new InputSource is setCharacterStream new StringReader volXML Document doc builder parse is Element rootElement doc getDocumentElement String VolName getTagValue rootElement Element target Element rootElement getElementsByTagName item String format getAttrValue target Long capacity Long parseLong getTagValue rootElement return new LibvirtStorageVolumeDef VolName capacity LibvirtStorageVolumeDef VolumeFormat getFormat format null null catch ParserConfigurationException e s_logger debug e toString catch SAXException e
builder DocumentBuilderFactory newInstance newDocumentBuilder InputSource is new InputSource is setCharacterStream new StringReader volXML Document doc builder parse is Element rootElement doc getDocumentElement String VolName getTagValue rootElement Element target Element rootElement getElementsByTagName item String format getAttrValue target Long capacity Long parseLong getTagValue rootElement return new LibvirtStorageVolumeDef VolName capacity LibvirtStorageVolumeDef VolumeFormat getFormat format null null catch ParserConfigurationException e s_logger debug e toString catch SAXException e s_logger debug e toString catch IOException e
public void getPifs final String cmdout Script runSimpleBashScript
public void getPifs final String cmdout Script runSimpleBashScript s_logger debug cmdout final List String bridges Arrays asList cmdout split for final String bridge bridges
protected void plugDPDKInterface InterfaceDef intf String trafficLabel Map String String extraConfig String vlanId String guestOsType NicTO nic String nicAdapter
Override public InterfaceDef plug NicTO nic String guestOsType String nicAdapter Map String String extraConfig throws InternalErrorException LibvirtException
String vlanId null String logicalSwitchUuid null if nic getBroadcastType Networks BroadcastDomainType Vlan vlanId Networks BroadcastDomainType getValue nic getBroadcastUri else if nic getBroadcastType Networks BroadcastDomainType Lswitch logicalSwitchUuid Networks BroadcastDomainType getValue nic getBroadcastUri else if nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId NetUtils getPrimaryPvlanFromUri nic getBroadcastUri String trafficLabel nic getName if nic getType Networks TrafficType Guest Integer networkRateKBps nic getNetworkRateMbps null nic getNetworkRateMbps intValue nic getNetworkRateMbps intValue if nic getBroadcastType Networks BroadcastDomainType Vlan nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId equalsIgnoreCase if trafficLabel null trafficLabel isEmpty if _libvirtComputingResource dpdkSupport nic isDpdkEnabled plugDPDKInterface intf trafficLabel extraConfig vlanId guestOsType nic nicAdapter
else if nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId NetUtils getPrimaryPvlanFromUri nic getBroadcastUri String trafficLabel nic getName if nic getType Networks TrafficType Guest Integer networkRateKBps nic getNetworkRateMbps null nic getNetworkRateMbps intValue nic getNetworkRateMbps intValue if nic getBroadcastType Networks BroadcastDomainType Vlan nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId equalsIgnoreCase if trafficLabel null trafficLabel isEmpty if _libvirtComputingResource dpdkSupport nic isDpdkEnabled plugDPDKInterface intf trafficLabel extraConfig vlanId guestOsType nic nicAdapter else s_logger debug trafficLabel intf defBridgeNet _pifs get trafficLabel null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps intf setVlanTag Integer parseInt vlanId else intf defBridgeNet _pifs get null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps
if nic getBroadcastType Networks BroadcastDomainType Vlan nic getBroadcastType Networks BroadcastDomainType Pvlan vlanId equalsIgnoreCase if trafficLabel null trafficLabel isEmpty if _libvirtComputingResource dpdkSupport nic isDpdkEnabled plugDPDKInterface intf trafficLabel extraConfig vlanId guestOsType nic nicAdapter else s_logger debug trafficLabel intf defBridgeNet _pifs get trafficLabel null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps intf setVlanTag Integer parseInt vlanId else intf defBridgeNet _pifs get null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps intf setVlanTag Integer parseInt vlanId else if nic getBroadcastType Networks BroadcastDomainType Lswitch nic getBroadcastType Networks BroadcastDomainType OpenDaylight s_logger debug nic logicalSwitchUuid intf setVirtualPortInterfaceId nic getUuid String brName trafficLabel null trafficLabel isEmpty _pifs get trafficLabel _pifs get
else intf defBridgeNet _pifs get null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps intf setVlanTag Integer parseInt vlanId else if nic getBroadcastType Networks BroadcastDomainType Lswitch nic getBroadcastType Networks BroadcastDomainType OpenDaylight s_logger debug nic logicalSwitchUuid intf setVirtualPortInterfaceId nic getUuid String brName trafficLabel null trafficLabel isEmpty _pifs get trafficLabel _pifs get intf defBridgeNet brName null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps else if nic getBroadcastType Networks BroadcastDomainType Vswitch String vnetId Networks BroadcastDomainType getValue nic getBroadcastUri String brName vnetId s_logger debug nic brName intf defBridgeNet brName null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps else intf defBridgeNet _bridges get null nic getMac getGuestNicModel guestOsType nicAdapter networkRateKBps
Override public void unplug InterfaceDef iface if _libvirtComputingResource dpdkSupport StringUtils isNotBlank iface getDpdkSourcePort String dpdkPort iface getDpdkSourcePort String cmd String format dpdkPort
final OutputInterpreter AllLinesParser parser new OutputInterpreter AllLinesParser if Strings isNullOrEmpty payload script add payload s_logger info stage script output script execute parser parser getLines if script isTimeout String msg scriptFile s_logger error msg success false return new Pair false msg int exitValue script getExitValue if exitValue exitValueTerminatedSignal throw new CloudRuntimeException scriptFile success exitValue exitValue exitValueAvoidMaintenance setAvoidMaintenance exitValue exitValueAvoidMaintenance
script add payload s_logger info stage script output script execute parser parser getLines if script isTimeout String msg scriptFile s_logger error msg success false return new Pair false msg int exitValue script getExitValue if exitValue exitValueTerminatedSignal throw new CloudRuntimeException scriptFile success exitValue exitValue exitValueAvoidMaintenance setAvoidMaintenance exitValue exitValueAvoidMaintenance s_logger info stage script exitValue if s_logger isDebugEnabled
s_logger info stage script output script execute parser parser getLines if script isTimeout String msg scriptFile s_logger error msg success false return new Pair false msg int exitValue script getExitValue if exitValue exitValueTerminatedSignal throw new CloudRuntimeException scriptFile success exitValue exitValue exitValueAvoidMaintenance setAvoidMaintenance exitValue exitValueAvoidMaintenance s_logger info stage script exitValue if s_logger isDebugEnabled s_logger debug output
private String invokeService String action String stage String file String payload
Override public boolean isStageRunning String stage File scriptFile String payload String result invokeService stage scriptFile getAbsolutePath payload if StringUtils isNotBlank result result equals String status invokeService stage scriptFile getAbsolutePath payload String errorMsg stage status
secondaryStoragePool storagePoolMgr getStoragePoolByURI secondaryStoragePoolUrl final String ssPmountPath secondaryStoragePool getLocalPath snapshotRelPath File separator File separator dcId File separator accountId File separator volumeId snapshotDestPath ssPmountPath File separator File separator dcId File separator accountId File separator volumeId final KVMStoragePool primaryPool storagePoolMgr getStoragePool command getPool getType command getPrimaryStoragePoolNameLabel final KVMPhysicalDisk snapshotDisk primaryPool getPhysicalDisk command getVolumePath final String manageSnapshotPath libvirtComputingResource manageSnapshotPath final int cmdsTimeout libvirtComputingResource getCmdsTimeout if primaryPool getType StoragePoolType RBD try final Rados r new Rados primaryPool getAuthUserName r confSet primaryPool getSourceHost primaryPool getSourcePort r confSet primaryPool getAuthSecret r confSet r connect
if primaryPool getType StoragePoolType RBD try final Rados r new Rados primaryPool getAuthUserName r confSet primaryPool getSourceHost primaryPool getSourcePort r confSet primaryPool getAuthSecret r confSet r connect s_logger debug r confGet final IoCTX io r ioCtxCreate primaryPool getSourceDir final Rbd rbd new Rbd io final RbdImage image rbd open snapshotDisk getName snapshotName final File fh new File snapshotDestPath try BufferedOutputStream bos new BufferedOutputStream new FileOutputStream fh final int chunkSize long offset
final RbdImage image rbd open snapshotDisk getName snapshotName final File fh new File snapshotDestPath try BufferedOutputStream bos new BufferedOutputStream new FileOutputStream fh final int chunkSize long offset s_logger debug snapshotName snapshotDestPath while true final byte buf new byte chunkSize final int bytes image read offset buf chunkSize if bytes break bos write buf bytes offset bytes s_logger debug snapshotName snapshotDestPath toHumanReadableSize offset catch final IOException ex
final int chunkSize long offset s_logger debug snapshotName snapshotDestPath while true final byte buf new byte chunkSize final int bytes image read offset buf chunkSize if bytes break bos write buf bytes offset bytes s_logger debug snapshotName snapshotDestPath toHumanReadableSize offset catch final IOException ex s_logger error ex getMessage r ioCtxDestroy io catch final RadosException e
while true final byte buf new byte chunkSize final int bytes image read offset buf chunkSize if bytes break bos write buf bytes offset bytes s_logger debug snapshotName snapshotDestPath toHumanReadableSize offset catch final IOException ex s_logger error ex getMessage r ioCtxDestroy io catch final RadosException e s_logger error e getMessage return new BackupSnapshotAnswer command false e toString null true catch final RbdException e
Override public Answer execute final CheckSshCommand command final LibvirtComputingResource libvirtComputingResource final String vmName command getName final String privateIp command getIp final int cmdPort command getPort if s_logger isDebugEnabled
Override public Answer execute CheckStorageAvailabilityCommand command LibvirtComputingResource resource KVMStoragePoolManager storagePoolMgr resource getStoragePoolMgr Map String Storage StoragePoolType poolsMap command getPoolsMap for String poolUuid poolsMap keySet Storage StoragePoolType type poolsMap get poolUuid
Override public Answer execute CheckStorageAvailabilityCommand command LibvirtComputingResource resource KVMStoragePoolManager storagePoolMgr resource getStoragePoolMgr Map String Storage StoragePoolType poolsMap command getPoolsMap for String poolUuid poolsMap keySet Storage StoragePoolType type poolsMap get poolUuid s_logger debug poolUuid type try KVMStoragePool storagePool storagePoolMgr getStoragePool type poolUuid if storagePool null
Override public CheckUrlAnswer execute CheckUrlCommand cmd LibvirtComputingResource serverResource final String url cmd getUrl
String diagnosticsZipFile command getFileName String vmSshIp command getSystemVmIp String secondaryStorageUrl command getSecondaryStorageUrl KVMStoragePoolManager storagePoolMgr libvirtResource getStoragePoolMgr KVMStoragePool secondaryPool boolean success secondaryPool storagePoolMgr getStoragePoolByURI secondaryStorageUrl String mountPoint secondaryPool getLocalPath String dataDirectoryInSecondaryStore String format mountPoint DiagnosticsService DIAGNOSTICS_DIRECTORY try File dataDirectory new File dataDirectoryInSecondaryStore boolean existsInSecondaryStore dataDirectory exists dataDirectory mkdir Path path Paths get dataDirectory getAbsolutePath setDirFilePermissions path if existsInSecondaryStore
primary storagePoolMgr createStoragePool command getPool getUuid command getPool getHost command getPool getPort command getPool getPath command getPool getUserInfo command getPool getType else return new CreatePrivateTemplateAnswer command false e getMessage final KVMPhysicalDisk disk primary getPhysicalDisk command getVolumePath final String tmpltPath secondaryStorage getLocalPath File separator templateInstallFolder final StorageLayer storage libvirtComputingResource getStorage storage mkdirs tmpltPath if primary getType StoragePoolType RBD final String createTmplPath libvirtComputingResource createTmplPath final int cmdsTimeout libvirtComputingResource getCmdsTimeout final Script scriptCommand new Script createTmplPath cmdsTimeout s_logger scriptCommand add disk getPath scriptCommand add tmpltPath scriptCommand add command getUniqueName final String result scriptCommand execute
return new CreatePrivateTemplateAnswer command false e getMessage final KVMPhysicalDisk disk primary getPhysicalDisk command getVolumePath final String tmpltPath secondaryStorage getLocalPath File separator templateInstallFolder final StorageLayer storage libvirtComputingResource getStorage storage mkdirs tmpltPath if primary getType StoragePoolType RBD final String createTmplPath libvirtComputingResource createTmplPath final int cmdsTimeout libvirtComputingResource getCmdsTimeout final Script scriptCommand new Script createTmplPath cmdsTimeout s_logger scriptCommand add disk getPath scriptCommand add tmpltPath scriptCommand add command getUniqueName final String result scriptCommand execute if result null s_logger debug result
final int cmdsTimeout libvirtComputingResource getCmdsTimeout final Script scriptCommand new Script createTmplPath cmdsTimeout s_logger scriptCommand add disk getPath scriptCommand add tmpltPath scriptCommand add command getUniqueName final String result scriptCommand execute if result null s_logger debug result return new CreatePrivateTemplateAnswer command false result else s_logger debug disk getPath command getUniqueName final QemuImgFile srcFile new QemuImgFile KVMPhysicalDisk RBDStringBuilder primary getSourceHost primary getSourcePort primary getAuthUserName primary getAuthSecret disk getPath srcFile setFormat PhysicalDiskFormat RAW final QemuImgFile destFile new QemuImgFile tmpltPath command getUniqueName destFile setFormat PhysicalDiskFormat QCOW2
Override public Answer execute final DeleteVMSnapshotCommand cmd final LibvirtComputingResource libvirtComputingResource String vmName cmd getVmName final KVMStoragePoolManager storagePoolMgr libvirtComputingResource getStoragePoolMgr Domain dm null DomainSnapshot snapshot null try final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper Connect conn libvirtUtilitiesHelper getConnection dm libvirtComputingResource getDomain conn vmName snapshot dm snapshotLookupByName cmd getTarget getSnapshotName
final KVMStoragePoolManager storagePoolMgr libvirtComputingResource getStoragePoolMgr Domain dm null DomainSnapshot snapshot null try final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper Connect conn libvirtUtilitiesHelper getConnection dm libvirtComputingResource getDomain conn vmName snapshot dm snapshotLookupByName cmd getTarget getSnapshotName s_logger debug vmName dm suspend snapshot delete return new DeleteVMSnapshotAnswer cmd cmd getVolumeTOs catch LibvirtException e String msg e toString if dm null
String qemu_img_snapshot Script runSimpleBashScript rootDisk getPath cmd getTarget getSnapshotName if qemu_img_snapshot null s_logger info cmd getTarget getSnapshotName rootDisk getPath return new DeleteVMSnapshotAnswer cmd cmd getVolumeTOs int result Script runSimpleBashScriptForExitValue cmd getTarget getSnapshotName rootDisk getPath if result return new DeleteVMSnapshotAnswer cmd false rootDisk getPath result else return new DeleteVMSnapshotAnswer cmd cmd getVolumeTOs else if snapshot null s_logger debug cmd getTarget getSnapshotName vmName return new DeleteVMSnapshotAnswer cmd cmd getVolumeTOs s_logger warn msg e return new DeleteVMSnapshotAnswer cmd false msg finally
final List String vmNames command getVmNames final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper try final HashMap String List VmDiskStatsEntry vmDiskStatsNameMap new HashMap String List VmDiskStatsEntry final Connect conn libvirtUtilitiesHelper getConnection for final String vmName vmNames try final List VmDiskStatsEntry statEntry libvirtComputingResource getVmDiskStat conn vmName if statEntry null continue vmDiskStatsNameMap put vmName statEntry catch LibvirtException e s_logger warn e toString return new GetVmDiskStatsAnswer command command getHostName vmDiskStatsNameMap catch final LibvirtException e
boolean result false String networkCidr command getVmNetworkCidr if command isWindows String leasesList Script runSimpleBashScript new StringBuilder append append command getVmName append toString if leasesList null String leasesFiles leasesList split for String leaseFile leasesFiles String ipAddr Script runSimpleBashScript new StringBuilder append append command getVmName append leaseFile toString if ipAddr null NetUtils isIpWithInCidrRange ipAddr networkCidr ip ipAddr break s_logger debug command getVmName ipAddr networkCidr else String ipList Script runSimpleBashScript new StringBuilder append append command getVmName append toString if ipList null
ip ipAddr break s_logger debug command getVmName ipAddr networkCidr else String ipList Script runSimpleBashScript new StringBuilder append append command getVmName append toString if ipList null s_logger debug command getVmName ipList String ips ipList split for String ipAddr ips if ipAddr null NetUtils isIpWithInCidrRange ipAddr networkCidr ip ipAddr break s_logger debug command getVmName ipAddr networkCidr if ip null result true
final List String vmNames command getVmNames final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper try final HashMap String List VmNetworkStatsEntry vmNetworkStatsNameMap new HashMap String List VmNetworkStatsEntry final Connect conn libvirtUtilitiesHelper getConnection for final String vmName vmNames try final List VmNetworkStatsEntry statEntry libvirtComputingResource getVmNetworkStat conn vmName if statEntry null continue vmNetworkStatsNameMap put vmName statEntry catch LibvirtException e s_logger warn e toString return new GetVmNetworkStatsAnswer command command getHostName vmNetworkStatsNameMap catch final LibvirtException e
final List String vmNames command getVmNames try final HashMap String VmStatsEntry vmStatsNameMap new HashMap String VmStatsEntry for final String vmName vmNames final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper final Connect conn libvirtUtilitiesHelper getConnectionByVmName vmName try final VmStatsEntry statEntry libvirtComputingResource getVmStat conn vmName if statEntry null continue vmStatsNameMap put vmName statEntry catch LibvirtException e s_logger warn e toString return new GetVmStatsAnswer command vmStatsNameMap catch final LibvirtException e
if vmName null try vm libvirtComputingResource getDomain conn command getVmName state vm getInfo state catch final LibvirtException e s_logger trace e final KVMStoragePoolManager storagePoolMgr libvirtComputingResource getStoragePoolMgr final StorageFilerTO pool command getPool final KVMStoragePool primaryPool storagePoolMgr getStoragePool pool getType pool getUuid final KVMPhysicalDisk disk primaryPool getPhysicalDisk command getVolumePath if state DomainState VIR_DOMAIN_RUNNING primaryPool isExternalSnapshot final MessageFormat snapshotXML new MessageFormat final String vmUuid vm getUUIDString final Object args new Object snapshotName vmUuid final String snapshot snapshotXML format args
s_logger debug snapshot if command getCommandSwitch equalsIgnoreCase ManageSnapshotCommand CREATE_SNAPSHOT vm snapshotCreateXML snapshot else final DomainSnapshot snap vm snapshotLookupByName snapshotName snap delete vm libvirtComputingResource getDomain conn command getVmName state vm getInfo state if state DomainState VIR_DOMAIN_PAUSED vm resume else if primaryPool getType StoragePoolType RBD try final Rados r new Rados primaryPool getAuthUserName r confSet primaryPool getSourceHost primaryPool getSourcePort
final DomainSnapshot snap vm snapshotLookupByName snapshotName snap delete vm libvirtComputingResource getDomain conn command getVmName state vm getInfo state if state DomainState VIR_DOMAIN_PAUSED vm resume else if primaryPool getType StoragePoolType RBD try final Rados r new Rados primaryPool getAuthUserName r confSet primaryPool getSourceHost primaryPool getSourcePort r confSet primaryPool getAuthSecret r confSet r connect s_logger debug r confGet
else if primaryPool getType StoragePoolType RBD try final Rados r new Rados primaryPool getAuthUserName r confSet primaryPool getSourceHost primaryPool getSourcePort r confSet primaryPool getAuthSecret r confSet r connect s_logger debug r confGet final IoCTX io r ioCtxCreate primaryPool getSourceDir final Rbd rbd new Rbd io final RbdImage image rbd open disk getName if command getCommandSwitch equalsIgnoreCase ManageSnapshotCommand CREATE_SNAPSHOT s_logger debug disk getName snapshotName image snapCreate snapshotName
else s_logger debug disk getName snapshotName image snapRemove snapshotName rbd close image r ioCtxDestroy io catch final Exception e s_logger error disk getName e getMessage else final int cmdsTimeout libvirtComputingResource getCmdsTimeout final String manageSnapshotPath libvirtComputingResource manageSnapshotPath final Script scriptCommand new Script manageSnapshotPath cmdsTimeout s_logger if command getCommandSwitch equalsIgnoreCase ManageSnapshotCommand CREATE_SNAPSHOT scriptCommand add disk getPath else scriptCommand add snapshotPath
String oldIsoVolumePath getOldVolumePath disks vmName String newIsoVolumePath getNewVolumePathIfDatastoreHasChanged libvirtComputingResource conn to if newIsoVolumePath null newIsoVolumePath equals oldIsoVolumePath s_logger debug xmlDesc replaceDiskSourceFile xmlDesc newIsoVolumePath vmName vmsnapshots libvirtComputingResource cleanVMSnapshotMetadata dm Map String MigrateCommand MigrateDiskInfo mapMigrateStorage command getMigrateStorage final boolean migrateStorage MapUtils isNotEmpty mapMigrateStorage final boolean migrateStorageManaged command isMigrateStorageManaged if migrateStorage xmlDesc replaceStorage xmlDesc mapMigrateStorage migrateStorageManaged Map String DpdkTO dpdkPortsMapping command getDpdkInterfaceMapping if MapUtils isNotEmpty dpdkPortsMapping xmlDesc replaceDpdkInterfaces xmlDesc dpdkPortsMapping dconn libvirtUtilitiesHelper retrieveQemuConnection destinationUri
dconn libvirtUtilitiesHelper retrieveQemuConnection destinationUri s_logger info vmName dconn getURI final ExecutorService executor Executors newFixedThreadPool boolean migrateNonSharedInc command isMigrateNonSharedInc migrateStorageManaged final Callable Domain worker new MigrateKVMAsync libvirtComputingResource dm dconn xmlDesc migrateStorage migrateNonSharedInc command isAutoConvergence vmName command getDestinationIp final Future Domain migrateThread executor submit worker executor shutdown long sleeptime while executor isTerminated Thread sleep sleeptime if sleeptime final int migrateDowntime libvirtComputingResource getMigrateDowntime if migrateDowntime try
boolean migrateNonSharedInc command isMigrateNonSharedInc migrateStorageManaged final Callable Domain worker new MigrateKVMAsync libvirtComputingResource dm dconn xmlDesc migrateStorage migrateNonSharedInc command isAutoConvergence vmName command getDestinationIp final Future Domain migrateThread executor submit worker executor shutdown long sleeptime while executor isTerminated Thread sleep sleeptime if sleeptime final int migrateDowntime libvirtComputingResource getMigrateDowntime if migrateDowntime try final int setDowntime dm migrateSetMaxDowntime migrateDowntime if setDowntime s_logger debug vmName String valueOf migrateDowntime
sleeptime if sleeptime final int migrateDowntime libvirtComputingResource getMigrateDowntime if migrateDowntime try final int setDowntime dm migrateSetMaxDowntime migrateDowntime if setDowntime s_logger debug vmName String valueOf migrateDowntime catch final LibvirtException e s_logger debug e getMessage if sleeptime s_logger info vmName sleeptime final int migratePauseAfter libvirtComputingResource getMigratePauseAfter if migratePauseAfter sleeptime migratePauseAfter DomainState state null
if migrateDowntime try final int setDowntime dm migrateSetMaxDowntime migrateDowntime if setDowntime s_logger debug vmName String valueOf migrateDowntime catch final LibvirtException e s_logger debug e getMessage if sleeptime s_logger info vmName sleeptime final int migratePauseAfter libvirtComputingResource getMigratePauseAfter if migratePauseAfter sleeptime migratePauseAfter DomainState state null try state dm getInfo state catch final LibvirtException e
if setDowntime s_logger debug vmName String valueOf migrateDowntime catch final LibvirtException e s_logger debug e getMessage if sleeptime s_logger info vmName sleeptime final int migratePauseAfter libvirtComputingResource getMigratePauseAfter if migratePauseAfter sleeptime migratePauseAfter DomainState state null try state dm getInfo state catch final LibvirtException e s_logger info sleeptime e getMessage if state null state DomainState VIR_DOMAIN_RUNNING try
catch final LibvirtException e s_logger debug e getMessage if sleeptime s_logger info vmName sleeptime final int migratePauseAfter libvirtComputingResource getMigratePauseAfter if migratePauseAfter sleeptime migratePauseAfter DomainState state null try state dm getInfo state catch final LibvirtException e s_logger info sleeptime e getMessage if state null state DomainState VIR_DOMAIN_RUNNING try s_logger info vmName migratePauseAfter dm suspend
if sleeptime s_logger info vmName sleeptime final int migratePauseAfter libvirtComputingResource getMigratePauseAfter if migratePauseAfter sleeptime migratePauseAfter DomainState state null try state dm getInfo state catch final LibvirtException e s_logger info sleeptime e getMessage if state null state DomainState VIR_DOMAIN_RUNNING try s_logger info vmName migratePauseAfter dm suspend catch final LibvirtException e s_logger info vmName e getMessage
Override public Answer execute final ModifySshKeysCommand command final LibvirtComputingResource libvirtComputingResource final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper final String sshkeyspath libvirtUtilitiesHelper retrieveSshKeysPath final String sshpubkeypath libvirtUtilitiesHelper retrieveSshPubKeyPath final String sshprvkeypath libvirtUtilitiesHelper retrieveSshPrvKeyPath final File sshKeysDir new File sshkeyspath String result null if sshKeysDir exists final Script script new Script libvirtComputingResource getTimeout s_logger script add script add sshkeyspath script execute if sshKeysDir exists
final File sshKeysDir new File sshkeyspath String result null if sshKeysDir exists final Script script new Script libvirtComputingResource getTimeout s_logger script add script add sshkeyspath script execute if sshKeysDir exists s_logger debug sshkeyspath final File pubKeyFile new File sshpubkeypath if pubKeyFile exists try pubKeyFile createNewFile catch final IOException e result e toString
script execute if sshKeysDir exists s_logger debug sshkeyspath final File pubKeyFile new File sshpubkeypath if pubKeyFile exists try pubKeyFile createNewFile catch final IOException e result e toString s_logger debug result if pubKeyFile exists try FileOutputStream pubkStream new FileOutputStream pubKeyFile pubkStream write command getPubKey getBytes StringUtils getPreferredCharset catch final FileNotFoundException e result sshpubkeypath e toString
final File pubKeyFile new File sshpubkeypath if pubKeyFile exists try pubKeyFile createNewFile catch final IOException e result e toString s_logger debug result if pubKeyFile exists try FileOutputStream pubkStream new FileOutputStream pubKeyFile pubkStream write command getPubKey getBytes StringUtils getPreferredCharset catch final FileNotFoundException e result sshpubkeypath e toString s_logger debug result catch final IOException e result sshpubkeypath e toString
catch final IOException e result e toString s_logger debug result if pubKeyFile exists try FileOutputStream pubkStream new FileOutputStream pubKeyFile pubkStream write command getPubKey getBytes StringUtils getPreferredCharset catch final FileNotFoundException e result sshpubkeypath e toString s_logger debug result catch final IOException e result sshpubkeypath e toString s_logger debug result final File prvKeyFile new File sshprvkeypath if prvKeyFile exists try
catch final FileNotFoundException e result sshpubkeypath e toString s_logger debug result catch final IOException e result sshpubkeypath e toString s_logger debug result final File prvKeyFile new File sshprvkeypath if prvKeyFile exists try prvKeyFile createNewFile catch final IOException e result e toString s_logger debug result if prvKeyFile exists final String prvKey command getPrvKey
s_logger debug result catch final IOException e result sshpubkeypath e toString s_logger debug result final File prvKeyFile new File sshprvkeypath if prvKeyFile exists try prvKeyFile createNewFile catch final IOException e result e toString s_logger debug result if prvKeyFile exists final String prvKey command getPrvKey try FileOutputStream prvKStream new FileOutputStream prvKeyFile if prvKStream null
Override public Answer execute final OvsFetchInterfaceCommand command final LibvirtComputingResource libvirtComputingResource final String label command getLabel
Override public Answer execute final PlugNicCommand command final LibvirtComputingResource libvirtComputingResource final NicTO nic command getNic final String vmName command getVmName final VirtualMachine Type vmType command getVMType Domain vm null try final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper final Connect conn libvirtUtilitiesHelper getConnectionByVmName vmName vm libvirtComputingResource getDomain conn vmName final List InterfaceDef pluggedNics libvirtComputingResource getInterfaces conn vmName Integer nicnum for final InterfaceDef pluggedNic pluggedNics if pluggedNic getMacAddress equalsIgnoreCase nic getMac
DpdkTO to new DpdkTO interfaceDef getDpdkOvsPath interfaceDef getDpdkSourcePort interfaceDef getInterfaceMode dpdkInterfaceMapping put nic getMac to final DiskTO volumes vm getDisks for final DiskTO volume volumes if volume getType Volume Type ISO libvirtComputingResource getVolumePath conn volume skipDisconnect true if storagePoolMgr connectPhysicalDisksViaVmSpec vm return new PrepareForMigrationAnswer command PrepareForMigrationAnswer answer new PrepareForMigrationAnswer command if MapUtils isNotEmpty dpdkInterfaceMapping answer setDpdkInterfaceMapping dpdkInterfaceMapping return answer catch final LibvirtException CloudRuntimeException InternalErrorException URISyntaxException e if MapUtils isNotEmpty dpdkInterfaceMapping
final String dhcpIp command getDhcpIp String opr if op equals opr String result null final String guestBridgeName libvirtComputingResource getGuestBridgeName final Duration timeout libvirtComputingResource getTimeout if command getType PvlanSetupCommand Type DHCP final String ovsPvlanDhcpHostPath libvirtComputingResource getOvsPvlanDhcpHostPath final Script script new Script ovsPvlanDhcpHostPath timeout s_logger script add opr pvlanType guestBridgeName primaryPvlan isolatedPvlan dhcpMac dhcpIp result script execute if result null s_logger warn dhcpMac else
final String ovsPvlanDhcpHostPath libvirtComputingResource getOvsPvlanDhcpHostPath final Script script new Script ovsPvlanDhcpHostPath timeout s_logger script add opr pvlanType guestBridgeName primaryPvlan isolatedPvlan dhcpMac dhcpIp result script execute if result null s_logger warn dhcpMac else s_logger info dhcpMac final String ovsPvlanVmPath libvirtComputingResource getOvsPvlanVmPath final Script script new Script ovsPvlanVmPath timeout s_logger script add opr pvlanType guestBridgeName primaryPvlan isolatedPvlan vmMac result script execute if result null s_logger warn vmMac return new Answer command false result
Domain vm null try final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper final Connect conn libvirtUtilitiesHelper getConnectionByVmName vmName vm libvirtComputingResource getDomain conn vmName InterfaceDef oldPluggedNic findPluggedNic libvirtComputingResource nic vmName conn final VifDriver newVifDriver libvirtComputingResource getVifDriver nic getType nic getName final InterfaceDef interfaceDef newVifDriver plug nic oldPluggedNic getModel toString null interfaceDef setSlot oldPluggedNic getSlot interfaceDef setDevName oldPluggedNic getDevName interfaceDef setLinkStateUp false oldPluggedNic setSlot null int i do i
final Connect conn libvirtUtilitiesHelper getConnectionByVmName vmName vm libvirtComputingResource getDomain conn vmName InterfaceDef oldPluggedNic findPluggedNic libvirtComputingResource nic vmName conn final VifDriver newVifDriver libvirtComputingResource getVifDriver nic getType nic getName final InterfaceDef interfaceDef newVifDriver plug nic oldPluggedNic getModel toString null interfaceDef setSlot oldPluggedNic getSlot interfaceDef setDevName oldPluggedNic getDevName interfaceDef setLinkStateUp false oldPluggedNic setSlot null int i do i s_logger debug oldPluggedNic i vm detachDevice oldPluggedNic toString while findPluggedNic libvirtComputingResource nic vmName conn null i
final VifDriver newVifDriver libvirtComputingResource getVifDriver nic getType nic getName final InterfaceDef interfaceDef newVifDriver plug nic oldPluggedNic getModel toString null interfaceDef setSlot oldPluggedNic getSlot interfaceDef setDevName oldPluggedNic getDevName interfaceDef setLinkStateUp false oldPluggedNic setSlot null int i do i s_logger debug oldPluggedNic i vm detachDevice oldPluggedNic toString while findPluggedNic libvirtComputingResource nic vmName conn null i s_logger debug interfaceDef vm attachDevice interfaceDef toString interfaceDef setLinkStateUp true
Override public Answer execute final ResizeVolumeCommand command final LibvirtComputingResource libvirtComputingResource final String volid command getPath final long newSize command getNewSize final long currentSize command getCurrentSize final String vmInstanceName command getInstanceName final boolean shrinkOk command getShrinkOk final StorageFilerTO spool command getPool final String notifyOnlyType if currentSize newSize
final String notifyOnlyType if currentSize newSize s_logger info toHumanReadableSize currentSize toHumanReadableSize newSize return new ResizeVolumeAnswer command true currentSize try final KVMStoragePoolManager storagePoolMgr libvirtComputingResource getStoragePoolMgr KVMStoragePool pool storagePoolMgr getStoragePool spool getType spool getUuid final KVMPhysicalDisk vol pool getPhysicalDisk volid final String path vol getPath String type notifyOnlyType if pool getType StoragePoolType RBD type libvirtComputingResource getResizeScriptType pool vol if type equals shrinkOk return new ResizeVolumeAnswer command false type else
return new ResizeVolumeAnswer command true currentSize try final KVMStoragePoolManager storagePoolMgr libvirtComputingResource getStoragePoolMgr KVMStoragePool pool storagePoolMgr getStoragePool spool getType spool getUuid final KVMPhysicalDisk vol pool getPhysicalDisk volid final String path vol getPath String type notifyOnlyType if pool getType StoragePoolType RBD type libvirtComputingResource getResizeScriptType pool vol if type equals shrinkOk return new ResizeVolumeAnswer command false type else s_logger debug path s_logger debug path toHumanReadableSize currentSize toHumanReadableSize newSize type vmInstanceName shrinkOk if pool getType StoragePoolType CLVM vol getFormat PhysicalDiskFormat QCOW2
else s_logger debug path s_logger debug path toHumanReadableSize currentSize toHumanReadableSize newSize type vmInstanceName shrinkOk if pool getType StoragePoolType CLVM vol getFormat PhysicalDiskFormat QCOW2 s_logger debug path try final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper final Connect conn libvirtUtilitiesHelper getConnection final StorageVol v conn storageVolLookupByPath path int flags if conn getLibVirVersion vol getFormat PhysicalDiskFormat RAW pool getType StoragePoolType RBD flags if shrinkOk flags v resize newSize flags
v resize newSize flags catch final LibvirtException e return new ResizeVolumeAnswer command false e toString s_logger debug type final Script resizecmd new Script libvirtComputingResource getResizeVolumePath libvirtComputingResource getCmdsTimeout s_logger resizecmd add String valueOf newSize resizecmd add String valueOf currentSize resizecmd add path resizecmd add type resizecmd add String valueOf shrinkOk resizecmd add vmInstanceName final String result resizecmd execute if result null if type equals notifyOnlyType return new ResizeVolumeAnswer command true
List VolumeObjectTO listVolumeTo cmd getVolumeTOs VirtualMachine PowerState vmState VirtualMachine PowerState PowerOn Domain dm null try final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper Connect conn libvirtUtilitiesHelper getConnection dm libvirtComputingResource getDomain conn vmName if dm null return new RestoreVMSnapshotAnswer cmd false vmName String xmlDesc dm getXMLDesc List VMSnapshotTO snapshots cmd getSnapshots Map Long VMSnapshotTO snapshotAndParents cmd getSnapshotAndParents for VMSnapshotTO snapshot snapshots VMSnapshotTO parent snapshotAndParents get snapshot getId String vmSnapshotXML libvirtUtilitiesHelper generateVMSnapshotXML snapshot parent xmlDesc
if dm null return new RestoreVMSnapshotAnswer cmd false vmName String xmlDesc dm getXMLDesc List VMSnapshotTO snapshots cmd getSnapshots Map Long VMSnapshotTO snapshotAndParents cmd getSnapshotAndParents for VMSnapshotTO snapshot snapshots VMSnapshotTO parent snapshotAndParents get snapshot getId String vmSnapshotXML libvirtUtilitiesHelper generateVMSnapshotXML snapshot parent xmlDesc s_logger debug snapshot getSnapshotName vmName vmSnapshotXML try int flags if snapshot getCurrent flags dm snapshotCreateXML vmSnapshotXML flags catch LibvirtException e
try snapshotRelPath snapshot getPath KVMStoragePoolManager storagePoolMgr libvirtComputingResource getStoragePoolMgr KVMPhysicalDisk snapshotDisk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volumePath KVMStoragePool primaryPool snapshotDisk getPool if primaryPool getType StoragePoolType RBD Rados rados new Rados primaryPool getAuthUserName rados confSet MON_HOST primaryPool getSourceHost primaryPool getSourcePort rados confSet KEY primaryPool getAuthSecret rados confSet CLIENT_MOUNT_TIMEOUT RADOS_CONNECTION_TIMEOUT rados connect String rbdPoolAndVolumeAndSnapshot snapshotRelPath split int snapshotIndex rbdPoolAndVolumeAndSnapshot length String rbdSnapshotId rbdPoolAndVolumeAndSnapshot snapshotIndex IoCTX io rados ioCtxCreate primaryPool getSourceDir
RbdImage image rbd open volumePath image snapRollBack rbdSnapshotId rbd close image rados ioCtxDestroy io else NfsTO nfsImageStore NfsTO snapshotImageStore String secondaryStoragePoolUrl nfsImageStore getUrl secondaryStoragePool storagePoolMgr getStoragePoolByURI secondaryStoragePoolUrl String ssPmountPath secondaryStoragePool getLocalPath snapshotPath ssPmountPath File separator snapshotRelPath Script cmd new Script libvirtComputingResource manageSnapshotPath libvirtComputingResource getCmdsTimeout s_logger cmd add snapshotPath cmd add snapshotDisk getName cmd add snapshotDisk getPath String result cmd execute
NfsTO nfsImageStore NfsTO snapshotImageStore String secondaryStoragePoolUrl nfsImageStore getUrl secondaryStoragePool storagePoolMgr getStoragePoolByURI secondaryStoragePoolUrl String ssPmountPath secondaryStoragePool getLocalPath snapshotPath ssPmountPath File separator snapshotRelPath Script cmd new Script libvirtComputingResource manageSnapshotPath libvirtComputingResource getCmdsTimeout s_logger cmd add snapshotPath cmd add snapshotDisk getName cmd add snapshotDisk getPath String result cmd execute if result null s_logger debug result return new Answer command false result return new Answer command true catch CloudRuntimeException e
String ssPmountPath secondaryStoragePool getLocalPath snapshotPath ssPmountPath File separator snapshotRelPath Script cmd new Script libvirtComputingResource manageSnapshotPath libvirtComputingResource getCmdsTimeout s_logger cmd add snapshotPath cmd add snapshotDisk getName cmd add snapshotDisk getPath String result cmd execute if result null s_logger debug result return new Answer command false result return new Answer command true catch CloudRuntimeException e return new Answer command false e toString catch RadosException e s_logger error e
try File agentFile getAgentPropertiesFile String privatePassword getKeystorePassword agentFile if isBlank privatePassword return new Answer command false KeyStoreUtils KS_FILENAME final String keyStoreFile getKeyStoreFilePath agentFile String checkCmd String format certificateAlias keyStoreFile privatePassword int existsCmdResult Script runSimpleBashScriptForExitValue checkCmd if existsCmdResult s_logger error certificateAlias else String revokeCmd String format certificateAlias keyStoreFile privatePassword s_logger debug certificateAlias keyStoreFile Script runSimpleBashScriptForExitValue revokeCmd catch FileNotFoundException CloudRuntimeException e
else if scriptFile null s_logger info stage return new RollingMaintenanceAnswer command true stage true if command isStarted executor RollingMaintenanceAgentExecutor String msg s_logger info msg return new RollingMaintenanceAnswer command true msg true s_logger info stage if command isStarted executor startStageExecution stage scriptFile timeout payload if executor isStageRunning stage scriptFile payload return new RollingMaintenanceAnswer command true stage false boolean success executor getStageExecutionSuccess stage scriptFile String output executor getStageExecutionOutput stage scriptFile RollingMaintenanceAnswer answer new RollingMaintenanceAnswer command success output true
if command isStarted executor RollingMaintenanceAgentExecutor String msg s_logger info msg return new RollingMaintenanceAnswer command true msg true s_logger info stage if command isStarted executor startStageExecution stage scriptFile timeout payload if executor isStageRunning stage scriptFile payload return new RollingMaintenanceAnswer command true stage false boolean success executor getStageExecutionSuccess stage scriptFile String output executor getStageExecutionOutput stage scriptFile RollingMaintenanceAnswer answer new RollingMaintenanceAnswer command success output true if executor getStageAvoidMaintenance stage scriptFile s_logger info stage answer setAvoidMaintenance true
final Connect conn libvirtUtilitiesHelper getConnectionByVmName command getVmName final List InterfaceDef nics libvirtComputingResource getInterfaces conn command getVmName vif nics get getDevName brname nics get getBrName final VirtualMachineTO vm command getVmTO if libvirtComputingResource applyDefaultNetworkRules conn vm true s_logger warn command getVmName return new SecurityGroupRuleAnswer command false catch final LibvirtException e return new SecurityGroupRuleAnswer command false e toString final boolean result libvirtComputingResource addNetworkRules command getVmName Long toString command getVmId command getGuestIp command getGuestIp6 command getSignature Long toString command getSeqNum command getGuestMac command stringifyRules vif brname command getSecIpsString if result s_logger warn command getVmName return new SecurityGroupRuleAnswer command false else
private void importCertificate String tempCerFilePath String keyStoreFile String certificateName String privatePassword s_logger debug String importCommandFormat String importCmd String format importCommandFormat tempCerFilePath keyStoreFile certificateName privatePassword int result Script runSimpleBashScriptForExitValue importCmd if result
private String createTemporaryFile File agentFile String certificateName String certificate String tempCerFilePath String format agentFile getParent temporaryCertFilePrefix certificateName
DomainState state DomainState VIR_DOMAIN_SHUTOFF final KVMStoragePoolManager storagePoolMgr libvirtComputingResource getStoragePoolMgr final LibvirtUtilitiesHelper libvirtUtilitiesHelper libvirtComputingResource getLibvirtUtilitiesHelper Connect conn null try vm libvirtComputingResource createVMFromSpec vmSpec conn libvirtUtilitiesHelper getConnectionByType vm getHvsType final NicTO nics vmSpec getNics for final NicTO nic nics if vmSpec getType VirtualMachine Type User nic setPxeDisable true libvirtComputingResource createVbd conn vmSpec vmName vm if storagePoolMgr connectPhysicalDisksViaVmSpec vmSpec return new StartAnswer command libvirtComputingResource createVifs vmSpec vm
if command checkBeforeCleanup try final Connect conn libvirtUtilitiesHelper getConnectionByVmName vmName final Domain vm conn domainLookupByName command getVmName if vm null vm getInfo state DomainState VIR_DOMAIN_RUNNING return new StopAnswer command false catch final Exception e s_logger debug e File pemFile new File LibvirtComputingResource SSHPRVKEYPATH try if vmName startsWith vmName startsWith s_logger debug try Pair Boolean String ret SshHelper sshExecute command getControlIp pemFile null CMDLINE_PATH CMDLINE_BACKUP_PATH if ret first
final Connect conn libvirtUtilitiesHelper getConnectionByVmName vmName final Domain vm conn domainLookupByName command getVmName if vm null vm getInfo state DomainState VIR_DOMAIN_RUNNING return new StopAnswer command false catch final Exception e s_logger debug e File pemFile new File LibvirtComputingResource SSHPRVKEYPATH try if vmName startsWith vmName startsWith s_logger debug try Pair Boolean String ret SshHelper sshExecute command getControlIp pemFile null CMDLINE_PATH CMDLINE_BACKUP_PATH if ret first s_logger debug ret second catch Exception e
Override public boolean connectPhysicalDisk String volumeUuid KVMStoragePool pool Map String String details Script iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add getIqn volumeUuid iScsiAdmCmd add pool getSourceHost pool getSourcePort iScsiAdmCmd add String result iScsiAdmCmd execute if result null
String chapInitiatorUsername details get DiskTO CHAP_INITIATOR_USERNAME String chapInitiatorSecret details get DiskTO CHAP_INITIATOR_SECRET if StringUtils isNotBlank chapInitiatorUsername StringUtils isNotBlank chapInitiatorSecret try executeChapCommand volumeUuid pool null executeChapCommand volumeUuid pool chapInitiatorUsername executeChapCommand volumeUuid pool chapInitiatorSecret catch Exception ex return false iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add getIqn volumeUuid iScsiAdmCmd add pool getSourceHost pool getSourcePort iScsiAdmCmd add result iScsiAdmCmd execute
try executeChapCommand volumeUuid pool null executeChapCommand volumeUuid pool chapInitiatorUsername executeChapCommand volumeUuid pool chapInitiatorSecret catch Exception ex return false iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add getIqn volumeUuid iScsiAdmCmd add pool getSourceHost pool getSourcePort iScsiAdmCmd add result iScsiAdmCmd execute if result null s_logger debug volumeUuid System out println volumeUuid
private void executeChapCommand String path KVMStoragePool pool String nParameter String vParameter String detail throws Exception Script iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add getIqn path iScsiAdmCmd add pool getSourceHost pool getSourcePort iScsiAdmCmd add iScsiAdmCmd add nParameter iScsiAdmCmd add vParameter String result iScsiAdmCmd execute boolean useDetail detail null detail trim length detail useDetail detail trim detail if result null
Script iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add getIqn path iScsiAdmCmd add pool getSourceHost pool getSourcePort iScsiAdmCmd add iScsiAdmCmd add nParameter iScsiAdmCmd add vParameter String result iScsiAdmCmd execute boolean useDetail detail null detail trim length detail useDetail detail trim detail if result null s_logger debug useDetail detail path result System out println useDetail detail path result throw new Exception useDetail detail path result else
private boolean disconnectPhysicalDisk String host int port String iqn String lun Script iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add iqn iScsiAdmCmd add host port iScsiAdmCmd add String result iScsiAdmCmd execute if result null
String result iScsiAdmCmd execute if result null s_logger debug iqn lun result System out println iqn lun result return false else s_logger debug iqn lun System out println iqn lun iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add iqn iScsiAdmCmd add host port iScsiAdmCmd add result iScsiAdmCmd execute if result null
return false else s_logger debug iqn lun System out println iqn lun iScsiAdmCmd new Script true s_logger iScsiAdmCmd add iScsiAdmCmd add iqn iScsiAdmCmd add host port iScsiAdmCmd add result iScsiAdmCmd execute if result null s_logger debug iqn lun result System out println iqn lun result return false else
final String vmName vmSpec getName List DiskTO disks Arrays asList vmSpec getDisks for DiskTO disk disks if disk getType Volume Type ISO result true continue VolumeObjectTO vol VolumeObjectTO disk getData PrimaryDataStoreTO store PrimaryDataStoreTO vol getDataStore if store isManaged VirtualMachine State Migrating equals vmSpec getState result true continue KVMStoragePool pool getStoragePool store getPoolType store getUuid StorageAdaptor adaptor getStorageAdaptor pool getType result adaptor connectPhysicalDisk vol getPath pool disk getDetails if result
boolean result true final String vmName vmSpec getName List DiskTO disks Arrays asList vmSpec getDisks for DiskTO disk disks if disk getType Volume Type ISO s_logger debug disk getPath VolumeObjectTO vol VolumeObjectTO disk getData PrimaryDataStoreTO store PrimaryDataStoreTO vol getDataStore KVMStoragePool pool getStoragePool store getPoolType store getUuid if pool null s_logger error store getUuid store getPoolType continue StorageAdaptor adaptor getStorageAdaptor pool getType boolean subResult adaptor disconnectPhysicalDisk vol getPath pool if subResult
KVMStoragePool secondaryPool null try secondaryPool storagePoolMgr getStoragePoolByURI mountpoint if tmpltname null secondaryPool refresh final List KVMPhysicalDisk disks secondaryPool listPhysicalDisks if disks null disks isEmpty return new PrimaryStorageDownloadAnswer secondaryPool getUuid for final KVMPhysicalDisk disk disks if disk getName endsWith tmplVol disk break else tmplVol secondaryPool getPhysicalDisk tmpltname if tmplVol null
for final KVMPhysicalDisk disk disks if disk getName endsWith tmplVol disk break else tmplVol secondaryPool getPhysicalDisk tmpltname if tmplVol null return new PrimaryStorageDownloadAnswer secondaryPool getUuid s_logger debug tmplVol getFormat final KVMStoragePool primaryPool storagePoolMgr getStoragePool primaryStore getPoolType primaryStore getUuid KVMPhysicalDisk primaryVol null if destData VolumeObjectTO final VolumeObjectTO volume VolumeObjectTO destData if volume getSize null volume getSize tmplVol getVirtualSize s_logger debug toHumanReadableSize volume getSize
KVMPhysicalDisk templateVol null KVMStoragePool secondaryPool null try secondaryPool storagePoolMgr getStoragePoolByURI mountpoint if templateName null secondaryPool refresh final List KVMPhysicalDisk disks secondaryPool listPhysicalDisks if disks null disks isEmpty s_logger error secondaryPool getUuid return null for final KVMPhysicalDisk disk disks if disk getName endsWith templateVol disk break if templateVol null
s_logger error secondaryPool getUuid return null for final KVMPhysicalDisk disk disks if disk getName endsWith templateVol disk break if templateVol null s_logger error secondaryPool getUuid return null else templateVol secondaryPool getPhysicalDisk templateName if size templateVol getSize s_logger debug toHumanReadableSize size templateVol setSize size templateVol setVirtualSize size
final String templateFolder template getPath secondaryStorage storagePoolMgr getStoragePoolByURI nfsImageStore getUrl primary storagePoolMgr getStoragePool primaryStore getPoolType primaryStore getUuid final KVMPhysicalDisk disk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volume getPath final String tmpltPath secondaryStorage getLocalPath File separator templateFolder storageLayer mkdirs tmpltPath final String templateName UUID randomUUID toString if primary getType StoragePoolType RBD final Script command new Script _createTmplPath wait s_logger command add disk getPath command add tmpltPath command add NAME_OPTION templateName final String result command execute if result null s_logger debug result
try FileOutputStream templFo new FileOutputStream templateProp templFo write templateContent getBytes templFo flush catch final IOException e throw e final Map String Object params new HashMap String Object params put StorageLayer InstanceConfigKey storageLayer final Processor qcow2Processor new QCOW2Processor qcow2Processor configure params final FormatInfo info qcow2Processor process tmpltPath null templateName final TemplateLocation loc new TemplateLocation storageLayer tmpltPath loc create true templateName loc addFormat info loc save final TemplateObjectTO newTemplate new TemplateObjectTO
catch final IOException e throw e final Map String Object params new HashMap String Object params put StorageLayer InstanceConfigKey storageLayer final Processor qcow2Processor new QCOW2Processor qcow2Processor configure params final FormatInfo info qcow2Processor process tmpltPath null templateName final TemplateLocation loc new TemplateLocation storageLayer tmpltPath loc create true templateName loc addFormat info loc save final TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath templateFolder File separator templateName newTemplate setSize info virtualSize newTemplate setPhysicalSize info size
srcStorePool storagePoolMgr getStoragePoolByURI srcStore getUrl File separator srcSnapshotDir if srcStorePool null return new CopyCmdAnswer srcStore getUrl srcFile new File srcStorePool getLocalPath File separator srcFileName if srcFile exists return new CopyCmdAnswer srcPath String destPath null if imageStore S3TO destPath copyToS3 srcFile S3TO imageStore destData getPath else return new CopyCmdAnswer final SnapshotObjectTO newSnapshot new SnapshotObjectTO newSnapshot setPath destPath return new CopyCmdAnswer newSnapshot catch final Exception e
if imageStore S3TO destPath copyToS3 srcFile S3TO imageStore destData getPath else return new CopyCmdAnswer final SnapshotObjectTO newSnapshot new SnapshotObjectTO newSnapshot setPath destPath return new CopyCmdAnswer newSnapshot catch final Exception e s_logger error srcPath e return new CopyCmdAnswer srcPath e toString finally try if srcFile null srcFile delete if srcStorePool null
Connect conn null KVMPhysicalDisk snapshotDisk null KVMStoragePool primaryPool null try conn LibvirtConnection getConnectionByVmName vmName secondaryStoragePool storagePoolMgr getStoragePoolByURI secondaryStoragePoolUrl final String ssPmountPath secondaryStoragePool getLocalPath snapshotRelPath destSnapshot getPath snapshotDestPath ssPmountPath File separator snapshotRelPath snapshotDisk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volumePath primaryPool snapshotDisk getPool long size if primaryPool getType StoragePoolType RBD final String rbdSnapshot snapshotDisk getPath snapshotName final String snapshotFile snapshotDestPath snapshotName
snapshotDestPath ssPmountPath File separator snapshotRelPath snapshotDisk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volumePath primaryPool snapshotDisk getPool long size if primaryPool getType StoragePoolType RBD final String rbdSnapshot snapshotDisk getPath snapshotName final String snapshotFile snapshotDestPath snapshotName try s_logger debug rbdSnapshot final File snapDir new File snapshotDestPath s_logger debug snapDir getAbsolutePath FileUtils forceMkdir snapDir final QemuImgFile srcFile new QemuImgFile KVMPhysicalDisk RBDStringBuilder primaryPool getSourceHost primaryPool getSourcePort primaryPool getAuthUserName primaryPool getAuthSecret rbdSnapshot srcFile setFormat snapshotDisk getFormat final QemuImgFile destFile new QemuImgFile snapshotFile
try s_logger debug rbdSnapshot final File snapDir new File snapshotDestPath s_logger debug snapDir getAbsolutePath FileUtils forceMkdir snapDir final QemuImgFile srcFile new QemuImgFile KVMPhysicalDisk RBDStringBuilder primaryPool getSourceHost primaryPool getSourcePort primaryPool getAuthUserName primaryPool getAuthSecret rbdSnapshot srcFile setFormat snapshotDisk getFormat final QemuImgFile destFile new QemuImgFile snapshotFile destFile setFormat PhysicalDiskFormat QCOW2 s_logger debug rbdSnapshot snapshotFile final QemuImg q new QemuImg cmd getWaitInMillSeconds q convert srcFile destFile final File snapFile new File snapshotFile if snapFile exists size snapFile length
s_logger debug rbdSnapshot final File snapDir new File snapshotDestPath s_logger debug snapDir getAbsolutePath FileUtils forceMkdir snapDir final QemuImgFile srcFile new QemuImgFile KVMPhysicalDisk RBDStringBuilder primaryPool getSourceHost primaryPool getSourcePort primaryPool getAuthUserName primaryPool getAuthSecret rbdSnapshot srcFile setFormat snapshotDisk getFormat final QemuImgFile destFile new QemuImgFile snapshotFile destFile setFormat PhysicalDiskFormat QCOW2 s_logger debug rbdSnapshot snapshotFile final QemuImg q new QemuImg cmd getWaitInMillSeconds q convert srcFile destFile final File snapFile new File snapshotFile if snapFile exists size snapFile length s_logger debug rbdSnapshot snapshotFile toHumanReadableSize size
FileUtils forceMkdir snapDir final QemuImgFile srcFile new QemuImgFile KVMPhysicalDisk RBDStringBuilder primaryPool getSourceHost primaryPool getSourcePort primaryPool getAuthUserName primaryPool getAuthSecret rbdSnapshot srcFile setFormat snapshotDisk getFormat final QemuImgFile destFile new QemuImgFile snapshotFile destFile setFormat PhysicalDiskFormat QCOW2 s_logger debug rbdSnapshot snapshotFile final QemuImg q new QemuImg cmd getWaitInMillSeconds q convert srcFile destFile final File snapFile new File snapshotFile if snapFile exists size snapFile length s_logger debug rbdSnapshot snapshotFile toHumanReadableSize size catch final FileNotFoundException e s_logger error snapshotDestPath e getMessage return new CopyCmdAnswer e toString
final QemuImgFile destFile new QemuImgFile snapshotFile destFile setFormat PhysicalDiskFormat QCOW2 s_logger debug rbdSnapshot snapshotFile final QemuImg q new QemuImg cmd getWaitInMillSeconds q convert srcFile destFile final File snapFile new File snapshotFile if snapFile exists size snapFile length s_logger debug rbdSnapshot snapshotFile toHumanReadableSize size catch final FileNotFoundException e s_logger error snapshotDestPath e getMessage return new CopyCmdAnswer e toString catch final IOException e s_logger error snapshotDestPath e getMessage return new CopyCmdAnswer e toString
catch final LibvirtException e s_logger debug e return new CopyCmdAnswer e toString catch final CloudRuntimeException e s_logger debug e return new CopyCmdAnswer e toString finally if isCreatedFromVmSnapshot s_logger debug else try DomainInfo DomainState state null Domain vm null if vmName null try
private void deleteSnapshotViaManageSnapshotScript final String snapshotName KVMPhysicalDisk snapshotDisk final Script command new Script _manageSnapshotPath _cmdsTimeout s_logger command add MANAGE_SNAPSTHOT_DESTROY_OPTION snapshotDisk getPath command add NAME_OPTION snapshotName final String result command execute if result null
protected synchronized String attachOrDetachDevice final Connect conn final boolean attach final String vmName final String xml throws LibvirtException InternalErrorException Domain dm null try dm conn domainLookupByName vmName if attach
List DiskDef disks null Domain dm null DiskDef diskdef null final KVMStoragePool attachingPool attachingDisk getPool try dm conn domainLookupByName vmName final LibvirtDomainXMLParser parser new LibvirtDomainXMLParser final String domXml dm getXMLDesc parser parseDomainXML domXml disks parser getDisks if attach if attachingPool getType StoragePoolType RBD if resource getHypervisorType Hypervisor HypervisorType LXC final String device resource mapRbdDevice attachingDisk if device null
final PrimaryDataStoreTO primaryStore PrimaryDataStoreTO vol getDataStore final String vmName cmd getVmName final String serial resource diskUuidToSerial vol getUuid try final Connect conn LibvirtConnection getConnectionByVmName vmName storagePoolMgr connectPhysicalDisk primaryStore getPoolType primaryStore getUuid vol getPath disk getDetails final KVMPhysicalDisk phyDisk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid vol getPath final String volCacheMode vol getCacheMode null null vol getCacheMode toString attachOrDetachDisk conn true vmName phyDisk disk getDiskSeq intValue serial vol getBytesReadRate vol getBytesReadRateMax vol getBytesReadRateMaxLength vol getBytesWriteRate vol getBytesWriteRateMax vol getBytesWriteRateMaxLength vol getIopsReadRate vol getIopsReadRateMax vol getIopsReadRateMaxLength vol getIopsWriteRate vol getIopsWriteRateMax vol getIopsWriteRateMaxLength volCacheMode return new AttachAnswer disk catch final LibvirtException e s_logger debug vol getPath e storagePoolMgr disconnectPhysicalDisk primaryStore getPoolType primaryStore getUuid vol getPath return new AttachAnswer e toString catch final InternalErrorException e
final VolumeObjectTO vol VolumeObjectTO disk getData final PrimaryDataStoreTO primaryStore PrimaryDataStoreTO vol getDataStore final String vmName cmd getVmName final String serial resource diskUuidToSerial vol getUuid try final Connect conn LibvirtConnection getConnectionByVmName vmName final KVMPhysicalDisk phyDisk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid vol getPath final String volCacheMode vol getCacheMode null null vol getCacheMode toString attachOrDetachDisk conn false vmName phyDisk disk getDiskSeq intValue serial vol getBytesReadRate vol getBytesReadRateMax vol getBytesReadRateMaxLength vol getBytesWriteRate vol getBytesWriteRateMax vol getBytesWriteRateMaxLength vol getIopsReadRate vol getIopsReadRateMax vol getIopsReadRateMaxLength vol getIopsWriteRate vol getIopsWriteRateMax vol getIopsWriteRateMaxLength volCacheMode storagePoolMgr disconnectPhysicalDisk primaryStore getPoolType primaryStore getUuid vol getPath return new DettachAnswer disk catch final LibvirtException e s_logger debug vol getPath e return new DettachAnswer e toString catch final InternalErrorException e
protected KVMPhysicalDisk createFullCloneVolume MigrationOptions migrationOptions VolumeObjectTO volume KVMStoragePool primaryPool PhysicalDiskFormat format
if vmName null try vm resource getDomain conn vmName state vm getInfo state catch final LibvirtException e s_logger trace e final KVMStoragePool primaryPool storagePoolMgr getStoragePool primaryStore getPoolType primaryStore getUuid final KVMPhysicalDisk disk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volume getPath if state DomainInfo DomainState VIR_DOMAIN_RUNNING primaryPool isExternalSnapshot final String vmUuid vm getUUIDString final Object args new Object snapshotName vmUuid final String snapshot SnapshotXML format args final long start System currentTimeMillis vm snapshotCreateXML snapshot final long total System currentTimeMillis start
final String vmUuid vm getUUIDString final Object args new Object snapshotName vmUuid final String snapshot SnapshotXML format args final long start System currentTimeMillis vm snapshotCreateXML snapshot final long total System currentTimeMillis start s_logger debug total vm resource getDomain conn vmName state vm getInfo state if state DomainInfo DomainState VIR_DOMAIN_PAUSED vm resume else if primaryPool getType StoragePoolType RBD try Rados r radosConnect primaryPool
final long total System currentTimeMillis start s_logger debug total vm resource getDomain conn vmName state vm getInfo state if state DomainInfo DomainState VIR_DOMAIN_PAUSED vm resume else if primaryPool getType StoragePoolType RBD try Rados r radosConnect primaryPool final IoCTX io r ioCtxCreate primaryPool getSourceDir final Rbd rbd new Rbd io final RbdImage image rbd open disk getName s_logger debug disk getName snapshotName image snapCreate snapshotName
final Rbd rbd new Rbd io final RbdImage image rbd open disk getName s_logger debug disk getName snapshotName image snapCreate snapshotName rbd close image r ioCtxDestroy io catch final Exception e s_logger error disk getName e getMessage else final Script command new Script _manageSnapshotPath _cmdsTimeout s_logger command add MANAGE_SNAPSTHOT_CREATE_OPTION disk getPath command add NAME_OPTION snapshotName final String result command execute if result null s_logger debug result
private Rados radosConnect final KVMStoragePool primaryPool throws RadosException Rados r new Rados primaryPool getAuthUserName r confSet CEPH_MON_HOST primaryPool getSourceHost primaryPool getSourcePort r confSet CEPH_AUTH_KEY primaryPool getAuthSecret r confSet CEPH_CLIENT_MOUNT_TIMEOUT CEPH_DEFAULT_MOUNT_TIMEOUT r connect
try SnapshotObjectTO snapshotTO SnapshotObjectTO cmd getData PrimaryDataStoreTO primaryStore PrimaryDataStoreTO snapshotTO getDataStore VolumeObjectTO volume snapshotTO getVolume KVMStoragePool primaryPool storagePoolMgr getStoragePool primaryStore getPoolType primaryStore getUuid KVMPhysicalDisk disk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volume getPath String snapshotFullPath snapshotTO getPath String snapshotName snapshotFullPath substring snapshotFullPath lastIndexOf snap_full_name disk getName snapshotName if primaryPool getType StoragePoolType RBD Rados r radosConnect primaryPool IoCTX io r ioCtxCreate primaryPool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open disk getName try
PrimaryDataStoreTO primaryStore PrimaryDataStoreTO snapshotTO getDataStore VolumeObjectTO volume snapshotTO getVolume KVMStoragePool primaryPool storagePoolMgr getStoragePool primaryStore getPoolType primaryStore getUuid KVMPhysicalDisk disk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volume getPath String snapshotFullPath snapshotTO getPath String snapshotName snapshotFullPath substring snapshotFullPath lastIndexOf snap_full_name disk getName snapshotName if primaryPool getType StoragePoolType RBD Rados r radosConnect primaryPool IoCTX io r ioCtxCreate primaryPool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open disk getName try s_logger info snap_full_name if image snapIsProtected snapshotName
KVMPhysicalDisk disk storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid volume getPath String snapshotFullPath snapshotTO getPath String snapshotName snapshotFullPath substring snapshotFullPath lastIndexOf snap_full_name disk getName snapshotName if primaryPool getType StoragePoolType RBD Rados r radosConnect primaryPool IoCTX io r ioCtxCreate primaryPool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open disk getName try s_logger info snap_full_name if image snapIsProtected snapshotName s_logger debug snap_full_name image snapUnprotect snapshotName image snapRemove snapshotName
String snapshotName snapshotFullPath substring snapshotFullPath lastIndexOf snap_full_name disk getName snapshotName if primaryPool getType StoragePoolType RBD Rados r radosConnect primaryPool IoCTX io r ioCtxCreate primaryPool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open disk getName try s_logger info snap_full_name if image snapIsProtected snapshotName s_logger debug snap_full_name image snapUnprotect snapshotName image snapRemove snapshotName s_logger info snap_full_name primaryPool getType toString catch RbdException e
Rbd rbd new Rbd io RbdImage image rbd open disk getName try s_logger info snap_full_name if image snapIsProtected snapshotName s_logger debug snap_full_name image snapUnprotect snapshotName image snapRemove snapshotName s_logger info snap_full_name primaryPool getType toString catch RbdException e s_logger error snap_full_name e toString ErrorCode getErrorMessage e getReturnValue finally rbd close image r ioCtxDestroy io else if primaryPool getType StoragePoolType NetworkFilesystem primaryPool getType StoragePoolType Filesystem
image snapRemove snapshotName s_logger info snap_full_name primaryPool getType toString catch RbdException e s_logger error snap_full_name e toString ErrorCode getErrorMessage e getReturnValue finally rbd close image r ioCtxDestroy io else if primaryPool getType StoragePoolType NetworkFilesystem primaryPool getType StoragePoolType Filesystem s_logger info String format snapshotTO getId snapshotTO getName snapshotTO getPath primaryPool getType deleteSnapshotViaManageSnapshotScript snapshotName disk else s_logger warn primaryPool getType toString throw new InternalErrorException primaryPool getType toString return new Answer cmd true snap_full_name catch RadosException e
catch RbdException e s_logger error snap_full_name e toString ErrorCode getErrorMessage e getReturnValue finally rbd close image r ioCtxDestroy io else if primaryPool getType StoragePoolType NetworkFilesystem primaryPool getType StoragePoolType Filesystem s_logger info String format snapshotTO getId snapshotTO getName snapshotTO getPath primaryPool getType deleteSnapshotViaManageSnapshotScript snapshotName disk else s_logger warn primaryPool getType toString throw new InternalErrorException primaryPool getType toString return new Answer cmd true snap_full_name catch RadosException e s_logger error snap_full_name e toString ErrorCode getErrorMessage e getReturnValue return new Answer cmd false snap_full_name
finally rbd close image r ioCtxDestroy io else if primaryPool getType StoragePoolType NetworkFilesystem primaryPool getType StoragePoolType Filesystem s_logger info String format snapshotTO getId snapshotTO getName snapshotTO getPath primaryPool getType deleteSnapshotViaManageSnapshotScript snapshotName disk else s_logger warn primaryPool getType toString throw new InternalErrorException primaryPool getType toString return new Answer cmd true snap_full_name catch RadosException e s_logger error snap_full_name e toString ErrorCode getErrorMessage e getReturnValue return new Answer cmd false snap_full_name catch RbdException e s_logger error snap_full_name e toString ErrorCode getErrorMessage e getReturnValue
Override public Answer handleDownloadTemplateToPrimaryStorage DirectDownloadCommand cmd final PrimaryDataStoreTO pool cmd getDestPool DirectTemplateDownloader downloader KVMPhysicalDisk template try s_logger debug String temporaryDownloadPath resource getDirectDownloadTemporaryDownloadPath if isLocationAccessible temporaryDownloadPath String msg temporaryDownloadPath
final String srcVolumePath srcData getPath final String destVolumePath destData getPath KVMStoragePool destPool null try final String volumeName UUID randomUUID toString final String destVolumeName volumeName destFormat getFileExtension final KVMPhysicalDisk volume storagePoolMgr getPhysicalDisk primaryStore getPoolType primaryStore getUuid srcVolumePath volume setFormat PhysicalDiskFormat valueOf srcFormat toString destPool storagePoolMgr getStoragePool primaryStoreDest getPoolType primaryStoreDest getUuid storagePoolMgr copyPhysicalDisk volume destVolumeName destPool cmd getWaitInMillSeconds final VolumeObjectTO newVol new VolumeObjectTO newVol setPath destVolumePath File separator destVolumeName newVol setFormat destFormat return new CopyCmdAnswer newVol catch final CloudRuntimeException e
Override public KVMPhysicalDisk createDiskFromTemplateBacking KVMPhysicalDisk template String name PhysicalDiskFormat format long size KVMStoragePool destPool int timeout
public StorageVol createVolume Connect conn StoragePool pool String uuid long size VolumeFormat format throws LibvirtException LibvirtStorageVolumeDef volDef new LibvirtStorageVolumeDef UUID randomUUID toString size format null null
private StoragePool createNetfsStoragePool PoolType fsType Connect conn String uuid String host String path throws LibvirtException String targetPath _mountPoint File separator uuid LibvirtStoragePoolDef spd new LibvirtStoragePoolDef fsType uuid uuid host path targetPath _storageLayer mkdir targetPath StoragePool sp null try
private StoragePool createNetfsStoragePool PoolType fsType Connect conn String uuid String host String path throws LibvirtException String targetPath _mountPoint File separator uuid LibvirtStoragePoolDef spd new LibvirtStoragePoolDef fsType uuid uuid host path targetPath _storageLayer mkdir targetPath StoragePool sp null try s_logger debug spd toString int mountpointResult Script runSimpleBashScriptForExitValue targetPath if mountpointResult
private StoragePool createNetfsStoragePool PoolType fsType Connect conn String uuid String host String path throws LibvirtException String targetPath _mountPoint File separator uuid LibvirtStoragePoolDef spd new LibvirtStoragePoolDef fsType uuid uuid host path targetPath _storageLayer mkdir targetPath StoragePool sp null try s_logger debug spd toString int mountpointResult Script runSimpleBashScriptForExitValue targetPath if mountpointResult s_logger info targetPath String result Script runSimpleBashScript targetPath if result null
_storageLayer mkdir targetPath StoragePool sp null try s_logger debug spd toString int mountpointResult Script runSimpleBashScriptForExitValue targetPath if mountpointResult s_logger info targetPath String result Script runSimpleBashScript targetPath if result null s_logger info targetPath else s_logger error sp conn storagePoolCreateXML spd toString return sp catch LibvirtException e
private StoragePool createSharedStoragePool Connect conn String uuid String host String path String mountPoint path if _storageLayer exists mountPoint
private StoragePool createCLVMStoragePool Connect conn String uuid String host String path String volgroupPath path String volgroupName path volgroupName volgroupName replaceFirst LibvirtStoragePoolDef spd new LibvirtStoragePoolDef PoolType LOGICAL volgroupName uuid host volgroupPath volgroupPath StoragePool sp null try
try s_logger debug spd toString sp conn storagePoolCreateXML spd toString return sp catch LibvirtException e s_logger error e toString if sp null try if sp isPersistent sp destroy sp undefine else sp destroy sp free catch LibvirtException l
private StoragePool createRBDStoragePool Connect conn String uuid String host int port String userInfo String path LibvirtStoragePoolDef spd StoragePool sp null Secret s null String userInfoTemp userInfo split if userInfoTemp length LibvirtSecretDef sd new LibvirtSecretDef Usage CEPH uuid sd setCephName userInfoTemp host port path try
String userInfoTemp userInfo split if userInfoTemp length LibvirtSecretDef sd new LibvirtSecretDef Usage CEPH uuid sd setCephName userInfoTemp host port path try s_logger debug sd toString s conn secretDefineXML sd toString s setValue Base64 decodeBase64 userInfoTemp catch LibvirtException e s_logger error e toString if s null try s undefine s free catch LibvirtException l
s conn secretDefineXML sd toString s setValue Base64 decodeBase64 userInfoTemp catch LibvirtException e s_logger error e toString if s null try s undefine s free catch LibvirtException l s_logger error l toString return null spd new LibvirtStoragePoolDef PoolType RBD uuid uuid host port path userInfoTemp AuthenticationType CEPH uuid else spd new LibvirtStoragePoolDef PoolType RBD uuid uuid host port path try
s_logger error e toString if s null try s undefine s free catch LibvirtException l s_logger error l toString return null spd new LibvirtStoragePoolDef PoolType RBD uuid uuid host port path userInfoTemp AuthenticationType CEPH uuid else spd new LibvirtStoragePoolDef PoolType RBD uuid uuid host port path try s_logger debug spd toString sp conn storagePoolCreateXML spd toString return sp
Override public KVMStoragePool getStoragePool String uuid boolean refreshInfo
type StoragePoolType RBD else if spd getPoolType LibvirtStoragePoolDef PoolType LOGICAL type StoragePoolType CLVM else if spd getPoolType LibvirtStoragePoolDef PoolType GLUSTERFS type StoragePoolType Gluster LibvirtStoragePool pool new LibvirtStoragePool uuid storage getName type this storage if pool getType StoragePoolType RBD pool setLocalPath spd getTargetPath else pool setLocalPath if pool getType StoragePoolType RBD pool getType StoragePoolType Gluster pool setSourceHost spd getSourceHost pool setSourcePort spd getSourcePort pool setSourceDir spd getSourceDir String authUsername spd getAuthUserName if authUsername null Secret secret conn secretLookupByUUIDString spd getSecretUUID
else if spd getPoolType LibvirtStoragePoolDef PoolType GLUSTERFS type StoragePoolType Gluster LibvirtStoragePool pool new LibvirtStoragePool uuid storage getName type this storage if pool getType StoragePoolType RBD pool setLocalPath spd getTargetPath else pool setLocalPath if pool getType StoragePoolType RBD pool getType StoragePoolType Gluster pool setSourceHost spd getSourceHost pool setSourcePort spd getSourcePort pool setSourceDir spd getSourceDir String authUsername spd getAuthUserName if authUsername null Secret secret conn secretLookupByUUIDString spd getSecretUUID String secretValue new String Base64 encodeBase64 secret getByteValue Charset defaultCharset pool setAuthUsername authUsername pool setAuthSecret secretValue
LibvirtStoragePool pool new LibvirtStoragePool uuid storage getName type this storage if pool getType StoragePoolType RBD pool setLocalPath spd getTargetPath else pool setLocalPath if pool getType StoragePoolType RBD pool getType StoragePoolType Gluster pool setSourceHost spd getSourceHost pool setSourcePort spd getSourcePort pool setSourceDir spd getSourceDir String authUsername spd getAuthUserName if authUsername null Secret secret conn secretLookupByUUIDString spd getSecretUUID String secretValue new String Base64 encodeBase64 secret getByteValue Charset defaultCharset pool setAuthUsername authUsername pool setAuthSecret secretValue if refreshInfo s_logger info uuid
Override public KVMStoragePool createStoragePool String name String host int port String path String userInfo StoragePoolType type
Override public KVMStoragePool createStoragePool String name String host int port String path String userInfo StoragePoolType type s_logger info name type toString StoragePool sp null Connect conn null try conn LibvirtConnection getConnection catch LibvirtException e throw new CloudRuntimeException e toString try sp conn storagePoolLookupByUUIDString name if sp null sp isActive sp undefine sp null s_logger info name if sp null
catch LibvirtException e throw new CloudRuntimeException e toString try sp conn storagePoolLookupByUUIDString name if sp null sp isActive sp undefine sp null s_logger info name if sp null s_logger info name catch LibvirtException e sp null s_logger warn name if path endsWith path path substring path length
s_logger info name catch LibvirtException e sp null s_logger warn name if path endsWith path path substring path length if sp null s_logger info name try String poolnames conn listStoragePools for String poolname poolnames s_logger debug poolname StoragePool p conn storagePoolLookupByName poolname LibvirtStoragePoolDef pdef getStoragePoolDef conn p if pdef null
if sp null s_logger info name try String poolnames conn listStoragePools for String poolname poolnames s_logger debug poolname StoragePool p conn storagePoolLookupByName poolname LibvirtStoragePoolDef pdef getStoragePoolDef conn p if pdef null throw new CloudRuntimeException poolname String targetPath pdef getTargetPath if targetPath null targetPath equals path s_logger debug path poolname name if p isPersistent p destroy
String poolnames conn listStoragePools for String poolname poolnames s_logger debug poolname StoragePool p conn storagePoolLookupByName poolname LibvirtStoragePoolDef pdef getStoragePoolDef conn p if pdef null throw new CloudRuntimeException poolname String targetPath pdef getTargetPath if targetPath null targetPath equals path s_logger debug path poolname name if p isPersistent p destroy p undefine else p destroy
for String poolname poolnames s_logger debug poolname StoragePool p conn storagePoolLookupByName poolname LibvirtStoragePoolDef pdef getStoragePoolDef conn p if pdef null throw new CloudRuntimeException poolname String targetPath pdef getTargetPath if targetPath null targetPath equals path s_logger debug path poolname name if p isPersistent p destroy p undefine else p destroy catch LibvirtException e
String targetPath pdef getTargetPath if targetPath null targetPath equals path s_logger debug path poolname name if p isPersistent p destroy p undefine else p destroy catch LibvirtException e s_logger error e s_logger debug name if type StoragePoolType NetworkFilesystem try sp createNetfsStoragePool PoolType NETFS conn name host path catch LibvirtException e
String targetPath pdef getTargetPath if targetPath null targetPath equals path s_logger debug path poolname name if p isPersistent p destroy p undefine else p destroy catch LibvirtException e s_logger error e s_logger debug name if type StoragePoolType NetworkFilesystem try sp createNetfsStoragePool PoolType NETFS conn name host path catch LibvirtException e
catch LibvirtException e s_logger error e s_logger debug name if type StoragePoolType NetworkFilesystem try sp createNetfsStoragePool PoolType NETFS conn name host path catch LibvirtException e s_logger error host path e s_logger error e getStackTrace throw new CloudRuntimeException e toString else if type StoragePoolType Gluster try sp createNetfsStoragePool PoolType GLUSTERFS conn name host path catch LibvirtException e s_logger error host path e
Override public boolean deleteStoragePool String uuid
Connect conn null try conn LibvirtConnection getConnection catch LibvirtException e throw new CloudRuntimeException e toString StoragePool sp null Secret s null try sp conn storagePoolLookupByUUIDString uuid catch LibvirtException e s_logger warn uuid return true try s conn secretLookupByUUIDString uuid catch LibvirtException e
catch LibvirtException e s_logger warn uuid return true try s conn secretLookupByUUIDString uuid catch LibvirtException e s_logger info uuid try if sp isPersistent sp destroy sp undefine else sp destroy sp free if s null
try if sp isPersistent sp destroy sp undefine else sp destroy sp free if s null s undefine s free s_logger info uuid return true catch LibvirtException e if e toString contains String targetPath _mountPoint File separator uuid
Override public KVMPhysicalDisk createPhysicalDisk String name KVMStoragePool pool PhysicalDiskFormat format Storage ProvisioningType provisioningType long size
private KVMPhysicalDisk createPhysicalDiskByLibVirt String name KVMStoragePool pool PhysicalDiskFormat format Storage ProvisioningType provisioningType long size LibvirtStoragePool libvirtPool LibvirtStoragePool pool StoragePool virtPool libvirtPool getPool LibvirtStorageVolumeDef VolumeFormat libvirtformat LibvirtStorageVolumeDef VolumeFormat getFormat format String volPath null String volName null long volAllocation long volCapacity LibvirtStorageVolumeDef volDef new LibvirtStorageVolumeDef name size libvirtformat null null
long actualSize final int timeout QemuImgFile destFile new QemuImgFile volPath destFile setFormat format destFile setSize size QemuImg qemu new QemuImg timeout Map String String options new HashMap String String if pool getType StoragePoolType NetworkFilesystem options put QemuImg PreallocationType getPreallocationType provisioningType toString try qemu create destFile options Map String String info qemu info destFile virtualSize Long parseLong info get new String actualSize new File destFile getFileName length catch QemuImgException e
Override public boolean deletePhysicalDisk String uuid KVMStoragePool pool Storage ImageFormat format
Override public boolean deletePhysicalDisk String uuid KVMStoragePool pool Storage ImageFormat format s_logger info uuid pool getUuid if pool getType StoragePoolType RBD try
Override public boolean deletePhysicalDisk String uuid KVMStoragePool pool Storage ImageFormat format s_logger info uuid pool getUuid if pool getType StoragePoolType RBD try s_logger info pool getSourceDir uuid Rados r new Rados pool getAuthUserName r confSet pool getSourceHost pool getSourcePort r confSet pool getAuthSecret r confSet r connect
Override public boolean deletePhysicalDisk String uuid KVMStoragePool pool Storage ImageFormat format s_logger info uuid pool getUuid if pool getType StoragePoolType RBD try s_logger info pool getSourceDir uuid Rados r new Rados pool getAuthUserName r confSet pool getSourceHost pool getSourcePort r confSet pool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate pool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open uuid
s_logger info pool getSourceDir uuid Rados r new Rados pool getAuthUserName r confSet pool getSourceHost pool getSourcePort r confSet pool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate pool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open uuid s_logger debug pool getSourceDir uuid List RbdSnapInfo snaps image snapList try for RbdSnapInfo snap snaps if image snapIsProtected snap name
r confSet pool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate pool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open uuid s_logger debug pool getSourceDir uuid List RbdSnapInfo snaps image snapList try for RbdSnapInfo snap snaps if image snapIsProtected snap name s_logger debug pool getSourceDir uuid snap name image snapUnprotect snap name else
Rbd rbd new Rbd io RbdImage image rbd open uuid s_logger debug pool getSourceDir uuid List RbdSnapInfo snaps image snapList try for RbdSnapInfo snap snaps if image snapIsProtected snap name s_logger debug pool getSourceDir uuid snap name image snapUnprotect snap name else s_logger debug pool getSourceDir uuid snap name s_logger debug pool getSourceDir uuid snap name image snapRemove snap name s_logger info snaps size pool getSourceDir uuid catch RbdException e
s_logger debug pool getSourceDir uuid snap name image snapUnprotect snap name else s_logger debug pool getSourceDir uuid snap name s_logger debug pool getSourceDir uuid snap name image snapRemove snap name s_logger info snaps size pool getSourceDir uuid catch RbdException e s_logger error e toString ErrorCode getErrorMessage e getReturnValue throw new CloudRuntimeException e toString ErrorCode getErrorMessage e getReturnValue finally s_logger debug rbd close image r ioCtxDestroy io catch RadosException e
else s_logger debug pool getSourceDir uuid snap name s_logger debug pool getSourceDir uuid snap name image snapRemove snap name s_logger info snaps size pool getSourceDir uuid catch RbdException e s_logger error e toString ErrorCode getErrorMessage e getReturnValue throw new CloudRuntimeException e toString ErrorCode getErrorMessage e getReturnValue finally s_logger debug rbd close image r ioCtxDestroy io catch RadosException e s_logger error e toString ErrorCode getErrorMessage e getReturnValue throw new CloudRuntimeException e toString ErrorCode getErrorMessage e getReturnValue
s_logger info snaps size pool getSourceDir uuid catch RbdException e s_logger error e toString ErrorCode getErrorMessage e getReturnValue throw new CloudRuntimeException e toString ErrorCode getErrorMessage e getReturnValue finally s_logger debug rbd close image r ioCtxDestroy io catch RadosException e s_logger error e toString ErrorCode getErrorMessage e getReturnValue throw new CloudRuntimeException e toString ErrorCode getErrorMessage e getReturnValue catch RbdException e s_logger error e toString ErrorCode getErrorMessage e getReturnValue throw new CloudRuntimeException e toString ErrorCode getErrorMessage e getReturnValue LibvirtStoragePool libvirtPool LibvirtStoragePool pool
Override public KVMPhysicalDisk createDiskFromTemplate KVMPhysicalDisk template String name PhysicalDiskFormat format Storage ProvisioningType provisioningType long size KVMStoragePool destPool int timeout
Map String String options new HashMap String String options put QemuImg PreallocationType getPreallocationType provisioningType toString switch provisioningType case THIN QemuImgFile backingFile new QemuImgFile template getPath template getFormat qemu create destFile backingFile options break case SPARSE case FAT QemuImgFile srcFile new QemuImgFile template getPath template getFormat qemu convert srcFile destFile options null break else if format PhysicalDiskFormat RAW QemuImgFile sourceFile new QemuImgFile template getPath template getFormat QemuImgFile destFile new QemuImgFile disk getPath PhysicalDiskFormat RAW if size template getVirtualSize destFile setSize size else
if size template getVirtualSize disk setSize size disk setVirtualSize size else disk setSize template getVirtualSize disk setVirtualSize disk getSize QemuImg qemu new QemuImg timeout QemuImgFile srcFile QemuImgFile destFile new QemuImgFile KVMPhysicalDisk RBDStringBuilder destPool getSourceHost destPool getSourcePort destPool getAuthUserName destPool getAuthSecret disk getPath destFile setFormat format if srcPool getType StoragePoolType RBD srcFile new QemuImgFile template getPath template getFormat try qemu convert srcFile destFile catch QemuImgException e
QemuImgFile destFile new QemuImgFile KVMPhysicalDisk RBDStringBuilder destPool getSourceHost destPool getSourcePort destPool getAuthUserName destPool getAuthSecret disk getPath destFile setFormat format if srcPool getType StoragePoolType RBD srcFile new QemuImgFile template getPath template getFormat try qemu convert srcFile destFile catch QemuImgException e s_logger error disk getPath e getMessage else try if srcPool getSourceHost equals destPool getSourceHost srcPool getSourceDir equals destPool getSourceDir s_logger debug Rados r new Rados srcPool getAuthUserName r confSet srcPool getSourceHost srcPool getSourcePort r confSet srcPool getAuthSecret
qemu convert srcFile destFile catch QemuImgException e s_logger error disk getPath e getMessage else try if srcPool getSourceHost equals destPool getSourceHost srcPool getSourceDir equals destPool getSourceDir s_logger debug Rados r new Rados srcPool getAuthUserName r confSet srcPool getSourceHost srcPool getSourcePort r confSet srcPool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate srcPool getSourceDir Rbd rbd new Rbd io
s_logger error disk getPath e getMessage else try if srcPool getSourceHost equals destPool getSourceHost srcPool getSourceDir equals destPool getSourceDir s_logger debug Rados r new Rados srcPool getAuthUserName r confSet srcPool getSourceHost srcPool getSourcePort r confSet srcPool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate srcPool getSourceDir Rbd rbd new Rbd io RbdImage srcImage rbd open template getName if srcImage isOldFormat
else try if srcPool getSourceHost equals destPool getSourceHost srcPool getSourceDir equals destPool getSourceDir s_logger debug Rados r new Rados srcPool getAuthUserName r confSet srcPool getSourceHost srcPool getSourcePort r confSet srcPool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate srcPool getSourceDir Rbd rbd new Rbd io RbdImage srcImage rbd open template getName if srcImage isOldFormat s_logger debug srcPool getSourceDir template getName toHumanReadableSize disk getVirtualSize
if srcPool getSourceHost equals destPool getSourceHost srcPool getSourceDir equals destPool getSourceDir s_logger debug Rados r new Rados srcPool getAuthUserName r confSet srcPool getSourceHost srcPool getSourcePort r confSet srcPool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate srcPool getSourceDir Rbd rbd new Rbd io RbdImage srcImage rbd open template getName if srcImage isOldFormat s_logger debug srcPool getSourceDir template getName toHumanReadableSize disk getVirtualSize rbd create disk getName disk getVirtualSize rbdFeatures rbdOrder RbdImage destImage rbd open disk getName
s_logger debug Rados r new Rados srcPool getAuthUserName r confSet srcPool getSourceHost srcPool getSourcePort r confSet srcPool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate srcPool getSourceDir Rbd rbd new Rbd io RbdImage srcImage rbd open template getName if srcImage isOldFormat s_logger debug srcPool getSourceDir template getName toHumanReadableSize disk getVirtualSize rbd create disk getName disk getVirtualSize rbdFeatures rbdOrder RbdImage destImage rbd open disk getName s_logger debug srcImage getName destImage getName srcPool getSourceDir
r confSet srcPool getSourceHost srcPool getSourcePort r confSet srcPool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate srcPool getSourceDir Rbd rbd new Rbd io RbdImage srcImage rbd open template getName if srcImage isOldFormat s_logger debug srcPool getSourceDir template getName toHumanReadableSize disk getVirtualSize rbd create disk getName disk getVirtualSize rbdFeatures rbdOrder RbdImage destImage rbd open disk getName s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd copy srcImage destImage s_logger debug srcImage getName destImage getName srcPool getSourceDir
s_logger debug r confGet IoCTX io r ioCtxCreate srcPool getSourceDir Rbd rbd new Rbd io RbdImage srcImage rbd open template getName if srcImage isOldFormat s_logger debug srcPool getSourceDir template getName toHumanReadableSize disk getVirtualSize rbd create disk getName disk getVirtualSize rbdFeatures rbdOrder RbdImage destImage rbd open disk getName s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd copy srcImage destImage s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd close destImage else s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName
if srcImage isOldFormat s_logger debug srcPool getSourceDir template getName toHumanReadableSize disk getVirtualSize rbd create disk getName disk getVirtualSize rbdFeatures rbdOrder RbdImage destImage rbd open disk getName s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd copy srcImage destImage s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd close destImage else s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName List RbdSnapInfo snaps srcImage snapList s_logger debug snaps size srcPool getSourceDir template getName boolean snapFound false for RbdSnapInfo snap snaps
rbd create disk getName disk getVirtualSize rbdFeatures rbdOrder RbdImage destImage rbd open disk getName s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd copy srcImage destImage s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd close destImage else s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName List RbdSnapInfo snaps srcImage snapList s_logger debug snaps size srcPool getSourceDir template getName boolean snapFound false for RbdSnapInfo snap snaps if rbdTemplateSnapName equals snap name s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName
rbd copy srcImage destImage s_logger debug srcImage getName destImage getName srcPool getSourceDir rbd close destImage else s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName List RbdSnapInfo snaps srcImage snapList s_logger debug snaps size srcPool getSourceDir template getName boolean snapFound false for RbdSnapInfo snap snaps if rbdTemplateSnapName equals snap name s_logger debug srcPool getSourceDir template getName rbdTemplateSnapName snapFound true break if snapFound
RbdImage diskImage rbd open disk getName diskImage resize disk getVirtualSize rbd close diskImage s_logger debug disk getName toHumanReadableSize disk getVirtualSize rbd close srcImage r ioCtxDestroy io else s_logger debug Rados rSrc new Rados srcPool getAuthUserName rSrc confSet srcPool getSourceHost srcPool getSourcePort rSrc confSet srcPool getAuthSecret rSrc confSet rSrc connect s_logger debug rSrc confGet Rados rDest new Rados destPool getAuthUserName
rbd close srcImage r ioCtxDestroy io else s_logger debug Rados rSrc new Rados srcPool getAuthUserName rSrc confSet srcPool getSourceHost srcPool getSourcePort rSrc confSet srcPool getAuthSecret rSrc confSet rSrc connect s_logger debug rSrc confGet Rados rDest new Rados destPool getAuthUserName rDest confSet destPool getSourceHost destPool getSourcePort rDest confSet destPool getAuthSecret rDest confSet rDest connect
Override public KVMPhysicalDisk copyPhysicalDisk KVMPhysicalDisk disk String name KVMStoragePool destPool int timeout KVMStoragePool srcPool disk getPool PhysicalDiskFormat sourceFormat disk getFormat String sourcePath disk getPath KVMPhysicalDisk newDisk
Script runSimpleBashScript destPath Script runSimpleBashScript destPath Script runSimpleBashScript sourcePath destPath timeout else srcFile new QemuImgFile sourcePath sourceFormat try Map String String info qemu info srcFile String backingFile info get new String if sourceFormat equals destFormat backingFile null sourcePath endsWith String result Script runSimpleBashScript sourcePath destPath timeout if result null throw new CloudRuntimeException result else destFile new QemuImgFile destPath destFormat try
else srcFile new QemuImgFile sourcePath sourceFormat try Map String String info qemu info srcFile String backingFile info get new String if sourceFormat equals destFormat backingFile null sourcePath endsWith String result Script runSimpleBashScript sourcePath destPath timeout if result null throw new CloudRuntimeException result else destFile new QemuImgFile destPath destFormat try qemu convert srcFile destFile Map String String destInfo qemu info destFile Long virtualSize Long parseLong destInfo get new String
throw new CloudRuntimeException result else destFile new QemuImgFile destPath destFormat try qemu convert srcFile destFile Map String String destInfo qemu info destFile Long virtualSize Long parseLong destInfo get new String newDisk setVirtualSize virtualSize newDisk setSize virtualSize catch QemuImgException e s_logger error srcFile getFileName destFile getFileName e getMessage newDisk null catch QemuImgException e s_logger error srcFile getFileName e getMessage newDisk null
else destFile new QemuImgFile destPath destFormat try qemu convert srcFile destFile Map String String destInfo qemu info destFile Long virtualSize Long parseLong destInfo get new String newDisk setVirtualSize virtualSize newDisk setSize virtualSize catch QemuImgException e s_logger error srcFile getFileName destFile getFileName e getMessage newDisk null catch QemuImgException e s_logger error srcFile getFileName e getMessage newDisk null else if srcPool getType StoragePoolType RBD destPool getType StoragePoolType RBD
catch QemuImgException e s_logger error srcFile getFileName e getMessage newDisk null else if srcPool getType StoragePoolType RBD destPool getType StoragePoolType RBD s_logger debug try srcFile new QemuImgFile sourcePath sourceFormat String rbdDestPath destPool getSourceDir name String rbdDestFile KVMPhysicalDisk RBDStringBuilder destPool getSourceHost destPool getSourcePort destPool getAuthUserName destPool getAuthSecret rbdDestPath destFile new QemuImgFile rbdDestFile destFormat s_logger debug srcFile getFileName rbdDestPath qemu convert srcFile destFile s_logger debug srcFile getFileName rbdDestPath Rados r new Rados destPool getAuthUserName r confSet destPool getSourceHost destPool getSourcePort
s_logger error srcFile getFileName e getMessage newDisk null else if srcPool getType StoragePoolType RBD destPool getType StoragePoolType RBD s_logger debug try srcFile new QemuImgFile sourcePath sourceFormat String rbdDestPath destPool getSourceDir name String rbdDestFile KVMPhysicalDisk RBDStringBuilder destPool getSourceHost destPool getSourcePort destPool getAuthUserName destPool getAuthSecret rbdDestPath destFile new QemuImgFile rbdDestFile destFormat s_logger debug srcFile getFileName rbdDestPath qemu convert srcFile destFile s_logger debug srcFile getFileName rbdDestPath Rados r new Rados destPool getAuthUserName r confSet destPool getSourceHost destPool getSourcePort r confSet destPool getAuthSecret
r confSet destPool getSourceHost destPool getSourcePort r confSet destPool getAuthSecret r confSet r connect s_logger debug r confGet IoCTX io r ioCtxCreate destPool getSourceDir Rbd rbd new Rbd io RbdImage image rbd open name RbdImageInfo rbdInfo image stat newDisk setSize rbdInfo size newDisk setVirtualSize rbdInfo size s_logger debug rbdDestPath toHumanReadableSize rbdInfo size rbd close image r ioCtxDestroy io catch QemuImgException e
Override public KVMPhysicalDisk createDiskFromSnapshot KVMPhysicalDisk snapshot String snapshotName String name KVMStoragePool destPool int timeout
PhysicalDiskFormat format snapshot getFormat long size snapshot getSize String destPath destPool getLocalPath endsWith destPool getLocalPath name destPool getLocalPath name if destPool getType StoragePoolType NetworkFilesystem try if format PhysicalDiskFormat QCOW2 QemuImg qemu new QemuImg timeout QemuImgFile destFile new QemuImgFile destPath format if size snapshot getVirtualSize destFile setSize size else destFile setSize snapshot getVirtualSize QemuImgFile srcFile new QemuImgFile snapshot getPath snapshot getFormat qemu convert srcFile destFile snapshotName catch QemuImgException e
String volumeUuid volumeUid if volumeUid contains String tokens volumeUid split volumeUuid tokens tokens length try disk this _storageAdaptor getPhysicalDisk volumeUuid this catch CloudRuntimeException e if this getStoragePoolType StoragePoolType NetworkFilesystem this getStoragePoolType StoragePoolType Filesystem throw e if disk null return disk s_logger debug volumeUid String localPoolPath this getLocalPath File f new File localPoolPath File separator volumeUuid if f exists
disk this _storageAdaptor getPhysicalDisk volumeUuid this catch CloudRuntimeException e if this getStoragePoolType StoragePoolType NetworkFilesystem this getStoragePoolType StoragePoolType Filesystem throw e if disk null return disk s_logger debug volumeUid String localPoolPath this getLocalPath File f new File localPoolPath File separator volumeUuid if f exists s_logger debug volumeUuid throw new CloudRuntimeException volumeUuid disk new KVMPhysicalDisk f getPath volumeUuid this disk setFormat PhysicalDiskFormat QCOW2 disk setSize f length
sp conn storagePoolCreateXML spd toString if sp null throw new CloudRuntimeException volumeUuid try if sp isActive sp create LibvirtStoragePool storagePool LibvirtStoragePool getStoragePool pool getUuid storagePool setPool sp return true catch LibvirtException e String error e toString if error contains throw new CloudRuntimeException error else throw new CloudRuntimeException error
if sp isActive sp create LibvirtStoragePool storagePool LibvirtStoragePool getStoragePool pool getUuid storagePool setPool sp return true catch LibvirtException e String error e toString if error contains throw new CloudRuntimeException error else throw new CloudRuntimeException error catch LibvirtException e s_logger error e toString if e toString contains s_logger error targetPath
throw new CloudRuntimeException error else throw new CloudRuntimeException error catch LibvirtException e s_logger error e toString if e toString contains s_logger error targetPath String result Script runSimpleBashScript targetPath if result null s_logger error targetPath try conn storagePoolCreateXML spd toString s_logger error return true catch LibvirtException l
StoragePool virtPool null try conn LibvirtConnection getConnection virtPool conn storagePoolLookupByName volumeUuid catch LibvirtException e1 throw new CloudRuntimeException e1 toString LibvirtStorageVolumeDef VolumeFormat libvirtformat null long volCapacity StorageVol vol getVolume virtPool volumeUuid try if vol null libvirtformat LibvirtStorageVolumeDef VolumeFormat QCOW2 StoragePoolInfo poolinfo virtPool getInfo volCapacity poolinfo available LibvirtStorageVolumeDef volDef new LibvirtStorageVolumeDef volumeUuid volCapacity libvirtformat null null
this cpusockets hosts sockets if hosts nodes this cpusockets hosts sockets hosts nodes this cpus hosts cpus final LibvirtCapXMLParser parser new LibvirtCapXMLParser parser parseCapabilitiesXML conn getCapabilities final ArrayList String oss parser getGuestOsType for final String s oss String hvmCapability if s equalsIgnoreCase hvmCapability if this capabilities contains hvmCapability this capabilities add hvmCapability this capabilities add conn close catch final LibvirtException e
Override public Map extends ServerResource Map String String find long dcId Long podId Long clusterId URI url String username String password List String hostTags throws DiscoveryException Connection conn null if url getScheme equals String msg url
ClusterVO cluster _clusterDao findById clusterId if cluster null cluster getHypervisorType HypervisorType Ovm if s_logger isInfoEnabled s_logger info return null String agentUsername _params get if agentUsername null throw new CloudRuntimeException String agentPassword _params get if agentPassword null throw new CloudRuntimeException try String hostname url getHost InetAddress ia InetAddress getByName hostname String hostIp ia getHostAddress String guid UUID nameUUIDFromBytes hostIp getBytes toString
Override public Boolean fenceOff VirtualMachine vm Host host if host getHypervisorType HypervisorType Ovm
return null List HostVO hosts _resourceMgr listAllHostsInCluster host getClusterId FenceCommand fence new FenceCommand vm host for HostVO h hosts if h getHypervisorType HypervisorType Ovm continue if h getStatus Status Up continue if h getId host getId continue FenceAnswer answer try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e if s_logger isDebugEnabled
for HostVO h hosts if h getHypervisorType HypervisorType Ovm continue if h getStatus Status Up continue if h getId host getId continue FenceAnswer answer try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e if s_logger isDebugEnabled s_logger debug h toString e continue catch OperationTimedoutException e
continue if h getId host getId continue FenceAnswer answer try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e if s_logger isDebugEnabled s_logger debug h toString e continue catch OperationTimedoutException e if s_logger isDebugEnabled s_logger debug h toString e continue if answer null answer getResult
_name name try _zoneId Long parseLong String params get _podId Long parseLong String params get _clusterId Long parseLong String params get _ip String params get _username String params get _password String params get _guid String params get _privateNetworkName String params get _publicNetworkName String params get _guestNetworkName String params get _agentUserName String params get _agentPassword String params get catch Exception e
if _podId null throw new ConfigurationException if _ip null throw new ConfigurationException if _username null throw new ConfigurationException if _password null throw new ConfigurationException if _guid null throw new ConfigurationException if _agentUserName null throw new ConfigurationException if _agentPassword null throw new ConfigurationException try
if _password null throw new ConfigurationException if _guid null throw new ConfigurationException if _agentUserName null throw new ConfigurationException if _agentPassword null throw new ConfigurationException try setupServer catch Exception e s_logger debug _ip e throw new ConfigurationException _conn new Connection _ip _agentUserName _agentPassword try
cmd setStorageIpAddress _ip String defaultBridge OvmBridge getBridgeByIp _conn _ip if _publicNetworkName null _publicNetworkName defaultBridge if _privateNetworkName null _privateNetworkName _publicNetworkName if _guestNetworkName null _guestNetworkName _privateNetworkName Map String String d cmd getHostDetails d put _publicNetworkName d put _privateNetworkName d put _guestNetworkName cmd setHostDetails d s_logger debug String format hostDetails toJson catch XmlRpcException e
SCPClient scp new SCPClient sshConnection String configScriptName String configScriptPath Script findScript configScriptName if configScriptPath null throw new CloudRuntimeException configScriptName scp put configScriptPath if SSHCmdHelper sshExecuteCmd sshConnection throw new CloudRuntimeException _ip File tmp new File configScriptPath File scriptDir new File tmp getParent File scripts scriptDir listFiles for int i i scripts length i File script scripts i if script getName equals continue
protected void createNfsSr StorageFilerTO pool throws XmlRpcException String mountPoint String format pool getHost pool getPath OvmStoragePool Details d new OvmStoragePool Details d path mountPoint d type OvmStoragePool NFS d uuid pool getUuid OvmStoragePool create _conn d
protected void createOCFS2Sr StorageFilerTO pool throws XmlRpcException OvmStoragePool Details d new OvmStoragePool Details d path pool getPath d type OvmStoragePool OCFS2 d uuid pool getUuid OvmStoragePool create _conn d
protected Answer execute ModifyStoragePoolCommand cmd StorageFilerTO pool cmd getPool try if pool getType StoragePoolType NetworkFilesystem createNfsSr pool else if pool getType StoragePoolType OCFS2 createOCFS2Sr pool else return new Answer cmd false pool getType name setupHeartBeat pool getUuid OvmStoragePool Details d OvmStoragePool getDetailsByUuid _conn pool getUuid Map String TemplateProp tInfo new HashMap String TemplateProp ModifyStoragePoolAnswer answer new ModifyStoragePoolAnswer cmd d totalSpace d freeSpace tInfo return answer catch Exception e
String vmName vmSpec getName OvmVm Details vmDetails null try vmDetails new OvmVm Details applySpecToVm vmDetails vmSpec createVbds vmDetails vmSpec createVifs vmDetails vmSpec startVm vmDetails NicTO nics vmSpec getNics for NicTO nic nics if nic isSecurityGroupEnabled if vmSpec getType equals VirtualMachine Type User defaultNetworkRulesForUserVm vmName vmSpec getId nic return new StartAnswer cmd catch Exception e
private PowerState toPowerState String vmName String s PowerState state s_powerStateMaps get s if state null
protected PrepareForMigrationAnswer execute PrepareForMigrationCommand cmd VirtualMachineTO vm cmd getVirtualMachine if s_logger isDebugEnabled
String secondaryStorageUrl cmd getSecondaryStorageUrl String volumePath cmd getVolumePath Long accountId cmd getAccountId Long templateId cmd getTemplateId int wait cmd getWait if wait wait try URI uri uri new URI secondaryStorageUrl String secondaryStorageMountPath uri getHost uri getPath String installPath accountId templateId Map String String res OvmStoragePool createTemplateFromVolume _conn secondaryStorageMountPath installPath volumePath wait return new CreatePrivateTemplateAnswer cmd true null res get Long parseLong res get Long parseLong res get res get ImageFormat RAW catch Exception e
protected CopyVolumeAnswer execute CopyVolumeCommand cmd String volumePath cmd getVolumePath String secondaryStorageURL cmd getSecondaryStorageURL int wait cmd getWait if wait wait try URI uri new URI secondaryStorageURL String secStorageMountPath uri getHost uri getPath String volumeFolderOnSecStorage String valueOf cmd getVolumeId String storagePoolUuid cmd getPool getUuid Boolean toSec cmd toSecondaryStorage String res OvmStoragePool copyVolume _conn secStorageMountPath volumeFolderOnSecStorage volumePath storagePoolUuid toSec wait return new CopyVolumeAnswer cmd true null null res catch Exception e
boolean errorout false String msg for PhysicalNetworkSetupInfo info infoList if isNetworkSetupByName info getGuestNetworkName msg info getPhysicalNetworkId info getGuestNetworkName errorout true break if isNetworkSetupByName info getPrivateNetworkName msg info getPhysicalNetworkId info getPrivateNetworkName errorout true break if isNetworkSetupByName info getPublicNetworkName msg info getPhysicalNetworkId info getPublicNetworkName errorout true break
private boolean isNetworkSetupByName String nameTag if nameTag null if s_logger isDebugEnabled
for int i i params length i mParams i params i if debug s_logger debug Coder toJson mParams long startTime System currentTimeMillis _client executeAsync mParams callback try return callback waitForResponse catch TimingOutCallback TimeoutException to throw to catch Throwable e throw new XmlRpcException e getMessage finally long endTime System currentTimeMillis long during endTime startTime
Override public boolean isVmAlive com cloud vm VirtualMachine vm Host host throws UnknownVM
Override public Status isAgentAlive Host agent
prot url new URL prot hostIp hostPort toString xmlClientConfig setTimeZone TimeZone getTimeZone xmlClientConfig setServerURL url xmlClientConfig setReplyTimeout xmlClientConfig setConnectionTimeout xmlClientConfig setReplyTimeout if hostUser null hostPass null LOGGER debug hostUser xmlClientConfig setBasicUserName hostUser xmlClientConfig setBasicPassword hostPass xmlClientConfig setXmlRpcServer null client setConfig xmlClientConfig client setTypeFactory new RpcTypeFactory client catch MalformedURLException e
public Object callTimeoutInSec String method List params int timeout boolean debug throws XmlRpcException TimingOutCallback callback new TimingOutCallback timeout if debug
TimingOutCallback callback new TimingOutCallback timeout if debug LOGGER debug hostName hostIp method params long startTime System currentTimeMillis try XmlRpcClientRequestImpl req new XmlRpcClientRequestImpl xmlClient getClientConfig method params xmlClient executeAsync req callback return callback waitForResponse catch TimingOutCallback TimeoutException e LOGGER info e throw new XmlRpcException e getMessage catch XmlRpcException e LOGGER info e throw e catch RuntimeException e
long startTime System currentTimeMillis try XmlRpcClientRequestImpl req new XmlRpcClientRequestImpl xmlClient getClientConfig method params xmlClient executeAsync req callback return callback waitForResponse catch TimingOutCallback TimeoutException e LOGGER info e throw new XmlRpcException e getMessage catch XmlRpcException e LOGGER info e throw e catch RuntimeException e LOGGER info e throw new XmlRpcException e getMessage catch Throwable e
public Vm getVmConfig String vmName throws Ovm3ResourceException defVm getRunningVmConfig vmName if defVm null
public Vm getVmConfig String repoId String vmId throws Ovm3ResourceException try Xen Vm nVm new Xen Vm Map String Object x Map String Object callWrapper repoId vmId if x null
private boolean CheckUrl URI url throws DiscoveryException if equals url getScheme equals url getScheme String msg url _params
Override public Map extends ServerResource Map String String find long dcId Long podId Long clusterId URI url String username String password List String hostTags throws DiscoveryException Connection c null CheckUrl url if clusterId null String msg
CheckUrl url if clusterId null String msg LOGGER info msg throw new DiscoveryException msg if podId null String msg LOGGER info msg throw new DiscoveryException msg ClusterVO cluster clusterDao findById clusterId if cluster null cluster getHypervisorType HypervisorType Ovm3 String msg LOGGER info msg throw new DiscoveryException msg else
throw new DiscoveryException msg if podId null String msg LOGGER info msg throw new DiscoveryException msg ClusterVO cluster clusterDao findById clusterId if cluster null cluster getHypervisorType HypervisorType Ovm3 String msg LOGGER info msg throw new DiscoveryException msg else LOGGER debug cluster String agentUsername _params get if agentUsername null String msg
throw new DiscoveryException msg ClusterVO cluster clusterDao findById clusterId if cluster null cluster getHypervisorType HypervisorType Ovm3 String msg LOGGER info msg throw new DiscoveryException msg else LOGGER debug cluster String agentUsername _params get if agentUsername null String msg LOGGER info msg throw new DiscoveryException msg String agentPassword _params get if agentPassword null
LOGGER info msg throw new DiscoveryException msg else LOGGER debug cluster String agentUsername _params get if agentUsername null String msg LOGGER info msg throw new DiscoveryException msg String agentPassword _params get if agentPassword null String msg LOGGER info msg throw new DiscoveryException msg String agentPort _params get
LOGGER info msg throw new DiscoveryException msg String agentPassword _params get if agentPassword null String msg LOGGER info msg throw new DiscoveryException msg String agentPort _params get if agentPort null String msg LOGGER info msg throw new DiscoveryException msg try String hostname url getHost InetAddress ia InetAddress getByName hostname
String agentPassword _params get if agentPassword null String msg LOGGER info msg throw new DiscoveryException msg String agentPort _params get if agentPort null String msg LOGGER info msg throw new DiscoveryException msg try String hostname url getHost InetAddress ia InetAddress getByName hostname String hostIp ia getHostAddress String guid UUID nameUUIDFromBytes hostIp getBytes toString
Override public void postDiscovery List HostVO hosts long msId throws CloudRuntimeException
Override public HostVO createHostVOForConnectedAgent HostVO host StartupCommand cmd
Override public boolean processAnswers long agentId long seq Answer answers
Override public boolean processCommands long agentId long seq Command commands
Override public AgentControlAnswer processControlCommand long agentId AgentControlCommand cmd
Override public boolean processTimeout long agentId long seq
Override public HostVO createHostVOForDirectConnectAgent HostVO host StartupCommand startup ServerResource resource Map String String details List String hostTags
Override public DeleteHostAnswer deleteHost HostVO host boolean isForced boolean isForceDeleteStorage throws UnableDeleteHostException
Override public Boolean fenceOff VirtualMachine vm Host host if host getHypervisorType HypervisorType Ovm3
Override public Boolean fenceOff VirtualMachine vm Host host if host getHypervisorType HypervisorType Ovm3 LOGGER debug host getHypervisorType return null else LOGGER debug vm host fenceParams List HostVO hosts resourceMgr listAllHostsInCluster host getClusterId FenceCommand fence new FenceCommand vm host for HostVO h hosts if h getHypervisorType HypervisorType Ovm3 h getStatus Status Up h getId host getId FenceAnswer answer try answer FenceAnswer agentMgr send h getId fence catch AgentUnavailableException OperationTimedoutException e if LOGGER isDebugEnabled
else LOGGER debug vm host fenceParams List HostVO hosts resourceMgr listAllHostsInCluster host getClusterId FenceCommand fence new FenceCommand vm host for HostVO h hosts if h getHypervisorType HypervisorType Ovm3 h getStatus Status Up h getId host getId FenceAnswer answer try answer FenceAnswer agentMgr send h getId fence catch AgentUnavailableException OperationTimedoutException e if LOGGER isDebugEnabled LOGGER debug h toString e continue if answer null answer getResult return true
Override public Pair Boolean Long getCommandHostDelegation long hostId Command cmd
Override public StartupCommand initialize LOGGER debug try StartupRoutingCommand srCmd new StartupRoutingCommand StartupStorageCommand ssCmd new StartupStorageCommand hypervisorsupport fillHostInfo srCmd hypervisorsupport vmStateMapClear
Override public PingCommand getCurrentStatus long id try Common test new Common c String ping String pong test echo ping if pong contains ping hypervisorsupport syncState CloudstackPlugin cSp new CloudstackPlugin c if cSp dom0CheckStorageHealthCheck configuration getAgentScriptsDir configuration getAgentCheckStorageScript configuration getCsHostGuid configuration getAgentStorageCheckTimeout configuration getAgentStorageCheckInterval cSp dom0CheckStorageHealthCheck
try Common test new Common c String ping String pong test echo ping if pong contains ping hypervisorsupport syncState CloudstackPlugin cSp new CloudstackPlugin c if cSp dom0CheckStorageHealthCheck configuration getAgentScriptsDir configuration getAgentCheckStorageScript configuration getCsHostGuid configuration getAgentStorageCheckTimeout configuration getAgentStorageCheckInterval cSp dom0CheckStorageHealthCheck LOGGER error configuration getAgentHostname else if cSp dom0CheckStorageHealthCheck LOGGER error configuration getAgentHostname else LOGGER debug configuration getAgentHostname return new PingRoutingCommand getType id hypervisorsupport hostVmStateReport else
String ping String pong test echo ping if pong contains ping hypervisorsupport syncState CloudstackPlugin cSp new CloudstackPlugin c if cSp dom0CheckStorageHealthCheck configuration getAgentScriptsDir configuration getAgentCheckStorageScript configuration getCsHostGuid configuration getAgentStorageCheckTimeout configuration getAgentStorageCheckInterval cSp dom0CheckStorageHealthCheck LOGGER error configuration getAgentHostname else if cSp dom0CheckStorageHealthCheck LOGGER error configuration getAgentHostname else LOGGER debug configuration getAgentHostname return new PingRoutingCommand getType id hypervisorsupport hostVmStateReport else LOGGER debug ping pong catch Ovm3ResourceException NullPointerException e
Override public Answer executeRequest Command cmd Class extends Command clazz cmd getClass
else if clazz MaintainCommand class return hypervisorsupport execute MaintainCommand cmd else if clazz CheckHealthCommand class return hypervisorsupport execute CheckHealthCommand cmd else if clazz ReadyCommand class return hypervisorsupport execute ReadyCommand cmd else if clazz FenceCommand class return hypervisorsupport execute FenceCommand cmd else if clazz CheckOnHostCommand class return hypervisorsupport execute CheckOnHostCommand cmd else if clazz PingTestCommand class return hypervisornetwork execute PingTestCommand cmd else if clazz CheckNetworkCommand class return hypervisornetwork execute CheckNetworkCommand cmd else if clazz GetVmStatsCommand class
Override public boolean configure String name Map String Object params throws ConfigurationException
public void setConnection Connection con
Override public synchronized StartAnswer execute StartCommand cmd VirtualMachineTO vmSpec cmd getVirtualMachine String vmName vmSpec getName State state State Stopped Xen xen new Xen c try hypervisorsupport setVmStateStarting vmName Xen Vm vm xen getVmConfig vm setVmCpus vmSpec getCpus vm setVmMemory vmSpec getMinRam vm setVmUuid UUID nameUUIDFromBytes vmSpec getName getBytes Charset defaultCharset toString vm setVmName vmName String domType guesttypes getOvm3GuestType vmSpec getOs if domType null domType isEmpty domType
String vmName vmSpec getName State state State Stopped Xen xen new Xen c try hypervisorsupport setVmStateStarting vmName Xen Vm vm xen getVmConfig vm setVmCpus vmSpec getCpus vm setVmMemory vmSpec getMinRam vm setVmUuid UUID nameUUIDFromBytes vmSpec getName getBytes Charset defaultCharset toString vm setVmName vmName String domType guesttypes getOvm3GuestType vmSpec getOs if domType null domType isEmpty domType LOGGER debug domType else
vm setupVifs vm setVnc vmSpec getVncPassword xen createVm ovmObject deDash vm getPrimaryPoolUuid vm getVmUuid xen startVm ovmObject deDash vm getPrimaryPoolUuid vm getVmUuid state State Running if vmSpec getType VirtualMachine Type User String controlIp null for NicTO nic vmSpec getNics if nic getType TrafficType Control controlIp nic getIp for int count count count CloudstackPlugin cSp new CloudstackPlugin c if hypervisorsupport getVmState vmName null count String msg vmName configuration getAgentHostname LOGGER debug msg
for int count count count CloudstackPlugin cSp new CloudstackPlugin c if hypervisorsupport getVmState vmName null count String msg vmName configuration getAgentHostname LOGGER debug msg state State Stopped return new StartAnswer cmd msg try Boolean res cSp domrCheckSsh controlIp LOGGER debug controlIp count res if res break catch Exception x LOGGER trace controlIp count x getMessage x Thread sleep
Override public StopAnswer execute StopCommand cmd String vmName cmd getVmName State state State Error hypervisorsupport setVmState vmName State Stopping try Xen vms new Xen c Xen Vm vm null vm vms getRunningVmConfig vmName if vm null state State Stopping
hypervisorsupport setVmState vmName State Stopping try Xen vms new Xen c Xen Vm vm null vm vms getRunningVmConfig vmName if vm null state State Stopping LOGGER debug vmName return new StopAnswer cmd true String repoId ovmObject deDash vm getVmRootDiskPoolId String vmId vm getVmUuid vms stopVm repoId vmId int tries while vms getRunningVmConfig vmName null tries String msg vmName
LOGGER debug vmName return new StopAnswer cmd true String repoId ovmObject deDash vm getVmRootDiskPoolId String vmId vm getVmUuid vms stopVm repoId vmId int tries while vms getRunningVmConfig vmName null tries String msg vmName LOGGER debug msg tries Thread sleep vms deleteVm repoId vmId vmsupport cleanup vm if vms getRunningVmConfig vmName null String msg vmName
vms stopVm repoId vmId int tries while vms getRunningVmConfig vmName null tries String msg vmName LOGGER debug msg tries Thread sleep vms deleteVm repoId vmId vmsupport cleanup vm if vms getRunningVmConfig vmName null String msg vmName LOGGER debug msg return new StopAnswer cmd msg false state State Stopped return new StopAnswer cmd true
public final Answer execute final CopyCommand cmd
public final Answer execute final CopyCommand cmd LOGGER debug cmd getClass DataTO srcData cmd getSrcTO DataStoreTO srcStore srcData getDataStore DataTO destData cmd getDestTO DataStoreTO destStore destData getDataStore String msg try if srcStore NfsTO srcData getObjectType DataObjectType TEMPLATE destData getObjectType DataObjectType TEMPLATE return copyTemplateToPrimaryStorage cmd else if srcData getObjectType DataObjectType TEMPLATE destData getObjectType DataObjectType VOLUME if srcStore getUrl equals destStore getUrl return cloneVolumeFromBaseTemplate cmd else msg
return copyTemplateToPrimaryStorage cmd else if srcData getObjectType DataObjectType TEMPLATE destData getObjectType DataObjectType VOLUME if srcStore getUrl equals destStore getUrl return cloneVolumeFromBaseTemplate cmd else msg LOGGER debug msg else if srcData getObjectType DataObjectType SNAPSHOT destData getObjectType DataObjectType SNAPSHOT return backupSnapshot cmd else if srcData getObjectType DataObjectType SNAPSHOT destData getObjectType DataObjectType TEMPLATE return createTemplateFromSnapshot cmd else if srcData getObjectType DataObjectType SNAPSHOT destData getObjectType DataObjectType VOLUME return createVolumeFromSnapshot cmd else msg srcStore getClass srcData getObjectType destStore getClass destData getObjectType
public Answer execute DeleteCommand cmd DataTO data cmd getData String msg
public CreateAnswer execute CreateCommand cmd
public CreateAnswer execute CreateCommand cmd LOGGER debug cmd getClass StorageFilerTO primaryStorage cmd getPool DiskProfile disk cmd getDiskCharacteristics String fileName UUID randomUUID toString String dst primaryStorage getPath primaryStorage getUuid fileName try StoragePlugin store new StoragePlugin c if cmd getTemplateUrl null
String fileName UUID randomUUID toString String dst primaryStorage getPath primaryStorage getUuid fileName try StoragePlugin store new StoragePlugin c if cmd getTemplateUrl null LOGGER debug cmd getTemplateUrl dst Linux host new Linux c host copyFile cmd getTemplateUrl dst else LOGGER debug dst store storagePluginCreate primaryStorage getUuid primaryStorage getHost dst disk getSize false FileProperties fp store storagePluginGetFileInfo primaryStorage getUuid primaryStorage getHost dst VolumeTO volume new VolumeTO cmd getVolumeId disk getType primaryStorage getType primaryStorage getUuid primaryStorage getPath fileName fp getName fp getSize null return new CreateAnswer cmd volume catch Exception e
Override public CopyCmdAnswer copyTemplateToPrimaryStorage CopyCommand cmd
DataStoreTO srcStore srcData getDataStore DataTO destData cmd getDestTO NfsTO srcImageStore NfsTO srcStore TemplateObjectTO destTemplate TemplateObjectTO destData try String secPoolUuid pool setupSecondaryStorage srcImageStore getUrl String primaryPoolUuid destData getDataStore getUuid String destPath config getAgentOvmRepoPath ovmObject deDash primaryPoolUuid config getTemplateDir String sourcePath config getAgentSecStoragePath secPoolUuid Linux host new Linux c String destUuid destTemplate getUuid String srcFile sourcePath srcData getPath if srcData getPath endsWith srcFile sourcePath srcData getPath destUuid String destFile destPath destUuid
Linux host new Linux c String destUuid destTemplate getUuid String srcFile sourcePath srcData getPath if srcData getPath endsWith srcFile sourcePath srcData getPath destUuid String destFile destPath destUuid LOGGER debug srcData getObjectType srcFile destData getObjectType destFile host copyFile srcFile destFile TemplateObjectTO newVol new TemplateObjectTO newVol setUuid destUuid newVol setPath destUuid newVol setFormat ImageFormat RAW return new CopyCmdAnswer newVol catch Ovm3ResourceException e String msg e getMessage
Override public Answer copyVolumeFromPrimaryToSecondary CopyCommand cmd
Override public CopyCmdAnswer cloneVolumeFromBaseTemplate CopyCommand cmd
Override public CopyCmdAnswer cloneVolumeFromBaseTemplate CopyCommand cmd LOGGER debug cmd getClass try DataTO srcData cmd getSrcTO TemplateObjectTO src TemplateObjectTO srcData String srcFile getVirtualDiskPath src getUuid src getDataStore getUuid srcFile srcFile replace config getVirtualDiskDir config getTemplateDir DataTO destData cmd getDestTO VolumeObjectTO dest VolumeObjectTO destData String destFile getVirtualDiskPath dest getUuid dest getDataStore getUuid Linux host new Linux c
String srcFile getVirtualDiskPath src getUuid src getDataStore getUuid srcFile srcFile replace config getVirtualDiskDir config getTemplateDir DataTO destData cmd getDestTO VolumeObjectTO dest VolumeObjectTO destData String destFile getVirtualDiskPath dest getUuid dest getDataStore getUuid Linux host new Linux c LOGGER debug srcData getObjectType srcFile destData getObjectType destFile host copyFile srcFile destFile VolumeObjectTO newVol new VolumeObjectTO newVol setUuid dest getUuid newVol setPath dest getUuid newVol setFormat ImageFormat RAW return new CopyCmdAnswer newVol catch Ovm3ResourceException e String msg e getMessage
Override public Answer createTemplateFromVolume CopyCommand cmd
Override public Answer copyVolumeFromImageCacheToPrimary CopyCommand cmd
Override public Answer createTemplateFromSnapshot CopyCommand cmd
TemplateObjectTO destTemplate TemplateObjectTO destData String secPoolUuidTemplate pool setupSecondaryStorage destData getDataStore getUrl String destDir config getAgentSecStoragePath secPoolUuidTemplate destTemplate getPath String destFile destDir destTemplate getUuid CloudstackPlugin csp new CloudstackPlugin c csp ovsMkdirs destDir Linux host new Linux c host copyFile srcFile destFile TemplateObjectTO newVol new TemplateObjectTO newVol setUuid destTemplate getUuid newVol setPath destTemplate getUuid newVol setFormat ImageFormat RAW return new CopyCmdAnswer newVol catch Ovm3ResourceException e String msg e getMessage
Override public CopyCmdAnswer backupSnapshot CopyCommand cmd
LOGGER debug cmd getClass try DataTO srcData cmd getSrcTO DataTO destData cmd getDestTO SnapshotObjectTO src SnapshotObjectTO srcData SnapshotObjectTO dest SnapshotObjectTO destData String srcFile getVirtualDiskPath src getPath src getDataStore getUuid String storeUrl dest getDataStore getUrl String secPoolUuid pool setupSecondaryStorage storeUrl String destDir config getAgentSecStoragePath secPoolUuid dest getPath String destFile destDir src getPath destFile destFile concat Linux host new Linux c CloudstackPlugin csp new CloudstackPlugin c csp ovsMkdirs destDir
String destFile destDir src getPath destFile destFile concat Linux host new Linux c CloudstackPlugin csp new CloudstackPlugin c csp ovsMkdirs destDir LOGGER debug srcData getObjectType srcFile destData getObjectType destFile host copyFile srcFile destFile StoragePlugin sp new StoragePlugin c sp storagePluginDestroy secPoolUuid srcFile SnapshotObjectTO newSnap new SnapshotObjectTO newSnap setPath dest getPath src getPath newSnap setParentSnapshotPath null return new CopyCmdAnswer newSnap catch Ovm3ResourceException e String msg e getMessage
public Answer execute CreateObjectCommand cmd
Override public AttachAnswer attachIso AttachCommand cmd
Override public AttachAnswer dettachIso DettachCommand cmd
private AttachAnswer attachDetach Command cmd String vmName DiskTO disk boolean isAttach Xen xen new Xen c String doThis isAttach
private AttachAnswer attachDetach Command cmd String vmName DiskTO disk boolean isAttach Xen xen new Xen c String doThis isAttach LOGGER debug doThis disk getType vmName String msg String path try Xen Vm vm xen getVmConfig vmName if vm null msg doThis vmName
LOGGER debug doThis disk getType vmName String msg String path try Xen Vm vm xen getVmConfig vmName if vm null msg doThis vmName LOGGER debug msg return new AttachAnswer msg if disk getType Volume Type ISO path getIsoPath disk else if disk getType Volume Type DATADISK path getVirtualDiskPath disk vm getPrimaryPoolUuid if equals path msg doThis
if disk getType Volume Type ISO path getIsoPath disk else if disk getType Volume Type DATADISK path getVirtualDiskPath disk vm getPrimaryPoolUuid if equals path msg doThis LOGGER debug msg return new AttachAnswer msg if isAttach if disk getType Volume Type ISO vm addIso path else vm addDataDisk path else if vm removeDisk path
Override public AttachAnswer attachVolume AttachCommand cmd
Override public AttachAnswer dettachVolume DettachCommand cmd
Override public Answer createVolume CreateObjectCommand cmd
String storeUrl data getDataStore getUrl URI uri new URI storeUrl String host uri getHost String file getVirtualDiskPath volume getUuid poolUuid Long size volume getSize StoragePlugin sp new StoragePlugin c FileProperties fp sp storagePluginCreate poolUuid host file size false if fp getName equals file return new CreateObjectAnswer fp getName file VolumeObjectTO newVol new VolumeObjectTO newVol setName volume getName newVol setSize fp getSize newVol setPath volume getUuid return new CreateObjectAnswer newVol catch Ovm3ResourceException URISyntaxException e
Override public Answer createSnapshot CreateObjectCommand cmd
Override public Answer deleteVolume DeleteCommand cmd
Override public Answer deleteVolume DeleteCommand cmd LOGGER debug cmd getClass DataTO data cmd getData VolumeObjectTO volume VolumeObjectTO data try String poolUuid data getDataStore getUuid String uuid volume getUuid String path getVirtualDiskPath uuid poolUuid StoragePlugin sp new StoragePlugin c sp storagePluginDestroy poolUuid path
public CopyVolumeAnswer execute CopyVolumeCommand cmd
String volumePath cmd getVolumePath String secondaryStorageURL cmd getSecondaryStorageURL int wait cmd getWait if wait wait try Linux host new Linux c if cmd toSecondaryStorage LOGGER debug volumePath secondaryStorageURL host copyFile volumePath secondaryStorageURL else LOGGER debug secondaryStorageURL volumePath host copyFile secondaryStorageURL volumePath return new CopyVolumeAnswer cmd true null null null catch Ovm3ResourceException e
public Answer execute DestroyCommand cmd
public CreatePrivateTemplateAnswer execute final CreatePrivateTemplateFromVolumeCommand cmd
Override public Answer createVolumeFromSnapshot CopyCommand cmd
SnapshotObjectTO srcSnap SnapshotObjectTO srcData String secPoolUuid pool setupSecondaryStorage srcImageStore getUrl String srcFile config getAgentSecStoragePath secPoolUuid srcSnap getPath DataTO destData cmd getDestTO VolumeObjectTO destVol VolumeObjectTO destData String primaryPoolUuid destData getDataStore getUuid String destFile getVirtualDiskPath destVol getUuid ovmObject deDash primaryPoolUuid Linux host new Linux c host copyFile srcFile destFile VolumeObjectTO newVol new VolumeObjectTO newVol setUuid destVol getUuid newVol setPath destVol getUuid newVol setFormat ImageFormat RAW return new CopyCmdAnswer newVol catch Ovm3ResourceException e
Override public Answer deleteSnapshot DeleteCommand cmd
Override public Answer deleteSnapshot DeleteCommand cmd LOGGER debug cmd getClass DataTO data cmd getData SnapshotObjectTO snap SnapshotObjectTO data String storeUrl data getDataStore getUrl String snapUuid snap getPath try String secPoolUuid pool setupSecondaryStorage storeUrl String filePath config getAgentSecStoragePath secPoolUuid snapUuid StoragePlugin sp new StoragePlugin c sp storagePluginDestroy secPoolUuid filePath
Override public Answer introduceObject IntroduceObjectCmd cmd
Override public Answer forgetObject ForgetObjectCmd cmd
public Answer execute AttachCommand cmd
public Answer execute DettachCommand cmd
Override public ExecutionResult createFileInVR String routerIp String path String filename String content String error null
private ExecutionResult prepNetBoth String routerName IpAddressTO ips String type Xen xen new Xen c try Xen Vm vm xen getVmConfig routerName for IpAddressTO ip ips Integer devId vm getVifIdByMac ip getVifMacAddress if devId equals type String msg vm getVmName ip getVifMacAddress
try Xen Vm vm xen getVmConfig routerName for IpAddressTO ip ips Integer devId vm getVifIdByMac ip getVifMacAddress if devId equals type String msg vm getVmName ip getVifMacAddress logger error msg return new ExecutionResult false msg else if devId equals type String msg vm getVmName ip getVifMacAddress logger debug msg devId ip setNicDevId devId catch Exception e String msg type e
private String validateParam String name String param throws ConfigurationException if param null String msg name
public void configureNetworking throws ConfigurationException try Network net new Network c String controlIface config getAgentControlNetworkName if controlIface null net getInterfaceByName controlIface null
public void configureNetworking throws ConfigurationException try Network net new Network c String controlIface config getAgentControlNetworkName if controlIface null net getInterfaceByName controlIface null LOGGER debug controlIface net startOvsLocalConfig controlIface int contCount while net getInterfaceByName controlIface null
public void configureNetworking throws ConfigurationException try Network net new Network c String controlIface config getAgentControlNetworkName if controlIface null net getInterfaceByName controlIface null LOGGER debug controlIface net startOvsLocalConfig controlIface int contCount while net getInterfaceByName controlIface null LOGGER debug controlIface Thread sleep if contCount throw new ConfigurationException controlIface config getAgentHostname contCount else
LOGGER debug controlIface net startOvsLocalConfig controlIface int contCount while net getInterfaceByName controlIface null LOGGER debug controlIface Thread sleep if contCount throw new ConfigurationException controlIface config getAgentHostname contCount else LOGGER debug controlIface net ovsIpConfig controlIface NetUtils getLinkLocalGateway NetUtils getLinkLocalNetMask CloudstackPlugin cSp new CloudstackPlugin c cSp ovsControlInterface controlIface NetUtils getLinkLocalCIDR catch InterruptedException e
while net getInterfaceByName controlIface null LOGGER debug controlIface Thread sleep if contCount throw new ConfigurationException controlIface config getAgentHostname contCount else LOGGER debug controlIface net ovsIpConfig controlIface NetUtils getLinkLocalGateway NetUtils getLinkLocalNetMask CloudstackPlugin cSp new CloudstackPlugin c cSp ovsControlInterface controlIface NetUtils getLinkLocalCIDR catch InterruptedException e LOGGER error e catch Ovm3ResourceException e String msg config getAgentHostname
private boolean isNetworkSetupByName String nameTag if nameTag null
private boolean isNetworkSetupByName String nameTag if nameTag null LOGGER debug nameTag try Network net new Network c net getInterfaceList if net getBridgeByName nameTag null
for PhysicalNetworkSetupInfo info infoList if info getGuestNetworkName null info setGuestNetworkName config getAgentGuestNetworkName if info getPublicNetworkName null info setPublicNetworkName config getAgentPublicNetworkName if info getPrivateNetworkName null info setPrivateNetworkName config getAgentPrivateNetworkName if info getStorageNetworkName null info setStorageNetworkName config getAgentStorageNetworkName if isNetworkSetupByName info getGuestNetworkName String msg info getPhysicalNetworkId info getGuestNetworkName LOGGER error msg return new CheckNetworkAnswer cmd false msg if isNetworkSetupByName info getPrivateNetworkName String msg info getPhysicalNetworkId info getPrivateNetworkName
if info getPublicNetworkName null info setPublicNetworkName config getAgentPublicNetworkName if info getPrivateNetworkName null info setPrivateNetworkName config getAgentPrivateNetworkName if info getStorageNetworkName null info setStorageNetworkName config getAgentStorageNetworkName if isNetworkSetupByName info getGuestNetworkName String msg info getPhysicalNetworkId info getGuestNetworkName LOGGER error msg return new CheckNetworkAnswer cmd false msg if isNetworkSetupByName info getPrivateNetworkName String msg info getPhysicalNetworkId info getPrivateNetworkName LOGGER error msg return new CheckNetworkAnswer cmd false msg if isNetworkSetupByName info getPublicNetworkName
private String createVlanBridge String networkName Integer vlanId throws Ovm3ResourceException if vlanId vlanId String msg vlanId
public File getSystemVMKeyFile String filename String keyPath Script findScript filename File keyFile null if keyPath null
public void fillHostInfo StartupRoutingCommand cmd try Linux host new Linux c if host getOvmVersion startsWith host getOvmVersion startsWith
throw new CloudRuntimeException c getIp if config getAgentPublicNetworkName null config setAgentPublicNetworkName defaultBridge if config getAgentPrivateNetworkName null config setAgentPrivateNetworkName config getAgentPublicNetworkName if config getAgentGuestNetworkName null config setAgentGuestNetworkName config getAgentPublicNetworkName if config getAgentStorageNetworkName null config setAgentStorageNetworkName config getAgentPrivateNetworkName Map String String d cmd getHostDetails d put config getAgentPublicNetworkName d put config getAgentPrivateNetworkName d put config getAgentGuestNetworkName d put config getAgentStorageNetworkName d put config getAgentIsMaster toString
oldStates new HashMap String State vmStateMap size oldStates putAll vmStateMap for final Map Entry String State entry newStates entrySet final String vmName entry getKey State newState entry getValue final State oldState oldStates remove vmName LOGGER trace vmName oldState newState if newState State Stopped oldState State Stopping oldState null oldState State Stopped LOGGER trace newState State Running if LOGGER isTraceEnabled LOGGER trace vmName newState oldState null oldState toString if newState State Migrating LOGGER trace vmName continue
LOGGER trace vmName oldState newState if newState State Stopped oldState State Stopping oldState null oldState State Stopped LOGGER trace newState State Running if LOGGER isTraceEnabled LOGGER trace vmName newState oldState null oldState toString if newState State Migrating LOGGER trace vmName continue if oldState null vmStateMap put vmName newState LOGGER debug vmName changes put vmName newState else if oldState State Starting if newState State Running
newState State Running if LOGGER isTraceEnabled LOGGER trace vmName newState oldState null oldState toString if newState State Migrating LOGGER trace vmName continue if oldState null vmStateMap put vmName newState LOGGER debug vmName changes put vmName newState else if oldState State Starting if newState State Running vmStateMap put vmName newState else if newState State Stopped LOGGER debug vmName
LOGGER trace vmName continue if oldState null vmStateMap put vmName newState LOGGER debug vmName changes put vmName newState else if oldState State Starting if newState State Running vmStateMap put vmName newState else if newState State Stopped LOGGER debug vmName else if oldState State Migrating if newState State Running LOGGER debug vmName vmStateMap put vmName newState
if newState State Running vmStateMap put vmName newState else if newState State Stopped LOGGER debug vmName else if oldState State Migrating if newState State Running LOGGER debug vmName vmStateMap put vmName newState else if oldState State Stopping if newState State Stopped vmStateMap put vmName newState else if newState State Running LOGGER debug vmName else if oldState newState vmStateMap put vmName newState
else if newState State Stopped LOGGER debug vmName else if oldState State Migrating if newState State Running LOGGER debug vmName vmStateMap put vmName newState else if oldState State Stopping if newState State Stopped vmStateMap put vmName newState else if newState State Running LOGGER debug vmName else if oldState newState vmStateMap put vmName newState if newState State Stopped changes put vmName newState
else if oldState State Migrating if newState State Running LOGGER debug vmName vmStateMap put vmName newState else if oldState State Stopping if newState State Stopped vmStateMap put vmName newState else if newState State Running LOGGER debug vmName else if oldState newState vmStateMap put vmName newState if newState State Stopped changes put vmName newState for final Map Entry String State entry oldStates entrySet final String vmName entry getKey
LOGGER debug vmName vmStateMap put vmName newState else if oldState State Stopping if newState State Stopped vmStateMap put vmName newState else if newState State Running LOGGER debug vmName else if oldState newState vmStateMap put vmName newState if newState State Stopped changes put vmName newState for final Map Entry String State entry oldStates entrySet final String vmName entry getKey final State oldState entry getValue if oldState State Stopping
else if oldState State Stopping if newState State Stopped vmStateMap put vmName newState else if newState State Running LOGGER debug vmName else if oldState newState vmStateMap put vmName newState if newState State Stopped changes put vmName newState for final Map Entry String State entry oldStates entrySet final String vmName entry getKey final State oldState entry getValue if oldState State Stopping LOGGER debug vmName vmStateMap remove vmName
public Map String HostVmStateReportEntry hostVmStateReport throws Ovm3ResourceException final Map String HostVmStateReportEntry vmStates new HashMap String HostVmStateReportEntry for final Map Entry String State vm vmStateMap entrySet
if equals config getOvm3PoolVip LOGGER debug return false try CloudstackPlugin cSp new CloudstackPlugin c if cSp dom0HasIp config getOvm3PoolVip LOGGER debug config getAgentHostname config getOvm3PoolVip config setAgentIsMaster true else if cSp ping config getOvm3PoolVip LOGGER debug config getAgentHostname config getOvm3PoolVip config setAgentHasMaster true else LOGGER debug config getAgentHostname config getOvm3PoolVip config setAgentIsMaster true catch Ovm3ResourceException e
Linux host new Linux c Pool pool new Pool c if host getIsMaster config getAgentInOvm3Cluster if pool getPoolMasterVip equalsIgnoreCase c getIp return new ReadyAnswer cmd else LOGGER debug pool getPoolMasterVip c getIp return new ReadyAnswer cmd else if host getIsMaster LOGGER debug config getAgentHostname return new ReadyAnswer cmd else LOGGER debug config getAgentHostname return new ReadyAnswer cmd catch CloudRuntimeException Ovm3ResourceException e
public CheckVirtualMachineAnswer execute final CheckVirtualMachineCommand cmd
String vmName cmd getVmName try CloudstackPlugin plug new CloudstackPlugin c Integer vncPort Integer valueOf plug getVncPort vmName if vncPort LOGGER warn vmName Map String State states getAllVmStates vmStateMap State vmState states get vmName if vmState null LOGGER warn vmName vmState State Stopped synchronized vmStateMap vmStateMap put vmName State Running return new CheckVirtualMachineAnswer cmd convertStateToPower vmState vncPort catch Ovm3ResourceException e
try Linux host new Linux c Pool pool new Pool c if host getServerRoles contentEquals pool getValidRoles toString LOGGER info config getAgentHostname else setRoles pool if host getMembershipState contentEquals if host getOvmVersion startsWith takeOwnership pool else if host getOvmVersion startsWith takeOwnership33x pool else if host getManagerUuid equals config getAgentOwnedByUuid String msg config getAgentHostname
LOGGER info config getAgentHostname else setRoles pool if host getMembershipState contentEquals if host getOvmVersion startsWith takeOwnership pool else if host getOvmVersion startsWith takeOwnership33x pool else if host getManagerUuid equals config getAgentOwnedByUuid String msg config getAgentHostname LOGGER debug msg return true else String msg config getAgentHostname
if host getMembershipState contentEquals if host getOvmVersion startsWith takeOwnership pool else if host getOvmVersion startsWith takeOwnership33x pool else if host getManagerUuid equals config getAgentOwnedByUuid String msg config getAgentHostname LOGGER debug msg return true else String msg config getAgentHostname LOGGER error msg throw new ConfigurationException msg catch ConfigurationException Ovm3ResourceException es
private Boolean setupPool StorageFilerTO cmd throws Ovm3ResourceException String primUuid cmd getUuid String ssUuid ovmObject deDash primUuid String fsType String clusterUuid config getAgentOwnedByUuid substring String managerId config getAgentOwnedByUuid String poolAlias cmd getHost cmd getPath String mountPoint String format cmd getHost cmd getPath Integer poolSize Pool poolHost new Pool c PoolOCFS2 poolFs new PoolOCFS2 c if config getAgentIsMaster try
try Connection m new Connection config getOvm3PoolVip c getPort c getUserName c getPassword Pool poolMaster new Pool m if poolMaster isInAPool members addAll poolMaster getPoolMemberList if poolMaster getPoolMemberList contains c getIp c getIp equals config getOvm3PoolVip members add c getIp else LOGGER warn c getIp config getOvm3PoolVip return false for String member members Connection x new Connection member c getPort c getUserName c getPassword Pool poolM new Pool x if poolM isInAPool poolM setPoolMemberList members
Repository repo new Repository c String primUuid repo deDash cmd getUuid String ovsRepo basePath primUuid String mountPoint String format cmd getHost cmd getPath String msg if cmd getType StoragePoolType NetworkFilesystem Boolean repoExists false try repo mountRepoFs mountPoint ovsRepo catch Ovm3ResourceException e LOGGER debug mountPoint ovsRepo config getAgentHostname e getMessage try repo addRepo mountPoint ovsRepo repoExists true catch Ovm3ResourceException e
Boolean repoExists false try repo mountRepoFs mountPoint ovsRepo catch Ovm3ResourceException e LOGGER debug mountPoint ovsRepo config getAgentHostname e getMessage try repo addRepo mountPoint ovsRepo repoExists true catch Ovm3ResourceException e LOGGER debug mountPoint ovsRepo e getMessage if repoExists try repo createRepo mountPoint ovsRepo primUuid catch Ovm3ResourceException e msg mountPoint ovsRepo
LOGGER debug mountPoint ovsRepo config getAgentHostname e getMessage try repo addRepo mountPoint ovsRepo repoExists true catch Ovm3ResourceException e LOGGER debug mountPoint ovsRepo e getMessage if repoExists try repo createRepo mountPoint ovsRepo primUuid catch Ovm3ResourceException e msg mountPoint ovsRepo LOGGER debug msg throw new CloudRuntimeException msg e getMessage e if config getAgentInOvm3Pool try
catch Ovm3ResourceException e LOGGER debug mountPoint ovsRepo e getMessage if repoExists try repo createRepo mountPoint ovsRepo primUuid catch Ovm3ResourceException e msg mountPoint ovsRepo LOGGER debug msg throw new CloudRuntimeException msg e getMessage e if config getAgentInOvm3Pool try msg config getAgentHostname config getAgentIp LOGGER debug msg setupPool cmd msg
repo createRepo mountPoint ovsRepo primUuid catch Ovm3ResourceException e msg mountPoint ovsRepo LOGGER debug msg throw new CloudRuntimeException msg e getMessage e if config getAgentInOvm3Pool try msg config getAgentHostname config getAgentIp LOGGER debug msg setupPool cmd msg if config getAgentInOvm3Cluster msg config getAgentHostname config getAgentIp LOGGER debug msg catch Ovm3ResourceException e
try msg config getAgentHostname config getAgentIp LOGGER debug msg setupPool cmd msg if config getAgentInOvm3Cluster msg config getAgentHostname config getAgentIp LOGGER debug msg catch Ovm3ResourceException e msg config getAgentHostname config getAgentIp ovsRepo throw new CloudRuntimeException msg e getMessage e else msg LOGGER debug msg try
msg config getAgentHostname config getAgentIp LOGGER debug msg catch Ovm3ResourceException e msg config getAgentHostname config getAgentIp ovsRepo throw new CloudRuntimeException msg e getMessage e else msg LOGGER debug msg try URI uri new URI cmd getType cmd getHost cmd getPort cmd getPath setupNfsStorage uri cmd getUuid catch Exception e msg mountPoint config getAgentSecStoragePath cmd getUuid throw new CloudRuntimeException msg e getMessage e else
private void prepareSecondaryStorageStore String storageUrl String poolUuid String host String mountPoint storageUrl GlobalLock lock GlobalLock getInternLock try if config getAgentHasMaster config getAgentInOvm3Pool LOGGER debug return if lock lock try File srcIso getSystemVMPatchIsoFile String destPath mountPoint try StoragePlugin sp new StoragePlugin c FileProperties fp sp storagePluginGetFileInfo poolUuid host destPath srcIso getName if fp getSize srcIso getTotalSpace
GlobalLock lock GlobalLock getInternLock try if config getAgentHasMaster config getAgentInOvm3Pool LOGGER debug return if lock lock try File srcIso getSystemVMPatchIsoFile String destPath mountPoint try StoragePlugin sp new StoragePlugin c FileProperties fp sp storagePluginGetFileInfo poolUuid host destPath srcIso getName if fp getSize srcIso getTotalSpace LOGGER info srcIso getAbsolutePath toString destPath catch Exception e
return if lock lock try File srcIso getSystemVMPatchIsoFile String destPath mountPoint try StoragePlugin sp new StoragePlugin c FileProperties fp sp storagePluginGetFileInfo poolUuid host destPath srcIso getName if fp getSize srcIso getTotalSpace LOGGER info srcIso getAbsolutePath toString destPath catch Exception e LOGGER info srcIso getAbsolutePath destPath try SshHelper scpTo c getIp config getAgentSshUserName null config getAgentSshPassword destPath srcIso getAbsolutePath toString catch Exception es
private String setupNfsStorage URI uri String uuid throws Ovm3ResourceException String fsUri String msg String mountPoint config getAgentSecStoragePath uuid Linux host new Linux c Map String Linux FileSystem fsList host getFileSystemMap fsUri Linux FileSystem fs fsList get uuid if fs null fs getRemoteDir equals mountPoint try StoragePlugin sp new StoragePlugin c sp storagePluginMountNFS uri getHost uri getPath uuid mountPoint msg uri mountPoint return uuid catch Ovm3ResourceException ec msg uri mountPoint ec getMessage
public GetStorageStatsAnswer execute final GetStorageStatsCommand cmd
public GetStorageStatsAnswer execute final GetStorageStatsCommand cmd LOGGER debug cmd getStorageId try Linux host new Linux c Linux FileSystem fs host getFileSystemByUuid cmd getStorageId StoragePlugin store new StoragePlugin c String propUuid store deDash cmd getStorageId String mntUuid cmd getStorageId if store null propUuid null mntUuid null fs null String msg cmd getStorageId
public GetStorageStatsAnswer execute final GetStorageStatsCommand cmd LOGGER debug cmd getStorageId try Linux host new Linux c Linux FileSystem fs host getFileSystemByUuid cmd getStorageId StoragePlugin store new StoragePlugin c String propUuid store deDash cmd getStorageId String mntUuid cmd getStorageId if store null propUuid null mntUuid null fs null String msg cmd getStorageId LOGGER error msg return new GetStorageStatsAnswer cmd msg StorageDetails sd store storagePluginGetFileSystemInfo propUuid mntUuid fs getHost fs getDevice if equals sd getSize String msg cmd getStorageId
String propUuid store deDash cmd getStorageId String mntUuid cmd getStorageId if store null propUuid null mntUuid null fs null String msg cmd getStorageId LOGGER error msg return new GetStorageStatsAnswer cmd msg StorageDetails sd store storagePluginGetFileSystemInfo propUuid mntUuid fs getHost fs getDevice if equals sd getSize String msg cmd getStorageId LOGGER debug msg return new GetStorageStatsAnswer cmd msg long total Long parseLong sd getSize long used total Long parseLong sd getFreeSize return new GetStorageStatsAnswer cmd total used catch Ovm3ResourceException e
public Answer execute ModifyStoragePoolCommand cmd StorageFilerTO pool cmd getPool
if config getAgentInOvm3Cluster if pool getType StoragePoolType NetworkFilesystem createRepo pool StoragePlugin store new StoragePlugin c String propUuid store deDash pool getUuid String mntUuid pool getUuid String nfsHost pool getHost String nfsPath pool getPath StorageDetails ss store storagePluginGetFileSystemInfo propUuid mntUuid nfsHost nfsPath Map String TemplateProp tInfo new HashMap String TemplateProp return new ModifyStoragePoolAnswer cmd Long parseLong ss getSize Long parseLong ss getFreeSize tInfo else if pool getType StoragePoolType OCFS2 createOCFS2Sr pool return new Answer cmd false pool getType name catch Exception e
public Answer execute CreateStoragePoolCommand cmd StorageFilerTO pool cmd getPool
args else if CREATE equals option args String vpcCIDR cmd getVpcCIDR args vpcCIDR else if equals option args else if equals option args else if equals option args else return new NetworkUsageAnswer cmd SUCCESS 0L 0L ExecutionResult callResult vrr executeInVR privateIp args if callResult isSuccess
public CheckSshAnswer execute CheckSshCommand cmd String vmName cmd getName String privateIp cmd getIp int cmdPort cmd getPort int interval cmd getInterval int retries cmd getRetries try CloudstackPlugin cSp new CloudstackPlugin c if cSp dom0CheckPort privateIp cmdPort retries interval String msg cmdPort vmName config getAgentHostname
String privateIp cmd getIp int cmdPort cmd getPort int interval cmd getInterval int retries cmd getRetries try CloudstackPlugin cSp new CloudstackPlugin c if cSp dom0CheckPort privateIp cmdPort retries interval String msg cmdPort vmName config getAgentHostname LOGGER info msg return new CheckSshAnswer cmd msg catch Exception e String msg cmdPort vmName config getAgentHostname e LOGGER error msg return new CheckSshAnswer cmd msg if LOGGER isDebugEnabled
private Boolean createVif Xen Vm vm NicTO nic throws Ovm3ResourceException try String net network getNetwork nic if net null
private Boolean deleteVif Xen Vm vm NicTO nic throws Ovm3ResourceException try String net network getNetwork nic if net null
public PrepareForMigrationAnswer execute PrepareForMigrationCommand cmd VirtualMachineTO vm cmd getVirtualMachine if LOGGER isDebugEnabled
public MigrateAnswer execute final MigrateCommand cmd final String vmName cmd getVmName String destUuid cmd getHostGuid String destIp cmd getDestinationIp State state State Error String msg vmName destIp
public MigrateAnswer execute final MigrateCommand cmd final String vmName cmd getVmName String destUuid cmd getHostGuid String destIp cmd getDestinationIp State state State Error String msg vmName destIp LOGGER info msg if config getAgentInOvm3Cluster config getAgentInOvm3Pool try Xen xen new Xen c Xen Vm vm xen getRunningVmConfig vmName HostVO destHost resourceMgr findHostByGuid destUuid if destHost null msg destUuid destIp
if config getAgentInOvm3Cluster config getAgentInOvm3Pool try Xen xen new Xen c Xen Vm vm xen getRunningVmConfig vmName HostVO destHost resourceMgr findHostByGuid destUuid if destHost null msg destUuid destIp LOGGER info msg return new MigrateAnswer cmd false msg null xen stopVm ovmObject deDash vm getVmRootDiskPoolId vm getVmUuid msg destHost toString state State Stopping return new MigrateAnswer cmd false msg null catch Ovm3ResourceException e msg vmName destUuid e getMessage
return new MigrateAnswer cmd false msg null finally hypervisor setVmState vmName state else try Xen xen new Xen c Xen Vm vm xen getRunningVmConfig vmName if vm null state State Stopped msg vmName config getAgentHostname return new MigrateAnswer cmd false msg null xen migrateVm ovmObject deDash vm getVmRootDiskPoolId vm getVmUuid destIp state State Stopping msg vmName return new MigrateAnswer cmd true msg null
public GetVncPortAnswer execute GetVncPortCommand cmd try Xen host new Xen c Xen Vm vm host getRunningVmConfig cmd getName Integer vncPort vm getVncPort
newVmStats cSp ovsDomUStats vmName catch Ovm3ResourceException e LOGGER info vmName e return stats if oldVmStats null LOGGER debug vmName stats setNumCPUs stats setNetworkReadKBs stats setNetworkWriteKBs stats setDiskReadKBs stats setDiskWriteKBs stats setDiskReadIOs stats setDiskWriteIOs stats setCPUUtilization stats setEntityType
public Boolean createVbds Xen Vm vm VirtualMachineTO spec if spec getDisks null
VolumeObjectTO vol VolumeObjectTO disk getData String diskFile processor getVirtualDiskPath vol getUuid vol getDataStore getUuid vm addRootDisk diskFile vm setPrimaryPoolUuid vol getDataStore getUuid LOGGER debug diskFile else if disk getType Volume Type ISO DataTO isoTO disk getData if isoTO getPath null TemplateObjectTO template TemplateObjectTO isoTO DataStoreTO store template getDataStore if store NfsTO throw new CloudRuntimeException NfsTO nfsStore NfsTO store String secPoolUuid pool setupSecondaryStorage nfsStore getUrl String isoPath config getAgentSecStoragePath secPoolUuid template getPath
else if disk getType Volume Type ISO DataTO isoTO disk getData if isoTO getPath null TemplateObjectTO template TemplateObjectTO isoTO DataStoreTO store template getDataStore if store NfsTO throw new CloudRuntimeException NfsTO nfsStore NfsTO store String secPoolUuid pool setupSecondaryStorage nfsStore getUrl String isoPath config getAgentSecStoragePath secPoolUuid template getPath vm addIso isoPath LOGGER debug isoPath else if disk getType Volume Type DATADISK VolumeObjectTO vol VolumeObjectTO disk getData String diskFile processor getVirtualDiskPath vol getUuid vol getDataStore getUuid
Override public Object callTimeoutInSec String method List params int timeout boolean debug throws XmlRpcException XmlRpcStreamConfig config new XmlRpcHttpRequestConfigImpl XmlRpcClient client new XmlRpcClient client setTypeFactory new RpcTypeFactory client XmlRpcResponseParser parser new XmlRpcResponseParser XmlRpcStreamRequestConfig config client getTypeFactory XMLReader xr SAXParsers newXMLReader xr setContentHandler parser try String result null if getMethodResponse method null result getMethodResponse method
Override public Object callTimeoutInSec String method List params int timeout boolean debug throws XmlRpcException XmlRpcStreamConfig config new XmlRpcHttpRequestConfigImpl XmlRpcClient client new XmlRpcClient client setTypeFactory new RpcTypeFactory client XmlRpcResponseParser parser new XmlRpcResponseParser XmlRpcStreamRequestConfig config client getTypeFactory XMLReader xr SAXParsers newXMLReader xr setContentHandler parser try String result null if getMethodResponse method null result getMethodResponse method LOGGER debug method params LOGGER trace result if result null multiRes size result getResult
mockHost setPrivateIpAddress ipAddress mockHost setPublicIpAddress ipAddress mockHost setStorageIpAddress ipAddress mockHost setPrivateMacAddress macAddress mockHost setPublicMacAddress macAddress mockHost setStorageMacAddress macAddress mockHost setVersion this getClass getPackage getImplementationVersion mockHost setResource TransactionLegacy txn TransactionLegacy open TransactionLegacy SIMULATOR_DB try txn start mockHost _mockHostDao persist mockHost txn commit catch Exception ex txn rollback
Override public Answer plugSecondaryIp final NetworkRulesVmSecondaryIpCommand cmd
Override public Answer createVmSnapshot final CreateVMSnapshotCommand cmd final String vmName cmd getVmName final String vmSnapshotName cmd getTarget getSnapshotName
private boolean logSecurityGroupAction final SecurityGroupRulesCmd cmd final Ternary String Long Long rule String action String reason final Long currSeqnum rule null null rule third final String currSig rule null null rule first boolean updateSeqnoAndSig false if currSeqnum null if cmd getSeqNum currSeqnum
private boolean logSecurityGroupAction final SecurityGroupRulesCmd cmd final Ternary String Long Long rule String action String reason final Long currSeqnum rule null null rule third final String currSig rule null null rule first boolean updateSeqnoAndSig false if currSeqnum null if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum updateSeqnoAndSig true if cmd getSignature equals currSig
private boolean logSecurityGroupAction final SecurityGroupRulesCmd cmd final Ternary String Long Long rule String action String reason final Long currSeqnum rule null null rule third final String currSig rule null null rule first boolean updateSeqnoAndSig false if currSeqnum null if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum updateSeqnoAndSig true if cmd getSignature equals currSig s_logger info cmd getSeqNum currSeqnum cmd getSignature currSig action reason reason else
final Long currSeqnum rule null null rule third final String currSig rule null null rule first boolean updateSeqnoAndSig false if currSeqnum null if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum updateSeqnoAndSig true if cmd getSignature equals currSig s_logger info cmd getSeqNum currSeqnum cmd getSignature currSig action reason reason else s_logger info cmd getSeqNum currSeqnum cmd getSignature reason reason else if cmd getSeqNum currSeqnum
if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum updateSeqnoAndSig true if cmd getSignature equals currSig s_logger info cmd getSeqNum currSeqnum cmd getSignature currSig action reason reason else s_logger info cmd getSeqNum currSeqnum cmd getSignature reason reason else if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum reason reason else if cmd getSignature equals currSig
action reason reason else s_logger info cmd getSeqNum currSeqnum cmd getSignature reason reason else if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum reason reason else if cmd getSignature equals currSig s_logger info cmd getSeqNum cmd getSignature currSig action reason reason updateSeqnoAndSig true else
else s_logger info cmd getSeqNum currSeqnum cmd getSignature reason reason else if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum reason reason else if cmd getSignature equals currSig s_logger info cmd getSeqNum cmd getSignature currSig action reason reason updateSeqnoAndSig true else s_logger info cmd getSeqNum currSeqnum cmd getSignature reason reason
else if cmd getSeqNum currSeqnum s_logger info cmd getSeqNum currSeqnum reason reason else if cmd getSignature equals currSig s_logger info cmd getSeqNum cmd getSignature currSig action reason reason updateSeqnoAndSig true else s_logger info cmd getSeqNum currSeqnum cmd getSignature reason reason else s_logger info cmd getSeqNum updateSeqnoAndSig true
DB Override public Answer simulate final Command cmd final String hostGuid
final int index cmdName lastIndexOf if index cmdName cmdName substring index final SimulatorInfo info new SimulatorInfo info setHostUuid hostGuid final MockConfigurationVO config _mockConfigDao findByNameBottomUP host getDataCenterId host getPodId host getClusterId host getId cmdName if config null config getCount null config getCount intValue final Map String String configParameters config getParameters for final Map Entry String String entry configParameters entrySet if entry getKey equalsIgnoreCase info setEnabled Boolean parseBoolean entry getValue else if entry getKey equalsIgnoreCase try info setTimeout Integer valueOf entry getValue catch final NumberFormatException e
final MockConfigurationVO config _mockConfigDao findByNameBottomUP host getDataCenterId host getPodId host getClusterId host getId cmdName if config null config getCount null config getCount intValue final Map String String configParameters config getParameters for final Map Entry String String entry configParameters entrySet if entry getKey equalsIgnoreCase info setEnabled Boolean parseBoolean entry getValue else if entry getKey equalsIgnoreCase try info setTimeout Integer valueOf entry getValue catch final NumberFormatException e s_logger debug e toString if entry getKey equalsIgnoreCase try final int wait Integer valueOf entry getValue Thread sleep wait
final Map String String configParameters config getParameters for final Map Entry String String entry configParameters entrySet if entry getKey equalsIgnoreCase info setEnabled Boolean parseBoolean entry getValue else if entry getKey equalsIgnoreCase try info setTimeout Integer valueOf entry getValue catch final NumberFormatException e s_logger debug e toString if entry getKey equalsIgnoreCase try final int wait Integer valueOf entry getValue Thread sleep wait catch final NumberFormatException e s_logger debug e toString
answer _mockStorageMgr GetStorageStats GetStorageStatsCommand cmd else if cmd GetVolumeStatsCommand answer _mockStorageMgr getVolumeStats GetVolumeStatsCommand cmd else if cmd ManageSnapshotCommand answer _mockStorageMgr ManageSnapshot ManageSnapshotCommand cmd else if cmd BackupSnapshotCommand answer _mockStorageMgr BackupSnapshot BackupSnapshotCommand cmd info else if cmd CreateVolumeFromSnapshotCommand answer _mockStorageMgr CreateVolumeFromSnapshot CreateVolumeFromSnapshotCommand cmd else if cmd DeleteCommand answer _mockStorageMgr Delete DeleteCommand cmd else if cmd SecStorageVMSetupCommand answer _mockStorageMgr SecStorageVMSetup SecStorageVMSetupCommand cmd else if cmd CreatePrivateTemplateFromSnapshotCommand answer _mockStorageMgr CreatePrivateTemplateFromSnapshot CreatePrivateTemplateFromSnapshotCommand cmd
else if cmd BackupSnapshotCommand answer _mockStorageMgr BackupSnapshot BackupSnapshotCommand cmd info else if cmd CreateVolumeFromSnapshotCommand answer _mockStorageMgr CreateVolumeFromSnapshot CreateVolumeFromSnapshotCommand cmd else if cmd DeleteCommand answer _mockStorageMgr Delete DeleteCommand cmd else if cmd SecStorageVMSetupCommand answer _mockStorageMgr SecStorageVMSetup SecStorageVMSetupCommand cmd else if cmd CreatePrivateTemplateFromSnapshotCommand answer _mockStorageMgr CreatePrivateTemplateFromSnapshot CreatePrivateTemplateFromSnapshotCommand cmd else if cmd ComputeChecksumCommand answer _mockStorageMgr ComputeChecksum ComputeChecksumCommand cmd else if cmd CreatePrivateTemplateFromVolumeCommand answer _mockStorageMgr CreatePrivateTemplateFromVolume CreatePrivateTemplateFromVolumeCommand cmd else if cmd UploadStatusCommand
Override public Boolean fenceOff VirtualMachine vm Host host if host getHypervisorType HypervisorType Simulator
s_logger debug host getHypervisorType return null List HostVO hosts _resourceMgr listAllHostsInCluster host getClusterId FenceCommand fence new FenceCommand vm host for HostVO h hosts if h getHypervisorType HypervisorType Simulator if h getStatus Status Up continue if h getId host getId continue FenceAnswer answer null try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e if s_logger isDebugEnabled
FenceCommand fence new FenceCommand vm host for HostVO h hosts if h getHypervisorType HypervisorType Simulator if h getStatus Status Up continue if h getId host getId continue FenceAnswer answer null try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e if s_logger isDebugEnabled s_logger debug h toString e continue catch OperationTimedoutException e
if h getId host getId continue FenceAnswer answer null try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e if s_logger isDebugEnabled s_logger debug h toString e continue catch OperationTimedoutException e if s_logger isDebugEnabled s_logger debug h toString e continue if answer null answer getResult return true
Override public Status isAgentAlive Host agent if agent getHypervisorType HypervisorType Simulator return null if haManager isHAEligible agent return haManager getHostStatus agent CheckOnHostCommand cmd new CheckOnHostCommand agent List HostVO neighbors _resourceMgr listHostsInClusterByStatus agent getClusterId Status Up for HostVO neighbor neighbors if neighbor getId agent getId neighbor getHypervisorType Hypervisor HypervisorType Simulator continue try Answer answer _agentMgr easySend neighbor getId cmd if answer null return answer getResult Status Up Status Down catch Exception e
if haManager isHAEligible host return haManager isVMAliveOnHost host CheckVirtualMachineCommand cmd new CheckVirtualMachineCommand vm getInstanceName try Answer answer _agentMgr send vm getHostId cmd if answer getResult s_logger debug vm toString throw new UnknownVM CheckVirtualMachineAnswer cvmAnswer CheckVirtualMachineAnswer answer s_logger debug cvmAnswer getState toString return cvmAnswer getState PowerState PowerOn catch AgentUnavailableException e s_logger debug vm toString e getMessage throw new UnknownVM catch OperationTimedoutException e
private void reconnect MockHost host if s_logger isDebugEnabled
protected String findScript String script
protected String findScript String script s_logger debug script URL url ClassLoader getSystemResource script File file null if url null file new File script
if entry getKey equalsIgnoreCase String value entry getValue if value equalsIgnoreCase return null config _simMgr getMockConfigurationDao findByNameBottomUP agentHost getDataCenterId agentHost getPodId agentHost getClusterId agentHost getId if config null String message config getJsonResponse if message null String objectType message split substring replace String objectData message substring message indexOf message length if objectType null Class clz null try clz Class forName objectType catch ClassNotFoundException e
Override public Map extends ServerResource Map String String find long dcId Long podId Long clusterId URI uri String username String password List String hostTags throws DiscoveryException Map AgentResourceBase Map String String resources try String scheme uri getScheme String host uri getAuthority String commands URLDecoder decode uri getPath long cpuSpeed MockAgentManager DEFAULT_HOST_SPEED_MHZ long cpuCores MockAgentManager DEFAULT_HOST_CPU_CORES long memory MockAgentManager DEFAULT_HOST_MEM_SIZE long localstorageSize MockStorageManager DEFAULT_HOST_STORAGE_SIZE if scheme equals if host null host startsWith String msg uri if s_logger isDebugEnabled
if parameter equalsIgnoreCase parameter null cpuSpeed Long parseLong parameter else if parameter equalsIgnoreCase parameter null cpuCores Long parseLong parameter else if parameter equalsIgnoreCase parameter null memory Long parseLong parameter else if parameter equalsIgnoreCase parameter null localstorageSize Long parseLong parameter else String msg uri if s_logger isDebugEnabled s_logger debug msg return null String cluster null if clusterId null
else String msg uri if s_logger isDebugEnabled s_logger debug msg return null String cluster null if clusterId null String msg if s_logger isDebugEnabled s_logger debug msg throw new RuntimeException msg else ClusterVO clu _clusterDao findById clusterId if clu null clu getHypervisorType HypervisorType Simulator if s_logger isInfoEnabled s_logger info
Override public Map extends ServerResource Map String String find long dcId Long podId Long clusterId URI uri String username String password List String hostTags if uri getScheme equalsIgnoreCase
TransactionLegacy txn TransactionLegacy currentTxn StringBuilder search new StringBuilder Formatter formatter new Formatter search formatter format name dcId podId clusterId hostId formatter format dcId podId clusterId formatter format dcId podId formatter format dcId formatter format formatter format formatter close String sql search toString try PreparedStatement pstmt txn prepareAutoCloseStatement sql ResultSet rs pstmt executeQuery if rs next return toEntityBean rs false catch Exception e
Override public String createEntityExtractUrl DataStore store String installPath Storage ImageFormat format DataObject dataObject EndPoint ep _epSelector select store if ep null String errMsg
private boolean isProfileAssociated Long ucsMgrId String dn UcsManagerVO mgrvo ucsDao findById ucsMgrId UcsHttpClient client new UcsHttpClient mgrvo getUrl String cookie getCookie ucsMgrId String cmd UcsCommands configResolveDn cookie dn String res client call cmd XmlObject xo XmlObjectParser parseFromString res
UcsHttpClient client new UcsHttpClient mgrvo getUrl String res client call ucscmd int count int timeout while count timeout if isProfileAssociated mgrvo getId bvo getDn break try TimeUnit SECONDS sleep catch InterruptedException e throw new CloudRuntimeException e count if count timeout throw new CloudRuntimeException String format pdn bvo getDn bvo setProfileDn pdn
Override public List Command finalizeExpungeNics VirtualMachine vm List NicProfile nics List Command commands new ArrayList Command List NicVO nicVOs _nicDao listByVmId vm getId for NicVO nic nicVOs NetworkVO network _networkDao findById nic getNetworkId if network getBroadcastDomainType BroadcastDomainType Lswitch
private DatacenterMO getDatacenterMO long zoneId throws Exception VmwareDatacenterVO vmwareDatacenter getVmwareDatacenter zoneId VmwareContext context VmwareContextFactory getContext vmwareDatacenter getVcenterHost vmwareDatacenter getUser vmwareDatacenter getPassword DatacenterMO dcMo new DatacenterMO context vmwareDatacenter getVmwareDatacenterName ManagedObjectReference dcMor dcMo getMor if dcMor null String msg vmwareDatacenter getVmwareDatacenterName
Override public boolean attachRestoredVolumeToVirtualMachine long zoneId String location Backup VolumeInfo volumeInfo VirtualMachine vm long poolId Backup backup throws Exception DatacenterMO dcMo getDatacenterMO zoneId VirtualMachineMO vmRestored findVM dcMo location VirtualMachineMO vmMo findVM dcMo vm getInstanceName VirtualDisk restoredDisk findRestoredVolume volumeInfo vmRestored String diskPath vmRestored getVmdkFileBaseName restoredDisk
Override public boolean attachRestoredVolumeToVirtualMachine long zoneId String location Backup VolumeInfo volumeInfo VirtualMachine vm long poolId Backup backup throws Exception DatacenterMO dcMo getDatacenterMO zoneId VirtualMachineMO vmRestored findVM dcMo location VirtualMachineMO vmMo findVM dcMo vm getInstanceName VirtualDisk restoredDisk findRestoredVolume volumeInfo vmRestored String diskPath vmRestored getVmdkFileBaseName restoredDisk s_logger debug toHumanReadableSize restoredDisk getCapacityInKB diskPath vmRestored detachAllDisks String srcPath getVolumeFullPath restoredDisk String destPath getDestVolumeFullPath restoredDisk vmRestored vmMo VirtualDiskManagerMO virtualDiskManagerMO new VirtualDiskManagerMO dcMo getContext virtualDiskManagerMO moveVirtualDisk srcPath dcMo getMor destPath dcMo getMor true try vmMo attachDisk new String destPath getDestStoreMor vmMo catch Exception e
s_logger debug toHumanReadableSize restoredDisk getCapacityInKB diskPath vmRestored detachAllDisks String srcPath getVolumeFullPath restoredDisk String destPath getDestVolumeFullPath restoredDisk vmRestored vmMo VirtualDiskManagerMO virtualDiskManagerMO new VirtualDiskManagerMO dcMo getContext virtualDiskManagerMO moveVirtualDisk srcPath dcMo getMor destPath dcMo getMor true try vmMo attachDisk new String destPath getDestStoreMor vmMo catch Exception e s_logger error diskPath e return false finally vmRestored destroy VirtualDisk attachedDisk getAttachedDisk vmMo diskPath if attachedDisk null
protected void configureNestedVirtualization Map String String details VirtualMachineTO to String localNestedV details get VmDetailConstants NESTED_VIRTUALIZATION_FLAG Boolean globalNestedVirtualisationEnabled getGlobalNestedVirtualisationEnabled Boolean globalNestedVPerVMEnabled getGlobalNestedVPerVMEnabled Boolean shouldEnableNestedVirtualization shouldEnableNestedVirtualization globalNestedVirtualisationEnabled globalNestedVPerVMEnabled localNestedV if LOG isDebugEnabled
VmwareManager mgr context getStockObject VmwareManager CONTEXT_STOCK_NAME assert mgr null if l null l size for VmwareCleanupMaid cleanupMaid l try VirtualMachineMO vmMo null if cleanupMaid getDatacenterMorValue null DatacenterMO dcMo new DatacenterMO context cleanupMaid getDatacenterMorValue vmMo dcMo findVm cleanupMaid getVmName else assert cleanupMaid getHostMorValue null HostMO hostMo new HostMO context cleanupMaid getHostMorValue ClusterMO clusterMo new ClusterMO context hostMo getHyperHostCluster vmMo clusterMo findVmOnHyperHost cleanupMaid getVmName if vmMo null
NetworkType zoneType zone getNetworkType _readGlobalConfigParameters if useDVS paramGuestVswitchType _urlParams get ApiConstants VSWITCH_TYPE_GUEST_TRAFFIC paramGuestVswitchName _urlParams get ApiConstants VSWITCH_NAME_GUEST_TRAFFIC paramPublicVswitchType _urlParams get ApiConstants VSWITCH_TYPE_PUBLIC_TRAFFIC paramPublicVswitchName _urlParams get ApiConstants VSWITCH_NAME_PUBLIC_TRAFFIC defaultVirtualSwitchType getDefaultVirtualSwitchType guestTrafficLabel _netmgr getDefaultGuestTrafficLabel dcId HypervisorType VMware guestTrafficLabelObj getTrafficInfo TrafficType Guest guestTrafficLabel defaultVirtualSwitchType paramGuestVswitchType paramGuestVswitchName clusterId if zoneType NetworkType Advanced publicTrafficLabel _netmgr getDefaultPublicTrafficLabel dcId HypervisorType VMware publicTrafficLabelObj getTrafficInfo TrafficType Public publicTrafficLabel defaultVirtualSwitchType paramPublicVswitchType paramPublicVswitchName clusterId List extends PhysicalNetwork pNetworkListGuestTraffic _netmgr getPhysicalNtwksSupportingTrafficType dcId TrafficType Guest List extends PhysicalNetwork pNetworkListPublicTraffic _netmgr getPhysicalNtwksSupportingTrafficType dcId TrafficType Public
paramGuestVswitchType _urlParams get ApiConstants VSWITCH_TYPE_GUEST_TRAFFIC paramGuestVswitchName _urlParams get ApiConstants VSWITCH_NAME_GUEST_TRAFFIC paramPublicVswitchType _urlParams get ApiConstants VSWITCH_TYPE_PUBLIC_TRAFFIC paramPublicVswitchName _urlParams get ApiConstants VSWITCH_NAME_PUBLIC_TRAFFIC defaultVirtualSwitchType getDefaultVirtualSwitchType guestTrafficLabel _netmgr getDefaultGuestTrafficLabel dcId HypervisorType VMware guestTrafficLabelObj getTrafficInfo TrafficType Guest guestTrafficLabel defaultVirtualSwitchType paramGuestVswitchType paramGuestVswitchName clusterId if zoneType NetworkType Advanced publicTrafficLabel _netmgr getDefaultPublicTrafficLabel dcId HypervisorType VMware publicTrafficLabelObj getTrafficInfo TrafficType Public publicTrafficLabel defaultVirtualSwitchType paramPublicVswitchType paramPublicVswitchName clusterId List extends PhysicalNetwork pNetworkListGuestTraffic _netmgr getPhysicalNtwksSupportingTrafficType dcId TrafficType Guest List extends PhysicalNetwork pNetworkListPublicTraffic _netmgr getPhysicalNtwksSupportingTrafficType dcId TrafficType Public PhysicalNetwork pNetworkPublic pNetworkListPublicTraffic get if pNetworkListGuestTraffic contains pNetworkPublic if publicTrafficLabelObj getVirtualSwitchType guestTrafficLabelObj getVirtualSwitchType
private VmwareDatacenterVO fetchVmwareDatacenterByZone Long dcId throws DiscoveryException VmwareDatacenterVO vmwareDc VmwareDatacenterZoneMapVO vmwareDcZone long vmwareDcId String msg vmwareDcZone _vmwareDcZoneMapDao findByZoneId dcId if vmwareDcZone null msg dcId
vCenterHost vmwareDc getVcenterHost try inventoryPath updatedInventoryPath URLDecoder decode url getPath catch UnsupportedEncodingException e throw new DiscoveredWithErrorException url getPath e assert inventoryPath null String pathTokens inventoryPath split if pathTokens length clusterName pathTokens updatedInventoryPath vmwareDcNameFromDb clusterName else if pathTokens length vmwareDcNameFromApi pathTokens clusterName pathTokens if vCenterHost equalsIgnoreCase url getHost msg clusterName url getHost vCenterHost vCenterHost vmwareDcNameFromDb
catch UnsupportedEncodingException e throw new DiscoveredWithErrorException url getPath e assert inventoryPath null String pathTokens inventoryPath split if pathTokens length clusterName pathTokens updatedInventoryPath vmwareDcNameFromDb clusterName else if pathTokens length vmwareDcNameFromApi pathTokens clusterName pathTokens if vCenterHost equalsIgnoreCase url getHost msg clusterName url getHost vCenterHost vCenterHost vmwareDcNameFromDb s_logger error msg throw new DiscoveryException msg else if vmwareDcNameFromDb equalsIgnoreCase vmwareDcNameFromApi
private void validateVswitchType String inputVswitchType VirtualSwitchType vSwitchType VirtualSwitchType getType inputVswitchType if vSwitchType VirtualSwitchType None
Override public void runInContext mine Thread currentThread
private void queryPoolForTemplates StoragePoolVO pool long zoneId if pool getHypervisor null Hypervisor HypervisorType VMware equals pool getHypervisor if s_logger isDebugEnabled
private boolean canRemoveTemplateFromZone long zoneId VMTemplateStoragePoolVO templateMapping if templateMapping getMarkedForGC if s_logger isDebugEnabled
Override public boolean configure String name Map String Object params throws ConfigurationException
_managemetPortGroupName _configDao getValue Config VmwareManagementPortGroup key if _managemetPortGroupName null _managemetPortGroupName _defaultSystemVmNicAdapterType _configDao getValue Config VmwareSystemVmNicDeviceType key if _defaultSystemVmNicAdapterType null _defaultSystemVmNicAdapterType VirtualEthernetCardType E1000 toString _additionalPortRangeStart NumbersUtil parseInt _configDao getValue Config VmwareAdditionalVncPortRangeStart key if _additionalPortRangeStart s_logger warn _additionalPortRangeStart _additionalPortRangeStart _additionalPortRangeSize NumbersUtil parseInt _configDao getValue Config VmwareAdditionalVncPortRangeSize key if _additionalPortRangeSize _additionalPortRangeStart _additionalPortRangeSize s_logger warn _additionalPortRangeSize _additionalPortRangeStart _additionalPortRangeSize Math min _additionalPortRangeStart _routerExtraPublicNics NumbersUtil parseInt _configDao getValue Config RouterExtraPublicNics key
AboutInfo about AboutInfo serviceContext getVimClient getDynamicProperty hosts get String version about getApiVersion int maxHostsPerCluster _hvCapabilitiesDao getMaxHostsPerCluster HypervisorType VMware version if hosts size maxHostsPerCluster String msg hosts size maxHostsPerCluster s_logger error msg throw new DiscoveredWithErrorException msg for ManagedObjectReference morHost hosts HostMO hostMo new HostMO serviceContext morHost prepareHost hostMo privateTrafficLabel returnedHostList add morHost return returnedHostList else if mor getType equals HostMO hostMo new HostMO serviceContext mor prepareHost hostMo privateTrafficLabel
Override public boolean needRecycle String workerTag if s_logger isInfoEnabled s_logger info workerTag if workerTag null workerTag isEmpty
Override public void prepareSecondaryStorageStore String storageUrl Long storeId String nfsVersion imageStoreDetailsUtil getNfsVersion storeId String mountPoint getMountPoint storageUrl nfsVersion GlobalLock lock GlobalLock getInternLock try if lock lock try File patchFolder new File mountPoint if patchFolder exists if patchFolder mkdirs String msg patchFolder toString
GlobalLock lock GlobalLock getInternLock try if lock lock try File patchFolder new File mountPoint if patchFolder exists if patchFolder mkdirs String msg patchFolder toString s_logger error msg throw new CloudRuntimeException msg File srcIso getSystemVMPatchIsoFile File destIso new File mountPoint getSystemVMIsoFileNameOnDatastore if destIso exists s_logger info _configServer updateKeyPairs
File patchFolder new File mountPoint if patchFolder exists if patchFolder mkdirs String msg patchFolder toString s_logger error msg throw new CloudRuntimeException msg File srcIso getSystemVMPatchIsoFile File destIso new File mountPoint getSystemVMIsoFileNameOnDatastore if destIso exists s_logger info _configServer updateKeyPairs s_logger info srcIso getAbsolutePath destIso getAbsolutePath try FileUtil copyfile srcIso destIso catch IOException e
if patchFolder mkdirs String msg patchFolder toString s_logger error msg throw new CloudRuntimeException msg File srcIso getSystemVMPatchIsoFile File destIso new File mountPoint getSystemVMIsoFileNameOnDatastore if destIso exists s_logger info _configServer updateKeyPairs s_logger info srcIso getAbsolutePath destIso getAbsolutePath try FileUtil copyfile srcIso destIso catch IOException e s_logger error e String msg srcIso toString destIso
private void startupCleanup String parent s_logger info long mshostId ManagementServerNode getManagementServerId List String mounts _storage listMountPointsByMsHost parent mshostId if mounts null mounts isEmpty for String mountPoint mounts
private void shutdownCleanup s_logger info for String mountPoint _storageMounts values
protected boolean shutdownRouterVM DomainRouterVO router if s_logger isDebugEnabled
Override public Map String String getNexusVSMCredentialsByClusterId Long clusterId CiscoNexusVSMDeviceVO nexusVSM null ClusterVSMMapVO vsmMapVO null vsmMapVO _vsmMapDao findByClusterId clusterId long vsmId if vsmMapVO null vsmId vsmMapVO getVsmId
throw new InvalidParameterValueException if password null throw new InvalidParameterValueException if vmwareDcName null throw new InvalidParameterValueException if vCenterHost null throw new InvalidParameterValueException if zoneId null throw new InvalidParameterValueException validateZone zoneId VmwareDatacenterZoneMapVO vmwareDcZoneMap vmwareDatacenterZoneMapDao findByZoneId zoneId if vmwareDcZoneMap null Long associatedVmwareDcId vmwareDcZoneMap getVmwareDcId VmwareDatacenterVO associatedVmwareDc vmwareDcDao findById associatedVmwareDcId if associatedVmwareDc getVcenterHost equalsIgnoreCase vCenterHost associatedVmwareDc getVmwareDatacenterName equalsIgnoreCase vmwareDcName
Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status vmwareDcDao remove vmwareDcId vmwareDatacenterZoneMapDao remove vmwareDcZoneMap getId VmwareContext context null try context VmwareContextFactory create vCenterHost userName password try dcMo new DatacenterMO context vmwareDcName catch Throwable t String msg vmwareDcName vCenterHost s_logger error msg throw new DiscoveryException msg assert dcMo null
vmwareDatacenterZoneMapDao remove vmwareDcZoneMap getId VmwareContext context null try context VmwareContextFactory create vCenterHost userName password try dcMo new DatacenterMO context vmwareDcName catch Throwable t String msg vmwareDcName vCenterHost s_logger error msg throw new DiscoveryException msg assert dcMo null dcMo setCustomFieldValue CustomFieldConstants CLOUD_ZONE s_logger info vmwareDcName catch Exception e
Override public boolean hasNexusVSM Long clusterId ClusterVSMMapVO vsmMapVo null vsmMapVo _vsmMapDao findByClusterId clusterId if vsmMapVo null
if s_logger isDebugEnabled s_logger debug if StorageManager StorageCleanupEnabled value StorageManager TemplateCleanupEnabled value templateCleanupInterval value try if s_logger isInfoEnabled s_logger info templateCleanupInterval value Runnable task getCleanupFullyClonedTemplatesTask templateCleanupScheduler scheduleAtFixedRate task templateCleanupInterval value templateCleanupInterval value TimeUnit MINUTES if s_logger isTraceEnabled s_logger trace catch RejectedExecutionException ree s_logger error s_logger debug ree catch NullPointerException npe s_logger error
if StorageManager StorageCleanupEnabled value StorageManager TemplateCleanupEnabled value templateCleanupInterval value try if s_logger isInfoEnabled s_logger info templateCleanupInterval value Runnable task getCleanupFullyClonedTemplatesTask templateCleanupScheduler scheduleAtFixedRate task templateCleanupInterval value templateCleanupInterval value TimeUnit MINUTES if s_logger isTraceEnabled s_logger trace catch RejectedExecutionException ree s_logger error s_logger debug ree catch NullPointerException npe s_logger error s_logger debug npe catch IllegalArgumentException iae
s_logger info templateCleanupInterval value Runnable task getCleanupFullyClonedTemplatesTask templateCleanupScheduler scheduleAtFixedRate task templateCleanupInterval value templateCleanupInterval value TimeUnit MINUTES if s_logger isTraceEnabled s_logger trace catch RejectedExecutionException ree s_logger error s_logger debug ree catch NullPointerException npe s_logger error s_logger debug npe catch IllegalArgumentException iae s_logger error s_logger debug iae catch Exception e
Override public void createOva String path String name int archiveTimeout Script commandSync new Script true s_logger commandSync execute Script command new Script false archiveTimeout s_logger command setWorkDir path command add name command add name command add name
NfsTO nfsStore NfsTO storeTO String secStorageUrl nfsStore getUrl assert secStorageUrl null String installPath template getPath String secondaryMountPoint _mountService getMountPoint secStorageUrl nfsStore getNfsVersion String installFullPath secondaryMountPoint installPath try if installFullPath endsWith if new File installFullPath exists s_logger debug installFullPath else if new File installFullPath exists createOVAFromMetafile installFullPath archiveTimeout else String msg
DataStoreTO storeTO volume getDataStore if storeTO NfsTO s_logger debug return null NfsTO nfsStore NfsTO storeTO String secStorageUrl nfsStore getUrl assert secStorageUrl null String installPath volume getPath int index installPath lastIndexOf File separator String volumeUuid installPath substring index String secondaryMountPoint _mountService getMountPoint secStorageUrl nfsStore getNfsVersion String volumePath installPath File separator volumeUuid String installFullPath secondaryMountPoint installPath try if new File secondaryMountPoint File separator volumePath exists
if templateName null templateName isEmpty templateName cmd getName else mountPoint templateUrl substring secondaryStorageUrl length if mountPoint endsWith mountPoint mountPoint templateName cmd getName VmwareContext context hostService getServiceContext cmd try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd String templateUuidName UUID nameUUIDFromBytes templateName cmd getPoolUuid hyperHost getMor getValue getBytes toString templateUuidName templateUuidName replace DatacenterMO dcMo new DatacenterMO context hyperHost getHyperHostDatacenter VirtualMachineMO templateMo VmwareHelper pickOneVmOnRunningHost dcMo findVmByNameAndLabel templateUuidName true if templateMo null
if mountPoint endsWith mountPoint mountPoint templateName cmd getName VmwareContext context hostService getServiceContext cmd try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd String templateUuidName UUID nameUUIDFromBytes templateName cmd getPoolUuid hyperHost getMor getValue getBytes toString templateUuidName templateUuidName replace DatacenterMO dcMo new DatacenterMO context hyperHost getHyperHostDatacenter VirtualMachineMO templateMo VmwareHelper pickOneVmOnRunningHost dcMo findVmByNameAndLabel templateUuidName true if templateMo null if s_logger isInfoEnabled s_logger info templateName templateUuidName ManagedObjectReference morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getPoolUuid assert morDs null
String volumePath cmd getVolumePath ManagedObjectReference morDs null DatastoreMO dsMo null String details null boolean success false String snapshotBackupUuid null VmwareContext context hostService getServiceContext cmd VirtualMachineMO vmMo null try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getPool getUuid try vmMo hyperHost findVmOnHyperHost cmd getVmName if vmMo null if s_logger isDebugEnabled
snapshotBackupUuid backupSnapshotToSecondaryStorage vmMo accountId volumeId cmd getVolumePath snapshotUuid secondaryStorageUrl prevSnapshotUuid prevBackupUuid hostService getWorkerName context cmd cmd getNfsVersion success snapshotBackupUuid null if success details snapshotUuid finally if vmMo null ManagedObjectReference snapshotMor vmMo getSnapshotMor snapshotUuid if snapshotMor null vmMo removeSnapshot snapshotUuid false try if workerVm null workerVm detachAllDisks workerVm destroy catch Throwable e s_logger warn workerVMName
Override public Answer execute VmwareHostService hostService CreatePrivateTemplateFromVolumeCommand cmd String secondaryStoragePoolURL cmd getSecondaryStorageUrl String volumePath cmd getVolumePath Long accountId cmd getAccountId Long templateId cmd getTemplateId String details null VmwareContext context hostService getServiceContext cmd try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd VirtualMachineMO vmMo hyperHost findVmOnHyperHost cmd getVmName if vmMo null if s_logger isDebugEnabled
String secondaryStoragePoolURL cmd getSecondaryStorageUrl String volumePath cmd getVolumePath Long accountId cmd getAccountId Long templateId cmd getTemplateId String details null VmwareContext context hostService getServiceContext cmd try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd VirtualMachineMO vmMo hyperHost findVmOnHyperHost cmd getVmName if vmMo null if s_logger isDebugEnabled s_logger debug hyperHost getHyperHostName vmMo hyperHost findVmOnPeerHyperHost cmd getVmName if vmMo null String msg cmd getVmName
result copyVolumeToSecStorage hostService hyperHost cmd vmName volumeId cmd getPool getUuid volumePath secondaryStorageURL hostService getWorkerName context cmd cmd getNfsVersion else StorageFilerTO poolTO cmd getPool ManagedObjectReference morDatastore HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost poolTO getUuid if morDatastore null morDatastore hyperHost mountDatastore false poolTO getHost poolTO getPath poolTO getUuid replace if morDatastore null throw new Exception poolTO getHost poolTO getPath result copyVolumeFromSecStorage hyperHost volumeId new DatastoreMO context morDatastore secondaryStorageURL volumePath cmd getNfsVersion deleteVolumeDirOnSecondaryStorage volumeId secondaryStorageURL cmd getNfsVersion return new CopyVolumeAnswer cmd true null result first result second catch Throwable e if e RemoteException hostService invalidateServiceContext context String msg
Override public Answer execute VmwareHostService hostService CreateVolumeFromSnapshotCommand cmd String primaryStorageNameLabel cmd getPrimaryStoragePoolNameLabel Long accountId cmd getAccountId Long volumeId cmd getVolumeId String secondaryStorageUrl cmd getSecondaryStorageUrl String backedUpSnapshotUuid cmd getSnapshotUuid String details null boolean success false String newVolumeName UUID randomUUID toString replace VmwareContext context hostService getServiceContext cmd try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd ManagedObjectReference morPrimaryDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost primaryStorageNameLabel if morPrimaryDs null String msg primaryStorageNameLabel
private void copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid String nfsVersion throws Exception
private void copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid String nfsVersion throws Exception s_logger info secondaryStorageUrl templatePathAtSecondaryStorage templateName String secondaryMountPoint _mountService getMountPoint secondaryStorageUrl nfsVersion
private void copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid String nfsVersion throws Exception s_logger info secondaryStorageUrl templatePathAtSecondaryStorage templateName String secondaryMountPoint _mountService getMountPoint secondaryStorageUrl nfsVersion s_logger info secondaryMountPoint String srcOVAFileName secondaryMountPoint templatePathAtSecondaryStorage templateName ImageFormat OVA getFileExtension String srcFileName getOVFFilePath srcOVAFileName if srcFileName null Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint templatePathAtSecondaryStorage
private void copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid String nfsVersion throws Exception s_logger info secondaryStorageUrl templatePathAtSecondaryStorage templateName String secondaryMountPoint _mountService getMountPoint secondaryStorageUrl nfsVersion s_logger info secondaryMountPoint String srcOVAFileName secondaryMountPoint templatePathAtSecondaryStorage templateName ImageFormat OVA getFileExtension String srcFileName getOVFFilePath srcOVAFileName if srcFileName null Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint templatePathAtSecondaryStorage s_logger info command toString String result command execute if result null String msg srcOVAFileName
String srcFileName getOVFFilePath srcOVAFileName if srcFileName null Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint templatePathAtSecondaryStorage s_logger info command toString String result command execute if result null String msg srcOVAFileName s_logger error msg throw new Exception msg srcFileName getOVFFilePath srcOVAFileName if srcFileName null String msg srcOVAFileName
String result command execute if result null String msg srcOVAFileName s_logger error msg throw new Exception msg srcFileName getOVFFilePath srcOVAFileName if srcFileName null String msg srcOVAFileName s_logger error msg throw new Exception msg String vmName templateUuid hyperHost importVmFromOVF srcFileName vmName datastoreMo VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null String msg secondaryStorageUrl templatePathAtSecondaryStorage templateName templateUuid
if srcFileName null String msg srcOVAFileName s_logger error msg throw new Exception msg String vmName templateUuid hyperHost importVmFromOVF srcFileName vmName datastoreMo VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null String msg secondaryStorageUrl templatePathAtSecondaryStorage templateName templateUuid s_logger error msg throw new Exception msg if vmMo createSnapshot false false vmMo setCustomFieldValue CustomFieldConstants CLOUD_UUID templateUuid vmMo markAsTemplate else
private Ternary String Long Long createTemplateFromVolume VirtualMachineMO vmMo long accountId long templateId String templateUniqueName String secStorageUrl String volumePath String workerVmName String nfsVersion throws Exception String secondaryMountPoint _mountService getMountPoint secStorageUrl nfsVersion String installPath getTemplateRelativeDirInSecStorage accountId templateId String installFullPath secondaryMountPoint installPath synchronized installPath intern Script command new Script false _timeout s_logger command add command add installFullPath String result command execute if result null String msg installPath secStorageUrl result
String installFullPath secondaryMountPoint installPath synchronized installPath intern Script command new Script false _timeout s_logger command add command add installFullPath String result command execute if result null String msg installPath secStorageUrl result s_logger error msg throw new Exception msg VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath
command add installFullPath String result command execute if result null String msg installPath secStorageUrl result s_logger error msg throw new Exception msg VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath s_logger error msg throw new Exception msg if vmMo createSnapshot templateUniqueName false false String msg volumePath
VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath s_logger error msg throw new Exception msg if vmMo createSnapshot templateUniqueName false false String msg volumePath s_logger error msg throw new Exception msg vmMo cloneFromCurrentSnapshot workerVmName volumeDeviceInfo second VmwareHelper getDiskDeviceDatastore volumeDeviceInfo first clonedVm vmMo getRunningHost findVmOnHyperHost workerVmName if clonedVm null String msg volumePath
String snapshotRoot secondaryMountPoint getSnapshotRelativeDirInSecStorage accountId volumeId String snapshotFullOVAName snapshotRoot backedUpSnapshotUuid String snapshotFullOvfName snapshotRoot backedUpSnapshotUuid String result Script command String templateVMDKName String backupSSUuid backedUpSnapshotUuid substring backedUpSnapshotUuid indexOf String snapshotFullVMDKName snapshotRoot backupSSUuid synchronized installPath intern command new Script false _timeout s_logger command add command add installFullPath result command execute if result null String msg installPath secStorageUrl result
command add command add installFullPath result command execute if result null String msg installPath secStorageUrl result s_logger error msg throw new Exception msg try if new File snapshotFullOVAName exists command new Script false _timeout s_logger command add snapshotFullOVAName command add installFullOVAName result command execute if result null String msg snapshotFullOVAName installFullPath
throw new Exception msg try if new File snapshotFullOVAName exists command new Script false _timeout s_logger command add snapshotFullOVAName command add installFullOVAName result command execute if result null String msg snapshotFullOVAName installFullPath s_logger error msg throw new Exception msg command new Script s_logger command add command add installFullOVAName command setWorkDir installFullPath
if new File snapshotFullOVAName exists command new Script false _timeout s_logger command add snapshotFullOVAName command add installFullOVAName result command execute if result null String msg snapshotFullOVAName installFullPath s_logger error msg throw new Exception msg command new Script s_logger command add command add installFullOVAName command setWorkDir installFullPath s_logger info command toString result command execute
command new Script s_logger command add command add installFullOVAName command setWorkDir installFullPath s_logger info command toString result command execute if result null String msg snapshotFullOVAName installFullPath s_logger error msg throw new Exception msg else if new File snapshotFullOvfName exists command new Script false _timeout s_logger command add snapshotFullOvfName command add installFullPath
result command execute if result null String msg snapshotFullOvfName installFullPath s_logger error msg throw new Exception msg s_logger info snapshotFullVMDKName File snapshotdir new File snapshotFullVMDKName File ssfiles snapshotdir listFiles for int i i ssfiles length i String vmdkfile ssfiles i getName s_logger info vmdkfile if vmdkfile toLowerCase startsWith backupSSUuid vmdkfile toLowerCase endsWith snapshotFullVMDKName vmdkfile templateVMDKName vmdkfile break
s_logger error msg throw new Exception msg s_logger info snapshotFullVMDKName File snapshotdir new File snapshotFullVMDKName File ssfiles snapshotdir listFiles for int i i ssfiles length i String vmdkfile ssfiles i getName s_logger info vmdkfile if vmdkfile toLowerCase startsWith backupSSUuid vmdkfile toLowerCase endsWith snapshotFullVMDKName vmdkfile templateVMDKName vmdkfile break if snapshotFullVMDKName null command new Script false _timeout s_logger command add snapshotFullVMDKName
String secondaryMountPoint _mountService getMountPoint secStorageUrl nfsVersion String srcOVAFileName secondaryMountPoint secStorageDir backupName ImageFormat OVA getFileExtension String snapshotDir if backupName contains snapshotDir backupName split File ovafile new File srcOVAFileName String srcOVFFileName secondaryMountPoint secStorageDir backupName File ovfFile new File srcOVFFileName if ovfFile exists srcOVFFileName getOVFFilePath srcOVAFileName if srcOVFFileName null ovafile exists Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir
snapshotDir backupName split File ovafile new File srcOVAFileName String srcOVFFileName secondaryMountPoint secStorageDir backupName File ovfFile new File srcOVFFileName if ovfFile exists srcOVFFileName getOVFFilePath srcOVAFileName if srcOVFFileName null ovafile exists Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir s_logger info command toString String result command execute if result null String msg srcOVAFileName
File ovfFile new File srcOVFFileName if ovfFile exists srcOVFFileName getOVFFilePath srcOVAFileName if srcOVFFileName null ovafile exists Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir s_logger info command toString String result command execute if result null String msg srcOVAFileName s_logger error msg throw new Exception msg else
command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir s_logger info command toString String result command execute if result null String msg srcOVAFileName s_logger error msg throw new Exception msg else String msg srcOVAFileName s_logger error msg throw new Exception msg srcOVFFileName getOVFFilePath srcOVAFileName if srcOVFFileName null
private void exportVolumeToSecondaryStorage VirtualMachineMO vmMo String volumePath String secStorageUrl String secStorageDir String exportName String workerVmName String nfsVersion boolean clonedWorkerVMNeeded throws Exception String secondaryMountPoint _mountService getMountPoint secStorageUrl nfsVersion String exportPath secondaryMountPoint secStorageDir exportName synchronized exportPath intern if new File exportPath exists Script command new Script false _timeout s_logger command add command add exportPath if command execute null throw new Exception VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath
command add exportPath if command execute null throw new Exception VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath s_logger error msg throw new Exception msg if clonedWorkerVMNeeded vmMo cloneFromCurrentSnapshot workerVmName volumeDeviceInfo second VmwareHelper getDiskDeviceDatastore volumeDeviceInfo first clonedVm vmMo getRunningHost findVmOnHyperHost workerVmName if clonedVm null String msg volumePath
private Pair String String copyVolumeToSecStorage VmwareHostService hostService VmwareHypervisorHost hyperHost CopyVolumeCommand cmd String vmName long volumeId String poolId String volumePath String secStorageUrl String workerVmName String nfsVersion throws Exception String volumeFolder String valueOf volumeId VirtualMachineMO workerVm null VirtualMachineMO vmMo null String exportName UUID randomUUID toString String searchExcludedFolders cmd getContextParam try ManagedObjectReference morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost poolId if morDs null String msg
String exportName UUID randomUUID toString String searchExcludedFolders cmd getContextParam try ManagedObjectReference morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost poolId if morDs null String msg s_logger error msg throw new Exception msg boolean clonedWorkerVMNeeded true vmMo hyperHost findVmOnHyperHost vmName if vmMo null DatastoreMO dsMo new DatastoreMO hyperHost getContext morDs workerVm HypervisorHostHelper createWorkerVM hyperHost dsMo workerVmName if workerVm null String msg
private String createOVAFromMetafile String metafileName int archiveTimeout throws Exception File ova_metafile new File metafileName Properties props null String ovaFileName
private String createOVAFromMetafile String metafileName int archiveTimeout throws Exception File ova_metafile new File metafileName Properties props null String ovaFileName s_logger info metafileName try FileInputStream strm new FileInputStream ova_metafile
private String createOVAFromMetafile String metafileName int archiveTimeout throws Exception File ova_metafile new File metafileName Properties props null String ovaFileName s_logger info metafileName try FileInputStream strm new FileInputStream ova_metafile s_logger info metafileName props new Properties props load strm ovaFileName props getProperty
private String createOVAFromMetafile String metafileName int archiveTimeout throws Exception File ova_metafile new File metafileName Properties props null String ovaFileName s_logger info metafileName try FileInputStream strm new FileInputStream ova_metafile s_logger info metafileName props new Properties props load strm ovaFileName props getProperty s_logger info ovaFileName String ovfFileName props getProperty
File ova_metafile new File metafileName Properties props null String ovaFileName s_logger info metafileName try FileInputStream strm new FileInputStream ova_metafile s_logger info metafileName props new Properties props load strm ovaFileName props getProperty s_logger info ovaFileName String ovfFileName props getProperty s_logger info ovfFileName int diskNum Integer parseInt props getProperty if diskNum String msg
ovaFileName props getProperty s_logger info ovaFileName String ovfFileName props getProperty s_logger info ovfFileName int diskNum Integer parseInt props getProperty if diskNum String msg s_logger error msg throw new Exception msg String disks new String diskNum for int i i diskNum i String diskNameKey disks i props getProperty diskNameKey s_logger info disks i String exportDir ova_metafile getParent
String ovfFileName props getProperty s_logger info ovfFileName int diskNum Integer parseInt props getProperty if diskNum String msg s_logger error msg throw new Exception msg String disks new String diskNum for int i i diskNum i String diskNameKey disks i props getProperty diskNameKey s_logger info disks i String exportDir ova_metafile getParent s_logger info exportDir s_logger info
String diskNameKey disks i props getProperty diskNameKey s_logger info disks i String exportDir ova_metafile getParent s_logger info exportDir s_logger info s_logger info ovaFileName ovfFileName disks Script commandSync new Script true s_logger commandSync execute Script command new Script false archiveTimeout s_logger command setWorkDir exportDir command add ovaFileName command add ovfFileName for String diskName disks command add diskName
s_logger info disks i String exportDir ova_metafile getParent s_logger info exportDir s_logger info s_logger info ovaFileName ovfFileName disks Script commandSync new Script true s_logger commandSync execute Script command new Script false archiveTimeout s_logger command setWorkDir exportDir command add ovaFileName command add ovfFileName for String diskName disks command add diskName command execute s_logger info exportDir command toString
try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd ManagedObjectReference taskmgr context getServiceContent getTaskManager List ManagedObjectReference tasks context getVimClient getDynamicProperty taskmgr for ManagedObjectReference taskMor tasks TaskInfo info TaskInfo context getVimClient getDynamicProperty taskMor if info getEntityName equals cmd getVmName StringUtils isNotBlank info getName info getName equalsIgnoreCase if info getState equals TaskInfoState SUCCESS info getState equals TaskInfoState ERROR s_logger debug context getVimClient waitForTask taskMor vmMo hyperHost findVmOnHyperHost vmName if vmMo null vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg
for ManagedObjectReference taskMor tasks TaskInfo info TaskInfo context getVimClient getDynamicProperty taskMor if info getEntityName equals cmd getVmName StringUtils isNotBlank info getName info getName equalsIgnoreCase if info getState equals TaskInfoState SUCCESS info getState equals TaskInfoState ERROR s_logger debug context getVimClient waitForTask taskMor vmMo hyperHost findVmOnHyperHost vmName if vmMo null vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg s_logger info msg return new CreateVMSnapshotAnswer cmd false msg else if vmMo getSnapshotMor vmSnapshotName null
vmMo hyperHost findVmOnHyperHost vmName if vmMo null vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg s_logger info msg return new CreateVMSnapshotAnswer cmd false msg else if vmMo getSnapshotMor vmSnapshotName null s_logger info vmSnapshotName else if vmMo createSnapshot vmSnapshotName vmSnapshotDesc snapshotMemory quiescevm return new CreateVMSnapshotAnswer cmd false Map String String mapNewDisk getNewDiskMap vmMo setVolumeToPathAndSize volumeTOs mapNewDisk context hyperHost cmd getVmName return new CreateVMSnapshotAnswer cmd cmd getTarget volumeTOs
VirtualMachineMO vmMo null VmwareContext context hostService getServiceContext cmd String vmName cmd getVmName String vmSnapshotName cmd getTarget getSnapshotName try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd vmMo hyperHost findVmOnHyperHost vmName if vmMo null vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg s_logger debug msg return new DeleteVMSnapshotAnswer cmd false msg else if vmMo getSnapshotMor vmSnapshotName null
try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd vmMo hyperHost findVmOnHyperHost vmName if vmMo null vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg s_logger debug msg return new DeleteVMSnapshotAnswer cmd false msg else if vmMo getSnapshotMor vmSnapshotName null s_logger debug vmSnapshotName else if vmMo removeSnapshot vmSnapshotName false String msg vmSnapshotName
s_logger debug msg return new DeleteVMSnapshotAnswer cmd false msg else if vmMo getSnapshotMor vmSnapshotName null s_logger debug vmSnapshotName else if vmMo removeSnapshot vmSnapshotName false String msg vmSnapshotName s_logger error msg return new DeleteVMSnapshotAnswer cmd false msg s_logger debug vmSnapshotName Map String String mapNewDisk getNewDiskMap vmMo setVolumeToPathAndSize listVolumeTo mapNewDisk context hyperHost cmd getVmName return new DeleteVMSnapshotAnswer cmd listVolumeTo catch Exception e
try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd ManagedObjectReference taskmgr context getServiceContent getTaskManager List ManagedObjectReference tasks context getVimClient getDynamicProperty taskmgr for ManagedObjectReference taskMor tasks TaskInfo info TaskInfo context getVimClient getDynamicProperty taskMor if info getEntityName equals cmd getVmName StringUtils isNotBlank info getName info getName equalsIgnoreCase s_logger debug context getVimClient waitForTask taskMor HostMO hostMo HostMO hyperHost vmMo hyperHost findVmOnHyperHost vmName if vmMo null vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg
boolean useWorkerVm false VmwareHypervisorHost hyperHost getHyperHost getServiceContext VirtualMachineMO vmMo null String vmdkDataStorePath null try if newSize oldSize throw new Exception oldSize ResourceType bytesToMiB newSize ResourceType bytesToMiB else if newSize oldSize return new ResizeVolumeAnswer cmd true newSize ResourceType bytesToKiB if vmName equalsIgnoreCase useWorkerVm true vmName getWorkerName getServiceContext cmd String poolId cmd getPoolUuid ManagedObjectReference morDS HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost poolId DatastoreMO dsMo new DatastoreMO hyperHost getContext morDS
Pair VirtualDisk String vdisk vmMo getDiskDevice path if vdisk null if s_logger isTraceEnabled s_logger trace throw new Exception path if vdisk second null vdisk second contains throw new Exception if cmd isManaged VmwareContext context getServiceContext ManagedObjectReference morCluster hyperHost getHyperHostCluster ClusterMO clusterMO new ClusterMO context morCluster List Pair ManagedObjectReference String lstHosts clusterMO getClusterHosts Collections shuffle lstHosts RANDOM Pair ManagedObjectReference String host lstHosts get HostMO hostMO new HostMO context host first
if VirtualDiskFlatVer2BackingInfo disk getBacking null VirtualDiskFlatVer2BackingInfo disk getBacking getParent null s_logger error VirtualDiskFlatVer2BackingInfo disk getBacking getParent getUuid throw new Exception VirtualDiskFlatVer2BackingInfo disk getBacking getParent getUuid String vmdkAbsFile getAbsoluteVmdkFile disk if vmdkAbsFile null vmdkAbsFile isEmpty vmMo updateAdapterTypeIfRequired vmdkAbsFile disk setCapacityInKB newSize VirtualDeviceConfigSpec deviceConfigSpec new VirtualDeviceConfigSpec deviceConfigSpec setDevice disk deviceConfigSpec setOperation VirtualDeviceConfigSpecOperation EDIT VirtualMachineConfigSpec vmConfigSpec new VirtualMachineConfigSpec vmConfigSpec getDeviceChange add deviceConfigSpec if vmMo configureVm vmConfigSpec throw new Exception vmName return new ResizeVolumeAnswer cmd true newSize
protected Answer execute CheckNetworkCommand cmd if s_logger isInfoEnabled
args else if option equals args String vpcCIDR cmd getVpcCIDR args vpcCIDR else if option equals args else if option equals args else if option equals args else return new NetworkUsageAnswer cmd 0L 0L ExecutionResult callResult executeInVR privateIp args if callResult isSuccess
private int findRouterEthDeviceIndex String domrName String routerIp String mac throws Exception File keyFile getSystemVmKeyFile
private ExecutionResult prepareNetworkElementCommand IpAssocVpcCommand cmd String routerName cmd getAccessDetail NetworkElementCommand ROUTER_NAME String routerIp getRouterSshControlIp cmd try IpAddressTO ips cmd getIpAddresses for IpAddressTO ip ips int ethDeviceNum findRouterEthDeviceIndex routerName routerIp ip getVifMacAddress if ethDeviceNum if ip isAdd throw new InternalErrorException else s_logger debug continue ip setNicDevId ethDeviceNum catch Exception e
private PlugNicAnswer execute PlugNicCommand cmd if s_logger isInfoEnabled
private PlugNicAnswer execute PlugNicCommand cmd if s_logger isInfoEnabled s_logger info _gson toJson cmd getServiceContext getStockObject VmwareManager CONTEXT_STOCK_NAME VmwareContext context getServiceContext try VmwareHypervisorHost hyperHost getHyperHost context String vmName cmd getVmName VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null if hyperHost HostMO ClusterMO clusterMo new ClusterMO hyperHost getContext HostMO hyperHost getParentMor vmMo clusterMo findVmOnHyperHost vmName if vmMo null String msg vmName
VirtualEthernetCardType nicDeviceType VirtualEthernetCardType E1000 Map String String details cmd getDetails if details null nicDeviceType VirtualEthernetCardType valueOf String details get VirtualDevice nicDevices vmMo getNicDevices int deviceNumber for VirtualDevice device nicDevices if device getUnitNumber deviceNumber deviceNumber device getUnitNumber deviceNumber NicTO nicTo cmd getNic VirtualDevice nic Pair ManagedObjectReference String networkInfo prepareNetworkFromNicInfo vmMo getRunningHost nicTo false cmd getVMType String dvSwitchUuid null if VmwareHelper isDvPortGroup networkInfo first ManagedObjectReference dcMor hyperHost getHyperHostDatacenter
if details null nicDeviceType VirtualEthernetCardType valueOf String details get VirtualDevice nicDevices vmMo getNicDevices int deviceNumber for VirtualDevice device nicDevices if device getUnitNumber deviceNumber deviceNumber device getUnitNumber deviceNumber NicTO nicTo cmd getNic VirtualDevice nic Pair ManagedObjectReference String networkInfo prepareNetworkFromNicInfo vmMo getRunningHost nicTo false cmd getVMType String dvSwitchUuid null if VmwareHelper isDvPortGroup networkInfo first ManagedObjectReference dcMor hyperHost getHyperHostDatacenter DatacenterMO dataCenterMo new DatacenterMO context dcMor ManagedObjectReference dvsMor dataCenterMo getDvSwitchMor networkInfo first
private ReplugNicAnswer execute ReplugNicCommand cmd if s_logger isInfoEnabled
private ReplugNicAnswer execute ReplugNicCommand cmd if s_logger isInfoEnabled s_logger info _gson toJson cmd getServiceContext getStockObject VmwareManager CONTEXT_STOCK_NAME VmwareContext context getServiceContext try VmwareHypervisorHost hyperHost getHyperHost context String vmName cmd getVmName VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null if hyperHost HostMO ClusterMO clusterMo new ClusterMO hyperHost getContext HostMO hyperHost getParentMor vmMo clusterMo findVmOnHyperHost vmName if vmMo null String msg vmName
String msg vmName s_logger error msg throw new Exception msg VirtualEthernetCardType nicDeviceType VirtualEthernetCardType E1000 Map String String details cmd getDetails if details null nicDeviceType VirtualEthernetCardType valueOf String details get NicTO nicTo cmd getNic VirtualDevice nic findVirtualNicDevice vmMo nicTo getMac if nic null return new ReplugNicAnswer cmd false Pair ManagedObjectReference String networkInfo prepareNetworkFromNicInfo vmMo getRunningHost nicTo false cmd getVMType String dvSwitchUuid null if VmwareHelper isDvPortGroup networkInfo first ManagedObjectReference dcMor hyperHost getHyperHostDatacenter
VirtualEthernetCardType nicDeviceType VirtualEthernetCardType E1000 Map String String details cmd getDetails if details null nicDeviceType VirtualEthernetCardType valueOf String details get NicTO nicTo cmd getNic VirtualDevice nic findVirtualNicDevice vmMo nicTo getMac if nic null return new ReplugNicAnswer cmd false Pair ManagedObjectReference String networkInfo prepareNetworkFromNicInfo vmMo getRunningHost nicTo false cmd getVMType String dvSwitchUuid null if VmwareHelper isDvPortGroup networkInfo first ManagedObjectReference dcMor hyperHost getHyperHostDatacenter DatacenterMO dataCenterMo new DatacenterMO context dcMor ManagedObjectReference dvsMor dataCenterMo getDvSwitchMor networkInfo first dvSwitchUuid dataCenterMo getDvSwitchUuid dvsMor
private UnPlugNicAnswer execute UnPlugNicCommand cmd if s_logger isInfoEnabled
if hyperHost HostMO ClusterMO clusterMo new ClusterMO hyperHost getContext HostMO hyperHost getParentMor vmMo clusterMo findVmOnHyperHost routerName if vmMo null String msg routerName s_logger error msg throw new Exception msg for IpAddressTO ip ips URI broadcastUri BroadcastDomainType fromString ip getBroadcastUri if BroadcastDomainType getSchemeValue broadcastUri BroadcastDomainType Vlan throw new InternalErrorException ip getBroadcastUri String vlanId BroadcastDomainType getValue broadcastUri String publicNeworkName HypervisorHostHelper getPublicNetworkNamePrefix vlanId Pair Integer VirtualDevice publicNicInfo vmMo getNicDeviceIndex publicNeworkName if s_logger isDebugEnabled
if vmMo null String msg routerName s_logger error msg throw new Exception msg for IpAddressTO ip ips URI broadcastUri BroadcastDomainType fromString ip getBroadcastUri if BroadcastDomainType getSchemeValue broadcastUri BroadcastDomainType Vlan throw new InternalErrorException ip getBroadcastUri String vlanId BroadcastDomainType getValue broadcastUri String publicNeworkName HypervisorHostHelper getPublicNetworkNamePrefix vlanId Pair Integer VirtualDevice publicNicInfo vmMo getNicDeviceIndex publicNeworkName if s_logger isDebugEnabled s_logger debug publicNeworkName publicNicInfo first boolean addVif false if ip isAdd publicNicInfo first intValue
Override public ExecutionResult executeInVR String routerIP String script String args Duration timeout Pair Boolean String result if s_logger isDebugEnabled
protected CheckSshAnswer execute CheckSshCommand cmd String vmName cmd getName String privateIp cmd getIp int cmdPort cmd getPort if s_logger isDebugEnabled
protected CheckSshAnswer execute CheckSshCommand cmd String vmName cmd getName String privateIp cmd getIp int cmdPort cmd getPort if s_logger isDebugEnabled s_logger debug privateIp cmdPort try String result connect cmd getName privateIp cmdPort if result null s_logger error vmName result return new CheckSshAnswer cmd vmName result catch Exception e s_logger error vmName return new CheckSshAnswer cmd e if s_logger isDebugEnabled
int cmdPort cmd getPort if s_logger isDebugEnabled s_logger debug privateIp cmdPort try String result connect cmd getName privateIp cmdPort if result null s_logger error vmName result return new CheckSshAnswer cmd vmName result catch Exception e s_logger error vmName return new CheckSshAnswer cmd e if s_logger isDebugEnabled s_logger debug vmName if VirtualMachineName isValidRouterName vmName if s_logger isDebugEnabled
long requestedMaxMemoryInMb vmSpec getMaxRam if getVmPowerState vmMo PowerState PowerOn throw new CloudRuntimeException vmMo getVmName hotaddIncrementSizeInMb vmMo getHotAddMemoryIncrementSizeInMb hotaddMemoryLimitInMb vmMo getHotAddMemoryLimitInMb if requestedMaxMemoryInMb hotaddMemoryLimitInMb throw new CloudRuntimeException vmMo getVmName requestedMaxMemoryInMb hotaddMemoryLimitInMb long reminder requestedMaxMemoryInMb hotaddIncrementSizeInMb if reminder requestedMaxMemoryInMb requestedMaxMemoryInMb hotaddIncrementSizeInMb reminder VmwareHelper isFeatureLicensed hyperHost FeatureKeyConstants HOTPLUG VmwareHelper setVmScaleUpConfig vmConfigSpec vmSpec getCpus vmSpec getMaxSpeed vmSpec getMinSpeed int requestedMaxMemoryInMb ramMb vmSpec getLimitCpuUse if vmMo configureVm vmConfigSpec throw new Exception catch Exception e
private static void postNvpConfigBeforeStart VirtualMachineMO vmMo VirtualMachineTO vmSpec throws Exception int nicIndex for NicTO nicTo sortNicsByDeviceId vmSpec getNics if nicTo getBroadcastType BroadcastDomainType Lswitch s_logger trace nicTo toString VirtualDevice nicVirtualDevice vmMo getNicDeviceByIndex nicIndex if nicVirtualDevice null throw new Exception nicIndex VirtualDeviceBackingInfo backing nicVirtualDevice getBacking if backing VirtualEthernetCardDistributedVirtualPortBackingInfo VirtualEthernetCardDistributedVirtualPortBackingInfo portInfo VirtualEthernetCardDistributedVirtualPortBackingInfo backing DistributedVirtualSwitchPortConnection port portInfo getPort String portKey port getPortKey String portGroupKey port getPortgroupKey String dvSwitchUuid port getSwitchUuid
DVPortConfigSpec dvPortConfigSpec new DVPortConfigSpec VMwareDVSPortSetting edittedSettings new VMwareDVSPortSetting blocked setValue Boolean FALSE blocked setInherited Boolean FALSE edittedSettings setBlocked blocked int i for i i i if usedVlans contains i break vlanId setVlanId i vlanId setInherited false edittedSettings setVlan vlanId dvPortConfigSpec setSetting edittedSettings dvPortConfigSpec setOperation dvPortConfigSpec setKey portKey List DVPortConfigSpec dvPortConfigSpecs new ArrayList DVPortConfigSpec
String dsName null String diskBackingFileBaseName null Map String String details vol getDetails boolean isManaged details null Boolean parseBoolean details get DiskTO MANAGED if isManaged String iScsiName details get DiskTO IQN dsName VmwareResource getDatastoreName iScsiName diskBackingFileBaseName new DatastoreFile volume getPath getFileBaseName else ManagedObjectReference morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost volume getDataStore getUuid DatastoreMO dsMo new DatastoreMO context morDs dsName dsMo getName diskBackingFileBaseName volume getPath VirtualMachineDiskInfo diskInfo diskInfoBuilder getDiskInfoByBackingFileBaseName diskBackingFileBaseName dsName if diskInfo null
diskBackingFileBaseName volume getPath VirtualMachineDiskInfo diskInfo diskInfoBuilder getDiskInfoByBackingFileBaseName diskBackingFileBaseName dsName if diskInfo null s_logger info volume getPath return diskInfo else String chainInfo volume getChainInfo if chainInfo null VirtualMachineDiskInfo infoInChain _gson fromJson chainInfo VirtualMachineDiskInfo class if infoInChain null String disks infoInChain getDiskChain if disks length for String diskPath disks DatastoreFile file new DatastoreFile diskPath diskInfo diskInfoBuilder getDiskInfoByBackingFileBaseName file getFileBaseName dsName
return diskInfo else String chainInfo volume getChainInfo if chainInfo null VirtualMachineDiskInfo infoInChain _gson fromJson chainInfo VirtualMachineDiskInfo class if infoInChain null String disks infoInChain getDiskChain if disks length for String diskPath disks DatastoreFile file new DatastoreFile diskPath diskInfo diskInfoBuilder getDiskInfoByBackingFileBaseName file getFileBaseName dsName if diskInfo null s_logger info diskPath return diskInfo if diskInfo null
private int getDiskController VirtualMachineDiskInfo matchingExistingDisk DiskTO vol VirtualMachineTO vmSpec int ideControllerKey int scsiControllerKey int controllerKey if matchingExistingDisk null
int controllerKey if matchingExistingDisk null s_logger info matchingExistingDisk getDiskDeviceBusName if matchingExistingDisk getDiskDeviceBusName startsWith return ideControllerKey else return scsiControllerKey if vol getType Volume Type ROOT Map String String vmDetails vmSpec getDetails if vmDetails null vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER null if vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER equalsIgnoreCase s_logger info vol getType vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER controllerKey scsiControllerKey else s_logger info vol getType vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER controllerKey ideControllerKey else
if matchingExistingDisk getDiskDeviceBusName startsWith return ideControllerKey else return scsiControllerKey if vol getType Volume Type ROOT Map String String vmDetails vmSpec getDetails if vmDetails null vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER null if vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER equalsIgnoreCase s_logger info vol getType vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER controllerKey scsiControllerKey else s_logger info vol getType vmDetails get VmDetailConstants ROOT_DISK_CONTROLLER controllerKey ideControllerKey else s_logger info vol getType controllerKey scsiControllerKey else
private String getDiskController VirtualMachineMO vmMo VirtualMachineDiskInfo matchingExistingDisk DiskTO vol Pair String String controllerInfo throws Exception int controllerKey DiskControllerType controllerType DiskControllerType none if matchingExistingDisk null String currentBusName matchingExistingDisk getDiskDeviceBusName if currentBusName null
int controllerKey DiskControllerType controllerType DiskControllerType none if matchingExistingDisk null String currentBusName matchingExistingDisk getDiskDeviceBusName if currentBusName null s_logger info currentBusName if currentBusName startsWith controllerType DiskControllerType ide else if currentBusName startsWith controllerType DiskControllerType scsi if controllerType DiskControllerType scsi controllerType DiskControllerType none Ternary Integer Integer DiskControllerType vmScsiControllerInfo vmMo getScsiControllerInfo controllerType vmScsiControllerInfo third return controllerType toString if vol getType Volume Type ROOT
String currentBusName matchingExistingDisk getDiskDeviceBusName if currentBusName null s_logger info currentBusName if currentBusName startsWith controllerType DiskControllerType ide else if currentBusName startsWith controllerType DiskControllerType scsi if controllerType DiskControllerType scsi controllerType DiskControllerType none Ternary Integer Integer DiskControllerType vmScsiControllerInfo vmMo getScsiControllerInfo controllerType vmScsiControllerInfo third return controllerType toString if vol getType Volume Type ROOT s_logger info vol getType controllerInfo first return controllerInfo first else
private void checkAndDeleteDatastoreFile String filePath List String skipDatastores DatastoreMO dsMo DatacenterMO dcMo throws Exception if dsMo null dcMo null skipDatastores null skipDatastores contains dsMo getName
if nicTo getBroadcastType BroadcastDomainType Native return defaultVlan else if nicTo getBroadcastType BroadcastDomainType Vlan nicTo getBroadcastType BroadcastDomainType Pvlan if nicTo getBroadcastUri null if nicTo getBroadcastType BroadcastDomainType Vlan return BroadcastDomainType getValue nicTo getBroadcastUri else return NetUtils getPrimaryPvlanFromUri nicTo getBroadcastUri else s_logger warn defaultVlan return defaultVlan else if nicTo getBroadcastType BroadcastDomainType Lswitch return null else if nicTo getBroadcastType BroadcastDomainType Storage URI broadcastUri nicTo getBroadcastUri if broadcastUri null String vlanId BroadcastDomainType getValue broadcastUri
private Pair ManagedObjectReference String prepareNetworkFromNicInfo HostMO hostMo NicTO nicTo boolean configureVServiceInNexus VirtualMachine Type vmType throws Exception Ternary String String String switchDetails getTargetSwitch nicTo VirtualSwitchType switchType VirtualSwitchType getType switchDetails second String switchName switchDetails first String vlanToken switchDetails third String namePrefix getNetworkNamePrefix nicTo Pair ManagedObjectReference String networkInfo null
private VirtualMachineMO takeVmFromOtherHyperHost VmwareHypervisorHost hyperHost String vmName throws Exception VirtualMachineMO vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null ManagedObjectReference morTargetPhysicalHost hyperHost findMigrationTarget vmMo if morTargetPhysicalHost null String msg vmName
protected Answer execute ReadyCommand cmd if s_logger isInfoEnabled
s_logger trace _gson toJson cmd VmwareContext context getServiceContext VmwareHypervisorHost hyperHost getHyperHost context HostStatsEntry hostStats new HostStatsEntry cmd getHostId Answer answer new GetHostStatsAnswer cmd hostStats try HostStatsEntry entry getHyperHostStats hyperHost if entry null entry setHostId cmd getHostId answer new GetHostStatsAnswer cmd entry catch Exception e if e RemoteException s_logger warn invalidateServiceContext String msg VmwareHelper getExceptionMessage e
HashMap String VmStatsEntry vmStatsMap null try HashMap String PowerState vmPowerStates getVmStates List String requestedVmNames cmd getVmNames List String vmNames new ArrayList String if requestedVmNames null for String vmName requestedVmNames if vmPowerStates get vmName null vmNames add vmName if vmNames null vmStatsMap getVmStats vmNames catch Throwable e if e RemoteException s_logger warn invalidateServiceContext
for String diskPath disks DatastoreFile file new DatastoreFile diskPath VirtualMachineMO vmMo dcMo findVm file getDir Pair VirtualDisk String vds vmMo getDiskDevice file getFileName true long virtualsize vds first getCapacityInKB long physicalsize primaryStorageDatastoreMo fileDiskSize file getPath if statEntry containsKey chainInfo VolumeStatsEntry vse statEntry get chainInfo if vse null vse setPhysicalSize vse getPhysicalSize physicalsize else VolumeStatsEntry vse new VolumeStatsEntry chainInfo physicalsize virtualsize statEntry put chainInfo vse return new GetVolumeStatsAnswer cmd statEntry catch Exception e
protected Answer execute CheckHealthCommand cmd if s_logger isInfoEnabled
protected Answer execute StopCommand cmd if s_logger isInfoEnabled
protected Answer execute StopCommand cmd if s_logger isInfoEnabled s_logger info _gson toJson cmd VmwareContext context getServiceContext VmwareHypervisorHost hyperHost getHyperHost context try VirtualMachineMO vmMo hyperHost findVmOnHyperHost cmd getVmName if vmMo null if cmd checkBeforeCleanup if getVmPowerState vmMo PowerState PowerOff String msg cmd getVmName s_logger warn msg return new StopAnswer cmd msg false else String msg cmd getVmName
s_logger info msg return new StopAnswer cmd msg true try vmMo setCustomFieldValue CustomFieldConstants CLOUD_NIC_MASK vmMo setCustomFieldValue CustomFieldConstants CLOUD_VM_INTERNAL_NAME cmd getVmName if getVmPowerState vmMo PowerState PowerOff String msg cmd getVmName boolean success false if cmd isForceStop success vmMo powerOff else success vmMo safePowerOff _shutdownWaitMs if success msg cmd getVmName s_logger warn msg
vmMo setCustomFieldValue CustomFieldConstants CLOUD_NIC_MASK vmMo setCustomFieldValue CustomFieldConstants CLOUD_VM_INTERNAL_NAME cmd getVmName if getVmPowerState vmMo PowerState PowerOff String msg cmd getVmName boolean success false if cmd isForceStop success vmMo powerOff else success vmMo safePowerOff _shutdownWaitMs if success msg cmd getVmName s_logger warn msg return new StopAnswer cmd msg true String msg cmd getVmName s_logger info msg
else success vmMo safePowerOff _shutdownWaitMs if success msg cmd getVmName s_logger warn msg return new StopAnswer cmd msg true String msg cmd getVmName s_logger info msg return new StopAnswer cmd msg true finally else String msg cmd getVmName s_logger info msg return new StopAnswer cmd msg true catch Exception e
protected Answer execute RebootRouterCommand cmd if s_logger isInfoEnabled
protected Answer execute RebootCommand cmd if s_logger isInfoEnabled
catch ToolsUnavailableFaultMsg e s_logger warn catch Exception e s_logger warn VmwareHelper getExceptionMessage e if vmMo reset return new RebootAnswer cmd true String msg cmd getVmName s_logger warn msg return new RebootAnswer cmd msg false else String msg cmd getVmName s_logger warn msg return new RebootAnswer cmd msg false catch Exception e if e RemoteException
s_logger warn VmwareHelper getExceptionMessage e if vmMo reset return new RebootAnswer cmd true String msg cmd getVmName s_logger warn msg return new RebootAnswer cmd msg false else String msg cmd getVmName s_logger warn msg return new RebootAnswer cmd msg false catch Exception e if e RemoteException s_logger warn invalidateServiceContext String msg VmwareHelper getExceptionMessage e
private boolean canSetEnableSetupConfig VirtualMachineMO vmMo VirtualMachineTO virtualMachine if virtualMachine isEnterHardwareSetup VirtualMachineBootOptions bootOptions new VirtualMachineBootOptions VirtualMachineConfigSpec vmConfigSpec new VirtualMachineConfigSpec if s_logger isDebugEnabled
protected Answer execute CheckVirtualMachineCommand cmd if s_logger isInfoEnabled
Integer vncPort null VmwareContext context getServiceContext VmwareHypervisorHost hyperHost getHyperHost context try VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null powerState getVmPowerState vmMo return new CheckVirtualMachineAnswer cmd powerState vncPort else s_logger warn vmName return new CheckVirtualMachineAnswer cmd powerState vncPort catch Throwable e if e RemoteException s_logger warn invalidateServiceContext
protected Answer execute PrepareForMigrationCommand cmd if s_logger isInfoEnabled
VirtualMachineTO vm cmd getVirtualMachine if s_logger isDebugEnabled s_logger debug vm final String vmName vm getName try VmwareHypervisorHost hyperHost getHyperHost getServiceContext VmwareManager mgr hyperHost getContext getStockObject VmwareManager CONTEXT_STOCK_NAME VirtualMachineMO vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null s_logger info vmName hyperHost getHyperHostName ManagedObjectReference dcMor hyperHost getHyperHostDatacenter DatacenterMO dcMo new DatacenterMO hyperHost getContext dcMor vmMo dcMo findVm vmName if vmMo null String msg vmName
List Pair String Long secStoreUrlAndIdList mgr getSecondaryStorageStoresUrlAndIdList Long parseLong _dcId for Pair String Long secStoreUrlAndId secStoreUrlAndIdList String secStoreUrl secStoreUrlAndId first Long secStoreId secStoreUrlAndId second if secStoreUrl null String msg String format _dcId throw new Exception msg if vm getType VirtualMachine Type User mgr prepareSecondaryStorageStore secStoreUrl secStoreId ManagedObjectReference morSecDs prepareSecondaryDatastoreOnHost secStoreUrl if morSecDs null String msg secStoreUrl throw new Exception msg return new PrepareForMigrationAnswer cmd catch Throwable e
protected Answer execute MigrateVmToPoolCommand cmd if s_logger isInfoEnabled
protected Answer execute MigrateVmToPoolCommand cmd if s_logger isInfoEnabled s_logger info String format cmd getVmName cmd getDestinationPool if s_logger isDebugEnabled
s_logger debug _gson toJson cmd final String vmName cmd getVmName VmwareHypervisorHost hyperHost getHyperHost getServiceContext try VirtualMachineMO vmMo getVirtualMachineMO vmName hyperHost if vmMo null String msg vmName s_logger error msg throw new CloudRuntimeException msg String poolUuid cmd getDestinationPool return migrateAndAnswer vmMo poolUuid hyperHost cmd catch Throwable e if e Exception return new Answer cmd Exception e if s_logger isDebugEnabled
final String vmName cmd getVmName VmwareHypervisorHost hyperHost getHyperHost getServiceContext try VirtualMachineMO vmMo getVirtualMachineMO vmName hyperHost if vmMo null String msg vmName s_logger error msg throw new CloudRuntimeException msg String poolUuid cmd getDestinationPool return migrateAndAnswer vmMo poolUuid hyperHost cmd catch Throwable e if e Exception return new Answer cmd Exception e if s_logger isDebugEnabled s_logger debug e
try Map Integer Long volumeDeviceKey getVolumesFromCommand vmMo cmd if s_logger isTraceEnabled for Integer diskId volumeDeviceKey keySet s_logger trace String format diskId volumeDeviceKey get diskId if vmMo changeDatastore morDs if vmMo consolidateVmDisks s_logger warn else s_logger debug vmMo getVmName return createAnswerForCmd vmMo poolUuid cmd volumeDeviceKey else return new Answer cmd false vmMo getVmName catch Exception e String msg vmMo getVmName
private void addVolumeDiskmapping VirtualMachineMO vmMo Map Integer Long volumeDeviceKey String volumePath long volumeId throws Exception if s_logger isDebugEnabled
private ManagedObjectReference getTargetDatastoreMOReference String destinationPool VmwareHypervisorHost hyperHost ManagedObjectReference morDs try if s_logger isDebugEnabled
protected Answer execute MigrateCommand cmd if s_logger isInfoEnabled
protected Answer execute MigrateWithStorageCommand cmd if s_logger isInfoEnabled
String tgtHostMorInfo tgtHost split morTgtHost setType tgtHostMorInfo split morTgtHost setValue tgtHostMorInfo split try srcHyperHost getHyperHost getServiceContext tgtHyperHost new HostMO getServiceContext morTgtHost morDc srcHyperHost getHyperHostDatacenter morDcOfTargetHost tgtHyperHost getHyperHostDatacenter if morDc getValue equalsIgnoreCase morDcOfTargetHost getValue String msg throw new CloudRuntimeException msg VmwareManager mgr tgtHyperHost getContext getStockObject VmwareManager CONTEXT_STOCK_NAME String srcHostApiVersion HostMO srcHyperHost getHostAboutInfo getApiVersion vmMo srcHyperHost findVmOnPeerHyperHost vmName if vmMo null
morDc srcHyperHost getHyperHostDatacenter morDcOfTargetHost tgtHyperHost getHyperHostDatacenter if morDc getValue equalsIgnoreCase morDcOfTargetHost getValue String msg throw new CloudRuntimeException msg VmwareManager mgr tgtHyperHost getContext getStockObject VmwareManager CONTEXT_STOCK_NAME String srcHostApiVersion HostMO srcHyperHost getHostAboutInfo getApiVersion vmMo srcHyperHost findVmOnPeerHyperHost vmName if vmMo null String msg vmName morDc getValue s_logger error msg throw new Exception msg vmName vmMo getName for Pair VolumeTO StorageFilerTO entry volToFiler volume entry first
VmwareManager mgr tgtHyperHost getContext getStockObject VmwareManager CONTEXT_STOCK_NAME String srcHostApiVersion HostMO srcHyperHost getHostAboutInfo getApiVersion vmMo srcHyperHost findVmOnPeerHyperHost vmName if vmMo null String msg vmName morDc getValue s_logger error msg throw new Exception msg vmName vmMo getName for Pair VolumeTO StorageFilerTO entry volToFiler volume entry first filerTo entry second s_logger debug volume getName morDsAtTarget HypervisorHostHelper findDatastoreWithBackwardsCompatibility tgtHyperHost filerTo getUuid morDsAtSource HypervisorHostHelper findDatastoreWithBackwardsCompatibility srcHyperHost filerTo getUuid if morDsAtTarget null
morDsAtTarget HypervisorHostHelper findDatastoreWithBackwardsCompatibility tgtHyperHost filerTo getUuid morDsAtSource HypervisorHostHelper findDatastoreWithBackwardsCompatibility srcHyperHost filerTo getUuid if morDsAtTarget null String msg filerTo getUuid tgtHyperHost getHyperHostName s_logger error msg throw new Exception msg morTgtDatastore morDsAtTarget if srcHostApiVersion compareTo tgtDsName filerTo getUuid replace tgtDsHost filerTo getHost tgtDsPath filerTo getPath tgtDsPort filerTo getPort if filerTo getType equals StoragePoolType NetworkFilesystem if morDsAtSource null morDsAtSource srcHyperHost mountDatastore false tgtDsHost tgtDsPort tgtDsPath tgtDsName
for NicTO nic nics prepareNetworkFromNicInfo new HostMO getServiceContext morTgtHost nic false vmTo getType List Pair String Long secStoreUrlAndIdList mgr getSecondaryStorageStoresUrlAndIdList Long parseLong _dcId for Pair String Long secStoreUrlAndId secStoreUrlAndIdList String secStoreUrl secStoreUrlAndId first Long secStoreId secStoreUrlAndId second if secStoreUrl null String msg String format _dcId throw new Exception msg if vmTo getType VirtualMachine Type User mgr prepareSecondaryStorageStore secStoreUrl secStoreId ManagedObjectReference morSecDs prepareSecondaryDatastoreOnSpecificHost secStoreUrl tgtHyperHost if morSecDs null String msg secStoreUrl throw new Exception msg
else s_logger debug vmName _hostName tgtHyperHost getHyperHostName else relocateSpec setHost tgtHyperHost getMor relocateSpec setPool tgtHyperHost getHyperHostOwnerResourcePool if vmMo changeDatastore relocateSpec throw new Exception else s_logger debug vmName _hostName tgtHyperHost getHyperHostName if vmMo consolidateVmDisks s_logger warn else s_logger debug vmName VirtualMachineDiskInfoBuilder diskInfoBuilder vmMo getDiskInfoBuilder for Pair VolumeTO StorageFilerTO entry volToFiler
else relocateSpec setHost tgtHyperHost getMor relocateSpec setPool tgtHyperHost getHyperHostOwnerResourcePool if vmMo changeDatastore relocateSpec throw new Exception else s_logger debug vmName _hostName tgtHyperHost getHyperHostName if vmMo consolidateVmDisks s_logger warn else s_logger debug vmName VirtualMachineDiskInfoBuilder diskInfoBuilder vmMo getDiskInfoBuilder for Pair VolumeTO StorageFilerTO entry volToFiler volume entry first long volumeId volume getId
relocateSpec setPool tgtHyperHost getHyperHostOwnerResourcePool if vmMo changeDatastore relocateSpec throw new Exception else s_logger debug vmName _hostName tgtHyperHost getHyperHostName if vmMo consolidateVmDisks s_logger warn else s_logger debug vmName VirtualMachineDiskInfoBuilder diskInfoBuilder vmMo getDiskInfoBuilder for Pair VolumeTO StorageFilerTO entry volToFiler volume entry first long volumeId volume getId VirtualDisk disks vmMo getAllDiskDevice for VirtualDisk disk disks
private Answer migrateVolume MigrateVolumeCommand cmd Answer answer null String path cmd getVolumePath VmwareHypervisorHost hyperHost getHyperHost getServiceContext VirtualMachineMO vmMo null DatastoreMO dsMo null ManagedObjectReference morSourceDS null String vmdkDataStorePath null String vmName null try vmName getWorkerName getServiceContext cmd morSourceDS HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getSourcePool getUuid dsMo new DatastoreMO hyperHost getContext morSourceDS
String vmdkDataStorePath null String vmName null try vmName getWorkerName getServiceContext cmd morSourceDS HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getSourcePool getUuid dsMo new DatastoreMO hyperHost getContext morSourceDS s_logger info vmName vmMo HypervisorHostHelper createWorkerVM hyperHost dsMo vmName if vmMo null throw new CloudRuntimeException synchronized this String vmdkFileName path VMDK_EXTENSION vmdkDataStorePath VmwareStorageLayoutHelper getLegacyDatastorePathFromVmdkFileName dsMo vmdkFileName if dsMo fileExists vmdkDataStorePath if s_logger isDebugEnabled
morSourceDS HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getSourcePool getUuid dsMo new DatastoreMO hyperHost getContext morSourceDS s_logger info vmName vmMo HypervisorHostHelper createWorkerVM hyperHost dsMo vmName if vmMo null throw new CloudRuntimeException synchronized this String vmdkFileName path VMDK_EXTENSION vmdkDataStorePath VmwareStorageLayoutHelper getLegacyDatastorePathFromVmdkFileName dsMo vmdkFileName if dsMo fileExists vmdkDataStorePath if s_logger isDebugEnabled s_logger debug String format vmdkFileName path vmdkDataStorePath VmwareStorageLayoutHelper getVmwareDatastorePathFromVmdkFileName dsMo path vmdkFileName if dsMo fileExists vmdkDataStorePath if s_logger isDebugEnabled
vmMo HypervisorHostHelper createWorkerVM hyperHost dsMo vmName if vmMo null throw new CloudRuntimeException synchronized this String vmdkFileName path VMDK_EXTENSION vmdkDataStorePath VmwareStorageLayoutHelper getLegacyDatastorePathFromVmdkFileName dsMo vmdkFileName if dsMo fileExists vmdkDataStorePath if s_logger isDebugEnabled s_logger debug String format vmdkFileName path vmdkDataStorePath VmwareStorageLayoutHelper getVmwareDatastorePathFromVmdkFileName dsMo path vmdkFileName if dsMo fileExists vmdkDataStorePath if s_logger isDebugEnabled s_logger debug String format vmdkFileName vmName vmdkDataStorePath VmwareStorageLayoutHelper getVmwareDatastorePathFromVmdkFileName dsMo vmName vmdkFileName if s_logger isDebugEnabled
vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg vmName s_logger error msg throw new Exception msg if s_logger isTraceEnabled VirtualDisk disks vmMo getAllDiskDevice String format for VirtualDisk disk disks s_logger trace String format format disk getKey vmMo getVmdkFileBaseName disk Pair VirtualDisk String vdisk vmMo getDiskDevice path if vdisk null if s_logger isTraceEnabled s_logger trace throw new CloudRuntimeException path VirtualDisk disk vdisk first
if s_logger isTraceEnabled s_logger trace throw new CloudRuntimeException path VirtualDisk disk vdisk first String vmdkAbsFile getAbsoluteVmdkFile disk if vmdkAbsFile null vmdkAbsFile isEmpty vmMo updateAdapterTypeIfRequired vmdkAbsFile answer migrateAndAnswer vmMo cmd getTargetPool getUuid hyperHost cmd catch Exception e String msg String format cmd getVolumePath e getLocalizedMessage s_logger error msg e answer new Answer cmd false msg finally try vmName vmMo getVmName morSourceDS HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getTargetPool getUuid
VirtualDisk disk vdisk first String vmdkAbsFile getAbsoluteVmdkFile disk if vmdkAbsFile null vmdkAbsFile isEmpty vmMo updateAdapterTypeIfRequired vmdkAbsFile answer migrateAndAnswer vmMo cmd getTargetPool getUuid hyperHost cmd catch Exception e String msg String format cmd getVolumePath e getLocalizedMessage s_logger error msg e answer new Answer cmd false msg finally try vmName vmMo getVmName morSourceDS HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getTargetPool getUuid dsMo new DatastoreMO hyperHost getContext morSourceDS s_logger info vmName
String msg String format cmd getVolumePath e getLocalizedMessage s_logger error msg e answer new Answer cmd false msg finally try vmName vmMo getVmName morSourceDS HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getTargetPool getUuid dsMo new DatastoreMO hyperHost getContext morSourceDS s_logger info vmName VirtualDisk disks vmMo getAllDiskDevice String format for VirtualDisk disk disks if s_logger isTraceEnabled s_logger trace String format format disk getKey vmMo getVmdkFileBaseName disk vmdkDataStorePath VmwareStorageLayoutHelper getLegacyDatastorePathFromVmdkFileName dsMo vmMo getVmdkFileBaseName disk VMDK_EXTENSION
private Answer execute MigrateVolumeCommand cmd String volumePath cmd getVolumePath StorageFilerTO poolTo cmd getPool if s_logger isInfoEnabled
List VirtualMachineRelocateSpecDiskLocator diskLocators new ArrayList VirtualMachineRelocateSpecDiskLocator VirtualMachineRelocateSpecDiskLocator diskLocator null String tgtDsName try srcHyperHost getHyperHost getServiceContext morDc srcHyperHost getHyperHostDatacenter tgtDsName poolTo getUuid DatacenterMO dcMo new DatacenterMO getServiceContext morDc vmMo dcMo findVm vmName if vmMo null String msg vmName morDc getValue s_logger error msg throw new CloudRuntimeException msg vmName vmMo getName morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility srcHyperHost tgtDsName
protected Answer execute ModifyStoragePoolCommand cmd if s_logger isInfoEnabled
ManagedObjectReference morDatastore HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost pool getUuid if morDatastore null morDatastore hyperHost mountDatastore pool getType StoragePoolType VMFS pool getHost pool getPort pool getPath pool getUuid replace assert morDatastore null DatastoreSummary summary new DatastoreMO getServiceContext morDatastore getSummary long capacity summary getCapacity long available summary getFreeSpace Map String TemplateProp tInfo new HashMap ModifyStoragePoolAnswer answer new ModifyStoragePoolAnswer cmd capacity available tInfo if cmd getAdd pool getType StoragePoolType VMFS answer setLocalDatastoreName morDatastore getValue return answer catch Throwable e if e RemoteException s_logger warn
protected Answer execute DeleteStoragePoolCommand cmd if s_logger isInfoEnabled
protected AttachIsoAnswer execute AttachIsoCommand cmd if s_logger isInfoEnabled
s_logger error msg throw new Exception msg else if cmd isAttach vmMo mountToolsInstaller else try if vmMo unmountToolsInstaller return new AttachIsoAnswer cmd false catch Throwable e vmMo detachIso null return new AttachIsoAnswer cmd ManagedObjectReference morSecondaryDs prepareSecondaryDatastoreOnHost storeUrl String isoPath cmd getIsoPath if isoPath startsWith storeUrl
ManagedObjectReference morSecondaryDs prepareSecondaryDatastoreOnHost storeUrl String isoPath cmd getIsoPath if isoPath startsWith storeUrl assert false String msg s_logger error msg throw new Exception msg int isoNameStartPos isoPath lastIndexOf String isoFileName isoPath substring isoNameStartPos String isoStorePathFromRoot isoPath substring storeUrl length isoNameStartPos DatastoreMO secondaryDsMo new DatastoreMO getServiceContext morSecondaryDs String storeName secondaryDsMo getName String isoDatastorePath String format storeName isoStorePathFromRoot isoFileName if cmd isAttach vmMo attachIso isoDatastorePath morSecondaryDs true false cmd getDeviceKey
protected Answer execute ValidateSnapshotCommand cmd if s_logger isInfoEnabled
protected Answer execute ManageSnapshotCommand cmd if s_logger isInfoEnabled
protected Answer execute BackupSnapshotCommand cmd if s_logger isInfoEnabled
protected Answer execute CreateVolumeFromSnapshotCommand cmd if s_logger isInfoEnabled
protected Answer execute CreateVolumeFromSnapshotCommand cmd if s_logger isInfoEnabled s_logger info _gson toJson cmd String details null boolean success false String newVolumeName UUID randomUUID toString try VmwareContext context getServiceContext VmwareManager mgr context getStockObject VmwareManager CONTEXT_STOCK_NAME return mgr getStorageManager execute this cmd catch Throwable e if e RemoteException s_logger warn invalidateServiceContext details VmwareHelper getExceptionMessage e
protected Answer execute CreatePrivateTemplateFromVolumeCommand cmd if s_logger isInfoEnabled
protected Answer execute CreatePrivateTemplateFromSnapshotCommand cmd if s_logger isInfoEnabled
protected Answer execute GetStorageStatsCommand cmd if s_logger isTraceEnabled s_logger trace _gson toJson cmd try VmwareContext context getServiceContext VmwareHypervisorHost hyperHost getHyperHost context ManagedObjectReference morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost cmd getStorageId if morDs null DatastoreMO datastoreMo new DatastoreMO context morDs DatastoreSummary summary datastoreMo getSummary assert summary null long capacity summary getCapacity long free summary getFreeSpace long used capacity free if s_logger isDebugEnabled
long free summary getFreeSpace long used capacity free if s_logger isDebugEnabled s_logger debug cmd getStorageId cmd getLocalPath cmd getPooltype toHumanReadableSize capacity toHumanReadableSize free toHumanReadableSize used if summary getCapacity s_logger warn return new GetStorageStatsAnswer cmd capacity used else String msg cmd getStorageId cmd getLocalPath cmd getPooltype s_logger error msg return new GetStorageStatsAnswer cmd msg catch Throwable e if e RemoteException s_logger warn invalidateServiceContext
VirtualMachineMO vmMo hyperHost findVmOnHyperHost cmd getName if vmMo null if s_logger isDebugEnabled s_logger debug hyperHost getHyperHostName vmMo hyperHost findVmOnPeerHyperHost cmd getName if vmMo null throw new Exception cmd getName Pair String Integer portInfo vmMo getVncPort mgr getManagementPortGroupByHost HostMO hyperHost if s_logger isTraceEnabled s_logger trace cmd getName portInfo first portInfo second return new GetVncPortAnswer cmd portInfo first portInfo second catch Throwable e if e RemoteException s_logger warn invalidateServiceContext
protected Answer execute SetupCommand cmd if s_logger isInfoEnabled
protected Answer execute MaintainCommand cmd if s_logger isInfoEnabled
protected Answer execute PingTestCommand cmd if s_logger isInfoEnabled
s_logger error controlIp VmwareHelper getExceptionMessage e e return new Answer cmd false else VmwareContext context getServiceContext VmwareHypervisorHost hyperHost getHyperHost context try HostMO hostMo HostMO hyperHost ClusterMO clusterMo new ClusterMO context hostMo getHyperHostCluster VmwareManager mgr context getStockObject VmwareManager CONTEXT_STOCK_NAME List Pair ManagedObjectReference String hosts clusterMo getClusterHosts for Pair ManagedObjectReference String entry hosts HostMO hostInCluster new HostMO context entry first String hostIp hostInCluster getHostManagementIp mgr getManagementPortGroupName if hostIp null hostIp equals cmd getComputingHostIp if hostInCluster isHyperHostConnected return new Answer cmd
protected Answer execute CheckOnHostCommand cmd if s_logger isInfoEnabled
details return new Answer cmd result details try VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null GuestInfo guestInfo vmMo getGuestInfo VirtualMachineToolsStatus toolsStatus guestInfo getToolsStatus if toolsStatus VirtualMachineToolsStatus TOOLS_NOT_INSTALLED details else ip guestInfo getIpAddress if ip null result true details ip else
GuestInfo guestInfo vmMo getGuestInfo VirtualMachineToolsStatus toolsStatus guestInfo getToolsStatus if toolsStatus VirtualMachineToolsStatus TOOLS_NOT_INSTALLED details else ip guestInfo getIpAddress if ip null result true details ip else details vmName hyperHost getHyperHostName s_logger info details catch Throwable e if e RemoteException s_logger warn
Override public PrimaryStorageDownloadAnswer execute PrimaryStorageDownloadCommand cmd if s_logger isInfoEnabled
protected Answer execute UnregisterVMCommand cmd if s_logger isInfoEnabled
deleteUnregisteredVmFiles vmFileLayout dataCenterMo false null return new Answer cmd true catch Exception e s_logger warn VmwareHelper getExceptionMessage e String msg cmd getVmName s_logger warn msg return new Answer cmd false msg else String msg cmd getVmName s_logger warn msg return new Answer cmd true msg catch Exception e if e RemoteException s_logger warn invalidateServiceContext
protected Answer execute UnregisterNicCommand cmd
if _guestTrafficInfo null return new Answer cmd false try if _guestTrafficInfo getVirtualSwitchType VirtualSwitchType StandardVirtualSwitch return new Answer cmd true s_logger debug cmd getNicUuid _guestTrafficInfo getVirtualSwitchName VmwareContext context getServiceContext VmwareHypervisorHost host getHyperHost context ManagedObjectReference clusterMO host getHyperHostCluster SuppressWarnings List ManagedObjectReference hosts List ManagedObjectReference context getVimClient getDynamicProperty clusterMO if hosts null return new Answer cmd false for ManagedObjectReference hostMOR hosts HostMO hostMo new HostMO context hostMOR hostMo deletePortGroup cmd getNicUuid toString
Override public CopyVolumeAnswer execute CopyVolumeCommand cmd if s_logger isInfoEnabled
String workerTag null for DynamicProperty prop props if prop getName equals template Boolean prop getVal else if prop getName equals workerPropName CustomFieldStringValue val CustomFieldStringValue prop getVal if val null val getValue null val getValue equalsIgnoreCase isWorker true else if prop getName equals workerTagPropName CustomFieldStringValue val CustomFieldStringValue prop getVal workerTag val getValue VirtualMachineMO vmMo new VirtualMachineMO hyperHost getContext oc getObj if template isWorker boolean recycle false recycle mgr needRecycle workerTag if recycle
Override public StartupCommand initialize try String hostApiVersion VmwareContext context getServiceContext try VmwareHypervisorHost hyperHost getHyperHost context assert hyperHost HostMO if HostMO hyperHost isHyperHostConnected
Override public StartupCommand initialize try String hostApiVersion VmwareContext context getServiceContext try VmwareHypervisorHost hyperHost getHyperHost context assert hyperHost HostMO if HostMO hyperHost isHyperHostConnected s_logger info hyperHost getHyperHostName return null HostMO hyperHost enableVncOnHostFirewall AboutInfo aboutInfo HostMO hyperHost getHostAboutInfo hostApiVersion aboutInfo getApiVersion catch Exception e String msg VmwareHelper getExceptionMessage e
String poolUuid dsMo getCustomFieldValue CustomFieldConstants CLOUD_UUID if poolUuid null poolUuid isEmpty poolUuid UUID randomUUID toString dsMo setCustomFieldValue CustomFieldConstants CLOUD_UUID poolUuid DatastoreSummary dsSummary dsMo getSummary String address hostMo getHostName StoragePoolInfo pInfo new StoragePoolInfo poolUuid address dsMo getMor getValue StoragePoolType VMFS dsSummary getCapacity dsSummary getFreeSpace StartupStorageCommand cmd new StartupStorageCommand cmd setName poolUuid cmd setPoolInfo pInfo cmd setGuid poolUuid cmd setResourceType Storage StorageResourceType STORAGE_POOL cmd setDataCenter _dcId cmd setPod _pod cmd setCluster _cluster
Map String String details cmd getHostDetails if details null details new HashMap String String try fillHostHardwareInfo serviceContext cmd fillHostNetworkInfo serviceContext cmd fillHostDetailsInfo serviceContext details catch RuntimeFaultFaultMsg e s_logger error e toString e throw new CloudRuntimeException catch RemoteException e s_logger error e toString e invalidateServiceContext throw new CloudRuntimeException catch Exception e
private void fillHostHardwareInfo VmwareContext serviceContext StartupRoutingCommand cmd throws RuntimeFaultFaultMsg RemoteException Exception VmwareHypervisorHost hyperHost getHyperHost getServiceContext VmwareHypervisorHostResourceSummary summary hyperHost getHyperHostResourceSummary if s_logger isInfoEnabled
assert hyperHost HostMO VmwareManager mgr hyperHost getContext getStockObject VmwareManager CONTEXT_STOCK_NAME VmwareHypervisorHostNetworkSummary summary hyperHost getHyperHostNetworkSummary mgr getManagementPortGroupByHost HostMO hyperHost if summary null throw new Exception if s_logger isInfoEnabled s_logger info _gson toJson summary cmd setPrivateIpAddress summary getHostIp cmd setPrivateNetmask summary getHostNetmask cmd setPrivateMacAddress summary getHostMacAddress cmd setStorageIpAddress summary getHostIp cmd setStorageNetmask summary getHostNetmask cmd setStorageMacAddress summary getHostMacAddress catch Throwable e String msg VmwareHelper getExceptionMessage e
val val maxVncPorts while val startVal if vncPort s_logger info Pair Integer Integer additionalRange mgr getAddiionalVncPortRange maxVncPorts additionalRange second val random nextInt maxVncPorts startVal val do if existingPorts contains additionalRange first val vncPort additionalRange first val break val val maxVncPorts while val startVal if vncPort
protected String connect final String vmName final String ipAddress final int port long startTick System currentTimeMillis int retry _retry while System currentTimeMillis startTick _opsTimeout retry
int retry _retry while System currentTimeMillis startTick _opsTimeout retry s_logger info ipAddress try SocketChannel sch SocketChannel open sch configureBlocking true sch socket setSoTimeout InetSocketAddress addr new InetSocketAddress ipAddress port sch connect addr return null catch IOException e s_logger info ipAddress e toString if e ConnectException try Thread sleep catch InterruptedException ex
cfmMo ensureCustomFieldDef CustomFieldConstants CLOUD_WORKER cfmMo ensureCustomFieldDef CustomFieldConstants CLOUD_WORKER_TAG VmwareHypervisorHost hostMo this getHyperHost context _hostName hostMo getHyperHostName if _guestTrafficInfo getVirtualSwitchType VirtualSwitchType NexusDistributedVirtualSwitch _publicTrafficInfo getVirtualSwitchType VirtualSwitchType NexusDistributedVirtualSwitch _privateNetworkVSwitchName mgr getPrivateVSwitchName Long parseLong _dcId HypervisorType VMware _vsmCredentials mgr getNexusVSMCredentialsByClusterId Long parseLong _cluster if _privateNetworkVSwitchName null _privateNetworkVSwitchName String params get String value String params get if value null value equalsIgnoreCase _recycleHungWorker true value String params get if value null value equalsIgnoreCase _rootDiskController DiskControllerType scsi else if value null value equalsIgnoreCase _rootDiskController DiskControllerType ide else _rootDiskController DiskControllerType osdefault
String poolKey VmwareContextPool composePoolKey _vCenterAddress _username if context getPoolKey equals poolKey if context validate if s_logger isTraceEnabled s_logger trace return context else s_logger info invalidateServiceContext context else s_logger warn poolKey context getPoolKey try context VmwareContextFactory getContext _vCenterAddress _username _password s_serviceContext set context catch Exception e
Override public Answer execute DestroyCommand cmd if s_logger isInfoEnabled
VmwareHypervisorHost hyperHost getHyperHost context null VolumeTO vol cmd getVolume VirtualMachineMO vmMo findVmOnDatacenter context hyperHost vol if vmMo null vmMo isTemplate if s_logger isInfoEnabled s_logger info vol getPath vmMo destroy else if s_logger isInfoEnabled s_logger info vol getPath return new Answer cmd true catch Throwable e if e RemoteException s_logger warn invalidateServiceContext null
protected VirtualMachineMO findVmOnDatacenter VmwareContext context VmwareHypervisorHost hyperHost VolumeTO vol throws Exception DatacenterMO dcMo new DatacenterMO context hyperHost getHyperHostDatacenter if dcMo getMor null String msg
private static File fetchSystemVmKeyFile String filePath s_relativePathSystemVmKeyFileInstallDir
break if disk getBacking VirtualDeviceFileBackingInfo VirtualDeviceFileBackingInfo diskBacking VirtualDeviceFileBackingInfo disk getBacking ManagedObjectReference morDs diskBacking getDatastore DatastoreInfo info DatastoreInfo vmMo getContext getVimClient getDynamicProperty diskBacking getDatastore if info NasDatastoreInfo NasDatastoreInfo dsInfo NasDatastoreInfo info instanceDisk setDatastoreName dsInfo getName if dsInfo getNas null instanceDisk setDatastoreHost dsInfo getNas getRemoteHost instanceDisk setDatastorePath dsInfo getNas getRemotePath instanceDisk setDatastoreType dsInfo getNas getType else if info VmfsDatastoreInfo VmfsDatastoreInfo dsInfo VmfsDatastoreInfo info instanceDisk setDatastoreName dsInfo getVmfs getName
List UnmanagedInstanceTO Nic instanceNics new ArrayList HashMap String List String guestNicMacIPAddressMap new HashMap try GuestInfo guestInfo vmMo getGuestInfo if guestInfo getToolsStatus VirtualMachineToolsStatus TOOLS_OK for GuestNicInfo nicInfo guestInfo getNet if CollectionUtils isNotEmpty nicInfo getIpAddress List String ipAddresses new ArrayList for String ipAddress nicInfo getIpAddress if NetUtils isValidIp4 ipAddress ipAddresses add ipAddress guestNicMacIPAddressMap put nicInfo getMacAddress ipAddresses else s_logger info String format vmMo getName guestInfo getToolsStatus toString catch Exception e
for GuestNicInfo nicInfo guestInfo getNet if CollectionUtils isNotEmpty nicInfo getIpAddress List String ipAddresses new ArrayList for String ipAddress nicInfo getIpAddress if NetUtils isValidIp4 ipAddress ipAddresses add ipAddress guestNicMacIPAddressMap put nicInfo getMacAddress ipAddresses else s_logger info String format vmMo getName guestInfo getToolsStatus toString catch Exception e s_logger info e getMessage VirtualDevice nics null try nics vmMo getNicDevices catch Exception e
try VirtualEthernetCard ethCardDevice VirtualEthernetCard nic s_logger error nic getClass getCanonicalName nic getBacking getClass getCanonicalName ethCardDevice getMacAddress UnmanagedInstanceTO Nic instanceNic new UnmanagedInstanceTO Nic instanceNic setNicId ethCardDevice getDeviceInfo getLabel if ethCardDevice VirtualPCNet32 instanceNic setAdapterType VirtualEthernetCardType PCNet32 toString else if ethCardDevice VirtualVmxnet2 instanceNic setAdapterType VirtualEthernetCardType Vmxnet2 toString else if ethCardDevice VirtualVmxnet3 instanceNic setAdapterType VirtualEthernetCardType Vmxnet3 toString else instanceNic setAdapterType VirtualEthernetCardType E1000 toString instanceNic setMacAddress ethCardDevice getMacAddress if guestNicMacIPAddressMap containsKey instanceNic getMacAddress
private Answer execute GetUnmanagedInstancesCommand cmd if s_logger isInfoEnabled
private Answer execute PrepareUnmanageVMInstanceCommand cmd
vsm _vsmDao getVSMbyIpaddress vsmIp if vsm null ClusterVSMMapVO connectorObj new ClusterVSMMapVO clusterId vsm getId _clusterVSMDao persist connectorObj return vsm else String msg msg Config VmwareUseNexusVSwitch toString if vsmIp null msg if vsmUser null msg if vsmPassword null if vsmUser null
Override public Answer executeRequest Command cmd String hypervisor cmd getContextParam if hypervisor null Hypervisor HypervisorType hypervisorType Hypervisor HypervisorType getType hypervisor if hypervisorType null
String tokens guid split if tokens null tokens length s_logger error return null String vCenterAddress tokens String hostTokens tokens split if hostTokens null hostTokens length s_logger error return null int vCenterSessionTimeout NumbersUtil parseInt cmd getContextParam try _resource ensureOutgoingRuleForAddress vCenterAddress VmwareContext context currentContext get if context null context validate invalidateServiceContext context
if hostTokens null hostTokens length s_logger error return null morHyperHost setType hostTokens morHyperHost setValue hostTokens if morHyperHost getType equalsIgnoreCase HostMO hostMo new HostMO context morHyperHost try ManagedObjectReference mor hostMo getHyperHostCluster ClusterMO clusterMo new ClusterMO hostMo getContext mor List Pair ManagedObjectReference String hostsInCluster clusterMo getClusterHosts for Pair ManagedObjectReference String hostPair hostsInCluster HostMO hostIteratorMo new HostMO hostMo getContext hostPair first VmwareHypervisorHostNetworkSummary netSummary hostIteratorMo getHyperHostNetworkSummary hostIteratorMo getHostType VmwareHostType ESXi cmd getContextParam cmd getContextParam _resource ensureOutgoingRuleForAddress netSummary getHostIp
public static String syncVolumeToVmDefaultFolder DatacenterMO dcMo String vmName DatastoreMO ds String vmdkName String excludeFolders throws Exception assert ds null if ds folderExists String format ds getName vmName
public static void syncVolumeToRootFolder DatacenterMO dcMo DatastoreMO ds String vmdkName String vmName String excludeFolders throws Exception String fileDsFullPath ds searchFileInSubFolders vmdkName false excludeFolders if fileDsFullPath null return String folderName null if ds folderExists String format ds getName vmName folderName String format ds getName vmName DatastoreFile srcDsFile new DatastoreFile fileDsFullPath String companionFilePath srcDsFile getCompanionPath vmdkName if ds fileExists companionFilePath String targetPath getLegacyDatastorePathFromVmdkFileName ds vmdkName s_logger info companionFilePath targetPath ds moveDatastoreFile companionFilePath dcMo getMor ds getMor targetPath dcMo getMor true companionFilePath srcDsFile getCompanionPath vmdkName if ds fileExists companionFilePath String targetPath getLegacyDatastorePathFromVmdkFileName ds vmdkName
String folderName null if ds folderExists String format ds getName vmName folderName String format ds getName vmName DatastoreFile srcDsFile new DatastoreFile fileDsFullPath String companionFilePath srcDsFile getCompanionPath vmdkName if ds fileExists companionFilePath String targetPath getLegacyDatastorePathFromVmdkFileName ds vmdkName s_logger info companionFilePath targetPath ds moveDatastoreFile companionFilePath dcMo getMor ds getMor targetPath dcMo getMor true companionFilePath srcDsFile getCompanionPath vmdkName if ds fileExists companionFilePath String targetPath getLegacyDatastorePathFromVmdkFileName ds vmdkName s_logger info companionFilePath targetPath ds moveDatastoreFile companionFilePath dcMo getMor ds getMor targetPath dcMo getMor true String targetPath getLegacyDatastorePathFromVmdkFileName ds vmdkName
public static void moveVolumeToRootFolder DatacenterMO dcMo List String detachedDisks throws Exception if detachedDisks size for String fileFullDsPath detachedDisks DatastoreFile file new DatastoreFile fileFullDsPath
public static void moveVolumeToRootFolder DatacenterMO dcMo List String detachedDisks throws Exception if detachedDisks size for String fileFullDsPath detachedDisks DatastoreFile file new DatastoreFile fileFullDsPath s_logger info fileFullDsPath DatastoreMO dsMo new DatastoreMO dcMo getContext dcMo findDatastore file getDatastoreName if dsMo getMor null DatastoreFile targetFile new DatastoreFile file getDatastoreName file getFileName if targetFile getPath equalsIgnoreCase file getPath
public static void moveVolumeToRootFolder DatacenterMO dcMo List String detachedDisks throws Exception if detachedDisks size for String fileFullDsPath detachedDisks DatastoreFile file new DatastoreFile fileFullDsPath s_logger info fileFullDsPath DatastoreMO dsMo new DatastoreMO dcMo getContext dcMo findDatastore file getDatastoreName if dsMo getMor null DatastoreFile targetFile new DatastoreFile file getDatastoreName file getFileName if targetFile getPath equalsIgnoreCase file getPath s_logger info file getPath targetFile getPath dsMo moveDatastoreFile file getPath dcMo getMor dsMo getMor targetFile getPath dcMo getMor true String pairSrcFilePath file getCompanionPath file getFileBaseName String pairTargetFilePath targetFile getCompanionPath file getFileBaseName if dsMo fileExists pairSrcFilePath
s_logger info fileFullDsPath DatastoreMO dsMo new DatastoreMO dcMo getContext dcMo findDatastore file getDatastoreName if dsMo getMor null DatastoreFile targetFile new DatastoreFile file getDatastoreName file getFileName if targetFile getPath equalsIgnoreCase file getPath s_logger info file getPath targetFile getPath dsMo moveDatastoreFile file getPath dcMo getMor dsMo getMor targetFile getPath dcMo getMor true String pairSrcFilePath file getCompanionPath file getFileBaseName String pairTargetFilePath targetFile getCompanionPath file getFileBaseName if dsMo fileExists pairSrcFilePath s_logger info pairSrcFilePath pairTargetFilePath dsMo moveDatastoreFile pairSrcFilePath dcMo getMor dsMo getMor pairTargetFilePath dcMo getMor true pairSrcFilePath file getCompanionPath file getFileBaseName pairTargetFilePath targetFile getCompanionPath file getFileBaseName if dsMo fileExists pairSrcFilePath
private List HostUnresolvedVmfsExtent getExtentsMatching List HostUnresolvedVmfsExtent extents String naa List HostUnresolvedVmfsExtent matchingExtents new ArrayList if extents null for HostUnresolvedVmfsExtent extent extents
private Pair VirtualMachineMO Long copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid boolean createSnapshot String nfsVersion throws Exception
private Pair VirtualMachineMO Long copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid boolean createSnapshot String nfsVersion throws Exception s_logger info secondaryStorageUrl templatePathAtSecondaryStorage templateName String secondaryMountPoint mountService getMountPoint secondaryStorageUrl nfsVersion
private Pair VirtualMachineMO Long copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid boolean createSnapshot String nfsVersion throws Exception s_logger info secondaryStorageUrl templatePathAtSecondaryStorage templateName String secondaryMountPoint mountService getMountPoint secondaryStorageUrl nfsVersion s_logger info secondaryMountPoint String srcOVAFileName VmwareStorageLayoutHelper getTemplateOnSecStorageFilePath secondaryMountPoint templatePathAtSecondaryStorage templateName ImageFormat OVA getFileExtension String srcFileName getOVFFilePath srcOVAFileName if srcFileName null Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint templatePathAtSecondaryStorage
private Pair VirtualMachineMO Long copyTemplateFromSecondaryToPrimary VmwareHypervisorHost hyperHost DatastoreMO datastoreMo String secondaryStorageUrl String templatePathAtSecondaryStorage String templateName String templateUuid boolean createSnapshot String nfsVersion throws Exception s_logger info secondaryStorageUrl templatePathAtSecondaryStorage templateName String secondaryMountPoint mountService getMountPoint secondaryStorageUrl nfsVersion s_logger info secondaryMountPoint String srcOVAFileName VmwareStorageLayoutHelper getTemplateOnSecStorageFilePath secondaryMountPoint templatePathAtSecondaryStorage templateName ImageFormat OVA getFileExtension String srcFileName getOVFFilePath srcOVAFileName if srcFileName null Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint templatePathAtSecondaryStorage s_logger info command toString String result command execute if result null String msg srcOVAFileName
String srcFileName getOVFFilePath srcOVAFileName if srcFileName null Script command new Script s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint templatePathAtSecondaryStorage s_logger info command toString String result command execute if result null String msg srcOVAFileName s_logger error msg throw new Exception msg srcFileName getOVFFilePath srcOVAFileName if srcFileName null String msg srcOVAFileName
if result null String msg srcOVAFileName s_logger error msg throw new Exception msg srcFileName getOVFFilePath srcOVAFileName if srcFileName null String msg srcOVAFileName s_logger error msg throw new Exception msg String vmName templateUuid hyperHost importVmFromOVF srcFileName vmName datastoreMo VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName VmConfigInfo vAppConfig if vmMo null String msg secondaryStorageUrl templatePathAtSecondaryStorage templateName templateUuid
throw new Exception msg else vAppConfig vmMo getConfigInfo getVAppConfig if vAppConfig null s_logger info OVAProcessor processor new OVAProcessor Map String Object params new HashMap params put StorageLayer InstanceConfigKey _storage processor configure params long virtualSize processor getTemplateVirtualSize secondaryMountPoint templatePathAtSecondaryStorage templateName if createSnapshot if vmMo createSnapshot false false vmMo setCustomFieldValue CustomFieldConstants CLOUD_UUID templateName if vAppConfig null vmMo markAsTemplate
private boolean createVMFullClone VirtualMachineMO vmTemplate DatacenterMO dcMo DatastoreMO dsMo String vmdkName ManagedObjectReference morDatastore ManagedObjectReference morPool throws Exception s_logger info if vmTemplate createFullClone vmdkName dcMo getVmFolder morPool morDatastore String msg
if morDatastore null throw new Exception DatastoreMO dsMo new DatastoreMO context morDatastore String vmdkName volume getName String vmdkFileBaseName if srcStore null String dummyVmName hostService getWorkerName context cmd try vmMo HypervisorHostHelper createWorkerVM hyperHost dsMo dummyVmName if vmMo null throw new Exception vmdkFileBaseName vmMo getVmdkFileBaseNames get String vmdkFilePair VmwareStorageLayoutHelper getVmdkFilePairDatastorePath dsMo null vmdkFileBaseName VmwareStorageLayoutType CLOUDSTACK_LEGACY true String volumeDatastorePath vmdkFilePair synchronized this
else String templatePath template getPath VirtualMachineMO vmTemplate VmwareHelper pickOneVmOnRunningHost dcMo findVmByNameAndLabel templatePath true if vmTemplate null s_logger warn return new CopyCmdAnswer ManagedObjectReference morPool hyperHost getHyperHostOwnerResourcePool ManagedObjectReference morCluster hyperHost getHyperHostCluster if template getSize null _fullCloneFlag volume getSize template getSize true _fullCloneFlag if _fullCloneFlag createVMLinkedClone vmTemplate dcMo vmdkName morDatastore morPool else createVMFullClone vmTemplate dcMo dsMo vmdkName morDatastore morPool vmMo new ClusterMO context morCluster findVmOnHyperHost vmdkName
VirtualMachineMO vmTemplate VmwareHelper pickOneVmOnRunningHost dcMo findVmByNameAndLabel templatePath true if vmTemplate null s_logger warn return new CopyCmdAnswer ManagedObjectReference morPool hyperHost getHyperHostOwnerResourcePool ManagedObjectReference morCluster hyperHost getHyperHostCluster if template getSize null _fullCloneFlag volume getSize template getSize true _fullCloneFlag if _fullCloneFlag createVMLinkedClone vmTemplate dcMo vmdkName morDatastore morPool else createVMFullClone vmTemplate dcMo dsMo vmdkName morDatastore morPool vmMo new ClusterMO context morCluster findVmOnHyperHost vmdkName assert vmMo null vmdkFileBaseName vmMo getVmdkFileBaseNames get
ManagedObjectReference morDatastore HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost uuid if morDatastore null URI uri new URI destStore getUrl morDatastore hyperHost mountDatastore false uri getHost uri getPath destStore getUuid replace if morDatastore null throw new Exception uri getHost uri getPath Pair String String result copyVolumeFromSecStorage hyperHost srcVolume getPath new DatastoreMO context morDatastore srcStore getUrl long cmd getWait _nfsVersion deleteVolumeDirOnSecondaryStorage result first srcStore getUrl _nfsVersion VolumeObjectTO newVolume new VolumeObjectTO newVolume setPath result second return new CopyCmdAnswer newVolume catch Throwable t if t RemoteException hostService invalidateServiceContext context String msg
private Pair String String copyVolumeToSecStorage VmwareHostService hostService VmwareHypervisorHost hyperHost CopyCommand cmd String vmName String poolId String volumePath String destVolumePath String secStorageUrl String workerVmName throws Exception VirtualMachineMO workerVm null VirtualMachineMO vmMo null String exportName UUID randomUUID toString replace String searchExcludedFolders cmd getContextParam try ManagedObjectReference morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost poolId if morDs null String msg
String exportName UUID randomUUID toString replace String searchExcludedFolders cmd getContextParam try ManagedObjectReference morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost poolId if morDs null String msg s_logger error msg throw new Exception msg boolean clonedWorkerVMNeeded true vmMo hyperHost findVmOnHyperHost vmName if vmMo null VmwareResource getVmState vmMo PowerState PowerOff DatastoreMO dsMo new DatastoreMO hyperHost getContext morDs workerVm HypervisorHostHelper createWorkerVM hyperHost dsMo workerVmName if workerVm null String msg
String vmName srcVolume getVmName VmwareContext context hostService getServiceContext cmd try DataStoreTO primaryStorage srcVolume getDataStore NfsTO destStore NfsTO destVolume getDataStore VmwareHypervisorHost hyperHost hostService getHyperHost context cmd Pair String String result result copyVolumeToSecStorage hostService hyperHost cmd vmName primaryStorage getUuid srcVolume getPath destVolume getPath destStore getUrl hostService getWorkerName context cmd VolumeObjectTO newVolume new VolumeObjectTO newVolume setPath result first File separator result second return new CopyCmdAnswer newVolume catch Throwable e if e RemoteException hostService invalidateServiceContext context String msg
private Ternary String Long Long createTemplateFromVolume VirtualMachineMO vmMo String installPath long templateId String templateUniqueName String secStorageUrl String volumePath String workerVmName String nfsVersion throws Exception String secondaryMountPoint mountService getMountPoint secStorageUrl nfsVersion String installFullPath secondaryMountPoint installPath synchronized installPath intern Script command new Script false _timeout s_logger command add command add installFullPath String result command execute if result null String msg installPath secStorageUrl result
String installFullPath secondaryMountPoint installPath synchronized installPath intern Script command new Script false _timeout s_logger command add command add installFullPath String result command execute if result null String msg installPath secStorageUrl result s_logger error msg throw new Exception msg VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath
command add installFullPath String result command execute if result null String msg installPath secStorageUrl result s_logger error msg throw new Exception msg VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath s_logger error msg throw new Exception msg if vmMo createSnapshot templateUniqueName false false String msg volumePath
VolumeObjectTO volume VolumeObjectTO cmd getSrcTO TemplateObjectTO template TemplateObjectTO cmd getDestTO DataStoreTO imageStore template getDataStore if imageStore NfsTO return new CopyCmdAnswer NfsTO nfsImageStore NfsTO imageStore String secondaryStoragePoolURL nfsImageStore getUrl String volumePath volume getPath String details null VmwareContext context hostService getServiceContext cmd try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd VirtualMachineMO vmMo hyperHost findVmOnHyperHost volume getVmName if vmMo null if s_logger isDebugEnabled
DatacenterMO dcMo new DatacenterMO context dcMor vmMo dcMo findVm volume getVmName if vmMo null String msg volume getVmName s_logger error msg throw new Exception msg Ternary String Long Long result createTemplateFromVolume vmMo template getPath template getId template getName secondaryStoragePoolURL volumePath hostService getWorkerName context cmd _nfsVersion TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath result first newTemplate setFormat ImageFormat OVA newTemplate setSize result third newTemplate setPhysicalSize result second return new CopyCmdAnswer newTemplate catch Throwable e if e RemoteException
synchronized installPath intern command new Script false _timeout s_logger command add command add installFullPath result command execute if result null String msg installPath secStorageUrl result s_logger error msg throw new Exception msg try if new File snapshotFullOVAName exists command new Script false wait s_logger command add snapshotFullOVAName command add installFullOVAName result command execute
String msg installPath secStorageUrl result s_logger error msg throw new Exception msg try if new File snapshotFullOVAName exists command new Script false wait s_logger command add snapshotFullOVAName command add installFullOVAName result command execute if result null String msg snapshotFullOVAName installFullPath s_logger error msg throw new Exception msg command new Script wait s_logger command add
try if new File snapshotFullOVAName exists command new Script false wait s_logger command add snapshotFullOVAName command add installFullOVAName result command execute if result null String msg snapshotFullOVAName installFullPath s_logger error msg throw new Exception msg command new Script wait s_logger command add command add installFullOVAName command setWorkDir installFullPath s_logger info command toString
throw new Exception msg command new Script wait s_logger command add command add installFullOVAName command setWorkDir installFullPath s_logger info command toString result command execute if result null String msg snapshotFullOVAName installFullPath s_logger error msg throw new Exception msg else if new File snapshotFullOvfName exists command new Script false wait s_logger command add snapshotFullOvfName
result command execute if result null String msg snapshotFullOVAName installFullPath s_logger error msg throw new Exception msg else if new File snapshotFullOvfName exists command new Script false wait s_logger command add snapshotFullOvfName command add installFullPath result command execute if result null String msg snapshotFullOvfName installFullPath s_logger error msg throw new Exception msg
String msg snapshotFullOvfName installFullPath s_logger error msg throw new Exception msg s_logger info snapshotRoot File snapshotdir new File snapshotRoot File ssfiles snapshotdir listFiles if ssfiles null String msg snapshotRoot s_logger error msg throw new Exception msg for int i i ssfiles length i String vmdkfile ssfiles i getName s_logger info vmdkfile if vmdkfile toLowerCase startsWith backupSSUuid vmdkfile toLowerCase endsWith snapshotFullVMDKName snapshotRoot File separator vmdkfile
s_logger info snapshotRoot File snapshotdir new File snapshotRoot File ssfiles snapshotdir listFiles if ssfiles null String msg snapshotRoot s_logger error msg throw new Exception msg for int i i ssfiles length i String vmdkfile ssfiles i getName s_logger info vmdkfile if vmdkfile toLowerCase startsWith backupSSUuid vmdkfile toLowerCase endsWith snapshotFullVMDKName snapshotRoot File separator vmdkfile templateVMDKName vmdkfile break if snapshotFullVMDKName null
if ssfiles null String msg snapshotRoot s_logger error msg throw new Exception msg for int i i ssfiles length i String vmdkfile ssfiles i getName s_logger info vmdkfile if vmdkfile toLowerCase startsWith backupSSUuid vmdkfile toLowerCase endsWith snapshotFullVMDKName snapshotRoot File separator vmdkfile templateVMDKName vmdkfile break if snapshotFullVMDKName null command new Script false wait s_logger command add snapshotFullVMDKName command add installFullPath
private void createTemplateFolder String installPath String installFullPath NfsTO nfsSvr synchronized installPath intern Script command new Script false _timeout s_logger command add command add installFullPath String result command execute if result null String secStorageUrl nfsSvr getUrl String msg installPath secStorageUrl result
private String getTemplateVmdkName String installFullPath String exportName File templateDir new File installFullPath File templateFiles templateDir listFiles if templateFiles null String msg installFullPath
createTemplateFolder installPath installFullPath nfsSvr String exportName UUID randomUUID toString exportManagedStorageSnapshotToTemplate cmd installFullPath snapshotPath exportName String templateVmdkName getTemplateVmdkName installFullPath exportName String uniqueName options get DiskTO UUID Size size handleMetadataCreateTemplateFromSnapshot installFullPath templateVmdkName template getId uniqueName exportName TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath installPath uniqueName newTemplate setPhysicalSize size getPhysicalSize newTemplate setSize size getVirtualSize newTemplate setFormat ImageFormat OVA newTemplate setName uniqueName return new CopyCmdAnswer newTemplate catch Exception ex String errMsg ex getMessage
private Pair String String exportVolumeToSecondaryStorage VirtualMachineMO vmMo String volumePath String secStorageUrl String secStorageDir String exportName String workerVmName String nfsVersion boolean clonedWorkerVMNeeded throws Exception String secondaryMountPoint mountService getMountPoint secStorageUrl nfsVersion String exportPath secondaryMountPoint secStorageDir exportName synchronized exportPath intern if new File exportPath exists Script command new Script false _timeout s_logger command add command add exportPath if command execute null throw new Exception VirtualMachineMO clonedVm null try Pair VirtualDisk String volumeDeviceInfo vmMo getDiskDevice volumePath if volumeDeviceInfo null String msg volumePath
boolean success String snapshotBackupUuid boolean hasOwnerVm false Ternary String String String backupResult null VmwareContext context hostService getServiceContext cmd VirtualMachineMO vmMo null String vmName srcSnapshot getVmName try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost primaryStore getUuid CopyCmdAnswer answer null try if vmName null vmMo hyperHost findVmOnHyperHost vmName if vmMo null
if vmName null vmMo hyperHost findVmOnHyperHost vmName if vmMo null if s_logger isDebugEnabled s_logger debug hyperHost getHyperHostName vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null dsMo new DatastoreMO hyperHost getContext morDs workerVMName hostService getWorkerName context cmd vmMo HypervisorHostHelper createWorkerVM hyperHost dsMo workerVMName if vmMo null throw new Exception workerVMName workerVm vmMo String datastoreVolumePath dsMo getDatastorePath volumePath vmMo attachDisk new String datastoreVolumePath morDs
s_logger info vmdkDsFilePath if chainConsolidated String topVmdkFilePath null try topVmdkFilePath vmMo getDiskCurrentTopBackingFileInChain backupResult second catch Exception e s_logger error e s_logger info topVmdkFilePath if topVmdkFilePath null DatastoreFile file new DatastoreFile topVmdkFilePath SnapshotObjectTO snapshotInfo SnapshotObjectTO answer getNewData VolumeObjectTO vol new VolumeObjectTO vol setUuid srcSnapshot getVolume getUuid vol setPath file getFileBaseName snapshotInfo setVolume vol
private Answer attachVolume Command cmd DiskTO disk boolean isAttach boolean isManaged String vmName String iScsiName String storageHost int storagePort Map String String controllerInfo VolumeObjectTO volumeTO VolumeObjectTO disk getData DataStoreTO primaryStore volumeTO getDataStore String vmdkPath isManaged resource getVmdkPath volumeTO getPath null try VmwareContext context hostService getServiceContext null VmwareHypervisorHost hyperHost hostService getHyperHost context null VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null vmMo hyperHost findVmOnPeerHyperHost vmName if vmMo null String msg vmName
s_logger error msg throw new Exception msg vmName vmMo getName ManagedObjectReference morDs String diskUuid volumeTO getUuid replace if isAttach isManaged Map String String details disk getDetails morDs prepareManagedStorage context hyperHost diskUuid iScsiName storageHost storagePort vmdkPath details get DiskTO CHAP_INITIATOR_USERNAME details get DiskTO CHAP_INITIATOR_SECRET details get DiskTO CHAP_TARGET_USERNAME details get DiskTO CHAP_TARGET_SECRET volumeTO getSize cmd else if storagePort DEFAULT_NFS_PORT morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost isManaged VmwareResource getDatastoreName diskUuid primaryStore getUuid else morDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost isManaged VmwareResource getDatastoreName iScsiName primaryStore getUuid if morDs null String msg vmName
private Answer attachIso DiskTO disk boolean isAttach String vmName try VmwareContext context hostService getServiceContext null VmwareHypervisorHost hyperHost hostService getHyperHost context null VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null String msg vmName
VmwareContext context hostService getServiceContext null VmwareHypervisorHost hyperHost hostService getHyperHost context null VirtualMachineMO vmMo hyperHost findVmOnHyperHost vmName if vmMo null String msg vmName s_logger error msg throw new Exception msg TemplateObjectTO iso TemplateObjectTO disk getData NfsTO nfsImageStore NfsTO iso getDataStore String storeUrl null if nfsImageStore null storeUrl nfsImageStore getUrl if storeUrl null if iso getName equalsIgnoreCase String msg
s_logger error msg throw new Exception msg else if isAttach vmMo mountToolsInstaller else try if vmMo unmountToolsInstaller return new AttachAnswer catch Throwable e vmMo detachIso null return new AttachAnswer disk ManagedObjectReference morSecondaryDs prepareSecondaryDatastoreOnHost storeUrl String isoPath nfsImageStore getUrl File separator iso getPath if isoPath startsWith storeUrl
ManagedObjectReference morSecondaryDs prepareSecondaryDatastoreOnHost storeUrl String isoPath nfsImageStore getUrl File separator iso getPath if isoPath startsWith storeUrl assert false String msg s_logger error msg throw new Exception msg int isoNameStartPos isoPath lastIndexOf String isoFileName isoPath substring isoNameStartPos String isoStorePathFromRoot isoPath substring storeUrl length isoNameStartPos DatastoreMO secondaryDsMo new DatastoreMO context morSecondaryDs String storeName secondaryDsMo getName String isoDatastorePath String format storeName isoStorePathFromRoot isoFileName if isAttach vmMo attachIso isoDatastorePath morSecondaryDs true false
VolumeObjectTO volume VolumeObjectTO cmd getData DataStoreTO primaryStore volume getDataStore try VmwareContext context hostService getServiceContext null VmwareHypervisorHost hyperHost hostService getHyperHost context null DatacenterMO dcMo new DatacenterMO context hyperHost getHyperHostDatacenter ManagedObjectReference morDatastore HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost primaryStore getUuid if morDatastore null throw new Exception DatastoreMO dsMo new DatastoreMO context morDatastore VirtualMachineMO vmMo null String volumeUuid UUID randomUUID toString replace String volumeDatastorePath dsMo getDatastorePath volumeUuid String dummyVmName hostService getWorkerName context cmd try
DatastoreMO dsMo new DatastoreMO context morDatastore VirtualMachineMO vmMo null String volumeUuid UUID randomUUID toString replace String volumeDatastorePath dsMo getDatastorePath volumeUuid String dummyVmName hostService getWorkerName context cmd try s_logger info dummyVmName vmMo HypervisorHostHelper createWorkerVM hyperHost dsMo dummyVmName if vmMo null throw new Exception synchronized this try vmMo createDisk volumeDatastorePath int volume getSize 1024L 1024L morDatastore vmMo getScsiDeviceControllerKey vmMo detachDisk volumeDatastorePath false catch Exception e
catch Exception e s_logger error volumeDatastorePath e getMessage VmwareStorageLayoutHelper deleteVolumeVmdkFiles dsMo volumeUuid dcMo VmwareManager s_vmwareSearchExcludeFolder value throw new CloudRuntimeException e getMessage VolumeObjectTO newVol new VolumeObjectTO newVol setPath volumeUuid newVol setSize volume getSize return new CreateObjectAnswer newVol finally s_logger info if vmMo null vmMo detachAllDisks vmMo destroy catch Throwable e if e RemoteException
Override public Answer deleteVolume DeleteCommand cmd if s_logger isInfoEnabled
if morDs null String msg store getUuid s_logger error msg throw new Exception msg DatastoreMO dsMo new DatastoreMO context morDs ManagedObjectReference morDc hyperHost getHyperHostDatacenter ManagedObjectReference morCluster hyperHost getHyperHostCluster ClusterMO clusterMo new ClusterMO context morCluster if vol getVolumeType Volume Type ROOT String vmName vol getVmName if vmName null VirtualMachineMO vmMo clusterMo findVmOnHyperHost vmName if vmMo null DatacenterMO dcMo new DatacenterMO context morDc vmMo dcMo findVm vmName
private ManagedObjectReference prepareManagedDatastore VmwareContext context VmwareHypervisorHost hyperHost String diskUuid String iScsiName String storageHost int storagePort String chapInitiatorUsername String chapInitiatorSecret String chapTargetUsername String chapTargetSecret throws Exception if storagePort DEFAULT_NFS_PORT
String srcOVFFileName srcOVAFileName secondaryMountPoint secStorageDir backupName ImageFormat OVA getFileExtension srcOVFFileName secondaryMountPoint secStorageDir backupName String snapshotDir if backupName contains snapshotDir backupName split File ovafile new File srcOVAFileName File ovfFile new File srcOVFFileName if ovfFile exists srcOVFFileName getOVFFilePath srcOVAFileName if srcOVFFileName null ovafile exists Script command new Script wait s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir
if backupName contains snapshotDir backupName split File ovafile new File srcOVAFileName File ovfFile new File srcOVFFileName if ovfFile exists srcOVFFileName getOVFFilePath srcOVAFileName if srcOVFFileName null ovafile exists Script command new Script wait s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir s_logger info command toString String result command execute if result null String msg srcOVAFileName
if ovfFile exists srcOVFFileName getOVFFilePath srcOVAFileName if srcOVFFileName null ovafile exists Script command new Script wait s_logger command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir s_logger info command toString String result command execute if result null String msg srcOVAFileName s_logger error msg throw new Exception msg srcOVFFileName getOVFFilePath srcOVAFileName else if srcOVFFileName null
command add command add srcOVAFileName command setWorkDir secondaryMountPoint secStorageDir snapshotDir s_logger info command toString String result command execute if result null String msg srcOVAFileName s_logger error msg throw new Exception msg srcOVFFileName getOVFFilePath srcOVAFileName else if srcOVFFileName null String msg srcOVAFileName s_logger error msg throw new Exception msg if srcOVFFileName null
NfsTO nfsImageStore NfsTO imageStore String primaryStorageNameLabel pool getUuid String secondaryStorageUrl nfsImageStore getUrl String backedUpSnapshotUuid snapshot getPath int index backedUpSnapshotUuid lastIndexOf File separator String backupPath backedUpSnapshotUuid substring index backedUpSnapshotUuid backedUpSnapshotUuid substring index String details String newVolumeName VmwareHelper getVCenterSafeUuid VmwareContext context hostService getServiceContext cmd try VmwareHypervisorHost hyperHost hostService getHyperHost context cmd ManagedObjectReference morPrimaryDs HypervisorHostHelper findDatastoreWithBackwardsCompatibility hyperHost primaryStorageNameLabel if morPrimaryDs null String msg primaryStorageNameLabel
String msg primaryStorageNameLabel s_logger error msg throw new Exception msg if backedUpSnapshotUuid endsWith backedUpSnapshotUuid backedUpSnapshotUuid replace else if backedUpSnapshotUuid endsWith backedUpSnapshotUuid backedUpSnapshotUuid replace DatastoreMO primaryDsMo new DatastoreMO hyperHost getContext morPrimaryDs restoreVolumeFromSecStorage hyperHost primaryDsMo newVolumeName secondaryStorageUrl backupPath backedUpSnapshotUuid long cmd getWait _nfsVersion VolumeObjectTO newVol new VolumeObjectTO newVol setPath newVolumeName return new CopyCmdAnswer newVol catch Throwable e if e RemoteException hostService invalidateServiceContext context
void setNfsVersion String nfsVersion this _nfsVersion nfsVersion
void setFullCloneFlag boolean value this _fullCloneFlag value
Override public StrategyPriority canHandle DataObject srcData DataObject destData if isOnVmware srcData destData isOnPrimary srcData destData isVolumesOnly srcData destData isDettached srcData isIntraCluster srcData destData isStoreScopeEqual srcData destData if s_logger isDebugEnabled String msg String format this getClass srcData getId srcData getUuid destData getId destData getUuid storagePoolDao findById srcData getDataStore getId getClusterId storagePoolDao findById destData getDataStore getId getClusterId
private boolean isStoreScopeEqual DataObject srcData DataObject destData DataStore srcStore srcData getDataStore DataStore destStore destData getDataStore String msg String format srcStore getScope toString destStore getScope toString
Override public void copyAsync DataObject srcData DataObject destData Host destHost AsyncCompletionCallback CopyCommandResult callback if destHost null String format String msg String format format this getClass getName srcData toString destData toString
StorageFilerTO filerTo new StorageFilerTO StoragePool entry getValue volumeToFilerto add new Pair VolumeTO StorageFilerTO volumeTo filerTo MigrateWithStorageCommand migrateWithStorageCmd new MigrateWithStorageCommand to volumeToFilerto destHost getGuid MigrateWithStorageAnswer migrateWithStorageAnswer MigrateWithStorageAnswer agentMgr send srcHost getId migrateWithStorageCmd if migrateWithStorageAnswer null s_logger error vm destHost throw new CloudRuntimeException vm destHost else if migrateWithStorageAnswer getResult s_logger error vm migrateWithStorageAnswer getDetails throw new CloudRuntimeException vm destHost migrateWithStorageAnswer getDetails else updateVolumesAfterMigration volumeToPool migrateWithStorageAnswer getVolumeTos s_logger debug vm getInstanceName destHost getName return migrateWithStorageAnswer catch OperationTimedoutException e
VolumeTO volumeTo new VolumeTO volume storagePoolDao findById volume getPoolId StorageFilerTO filerTo new StorageFilerTO StoragePool entry getValue volumeToFilerto add new Pair VolumeTO StorageFilerTO volumeTo filerTo MigrateWithStorageCommand command new MigrateWithStorageCommand to volumeToFilerto destHost getGuid MigrateWithStorageAnswer answer MigrateWithStorageAnswer agentMgr send srcHost getId command if answer null s_logger error vm throw new CloudRuntimeException vm destHost else if answer getResult s_logger error vm answer getDetails throw new CloudRuntimeException vm destHost answer getDetails else updateVolumesAfterMigration volumeToPool answer getVolumeTos return answer catch OperationTimedoutException e
for VolumeObjectTO volumeTo volumeTos if volume getId volumeTo getId VolumeVO volumeVO volDao findById volume getId Long oldPoolId volumeVO getPoolId volumeVO setPath volumeTo getPath if volumeTo getChainInfo null volumeVO setChainInfo volumeTo getChainInfo volumeVO setLastPoolId oldPoolId volumeVO setFolder pool getPath volumeVO setPodId pool getPodId volumeVO setPoolId pool getId volDao update volume getId volumeVO updated true break if updated
Override public Boolean fenceOff VirtualMachine vm Host host if host getHypervisorType HypervisorType XenServer
if host getHypervisorType HypervisorType XenServer s_logger debug host getHypervisorType return null List HostVO hosts _resourceMgr listAllHostsInCluster host getClusterId FenceCommand fence new FenceCommand vm host for HostVO h hosts if h getHypervisorType HypervisorType XenServer if h getStatus Status Up continue if h getId host getId continue FenceAnswer answer try Answer ans _agentMgr send h getId fence if ans FenceAnswer
FenceCommand fence new FenceCommand vm host for HostVO h hosts if h getHypervisorType HypervisorType XenServer if h getStatus Status Up continue if h getId host getId continue FenceAnswer answer try Answer ans _agentMgr send h getId fence if ans FenceAnswer s_logger debug ans getResult ans getDetails continue answer FenceAnswer ans catch AgentUnavailableException e
continue if h getId host getId continue FenceAnswer answer try Answer ans _agentMgr send h getId fence if ans FenceAnswer s_logger debug ans getResult ans getDetails continue answer FenceAnswer ans catch AgentUnavailableException e if s_logger isDebugEnabled s_logger debug h toString e continue catch OperationTimedoutException e
boolean isSourceObjectSnapshotTypeAndDestinationObjectTemplateType srcData getObjectType DataObjectType SNAPSHOT destData getObjectType DataObjectType TEMPLATE if isSourceObjectSnapshotTypeAndDestinationObjectTemplateType logger debug return defaultHostToExecuteCommands HostVO defaultHostToExecuteCommand hostDao findById hostId HostVO hostCandidateToExecutedCommand hostDao findHostInZoneToExecuteCommand defaultHostToExecuteCommand getDataCenterId srcData getHypervisorType hostDao loadDetails hostCandidateToExecutedCommand String hypervisorVersion hostCandidateToExecutedCommand getHypervisorVersion if StringUtils isBlank hypervisorVersion logger debug return defaultHostToExecuteCommands boolean isXenServer610 StringUtils equals hypervisorVersion if isXenServer610 logger debug return defaultHostToExecuteCommands
logger debug return defaultHostToExecuteCommands HostVO defaultHostToExecuteCommand hostDao findById hostId HostVO hostCandidateToExecutedCommand hostDao findHostInZoneToExecuteCommand defaultHostToExecuteCommand getDataCenterId srcData getHypervisorType hostDao loadDetails hostCandidateToExecutedCommand String hypervisorVersion hostCandidateToExecutedCommand getHypervisorVersion if StringUtils isBlank hypervisorVersion logger debug return defaultHostToExecuteCommands boolean isXenServer610 StringUtils equals hypervisorVersion if isXenServer610 logger debug return defaultHostToExecuteCommands String snapshotHotFixVersion hostCandidateToExecutedCommand getDetail XenserverConfigs XS620HotFix boolean isXenServer620 StringUtils equals hypervisorVersion
try Map Host Host Record hosts Host getAllRecords conn for Map Entry Host Host Record entry hosts entrySet Host Record re entry getValue if re address equalsIgnoreCase hostIp continue Set HostPatch patches re patches PoolPatch poolPatch PoolPatch getByUuid conn hotFixUuid for HostPatch patch patches PoolPatch pp patch getPoolPatch conn if pp null pp equals poolPatch patch getApplied conn s_logger debug hostIp hotFixUuid return true return false catch UuidInvalid e
for Map Entry Host Host Record entry hosts entrySet Host Record re entry getValue if re address equalsIgnoreCase hostIp continue Set HostPatch patches re patches PoolPatch poolPatch PoolPatch getByUuid conn hotFixUuid for HostPatch patch patches PoolPatch pp patch getPoolPatch conn if pp null pp equals poolPatch patch getApplied conn s_logger debug hostIp hotFixUuid return true return false catch UuidInvalid e s_logger debug hostIp hotFixUuid catch Exception e
Override public Map extends ServerResource Map String String find long dcId Long podId Long clusterId URI url String username String password List String hostTags throws DiscoveryException Map CitrixResourceBase Map String String resources new HashMap CitrixResourceBase Map String String Connection conn null if url getScheme equals String msg url
String msg s_logger debug msg throw new RuntimeException msg ClusterVO cluster _clusterDao findById clusterId if cluster null cluster getHypervisorType HypervisorType XenServer if s_logger isInfoEnabled s_logger info return null try String hostname url getHost InetAddress ia InetAddress getByName hostname String hostIp ia getHostAddress Queue String pass new LinkedList String pass add password conn _connPool getConnect hostIp username pass
s_logger warn msg throw new DiscoveryException msg else setClusterGuid clu poolUuid if conn null try Session logout conn catch Exception e s_logger debug e conn dispose conn null poolUuid clu getGuid _clusterDao update clusterId clu if _checkHvm for Map Entry Host Host Record entry hosts entrySet
s_logger debug e conn dispose conn null poolUuid clu getGuid _clusterDao update clusterId clu if _checkHvm for Map Entry Host Host Record entry hosts entrySet Host Record record entry getValue boolean support_hvm false for String capability record capabilities if capability contains support_hvm true break if support_hvm String msg record address
conn null poolUuid clu getGuid _clusterDao update clusterId clu if _checkHvm for Map Entry Host Host Record entry hosts entrySet Host Record record entry getValue boolean support_hvm false for String capability record capabilities if capability contains support_hvm true break if support_hvm String msg record address _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_HOST dcId podId msg msg s_logger debug msg
HostVO host _hostDao findById agentId ClusterVO cluster _clusterDao findById host getClusterId if cluster getGuid null cluster setGuid startup getPool _clusterDao update cluster getId cluster else if cluster getGuid equals startup getPool String msg cluster getId cluster getGuid startup getPool s_logger warn msg throw new CloudRuntimeException msg Map String String details startup getHostDetails String prodBrand details get trim String prodVersion details get trim String hotfix details get XenserverConfigs XS620HotFix String prodVersionTextShort details get String resource createServerResource prodBrand prodVersion prodVersionTextShort hotfix getClass getName
try for int i i params length i args put params i params i if s_logger isTraceEnabled s_logger trace cmd getArgsString args final Host host Host getByUuid conn _host getUuid final String result host callPlugin conn plugin cmd args if s_logger isTraceEnabled s_logger trace result return result replace catch final XenAPIException e msg cmd getArgsString args e toString s_logger warn msg catch final XmlRpcException e msg cmd getArgsString args e getMessage
final Host host Host getByUuid conn _host getUuid task host callPluginAsync conn plugin cmd args waitForTask conn task timeout checkForSuccess conn task final String result task getResult conn if s_logger isTraceEnabled s_logger trace result return result replace replace replace catch final Types HandleInvalid e s_logger warn cmd getArgsString args e clazz e handle catch final Exception e s_logger warn cmd getArgsString args e toString e finally if task null try
waitForTask conn task timeout checkForSuccess conn task final String result task getResult conn if s_logger isTraceEnabled s_logger trace result return result replace replace replace catch final Types HandleInvalid e s_logger warn cmd getArgsString args e clazz e handle catch final XenAPIException e s_logger warn cmd getArgsString args e toString e catch final Exception e s_logger warn cmd getArgsString args e getMessage e finally if task null try
private void CheckXenHostInfo throws ConfigurationException final Connection conn ConnPool getConnect _host getIp _username _password if conn null throw new ConfigurationException _host getIp try Host Record hostRec null try final Host host Host getByUuid conn _host getUuid hostRec host getRecord conn final Pool Record poolRec Pool getAllRecords conn values iterator next _host setPool poolRec uuid catch final Exception e throw new ConfigurationException _host getIp if hostRec address equals _host getIp final String msg _host getIp
protected VDI cloudVDIcopy final Connection conn final VDI vdi final SR sr int wait throws Exception Task task null if wait wait try task vdi copyAsync conn sr waitForTask conn task long wait checkForSuccess conn task final VDI dvdi Types toVDI task conn return dvdi finally if task null try task destroy conn catch final Exception e
final String msg vmName s_logger warn msg return msg catch final Exception e final String msg vmName e toString s_logger warn msg e return msg if s_logger isDebugEnabled s_logger debug ipAddress i _retry if pingdomr conn ipAddress Integer toString port return null try Thread sleep _sleep catch final InterruptedException e final String msg ipAddress
Override public ExecutionResult createFileInVR final String routerIp final String path final String filename final String content final Connection conn getConnection final String hostPath
protected SR createNfsSRbyURI final Connection conn final URI uri final boolean shared try if s_logger isDebugEnabled
deviceConfig put uri getHost deviceConfig put path final String name UUID nameUUIDFromBytes new String uri getHost path getBytes toString if shared final Set SR srs SR getByNameLabel conn name for final SR sr srs final SR Record record sr getRecord conn if SRType NFS equals record type record contentType equals record shared removeSRSync conn sr final Host host Host getByUuid conn _host getUuid final Map String String smConfig new HashMap String String smConfig put final SR sr SR create conn host deviceConfig new Long name uri getHost uri getPath SRType NFS toString shared smConfig if checkSR conn sr throw new Exception
else vbdr empty true if type Volume Type ROOT bootLoaderType BootloaderType PyGrub vbdr bootable true else if type Volume Type ISO bootLoaderType BootloaderType CD vbdr bootable true if volume getType Volume Type ISO vbdr mode Types VbdMode RO vbdr type Types VbdType CD vbdr userdevice String valueOf USER_DEVICE_START_ID isoCount else vbdr mode Types VbdMode RW vbdr type Types VbdType DISK vbdr unpluggable volume getType Volume Type ROOT false true vbdr userdevice
protected Network enableVlanNetwork final Connection conn final long tag final XsLocalNetwork network throws XenAPIException XmlRpcException Network vlanNetwork null final String oldName Long toString tag final String newName network getNetworkRecord conn uuid tag XsLocalNetwork vlanNic getNetworkByName conn newName if vlanNic null if s_logger isDebugEnabled
if vlanNic null if s_logger isDebugEnabled s_logger debug tag _host getIp final Network Record nwr new Network Record nwr nameLabel newName nwr tags new HashSet String nwr tags add generateTimeStamp vlanNetwork Network create conn nwr vlanNic getNetworkByName conn newName if vlanNic null throw new CloudRuntimeException newName final PIF nPif network getPif conn final PIF Record nPifr network getPifRecord conn vlanNetwork vlanNic getNetwork if vlanNic getPif conn null
nwr nameLabel newName nwr tags new HashSet String nwr tags add generateTimeStamp vlanNetwork Network create conn nwr vlanNic getNetworkByName conn newName if vlanNic null throw new CloudRuntimeException newName final PIF nPif network getPif conn final PIF Record nPifr network getPifRecord conn vlanNetwork vlanNic getNetwork if vlanNic getPif conn null return vlanNetwork if s_logger isDebugEnabled s_logger debug tag _host getIp nPifr device final VLAN vlan VLAN create conn nPif tag vlanNetwork
Override public ExecutionResult executeInVR final String routerIP final String script final String args final Duration timeout Pair Boolean String result String cmdline script routerIP args cmdline cmdline replaceAll try
if caps length caps delete caps length caps length cmd setCaps caps toString cmd setSpeed _host getSpeed cmd setCpuSockets _host getCpuSockets cmd setCpus _host getCpus final HostMetrics hm host getMetrics conn long ram long dom0Ram ram hm getMemoryTotal conn final Set VM vms host getResidentVMs conn for final VM vm vms if vm getIsControlDomain conn dom0Ram vm getMemoryStaticMax conn break
public synchronized Network findOrCreateTunnelNetwork final Connection conn final String nwName try Network nw null final Network Record rec new Network Record final Set Network networks Network getByNameLabel conn nwName if networks size rec nameDescription nwName rec nameLabel nwName final Map String String otherConfig new HashMap String String otherConfig put otherConfig put rec otherConfig otherConfig nw Network create conn rec
try Network nw null final Network Record rec new Network Record final Set Network networks Network getByNameLabel conn nwName if networks size rec nameDescription nwName rec nameLabel nwName final Map String String otherConfig new HashMap String String otherConfig put otherConfig put rec otherConfig otherConfig nw Network create conn rec s_logger debug nwName else nw networks iterator next
if publicNic null s_logger warn _publicNetworkName _host getIp throw new IllegalArgumentException _publicNetworkName _host getIp else publicNic guestNic _publicNetworkName _guestNetworkName _host setPublicPif publicNic getPifRecord conn uuid _host setPublicNetwork publicNic getNetworkRecord conn uuid if _storageNetworkName1 null _storageNetworkName1 _guestNetworkName XsLocalNetwork storageNic1 null storageNic1 getNetworkByName conn _storageNetworkName1 if storageNic1 null s_logger warn _storageNetworkName1 _host getIp throw new IllegalArgumentException _storageNetworkName1 _host getIp
if publicNic null s_logger warn _publicNetworkName _host getIp throw new IllegalArgumentException _publicNetworkName _host getIp else publicNic guestNic _publicNetworkName _guestNetworkName _host setPublicPif publicNic getPifRecord conn uuid _host setPublicNetwork publicNic getNetworkRecord conn uuid if _storageNetworkName1 null _storageNetworkName1 _guestNetworkName XsLocalNetwork storageNic1 null storageNic1 getNetworkByName conn _storageNetworkName1 if storageNic1 null s_logger warn _storageNetworkName1 _host getIp throw new IllegalArgumentException _storageNetworkName1 _host getIp
s_logger warn _publicNetworkName _host getIp throw new IllegalArgumentException _publicNetworkName _host getIp else publicNic guestNic _publicNetworkName _guestNetworkName _host setPublicPif publicNic getPifRecord conn uuid _host setPublicNetwork publicNic getNetworkRecord conn uuid if _storageNetworkName1 null _storageNetworkName1 _guestNetworkName XsLocalNetwork storageNic1 null storageNic1 getNetworkByName conn _storageNetworkName1 if storageNic1 null s_logger warn _storageNetworkName1 _host getIp throw new IllegalArgumentException _storageNetworkName1 _host getIp else
throw new IllegalArgumentException _publicNetworkName _host getIp else publicNic guestNic _publicNetworkName _guestNetworkName _host setPublicPif publicNic getPifRecord conn uuid _host setPublicNetwork publicNic getNetworkRecord conn uuid if _storageNetworkName1 null _storageNetworkName1 _guestNetworkName XsLocalNetwork storageNic1 null storageNic1 getNetworkByName conn _storageNetworkName1 if storageNic1 null s_logger warn _storageNetworkName1 _host getIp throw new IllegalArgumentException _storageNetworkName1 _host getIp else _host setStorageNetwork1 storageNic1 getNetworkRecord conn uuid
s_logger warn e try Thread sleep catch final InterruptedException ex if vm_map null return vmStates for final VM Record record vm_map values if record isControlDomain record isASnapshot record isATemplate continue final VmPowerState ps record powerState final Host host record residentOn String host_uuid null if isRefNull host try host_uuid host getUuid conn
try Thread sleep catch final InterruptedException ex if vm_map null return vmStates for final VM Record record vm_map values if record isControlDomain record isASnapshot record isATemplate continue final VmPowerState ps record powerState final Host host record residentOn String host_uuid null if isRefNull host try host_uuid host getUuid conn catch final BadServerResponse e
catch final InterruptedException ex if vm_map null return vmStates for final VM Record record vm_map values if record isControlDomain record isASnapshot record isATemplate continue final VmPowerState ps record powerState final Host host record residentOn String host_uuid null if isRefNull host try host_uuid host getUuid conn catch final BadServerResponse e s_logger error host toWireString e catch final XenAPIException e
vmName vm getNameLabel conn final List Integer usedDeviceNums new ArrayList Integer final Set VIF vifs vm getVIFs conn final Iterator VIF vifIter vifs iterator while vifIter hasNext final VIF vif vifIter next try final String deviceId vif getDevice conn if vm getIsControlDomain conn vif getCurrentlyAttached conn usedDeviceNums add Integer valueOf deviceId else s_logger debug deviceId vmName vif destroy conn catch final NumberFormatException e final String msg vmName
while vifIter hasNext final VIF vif vifIter next try final String deviceId vif getDevice conn if vm getIsControlDomain conn vif getCurrentlyAttached conn usedDeviceNums add Integer valueOf deviceId else s_logger debug deviceId vmName vif destroy conn catch final NumberFormatException e final String msg vmName s_logger debug msg e throw new CloudRuntimeException msg for Integer i i _maxNics i if usedDeviceNums contains i
public XsLocalNetwork getNativeNetworkForTraffic final Connection conn final TrafficType type final String name throws XenAPIException XmlRpcException if name null if s_logger isDebugEnabled
public String getVhdParent final Connection conn final String primaryStorageSRUuid final String snapshotUuid final Boolean isISCSI final String parentUuid callHostPlugin conn primaryStorageSRUuid snapshotUuid isISCSI toString if parentUuid null parentUuid isEmpty parentUuid equalsIgnoreCase
if dataDisk null final String dataDiskName dataDisk getNameLabel conn if dataDiskName null dataDiskName isEmpty volumeTo setName dataDiskName final Set VDI allvolumeVDIs VDI getByNameLabel conn volumeTo getName long size for final VDI vdi allvolumeVDIs try if vdi getIsASnapshot conn vdi getSmConfig conn get null final String parentUuid vdi getSmConfig conn get final VDI parentVDI VDI getByUuid conn parentUuid size size vdi getPhysicalUtilisation conn if isRefNull parentVDI size size parentVDI getPhysicalUtilisation conn longValue catch final Exception e
size size parentVDI getPhysicalUtilisation conn longValue catch final Exception e s_logger debug e toString continue if volumeTo getVolumeType Volume Type ROOT VM vm getVM conn vmName if vm null Set VM vmSnapshots vm getSnapshots conn if vmSnapshots null for VM vmsnap vmSnapshots try final String vmSnapName vmsnap getNameLabel conn s_logger debug vmSnapName if vmSnapName null vmSnapName contains vmSnapshotName vmsnap getIsASnapshot conn s_logger debug vmSnapName
continue if volumeTo getVolumeType Volume Type ROOT VM vm getVM conn vmName if vm null Set VM vmSnapshots vm getSnapshots conn if vmSnapshots null for VM vmsnap vmSnapshots try final String vmSnapName vmsnap getNameLabel conn s_logger debug vmSnapName if vmSnapName null vmSnapName contains vmSnapshotName vmsnap getIsASnapshot conn s_logger debug vmSnapName VDI memoryVDI vmsnap getSuspendVDI conn if isRefNull memoryVDI size size memoryVDI getPhysicalUtilisation conn
else if param matches vmStatsAnswer setNetworkReadKBs vmStatsAnswer getNetworkReadKBs getDataAverage dataNode col numRows BASE_TO_CONVERT_BYTES_INTO_KILOBYTES else if param matches vmStatsAnswer setNetworkWriteKBs vmStatsAnswer getNetworkWriteKBs getDataAverage dataNode col numRows BASE_TO_CONVERT_BYTES_INTO_KILOBYTES else if param matches vmStatsAnswer setDiskReadKBs vmStatsAnswer getDiskReadKBs getDataAverage dataNode col numRows BASE_TO_CONVERT_BYTES_INTO_KILOBYTES else if param matches vmStatsAnswer setDiskWriteKBs vmStatsAnswer getDiskWriteKBs getDataAverage dataNode col numRows BASE_TO_CONVERT_BYTES_INTO_KILOBYTES else if param contains vmStatsAnswer setIntFreeMemoryKBs vmStatsAnswer getIntFreeMemoryKBs getDataAverage dataNode col numRows BASE_TO_CONVERT_BYTES_INTO_KILOBYTES else if param contains vmStatsAnswer setTargetMemoryKBs vmStatsAnswer getTargetMemoryKBs getDataAverage dataNode col numRows BASE_TO_CONVERT_BYTES_INTO_KILOBYTES else if param contains vmStatsAnswer setMemoryKBs vmStatsAnswer getMemoryKBs getDataAverage dataNode col numRows BASE_TO_CONVERT_BYTES_INTO_KILOBYTES for final Map Entry String VmStatsEntry entry vmResponseMap entrySet
if MapUtils isEmpty allSrRecords return localSrs for Map Entry SR SR Record entry allSrRecords entrySet SR Record srRec entry getValue if srType equals srRec type continue if BooleanUtils toBoolean srRec shared continue Set PBD pbds srRec PBDs if CollectionUtils isEmpty pbds continue for PBD pbd pbds Host host pbd getHost conn if isRefNull host org apache commons lang3 StringUtils equals host getUuid conn _host getUuid if pbd getCurrentlyAttached conn
for Map Entry SR SR Record entry allSrRecords entrySet SR Record srRec entry getValue if srType equals srRec type continue if BooleanUtils toBoolean srRec shared continue Set PBD pbds srRec PBDs if CollectionUtils isEmpty pbds continue for PBD pbd pbds Host host pbd getHost conn if isRefNull host org apache commons lang3 StringUtils equals host getUuid conn _host getUuid if pbd getCurrentlyAttached conn s_logger debug String format pbd getUuid conn srRec uuid pbd plug conn
if BooleanUtils toBoolean srRec shared continue Set PBD pbds srRec PBDs if CollectionUtils isEmpty pbds continue for PBD pbd pbds Host host pbd getHost conn if isRefNull host org apache commons lang3 StringUtils equals host getUuid conn _host getUuid if pbd getCurrentlyAttached conn s_logger debug String format pbd getUuid conn srRec uuid pbd plug conn s_logger debug srRec uuid SR sr entry getKey sr scan conn localSrs add sr
public boolean isNetworkSetupByName final String nameTag throws XenAPIException XmlRpcException if nameTag null if s_logger isDebugEnabled
checkForSuccess conn task catch final Types HandleInvalid e if vm getResidentOn conn equals destHost task null return throw new CloudRuntimeException catch final XenAPIException e final String msg vmName _host getUuid s_logger warn msg e throw new CloudRuntimeException msg finally if task null try task destroy conn catch final Exception e1
protected Pair Long Integer parseTimestamp final String timeStampStr final String tokens timeStampStr split if tokens length
private void pbdPlug final Connection conn final PBD pbd final String uuid try if s_logger isDebugEnabled
public boolean pingXAPI final Connection conn getConnection try final Host host Host getByUuid conn _host getUuid if host getEnabled conn
protected ExecutionResult prepareNetworkElementCommand final SetNetworkACLCommand cmd final Connection conn getConnection final String routerName cmd getAccessDetail NetworkElementCommand ROUTER_NAME try final VM router getVM conn routerName final NicTO nic cmd getNic if nic null final VIF vif getVifByMac conn router nic getMac if vif null final String msg nic getMac routerName
protected ExecutionResult prepareNetworkElementCommand final SetNetworkACLCommand cmd final Connection conn getConnection final String routerName cmd getAccessDetail NetworkElementCommand ROUTER_NAME try final VM router getVM conn routerName final NicTO nic cmd getNic if nic null final VIF vif getVifByMac conn router nic getMac if vif null final String msg nic getMac routerName s_logger error msg return new ExecutionResult false msg nic setDeviceId Integer parseInt vif getDevice conn else final String msg routerName
final VM router getVM conn routerName final NicTO nic cmd getNic if nic null final VIF vif getVifByMac conn router nic getMac if vif null final String msg nic getMac routerName s_logger error msg return new ExecutionResult false msg nic setDeviceId Integer parseInt vif getDevice conn else final String msg routerName s_logger error msg return new ExecutionResult false msg catch final Exception e final String msg e toString
task null return throw new CloudRuntimeException catch final XenAPIException e s_logger debug vmName _host getUuid e toString try vm hardReboot conn catch final Exception e1 final String msg vmName _host getUuid e toString s_logger warn msg e1 throw new CloudRuntimeException msg finally if task null try task destroy conn
if s_logger isDebugEnabled s_logger debug logX sr for int i i i try final Set VDI vdis sr getVDIs conn for final VDI vdi vdis vdi forget conn Set PBD pbds sr getPBDs conn for final PBD pbd pbds if s_logger isDebugEnabled s_logger debug logX pbd pbd unplug conn pbd destroy conn pbds sr getPBDs conn if pbds size
try final Set VDI vdis sr getVDIs conn for final VDI vdi vdis vdi forget conn Set PBD pbds sr getPBDs conn for final PBD pbd pbds if s_logger isDebugEnabled s_logger debug logX pbd pbd unplug conn pbd destroy conn pbds sr getPBDs conn if pbds size if s_logger isDebugEnabled s_logger debug logX sr sr forget conn
Set PBD pbds sr getPBDs conn for final PBD pbd pbds if s_logger isDebugEnabled s_logger debug logX pbd pbd unplug conn pbd destroy conn pbds sr getPBDs conn if pbds size if s_logger isDebugEnabled s_logger debug logX sr sr forget conn return if s_logger isDebugEnabled s_logger debug logX sr if s_logger isTraceEnabled
if s_logger isDebugEnabled s_logger debug logX pbd pbd unplug conn pbd destroy conn pbds sr getPBDs conn if pbds size if s_logger isDebugEnabled s_logger debug logX sr sr forget conn return if s_logger isDebugEnabled s_logger debug logX sr if s_logger isTraceEnabled for final PBD pbd pbds s_logger trace logX pbd
try if _host getVswitchNetwork null Network vswitchNw null final Network Record rec new Network Record final String nwName Networks BroadcastScheme VSwitch toString final Set Network networks Network getByNameLabel conn nwName if networks size rec nameDescription nwName rec nameLabel nwName vswitchNw Network create conn rec else vswitchNw networks iterator next _host setVswitchNetwork vswitchNw return _host getVswitchNetwork catch final BadServerResponse e
Network vswitchNw null final Network Record rec new Network Record final String nwName Networks BroadcastScheme VSwitch toString final Set Network networks Network getByNameLabel conn nwName if networks size rec nameDescription nwName rec nameLabel nwName vswitchNw Network create conn rec else vswitchNw networks iterator next _host setVswitchNetwork vswitchNw return _host getVswitchNetwork catch final BadServerResponse e s_logger error e catch final XenAPIException e
final String nwName Networks BroadcastScheme VSwitch toString final Set Network networks Network getByNameLabel conn nwName if networks size rec nameDescription nwName rec nameLabel nwName vswitchNw Network create conn rec else vswitchNw networks iterator next _host setVswitchNetwork vswitchNw return _host getVswitchNetwork catch final BadServerResponse e s_logger error e catch final XenAPIException e s_logger error e catch final XmlRpcException e
Task task null try if forcedStop task vm hardShutdownAsync conn else task vm cleanShutdownAsync conn try waitForTask conn task checkForSuccess conn task catch final TimeoutException e if vm getPowerState conn VmPowerState HALTED task null return throw new CloudRuntimeException catch final XenAPIException e
try waitForTask conn task checkForSuccess conn task catch final TimeoutException e if vm getPowerState conn VmPowerState HALTED task null return throw new CloudRuntimeException catch final XenAPIException e s_logger debug vmName forcedStop _host getUuid e toString try VmPowerState state vm getPowerState conn if state VmPowerState RUNNING try vm hardShutdown conn
catch final Exception e1 s_logger debug vmName _host getUuid e toString state vm getPowerState conn if state VmPowerState RUNNING forceShutdownVM conn vm return else if state VmPowerState HALTED return else final String msg state toString s_logger warn msg throw new CloudRuntimeException msg catch final Exception e1 final String msg vmName _host getUuid e toString s_logger warn msg e1
public void startVM final Connection conn final Host host final VM vm final String vmName throws Exception Task task null try task vm startOnAsync conn host false true try waitForTask conn task checkForSuccess conn task catch final Types HandleInvalid e if vm getPowerState conn VmPowerState RUNNING s_logger debug vmName e task null return throw new CloudRuntimeException vmName catch final TimeoutException e if vm getPowerState conn VmPowerState RUNNING
throw new CloudRuntimeException vmName catch final TimeoutException e if vm getPowerState conn VmPowerState RUNNING s_logger debug vmName e task null return throw new CloudRuntimeException vmName catch final XenAPIException e final String msg vmName _host getUuid e toString s_logger warn msg e throw new CloudRuntimeException msg finally if task null try task destroy conn
public boolean transferManagementNetwork final Connection conn final Host host final PIF src final PIF Record spr final PIF dest throws XmlRpcException XenAPIException dest reconfigureIp conn spr ipConfigurationMode spr IP spr netmask spr gateway spr DNS Host managementReconfigure conn dest String hostUuid null int count while count try Thread sleep hostUuid host getUuid conn if hostUuid null break count catch final XmlRpcException e s_logger debug e getMessage catch final XenAPIException e
final String dataType item final String fileName item final String content item if dataType null dataType isEmpty final String folder isoPath configDriveName dataType if folder null folder isEmpty final File dir new File folder final boolean result true try if dir exists dir mkdirs catch final SecurityException ex s_logger debug ex getMessage return false if result content null content isEmpty
final String content item if dataType null dataType isEmpty final String folder isoPath configDriveName dataType if folder null folder isEmpty final File dir new File folder final boolean result true try if dir exists dir mkdirs catch final SecurityException ex s_logger debug ex getMessage return false if result content null content isEmpty File file new File folder fileName try OutputStreamWriter fw new OutputStreamWriter new FileOutputStream file getAbsoluteFile BufferedWriter bw new BufferedWriter fw
catch final SecurityException ex s_logger debug ex getMessage return false if result content null content isEmpty File file new File folder fileName try OutputStreamWriter fw new OutputStreamWriter new FileOutputStream file getAbsoluteFile BufferedWriter bw new BufferedWriter fw bw write content s_logger debug file folder catch final IOException ex s_logger debug ex getMessage return false s_logger debug isoPath String s null try final String cmd configDriveLabel isoPath vmName isoPath
s_logger debug ex getMessage return false if result content null content isEmpty File file new File folder fileName try OutputStreamWriter fw new OutputStreamWriter new FileOutputStream file getAbsoluteFile BufferedWriter bw new BufferedWriter fw bw write content s_logger debug file folder catch final IOException ex s_logger debug ex getMessage return false s_logger debug isoPath String s null try final String cmd configDriveLabel isoPath vmName isoPath final Process p Runtime getRuntime exec cmd
if result content null content isEmpty File file new File folder fileName try OutputStreamWriter fw new OutputStreamWriter new FileOutputStream file getAbsoluteFile BufferedWriter bw new BufferedWriter fw bw write content s_logger debug file folder catch final IOException ex s_logger debug ex getMessage return false s_logger debug isoPath String s null try final String cmd configDriveLabel isoPath vmName isoPath final Process p Runtime getRuntime exec cmd final BufferedReader stdInput new BufferedReader new InputStreamReader p getInputStream Charset defaultCharset final BufferedReader stdError new BufferedReader new InputStreamReader p getErrorStream Charset defaultCharset
final com trilead ssh2 Connection sshConnection new com trilead ssh2 Connection _host getIp try sshConnection connect null if sshConnection authenticateWithPassword _username _password peek throw new CloudRuntimeException s_logger debug vmIso _host getIp _configDriveIsopath final SCPClient scp new SCPClient sshConnection final String p scp put vmIso _configDriveIsopath p sr scan conn s_logger debug _host catch final IOException e s_logger debug vmIso _host e return false catch final XmlRpcException e
final SCPClient scp new SCPClient sshConnection final String p scp put vmIso _configDriveIsopath p sr scan conn s_logger debug _host catch final IOException e s_logger debug vmIso _host e return false catch final XmlRpcException e s_logger debug _configDriveSRName _host getIp _host e return false finally sshConnection close final String configDir vmName try
scp put vmIso _configDriveIsopath p sr scan conn s_logger debug _host catch final IOException e s_logger debug vmIso _host e return false catch final XmlRpcException e s_logger debug _configDriveSRName _host getIp _host e return false finally sshConnection close final String configDir vmName try deleteLocalFolder configDir s_logger debug configDir
VBD isoVBD null final Set VBD vbds vm getVBDs conn for final VBD vbd vbds final Types VbdType type vbd getType conn final VBD Record vbdr vbd getRecord conn if vbdr userdevice equals _attachIsoDeviceNum type Types VbdType CD isoVBD vbd break if isoVBD null final VBD Record cfgDriveVbdr new VBD Record cfgDriveVbdr VM vm cfgDriveVbdr empty true cfgDriveVbdr bootable false cfgDriveVbdr userdevice cfgDriveVbdr mode Types VbdMode RO
final String cmd _configDriveIsopath if SSHCmdHelper sshExecuteCmd sshConnection cmd throw new CloudRuntimeException catch final IOException e throw new CloudRuntimeException e finally sshConnection close s_logger debug srName _configDriveIsopath deviceConfig put _configDriveIsopath deviceConfig put final Host host Host getByUuid conn _host getUuid final String type SRType ISO toString sr SR create conn host deviceConfig new Long _configDriveIsopath type false new HashMap String String sr setNameLabel conn srName sr setNameDescription conn deviceConfig get
public void deleteLocalFolder final String directory throws Exception if directory null directory isEmpty final String msg
public boolean attachConfigDriveToMigratedVm Connection conn String vmName String ipAddr try
public boolean attachConfigDriveToMigratedVm Connection conn String vmName String ipAddr try s_logger debug vmName ipAddr Set VM vms VM getByNameLabel conn vmName SR sr getSRByNameLabel conn vmName VM_NAME_ISO_SUFFIX Set VDI vdis VDI getByNameLabel conn vmName VM_FILE_ISO_SUFFIX if vdis isEmpty
try s_logger debug vmName ipAddr Set VM vms VM getByNameLabel conn vmName SR sr getSRByNameLabel conn vmName VM_NAME_ISO_SUFFIX Set VDI vdis VDI getByNameLabel conn vmName VM_FILE_ISO_SUFFIX if vdis isEmpty s_logger debug vmName return false VDI configdriveVdi null for VDI vdi vdis SR vdiSr vdi getSR conn if vdiSr getUuid conn equals sr getUuid conn configdriveVdi vdi s_logger debug vdi else
s_logger debug vdi else s_logger debug vdi vdi destroy conn if configdriveVdi null s_logger debug return false for VM vm vms VBD Record cfgDriveVbdr new VBD Record cfgDriveVbdr VM vm cfgDriveVbdr empty true cfgDriveVbdr bootable false cfgDriveVbdr userdevice cfgDriveVbdr mode Types VbdMode RO cfgDriveVbdr type Types VbdType CD
String mountPoint mountNfs conn secondaryStorageMountPath localDir if org apache commons lang StringUtils isBlank mountPoint return new CopyToSecondaryStorageAnswer cmd false secondaryStorageMountPath localDir String dataDirectoryInSecondaryStore localDir File separator DiagnosticsService DIAGNOSTICS_DIRECTORY final CopyToSecondaryStorageAnswer answer final String scpResult callHostPlugin conn dataDirectoryInSecondaryStore vmIP cmd getFileName toLowerCase if scpResult contains answer new CopyToSecondaryStorageAnswer cmd true else answer new CopyToSecondaryStorageAnswer cmd false diagnosticsZipFile replace scpResult umountNfs conn secondaryStorageMountPath localDir localDir null return answer catch Exception e String msg secondaryStorageUrl e
Override protected void setMemory final Connection conn final VM vm final long minMemsize final long maxMemsize throws XmlRpcException XenAPIException if s_logger isDebugEnabled
for final VBD vbd vbds final VBD Record vbdr vbd getRecord connection if vbdr type Types VbdType DISK final VDI vdi vbdr VDI deviceIdToVdiMap put vbdr userdevice vdi for final DiskTO volumeTo volumes if volumeTo getType Volume Type ISO final VolumeObjectTO vol VolumeObjectTO volumeTo getData final Long deviceId volumeTo getDiskSeq final VDI vdi deviceIdToVdiMap get deviceId toString final VolumeObjectTO newVol new VolumeObjectTO newVol setPath vdi getUuid connection newVol setId vol getId volumeToList add newVol catch final Exception e
private void addConnect String poolUuid XenServerConnection conn if poolUuid null return if s_logger isDebugEnabled
public Connection getConnect String ip String username Queue String password Connection conn new Connection getURL ip _connWait try loginWithPassword conn username password APIVersion latest toString catch Types HostIsSlave e String maddress e masterIPAddress conn new Connection getURL maddress _connWait try loginWithPassword conn username password APIVersion latest toString catch Exception e1 String msg maddress e1 toString s_logger debug msg throw new CloudRuntimeException msg e1 catch Exception e String msg ip e toString
public Connection connect String hostUuid String poolUuid String ipAddress String username Queue String password int wait XenServerConnection mConn null if hostUuid null poolUuid null ipAddress null username null password null String msg hostUuid poolUuid ipAddress
mConn getConnect poolUuid if mConn null try Host host Host getByUuid mConn hostUuid if host getEnabled mConn String msg ipAddress s_logger debug msg if mConn getIp equalsIgnoreCase ipAddress removeConnect poolUuid mConn null throw new CloudRuntimeException msg return mConn catch CloudRuntimeException e throw e catch Exception e
return mConn catch CloudRuntimeException e throw e catch Exception e if s_logger isDebugEnabled s_logger debug mConn getIp poolUuid e toString removeConnect poolUuid mConn null if mConn null try Connection conn new Connection getURL ipAddress _connWait Session sess loginWithPassword conn username password APIVersion latest toString Host host sess getThisHost conn Boolean hostenabled host getEnabled conn if sess null
Session sess loginWithPassword conn username password APIVersion latest toString Host host sess getThisHost conn Boolean hostenabled host getEnabled conn if sess null try Session logout conn catch Exception e s_logger debug e conn dispose if hostenabled String msg ipAddress s_logger debug msg throw new CloudRuntimeException msg mConn new XenServerConnection getURL ipAddress ipAddress username password _retries _interval wait _connWait loginWithPassword mConn username password APIVersion latest toString
try Session logout conn catch Exception e s_logger debug e conn dispose if hostenabled String msg ipAddress s_logger debug msg throw new CloudRuntimeException msg mConn new XenServerConnection getURL ipAddress ipAddress username password _retries _interval wait _connWait loginWithPassword mConn username password APIVersion latest toString catch Types HostIsSlave e String maddress e masterIPAddress mConn new XenServerConnection getURL maddress maddress username password _retries _interval wait _connWait try
conn dispose if hostenabled String msg ipAddress s_logger debug msg throw new CloudRuntimeException msg mConn new XenServerConnection getURL ipAddress ipAddress username password _retries _interval wait _connWait loginWithPassword mConn username password APIVersion latest toString catch Types HostIsSlave e String maddress e masterIPAddress mConn new XenServerConnection getURL maddress maddress username password _retries _interval wait _connWait try Session session loginWithPassword mConn username password APIVersion latest toString Host host session getThisHost mConn if host getEnabled mConn String msg maddress
snapshot setNameLabel conn snapshotName snapshotUUID snapshot getUuid conn final String preSnapshotUUID snapshotTO getParentSnapshotPath if preSnapshotUUID null final SR sr volume getSR conn final String srUUID sr getUuid conn final String type sr getType conn final Boolean isISCSI IsISCSI type final String snapshotParentUUID getVhdParent conn srUUID snapshotUUID isISCSI try final String preSnapshotParentUUID getVhdParent conn srUUID preSnapshotUUID isISCSI if snapshotParentUUID null snapshotParentUUID equals preSnapshotParentUUID snapshot destroy conn snapshotUUID preSnapshotUUID catch final Exception e
final Connection conn hypervisorResource getConnection String errorMsg null try final VDI vdi VDI getByUuid conn volume getPath for VDI svdi vdi getSnapshots conn deleteVDI conn svdi deleteVDI conn vdi return new Answer null catch final BadServerResponse e s_logger debug e errorMsg e toString catch final XenAPIException e s_logger debug e errorMsg e toString catch final XmlRpcException e
protected String getVhdParent final Connection conn final String primaryStorageSRUuid final String snapshotUuid final Boolean isISCSI final String parentUuid hypervisorResource callHostPlugin conn primaryStorageSRUuid snapshotUuid isISCSI toString if parentUuid null parentUuid isEmpty parentUuid equalsIgnoreCase
final SR poolSr hypervisorResource getStorageRepository conn data getDataStore getUuid VDI Record vdir new VDI Record vdir nameLabel volume getName vdir SR poolSr vdir type Types VdiType USER vdir virtualSize volume getSize VDI vdi vdi VDI create conn vdir vdir vdi getRecord conn final VolumeObjectTO newVol new VolumeObjectTO newVol setName vdir nameLabel newVol setSize vdir virtualSize newVol setPath vdir uuid return new CreateObjectAnswer newVol catch final Exception e
Override public Answer cloneVolumeFromBaseTemplate final CopyCommand cmd final Connection conn hypervisorResource getConnection final DataTO srcData cmd getSrcTO final DataTO destData cmd getDestTO final VolumeObjectTO volume VolumeObjectTO destData VDI vdi null try VDI tmpltvdi null tmpltvdi getVDIbyUuid conn srcData getPath vdi tmpltvdi createClone conn new HashMap String String Long virtualSize vdi getVirtualSize conn if volume getSize virtualSize
Override public Answer cloneVolumeFromBaseTemplate final CopyCommand cmd final Connection conn hypervisorResource getConnection final DataTO srcData cmd getSrcTO final DataTO destData cmd getDestTO final VolumeObjectTO volume VolumeObjectTO destData VDI vdi null try VDI tmpltvdi null tmpltvdi getVDIbyUuid conn srcData getPath vdi tmpltvdi createClone conn new HashMap String String Long virtualSize vdi getVirtualSize conn if volume getSize virtualSize s_logger debug toHumanReadableSize volume getSize volume getName vdi resize conn volume getSize else
final VolumeObjectTO volume VolumeObjectTO destData VDI vdi null try VDI tmpltvdi null tmpltvdi getVDIbyUuid conn srcData getPath vdi tmpltvdi createClone conn new HashMap String String Long virtualSize vdi getVirtualSize conn if volume getSize virtualSize s_logger debug toHumanReadableSize volume getSize volume getName vdi resize conn volume getSize else s_logger debug toHumanReadableSize virtualSize volume getName toHumanReadableSize volume getSize vdi setNameLabel conn volume getName VDI Record vdir vdir vdi getRecord conn
SR secondaryStorage null try final NfsTO nfsStore NfsTO destStore final URI uri new URI nfsStore getUrl if hypervisorResource createSecondaryStorageFolder conn uri getHost uri getPath destVolume getPath throw new InternalErrorException secondaryStorage hypervisorResource createNfsSRbyURI conn new URI nfsStore getUrl nfsStore getPathSeparator destVolume getPath false final VDI srcVdi getVDIbyUuid conn srcVolume getPath final VDI destVdi hypervisorResource cloudVDIcopy conn srcVdi secondaryStorage wait final String destVolumeUUID destVdi getUuid conn final VolumeObjectTO newVol new VolumeObjectTO newVol setPath destVolume getPath nfsStore getPathSeparator destVolumeUUID newVol setSize srcVolume getSize return new CopyCmdAnswer newVol catch final Exception e
VDI avoidSnapshot getVDIbyUuid conn avoidSnapshotUuid if avoidSnapshot null throw new InternalErrorException avoidSnapshotUuid final Set VDI snapshots volume getSnapshots conn for final VDI snapshot snapshots try if snapshot getUuid conn equals avoidSnapshotUuid snapshot getSnapshotTime conn before avoidSnapshot getSnapshotTime conn snapshot getVBDs conn isEmpty snapshot destroy conn catch final Exception e final String msg snapshot e toString s_logger warn msg e s_logger debug volumeUuid avoidSnapshotUuid return true catch final XenAPIException e final String msg volumeUuid avoidSnapshotUuid e toString
snapshotSr hypervisorResource createNfsSRbyURI conn new URI snapshotMountpoint false final VDI backedVdi hypervisorResource cloudVDIcopy conn snapshotVdi snapshotSr wait snapshotBackupUuid backedVdi getUuid conn final String primarySRuuid snapshotSr getUuid conn physicalSize getSnapshotSize conn primarySRuuid snapshotBackupUuid isISCSI wait if destStore SwiftTO try final String container snapshotTO getVolume getVolumeId toString final String destSnapshotName swiftBackupSnapshot conn SwiftTO destStore snapshotSr getUuid conn snapshotBackupUuid container false wait final String swiftPath container File separator destSnapshotName finalPath swiftPath finally try deleteSnapshotBackup conn localMountPoint folder secondaryStorageMountPath snapshotBackupUuid catch final Exception e
installPath installPath tmpltFilename hypervisorResource removeSR conn tmpltSR tmpltSR null final TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath installPath newTemplate setFormat ImageFormat VHD newTemplate setSize virtualSize newTemplate setPhysicalSize physicalSize newTemplate setName tmpltUUID final CopyCmdAnswer answer new CopyCmdAnswer newTemplate return answer catch final Exception e if tmpltSR null hypervisorResource removeSR conn tmpltSR if secondaryStorageMountPath null
if snapshotName startsWith snapshotName endsWith snapshotInstallPath snapshotInstallPath URI snapshotURI new URI secondaryStorageUrl nfsImageStore getPathSeparator snapshotInstallPath String snapshotPath snapshotURI getHost snapshotURI getPath String srUuid primaryStorageSR getUuid conn volumeUUID copy_vhd_from_secondarystorage conn snapshotPath srUuid wait result true VDI volume VDI getByUuid conn volumeUUID VDI Record vdir volume getRecord conn VolumeObjectTO newVol new VolumeObjectTO newVol setPath volumeUUID newVol setSize vdir virtualSize return new CopyCmdAnswer newVol catch final XenAPIException e details e toString
Override public Answer deleteSnapshot final DeleteCommand cmd final SnapshotObjectTO snapshot SnapshotObjectTO cmd getData final DataStoreTO store snapshot getDataStore if store getRole DataStoreRole Primary final Connection conn hypervisorResource getConnection final VDI snapshotVdi getVDIbyUuid conn snapshot getPath if snapshotVdi null return new Answer null String errMsg null try deleteVDI conn snapshotVdi catch final BadServerResponse e s_logger debug e toString errMsg e toString catch final XenAPIException e
if store getRole DataStoreRole Primary final Connection conn hypervisorResource getConnection final VDI snapshotVdi getVDIbyUuid conn snapshot getPath if snapshotVdi null return new Answer null String errMsg null try deleteVDI conn snapshotVdi catch final BadServerResponse e s_logger debug e toString errMsg e toString catch final XenAPIException e s_logger debug e toString errMsg e toString catch final XmlRpcException e
protected SR createNewFileSr Connection conn String srPath String hostUuid hypervisorResource getHost getUuid
sr SR introduce conn srUuid srPath srPath false smConfig PBD Record record new PBD Record record host host record SR sr smConfig put srPath record deviceConfig smConfig pbd PBD create conn record pbd plug conn sr scan conn return sr catch XenAPIException XmlRpcException e if e Types InternalError String expectedDuplicatedFileSrErrorMessage Types InternalError internalErrorException Types InternalError e if StringUtils contains internalErrorException message expectedDuplicatedFileSrErrorMessage
record SR sr smConfig put srPath record deviceConfig smConfig pbd PBD create conn record pbd plug conn sr scan conn return sr catch XenAPIException XmlRpcException e if e Types InternalError String expectedDuplicatedFileSrErrorMessage Types InternalError internalErrorException Types InternalError e if StringUtils contains internalErrorException message expectedDuplicatedFileSrErrorMessage s_logger debug String format srPath return retrieveAlreadyConfiguredSrWithoutException conn srPath removeSrAndPbdIfPossible conn sr pbd
protected SR retrieveAlreadyConfiguredSr Connection conn String path throws XenAPIException XmlRpcException Set SR srs SR getByNameLabel conn path if CollectionUtils isEmpty srs
Set SR srs SR getByNameLabel conn path if CollectionUtils isEmpty srs s_logger debug path return null if srs size throw new CloudRuntimeException path SR sr srs iterator next String srUuid sr getUuid conn s_logger debug String format srUuid Map String StorageOperations currentOperations sr getCurrentOperations conn if MapUtils isEmpty currentOperations s_logger debug String format srUuid try sr scan conn catch XenAPIException XmlRpcException e
protected void forgetSr Connection conn SR sr String srUuid StringUtils EMPTY try srUuid sr getUuid conn Set PBD pbDs sr getPBDs conn for PBD pbd pbDs
final VDI snapshotVdi tmplVdi snapshot conn new HashMap String String uuidToReturn snapshotVdi getUuid conn snapshotVdi setNameLabel conn srcTemplate getName tmplVdi destroy conn destSr scan conn try Thread sleep catch final Exception e final TemplateObjectTO newVol new TemplateObjectTO newVol setUuid uuidToReturn newVol setPath uuidToReturn if physicalSize null newVol setSize physicalSize newVol setFormat Storage ImageFormat VHD return new CopyCmdAnswer newVol
ssSR scan conn finally if task null try task destroy conn catch final Exception e s_logger warn task toWireString e toString final String result dvdi getUuid conn concat concat dvdi getPhysicalUtilisation conn toString return result catch final Exception e final String msg e toString s_logger debug msg throw new CloudRuntimeException msg e finally try
Override protected String getVhdParent final Connection conn final String primaryStorageSRUuid final String snapshotUuid final Boolean isISCSI final String parentUuid hypervisorResource callHostPlugin conn primaryStorageSRUuid snapshotUuid isISCSI toString if parentUuid null parentUuid isEmpty parentUuid equalsIgnoreCase
snapshotSr scan conn physicalSize backedVdi getPhysicalUtilisation conn if destStore SwiftTO try final String container snapshotTO getVolume getVolumeId toString final String destSnapshotName swiftBackupSnapshot conn SwiftTO destStore snapshotSr getUuid conn snapshotBackupUuid container false wait final String swiftPath container File separator destSnapshotName finalPath swiftPath finally try deleteSnapshotBackup conn localMountPoint folder secondaryStorageMountPath snapshotBackupUuid catch final Exception e s_logger debug e else if destStore S3TO try
installPath installPath tmpltFilename hypervisorResource removeSR conn tmpltSR tmpltSR null final TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath installPath newTemplate setFormat Storage ImageFormat VHD newTemplate setSize virtualSize newTemplate setPhysicalSize physicalSize newTemplate setName tmpltUUID final CopyCmdAnswer answer new CopyCmdAnswer newTemplate return answer catch final Exception e if tmpltSR null hypervisorResource removeSR conn tmpltSR if secondaryStorageMountPath null
hypervisorResource checkForSuccess conn task task destroy conn result true destVdi VDI getByUuid conn volumeUUID final VDI Record vdir destVdi getRecord conn final VolumeObjectTO newVol new VolumeObjectTO newVol setPath volumeUUID newVol setSize vdir virtualSize return new CopyCmdAnswer newVol catch final Types XenAPIException e details e toString s_logger warn details e catch final Exception e details e getMessage s_logger warn details e
result true destVdi VDI getByUuid conn volumeUUID final VDI Record vdir destVdi getRecord conn final VolumeObjectTO newVol new VolumeObjectTO newVol setPath volumeUUID newVol setSize vdir virtualSize return new CopyCmdAnswer newVol catch final Types XenAPIException e details e toString s_logger warn details e catch final Exception e details e getMessage s_logger warn details e finally if srcSr null
final URI uri new URI nfsStore getUrl if hypervisorResource createSecondaryStorageFolder conn uri getHost uri getPath destVolume getPath throw new InternalErrorException secondaryStorage createFileSr conn uri getHost uri getPath destVolume getPath final VDI srcVdi getVDIbyUuid conn srcVolume getPath task srcVdi copyAsync conn secondaryStorage null null hypervisorResource waitForTask conn task wait hypervisorResource checkForSuccess conn task final VDI destVdi Types toVDI task conn final String destVolumeUUID destVdi getUuid conn final VolumeObjectTO newVol new VolumeObjectTO newVol setPath destVolume getPath File separator destVolumeUUID newVol setSize srcVolume getSize return new CopyCmdAnswer newVol catch final Exception e
final DataTO srcData cmd getSrcTO final DataTO destData cmd getDestTO if srcData getDataStore PrimaryDataStoreTO destData getDataStore NfsTO return createTemplateFromSnapshot2 cmd final int wait cmd getWait final SnapshotObjectTO srcObj SnapshotObjectTO srcData final TemplateObjectTO destObj TemplateObjectTO destData final NfsTO srcStore NfsTO srcObj getDataStore final NfsTO destStore NfsTO destObj getDataStore URI srcUri null URI destUri null try srcUri new URI srcStore getUrl destUri new URI destStore getUrl catch final Exception e
templatePath templatePath replaceAll result hypervisorResource postCreatePrivateTemplate conn templatePath templateFilename templateUuid nameLabel null physicalSize virtualSize destObj getId if result throw new CloudRuntimeException final TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath destDir templateFilename newTemplate setFormat Storage ImageFormat VHD newTemplate setSize destVdi getVirtualSize conn newTemplate setPhysicalSize destVdi getPhysicalUtilisation conn newTemplate setName destVdiUuid result true return new CopyCmdAnswer newTemplate catch final Exception e s_logger error e return new CopyCmdAnswer e toString
String templatePath destNfsPath destDir templatePath templatePath replaceAll result hypervisorResource postCreatePrivateTemplate conn templatePath templateFilename templateUuid nameLabel null physicalSize virtualSize templateObjTO getId if result throw new CloudRuntimeException final TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath destDir templateFilename newTemplate setFormat Storage ImageFormat VHD newTemplate setHypervisorType HypervisorType XenServer newTemplate setSize virtualSize newTemplate setPhysicalSize physicalSize newTemplate setName templateUuid result true return new CopyCmdAnswer newTemplate catch final BadServerResponse e
if result throw new CloudRuntimeException final TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath destDir templateFilename newTemplate setFormat Storage ImageFormat VHD newTemplate setHypervisorType HypervisorType XenServer newTemplate setSize virtualSize newTemplate setPhysicalSize physicalSize newTemplate setName templateUuid result true return new CopyCmdAnswer newTemplate catch final BadServerResponse e s_logger error e return new CopyCmdAnswer e toString catch final XenAPIException e
newTemplate setPhysicalSize physicalSize newTemplate setName templateUuid result true return new CopyCmdAnswer newTemplate catch final BadServerResponse e s_logger error e return new CopyCmdAnswer e toString catch final XenAPIException e s_logger error e return new CopyCmdAnswer e toString catch final XmlRpcException e s_logger error e return new CopyCmdAnswer e toString finally if result
public PIF getPif final Connection conn throws XenAPIException XmlRpcException if _p null final Network Record nr getNetworkRecord conn for final PIF pif nr PIFs final PIF Record pr pif getRecord conn if _citrixResourceBase getHost getUuid equals pr host getUuid conn if s_logger isDebugEnabled
else StorageFilerTO destPoolTO command getPool String destPoolUuid destPoolTO getUuid destPool xenServer610Resource getStorageRepository connection destPoolUuid Map String String other new HashMap other put Task task srcVolume poolMigrateAsync connection destPool other long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task VDI destVdi Types toVDI task connection return new MigrateVolumeAnswer command true null destVdi getUuid connection catch Exception ex if destDetails null Boolean parseBoolean destDetails get DiskTO MANAGED destPool null xenServer610Resource removeSR connection destPool
final Map VIF Network vifMap new HashMap VIF Network final Map VDI SR vdiMap new HashMap VDI SR for final Pair VolumeTO StorageFilerTO entry volumeToFiler final StorageFilerTO storageFiler entry second final VolumeTO volume entry first vdiMap put xenServer610Resource getVDIbyUuid connection volume getPath xenServer610Resource getStorageRepository connection storageFiler getUuid final Set VM vms VM getByNameLabel connection vmSpec getName final VM vmToMigrate vms iterator next final Host host Host getByUuid connection uuid final Map String String token host migrateReceive connection networkForSm other task vmToMigrate assertCanMigrateAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task
final VM vmToMigrate vms iterator next final Host host Host getByUuid connection uuid final Map String String token host migrateReceive connection networkForSm other task vmToMigrate assertCanMigrateAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e s_logger error vmName host e throw new CloudRuntimeException vmName host e task vmToMigrate migrateSendAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout
task vmToMigrate migrateSendAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e s_logger error vmName host e throw new CloudRuntimeException vmName host e final List VolumeObjectTO volumeToList xenServer610Resource getUpdatedVolumePathsOfMigratedVm connection vmToMigrate vmSpec getDisks vmToMigrate setAffinity connection host return new MigrateWithStorageAnswer command volumeToList catch final Exception e s_logger warn e getClass getName e toString e return new MigrateWithStorageAnswer command e finally
final String name vmSpec getName try final XsHost xsHost xenServer610Resource getHost final String uuid xsHost getUuid final Set VM vms VM getByNameLabel connection name if vms null throw new CloudRuntimeException name final VM migratedVm vms iterator next if migratedVm null throw new CloudRuntimeException name final Host host Host getByUuid connection uuid migratedVm setAffinity connection host final List VolumeObjectTO volumeToSet xenServer610Resource getUpdatedVolumePathsOfMigratedVm connection migratedVm vmSpec getDisks return new MigrateWithStorageCompleteAnswer command volumeToSet catch final CloudRuntimeException e
final String uuid xsHost getUuid final Set VM vms VM getByNameLabel connection name if vms null throw new CloudRuntimeException name final VM migratedVm vms iterator next if migratedVm null throw new CloudRuntimeException name final Host host Host getByUuid connection uuid migratedVm setAffinity connection host final List VolumeObjectTO volumeToSet xenServer610Resource getUpdatedVolumePathsOfMigratedVm connection migratedVm vmSpec getDisks return new MigrateWithStorageCompleteAnswer command volumeToSet catch final CloudRuntimeException e s_logger error name e toString e return new MigrateWithStorageCompleteAnswer command e catch final Exception e
volumeToSr add new Pair VolumeTO Object entry first sr final List Pair NicTO Object nicToNetwork new ArrayList Pair NicTO Object for final NicTO nicTo vmSpec getNics final Network network xenServer610Resource getNetwork connection nicTo nicToNetwork add new Pair NicTO Object nicTo network final XsLocalNetwork nativeNetworkForTraffic xenServer610Resource getNativeNetworkForTraffic connection TrafficType Storage null final Network network nativeNetworkForTraffic getNetwork final XsHost xsHost xenServer610Resource getHost final String uuid xsHost getUuid final Map String String other new HashMap String String other put final Host host Host getByUuid connection uuid final Map String String token host migrateReceive connection network other return new MigrateWithStorageReceiveAnswer command volumeToSr nicToNetwork token catch final CloudRuntimeException e
for final NicTO nicTo vmSpec getNics final Network network xenServer610Resource getNetwork connection nicTo nicToNetwork add new Pair NicTO Object nicTo network final XsLocalNetwork nativeNetworkForTraffic xenServer610Resource getNativeNetworkForTraffic connection TrafficType Storage null final Network network nativeNetworkForTraffic getNetwork final XsHost xsHost xenServer610Resource getHost final String uuid xsHost getUuid final Map String String other new HashMap String String other put final Host host Host getByUuid connection uuid final Map String String token host migrateReceive connection network other return new MigrateWithStorageReceiveAnswer command volumeToSr nicToNetwork token catch final CloudRuntimeException e s_logger error vmSpec getName e toString e return new MigrateWithStorageReceiveAnswer command e
final Network network Network entry second final VIF vif xenServer610Resource getVifByMac connection vmToMigrate entry first getMac vifMap put vif network else throw new CloudRuntimeException entry second task vmToMigrate assertCanMigrateAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e s_logger error vmName e throw new CloudRuntimeException vmName e task vmToMigrate migrateSendAsync connection token true vdiMap vifMap other try
throw new CloudRuntimeException entry second task vmToMigrate assertCanMigrateAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e s_logger error vmName e throw new CloudRuntimeException vmName e task vmToMigrate migrateSendAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e
task vmToMigrate assertCanMigrateAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e s_logger error vmName e throw new CloudRuntimeException vmName e task vmToMigrate migrateSendAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e s_logger error vmName e
s_logger error vmName e throw new CloudRuntimeException vmName e task vmToMigrate migrateSendAsync connection token true vdiMap vifMap other try final long timeout xenServer610Resource getMigrateWait 1000L xenServer610Resource waitForTask connection task timeout xenServer610Resource checkForSuccess connection task catch final Types HandleInvalid e s_logger error vmName e throw new CloudRuntimeException vmName e final Set VolumeTO volumeToSet null return new MigrateWithStorageSendAnswer command volumeToSet catch final CloudRuntimeException e s_logger error vmName e toString e return new MigrateWithStorageSendAnswer command e
Override public Answer execute final AttachOrDettachConfigDriveCommand command final CitrixResourceBase citrixResourceBase final Connection conn citrixResourceBase getConnection String vmName command getVmName List String vmData command getVmData String label command getConfigDriveLabel Boolean isAttach command isAttach try Set VM vms VM getByNameLabel conn vmName for VM vm vms if isAttach if citrixResourceBase createAndAttachConfigDriveIsoForVM conn vm vmData label
Override public Answer execute final AttachOrDettachConfigDriveCommand command final CitrixResourceBase citrixResourceBase final Connection conn citrixResourceBase getConnection String vmName command getVmName List String vmData command getVmData String label command getConfigDriveLabel Boolean isAttach command isAttach try Set VM vms VM getByNameLabel conn vmName for VM vm vms if isAttach if citrixResourceBase createAndAttachConfigDriveIsoForVM conn vm vmData label s_logger debug vmName else Set VDI vdis VDI getByNameLabel conn vmName if vdis null vdis isEmpty
else Set VDI vdis VDI getByNameLabel conn vmName if vdis null vdis isEmpty s_logger debug vmName VDI vdi vdis iterator next Set VBD vbds vdi getVBDs conn for VBD vbd vbds VBD Record vbdRec vbd getRecord conn if vbdRec type equals Types VbdType CD vbdRec empty vbdRec userdevice equals citrixResourceBase _attachIsoDeviceNum if vbdRec currentlyAttached vbd eject conn vbd destroy conn vdi destroy conn s_logger debug vmName catch Types XenAPIException ex
else Set VDI vdis VDI getByNameLabel conn vmName if vdis null vdis isEmpty s_logger debug vmName VDI vdi vdis iterator next Set VBD vbds vdi getVBDs conn for VBD vbd vbds VBD Record vbdRec vbd getRecord conn if vbdRec type equals Types VbdType CD vbdRec empty vbdRec userdevice equals citrixResourceBase _attachIsoDeviceNum if vbdRec currentlyAttached vbd eject conn vbd destroy conn vdi destroy conn s_logger debug vmName catch Types XenAPIException ex
boolean errorout false String msg for final PhysicalNetworkSetupInfo info infoList if citrixResourceBase isNetworkSetupByName info getGuestNetworkName msg info getPhysicalNetworkId info getGuestNetworkName errorout true break if citrixResourceBase isNetworkSetupByName info getPrivateNetworkName msg info getPhysicalNetworkId info getPrivateNetworkName errorout true break if citrixResourceBase isNetworkSetupByName info getPublicNetworkName msg info getPhysicalNetworkId info getPublicNetworkName errorout true break
Override public Answer execute final CheckSshCommand command final CitrixResourceBase citrixResourceBase final Connection conn citrixResourceBase getConnection final String vmName command getName final String privateIp command getIp final int cmdPort command getPort if s_logger isDebugEnabled
Override public Answer execute final CheckVirtualMachineCommand command final CitrixResourceBase citrixResourceBase final Connection conn citrixResourceBase getConnection final String vmName command getVmName final PowerState powerState citrixResourceBase getVmState conn vmName final Integer vncPort null if powerState PowerState PowerOn
Override public Answer execute CopyToSecondaryStorageCommand cmd CitrixResourceBase citrixResourceBase final Connection conn citrixResourceBase getConnection String msg String format cmd getFileName cmd getSystemVmIp cmd getSecondaryStorageUrl
final SR poolSr citrixResourceBase getStorageRepository conn pool getUuid if command getTemplateUrl null VDI tmpltvdi null tmpltvdi citrixResourceBase getVDIbyUuid conn command getTemplateUrl vdi tmpltvdi createClone conn new HashMap String String vdi setNameLabel conn dskch getName else final VDI Record vdir new VDI Record vdir nameLabel dskch getName vdir SR poolSr vdir type Types VdiType USER vdir virtualSize dskch getSize vdi VDI create conn vdir VDI Record vdir vdir vdi getRecord conn
citrixResourceBase waitForTask conn task timeout citrixResourceBase checkForSuccess conn task final String result task getResult conn final String ref result substring length result length length vmSnapshot Types toVM ref try Thread sleep catch final InterruptedException ex for final VolumeObjectTO volumeTo command getVolumeTOs try final long size citrixResourceBase getVMSnapshotChainSize conn volumeTo command getVmName vmSnapshotName volumeTo setSize size catch final CloudRuntimeException cre success true return new CreateVMSnapshotAnswer command command getTarget command getVolumeTOs
final Connection conn citrixResourceBase getConnection final StorageFilerTO poolTO command getPool try final SR sr if command getRemoveDatastore Map String String details command getDetails String srNameLabel details get DeleteStoragePoolCommand DATASTORE_NAME sr citrixResourceBase getStorageRepository conn srNameLabel else sr citrixResourceBase getStorageRepository conn poolTO getUuid citrixResourceBase removeSR conn sr final Answer answer new Answer command true return answer catch final Exception e final String msg e getMessage citrixResourceBase getHost getUuid poolTO getHost poolTO getPath
String vmName command getVmName String networkCidr command getVmNetworkCidr boolean result false String errorMsg null String vmIp null try VM vm citrixResourceBase getVM conn vmName VMGuestMetrics mtr vm getGuestMetrics conn VMGuestMetrics Record rec mtr getRecord conn Map String String vmIpsMap rec networks for String ipAddr vmIpsMap values if NetUtils isIpWithInCidrRange ipAddr networkCidr vmIp ipAddr break if vmIp null
String vmIp null try VM vm citrixResourceBase getVM conn vmName VMGuestMetrics mtr vm getGuestMetrics conn VMGuestMetrics Record rec mtr getRecord conn Map String String vmIpsMap rec networks for String ipAddr vmIpsMap values if NetUtils isIpWithInCidrRange ipAddr networkCidr vmIp ipAddr break if vmIp null s_logger debug vmName vmIp result true return new Answer command result vmIp catch Types XenAPIException e
VMGuestMetrics mtr vm getGuestMetrics conn VMGuestMetrics Record rec mtr getRecord conn Map String String vmIpsMap rec networks for String ipAddr vmIpsMap values if NetUtils isIpWithInCidrRange ipAddr networkCidr vmIp ipAddr break if vmIp null s_logger debug vmName vmIp result true return new Answer command result vmIp catch Types XenAPIException e s_logger debug e getMessage errorMsg e getMessage catch XmlRpcException e
final String msg dstHostIpAddr citrixResourceBase getHost getPool s_logger warn msg return new MigrateAnswer command false msg null for final VM vm vms final Set VBD vbds vm getVBDs conn for final VBD vbd vbds final VBD Record vbdRec vbd getRecord conn if vbdRec type equals Types VbdType CD vbdRec empty vbd eject conn if vbdRec userdevice equals citrixResourceBase _attachIsoDeviceNum if vbdRec currentlyAttached vbd destroy conn continue citrixResourceBase migrateVM conn dsthost vm vmName vm setAffinity conn dsthost
protected void destroyMigratedVmNetworkRulesOnSourceHost final MigrateCommand command final CitrixResourceBase citrixResourceBase final Connection conn Host dsthost throws BadServerResponse XenAPIException XmlRpcException if citrixResourceBase canBridgeFirewall final String result citrixResourceBase callHostPlugin conn command getVmName if BooleanUtils toBoolean result
citrixResourceBase setIsOvs true final Connection conn citrixResourceBase getConnection String bridge try final Network nw citrixResourceBase setupvSwitchNetwork conn bridge nw getBridge conn final String result citrixResourceBase callHostPlugin conn bridge command getRemoteIp command getKey Long toString command getFrom Long toString command getTo final String res result split if res length res length res equalsIgnoreCase return new OvsCreateGreTunnelAnswer command false result citrixResourceBase getHost getIp bridge else return new OvsCreateGreTunnelAnswer command true result citrixResourceBase getHost getIp bridge Integer parseInt res catch final BadServerResponse e s_logger error command getRemoteIp citrixResourceBase getHost getIp e catch final XenAPIException e
String bridge try final Network nw citrixResourceBase setupvSwitchNetwork conn bridge nw getBridge conn final String result citrixResourceBase callHostPlugin conn bridge command getRemoteIp command getKey Long toString command getFrom Long toString command getTo final String res result split if res length res length res equalsIgnoreCase return new OvsCreateGreTunnelAnswer command false result citrixResourceBase getHost getIp bridge else return new OvsCreateGreTunnelAnswer command true result citrixResourceBase getHost getIp bridge Integer parseInt res catch final BadServerResponse e s_logger error command getRemoteIp citrixResourceBase getHost getIp e catch final XenAPIException e s_logger error command getRemoteIp citrixResourceBase getHost getIp e catch final XmlRpcException e
citrixResourceBase setIsOvs true final Connection conn citrixResourceBase getConnection try final Network nw citrixResourceBase setupvSwitchNetwork conn final String bridge nw getBridge conn final String result citrixResourceBase callHostPlugin conn bridge command getVmName if result equalsIgnoreCase return new Answer command true command getVmName else return new Answer command false result catch final BadServerResponse e s_logger error e catch final XenAPIException e s_logger error e catch final XmlRpcException e
String label command getLabel if citrixResourceBase isXcp label citrixResourceBase getLabel s_logger debug label citrixResourceBase getHost getIp final Connection conn citrixResourceBase getConnection try final XsLocalNetwork nw citrixResourceBase getNetworkByName conn label if nw null throw new CloudRuntimeException label citrixResourceBase getHost getIp s_logger debug nw getNetwork getUuid conn final PIF pif nw getPif conn final PIF Record pifRec pif getRecord conn s_logger debug pifRec uuid pifRec device return new OvsFetchInterfaceAnswer command true pifRec device pifRec IP pifRec netmask pifRec MAC catch final BadServerResponse e
s_logger debug label citrixResourceBase getHost getIp final Connection conn citrixResourceBase getConnection try final XsLocalNetwork nw citrixResourceBase getNetworkByName conn label if nw null throw new CloudRuntimeException label citrixResourceBase getHost getIp s_logger debug nw getNetwork getUuid conn final PIF pif nw getPif conn final PIF Record pifRec pif getRecord conn s_logger debug pifRec uuid pifRec device return new OvsFetchInterfaceAnswer command true pifRec device pifRec IP pifRec netmask pifRec MAC catch final BadServerResponse e s_logger error label citrixResourceBase getHost getIp e return new OvsFetchInterfaceAnswer command false e getMessage catch final XenAPIException e
try final XsLocalNetwork nw citrixResourceBase getNetworkByName conn label if nw null throw new CloudRuntimeException label citrixResourceBase getHost getIp s_logger debug nw getNetwork getUuid conn final PIF pif nw getPif conn final PIF Record pifRec pif getRecord conn s_logger debug pifRec uuid pifRec device return new OvsFetchInterfaceAnswer command true pifRec device pifRec IP pifRec netmask pifRec MAC catch final BadServerResponse e s_logger error label citrixResourceBase getHost getIp e return new OvsFetchInterfaceAnswer command false e getMessage catch final XenAPIException e s_logger error label citrixResourceBase getHost getIp e return new OvsFetchInterfaceAnswer command false e getMessage
Override public Answer execute final OvsSetTagAndFlowCommand command final CitrixResourceBase citrixResourceBase citrixResourceBase setIsOvs true final Connection conn citrixResourceBase getConnection try final Network nw citrixResourceBase setupvSwitchNetwork conn final String bridge nw getBridge conn final String result citrixResourceBase callHostPlugin conn bridge command getVmName command getTag command getVlans command getSeqNo
Override public Answer execute final OvsSetTagAndFlowCommand command final CitrixResourceBase citrixResourceBase citrixResourceBase setIsOvs true final Connection conn citrixResourceBase getConnection try final Network nw citrixResourceBase setupvSwitchNetwork conn final String bridge nw getBridge conn final String result citrixResourceBase callHostPlugin conn bridge command getVmName command getTag command getVlans command getSeqNo s_logger debug command getVmName result if result null result equalsIgnoreCase return new OvsSetTagAndFlowAnswer command true result else return new OvsSetTagAndFlowAnswer command false result catch final BadServerResponse e s_logger error e catch final XenAPIException e
final Connection conn citrixResourceBase getConnection try final Network nw citrixResourceBase setupvSwitchNetwork conn final String bridge nw getBridge conn final String result citrixResourceBase callHostPlugin conn bridge command getVmName command getTag command getVlans command getSeqNo s_logger debug command getVmName result if result null result equalsIgnoreCase return new OvsSetTagAndFlowAnswer command true result else return new OvsSetTagAndFlowAnswer command false result catch final BadServerResponse e s_logger error e catch final XenAPIException e s_logger error e catch final XmlRpcException e
final Set VM vms VM getByNameLabel conn vmName if vms null vms isEmpty return new PlugNicAnswer command false vmName final VM vm vms iterator next final NicTO nic command getNic String mac nic getMac final Set VIF routerVIFs vm getVIFs conn mac mac trim int counter for final VIF vif routerVIFs final String lmac vif getMAC conn if lmac trim equals mac counter if counter final String msg nic getMac
int counter for final VIF vif routerVIFs final String lmac vif getMAC conn if lmac trim equals mac counter if counter final String msg nic getMac s_logger error msg return new PlugNicAnswer command false msg final String deviceId citrixResourceBase getLowestAvailableVIFDeviceNum conn vm nic setDeviceId Integer parseInt deviceId final VIF vif citrixResourceBase createVif conn vmName vm null nic vif plug conn return new PlugNicAnswer command true catch final Exception e
Override public Answer execute final PvlanSetupCommand command final CitrixResourceBase citrixResourceBase final Connection conn citrixResourceBase getConnection final String primaryPvlan command getPrimary final String isolatedPvlan command getIsolated final String op command getOp final String dhcpName command getDhcpName final String dhcpMac command getDhcpMac final String dhcpIp command getDhcpIp final String vmMac command getVmMac final String networkTag command getNetworkTag String nwNameLabel null try final XsLocalNetwork nw citrixResourceBase getNativeNetworkForTraffic conn TrafficType Guest networkTag if nw null
throw new CloudRuntimeException primaryPvlan nwNameLabel nw getNetwork getNameLabel conn catch final XenAPIException e s_logger warn e return new Answer command false e toString catch final XmlRpcException e s_logger warn e return new Answer command false e toString String result null if command getType PvlanSetupCommand Type DHCP result citrixResourceBase callHostPlugin conn op nwNameLabel primaryPvlan isolatedPvlan dhcpName dhcpIp dhcpMac if result null result isEmpty Boolean parseBoolean result s_logger warn dhcpMac return new Answer command false result else
catch final XmlRpcException e s_logger warn e return new Answer command false e toString String result null if command getType PvlanSetupCommand Type DHCP result citrixResourceBase callHostPlugin conn op nwNameLabel primaryPvlan isolatedPvlan dhcpName dhcpIp dhcpMac if result null result isEmpty Boolean parseBoolean result s_logger warn dhcpMac return new Answer command false result else s_logger info dhcpMac else if command getType PvlanSetupCommand Type VM result citrixResourceBase callHostPlugin conn op nwNameLabel primaryPvlan isolatedPvlan vmMac if result null result isEmpty Boolean parseBoolean result s_logger warn vmMac
Override public Answer execute final RebootCommand command final CitrixResourceBase citrixResourceBase final Connection conn citrixResourceBase getConnection
catch final XenAPIException e0 s_logger debug e0 toString return new RebootAnswer command e0 toString false catch final Exception e0 s_logger debug e0 getMessage return new RebootAnswer command false for final VM vm vms try citrixResourceBase rebootVM conn vm vm getNameLabel conn catch final Exception e final String msg e toString s_logger warn msg e return new RebootAnswer command msg false return new RebootAnswer command true finally
Override public Answer execute final ResizeVolumeCommand command final CitrixResourceBase citrixResourceBase Connection conn citrixResourceBase getConnection String volId command getPath long newSize command getNewSize try if command getCurrentSize newSize
vm citrixResourceBase getVM conn vmName final Set VBD vbds vm getVBDs conn final Map String VDI vdiMap new HashMap String VDI for final VBD vbd vbds final VBD Record vbdr vbd getRecord conn if vbdr type Types VbdType DISK final VDI vdi vbdr VDI vdiMap put vbdr userdevice vdi if snapshotMemory vm destroy conn vmState PowerState PowerOff else vmState PowerState PowerOn for final VolumeObjectTO volumeTo listVolumeTo final Long deviceId volumeTo getDeviceId
if vms null vms size s_logger info vmName citrixResourceBase getHost getUuid return new ScaleVmAnswer command false final Iterator VM iter vms iterator while iter hasNext final VM vm iter next final VM Record vmr vm getRecord conn if vmr powerState VmPowerState HALTED vmr powerState VmPowerState RUNNING citrixResourceBase isRefNull vmr residentOn vmr residentOn getUuid conn equals citrixResourceBase getHost getUuid iter remove for final VM vm vms vm getRecord conn try citrixResourceBase scaleVM conn vm vmSpec host catch final Exception e final String msg e getClass getName vmName e toString
return new ScaleVmAnswer command false final Iterator VM iter vms iterator while iter hasNext final VM vm iter next final VM Record vmr vm getRecord conn if vmr powerState VmPowerState HALTED vmr powerState VmPowerState RUNNING citrixResourceBase isRefNull vmr residentOn vmr residentOn getUuid conn equals citrixResourceBase getHost getUuid iter remove for final VM vm vms vm getRecord conn try citrixResourceBase scaleVM conn vm vmSpec host catch final Exception e final String msg e getClass getName vmName e toString s_logger debug msg return new ScaleVmAnswer command false msg
if command useMultipath host addToOtherConfig conn host addToOtherConfig conn catch final Types MapDuplicateKey e s_logger debug if command needSetup final String result citrixResourceBase callHostPlugin conn citrixResourceBase getHost getUuid if result contains s_logger warn result return new SetupAnswer command result Pair PIF PIF Record mgmtPif null final Set PIF hostPifs host getPIFs conn for final PIF pif hostPifs final PIF Record rec pif getRecord conn if rec management
final VirtualMachineTO vmSpec command getVirtualMachine final String vmName vmSpec getName VmPowerState state VmPowerState HALTED VM vm null final Map String Map String String iqnToData new HashMap try final Set VM vms VM getByNameLabel conn vmName if vms null for final VM v vms final VM Record vRec v getRecord conn if vRec powerState VmPowerState HALTED v destroy conn else if vRec powerState VmPowerState RUNNING final String host vRec residentOn getUuid conn final String msg vmName host
v destroy conn else if vRec powerState VmPowerState RUNNING final String host vRec residentOn getUuid conn final String msg vmName host s_logger debug msg return new StartAnswer command msg host else final String msg vmName vRec toString s_logger warn msg return new StartAnswer command msg s_logger debug vmName final Host host Host getByUuid conn citrixResourceBase getHost getUuid vm citrixResourceBase createVmFromTemplate conn vmSpec host final GPUDeviceTO gpuDevice vmSpec getGpuDevice if gpuDevice null
boolean secGrpEnabled false for final NicTO nic nics if nic isSecurityGroupEnabled nic getIsolationUri null nic getIsolationUri getScheme equalsIgnoreCase IsolationType Ec2 toString secGrpEnabled true break if secGrpEnabled result citrixResourceBase callHostPlugin conn vmName if result null result isEmpty Boolean parseBoolean result s_logger warn vmName else s_logger info vmName else final NicTO nics vmSpec getNics for final NicTO nic nics if nic isSecurityGroupEnabled nic getIsolationUri null nic getIsolationUri getScheme equalsIgnoreCase IsolationType Ec2 toString
s_logger info vmName else final NicTO nics vmSpec getNics for final NicTO nic nics if nic isSecurityGroupEnabled nic getIsolationUri null nic getIsolationUri getScheme equalsIgnoreCase IsolationType Ec2 toString final List String nicSecIps nic getNicSecIps String secIpsStr final StringBuilder sb new StringBuilder if nicSecIps null for final String ip nicSecIps sb append ip append secIpsStr sb toString else secIpsStr result citrixResourceBase callHostPlugin conn vmName nic getIp nic getMac Long toString vmSpec getId secIpsStr
else final NicTO nics vmSpec getNics for final NicTO nic nics if nic isSecurityGroupEnabled nic getIsolationUri null nic getIsolationUri getScheme equalsIgnoreCase IsolationType Ec2 toString final List String nicSecIps nic getNicSecIps String secIpsStr final StringBuilder sb new StringBuilder if nicSecIps null for final String ip nicSecIps sb append ip append secIpsStr sb toString else secIpsStr result citrixResourceBase callHostPlugin conn vmName nic getIp nic getMac Long toString vmSpec getId secIpsStr if result null result isEmpty Boolean parseBoolean result
continue iter remove if vms size return new StopAnswer command true for final VM vm vms final VM Record vmr vm getRecord conn platformstring StringUtils mapToString vmr platform if vmr isControlDomain final String msg s_logger warn msg return new StopAnswer command msg false if vmr powerState VmPowerState RUNNING citrixResourceBase isRefNull vmr residentOn vmr residentOn getUuid conn equals citrixResourceBase getHost getUuid final String msg vmName citrixResourceBase getHost getUuid vmr residentOn getUuid conn s_logger warn msg return new StopAnswer command msg platformstring false
if vms size return new StopAnswer command true for final VM vm vms final VM Record vmr vm getRecord conn platformstring StringUtils mapToString vmr platform if vmr isControlDomain final String msg s_logger warn msg return new StopAnswer command msg false if vmr powerState VmPowerState RUNNING citrixResourceBase isRefNull vmr residentOn vmr residentOn getUuid conn equals citrixResourceBase getHost getUuid final String msg vmName citrixResourceBase getHost getUuid vmr residentOn getUuid conn s_logger warn msg return new StopAnswer command msg platformstring false if command checkBeforeCleanup vmr powerState VmPowerState RUNNING final String msg vmName
final String msg s_logger warn msg return new StopAnswer command msg false if vmr powerState VmPowerState RUNNING citrixResourceBase isRefNull vmr residentOn vmr residentOn getUuid conn equals citrixResourceBase getHost getUuid final String msg vmName citrixResourceBase getHost getUuid vmr residentOn getUuid conn s_logger warn msg return new StopAnswer command msg platformstring false if command checkBeforeCleanup vmr powerState VmPowerState RUNNING final String msg vmName s_logger debug msg return new StopAnswer command msg false s_logger debug vmName try if vmr powerState VmPowerState RUNNING vm setAffinity conn vm getResidentOn conn
if vmr powerState VmPowerState RUNNING citrixResourceBase isRefNull vmr residentOn vmr residentOn getUuid conn equals citrixResourceBase getHost getUuid final String msg vmName citrixResourceBase getHost getUuid vmr residentOn getUuid conn s_logger warn msg return new StopAnswer command msg platformstring false if command checkBeforeCleanup vmr powerState VmPowerState RUNNING final String msg vmName s_logger debug msg return new StopAnswer command msg false s_logger debug vmName try if vmr powerState VmPowerState RUNNING vm setAffinity conn vm getResidentOn conn if citrixResourceBase canBridgeFirewall final String result citrixResourceBase callHostPlugin conn command getVmName if result null result isEmpty Boolean parseBoolean result
s_logger debug vmName try if vmr powerState VmPowerState RUNNING vm setAffinity conn vm getResidentOn conn if citrixResourceBase canBridgeFirewall final String result citrixResourceBase callHostPlugin conn command getVmName if result null result isEmpty Boolean parseBoolean result s_logger warn command getVmName else s_logger info command getVmName citrixResourceBase shutdownVM conn vm vmName command isForceStop catch final Exception e final String msg e getClass getName command getVmName e toString s_logger debug msg return new StopAnswer command msg platformstring false
finally try if vm getPowerState conn VmPowerState HALTED Set VGPU vGPUs null try vGPUs vm getVGPUs conn catch final XenAPIException e2 s_logger debug vmName if vGPUs null vGPUs isEmpty final HashMap String HashMap String VgpuTypesInfo groupDetails citrixResourceBase getGPUGroupDetails conn command setGpuDevice new GPUDeviceTO null null groupDetails final Set VIF vifs vm getVIFs conn final List Network networks new ArrayList Network for final VIF vif vifs networks add vif getNetwork conn
Override public Answer execute final UpdateHostPasswordCommand command final CitrixResourceBase citrixResourceBase final String hostIp command getHostIp final String username command getUsername final String newPassword command getNewPassword final XenServerUtilitiesHelper xenServerUtilitiesHelper citrixResourceBase getXenServerUtilitiesHelper final String cmdLine xenServerUtilitiesHelper buildCommandLine SCRIPT_CMD_PATH VRScripts UPDATE_HOST_PASSWD username newPassword Pair Boolean String result try
final Long templateId command getTemplateId final Long tmpltAcountId command getTmpltAccountId final String version command getVersion if version equals return new Answer command true try final Connection conn citrixResourceBase getConnection final URI uri new URI secondaryStorageUrl final String secondaryStorageMountPath uri getHost uri getPath final String snapshotPath secondaryStorageMountPath accountId volumeId backedUpSnapshotUuid final String templatePath secondaryStorageMountPath tmpltAcountId templateId citrixResourceBase upgradeSnapshot conn templatePath snapshotPath return new Answer command true catch final Exception e final String details backedUpSnapshotUuid e toString
private static void applyConfigWithNestedKeyValue Connection conn VM vm Map String Object recordMap String paramKey String paramValue int i paramKey indexOf String actualParam paramKey substring i String keyName paramKey substring i if isValidOperation recordMap actualParam
try switch actualParam case vm addToVCPUsParams conn keyName paramValue break case vm addToOtherConfig conn keyName paramValue break case vm addToHVMBootParams conn keyName paramValue break case vm addToOtherConfig conn keyName paramValue break case vm addToXenstoreData conn keyName paramValue break default String msg String format paramKey LOG warn msg catch XmlRpcException Types XenAPIException e
private static void applyConfigWithKeyValue Connection conn VM vm Map String Object recordMap String paramKey String paramValue if isValidOperation recordMap paramKey
final Set String classes new HashSet String classes add task toWireString String token final Double t new Double timeout while true final EventBatch map Event from c classes token t token map token SuppressWarnings final Set Event Record events map events if events size final String msg task toWireString s_logger warn msg task cancel c throw new TimeoutException msg for final Event Record rec events if rec snapshot Task Record
final EventBatch map Event from c classes token t token map token SuppressWarnings final Set Event Record events map events if events size final String msg task toWireString s_logger warn msg task cancel c throw new TimeoutException msg for final Event Record rec events if rec snapshot Task Record if s_logger isDebugEnabled s_logger debug rec continue final Task Record taskRecord Task Record rec snapshot if taskRecord status Types TaskStatusType PENDING
final String msg task toWireString s_logger warn msg task cancel c throw new TimeoutException msg for final Event Record rec events if rec snapshot Task Record if s_logger isDebugEnabled s_logger debug rec continue final Task Record taskRecord Task Record rec snapshot if taskRecord status Types TaskStatusType PENDING if s_logger isDebugEnabled s_logger debug task toWireString taskRecord uuid taskRecord status return else
volumeDetailVo new VolumeDetailVO volumeInfo getId PrimaryDataStoreDriver BASIC_GRANT_ACCESS Boolean TRUE toString false volumeDetailsDao persist volumeDetailVo pdsd grantAccess volumeInfo destHost volumeInfo getDataStore final Map String String details new HashMap final String iqn getBasicIqn volumeInfo getId details put CreateStoragePoolCommand DATASTORE_NAME iqn details put CreateStoragePoolCommand IQN iqn details put CreateStoragePoolCommand STORAGE_HOST storagePool getHostAddress details put CreateStoragePoolCommand STORAGE_PORT String valueOf storagePool getPort final CreateStoragePoolCommand cmd new CreateStoragePoolCommand true storagePool cmd setDetails details cmd setCreateDatastore true final Answer answer agentMgr easySend destHost getId cmd if answer null answer getResult String errMsg StringUtils isNotBlank answer getDetails answer getDetails
private void handleManagedVolumePostMigration VolumeInfo volumeInfo Host srcHost VolumeObjectTO volumeTO final Map String String details new HashMap details put DeleteStoragePoolCommand DATASTORE_NAME volumeInfo get_iScsiName final DeleteStoragePoolCommand cmd new DeleteStoragePoolCommand cmd setDetails details cmd setRemoveDatastore true final Answer answer agentMgr easySend srcHost getId cmd if answer null answer getResult String errMsg StringUtils isNotBlank answer getDetails answer getDetails
private void handleManagedVolumesAfterFailedMigration Map VolumeInfo DataStore volumeToPool Host destHost for Map Entry VolumeInfo DataStore entry volumeToPool entrySet VolumeInfo volumeInfo entry getKey StoragePool storagePool storagePoolDao findById volumeInfo getPoolId if storagePool isManaged final Map String String details new HashMap details put DeleteStoragePoolCommand DATASTORE_NAME getBasicIqn volumeInfo getId final DeleteStoragePoolCommand cmd new DeleteStoragePoolCommand cmd setDetails details cmd setRemoveDatastore true final Answer answer agentMgr easySend destHost getId cmd if answer null answer getResult String errMsg StringUtils isNotBlank answer getDetails answer getDetails
try verifyNoSnapshotsOnManagedStorageVolumes volumeToPool List Pair VolumeTO String volumeToStorageUuid new ArrayList for Map Entry VolumeInfo DataStore entry volumeToPool entrySet VolumeInfo volumeInfo entry getKey StoragePool storagePool storagePoolDao findById volumeInfo getPoolId VolumeTO volumeTo new VolumeTO volumeInfo storagePool if storagePool isManaged String iqn handleManagedVolumePreMigration volumeInfo storagePool destHost volumeToStorageUuid add new Pair volumeTo iqn else volumeToStorageUuid add new Pair volumeTo StoragePool entry getValue getUuid MigrateWithStorageReceiveCommand receiveCmd new MigrateWithStorageReceiveCommand to volumeToStorageUuid MigrateWithStorageReceiveAnswer receiveAnswer MigrateWithStorageReceiveAnswer agentMgr send destHost getId receiveCmd if receiveAnswer null
for Map Entry VolumeInfo DataStore entry volumeToPool entrySet VolumeInfo volumeInfo entry getKey StoragePool storagePool storagePoolDao findById volumeInfo getPoolId VolumeTO volumeTo new VolumeTO volumeInfo storagePool if storagePool isManaged String iqn handleManagedVolumePreMigration volumeInfo storagePool destHost volumeToStorageUuid add new Pair volumeTo iqn else volumeToStorageUuid add new Pair volumeTo StoragePool entry getValue getUuid MigrateWithStorageReceiveCommand receiveCmd new MigrateWithStorageReceiveCommand to volumeToStorageUuid MigrateWithStorageReceiveAnswer receiveAnswer MigrateWithStorageReceiveAnswer agentMgr send destHost getId receiveCmd if receiveAnswer null s_logger error vm destHost throw new CloudRuntimeException vm destHost else if receiveAnswer getResult
volumeToStorageUuid add new Pair volumeTo iqn else volumeToStorageUuid add new Pair volumeTo StoragePool entry getValue getUuid MigrateWithStorageReceiveCommand receiveCmd new MigrateWithStorageReceiveCommand to volumeToStorageUuid MigrateWithStorageReceiveAnswer receiveAnswer MigrateWithStorageReceiveAnswer agentMgr send destHost getId receiveCmd if receiveAnswer null s_logger error vm destHost throw new CloudRuntimeException vm destHost else if receiveAnswer getResult s_logger error vm receiveAnswer getDetails throw new CloudRuntimeException vm destHost MigrateWithStorageSendCommand sendCmd new MigrateWithStorageSendCommand to receiveAnswer getVolumeToSr receiveAnswer getNicToNetwork receiveAnswer getToken MigrateWithStorageSendAnswer sendAnswer MigrateWithStorageSendAnswer agentMgr send srcHost getId sendCmd if sendAnswer null handleManagedVolumesAfterFailedMigration volumeToPool destHost
MigrateWithStorageReceiveCommand receiveCmd new MigrateWithStorageReceiveCommand to volumeToStorageUuid MigrateWithStorageReceiveAnswer receiveAnswer MigrateWithStorageReceiveAnswer agentMgr send destHost getId receiveCmd if receiveAnswer null s_logger error vm destHost throw new CloudRuntimeException vm destHost else if receiveAnswer getResult s_logger error vm receiveAnswer getDetails throw new CloudRuntimeException vm destHost MigrateWithStorageSendCommand sendCmd new MigrateWithStorageSendCommand to receiveAnswer getVolumeToSr receiveAnswer getNicToNetwork receiveAnswer getToken MigrateWithStorageSendAnswer sendAnswer MigrateWithStorageSendAnswer agentMgr send srcHost getId sendCmd if sendAnswer null handleManagedVolumesAfterFailedMigration volumeToPool destHost s_logger error vm destHost throw new CloudRuntimeException vm destHost else if sendAnswer getResult
s_logger error vm destHost throw new CloudRuntimeException vm destHost else if receiveAnswer getResult s_logger error vm receiveAnswer getDetails throw new CloudRuntimeException vm destHost MigrateWithStorageSendCommand sendCmd new MigrateWithStorageSendCommand to receiveAnswer getVolumeToSr receiveAnswer getNicToNetwork receiveAnswer getToken MigrateWithStorageSendAnswer sendAnswer MigrateWithStorageSendAnswer agentMgr send srcHost getId sendCmd if sendAnswer null handleManagedVolumesAfterFailedMigration volumeToPool destHost s_logger error vm destHost throw new CloudRuntimeException vm destHost else if sendAnswer getResult handleManagedVolumesAfterFailedMigration volumeToPool destHost s_logger error vm sendAnswer getDetails throw new CloudRuntimeException vm destHost
else if receiveAnswer getResult s_logger error vm receiveAnswer getDetails throw new CloudRuntimeException vm destHost MigrateWithStorageSendCommand sendCmd new MigrateWithStorageSendCommand to receiveAnswer getVolumeToSr receiveAnswer getNicToNetwork receiveAnswer getToken MigrateWithStorageSendAnswer sendAnswer MigrateWithStorageSendAnswer agentMgr send srcHost getId sendCmd if sendAnswer null handleManagedVolumesAfterFailedMigration volumeToPool destHost s_logger error vm destHost throw new CloudRuntimeException vm destHost else if sendAnswer getResult handleManagedVolumesAfterFailedMigration volumeToPool destHost s_logger error vm sendAnswer getDetails throw new CloudRuntimeException vm destHost MigrateWithStorageCompleteCommand command new MigrateWithStorageCompleteCommand to MigrateWithStorageCompleteAnswer answer MigrateWithStorageCompleteAnswer agentMgr send destHost getId command
if sendAnswer null handleManagedVolumesAfterFailedMigration volumeToPool destHost s_logger error vm destHost throw new CloudRuntimeException vm destHost else if sendAnswer getResult handleManagedVolumesAfterFailedMigration volumeToPool destHost s_logger error vm sendAnswer getDetails throw new CloudRuntimeException vm destHost MigrateWithStorageCompleteCommand command new MigrateWithStorageCompleteCommand to MigrateWithStorageCompleteAnswer answer MigrateWithStorageCompleteAnswer agentMgr send destHost getId command if answer null s_logger error vm throw new CloudRuntimeException vm destHost else if answer getResult s_logger error vm answer getDetails
VolumeTO volumeTo new VolumeTO volume storagePoolDao findById volume getPoolId StorageFilerTO filerTo new StorageFilerTO StoragePool entry getValue volumeToFilerto add new Pair VolumeTO StorageFilerTO volumeTo filerTo MigrateWithStorageCommand command new MigrateWithStorageCommand to volumeToFilerto MigrateWithStorageAnswer answer MigrateWithStorageAnswer agentMgr send destHost getId command if answer null s_logger error vm throw new CloudRuntimeException vm destHost else if answer getResult s_logger error vm answer getDetails throw new CloudRuntimeException vm destHost answer getDetails else updateVolumePathsAfterMigration volumeToPool answer getVolumeTos srcHost return answer catch OperationTimedoutException e
if volumeInfo getId volumeTo getId if storagePool isManaged handleManagedVolumePostMigration volumeInfo srcHost volumeTo else VolumeVO volumeVO volDao findById volumeInfo getId Long oldPoolId volumeVO getPoolId volumeVO setPath volumeTo getPath volumeVO setFolder storagePool getPath volumeVO setPodId storagePool getPodId volumeVO setPoolId storagePool getId volumeVO setLastPoolId oldPoolId volDao update volumeInfo getId volumeVO updated true break if updated
final Account caller CallContext current getCallingAccount final Domain domain domainDao findById caller getDomainId String user caller getUuid String group domain getUuid if caller getAccountName equals caller getRoleId RoleType Admin getId user CloudianCmcAdminUser value group LOG debug String format user group final CloudianUser ssoUser getClient listUser user group if ssoUser null ssoUser getActive LOG debug String format user group final CloudianGroup ssoGroup getClient listGroup group if ssoGroup null LOG debug String format group if addGroup domain
String group domain getUuid if caller getAccountName equals caller getRoleId RoleType Admin getId user CloudianCmcAdminUser value group LOG debug String format user group final CloudianUser ssoUser getClient listUser user group if ssoUser null ssoUser getActive LOG debug String format user group final CloudianGroup ssoGroup getClient listGroup group if ssoGroup null LOG debug String format group if addGroup domain LOG error group throw new ServerApiException ApiErrorCode INTERNAL_ERROR if addUserAccount caller domain
LOG debug String format user group final CloudianGroup ssoGroup getClient listGroup group if ssoGroup null LOG debug String format group if addGroup domain LOG error group throw new ServerApiException ApiErrorCode INTERNAL_ERROR if addUserAccount caller domain LOG error group throw new ServerApiException ApiErrorCode INTERNAL_ERROR final CloudianUser addedSsoUser getClient listUser user group if addedSsoUser null addedSsoUser getActive throw new ServerApiException ApiErrorCode INTERNAL_ERROR else if group equals updateUserAccount caller domain ssoUser
super configure name params if isEnabled LOG debug return true LOG debug String format CloudianAdminHost value CloudianAdminPort value CloudianAdminUser value messageBus subscribe AccountManager MESSAGE_ADD_ACCOUNT_EVENT new MessageSubscriber Override public void onPublishMessage String senderAddress String subject Object args try final Map Long Long accountGroupMap Map Long Long args final Long accountId accountGroupMap keySet iterator next final Account account accountDao findById accountId final Domain domain domainDao findById account getDomainId if addUserAccount account domain LOG warn String format account getAccountName domain getPath catch final Exception e
final Map Long Long accountGroupMap Map Long Long args final Long accountId accountGroupMap keySet iterator next final Account account accountDao findById accountId final Domain domain domainDao findById account getDomainId if addUserAccount account domain LOG warn String format account getAccountName domain getPath catch final Exception e LOG error e messageBus subscribe AccountManager MESSAGE_REMOVE_ACCOUNT_EVENT new MessageSubscriber Override public void onPublishMessage String senderAddress String subject Object args try final Account account accountDao findByIdIncludingRemoved Long args if removeUserAccount account LOG warn String format account getAccountName account getId
LOG error e messageBus subscribe AccountManager MESSAGE_REMOVE_ACCOUNT_EVENT new MessageSubscriber Override public void onPublishMessage String senderAddress String subject Object args try final Account account accountDao findByIdIncludingRemoved Long args if removeUserAccount account LOG warn String format account getAccountName account getId catch final Exception e LOG error e messageBus subscribe DomainManager MESSAGE_ADD_DOMAIN_EVENT new MessageSubscriber Override public void onPublishMessage String senderAddress String subject Object args try final Domain domain domainDao findById Long args
if removeUserAccount account LOG warn String format account getAccountName account getId catch final Exception e LOG error e messageBus subscribe DomainManager MESSAGE_ADD_DOMAIN_EVENT new MessageSubscriber Override public void onPublishMessage String senderAddress String subject Object args try final Domain domain domainDao findById Long args if addGroup domain LOG warn String format domain getPath domain getId catch final Exception e LOG error e messageBus subscribe DomainManager MESSAGE_REMOVE_DOMAIN_EVENT new MessageSubscriber
private void checkAuthFailure final HttpResponse response if response null response getStatusLine getStatusCode HttpStatus SC_UNAUTHORIZED final Credentials credentials httpContext getCredentialsProvider getCredentials AuthScope ANY
throw new InvalidParameterValueException String format network getUuid List FirewallRuleVO rules firewallRulesDao listByIpAndPurposeAndNotRevoked sourceNatIp getId FirewallRule Purpose Firewall for FirewallRuleVO rule rules Integer startPort rule getSourcePortStart Integer endPort rule getSourcePortEnd if LOGGER isDebugEnabled LOGGER debug startPort endPort if startPort KubernetesClusterActionWorker CLUSTER_API_PORT KubernetesClusterActionWorker CLUSTER_API_PORT endPort throw new InvalidParameterValueException String format network getUuid if startPort KubernetesClusterActionWorker CLUSTER_NODES_DEFAULT_START_SSH_PORT KubernetesClusterActionWorker CLUSTER_NODES_DEFAULT_START_SSH_PORT clusterTotalNodeCount endPort throw new InvalidParameterValueException String format network getUuid rules firewallRulesDao listByIpAndPurposeAndNotRevoked sourceNatIp getId FirewallRule Purpose PortForwarding for FirewallRuleVO rule rules Integer startPort rule getSourcePortStart Integer endPort rule getSourcePortEnd
for int i i nodesCount i suitable_host_found false for Map Entry String Pair HostVO Integer hostEntry hosts_with_resevered_capacity entrySet Pair HostVO Integer hp hostEntry getValue HostVO h hp first hostDao loadHostTags h if Strings isNullOrEmpty offering getHostTag h getHostTags null h getHostTags contains offering getHostTag continue int reserved hp second reserved ClusterVO cluster clusterDao findById h getClusterId ClusterDetailsVO cluster_detail_cpu clusterDetailsDao findDetail cluster getId ClusterDetailsVO cluster_detail_ram clusterDetailsDao findDetail cluster getId Float cpuOvercommitRatio Float parseFloat cluster_detail_cpu getValue Float memoryOvercommitRatio Float parseFloat cluster_detail_ram getValue
Pair HostVO Integer hp hostEntry getValue HostVO h hp first hostDao loadHostTags h if Strings isNullOrEmpty offering getHostTag h getHostTags null h getHostTags contains offering getHostTag continue int reserved hp second reserved ClusterVO cluster clusterDao findById h getClusterId ClusterDetailsVO cluster_detail_cpu clusterDetailsDao findDetail cluster getId ClusterDetailsVO cluster_detail_ram clusterDetailsDao findDetail cluster getId Float cpuOvercommitRatio Float parseFloat cluster_detail_cpu getValue Float memoryOvercommitRatio Float parseFloat cluster_detail_ram getValue if LOGGER isDebugEnabled LOGGER debug String format h getUuid reserved if capacityManager checkIfHostHasCapacity h getId cpu_requested reserved ram_requested reserved false cpuOvercommitRatio memoryOvercommitRatio true
Float cpuOvercommitRatio Float parseFloat cluster_detail_cpu getValue Float memoryOvercommitRatio Float parseFloat cluster_detail_ram getValue if LOGGER isDebugEnabled LOGGER debug String format h getUuid reserved if capacityManager checkIfHostHasCapacity h getId cpu_requested reserved ram_requested reserved false cpuOvercommitRatio memoryOvercommitRatio true if LOGGER isDebugEnabled LOGGER debug String format h getUuid cpu_requested reserved toHumanReadableSize ram_requested reserved hostEntry setValue new Pair HostVO Integer h reserved suitable_host_found true planCluster cluster break if suitable_host_found if LOGGER isInfoEnabled LOGGER info String format zone getUuid i offering getUuid break
if Network GuestType Isolated equals network getGuestType if kubernetesClusterDao listByNetworkId network getId isEmpty if validateNetwork network masterNodesCount nodesCount throw new InvalidParameterValueException String format network getUuid networkModel checkNetworkPermissions owner network else throw new InvalidParameterValueException String format network getUuid else if Network GuestType Shared equals network getGuestType if masterNodesCount Strings isNullOrEmpty externalLoadBalancerIpAddress throw new InvalidParameterValueException String format network getGuestType toString network getUuid ApiConstants EXTERNAL_LOAD_BALANCER_IP_ADDRESS else NetworkOfferingVO networkOffering networkOfferingDao findByUniqueName KubernetesClusterNetworkOffering value long physicalNetworkId networkModel findPhysicalNetworkId zone getId networkOffering getTags networkOffering getTrafficType PhysicalNetwork physicalNetwork physicalNetworkDao findById physicalNetworkId if LOGGER isInfoEnabled
catch InsufficientCapacityException e logAndThrow Level ERROR String format totalNodeCount zone getUuid serviceOffering getUuid if deployDestination null deployDestination getCluster null logAndThrow Level ERROR String format zone getUuid final Network defaultNetwork getKubernetesClusterNetworkIfMissing cmd getName zone owner int masterNodeCount int clusterSize cmd getExternalLoadBalancerIpAddress cmd getNetworkId final VMTemplateVO finalTemplate getKubernetesServiceTemplate deployDestination getCluster getHypervisorType final long cores serviceOffering getCpu masterNodeCount clusterSize final long memory serviceOffering getRamSize masterNodeCount clusterSize final KubernetesClusterVO cluster Transaction execute new TransactionCallback KubernetesClusterVO Override public KubernetesClusterVO doInTransaction TransactionStatus status KubernetesClusterVO newCluster new KubernetesClusterVO cmd getName cmd getDisplayName zone getId clusterKubernetesVersion getId serviceOffering getId finalTemplate getId defaultNetwork getId owner getDomainId owner getAccountId masterNodeCount clusterSize KubernetesCluster State Created cmd getSSHKeyPairName cores memory cmd getNodeRootDiskSize kubernetesClusterDao persist newCluster return newCluster addKubernetesClusterDetails cluster defaultNetwork cmd
Override public boolean startKubernetesCluster long kubernetesClusterId boolean onCreate throws CloudRuntimeException if KubernetesServiceEnabled value logAndThrow Level ERROR final KubernetesClusterVO kubernetesCluster kubernetesClusterDao findById kubernetesClusterId if kubernetesCluster null throw new InvalidParameterValueException if kubernetesCluster getRemoved null throw new InvalidParameterValueException String format kubernetesCluster getUuid accountManager checkAccess CallContext current getCallingAccount SecurityChecker AccessType OperateEntry false kubernetesCluster if kubernetesCluster getState equals KubernetesCluster State Running if LOGGER isDebugEnabled LOGGER debug String format kubernetesCluster getUuid return true if kubernetesCluster getState equals KubernetesCluster State Starting if LOGGER isDebugEnabled
Override public boolean stopKubernetesCluster long kubernetesClusterId throws CloudRuntimeException if KubernetesServiceEnabled value logAndThrow Level ERROR final KubernetesClusterVO kubernetesCluster kubernetesClusterDao findById kubernetesClusterId if kubernetesCluster null throw new InvalidParameterValueException if kubernetesCluster getRemoved null throw new InvalidParameterValueException String format kubernetesCluster getUuid accountManager checkAccess CallContext current getCallingAccount SecurityChecker AccessType OperateEntry false kubernetesCluster if kubernetesCluster getState equals KubernetesCluster State Stopped if LOGGER isDebugEnabled LOGGER debug String format kubernetesCluster getUuid return true if kubernetesCluster getState equals KubernetesCluster State Stopping if LOGGER isDebugEnabled
boolean isClusterVMsInDesiredState KubernetesCluster kubernetesCluster VirtualMachine State state List KubernetesClusterVmMapVO clusterVMs kubernetesClusterVmMapDao listByClusterId kubernetesCluster getId if clusterVMs size kubernetesCluster getTotalNodeCount if LOGGER isDebugEnabled
protected void logMessage final Level logLevel final String message final Exception e if logLevel Level INFO if LOGGER isInfoEnabled if e null
else LOGGER info message else if logLevel Level DEBUG if LOGGER isDebugEnabled if e null LOGGER debug message e else LOGGER debug message else if logLevel Level WARN if e null LOGGER warn message e else LOGGER warn message else if e null
LOGGER info message else if logLevel Level DEBUG if LOGGER isDebugEnabled if e null LOGGER debug message e else LOGGER debug message else if logLevel Level WARN if e null LOGGER warn message e else LOGGER warn message else if e null LOGGER error message e
KubernetesCluster cluster kubernetesClusterDao findById kubernetesCluster getId if cluster null cluster getState KubernetesCluster State Starting failedEvent KubernetesCluster Event CreateFailed if version null logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId failedEvent VMTemplateVO iso templateDao findById version getIsoId if iso null logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId failedEvent if iso getFormat equals Storage ImageFormat ISO logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId failedEvent if iso getState equals VirtualMachineTemplate State Active logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId failedEvent for UserVm vm clusterVMs try templateService attachIso iso getId vm getId
if cleanupNetwork NetworkVO network networkDao findById kubernetesCluster getNetworkId if network null logAndThrow Level ERROR String format kubernetesCluster getUuid List VMInstanceVO networkVMs vmInstanceDao listNonRemovedVmsByTypeAndNetwork network getId VirtualMachine Type User if networkVMs size clusterVMs size logAndThrow Level ERROR String format network getUuid kubernetesCluster getUuid for VMInstanceVO vm networkVMs boolean vmFoundInKubernetesCluster false for KubernetesClusterVmMap clusterVM clusterVMs if vm getId clusterVM getVmId vmFoundInKubernetesCluster true break if vmFoundInKubernetesCluster logAndThrow Level ERROR String format vm getUuid kubernetesCluster getUuid network getUuid
catch ManagementServerException e String msg String format kubernetesCluster getUuid LOGGER warn msg e updateKubernetesClusterEntryForGC throw new CloudRuntimeException msg e else try deleteKubernetesClusterNetworkRules catch ManagementServerException e String msg String format kubernetesCluster getUuid LOGGER warn msg e updateKubernetesClusterEntryForGC throw new CloudRuntimeException msg e else String msg String format kubernetesCluster getUuid
for Map Entry String Pair HostVO Integer hostEntry hosts_with_resevered_capacity entrySet Pair HostVO Integer hp hostEntry getValue HostVO h hp first if h getHypervisorType equals clusterTemplate getHypervisorType continue hostDao loadHostTags h if Strings isNullOrEmpty offering getHostTag h getHostTags null h getHostTags contains offering getHostTag continue int reserved hp second reserved ClusterVO cluster clusterDao findById h getClusterId ClusterDetailsVO cluster_detail_cpu clusterDetailsDao findDetail cluster getId ClusterDetailsVO cluster_detail_ram clusterDetailsDao findDetail cluster getId Float cpuOvercommitRatio Float parseFloat cluster_detail_cpu getValue Float memoryOvercommitRatio Float parseFloat cluster_detail_ram getValue
if h getHypervisorType equals clusterTemplate getHypervisorType continue hostDao loadHostTags h if Strings isNullOrEmpty offering getHostTag h getHostTags null h getHostTags contains offering getHostTag continue int reserved hp second reserved ClusterVO cluster clusterDao findById h getClusterId ClusterDetailsVO cluster_detail_cpu clusterDetailsDao findDetail cluster getId ClusterDetailsVO cluster_detail_ram clusterDetailsDao findDetail cluster getId Float cpuOvercommitRatio Float parseFloat cluster_detail_cpu getValue Float memoryOvercommitRatio Float parseFloat cluster_detail_ram getValue if LOGGER isDebugEnabled LOGGER debug String format h getUuid reserved if capacityManager checkIfHostHasCapacity h getId cpu_requested reserved ram_requested reserved false cpuOvercommitRatio memoryOvercommitRatio true
ClusterDetailsVO cluster_detail_cpu clusterDetailsDao findDetail cluster getId ClusterDetailsVO cluster_detail_ram clusterDetailsDao findDetail cluster getId Float cpuOvercommitRatio Float parseFloat cluster_detail_cpu getValue Float memoryOvercommitRatio Float parseFloat cluster_detail_ram getValue if LOGGER isDebugEnabled LOGGER debug String format h getUuid reserved if capacityManager checkIfHostHasCapacity h getId cpu_requested reserved ram_requested reserved false cpuOvercommitRatio memoryOvercommitRatio true if LOGGER isDebugEnabled LOGGER debug String format h getUuid cpu_requested reserved toHumanReadableSize ram_requested reserved hostEntry setValue new Pair HostVO Integer h reserved suitable_host_found true break if suitable_host_found if LOGGER isInfoEnabled LOGGER info String format zone getUuid i offering getUuid clusterTemplate getHypervisorType toString
protected DeployDestination plan throws InsufficientServerCapacityException ServiceOffering offering serviceOfferingDao findById kubernetesCluster getServiceOfferingId DataCenter zone dataCenterDao findById kubernetesCluster getZoneId if LOGGER isDebugEnabled
protected void startKubernetesVM final UserVm vm throws ManagementServerException try StartVMCmd startVm new StartVMCmd startVm ComponentContext inject startVm Field f startVm getClass getDeclaredField f setAccessible true f set startVm vm getId userVmService startVirtualMachine startVm if LOGGER isInfoEnabled
Account owner accountDao findById kubernetesCluster getAccountId Network IpAddresses addrs new Network IpAddresses null null long rootDiskSize kubernetesCluster getNodeRootDiskSize Map String String customParameterMap new HashMap String String if rootDiskSize customParameterMap put String valueOf rootDiskSize String hostName getKubernetesClusterNodeAvailableName String format kubernetesClusterNodeNamePrefix nodeInstance String k8sNodeConfig null try k8sNodeConfig getKubernetesNodeConfig joinIp Hypervisor HypervisorType VMware equals clusterTemplate getHypervisorType catch IOException e logAndThrow Level ERROR e String base64UserData Base64 encodeBase64String k8sNodeConfig getBytes StringUtils getPreferredCharset nodeVm userVmService createAdvancedVirtualMachine zone serviceOffering clusterTemplate networkIds owner hostName hostName null null null Hypervisor HypervisorType None BaseCmd HTTPMethod POST base64UserData kubernetesCluster getKeyPair null addrs null null null customParameterMap null null null null if LOGGER isInfoEnabled
long vmId clusterVMIds get i Nic vmNic networkModel getNicInNetwork vmId networkId final Ip vmIp new Ip vmNic getIPv4Address final long vmIdFinal vmId final int srcPortFinal firewallRuleSourcePortStart i PortForwardingRuleVO pfRule Transaction execute new TransactionCallbackWithException PortForwardingRuleVO NetworkRuleConflictException Override public PortForwardingRuleVO doInTransaction TransactionStatus status throws NetworkRuleConflictException PortForwardingRuleVO newRule new PortForwardingRuleVO null publicIpId srcPortFinal srcPortFinal vmIp networkId accountId domainId vmIdFinal newRule setDisplay true newRule setState FirewallRule State Add newRule portForwardingRulesDao persist newRule return newRule rulesService applyPortForwardingRules publicIp getId account if LOGGER isInfoEnabled
private void scaleKubernetesClusterNetworkRules final List Long clusterVMIds final List Long removedVMIds throws ManagementServerException if Network GuestType Isolated equals network getGuestType if LOGGER isDebugEnabled
if Network GuestType Isolated equals network getGuestType if LOGGER isDebugEnabled LOGGER debug String format network getUuid kubernetesCluster getUuid return IpAddress publicIp getSourceNatIp network if publicIp null throw new ManagementServerException String format network getUuid kubernetesCluster getUuid FirewallRule firewallRule removeSshFirewallRule publicIp if firewallRule null throw new ManagementServerException int existingFirewallRuleSourcePortEnd firewallRule getSourcePortEnd final int scaledTotalNodeCount clusterSize null int kubernetesCluster getTotalNodeCount int clusterSize kubernetesCluster getMasterNodeCount try provisionFirewallRules publicIp owner CLUSTER_NODES_DEFAULT_START_SSH_PORT CLUSTER_NODES_DEFAULT_START_SSH_PORT scaledTotalNodeCount if LOGGER isDebugEnabled
Pair Boolean String result SshHelper sshExecute ipAddress port CLUSTER_NODE_VM_USER pkFile null String format hostName if result first LOGGER warn String format hostName userVm getUuid kubernetesCluster getUuid else result SshHelper sshExecute ipAddress port CLUSTER_NODE_VM_USER pkFile null String format hostName if result first return true else LOGGER warn String format hostName userVm getUuid kubernetesCluster getUuid break catch Exception e String msg String format kubernetesCluster getUuid hostName userVm getUuid LOGGER warn msg e try Thread sleep waitDuration
Map String String customParameterMap new HashMap String String if rootDiskSize customParameterMap put String valueOf rootDiskSize String hostName kubernetesClusterNodeNamePrefix if kubernetesCluster getMasterNodeCount hostName hostName getKubernetesClusterNodeAvailableName hostName boolean haSupported isKubernetesVersionSupportsHA String k8sMasterConfig null try k8sMasterConfig getKubernetesMasterConfig masterIp serverIp hostName haSupported Hypervisor HypervisorType VMware equals clusterTemplate getHypervisorType catch IOException e logAndThrow Level ERROR e String base64UserData Base64 encodeBase64String k8sMasterConfig getBytes StringUtils getPreferredCharset masterVm userVmService createAdvancedVirtualMachine zone serviceOffering clusterTemplate networkIds owner hostName hostName null null null Hypervisor HypervisorType None BaseCmd HTTPMethod POST base64UserData kubernetesCluster getKeyPair requestedIps addrs null null null customParameterMap null null null null
networkIds add kubernetesCluster getNetworkId Network IpAddresses addrs new Network IpAddresses null null long rootDiskSize kubernetesCluster getNodeRootDiskSize Map String String customParameterMap new HashMap String String if rootDiskSize customParameterMap put String valueOf rootDiskSize String hostName getKubernetesClusterNodeAvailableName String format kubernetesClusterNodeNamePrefix additionalMasterNodeInstance String k8sMasterConfig null try k8sMasterConfig getKubernetesAdditionalMasterConfig joinIp Hypervisor HypervisorType VMware equals clusterTemplate getHypervisorType catch IOException e logAndThrow Level ERROR e String base64UserData Base64 encodeBase64String k8sMasterConfig getBytes StringUtils getPreferredCharset additionalMasterVm userVmService createAdvancedVirtualMachine zone serviceOffering clusterTemplate networkIds owner hostName hostName null null null Hypervisor HypervisorType None BaseCmd HTTPMethod POST base64UserData kubernetesCluster getKeyPair null addrs null null null customParameterMap null null null null if LOGGER isInfoEnabled
private void setupKubernetesClusterNetworkRules Network network List UserVm clusterVMs throws ManagementServerException if Network GuestType Isolated equals network getGuestType if LOGGER isDebugEnabled
List Long clusterVMIds new ArrayList for UserVm vm clusterVMs clusterVMIds add vm getId IpAddress publicIp getSourceNatIp network if publicIp null throw new ManagementServerException String format network getUuid kubernetesCluster getUuid try provisionFirewallRules publicIp owner CLUSTER_API_PORT CLUSTER_API_PORT if LOGGER isInfoEnabled LOGGER info String format CLUSTER_API_PORT publicIp getAddress addr kubernetesCluster getUuid catch NoSuchFieldException IllegalAccessException ResourceUnavailableException NetworkRuleConflictException e throw new ManagementServerException String format kubernetesCluster getUuid e try int endPort CLUSTER_NODES_DEFAULT_START_SSH_PORT clusterVMs size provisionFirewallRules publicIp owner CLUSTER_NODES_DEFAULT_START_SSH_PORT endPort
try k8sMasterVM provisionKubernetesClusterMasterVm network publicIpAddress catch CloudRuntimeException ManagementServerException ResourceUnavailableException InsufficientCapacityException e logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event CreateFailed e clusterVMs add k8sMasterVM if Strings isNullOrEmpty publicIpAddress publicIpSshPort getKubernetesClusterServerIpSshPort k8sMasterVM publicIpAddress publicIpSshPort first if Strings isNullOrEmpty publicIpAddress logTransitStateAndThrow Level WARN String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event CreateFailed try List UserVm additionalMasterVMs provisionKubernetesClusterAdditionalMasterVms publicIpAddress clusterVMs addAll additionalMasterVMs catch CloudRuntimeException ManagementServerException ResourceUnavailableException InsufficientCapacityException e logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event CreateFailed e
InetAddress address InetAddress getByName new URL kubernetesCluster getEndpoint getHost catch MalformedURLException UnknownHostException ex logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event OperationFailed Pair String Integer sshIpPort getKubernetesClusterServerIpSshPort null publicIpAddress sshIpPort first sshPort sshIpPort second if Strings isNullOrEmpty publicIpAddress logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event OperationFailed if KubernetesClusterUtil isKubernetesClusterServerRunning kubernetesCluster publicIpAddress CLUSTER_API_PORT startTimeoutTime logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event OperationFailed if isKubernetesClusterKubeConfigAvailable startTimeoutTime logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event OperationFailed if isKubernetesClusterDashboardServiceRunning false startTimeoutTime logTransitStateAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster getId KubernetesCluster Event OperationFailed stateTransitTo kubernetesCluster getId KubernetesCluster Event OperationSucceeded
if result first logTransitStateDetachIsoAndThrow Level ERROR String format kubernetesCluster getUuid vm getUuid kubernetesCluster clusterVMs KubernetesCluster Event OperationFailed null if System currentTimeMillis upgradeTimeoutTime logTransitStateDetachIsoAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster clusterVMs KubernetesCluster Event OperationFailed null try result runInstallScriptOnVM vm i catch Exception e logTransitStateDetachIsoAndThrow Level ERROR String format kubernetesCluster getUuid vm getUuid kubernetesCluster clusterVMs KubernetesCluster Event OperationFailed e if result first logTransitStateDetachIsoAndThrow Level ERROR String format kubernetesCluster getUuid vm getUuid kubernetesCluster clusterVMs KubernetesCluster Event OperationFailed null if System currentTimeMillis upgradeTimeoutTime logTransitStateDetachIsoAndThrow Level ERROR String format kubernetesCluster getUuid kubernetesCluster clusterVMs KubernetesCluster Event OperationFailed null if KubernetesClusterUtil uncordonKubernetesClusterNode kubernetesCluster publicIpAddress sshPort CLUSTER_NODE_VM_USER getManagementServerSshPublicKeyFile vm upgradeTimeoutTime logTransitStateDetachIsoAndThrow Level ERROR String format kubernetesCluster getUuid vm getUuid kubernetesCluster clusterVMs KubernetesCluster Event OperationFailed null if i
public static boolean isKubernetesClusterDashboardServiceRunning final KubernetesCluster kubernetesCluster String ipAddress final int port final String user final File sshKeyFile final long timeoutTime final long waitDuration boolean running false while System currentTimeMillis timeoutTime if LOGGER isDebugEnabled
public static boolean isKubernetesClusterServerRunning final KubernetesCluster kubernetesCluster final String ipAddress final int port final long timeoutTime final long waitDuration boolean k8sApiServerSetup false while System currentTimeMillis timeoutTime try String versionOutput IOUtils toString new URL String format ipAddress port StringUtils getPreferredCharset if Strings isNullOrEmpty versionOutput if LOGGER isInfoEnabled
public static boolean isKubernetesClusterServerRunning final KubernetesCluster kubernetesCluster final String ipAddress final int port final long timeoutTime final long waitDuration boolean k8sApiServerSetup false while System currentTimeMillis timeoutTime try String versionOutput IOUtils toString new URL String format ipAddress port StringUtils getPreferredCharset if Strings isNullOrEmpty versionOutput if LOGGER isInfoEnabled LOGGER info String format kubernetesCluster getUuid versionOutput k8sApiServerSetup true break catch Exception e LOGGER warn String format kubernetesCluster getUuid e try Thread sleep waitDuration catch InterruptedException ie
public static boolean validateKubernetesClusterReadyNodesCount final KubernetesCluster kubernetesCluster final String ipAddress final int port final String user final File sshKeyFile final long timeoutTime final long waitDuration while System currentTimeMillis timeoutTime if LOGGER isDebugEnabled
if minimumRamSize null minimumRamSize KubernetesClusterService MIN_KUBERNETES_CLUSTER_NODE_RAM_SIZE throw new InvalidParameterValueException String format ApiConstants MIN_MEMORY if compareSemanticVersions semanticVersion MIN_KUBERNETES_VERSION throw new InvalidParameterValueException String format MIN_KUBERNETES_VERSION if zoneId null dataCenterDao findById zoneId null throw new InvalidParameterValueException if Strings isNullOrEmpty isoUrl throw new InvalidParameterValueException String format isoUrl if Strings isNullOrEmpty name name String format semanticVersion if zoneId null name String format name dataCenterDao findById zoneId getName VMTemplateVO template null try VirtualMachineTemplate vmTemplate registerKubernetesVersionIso zoneId name isoUrl isoChecksum
throw new CloudRuntimeException final Long versionId cmd getId KubernetesSupportedVersion version kubernetesSupportedVersionDao findById versionId if version null throw new InvalidParameterValueException List KubernetesClusterVO clusters kubernetesClusterDao listAllByKubernetesVersion versionId if clusters size throw new CloudRuntimeException String format version getUuid VMTemplateVO template templateDao findByIdIncludingRemoved version getIsoId if template null LOGGER warn String format version getUuid if template null template getRemoved null try deleteKubernetesVersionIso template getId catch IllegalAccessException NoSuchFieldException IllegalArgumentException ex
if EnablePrometheusExporter value try httpServer HttpServer create new InetSocketAddress PrometheusExporterServerPort value httpServer createContext new ExporterHandler prometheusExporter httpServer createContext new HttpHandler Override public void handle HttpExchange httpExchange throws IOException final String response httpExchange sendResponseHeaders response length final OutputStream os httpExchange getResponseBody os write response getBytes os close httpServer start LOG debug catch final IOException e
if m getStatusCode HttpStatus SC_CONFLICT if m GetMethod return HASH_CONFLICT throw new BigSwitchBcfApiException true if m getStatusCode HttpStatus SC_SEE_OTHER isMaster false set_hash HASH_IGNORE return HASH_IGNORE if m getStatusCode HttpStatus SC_NOT_FOUND if m DeleteMethod return if m getStatusCode HttpStatus SC_BAD_REQUEST customErrorMsg throw new IllegalArgumentException customErrorMsg String errorMessage responseToErrorMessage m
SuppressWarnings protected T T executeRetrieveObject final Type returnObjectType final String uri final Map String String parameters throws BigSwitchBcfApiException checkInvariants GetMethod gm GetMethod createMethod uri _port setHttpHeader gm if parameters null parameters isEmpty List NameValuePair nameValuePairs new ArrayList NameValuePair parameters size for Entry String String e parameters entrySet nameValuePairs add new NameValuePair e getKey e getValue gm setQueryString nameValuePairs toArray new NameValuePair executeMethod gm String hash checkResponse gm T returnValue try returnValue T gson fromJson gm getResponseBodyAsString returnObjectType catch IOException e
private boolean canHandle Network network Service service
_bcfUtils listACLbyNetwork network Vpc vpc null if network getVpcId null vpc _vpcDao acquireInLockTable network getVpcId String tenantId if vpc null tenantId vpc getUuid _vpcDao releaseFromLockTable vpc getId else tenantId network getUuid for StaticNat rule rules String srcIp _ipAddressDao findById rule getSourceIpAddressId getAddress addr String dstIp rule getDestIpAddress String mac rule getSourceMacAddress if rule isForRevoke
String tenantId if vpc null tenantId vpc getUuid _vpcDao releaseFromLockTable vpc getId else tenantId network getUuid for StaticNat rule rules String srcIp _ipAddressDao findById rule getSourceIpAddressId getAddress addr String dstIp rule getDestIpAddress String mac rule getSourceMacAddress if rule isForRevoke s_logger debug srcIp dstIp mac CreateBcfStaticNatCommand cmd new CreateBcfStaticNatCommand tenantId network getUuid dstIp srcIp mac _bcfUtils sendBcfCommandWithNetworkSyncCheck cmd network else
if initTopologySyncDone _latestTopology null initTopologySyncDone true if _bigswitchBcfApi isNatEnabled try executeRequest new SyncBcfTopologyCommand true true _numRetries catch Exception e s_logger error e else try executeRequest new SyncBcfTopologyCommand true false _numRetries catch Exception e s_logger error e try ControlClusterStatus ccs _bigswitchBcfApi getControlClusterStatus if ccs getStatus
try executeRequest new SyncBcfTopologyCommand true false _numRetries catch Exception e s_logger error e try ControlClusterStatus ccs _bigswitchBcfApi getControlClusterStatus if ccs getStatus s_logger error ccs getStatus return null if ccs isTopologySyncRequested if _latestTopology null if _bigswitchBcfApi isNatEnabled executeRequest new SyncBcfTopologyCommand true true _numRetries else executeRequest new SyncBcfTopologyCommand true false _numRetries
s_logger error ccs getStatus return null if ccs isTopologySyncRequested if _latestTopology null if _bigswitchBcfApi isNatEnabled executeRequest new SyncBcfTopologyCommand true true _numRetries else executeRequest new SyncBcfTopologyCommand true false _numRetries else s_logger debug catch BigSwitchBcfApiException e s_logger error e return null try Capabilities cap _bigswitchBcfApi getCapabilities
else if cmd CreateBcfRouterCommand _latestTopology CreateBcfRouterCommand cmd getTopology return executeRequest CreateBcfRouterCommand cmd numRetries else if cmd CreateBcfRouterInterfaceCommand _latestTopology CreateBcfRouterInterfaceCommand cmd getTopology return executeRequest CreateBcfRouterInterfaceCommand cmd numRetries else if cmd CreateBcfStaticNatCommand _latestTopology CreateBcfStaticNatCommand cmd getTopology return executeRequest CreateBcfStaticNatCommand cmd numRetries else if cmd DeleteBcfStaticNatCommand _latestTopology DeleteBcfStaticNatCommand cmd getTopology return executeRequest DeleteBcfStaticNatCommand cmd numRetries else if cmd UpdateBcfRouterCommand _latestTopology UpdateBcfRouterCommand cmd getTopology return executeRequest UpdateBcfRouterCommand cmd numRetries
final boolean result true if _host null _host isEmpty _adminuser null _adminuser isEmpty _adminpass null _adminpass isEmpty throw new BrocadeVcsApiException final HttpPatch pm HttpPatch createMethod uri pm setHeader pm setEntity new StringEntity convertToString newObject ContentType APPLICATION_XML final HttpResponse response executeMethod pm if response getStatusLine getStatusCode HttpStatus SC_NO_CONTENT String errorMessage try errorMessage responseToErrorMessage response catch final IOException e s_logger error e getMessage throw new BrocadeVcsApiException e getMessage pm releaseConnection
protected Output convertToXML String object throws BrocadeVcsApiException Output output null try final JAXBContext context JAXBContext newInstance Output class final StringReader reader new StringReader object final Unmarshaller unmarshaller context createUnmarshaller final Object result unmarshaller unmarshal reader if result Output output Output result
if _host null _host isEmpty _adminuser null _adminuser isEmpty _adminpass null _adminpass isEmpty throw new BrocadeVcsApiException final boolean result true final HttpPost pm HttpPost createMethod uri pm setHeader pm setEntity new StringEntity convertToString newObject ContentType APPLICATION_XML final HttpResponse response executeMethod pm if response getStatusLine getStatusCode HttpStatus SC_CREATED String errorMessage try errorMessage responseToErrorMessage response catch final IOException e s_logger error e getMessage throw new BrocadeVcsApiException e getMessage pm releaseConnection
throw new BrocadeVcsApiException String readLine null StringBuffer sb null final HttpPost pm HttpPost createMethod uri pm setHeader pm setEntity new StringEntity ContentType APPLICATION_XML final HttpResponse response executeMethod pm if response getStatusLine getStatusCode HttpStatus SC_OK String errorMessage try errorMessage responseToErrorMessage response catch final IOException e s_logger error e getMessage throw new BrocadeVcsApiException e getMessage pm releaseConnection
if response getStatusLine getStatusCode HttpStatus SC_OK String errorMessage try errorMessage responseToErrorMessage response catch final IOException e s_logger error e getMessage throw new BrocadeVcsApiException e getMessage pm releaseConnection s_logger error errorMessage throw new BrocadeVcsApiException errorMessage try BufferedReader br new BufferedReader new InputStreamReader response getEntity getContent Charset forName sb new StringBuffer while readLine br readLine null s_logger debug readLine sb append readLine
protected boolean canHandle Network network Service service
Override public boolean implement Network network NetworkOffering offering DeployDestination dest ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException
Override public void reserve NicProfile nic Network network VirtualMachineProfile vm DeployDestination dest ReservationContext context throws InsufficientVirtualNetworkCapacityException InsufficientAddressCapacityException super reserve nic network vm dest context DataCenter dc _dcDao findById network getDataCenterId String interfaceMac nic getMacAddress List BrocadeVcsDeviceVO devices _brocadeVcsDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty
Override public void deallocate Network network NicProfile nic VirtualMachineProfile vm String interfaceMac nic getMacAddress List BrocadeVcsDeviceVO devices _brocadeVcsDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty
if brocadeVcsNetworkVlanMapping null vlanTag brocadeVcsNetworkVlanMapping getVlanId else s_logger error network getId return false List BrocadeVcsDeviceVO devices _brocadeVcsDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty s_logger error network getPhysicalNetworkId return false for BrocadeVcsDeviceVO brocadeVcsDevice devices HostVO brocadeVcsHost _hostDao findById brocadeVcsDevice getHostId DeleteNetworkCommand cmd new DeleteNetworkCommand vlanTag network getId DeleteNetworkAnswer answer DeleteNetworkAnswer _agentMgr easySend brocadeVcsHost getId cmd if answer null answer getResult s_logger error
Override public boolean implement final Network network final NetworkOffering offering final DeployDestination dest final ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException final DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Basic
if zone getNetworkType NetworkType Basic s_logger debug NetworkType Basic return false if canHandle network return false final List CiscoVnmcControllerVO devices _ciscoVnmcDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty s_logger error network getName return false List CiscoAsa1000vDeviceVO asaList _ciscoAsa1000vDao listByPhysicalNetwork network getPhysicalNetworkId if asaList isEmpty s_logger debug network getName return false NetworkAsa1000vMapVO asaForNetwork _networkAsa1000vMapDao findByNetworkId network getId if asaForNetwork null
if canHandle network return false final List CiscoVnmcControllerVO devices _ciscoVnmcDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty s_logger error network getName return false List CiscoAsa1000vDeviceVO asaList _ciscoAsa1000vDao listByPhysicalNetwork network getPhysicalNetworkId if asaList isEmpty s_logger debug network getName return false NetworkAsa1000vMapVO asaForNetwork _networkAsa1000vMapDao findByNetworkId network getId if asaForNetwork null s_logger debug network getName return true if _networkModel isProviderSupportServiceInNetwork network getId Service SourceNat Provider CiscoVnmc
if devices isEmpty s_logger error network getName return false List CiscoAsa1000vDeviceVO asaList _ciscoAsa1000vDao listByPhysicalNetwork network getPhysicalNetworkId if asaList isEmpty s_logger debug network getName return false NetworkAsa1000vMapVO asaForNetwork _networkAsa1000vMapDao findByNetworkId network getId if asaForNetwork null s_logger debug network getName return true if _networkModel isProviderSupportServiceInNetwork network getId Service SourceNat Provider CiscoVnmc s_logger error network getName return false try
NetworkAsa1000vMapVO asaForNetwork _networkAsa1000vMapDao findByNetworkId network getId if asaForNetwork null s_logger debug network getName return true if _networkModel isProviderSupportServiceInNetwork network getId Service SourceNat Provider CiscoVnmc s_logger error network getName return false try CiscoAsa1000vDevice assignedAsa assignAsa1000vToNetwork network if assignedAsa null s_logger error network getName throw new CloudRuntimeException network getName ClusterVO asaCluster _clusterDao findById assignedAsa getClusterId ClusterVSMMapVO clusterVsmMap _clusterVsmMapDao findByClusterId assignedAsa getClusterId if clusterVsmMap null
Account owner context getAccount PublicIp sourceNatIp _ipAddrMgr assignSourceNatIpAddressToGuestNetwork owner network long vlanId Long parseLong BroadcastDomainType getValue network getBroadcastUri List VlanVO vlanVOList _vlanDao listVlansByPhysicalNetworkId network getPhysicalNetworkId List String publicGateways new ArrayList String for VlanVO vlanVO vlanVOList publicGateways add vlanVO getVlanGateway IpAddress outsideIp null List IPAddressVO publicIps _ipAddressDao listByAssociatedNetwork network getId null for IPAddressVO ip publicIps if ip isSourceNat outsideIp ip break if outsideIp null try
List String publicGateways new ArrayList String for VlanVO vlanVO vlanVOList publicGateways add vlanVO getVlanGateway IpAddress outsideIp null List IPAddressVO publicIps _ipAddressDao listByAssociatedNetwork network getId null for IPAddressVO ip publicIps if ip isSourceNat outsideIp ip break if outsideIp null try Account caller CallContext current getCallingAccount long callerUserId CallContext current getCallingUserId outsideIp _ipAddrMgr allocateIp owner false caller callerUserId zone true null catch ResourceAllocationException e
IpAddress outsideIp null List IPAddressVO publicIps _ipAddressDao listByAssociatedNetwork network getId null for IPAddressVO ip publicIps if ip isSourceNat outsideIp ip break if outsideIp null try Account caller CallContext current getCallingAccount long callerUserId CallContext current getCallingUserId outsideIp _ipAddrMgr allocateIp owner false caller callerUserId zone true null catch ResourceAllocationException e s_logger error e throw new CloudRuntimeException e try
for IPAddressVO ip publicIps if ip isSourceNat outsideIp ip break if outsideIp null try Account caller CallContext current getCallingAccount long callerUserId CallContext current getCallingUserId outsideIp _ipAddrMgr allocateIp owner false caller callerUserId zone true null catch ResourceAllocationException e s_logger error e throw new CloudRuntimeException e try outsideIp _ipAddrMgr associateIPToGuestNetwork outsideIp getId network getId true catch ResourceAllocationException e
break if outsideIp null try Account caller CallContext current getCallingAccount long callerUserId CallContext current getCallingUserId outsideIp _ipAddrMgr allocateIp owner false caller callerUserId zone true null catch ResourceAllocationException e s_logger error e throw new CloudRuntimeException e try outsideIp _ipAddrMgr associateIPToGuestNetwork outsideIp getId network getId true catch ResourceAllocationException e s_logger error outsideIp getAddress addr vlanId e throw new CloudRuntimeException outsideIp getAddress addr vlanId e String gatewayNetmask NetUtils getCidrNetmask network getCidr
try Account caller CallContext current getCallingAccount long callerUserId CallContext current getCallingUserId outsideIp _ipAddrMgr allocateIp owner false caller callerUserId zone true null catch ResourceAllocationException e s_logger error e throw new CloudRuntimeException e try outsideIp _ipAddrMgr associateIPToGuestNetwork outsideIp getId network getId true catch ResourceAllocationException e s_logger error outsideIp getAddress addr vlanId e throw new CloudRuntimeException outsideIp getAddress addr vlanId e String gatewayNetmask NetUtils getCidrNetmask network getCidr if createLogicalEdgeFirewall vlanId network getGateway gatewayNetmask outsideIp getAddress addr sourceNatIp getNetmask publicGateways ciscoVnmcHost getId s_logger error network getName
Override public boolean applyFWRules Network network List extends FirewallRule rules throws ResourceUnavailableException if _networkModel isProviderSupportServiceInNetwork network getId Service Firewall Provider CiscoVnmc
Override public boolean applyPFRules Network network List PortForwardingRule rules throws ResourceUnavailableException if _networkModel isProviderSupportServiceInNetwork network getId Service PortForwarding Provider CiscoVnmc
Override public boolean applyStaticNats Network network List extends StaticNat rules throws ResourceUnavailableException if _networkModel isProviderSupportServiceInNetwork network getId Service StaticNat Provider CiscoVnmc
if _connection createTenantVDCNatPolicySet tenant throw new ExecutionException vlanId if _connection createTenantVDCSourceNatPolicy tenant policyIdentifier throw new ExecutionException vlanId if _connection createTenantVDCSourceNatPolicyRef tenant policyIdentifier throw new ExecutionException vlanId if _connection createTenantVDCSourceNatIpPool tenant policyIdentifier cmd getIpAddress getPublicIp throw new ExecutionException vlanId String ipRange getIpRangeFromCidr cmd getContextParam NetworkElementCommand GUEST_NETWORK_CIDR if _connection createTenantVDCSourceNatRule tenant policyIdentifier ipRange ipRange throw new ExecutionException vlanId if _connection associateNatPolicySet tenant throw new ExecutionException vlanId catch ExecutionException e String msg e getMessage
private Answer execute ConfigureNexusVsmForAsaCommand cmd int numRetries String vlanId Long toString cmd getVlanId NetconfHelper helper null List Pair OperationType String params new ArrayList Pair OperationType String params add new Pair OperationType String OperationType addvlanid vlanId try helper new NetconfHelper cmd getVsmIp cmd getVsmUsername cmd getVsmPassword
private Answer execute ConfigureNexusVsmForAsaCommand cmd int numRetries String vlanId Long toString cmd getVlanId NetconfHelper helper null List Pair OperationType String params new ArrayList Pair OperationType String params add new Pair OperationType String OperationType addvlanid vlanId try helper new NetconfHelper cmd getVsmIp cmd getVsmUsername cmd getVsmPassword s_logger debug cmd getVsmIp helper addVServiceNode vlanId cmd getIpAddress
private Answer execute ConfigureNexusVsmForAsaCommand cmd int numRetries String vlanId Long toString cmd getVlanId NetconfHelper helper null List Pair OperationType String params new ArrayList Pair OperationType String params add new Pair OperationType String OperationType addvlanid vlanId try helper new NetconfHelper cmd getVsmIp cmd getVsmUsername cmd getVsmPassword s_logger debug cmd getVsmIp helper addVServiceNode vlanId cmd getIpAddress s_logger debug vlanId helper updatePortProfile cmd getAsaInPortProfile SwitchPortMode access params
private boolean canHandle Network network List LoadBalancingRule rules if network getGuestType Network GuestType Shared network getTrafficType TrafficType Guest
s_logger warn network getId throw new ResourceUnavailableException DataCenter class network getDataCenterId if elbVm getState State Running long sourceIpId _networkModel getPublicIpAddress rules get getSourceIp addr network getDataCenterId getId List LoadBalancerVO lbs _lbDao listByIpAddress sourceIpId List LoadBalancingRule lbRules new ArrayList LoadBalancingRule for LoadBalancerVO lb lbs List LbDestination dstList _lbMgr getExistingDestinations lb getId List LbStickinessPolicy policyList _lbMgr getStickinessPolicies lb getId List LbHealthCheckPolicy hcPolicyList _lbMgr getHealthCheckPolicies lb getId Ip sourceIp _networkModel getPublicIpAddress lb getSourceIpAddressId getAddress LbSslCert sslCert _lbMgr getLbSslCert lb getId LoadBalancingRule loadBalancing new LoadBalancingRule lb dstList policyList hcPolicyList sourceIp sslCert lb getLbProtocol lbRules add loadBalancing return applyLBRules elbVm lbRules network getId
_systemAcct _accountService getSystemAccount _instance configs get if _instance null _instance _mgmtCidr _configDao getValue Config ManagementNetwork key _elasticLbVmRamSize NumbersUtil parseInt configs get Config ElasticLoadBalancerVmMemory key DEFAULT_ELB_VM_RAMSIZE _elasticLbvmCpuMHz NumbersUtil parseInt configs get Config ElasticLoadBalancerVmCpuMhz key DEFAULT_ELB_VM_CPU_MHZ _elasticLbvmNumCpu NumbersUtil parseInt configs get Config ElasticLoadBalancerVmNumVcpu key List ServiceOfferingVO offerings _serviceOfferingDao createSystemServiceOfferings ServiceOffering elbVmDefaultOffUniqueName _elasticLbvmNumCpu _elasticLbVmRamSize _elasticLbvmCpuMHz true null Storage ProvisioningType THIN true null true VirtualMachine Type ElasticLoadBalancerVm true if offerings null offerings size String msg s_logger error msg throw new ConfigurationException msg String enabled _configDao getValue Config ElasticLoadBalancerEnabled key _enabled enabled null false Boolean parseBoolean enabled
_elasticLbvmNumCpu NumbersUtil parseInt configs get Config ElasticLoadBalancerVmNumVcpu key List ServiceOfferingVO offerings _serviceOfferingDao createSystemServiceOfferings ServiceOffering elbVmDefaultOffUniqueName _elasticLbvmNumCpu _elasticLbVmRamSize _elasticLbvmCpuMHz true null Storage ProvisioningType THIN true null true VirtualMachine Type ElasticLoadBalancerVm true if offerings null offerings size String msg s_logger error msg throw new ConfigurationException msg String enabled _configDao getValue Config ElasticLoadBalancerEnabled key _enabled enabled null false Boolean parseBoolean enabled s_logger info _enabled if _enabled String traffType _configDao getValue Config ElasticLoadBalancerNetwork key if equalsIgnoreCase traffType _frontendTrafficType TrafficType Guest else if equalsIgnoreCase traffType _frontendTrafficType TrafficType Public
String msg s_logger error msg throw new ConfigurationException msg String enabled _configDao getValue Config ElasticLoadBalancerEnabled key _enabled enabled null false Boolean parseBoolean enabled s_logger info _enabled if _enabled String traffType _configDao getValue Config ElasticLoadBalancerNetwork key if equalsIgnoreCase traffType _frontendTrafficType TrafficType Guest else if equalsIgnoreCase traffType _frontendTrafficType TrafficType Public else throw new ConfigurationException traffType s_logger info traffType int gcIntervalMinutes NumbersUtil parseInt configs get Config ElasticLoadBalancerVmGcInterval key
private DomainRouterVO stop DomainRouterVO elbVm boolean forced throws ConcurrentOperationException ResourceUnavailableException
void garbageCollectUnusedElbVms List DomainRouterVO unusedElbVms _elbVmMapDao listUnusedElbVms if unusedElbVms null if unusedElbVms size
_gcCandidateElbVmIds retainAll currentGcCandidates currentGcCandidates removeAll _gcCandidateElbVmIds for Long elbVmId _gcCandidateElbVmIds DomainRouterVO elbVm _routerDao findById elbVmId boolean gceed false try s_logger info elbVm stop elbVm true gceed true catch ConcurrentOperationException e s_logger warn elbVm e catch ResourceUnavailableException e s_logger warn elbVm e continue if gceed
else if nic getTrafficType TrafficType Control if dest getHost getHypervisorType HypervisorType VMware if s_logger isInfoEnabled s_logger info dest getPod getCidrAddress dest getPod getCidrSize dest getPod getGateway ApiServiceConfiguration ManagementServerAddresses value if s_logger isDebugEnabled s_logger debug buf append append _mgmtCidr buf append append dest getPod getGateway if dc getNetworkType NetworkType Basic buf append controlNic nic String domain guestNetwork getNetworkDomain if domain null buf append domain buf append append defaultDns1
DataCenterVO dcVo _dcDao findById elbVm getDataCenterId NicProfile controlNic null Long guestNetworkId null if profile getHypervisorType HypervisorType VMware dcVo getNetworkType NetworkType Basic for NicProfile nic profile getNics if nic getTrafficType TrafficType Guest nic getIPv4Address null controlNic nic guestNetworkId nic getNetworkId else for NicProfile nic profile getNics if nic getTrafficType TrafficType Control nic getIPv4Address null controlNic nic else if nic getTrafficType TrafficType Guest guestNetworkId nic getNetworkId if controlNic null
if nic getTrafficType TrafficType Control nic getIPv4Address null controlNic nic else if nic getTrafficType TrafficType Guest guestNetworkId nic getNetworkId if controlNic null s_logger error elbVm return false cmds addCommand new CheckSshCommand profile getInstanceName controlNic getIPv4Address List LoadBalancerVO lbs _elbVmMapDao listLbsForElbVm elbVm getId List LoadBalancingRule lbRules new ArrayList LoadBalancingRule for LoadBalancerVO lb lbs List LbDestination dstList _lbMgr getExistingDestinations lb getId List LbStickinessPolicy policyList _lbMgr getStickinessPolicies lb getId List LbHealthCheckPolicy hcPolicyList _lbMgr getHealthCheckPolicies lb getId Ip sourceIp _networkModel getPublicIpAddress lb getSourceIpAddressId getAddress
public void handleDeleteLoadBalancerRule final LoadBalancer lb final long userId final Account caller final List LoadBalancerVO remainingLbs _loadBalancerDao listByIpAddress lb getSourceIpAddressId if remainingLbs size
private void releaseIp final long ipId final long userId final Account caller
Long ipId null boolean newIp false List LoadBalancerVO existingLbs findExistingLoadBalancers lb getName lb getSourceIpAddressId lb getAccountId lb getDomainId lb getSourcePortStart if existingLbs null existingLbs findExistingLoadBalancers lb getName lb getSourceIpAddressId lb getAccountId lb getDomainId null if existingLbs null if lb getSourceIpAddressId null throwExceptionIfSuppliedlLbNameIsNotAssociatedWithIpAddress lb else s_logger debug final PublicIp ip allocDirectIp account networkId ipId ip getId newIp true else ipId existingLbs get getSourceIpAddressId
DB private PublicIp allocDirectIp final Account account final long guestNetworkId throws InsufficientAddressCapacityException return Transaction execute new TransactionCallbackWithException PublicIp InsufficientAddressCapacityException Override public PublicIp doInTransaction final TransactionStatus status throws InsufficientAddressCapacityException final Network frontEndNetwork _networkModel getNetwork guestNetworkId final PublicIp ip _ipAddrMgr assignPublicIpAddress frontEndNetwork getDataCenterId null account VlanType DirectAttached frontEndNetwork getId null true false final IPAddressVO ipvo _ipAddressDao findById ip getId ipvo setAssociatedWithNetworkId frontEndNetwork getId _ipAddressDao update ipvo getId ipvo
protected DomainRouterVO start final DomainRouterVO elbVm final Map Param Object params throws ConcurrentOperationException
Override public IpDeployer getIpDeployer Network network ExternalLoadBalancerDeviceVO lbDevice getExternalLoadBalancerForNetwork network if lbDevice null
private Answer retry Command cmd int numRetries int numRetriesRemaining numRetries
String results new String cmd getIpAddresses length int i try IpAddressTO ips cmd getIpAddresses for IpAddressTO ip ips long guestVlanTag Long parseLong ip getBroadcastUri boolean inline ip isOneToOneNat String vlanSelfIp inline tagAddressWithRouteDomain ip getVlanGateway guestVlanTag ip getVlanGateway String vlanNetmask ip getVlanNetmask deleteGuestVlan guestVlanTag vlanSelfIp vlanNetmask inline if ip isAdd addGuestVlan guestVlanTag vlanSelfIp vlanNetmask inline saveConfiguration results i ip getPublicIp catch ExecutionException e
private void addGuestVlan long vlanTag String vlanSelfIp String vlanNetmask boolean inline throws ExecutionException try String vlanName genVlanName vlanTag List String allVlans getStrippedVlans if allVlans contains vlanName String vlanNames genStringArray vlanName long vlanTags genLongArray vlanTag CommonEnabledState commonEnabledState CommonEnabledState STATE_DISABLED NetworkingVLANMemberEntry vlanMemberEntries new NetworkingVLANMemberEntry vlanMemberEntries setMember_type NetworkingMemberType MEMBER_INTERFACE vlanMemberEntries setTag_state NetworkingMemberTagType MEMBER_TAGGED vlanMemberEntries setMember_name _privateInterface
private void addGuestVlan long vlanTag String vlanSelfIp String vlanNetmask boolean inline throws ExecutionException try String vlanName genVlanName vlanTag List String allVlans getStrippedVlans if allVlans contains vlanName String vlanNames genStringArray vlanName long vlanTags genLongArray vlanTag CommonEnabledState commonEnabledState CommonEnabledState STATE_DISABLED NetworkingVLANMemberEntry vlanMemberEntries new NetworkingVLANMemberEntry vlanMemberEntries setMember_type NetworkingMemberType MEMBER_INTERFACE vlanMemberEntries setTag_state NetworkingMemberTagType MEMBER_TAGGED vlanMemberEntries setMember_name _privateInterface s_logger debug vlanTag _vlanApi create vlanNames vlanTags vlanMemberEntries commonEnabledState new long 10L new String
NetworkingVLANMemberEntry vlanMemberEntries new NetworkingVLANMemberEntry vlanMemberEntries setMember_type NetworkingMemberType MEMBER_INTERFACE vlanMemberEntries setTag_state NetworkingMemberTagType MEMBER_TAGGED vlanMemberEntries setMember_name _privateInterface s_logger debug vlanTag _vlanApi create vlanNames vlanTags vlanMemberEntries commonEnabledState new long 10L new String s_logger debug vlanName s_logger debug getStrippedVlans if getStrippedVlans contains vlanName throw new ExecutionException vlanTag if inline List Long allRouteDomains getRouteDomains if allRouteDomains contains vlanTag long routeDomainIds genLongArray vlanTag String vlanNames new String genStringArray genVlanName vlanTag
if inline List Long allRouteDomains getRouteDomains if allRouteDomains contains vlanTag long routeDomainIds genLongArray vlanTag String vlanNames new String genStringArray genVlanName vlanTag s_logger debug vlanTag _routeDomainApi create routeDomainIds vlanNames if getRouteDomains contains vlanTag throw new ExecutionException vlanTag List String allSelfIps getSelfIps if allSelfIps contains vlanSelfIp String selfIpsToCreate genStringArray vlanSelfIp String vlans genStringArray vlanName String netmasks genStringArray vlanNetmask long unitIds genLongArray 0L
private void deleteGuestVlan long vlanTag String vlanSelfIp String vlanNetmask boolean inline throws ExecutionException try deleteVirtualServersInGuestVlan vlanSelfIp vlanNetmask List String allSelfIps getSelfIps if allSelfIps contains vlanSelfIp
private void addVirtualServer String virtualServerName LbProtocol protocol String srcIp int srcPort StickinessPolicyTO stickyPolicies throws ExecutionException try if virtualServerExists virtualServerName
private void deletePool String virtualServerName throws ExecutionException try if poolExists virtualServerName getMembers virtualServerName size
private void addPoolMember String virtualServerName String destIp int destPort throws ExecutionException try String memberIdentifier destIp destPort if poolExists virtualServerName memberExists virtualServerName memberIdentifier
private void deletePoolMember String virtualServerName String destIp int destPort throws ExecutionException try String memberIdentifier destIp destPort List String lbPools getAllStrippedLbPools if lbPools contains virtualServerName memberExists virtualServerName memberIdentifier
String memberIdentifier destIp destPort List String lbPools getAllStrippedLbPools if lbPools contains virtualServerName memberExists virtualServerName memberIdentifier s_logger debug memberIdentifier virtualServerName _loadbalancerApi remove_member genStringArray virtualServerName genMembers destIp destPort if memberExists virtualServerName memberIdentifier throw new ExecutionException memberIdentifier virtualServerName if nodeExists destIp boolean nodeNeeded false done for String poolToCheck lbPools for String memberInPool getMembers poolToCheck if getIpAndPort memberInPool equals destIp nodeNeeded true break done if nodeNeeded
for CommonStatistic stat entry getStatistics int index if stat getType equals CommonStatisticType STATISTIC_CLIENT_SIDE_BYTES_OUT index else if stat getType equals CommonStatisticType STATISTIC_CLIENT_SIDE_BYTES_IN index else continue long high stat getValue getHigh long low stat getValue getLow long full getFullUsage high low bytesSentAndReceived index full if bytesSentAndReceived bytesSentAndReceived answer ipBytes put virtualServerIp bytesSentAndReceived catch Exception e
Override DB public boolean prepare final Network network final NicProfile nic final VirtualMachineProfile vm DeployDestination dest ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException if isTypeSupported vm getType
Override DB public boolean release final Network network NicProfile nic final VirtualMachineProfile vm ReservationContext context throws ConcurrentOperationException ResourceUnavailableException if isTypeSupported vm getType
protected boolean createOrUpdateReverse String networkIp String reverseRecordContent Long templateId boolean override String reverseDomainName generateReverseDomainNameFromNetworkIp networkIp Domain reverseDomain searchDomain reverseDomainName true if reverseDomain null reverseDomain _globoDns getDomainAPI createReverseDomain reverseDomainName templateId DEFAULT_AUTHORITY_TYPE
public Answer execute CreateOrUpdateDomainCommand cmd boolean needsExport false try Domain domain searchDomain cmd getDomainName false if domain null domain _globoDns getDomainAPI createDomain cmd getDomainName cmd getTemplateId DEFAULT_AUTHORITY_TYPE
private boolean createOrUpdateRecord Long domainId String name String ip String type boolean override Record record this searchRecord name domainId if record null record _globoDns getRecordAPI createRecord domainId name ip type
public void scheduleExportChangesToBind try Export export _globoDns getExportAPI scheduleExport if export null
protected boolean implementInternalLbVms Network network DeployDestination dest throws ResourceUnavailableException List String ips _appLbDao listLbIpsBySourceIpNetworkIdAndScheme network getId Scheme Internal for String ip ips Ip sourceIp new Ip ip long active _appLbDao countActiveBySourceIp sourceIp network getId if active
Override public boolean applyLBRules Network network List LoadBalancingRule rules throws ResourceUnavailableException Set Ip vmsToDestroy getVmsToDestroy network rules Map Ip List LoadBalancingRule rulesToApply getLbRulesToApply rules
Override public boolean applyLBRules Network network List LoadBalancingRule rules throws ResourceUnavailableException Set Ip vmsToDestroy getVmsToDestroy network rules Map Ip List LoadBalancingRule rulesToApply getLbRulesToApply rules s_logger debug rulesToApply size getName for Ip sourceIp vmsToDestroy List extends VirtualRouter vms _internalLbMgr findInternalLbVms network getId sourceIp if vms size try
Override public VirtualRouterProvider addInternalLoadBalancerElement long ntwkSvcProviderId VirtualRouterProviderVO element _vrProviderDao findByNspIdAndType ntwkSvcProviderId Type InternalLbVm if element null
else if nic getTrafficType TrafficType Control controlNic nic if dest getHost getHypervisorType HypervisorType VMware if s_logger isInfoEnabled s_logger info dest getPod getCidrAddress dest getPod getCidrSize dest getPod getGateway _mgmtHost if s_logger isInfoEnabled s_logger info buf append append _mgmtCidr buf append append dest getPod getGateway if controlNic null throw new CloudRuntimeException if guestNetwork null final String domain guestNetwork getNetworkDomain if domain null buf append domain
Override public boolean finalizeCommandsOnStart final Commands cmds final VirtualMachineProfile profile final DomainRouterVO internalLbVm _internalLbVmDao findById profile getId final NicProfile controlNic getNicProfileByTrafficType profile TrafficType Control if controlNic null
if _instance null _instance _mgmtHost configs get _mgmtCidr _configDao getValue Config ManagementNetwork key final String offUUID configs get Config InternalLbVmServiceOfferingId key if offUUID null offUUID isEmpty final ServiceOfferingVO off _serviceOfferingDao findByUuid offUUID if off null _internalLbVmOfferingId off getId else s_logger warn Config InternalLbVmServiceOfferingId key if _internalLbVmOfferingId 0L List ServiceOfferingVO offerings _serviceOfferingDao createSystemServiceOfferings ServiceOffering internalLbVmDefaultOffUniqueName InternalLoadBalancerVMManager DEFAULT_INTERNALLB_VM_RAMSIZE InternalLoadBalancerVMManager DEFAULT_INTERNALLB_VM_CPU_MHZ null null true null Storage ProvisioningType THIN true null true VirtualMachine Type InternalLoadBalancerVm true if offerings null offerings size String msg
protected void finalizeLbRulesForIp final Commands cmds final DomainRouterVO internalLbVm final Provider provider final Ip sourceIp final long guestNtwkId
Override public boolean destroyInternalLbVm final long vmId final Account caller final Long callerUserId throws ResourceUnavailableException ConcurrentOperationException if s_logger isDebugEnabled
protected VirtualRouter stopInternalLbVm final DomainRouterVO internalLbVm final boolean forced final Account caller final long callerUserId throws ResourceUnavailableException ConcurrentOperationException
protected LinkedHashMap Network List extends NicProfile createInternalLbVmNetworks final Network guestNetwork final DeploymentPlan plan final Ip guestIp throws ConcurrentOperationException InsufficientAddressCapacityException final LinkedHashMap Network List extends NicProfile networks new LinkedHashMap Network List extends NicProfile if guestNetwork null
protected DomainRouterVO deployInternalLbVm final Account owner final DeployDestination dest final DeploymentPlan plan final Map Param Object params final long internalLbProviderId final long svcOffId final Long vpcId final LinkedHashMap Network List extends NicProfile networks final boolean startVm throws ConcurrentOperationException InsufficientAddressCapacityException InsufficientServerCapacityException InsufficientCapacityException StorageUnavailableException ResourceUnavailableException final ServiceOfferingVO routerOffering _serviceOfferingDao findById svcOffId final List HypervisorType hypervisors getHypervisors dest plan null int allocateRetry int startRetry DomainRouterVO internalLbVm null for final Iterator HypervisorType iter hypervisors iterator iter hasNext final HypervisorType hType iter next try final long id _internalLbVmDao getNextInSequence Long class if s_logger isDebugEnabled
String templateName null switch hType case XenServer templateName VirtualNetworkApplianceManager RouterTemplateXen valueIn dest getDataCenter getId break case KVM templateName VirtualNetworkApplianceManager RouterTemplateKvm valueIn dest getDataCenter getId break case VMware templateName VirtualNetworkApplianceManager RouterTemplateVmware valueIn dest getDataCenter getId break case Hyperv templateName VirtualNetworkApplianceManager RouterTemplateHyperV valueIn dest getDataCenter getId break case LXC templateName VirtualNetworkApplianceManager RouterTemplateLxc valueIn dest getDataCenter getId break default break final VMTemplateVO template _templateDao findRoutingTemplate hType templateName if template null
final VMTemplateVO template _templateDao findRoutingTemplate hType templateName if template null s_logger debug hType continue long userId CallContext current getCallingUserId if CallContext current getCallingAccount getId owner getId List UserVO userVOs _userDao listByAccount owner getAccountId if userVOs isEmpty userId userVOs get getId internalLbVm new DomainRouterVO id routerOffering getId internalLbProviderId VirtualMachineName getSystemVmName id _instance InternalLbVmNamePrefix template getId template getHypervisorType template getGuestOSId owner getDomainId owner getId userId false RedundantState UNKNOWN false false VirtualMachine Type InternalLoadBalancerVm vpcId internalLbVm setRole Role INTERNAL_LB_VM internalLbVm _internalLbVmDao persist internalLbVm _itMgr allocate internalLbVm getInstanceName template routerOffering networks plan null internalLbVm _internalLbVmDao findById internalLbVm getId catch final InsufficientCapacityException ex
internalLbVm new DomainRouterVO id routerOffering getId internalLbProviderId VirtualMachineName getSystemVmName id _instance InternalLbVmNamePrefix template getId template getHypervisorType template getGuestOSId owner getDomainId owner getId userId false RedundantState UNKNOWN false false VirtualMachine Type InternalLoadBalancerVm vpcId internalLbVm setRole Role INTERNAL_LB_VM internalLbVm _internalLbVmDao persist internalLbVm _itMgr allocate internalLbVm getInstanceName template routerOffering networks plan null internalLbVm _internalLbVmDao findById internalLbVm getId catch final InsufficientCapacityException ex if allocateRetry iter hasNext s_logger debug hType continue else throw ex finally allocateRetry if startVm try
protected DomainRouterVO startInternalLbVm DomainRouterVO internalLbVm final Account caller final long callerUserId final Map Param Object params throws StorageUnavailableException InsufficientCapacityException ConcurrentOperationException ResourceUnavailableException
protected DomainRouterVO startInternalLbVm DomainRouterVO internalLbVm final Account caller final long callerUserId final Map Param Object params throws StorageUnavailableException InsufficientCapacityException ConcurrentOperationException ResourceUnavailableException s_logger debug internalLbVm _itMgr start internalLbVm getUuid params null null if internalLbVm isStopPending
Override public boolean applyLoadBalancingRules final Network network final List LoadBalancingRule rules final List extends VirtualRouter internalLbVms throws ResourceUnavailableException if rules null rules isEmpty
Override public boolean implement Network network NetworkOffering offering DeployDestination dest ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException
Override public boolean implement Network network NetworkOffering offering DeployDestination dest ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException s_logger debug network getName network getTrafficType if network getTrafficType TrafficType Guest
Override public boolean isReady PhysicalNetworkServiceProvider provider Map String String serviceMap ConfigurationServerImpl _configServer getServicesAndProvidersForNetwork _manager getRouterOffering getId List TrafficType types new ArrayList TrafficType types add TrafficType Control types add TrafficType Management types add TrafficType Storage List NetworkVO systemNets _manager findSystemNetworks types if systemNets null systemNets isEmpty for NetworkVO net systemNets
types add TrafficType Management types add TrafficType Storage List NetworkVO systemNets _manager findSystemNetworks types if systemNets null systemNets isEmpty for NetworkVO net systemNets s_logger debug net getName serviceMap _networksDao update net getId net serviceMap else s_logger debug serviceMap ConfigurationServerImpl _configServer getServicesAndProvidersForNetwork _manager getPublicRouterOffering getId types new ArrayList TrafficType types add TrafficType Public systemNets _manager findSystemNetworks types if systemNets null systemNets isEmpty for NetworkVO net systemNets
Override public boolean verifyServicesCombination Set Service services s_logger debug
Override public Network implement Network network NetworkOffering offering DeployDestination destination ReservationContext context throws InsufficientVirtualNetworkCapacityException
s_logger debug network getName network getTrafficType VirtualNetworkModel vnModel _manager getDatabase lookupVirtualNetwork network getUuid _manager getCanonicalName network network getTrafficType if vnModel null vnModel new VirtualNetworkModel network network getUuid _manager getCanonicalName network network getTrafficType vnModel setProperties _manager getModelController network try if vnModel verify _manager getModelController vnModel update _manager getModelController catch Exception ex s_logger warn ex return network _manager getDatabase getVirtualNetworks add vnModel if network getVpcId null List IPAddressVO ips _ipAddressDao listByAssociatedVpc network getVpcId true if ips isEmpty
Override public NicProfile allocate Network network NicProfile profile VirtualMachineProfile vm throws InsufficientVirtualNetworkCapacityException InsufficientAddressCapacityException ConcurrentOperationException
Override public boolean release NicProfile nic VirtualMachineProfile vm String reservationId
Override public void updateNicProfile NicProfile profile Network network
else final Properties configProps new Properties fileStream new FileInputStream configFile configProps load fileStream String value configProps getProperty if value null _dbSyncInterval Integer parseInt value hostname configProps getProperty String portStr configProps getProperty if portStr null portStr length port Integer parseInt portStr _api ApiConnectorFactory build hostname port catch IOException ex s_logger warn configuration ex throw new ConfigurationException
_api ApiConnectorFactory build hostname port catch IOException ex s_logger warn configuration ex throw new ConfigurationException catch Exception ex s_logger debug ex ex printStackTrace throw new ConfigurationException finally IOUtils closeQuietly fileStream _controller new ModelController this _api _vmDao _networksDao _nicDao _vlanDao _ipAddressDao try _routerOffering locateNetworkOffering routerOfferingName routerOfferingDisplayText Provider JuniperContrailRouter _routerPublicOffering locatePublicNetworkOffering routerPublicOfferingName routerPublicOfferingDisplayText Provider JuniperContrailRouter _vpcRouterOffering locateNetworkOffering vpcRouterOfferingName vpcRouterOfferingDisplayText Provider JuniperContrailVpcRouter
List Long offerings new ArrayList Long offerings add getRouterOffering getId offerings add getVpcRouterOffering getId offerings add getPublicRouterOffering getId sc setParameters offerings toArray if types null types isEmpty types new ArrayList TrafficType types add TrafficType Control types add TrafficType Management types add TrafficType Public types add TrafficType Storage types add TrafficType Guest sc setParameters types toArray List NetworkVO dbNets _networksDao search sc null if dbNets null
private Boolean filter Class cls Object parameters throws InvocationTargetException IllegalAccessException NoSuchMethodException String filterMethod filterMethodPrefix getClassName cls Method method _methodMap get filterMethod if method null
private Boolean equal Class cls Object parameters throws InvocationTargetException IllegalAccessException NoSuchMethodException String equalMethod equalMethodPrefix getClassName cls Method method _methodMap get equalMethod if method null
SuppressWarnings public boolean syncGeneric Class cls List dbList List vncList throws Exception SyncStats stats new SyncStats stats log getClassName cls
SuppressWarnings public boolean syncGeneric Class cls List dbList List vncList throws Exception SyncStats stats new SyncStats stats log getClassName cls s_logger debug getClassName cls java util Collections sort dbList this dbComparator cls java util Collections sort vncList this vncComparator cls syncCollections cls dbList vncList _syncMode SYNC_MODE_CHECK stats if _syncMode SYNC_MODE_CHECK
SuppressWarnings public boolean syncGeneric Class cls List dbList List vncList throws Exception SyncStats stats new SyncStats stats log getClassName cls s_logger debug getClassName cls java util Collections sort dbList this dbComparator cls java util Collections sort vncList this vncComparator cls syncCollections cls dbList vncList _syncMode SYNC_MODE_CHECK stats if _syncMode SYNC_MODE_CHECK s_logger debug getClassName cls stats toString
SuppressWarnings public boolean syncGeneric Class cls List dbList List vncList throws Exception SyncStats stats new SyncStats stats log getClassName cls s_logger debug getClassName cls java util Collections sort dbList this dbComparator cls java util Collections sort vncList this vncComparator cls syncCollections cls dbList vncList _syncMode SYNC_MODE_CHECK stats if _syncMode SYNC_MODE_CHECK s_logger debug getClassName cls stats toString s_logger debug stats logMsg
SuppressWarnings public boolean syncGeneric Class cls List dbList List vncList throws Exception SyncStats stats new SyncStats stats log getClassName cls s_logger debug getClassName cls java util Collections sort dbList this dbComparator cls java util Collections sort vncList this vncComparator cls syncCollections cls dbList vncList _syncMode SYNC_MODE_CHECK stats if _syncMode SYNC_MODE_CHECK s_logger debug getClassName cls stats toString s_logger debug stats logMsg s_logger debug getClassName cls else s_logger debug getClassName cls stats toString if stats isSynchronized s_logger debug getClassName cls
stats log getClassName cls s_logger debug getClassName cls java util Collections sort dbList this dbComparator cls java util Collections sort vncList this vncComparator cls syncCollections cls dbList vncList _syncMode SYNC_MODE_CHECK stats if _syncMode SYNC_MODE_CHECK s_logger debug getClassName cls stats toString s_logger debug stats logMsg s_logger debug getClassName cls else s_logger debug getClassName cls stats toString if stats isSynchronized s_logger debug getClassName cls s_logger debug stats logMsg else
throw new FileNotFoundException inputFile new FileInputStream configFile catch FileNotFoundException e s_logger error e getMessage throw new ConfigurationException e getMessage final Properties configProps new Properties try configProps load inputFile catch IOException e s_logger error e getMessage throw new ConfigurationException e getMessage finally closeAutoCloseable inputFile _mgmtCidr configProps getProperty _mgmtGateway configProps getProperty
Override public short syncAll short syncMode short syncState SYNC_STATE_IN_SYNC s_logger debug try for Class cls _vncClasses _lockSyncMode lock _rwMode syncMode DBSyncGeneric SYNC_MODE_UPDATE _dbSync setSyncMode syncMode if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK
short syncState SYNC_STATE_IN_SYNC s_logger debug try for Class cls _vncClasses _lockSyncMode lock _rwMode syncMode DBSyncGeneric SYNC_MODE_UPDATE _dbSync setSyncMode syncMode if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK s_logger debug DBSyncGeneric getClassName cls else s_logger debug DBSyncGeneric getClassName cls if _dbSync sync cls false if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK s_logger info DBSyncGeneric getClassName cls else
for Class cls _vncClasses _lockSyncMode lock _rwMode syncMode DBSyncGeneric SYNC_MODE_UPDATE _dbSync setSyncMode syncMode if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK s_logger debug DBSyncGeneric getClassName cls else s_logger debug DBSyncGeneric getClassName cls if _dbSync sync cls false if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK s_logger info DBSyncGeneric getClassName cls else s_logger info DBSyncGeneric getClassName cls syncState SYNC_STATE_OUT_OF_SYNC if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK
_rwMode syncMode DBSyncGeneric SYNC_MODE_UPDATE _dbSync setSyncMode syncMode if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK s_logger debug DBSyncGeneric getClassName cls else s_logger debug DBSyncGeneric getClassName cls if _dbSync sync cls false if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK s_logger info DBSyncGeneric getClassName cls else s_logger info DBSyncGeneric getClassName cls syncState SYNC_STATE_OUT_OF_SYNC if _dbSync getSyncMode DBSyncGeneric SYNC_MODE_CHECK s_logger debug DBSyncGeneric getClassName cls else
Override public void syncClass Class cls
Override public void syncClass Class cls s_logger debug cls getName try
Override public void syncClass Class cls s_logger debug cls getName try s_logger debug DBSyncGeneric getClassName cls _lockSyncMode lock _dbSync setSyncMode DBSyncGeneric SYNC_MODE_UPDATE _dbSync sync cls _lockSyncMode unlock
Override public void createDomain DomainVO db StringBuffer syncLogMesg throws IOException final ApiConnector api _manager getApiConnector net juniper contrail api types Domain vnc new net juniper contrail api types Domain vnc setName db getName vnc setUuid db getUuid if api create vnc
Override public void createProject ProjectVO db StringBuffer syncLogMesg throws IOException final ApiConnector api _manager getApiConnector net juniper contrail api types Project vnc new net juniper contrail api types Project vnc setName db getName vnc setUuid db getUuid if api create vnc
NetworkACLVO acl _networkACLDao findById dbNet getNetworkACLId NetworkPolicyModel policyModel _manager getDatabase lookupNetworkPolicy acl getUuid if policyModel null s_logger error dbNet getName acl getUuid acl getName else vnModel addToNetworkPolicy policyModel vnModel build _manager getModelController dbNet if _rwMode try if vnModel verify _manager getModelController vnModel update _manager getModelController catch InternalErrorException ex s_logger warn ex syncLogMesg append dbNet getName return
public Boolean equalVirtualNetwork NetworkVO dbn VirtualNetwork vnet StringBuffer syncLogMesg syncLogMesg append _manager getCanonicalName dbn vnet getName VirtualNetworkModel current _manager getDatabase lookupVirtualNetwork vnet getUuid _manager getCanonicalName dbn dbn getTrafficType VirtualNetworkModel vnModel new VirtualNetworkModel dbn vnet getUuid _manager getCanonicalName dbn dbn getTrafficType if dbn getTrafficType TrafficType Guest dbn getNetworkACLId null NetworkACLVO acl _networkACLDao findById dbn getNetworkACLId NetworkPolicyModel policyModel _manager getDatabase lookupNetworkPolicy acl getUuid if policyModel null
public boolean syncVirtualMachine final ApiConnector api _manager getApiConnector try List VMInstanceVO vmDbList _vmInstanceDao listAll SuppressWarnings List VirtualMachine vncVmList List VirtualMachine api list VirtualMachine class null
catch IOException ex s_logger warn ex throw ex policyModel setProject project List NetworkACLItemVO rules _networkACLItemDao listByACL db getId try policyModel build _manager getModelController rules catch Exception e e printStackTrace if _rwMode try if policyModel verify _manager getModelController policyModel update _manager getModelController catch Exception ex s_logger warn ex
public void deleteServiceInstance ServiceInstance siObj StringBuffer logMsg final ApiConnector api _manager getApiConnector
public void equalServiceInstance ServiceInstanceModel siModel ServiceInstance siObj StringBuffer logMsg
MessageHandler topic public void defaultMessageHandler String subject String topic Object args
org apache cloudstack framework events Event event org apache cloudstack framework events Event args Method method null try if event getEventType contains String methodName event getResourceType method _methodMap get methodName if method null defaultCreateHandler subject topic event else method invoke this subject topic event else if event getEventType contains defaultDeleteHandler subject topic event else defaultHandler subject topic event catch Exception e
void defaultCreateHandler String subject String topic org apache cloudstack framework events Event event
void defaultCreateHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic
void defaultCreateHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription
void defaultCreateHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription s_logger debug event getEventCategory
void defaultCreateHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription s_logger debug event getEventCategory s_logger debug event getResourceType
void defaultDeleteHandler String subject String topic org apache cloudstack framework events Event event
void defaultDeleteHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic
void defaultDeleteHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription
void defaultDeleteHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription s_logger debug event getEventCategory
void defaultDeleteHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription s_logger debug event getEventCategory s_logger debug event getResourceType
void defaultHandler String subject String topic org apache cloudstack framework events Event event
void defaultHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic
void defaultHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription
void defaultHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription s_logger debug event getEventCategory
void defaultHandler String subject String topic org apache cloudstack framework events Event event s_logger debug subject topic s_logger debug event getDescription s_logger debug event getEventCategory s_logger debug event getResourceType
public void onDomainCreate String subject String topic org apache cloudstack framework events Event event
public void onDomainCreate String subject String topic org apache cloudstack framework events Event event s_logger info topic subject try long id parseForId event getResourceType event getDescription if id DomainVO domain _domainDao findById id if domain null
public void onDomainCreate String subject String topic org apache cloudstack framework events Event event s_logger info topic subject try long id parseForId event getResourceType event getDescription if id DomainVO domain _domainDao findById id if domain null s_logger info domain getName domain getUuid StringBuffer logMesg new StringBuffer _dbSync createDomain domain logMesg else _dbSync syncClass net juniper contrail api types Domain class else _dbSync syncClass net juniper contrail api types Domain class catch Exception e
public void onProjectCreate String subject String topic org apache cloudstack framework events Event event
public void onProjectCreate String subject String topic org apache cloudstack framework events Event event s_logger info topic subject try long id parseForId event getResourceType event getDescription if id ProjectVO project _projectDao findById id if project null
public void onProjectCreate String subject String topic org apache cloudstack framework events Event event s_logger info topic subject try long id parseForId event getResourceType event getDescription if id ProjectVO project _projectDao findById id if project null s_logger info project getName project getUuid StringBuffer logMesg new StringBuffer _dbSync createProject project logMesg else _dbSync syncClass net juniper contrail api types Project class else _dbSync syncClass net juniper contrail api types Project class catch Exception e
Override public ServiceVirtualMachine createServiceInstance DataCenter zone Account owner VirtualMachineTemplate template ServiceOffering serviceOffering String name Network left Network right
Override public void startServiceInstance long instanceId
Override public ServiceInstanceResponse createServiceInstanceResponse long instanceId
String policyId api findByName NetworkPolicy class _project _name if policyId null policy _policy NetworkPolicy api findById NetworkPolicy class policyId if policy null policy new NetworkPolicy policy setUuid _uuid policy setName _name policy setParent _project catch IOException ex s_logger warn ex return policy setEntries _policyMap if _policy null try api create policy
policyModel setProject Project _serviceInstance getParent _left addToNetworkPolicy policyModel _right addToNetworkPolicy policyModel List String siList new ArrayList String siList add StringUtils join _serviceInstance getQualifiedName try policyModel build controller getManager getModelController _leftName _rightName siList catch Exception e s_logger error e return null try if policyModel verify controller getManager getModelController policyModel update controller getManager getModelController controller getManager getDatabase getNetworkPolicys add policyModel catch Exception ex
Override public void update ModelController controller throws InternalErrorException IOException if _netActive _nicActive
public void build ModelController controller VMInstanceVO instance setProperties controller instance UserVm userVm controller getVmDao findById instance getId if userVm null userVm getUserData null
Project project try project Project api findById Project class _projectId catch IOException ex s_logger debug ex throw new CloudRuntimeException ex vm setParent project vm setName _instanceName vm setUuid _uuid if _serviceModel null vm setServiceInstance _serviceModel getServiceInstance if _vm null try api create vm catch Exception ex
try _vn VirtualNetwork api findById VirtualNetwork class _uuid catch IOException e e printStackTrace if _vn null return if _ipam null NetworkIpam ipam null try String ipam_id api findByName NetworkIpam class null if ipam_id null s_logger debug return ipam NetworkIpam api findById NetworkIpam class ipam_id if ipam null
Override public void delete Class extends ApiObjectBase arg0 String arg1 throws IOException
Override public ApiObjectBase findByFQN Class extends ApiObjectBase arg0 String arg1 throws IOException
Override public ApiObjectBase findById Class extends ApiObjectBase arg0 String arg1 throws IOException
Override public String findByName Class extends ApiObjectBase arg0 List String arg1 throws IOException
Override public T extends ApiPropertyBase List extends ApiObjectBase getObjects Class extends ApiObjectBase arg0 List ObjectReference T arg1 throws IOException
Override public List extends ApiObjectBase list Class extends ApiObjectBase arg0 List String arg1 throws IOException
if nets null nets isEmpty NetworkVO public_net nets get public_net_id public_net getId else s_logger debug _zone getId Account system _accountMgr getSystemAccount setParameter cmd BaseCmd CommandType STRING system getAccountName setParameter cmd BaseCmd CommandType LONG Domain ROOT_DOMAIN setParameter cmd BaseCmd CommandType STRING setParameter cmd BaseCmd CommandType STRING setParameter cmd ApiConstants GATEWAY BaseCmd CommandType STRING setParameter cmd ApiConstants NETMASK BaseCmd CommandType STRING setParameter cmd BaseCmd CommandType LONG public_net_id setParameter cmd BaseCmd CommandType LONG _zone getId setParameter cmd BaseCmd CommandType STRING
if _znet getState PhysicalNetwork State Enabled _znet _networkService updatePhysicalNetwork _znet getId null null null PhysicalNetwork State Enabled toString Pair List extends PhysicalNetworkTrafficType Integer trafficTypes _networkService listTrafficTypes _znet getId boolean found false for PhysicalNetworkTrafficType ttype trafficTypes first if ttype getTrafficType TrafficType Guest found true if found _networkService addTrafficTypeToPhysicalNetwork _znet getId TrafficType Guest toString null null null null null null null Pair List extends PhysicalNetworkServiceProvider Integer providers _networkService listNetworkServiceProviders _znet getId Provider JuniperContrailRouter getName null null null if providers second s_logger debug Provider JuniperContrailRouter getName _znet getName PhysicalNetworkServiceProvider provider _networkService addProviderToPhysicalNetwork _znet getId Provider JuniperContrailRouter getName null null _networkService updateNetworkServiceProvider provider getId PhysicalNetworkServiceProvider State Enabled toString null else
for PhysicalNetworkTrafficType ttype trafficTypes first if ttype getTrafficType TrafficType Guest found true if found _networkService addTrafficTypeToPhysicalNetwork _znet getId TrafficType Guest toString null null null null null null null Pair List extends PhysicalNetworkServiceProvider Integer providers _networkService listNetworkServiceProviders _znet getId Provider JuniperContrailRouter getName null null null if providers second s_logger debug Provider JuniperContrailRouter getName _znet getName PhysicalNetworkServiceProvider provider _networkService addProviderToPhysicalNetwork _znet getId Provider JuniperContrailRouter getName null null _networkService updateNetworkServiceProvider provider getId PhysicalNetworkServiceProvider State Enabled toString null else PhysicalNetworkServiceProvider provider providers first get if provider getState PhysicalNetworkServiceProvider State Enabled _networkService updateNetworkServiceProvider provider getId PhysicalNetworkServiceProvider State Enabled toString null providers _networkService listNetworkServiceProviders _znet getId null PhysicalNetworkServiceProvider State Enabled toString null null
BeforeClass public static void globalSetUp throws Exception ApiConnectorFactory setImplementation ApiConnectorMock class s_logger info s_mysqlSrverPort TestDbSetup init null
private void purgeTestNetwork Account system _accountMgr getSystemAccount DataCenter zone _server getZone List extends Network list _networkService getIsolatedNetworksOwnedByAccountInZone zone getId system for Network net list
BeforeClass public static void globalSetUp throws Exception ApiConnectorFactory setImplementation ApiConnectorMockito class s_logger info s_mysqlServerPort TestDbSetup init null
Override public boolean implement Network network NetworkOffering offering DeployDestination dest ReservationContext context throws ResourceUnavailableException ConcurrentOperationException InsufficientNetworkCapacityException DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Basic
Override public boolean shutdown Network network ReservationContext context boolean cleanup throws ResourceUnavailableException ConcurrentOperationException DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Basic
private String getXml String filename try String xmlFilePath Script findScript scriptsDir filename if xmlFilePath null throw new Exception filename try InputStreamReader fr new InputStreamReader new FileInputStream xmlFilePath BufferedReader br new BufferedReader fr String xml String line while line br readLine null xml line trim return xml catch Exception e s_logger debug e return null catch Exception e
private void closeConfiguration String xml SrxXml CLOSE_CONFIGURATION getXml String successMsg String errorMsg try if sendRequestAndCheckResponse SrxCommand CLOSE_CONFIGURATION xml
long guestVlanTag Long parseLong cmd getAccessDetail NetworkElementCommand GUEST_VLAN_TAG String guestVlanGateway cmd getAccessDetail NetworkElementCommand GUEST_NETWORK_GATEWAY String cidr cmd getAccessDetail NetworkElementCommand GUEST_NETWORK_CIDR long cidrSize NetUtils cidrToLong cidr String guestVlanSubnet NetUtils getCidrSubNet guestVlanGateway cidrSize Long publicVlanTag null if ip getBroadcastUri null ip getBroadcastUri equals try publicVlanTag Long parseLong BroadcastDomainType getValue ip getBroadcastUri catch Exception e throw new ExecutionException ip getBroadcastUri openConfiguration shutdownGuestNetwork type ip getAccountId publicVlanTag sourceNatIpAddress guestVlanTag guestVlanGateway guestVlanSubnet cidrSize if ip isAdd implementGuestNetwork type publicVlanTag sourceNatIpAddress guestVlanTag guestVlanGateway guestVlanSubnet cidrSize
privateGateway privateGateway privateCidrNumber privateSubnet privateSubnet privateCidrNumber managePrivateInterface SrxCommand ADD type equals GuestNetworkType SOURCE_NAT privateVlanTag privateGateway manageZoneInterface SrxCommand ADD privateVlanTag if type equals GuestNetworkType SOURCE_NAT manageSourceNatPool SrxCommand ADD publicIp manageSourceNatRule SrxCommand ADD publicIp privateSubnet manageProxyArp SrxCommand ADD publicVlanTag publicIp manageUsageFilter SrxCommand ADD _usageFilterIPOutput privateSubnet null genIpFilterTermName publicIp manageUsageFilter SrxCommand ADD _usageFilterIPInput publicIp null genIpFilterTermName publicIp else if type equals GuestNetworkType INTERFACE_NAT manageUsageFilter SrxCommand ADD _usageFilterVlanOutput null privateVlanTag null manageUsageFilter SrxCommand ADD _usageFilterVlanInput null privateVlanTag null String msg type privateVlanTag privateGateway msg type equals GuestNetworkType SOURCE_NAT publicIp
privateSubnet privateSubnet privateCidrSize managePrivateInterface SrxCommand DELETE false privateVlanTag privateGateway manageZoneInterface SrxCommand DELETE privateVlanTag deleteVpnObjectsForAccount accountId if type equals GuestNetworkType SOURCE_NAT manageSourceNatRule SrxCommand DELETE sourceNatIpAddress privateSubnet manageSourceNatPool SrxCommand DELETE sourceNatIpAddress manageProxyArp SrxCommand DELETE publicVlanTag sourceNatIpAddress manageUsageFilter SrxCommand DELETE _usageFilterIPOutput privateSubnet null genIpFilterTermName sourceNatIpAddress manageUsageFilter SrxCommand DELETE _usageFilterIPInput sourceNatIpAddress null genIpFilterTermName sourceNatIpAddress else if type equals GuestNetworkType INTERFACE_NAT manageUsageFilter SrxCommand DELETE _usageFilterVlanOutput null privateVlanTag null manageUsageFilter SrxCommand DELETE _usageFilterVlanInput null privateVlanTag null String msg type privateVlanTag privateGateway msg type equals GuestNetworkType SOURCE_NAT sourceNatIpAddress
try openConfiguration Set String ipPairs activeRules keySet for String ipPair ipPairs String ipPairComponents ipPair split String publicIp ipPairComponents String privateIp ipPairComponents List FirewallRuleTO activeRulesForIpPair activeRules get ipPair Long publicVlanTag getVlanTag vlanTagMap get publicIp removeStaticNatRule publicVlanTag publicIp privateIp if activeRulesForIpPair size addStaticNatRule publicVlanTag publicIp privateIp activeRulesForIpPair commitConfiguration return new Answer cmd catch ExecutionException e
String ipPairComponents ipPair split String publicIp ipPairComponents String privateIp ipPairComponents List FirewallRuleTO activeRulesForIpPair activeRules get ipPair Long publicVlanTag getVlanTag vlanTagMap get publicIp removeStaticNatRule publicVlanTag publicIp privateIp if activeRulesForIpPair size addStaticNatRule publicVlanTag publicIp privateIp activeRulesForIpPair commitConfiguration return new Answer cmd catch ExecutionException e s_logger error e closeConfiguration if numRetries refreshSrxConnection int numRetriesRemaining numRetries
private void addStaticNatRule Long publicVlanTag String publicIp String privateIp List FirewallRuleTO rules throws ExecutionException manageStaticNatRule SrxCommand ADD publicIp privateIp manageAddressBookEntry SrxCommand ADD _privateZone privateIp null manageProxyArp SrxCommand ADD publicVlanTag publicIp addSecurityPolicyAndApplications SecurityPolicyType STATIC_NAT privateIp extractApplications rules
private void removeStaticNatRule Long publicVlanTag String publicIp String privateIp throws ExecutionException manageStaticNatRule SrxCommand DELETE publicIp privateIp removeSecurityPolicyAndApplications SecurityPolicyType STATIC_NAT privateIp manageAddressBookEntry SrxCommand DELETE _privateZone privateIp null manageProxyArp SrxCommand DELETE publicVlanTag publicIp
String preSharedKey cmd getPresharedKey String ipRange cmd getIpRange split try openConfiguration deleteVpnObjectsForAccount accountId if cmd isCreate manageIkePolicy SrxCommand ADD null accountId preSharedKey manageAddressPool SrxCommand ADD null accountId guestNetworkCidr ipRange ipRange _primaryDnsAddress commitConfiguration return new Answer cmd catch ExecutionException e s_logger error e closeConfiguration if numRetries refreshSrxConnection int numRetriesRemaining numRetries
UsernamePassword users cmd getUserpwds try openConfiguration for UsernamePassword user users SrxCommand srxCmd user isAdd SrxCommand ADD SrxCommand DELETE String ipsecVpnName genIpsecVpnName accountId user getUsername manageIkeGateway srxCmd null accountId ikePolicyName _ikeGatewayHostname user getUsername manageIpsecVpn srxCmd null accountId guestNetworkCidr user getUsername _ipsecPolicyName manageDynamicVpnClient srxCmd null accountId guestNetworkCidr ipsecVpnName user getUsername manageAccessProfile srxCmd null accountId user getUsername user getPassword genAddressPoolName accountId manageAddressBookEntry srxCmd _privateZone guestNetworkCidr ipsecVpnName manageSecurityPolicy SecurityPolicyType VPN srxCmd null null guestNetworkCidr null null ipsecVpnName false commitConfiguration return new Answer cmd catch ExecutionException e
SrxCommand srxCmd user isAdd SrxCommand ADD SrxCommand DELETE String ipsecVpnName genIpsecVpnName accountId user getUsername manageIkeGateway srxCmd null accountId ikePolicyName _ikeGatewayHostname user getUsername manageIpsecVpn srxCmd null accountId guestNetworkCidr user getUsername _ipsecPolicyName manageDynamicVpnClient srxCmd null accountId guestNetworkCidr ipsecVpnName user getUsername manageAccessProfile srxCmd null accountId user getUsername user getPassword genAddressPoolName accountId manageAddressBookEntry srxCmd _privateZone guestNetworkCidr ipsecVpnName manageSecurityPolicy SecurityPolicyType VPN srxCmd null null guestNetworkCidr null null ipsecVpnName false commitConfiguration return new Answer cmd catch ExecutionException e s_logger error e closeConfiguration if numRetries refreshSrxConnection int numRetriesRemaining numRetries
for String ipPair ipPairs String ipPairComponents ipPair split String publicIp ipPairComponents String privateIp ipPairComponents List FirewallRuleTO activeRulesForIpPair activeRules get ipPair List String destNatRules getDestNatRules RuleMatchCondition PUBLIC_PRIVATE_IPS publicIp privateIp null null Map String Long publicVlanTags getPublicVlanTagsForNatRules destNatRules removeDestinationNatRules null publicVlanTags destNatRules for FirewallRuleTO rule activeRulesForIpPair Long publicVlanTag getVlanTag rule getSrcVlanTag PortForwardingRuleTO portForwardingRule PortForwardingRuleTO rule addDestinationNatRule getProtocol rule getProtocol publicVlanTag portForwardingRule getSrcIp portForwardingRule getDstIp portForwardingRule getSrcPortRange portForwardingRule getSrcPortRange portForwardingRule getDstPortRange portForwardingRule getDstPortRange commitConfiguration return new Answer cmd catch ExecutionException e
List FirewallRuleTO activeRulesForIpPair activeRules get ipPair List String destNatRules getDestNatRules RuleMatchCondition PUBLIC_PRIVATE_IPS publicIp privateIp null null Map String Long publicVlanTags getPublicVlanTagsForNatRules destNatRules removeDestinationNatRules null publicVlanTags destNatRules for FirewallRuleTO rule activeRulesForIpPair Long publicVlanTag getVlanTag rule getSrcVlanTag PortForwardingRuleTO portForwardingRule PortForwardingRuleTO rule addDestinationNatRule getProtocol rule getProtocol publicVlanTag portForwardingRule getSrcIp portForwardingRule getDstIp portForwardingRule getSrcPortRange portForwardingRule getSrcPortRange portForwardingRule getDstPortRange portForwardingRule getDstPortRange commitConfiguration return new Answer cmd catch ExecutionException e s_logger error e closeConfiguration if numRetries refreshSrxConnection int numRetriesRemaining numRetries
private void removeDestinationNatRule Long publicVlanTag String publicIp String privateIp int srcPort int destPort throws ExecutionException manageDestinationNatRule SrxCommand DELETE publicIp privateIp srcPort destPort manageDestinationNatPool SrxCommand DELETE privateIp destPort manageProxyArp SrxCommand DELETE publicVlanTag publicIp removeSecurityPolicyAndApplications SecurityPolicyType DESTINATION_NAT privateIp manageAddressBookEntry SrxCommand DELETE _privateZone privateIp null
xml setDelete xml false xml replaceXmlValue xml _privateZone xml replaceXmlValue xml _privateZone xml replaceXmlValue xml ruleName_private return sendRequestAndCheckResponse command xml ruleName_private case ADD if manageStaticNatRule SrxCommand CHECK_IF_EXISTS publicIp privateIp xml SrxXml STATIC_NAT_RULE_ADD getXml xml replaceXmlValue xml _publicZone xml replaceXmlValue xml _publicZone xml replaceXmlValue xml ruleName xml replaceXmlValue xml publicIp xml replaceXmlValue xml privateIp if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp privateIp _publicZone else
xml replaceXmlValue xml privateIp if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp privateIp _publicZone else s_logger debug String format publicIp privateIp _publicZone if manageStaticNatRule SrxCommand CHECK_PRIVATE_IF_EXISTS publicIp privateIp xml SrxXml STATIC_NAT_RULE_ADD getXml xml replaceXmlValue xml _privateZone xml replaceXmlValue xml _privateZone xml replaceXmlValue xml ruleName_private xml replaceXmlValue xml publicIp xml replaceXmlValue xml privateIp if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp privateIp _privateZone else
xml replaceXmlValue xml _privateZone xml replaceXmlValue xml ruleName_private xml replaceXmlValue xml publicIp xml replaceXmlValue xml privateIp if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp privateIp _privateZone else s_logger debug String format publicIp privateIp _privateZone return true case DELETE if manageStaticNatRule SrxCommand CHECK_IF_EXISTS publicIp privateIp xml SrxXml STATIC_NAT_RULE_GETONE getXml xml setDelete xml true xml replaceXmlValue xml _publicZone xml replaceXmlValue xml _publicZone xml replaceXmlValue xml ruleName
return true case DELETE if manageStaticNatRule SrxCommand CHECK_IF_EXISTS publicIp privateIp xml SrxXml STATIC_NAT_RULE_GETONE getXml xml setDelete xml true xml replaceXmlValue xml _publicZone xml replaceXmlValue xml _publicZone xml replaceXmlValue xml ruleName if sendRequestAndCheckResponse command xml ruleName throw new ExecutionException String format publicIp privateIp _publicZone else s_logger debug String format publicIp privateIp _publicZone if manageStaticNatRule SrxCommand CHECK_PRIVATE_IF_EXISTS publicIp privateIp xml SrxXml STATIC_NAT_RULE_GETONE getXml xml setDelete xml true xml replaceXmlValue xml _privateZone
case CHECK_IF_EXISTS xml SrxXml DEST_NAT_POOL_GETONE getXml xml setDelete xml false xml replaceXmlValue xml poolName return sendRequestAndCheckResponse command xml poolName case CHECK_IF_IN_USE xml SrxXml DEST_NAT_RULE_GETALL getXml xml replaceXmlValue xml _publicZone return sendRequestAndCheckResponse command xml poolName case ADD if manageDestinationNatPool SrxCommand CHECK_IF_EXISTS privateIp destPort xml SrxXml DEST_NAT_POOL_ADD getXml xml replaceXmlValue xml poolName xml replaceXmlValue xml privateIp xml replaceXmlValue xml String valueOf destPort if sendRequestAndCheckResponse command xml throw new ExecutionException String format privateIp destPort else
xml replaceXmlValue xml String valueOf destPort if sendRequestAndCheckResponse command xml throw new ExecutionException String format privateIp destPort else s_logger debug String format privateIp destPort return true return true case DELETE if manageDestinationNatPool SrxCommand CHECK_IF_EXISTS privateIp destPort if manageDestinationNatPool SrxCommand CHECK_IF_IN_USE privateIp destPort xml SrxXml DEST_NAT_POOL_GETONE getXml xml setDelete xml true xml replaceXmlValue xml poolName if sendRequestAndCheckResponse command xml throw new ExecutionException String format privateIp destPort else
throw new ExecutionException String format privateIp destPort else s_logger debug String format privateIp destPort return true return true case DELETE if manageDestinationNatPool SrxCommand CHECK_IF_EXISTS privateIp destPort if manageDestinationNatPool SrxCommand CHECK_IF_IN_USE privateIp destPort xml SrxXml DEST_NAT_POOL_GETONE getXml xml setDelete xml true xml replaceXmlValue xml poolName if sendRequestAndCheckResponse command xml throw new ExecutionException String format privateIp destPort else s_logger debug String format privateIp destPort else
xml replaceXmlValue xml ruleName_private return sendRequestAndCheckResponse command xml ruleName_private case ADD if manageDestinationNatRule SrxCommand CHECK_IF_EXISTS publicIp privateIp srcPort destPort if manageDestinationNatPool SrxCommand CHECK_IF_EXISTS privateIp destPort throw new ExecutionException String format privateIp destPort xml SrxXml DEST_NAT_RULE_ADD getXml xml replaceXmlValue xml _publicZone xml replaceXmlValue xml _publicZone xml replaceXmlValue xml ruleName xml replaceXmlValue xml publicIp xml replaceXmlValue xml String valueOf srcPort xml replaceXmlValue xml poolName if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp srcPort privateIp destPort _publicZone else
xml replaceXmlValue xml poolName if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp srcPort privateIp destPort _publicZone else s_logger debug String format publicIp srcPort privateIp destPort _publicZone if manageDestinationNatRule SrxCommand CHECK_PRIVATE_IF_EXISTS publicIp privateIp srcPort destPort xml SrxXml DEST_NAT_RULE_ADD getXml xml replaceXmlValue xml _privateZone xml replaceXmlValue xml _privateZone xml replaceXmlValue xml ruleName_private xml replaceXmlValue xml publicIp xml replaceXmlValue xml String valueOf srcPort xml replaceXmlValue xml poolName if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp srcPort privateIp destPort _privateZone
xml replaceXmlValue xml _privateZone xml replaceXmlValue xml ruleName_private xml replaceXmlValue xml publicIp xml replaceXmlValue xml String valueOf srcPort xml replaceXmlValue xml poolName if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp srcPort privateIp destPort _privateZone else s_logger debug String format publicIp srcPort privateIp destPort _privateZone return true case DELETE if manageDestinationNatRule SrxCommand CHECK_IF_EXISTS publicIp privateIp srcPort destPort xml SrxXml DEST_NAT_RULE_GETONE getXml xml setDelete xml true xml replaceXmlValue xml _publicZone xml replaceXmlValue xml _publicZone
s_logger debug String format publicIp srcPort privateIp destPort _privateZone return true case DELETE if manageDestinationNatRule SrxCommand CHECK_IF_EXISTS publicIp privateIp srcPort destPort xml SrxXml DEST_NAT_RULE_GETONE getXml xml setDelete xml true xml replaceXmlValue xml _publicZone xml replaceXmlValue xml _publicZone xml replaceXmlValue xml ruleName if sendRequestAndCheckResponse command xml throw new ExecutionException String format publicIp srcPort privateIp destPort _publicZone else s_logger debug String format publicIp srcPort privateIp destPort _publicZone if manageDestinationNatRule SrxCommand CHECK_PRIVATE_IF_EXISTS publicIp privateIp srcPort destPort xml SrxXml DEST_NAT_RULE_GETONE getXml xml setDelete xml true
private String sendRequestPrim BufferedWriter sendStream BufferedReader recvStream String xmlRequest throws ExecutionException if xmlRequest contains
if xmlRequest contains s_logger debug xmlRequest else s_logger debug boolean timedOut false StringBuffer xmlResponseBuffer new StringBuffer try sendStream write xmlRequest sendStream flush String line while line recvStream readLine null xmlResponseBuffer append line if line contains break catch SocketTimeoutException e
else s_logger debug boolean timedOut false StringBuffer xmlResponseBuffer new StringBuffer try sendStream write xmlRequest sendStream flush String line while line recvStream readLine null xmlResponseBuffer append line if line contains break catch SocketTimeoutException e s_logger debug e timedOut true
catch SocketTimeoutException e s_logger debug e timedOut true catch IOException e s_logger debug e return null String xmlResponse xmlResponseBuffer toString String errorMsg null if timedOut errorMsg xmlRequest else if xmlResponse isEmpty errorMsg else if xmlResponse contains errorMsg else if xmlResponse contains
private boolean checkResponse String xmlResponse boolean errorKeyAndValue String key String value if xmlResponse null s_logger error return false if xmlResponse contains s_logger debug xmlResponse else s_logger debug String textToSearchFor key if value null textToSearchFor key value key if errorKeyAndValue xmlResponse contains textToSearchFor errorKeyAndValue xmlResponse contains textToSearchFor return true String responseMessage extractXml xmlResponse if responseMessage null
return false if xmlResponse contains s_logger debug xmlResponse else s_logger debug String textToSearchFor key if value null textToSearchFor key value key if errorKeyAndValue xmlResponse contains textToSearchFor errorKeyAndValue xmlResponse contains textToSearchFor return true String responseMessage extractXml xmlResponse if responseMessage null s_logger error responseMessage else if errorKeyAndValue
if xmlResponse contains s_logger debug xmlResponse else s_logger debug String textToSearchFor key if value null textToSearchFor key value key if errorKeyAndValue xmlResponse contains textToSearchFor errorKeyAndValue xmlResponse contains textToSearchFor return true String responseMessage extractXml xmlResponse if responseMessage null s_logger error responseMessage else if errorKeyAndValue s_logger error textToSearchFor
String deviceName cmd getDeviceType if isNetscalerDevice deviceName throw new InvalidParameterValueException URI uri try uri new URI cmd getUrl catch Exception e String msg e getMessage s_logger debug msg throw new InvalidParameterValueException msg Map String String configParams new HashMap String String UrlUtil parseQueryParameters uri getQuery false configParams boolean dedicatedUse configParams get ApiConstants LOAD_BALANCER_DEVICE_DEDICATED null Boolean parseBoolean configParams get ApiConstants LOAD_BALANCER_DEVICE_DEDICATED false if dedicatedUse deviceName equals NetworkDevice NetscalerVPXLoadBalancer getName String msg
try uri new URI cmd getUrl catch Exception e String msg e getMessage s_logger debug msg throw new InvalidParameterValueException msg Map String String configParams new HashMap String String UrlUtil parseQueryParameters uri getQuery false configParams boolean dedicatedUse configParams get ApiConstants LOAD_BALANCER_DEVICE_DEDICATED null Boolean parseBoolean configParams get ApiConstants LOAD_BALANCER_DEVICE_DEDICATED false if dedicatedUse deviceName equals NetworkDevice NetscalerVPXLoadBalancer getName String msg s_logger debug msg throw new InvalidParameterValueException msg if cmd isGslbProvider if deviceName equals NetworkDevice NetscalerVPXLoadBalancer getName deviceName equals NetworkDevice NetscalerMPXLoadBalancer getName
String msg e getMessage s_logger debug msg throw new InvalidParameterValueException msg Map String String configParams new HashMap String String UrlUtil parseQueryParameters uri getQuery false configParams boolean dedicatedUse configParams get ApiConstants LOAD_BALANCER_DEVICE_DEDICATED null Boolean parseBoolean configParams get ApiConstants LOAD_BALANCER_DEVICE_DEDICATED false if dedicatedUse deviceName equals NetworkDevice NetscalerVPXLoadBalancer getName String msg s_logger debug msg throw new InvalidParameterValueException msg if cmd isGslbProvider if deviceName equals NetworkDevice NetscalerVPXLoadBalancer getName deviceName equals NetworkDevice NetscalerMPXLoadBalancer getName String msg s_logger debug msg throw new InvalidParameterValueException msg
return false boolean multiNetScalerDeployment Boolean valueOf _configDao getValue Config EIPWithMultipleNetScalersEnabled key try if multiNetScalerDeployment String errMsg ExternalLoadBalancerDeviceVO lbDevice getExternalLoadBalancerForNetwork config if lbDevice null try lbDevice allocateLoadBalancerForNetwork config catch Exception e errMsg e getMessage s_logger error errMsg throw new ResourceUnavailableException errMsg this getClass if isNetscalerDevice lbDevice getDeviceName errMsg
SetStaticNatRulesCommand cmd new SetStaticNatRulesCommand rulesTO null answer SetStaticNatRulesAnswer _agentMgr send lbDevice getHostId cmd if answer null return false else return answer getResult else if rules null for StaticNat rule rules ExternalLoadBalancerDeviceVO lbDevice getNetScalerForEIP rule if lbDevice null String errMsg rule getDestIpAddress s_logger error errMsg throw new ResourceUnavailableException errMsg this getClass List StaticNatRuleTO rulesTO new ArrayList StaticNatRuleTO
Override public boolean applyGlobalLoadBalancerRule long zoneId long physicalNetworkId GlobalLoadBalancerConfigCommand gslbConfigCmd throws ResourceUnavailableException long zoneGslbProviderHosId ExternalLoadBalancerDeviceVO nsGslbProvider findGslbProvider zoneId physicalNetworkId if nsGslbProvider null String msg zoneId
public void getServicePackages throws ExecutionException String result null try URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null org json JSONObject jsonBody new JSONObject org json JSONObject jsonCredentials new JSONObject result getHttpRequest jsonBody toString agentUri _sessionid
try URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null org json JSONObject jsonBody new JSONObject org json JSONObject jsonCredentials new JSONObject jsonCredentials put _username jsonCredentials put _password jsonBody put jsonCredentials result postHttpRequest jsonBody toString agentUri _sessionid if result null throw new ConfigurationException else jsonResponse new JSONObject result org json JSONArray loginResponse jsonResponse getJSONArray _sessionid jsonResponse getJSONArray getJSONObject getString
jsonBody put jsonCredentials result postHttpRequest jsonBody toString agentUri _sessionid if result null throw new ConfigurationException else jsonResponse new JSONObject result org json JSONArray loginResponse jsonResponse getJSONArray _sessionid jsonResponse getJSONArray getJSONObject getString s_logger debug _sessionid set_nccsession _sessionid s_logger debug get_nccsession s_logger debug result return result catch URISyntaxException e String errMsg
if result null throw new ConfigurationException else jsonResponse new JSONObject result org json JSONArray loginResponse jsonResponse getJSONArray _sessionid jsonResponse getJSONArray getJSONObject getString s_logger debug _sessionid set_nccsession _sessionid s_logger debug get_nccsession s_logger debug result return result catch URISyntaxException e String errMsg s_logger error errMsg e catch JSONException e
private String queryAsyncJob String jobId throws ExecutionException String result null try URI agentUri null agentUri new URI null _ip DEFAULT_PORT jobId null null org json JSONObject jsonBody new JSONObject long startTick System currentTimeMillis while System currentTimeMillis startTick _nccCmdTimeout result getHttpRequest jsonBody toString agentUri _sessionid JSONObject response new JSONObject result if response null
private String queryAsyncJob String jobId throws ExecutionException String result null try URI agentUri null agentUri new URI null _ip DEFAULT_PORT jobId null null org json JSONObject jsonBody new JSONObject long startTick System currentTimeMillis while System currentTimeMillis startTick _nccCmdTimeout result getHttpRequest jsonBody toString agentUri _sessionid JSONObject response new JSONObject result if response null s_logger debug jobId result System currentTimeMillis startTick _nccCmdTimeout String status response getJSONObject getString toUpperCase String message response getJSONObject getString
result getHttpRequest jsonBody toString agentUri _sessionid JSONObject response new JSONObject result if response null s_logger debug jobId result System currentTimeMillis startTick _nccCmdTimeout String status response getJSONObject getString toUpperCase String message response getJSONObject getString s_logger debug jobId status switch status case return status case break case break case throw new ExecutionException message case throw new ExecutionException message catch URISyntaxException e String errMsg
private synchronized Answer execute NetScalerImplementNetworkCommand cmd int numRetries String result null try URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null org json JSONObject jsonBody new JSONObject cmd getDetails
private synchronized Answer execute NetScalerImplementNetworkCommand cmd int numRetries String result null try URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null org json JSONObject jsonBody new JSONObject cmd getDetails s_logger debug jsonBody result postHttpRequest jsonBody toString agentUri _sessionid
private synchronized Answer execute NetScalerImplementNetworkCommand cmd int numRetries String result null try URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null org json JSONObject jsonBody new JSONObject cmd getDetails s_logger debug jsonBody result postHttpRequest jsonBody toString agentUri _sessionid s_logger debug result result queryAsyncJob result
agentUri new URI null _ip DEFAULT_PORT null null org json JSONObject jsonBody new JSONObject cmd getDetails s_logger debug jsonBody result postHttpRequest jsonBody toString agentUri _sessionid s_logger debug result result queryAsyncJob result s_logger debug result return new Answer cmd true catch URISyntaxException e String errMsg s_logger error errMsg e catch ExecutionException e if e getMessage equalsIgnoreCase NccHttpCode NOT_FOUND return new Answer cmd true else if e getMessage startsWith
s_logger debug result result queryAsyncJob result s_logger debug result return new Answer cmd true catch URISyntaxException e String errMsg s_logger error errMsg e catch ExecutionException e if e getMessage equalsIgnoreCase NccHttpCode NOT_FOUND return new Answer cmd true else if e getMessage startsWith s_logger error e getMessage return new Answer cmd false e getMessage else if shouldRetry numRetries
String errMsg s_logger error errMsg e catch ExecutionException e if e getMessage equalsIgnoreCase NccHttpCode NOT_FOUND return new Answer cmd true else if e getMessage startsWith s_logger error e getMessage return new Answer cmd false e getMessage else if shouldRetry numRetries s_logger debug numRetries e return retry cmd numRetries else return new Answer cmd false e getMessage catch Exception e
JSONArray dest lbstat getJSONArray List DestinationTO listDestTo new ArrayList DestinationTO for int d d dest length d JSONObject dt dest getJSONObject d if dt null DestinationTO destTO new DestinationTO dt getString dt getInt dt getString listDestTo add destTO loadBalancer new LoadBalancerTO lbstat getString listDestTo hcLB add loadBalancer catch ExecutionException e s_logger error e if shouldRetry numRetries return retry cmd numRetries else return new HealthCheckLBConfigAnswer hcLB
private String getLBHealthChecks long networkid throws ExecutionException URI agentUri null String response null try agentUri new URI null _ip DEFAULT_PORT networkid null null org json JSONObject jsonBody new JSONObject response getHttpRequest jsonBody toString agentUri _sessionid
private synchronized Answer execute LoadBalancerConfigCommand cmd int numRetries try LoadBalancerTO loadBalancers cmd getLoadBalancers if loadBalancers null return new Answer cmd JSONObject lbConfigPaylod new JSONObject cmd String gsonLBConfig _gson toJson cmd URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null JSONObject lbConfigCmd new JSONObject JSONObject lbcmd new JSONObject gsonLBConfig s_logger debug lbcmd toString gsonLBConfig lbConfigCmd put lbcmd getJSONArray s_logger debug lbConfigCmd toString String result postHttpRequest lbConfigCmd toString agentUri _sessionid
LoadBalancerTO loadBalancers cmd getLoadBalancers if loadBalancers null return new Answer cmd JSONObject lbConfigPaylod new JSONObject cmd String gsonLBConfig _gson toJson cmd URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null JSONObject lbConfigCmd new JSONObject JSONObject lbcmd new JSONObject gsonLBConfig s_logger debug lbcmd toString gsonLBConfig lbConfigCmd put lbcmd getJSONArray s_logger debug lbConfigCmd toString String result postHttpRequest lbConfigCmd toString agentUri _sessionid s_logger debug result result queryAsyncJob result
JSONObject lbConfigPaylod new JSONObject cmd String gsonLBConfig _gson toJson cmd URI agentUri null agentUri new URI null _ip DEFAULT_PORT null null JSONObject lbConfigCmd new JSONObject JSONObject lbcmd new JSONObject gsonLBConfig s_logger debug lbcmd toString gsonLBConfig lbConfigCmd put lbcmd getJSONArray s_logger debug lbConfigCmd toString String result postHttpRequest lbConfigCmd toString agentUri _sessionid s_logger debug result result queryAsyncJob result s_logger debug result return new Answer cmd catch ExecutionException e
agentUri new URI null _ip DEFAULT_PORT null null JSONObject lbConfigCmd new JSONObject JSONObject lbcmd new JSONObject gsonLBConfig s_logger debug lbcmd toString gsonLBConfig lbConfigCmd put lbcmd getJSONArray s_logger debug lbConfigCmd toString String result postHttpRequest lbConfigCmd toString agentUri _sessionid s_logger debug result result queryAsyncJob result s_logger debug result return new Answer cmd catch ExecutionException e s_logger error e if e getMessage equalsIgnoreCase NccHttpCode NOT_FOUND return new Answer cmd true
s_logger debug lbcmd toString gsonLBConfig lbConfigCmd put lbcmd getJSONArray s_logger debug lbConfigCmd toString String result postHttpRequest lbConfigCmd toString agentUri _sessionid s_logger debug result result queryAsyncJob result s_logger debug result return new Answer cmd catch ExecutionException e s_logger error e if e getMessage equalsIgnoreCase NccHttpCode NOT_FOUND return new Answer cmd true else if e getMessage startsWith e getMessage startsWith s_logger error e getMessage return new Answer cmd false e getMessage
return new Answer cmd catch ExecutionException e s_logger error e if e getMessage equalsIgnoreCase NccHttpCode NOT_FOUND return new Answer cmd true else if e getMessage startsWith e getMessage startsWith s_logger error e getMessage return new Answer cmd false e getMessage else if e getMessage startsWith NccHttpCode INTERNAL_ERROR s_logger error e getMessage return new Answer cmd false e getMessage if shouldRetry numRetries return retry cmd numRetries else return new Answer cmd false e getMessage
statsIPList new JSONObject response getJSONObject getJSONArray if statsIPList null for int i i statsIPList length i JSONObject ipstat statsIPList getJSONObject i JSONObject ipvalues ipstat getJSONObject if ipstat null long bytesSentAndReceived new long bytesSentAndReceived ipvalues getLong bytesSentAndReceived ipvalues getLong if bytesSentAndReceived bytesSentAndReceived answer ipBytes put ipstat getString bytesSentAndReceived s_logger debug response catch URISyntaxException e e printStackTrace catch ExecutionException e
for int i i statsIPList length i JSONObject ipstat statsIPList getJSONObject i JSONObject ipvalues ipstat getJSONObject if ipstat null long bytesSentAndReceived new long bytesSentAndReceived ipvalues getLong bytesSentAndReceived ipvalues getLong if bytesSentAndReceived bytesSentAndReceived answer ipBytes put ipstat getString bytesSentAndReceived s_logger debug response catch URISyntaxException e e printStackTrace catch ExecutionException e s_logger debug e getMessage e printStackTrace
public static HttpClient getHttpClient HttpClient httpClient null TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted X509Certificate chain String authType throws CertificateException return true try SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_PORT sf ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e s_logger error e getMessage catch UnrecoverableKeyException e
TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted X509Certificate chain String authType throws CertificateException return true try SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_PORT sf ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e s_logger error e getMessage catch UnrecoverableKeyException e s_logger error e getMessage catch NoSuchAlgorithmException e
return true try SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_PORT sf ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e s_logger error e getMessage catch UnrecoverableKeyException e s_logger error e getMessage catch NoSuchAlgorithmException e s_logger error e getMessage catch KeyStoreException e
public static String getHttpRequest final String jsonCmd final URI agentUri String sessionID throws ExecutionException String logMessage StringEscapeUtils unescapeJava jsonCmd logMessage cleanPassword logMessage
public static String getHttpRequest final String jsonCmd final URI agentUri String sessionID throws ExecutionException String logMessage StringEscapeUtils unescapeJava jsonCmd logMessage cleanPassword logMessage s_logger debug agentUri toString logMessage HttpClient httpClient getHttpClient String result null try HttpGet request new HttpGet agentUri StringEntity cmdJson new StringEntity jsonCmd request addHeader request addHeader sessionID
public static String getHttpRequest final String jsonCmd final URI agentUri String sessionID throws ExecutionException String logMessage StringEscapeUtils unescapeJava jsonCmd logMessage cleanPassword logMessage s_logger debug agentUri toString logMessage HttpClient httpClient getHttpClient String result null try HttpGet request new HttpGet agentUri StringEntity cmdJson new StringEntity jsonCmd request addHeader request addHeader sessionID s_logger debug agentUri toString logMessage HttpResponse response httpClient execute request if response getStatusLine getStatusCode HttpStatus SC_NOT_FOUND String errMsg response getStatusLine getStatusCode
s_logger debug agentUri toString logMessage HttpClient httpClient getHttpClient String result null try HttpGet request new HttpGet agentUri StringEntity cmdJson new StringEntity jsonCmd request addHeader request addHeader sessionID s_logger debug agentUri toString logMessage HttpResponse response httpClient execute request if response getStatusLine getStatusCode HttpStatus SC_NOT_FOUND String errMsg response getStatusLine getStatusCode s_logger error errMsg String unsupportMsg agentUri getPath Answer ans new UnsupportedAnswer null unsupportMsg
HttpGet request new HttpGet agentUri StringEntity cmdJson new StringEntity jsonCmd request addHeader request addHeader sessionID s_logger debug agentUri toString logMessage HttpResponse response httpClient execute request if response getStatusLine getStatusCode HttpStatus SC_NOT_FOUND String errMsg response getStatusLine getStatusCode s_logger error errMsg String unsupportMsg agentUri getPath Answer ans new UnsupportedAnswer null unsupportMsg s_logger error ans result s_gson toJson new Answer ans else if response getStatusLine getStatusCode HttpStatus SC_OK String errMsg agentUri toString response getStatusLine getStatusCode
HttpResponse response httpClient execute request if response getStatusLine getStatusCode HttpStatus SC_NOT_FOUND String errMsg response getStatusLine getStatusCode s_logger error errMsg String unsupportMsg agentUri getPath Answer ans new UnsupportedAnswer null unsupportMsg s_logger error ans result s_gson toJson new Answer ans else if response getStatusLine getStatusCode HttpStatus SC_OK String errMsg agentUri toString response getStatusLine getStatusCode s_logger error errMsg throw new ExecutionException else result EntityUtils toString response getEntity String logResult cleanPassword StringEscapeUtils unescapeJava result
String errMsg response getStatusLine getStatusCode s_logger error errMsg String unsupportMsg agentUri getPath Answer ans new UnsupportedAnswer null unsupportMsg s_logger error ans result s_gson toJson new Answer ans else if response getStatusLine getStatusCode HttpStatus SC_OK String errMsg agentUri toString response getStatusLine getStatusCode s_logger error errMsg throw new ExecutionException else result EntityUtils toString response getEntity String logResult cleanPassword StringEscapeUtils unescapeJava result s_logger debug logResult catch ClientProtocolException protocolEx
String unsupportMsg agentUri getPath Answer ans new UnsupportedAnswer null unsupportMsg s_logger error ans result s_gson toJson new Answer ans else if response getStatusLine getStatusCode HttpStatus SC_OK String errMsg agentUri toString response getStatusLine getStatusCode s_logger error errMsg throw new ExecutionException else result EntityUtils toString response getEntity String logResult cleanPassword StringEscapeUtils unescapeJava result s_logger debug logResult catch ClientProtocolException protocolEx s_logger error protocolEx catch IOException connEx
public static String postHttpRequest final String jsonCmd final URI agentUri String sessionID throws ExecutionException String logMessage StringEscapeUtils unescapeJava jsonCmd logMessage cleanPassword logMessage
String logMessage StringEscapeUtils unescapeJava jsonCmd logMessage cleanPassword logMessage s_logger debug agentUri toString logMessage HttpClient httpClient getHttpClient TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted X509Certificate chain String authType throws CertificateException return true try SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_PORT sf ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e
s_logger debug agentUri toString logMessage HttpClient httpClient getHttpClient TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted X509Certificate chain String authType throws CertificateException return true try SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_PORT sf ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e s_logger error e getMessage catch UnrecoverableKeyException e
TrustStrategy easyStrategy new TrustStrategy Override public boolean isTrusted X509Certificate chain String authType throws CertificateException return true try SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_PORT sf ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e s_logger error e getMessage catch UnrecoverableKeyException e s_logger error e getMessage catch NoSuchAlgorithmException e
return true try SSLSocketFactory sf new SSLSocketFactory easyStrategy new AllowAllHostnameVerifier SchemeRegistry registry new SchemeRegistry registry register new Scheme DEFAULT_PORT sf ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e s_logger error e getMessage catch UnrecoverableKeyException e s_logger error e getMessage catch NoSuchAlgorithmException e s_logger error e getMessage catch KeyStoreException e
ClientConnectionManager ccm new BasicClientConnectionManager registry httpClient new DefaultHttpClient ccm catch KeyManagementException e s_logger error e getMessage catch UnrecoverableKeyException e s_logger error e getMessage catch NoSuchAlgorithmException e s_logger error e getMessage catch KeyStoreException e s_logger error e getMessage String result null try HttpPost request new HttpPost agentUri StringEntity cmdJson new StringEntity jsonCmd request addHeader
final String results new String cmd getIpAddresses length int i try final IpAddressTO ips cmd getIpAddresses for final IpAddressTO ip ips final long guestVlanTag Long parseLong ip getBroadcastUri final String vlanSelfIp ip getVlanGateway final String vlanNetmask ip getVlanNetmask if ip isAdd addGuestVlanAndSubnet guestVlanTag vlanSelfIp vlanNetmask true else deleteGuestVlan guestVlanTag vlanSelfIp vlanNetmask saveConfiguration results i ip getPublicIp final String action ip isAdd
try final IpAddressTO ips cmd getIpAddresses for final IpAddressTO ip ips final long guestVlanTag Long parseLong ip getBroadcastUri final String vlanSelfIp ip getVlanGateway final String vlanNetmask ip getVlanNetmask if ip isAdd addGuestVlanAndSubnet guestVlanTag vlanSelfIp vlanNetmask true else deleteGuestVlan guestVlanTag vlanSelfIp vlanNetmask saveConfiguration results i ip getPublicIp final String action ip isAdd if s_logger isDebugEnabled s_logger debug _ip action ip
final String nsVirtualServerName generateNSVirtualServerName loadBalancer getSrcIp loadBalancer getSrcPort final com citrix netscaler nitro resource config lb lbvserver_service_binding serviceBindings com citrix netscaler nitro resource config lb lbvserver_service_binding get _netscalerService nsVirtualServerName if serviceBindings null for final DestinationTO destination loadBalancer getDestinations final String nsServiceName generateNSServiceName destination getDestIp destination getDestPort for final com citrix netscaler nitro resource config lb lbvserver_service_binding binding serviceBindings if nsServiceName equalsIgnoreCase binding get_servicename destination setMonitorState binding get_curstate break hcLB add loadBalancer catch final ExecutionException e s_logger error e if shouldRetry numRetries return retry cmd numRetries else
final String nsVirtualServerName generateNSVirtualServerName srcIp srcPort final String nsMonitorName generateNSMonitorName srcIp srcPort final LbSslCert sslCert loadBalancer getSslCert if loadBalancer isAutoScaleVmGroupTO applyAutoScaleConfig loadBalancer continue boolean hasMonitor false boolean deleteMonitor false boolean destinationsToAdd false boolean deleteCert false for final DestinationTO destination loadBalancer getDestinations if destination isRevoked destinationsToAdd true break if loadBalancer isRevoked destinationsToAdd
if newVpx get_instance_state equalsIgnoreCase return new Answer cmd new ExecutionException vpxName _ip startTick System currentTimeMillis boolean nsServiceUp false final long nsServiceWaitMilliSeconds while System currentTimeMillis startTick nsServiceWaitMilliSeconds try final nitro_service netscalerService new nitro_service cmd getLoadBalancerIP netscalerService set_certvalidation false netscalerService set_hostnameverification false netscalerService set_credential username password apiCallResult netscalerService login if apiCallResult errorcode nsServiceUp true break
try ns vpxToDelete null final ns vpxInstances ns get _netscalerSdxService for final ns vpx vpxInstances if vpx get_name equals vpxName vpxToDelete vpx break if vpxToDelete null final String msg vpxName _ip s_logger warn msg return new DestroyLoadBalancerApplianceAnswer cmd true msg final ns nsDelObj new ns nsDelObj set_id vpxToDelete get_id vpxToDelete ns delete _netscalerSdxService nsDelObj final String msg vpxName _ip
catch final nitro_exception e if e getErrorCode NitroError NS_RESOURCE_NOT_EXISTS throw e if iNatRule null iNatRule new inat iNatRule set_name iNatRuleName iNatRule set_publicip srcIp iNatRule set_privateip dstIP iNatRule set_usnip iNatRule set_usip try apiCallResult inat add _netscalerService iNatRule catch final nitro_exception e if e getErrorCode NitroError NS_RESOURCE_EXISTS throw e
s_logger debug _ip srcIp dstIP try final rnat rnatRules rnat get _netscalerService if rnatRules null for final rnat rantrule rnatRules if rantrule get_network equalsIgnoreCase rNatRuleName rnatRule rantrule break catch final nitro_exception e throw e if rnatRule null rnatRule new rnat rnatRule set_natip srcIp rnatRule set_network dstIP rnatRule set_netmask
catch final nitro_exception e throw e if rnatRule null rnatRule new rnat rnatRule set_natip srcIp rnatRule set_network dstIP rnatRule set_netmask try apiCallResult rnat update _netscalerService rnatRule catch final nitro_exception e if e getErrorCode NitroError NS_RESOURCE_EXISTS throw e s_logger debug _ip dstIP srcIp else try
csMonitorExisis true if csMonitorExisis final lbmonitor csMon new lbmonitor csMon set_monitorname nsMonitorName csMon set_type lbProtocol if lbProtocol equalsIgnoreCase csMon set_httprequest hcp getpingPath s_logger trace else s_logger debug csMon set_interval hcp getHealthcheckInterval csMon set_retries Math max hcp getHealthcheckThresshold hcp getUnhealthThresshold csMon set_resptimeout hcp getResponseTime csMon set_failureretries hcp getUnhealthThresshold csMon set_successretries hcp getHealthcheckThresshold
if csMonitorExisis final lbmonitor csMon new lbmonitor csMon set_monitorname nsMonitorName csMon set_type lbProtocol if lbProtocol equalsIgnoreCase csMon set_httprequest hcp getpingPath s_logger trace else s_logger debug csMon set_interval hcp getHealthcheckInterval csMon set_retries Math max hcp getHealthcheckThresshold hcp getUnhealthThresshold csMon set_resptimeout hcp getResponseTime csMon set_failureretries hcp getUnhealthThresshold csMon set_successretries hcp getHealthcheckThresshold s_logger debug csMon get_interval csMon get_resptimeout csMon get_failureretries csMon get_successretries
private void bindServiceToMonitor final String nsServiceName final String nsMonitorName throws ExecutionException try com citrix netscaler nitro resource config basic service serviceObject new com citrix netscaler nitro resource config basic service serviceObject com citrix netscaler nitro resource config basic service get _netscalerService nsServiceName if serviceObject null final com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor new com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor set_monitor_name nsMonitorName serviceMonitor set_name nsServiceName serviceMonitor set_monstate
private void bindServiceToMonitor final String nsServiceName final String nsMonitorName throws ExecutionException try com citrix netscaler nitro resource config basic service serviceObject new com citrix netscaler nitro resource config basic service serviceObject com citrix netscaler nitro resource config basic service get _netscalerService nsServiceName if serviceObject null final com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor new com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor set_monitor_name nsMonitorName serviceMonitor set_name nsServiceName serviceMonitor set_monstate s_logger debug nsMonitorName nsServiceName com citrix netscaler nitro resource config basic service_lbmonitor_binding add _netscalerService serviceMonitor
private void unBindServiceToMonitor final String nsServiceName final String nsMonitorName throws ExecutionException try com citrix netscaler nitro resource config basic service serviceObject new com citrix netscaler nitro resource config basic service serviceObject com citrix netscaler nitro resource config basic service get _netscalerService nsServiceName if serviceObject null final com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor new com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor set_monitor_name nsMonitorName serviceMonitor set_name nsServiceName
private void unBindServiceToMonitor final String nsServiceName final String nsMonitorName throws ExecutionException try com citrix netscaler nitro resource config basic service serviceObject new com citrix netscaler nitro resource config basic service serviceObject com citrix netscaler nitro resource config basic service get _netscalerService nsServiceName if serviceObject null final com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor new com citrix netscaler nitro resource config basic service_lbmonitor_binding serviceMonitor set_monitor_name nsMonitorName serviceMonitor set_name nsServiceName s_logger debug nsMonitorName nsServiceName service_lbmonitor_binding delete _netscalerService serviceMonitor
private void removeLBMonitor final String nsMonitorName throws ExecutionException try if nsMonitorExist nsMonitorName final lbmonitor monitorObj lbmonitor get _netscalerService nsMonitorName monitorObj set_respcode null lbmonitor delete _netscalerService monitorObj
private synchronized boolean createAutoScaleConfig final LoadBalancerTO loadBalancerTO throws ExecutionException Exception final String srcIp loadBalancerTO getSrcIp final int srcPort loadBalancerTO getSrcPort final String lbProtocol getNetScalerProtocol loadBalancerTO final String lbAlgorithm loadBalancerTO getAlgorithm generateAutoScaleVmGroupIdentifier loadBalancerTO final String nsVirtualServerName generateNSVirtualServerName srcIp srcPort final AutoScaleVmGroupTO vmGroupTO loadBalancerTO getAutoScaleVmGroupTO if s_logger isDebugEnabled
if stats null stats length return answer for final lbvserver_stats stat_entry stats final String lbvserverName stat_entry get_name final lbvserver vserver lbvserver get _netscalerService lbvserverName if vserver null final String lbVirtualServerIp vserver get_ipv46 long bytesSentAndReceived answer ipBytes get lbVirtualServerIp if bytesSentAndReceived null bytesSentAndReceived new long bytesSentAndReceived stat_entry get_totalrequestbytes bytesSentAndReceived stat_entry get_totalresponsebytes if bytesSentAndReceived bytesSentAndReceived answer ipBytes put lbVirtualServerIp bytesSentAndReceived catch final Exception e
protected VirtualRouter stopInternalLbVm DomainRouterVO internalLbVm boolean forced Account caller long callerUserId throws ResourceUnavailableException ConcurrentOperationException
public VirtualRouterProvider addNetScalerLoadBalancerElement long ntwkSvcProviderId VirtualRouterProviderVO element _vrProviderDao findByNspIdAndType ntwkSvcProviderId com cloud network VirtualRouterProvider Type NetScalerVm if element null
protected void startNsVpx VMInstanceVO nsVpx Map Param Object params throws StorageUnavailableException InsufficientCapacityException ConcurrentOperationException ResourceUnavailableException
protected VirtualRouter stopNetScalerVm final long vmId final boolean forced final Account caller final long callerUserId throws ResourceUnavailableException ConcurrentOperationException final DomainRouterVO netscalerVm _routerDao findById vmId
Override public VirtualRouter stopNetScalerVm Long vmId boolean forced Account caller long callingUserId final DomainRouterVO netscalerVm _routerDao findById vmId
protected boolean canHandle Network network Service service
Override public boolean implement Network network NetworkOffering offering DeployDestination dest ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException
else if network getGuestType equals GuestType Isolated networkModel isProviderSupportServiceInNetwork network getId Service SourceNat Provider NiciraNvp s_logger debug PublicIp sourceNatIp ipAddrMgr assignSourceNatIpAddressToGuestNetwork owner network String publicCidr sourceNatIp getAddress addr NetUtils getCidrSize sourceNatIp getVlanNetmask String internalCidr network getGateway network getCidr split String vtag sourceNatIp getVlanTag BroadcastDomainType tiep null try tiep BroadcastDomainType getTypeOf vtag catch URISyntaxException use throw new CloudRuntimeException vtag use if tiep BroadcastDomainType Vlan vtag BroadcastDomainType Vlan getValueFrom BroadcastDomainType fromString vtag else if tiep BroadcastDomainType UnDecided tiep BroadcastDomainType Native throw new CloudRuntimeException vtag
private boolean sharedNetworkSupportUUIDVlanId Network network String lSwitchUuid String ownerName HostVO niciraNvpHost String networkCidr network getCidr String vlanGateway network getGateway String portIpAddress createLogicalRouterPortIpAddress networkCidr vlanGateway NiciraNvpRouterMappingVO mapRouterNetwork niciraNvpRouterMappingDao findByNetworkId network getId String lRouterUuid mapRouterNetwork getLogicalRouterUuid ConfigureSharedNetworkUuidCommand cmd new ConfigureSharedNetworkUuidCommand lRouterUuid lSwitchUuid portIpAddress ownerName network getId ConfigureSharedNetworkUuidAnswer answer ConfigureSharedNetworkUuidAnswer agentMgr easySend niciraNvpHost getId cmd if answer getResult false
NicVO nicVO nicDao findById nic getId List NiciraNvpDeviceVO devices niciraNvpDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty s_logger error network getPhysicalNetworkId return false NiciraNvpDeviceVO niciraNvpDevice devices get HostVO niciraNvpHost hostDao findById niciraNvpDevice getHostId NiciraNvpNicMappingVO existingNicMap niciraNvpNicMappingDao findByNicUuid nicVO getUuid if existingNicMap null FindLogicalSwitchPortCommand findCmd new FindLogicalSwitchPortCommand existingNicMap getLogicalSwitchUuid existingNicMap getLogicalSwitchPortUuid FindLogicalSwitchPortAnswer answer FindLogicalSwitchPortAnswer agentMgr easySend niciraNvpHost getId findCmd if answer getResult s_logger warn nic getName existingNicMap getLogicalSwitchPortUuid UpdateLogicalSwitchPortCommand cmd new UpdateLogicalSwitchPortCommand existingNicMap getLogicalSwitchPortUuid BroadcastDomainType getValue network getBroadcastUri nicVO getUuid context getDomain getName context getAccount getAccountName nic getName agentMgr easySend niciraNvpHost getId cmd
Override public boolean release Network network NicProfile nic VirtualMachineProfile vm ReservationContext context throws ConcurrentOperationException ResourceUnavailableException if canHandle network Service Connectivity return false if network getBroadcastUri null s_logger error return false NicVO nicVO nicDao findById nic getId List NiciraNvpDeviceVO devices niciraNvpDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty s_logger error network getPhysicalNetworkId return false NiciraNvpDeviceVO niciraNvpDevice devices get HostVO niciraNvpHost hostDao findById niciraNvpDevice getHostId NiciraNvpNicMappingVO nicMap niciraNvpNicMappingDao findByNicUuid nicVO getUuid if nicMap null
List NiciraNvpDeviceVO devices niciraNvpDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty s_logger error network getPhysicalNetworkId return false NiciraNvpDeviceVO niciraNvpDevice devices get HostVO niciraNvpHost hostDao findById niciraNvpDevice getHostId if network getGuestType equals GuestType Shared networkModel isProviderSupportServiceInNetwork network getId Service SourceNat Provider NiciraNvp s_logger debug NiciraNvpRouterMappingVO routermapping niciraNvpRouterMappingDao findByNetworkId network getId if routermapping null s_logger warn network getDisplayText return true DeleteLogicalRouterCommand cmd new DeleteLogicalRouterCommand routermapping getLogicalRouterUuid DeleteLogicalRouterAnswer answer DeleteLogicalRouterAnswer agentMgr easySend niciraNvpHost getId cmd if answer getResult false
Override public boolean applyIps Network network List extends PublicIpAddress ipAddress Set Service services throws ResourceUnavailableException if services contains Service SourceNat List NiciraNvpDeviceVO devices niciraNvpDao listByPhysicalNetwork network getPhysicalNetworkId if devices isEmpty
private void sharedNetworksCleanup NetworkVO networkObject String logicalSwitchUuid HostVO niciraNvpHost NiciraNvpRouterMappingVO routermapping niciraNvpRouterMappingDao findByNetworkId networkObject getId if routermapping null
private void sharedNetworksCleanup NetworkVO networkObject String logicalSwitchUuid HostVO niciraNvpHost NiciraNvpRouterMappingVO routermapping niciraNvpRouterMappingDao findByNetworkId networkObject getId if routermapping null s_logger info networkObject getDisplayText else String lRouterUuid routermapping getLogicalRouterUuid s_logger debug lRouterUuid logicalSwitchUuid final FindLogicalRouterPortCommand cmd new FindLogicalRouterPortCommand lRouterUuid logicalSwitchUuid final FindLogicalRouterPortAnswer answer FindLogicalRouterPortAnswer agentMgr easySend niciraNvpHost getId cmd if answer null answer getResult String logicalRouterPortUuid answer getLogicalRouterPortUuid s_logger debug logicalRouterPortUuid final DeleteLogicalRouterPortCommand cmdDeletePort new DeleteLogicalRouterPortCommand lRouterUuid logicalRouterPortUuid final DeleteLogicalRouterPortAnswer answerDelete DeleteLogicalRouterPortAnswer agentMgr easySend niciraNvpHost getId cmdDeletePort if answerDelete null answerDelete getResult
if routermapping null s_logger info networkObject getDisplayText else String lRouterUuid routermapping getLogicalRouterUuid s_logger debug lRouterUuid logicalSwitchUuid final FindLogicalRouterPortCommand cmd new FindLogicalRouterPortCommand lRouterUuid logicalSwitchUuid final FindLogicalRouterPortAnswer answer FindLogicalRouterPortAnswer agentMgr easySend niciraNvpHost getId cmd if answer null answer getResult String logicalRouterPortUuid answer getLogicalRouterPortUuid s_logger debug logicalRouterPortUuid final DeleteLogicalRouterPortCommand cmdDeletePort new DeleteLogicalRouterPortCommand lRouterUuid logicalRouterPortUuid final DeleteLogicalRouterPortAnswer answerDelete DeleteLogicalRouterPortAnswer agentMgr easySend niciraNvpHost getId cmdDeletePort if answerDelete null answerDelete getResult s_logger info logicalRouterPortUuid else
private CloseableHttpResponse handleUnauthorizedResponse final HttpUriRequest request final int previousStatusCode final CloseableHttpResponse response final int statusCode throws CloudstackRESTException super closeResponse response if HttpStatusCodeHelper isUnauthorized previousStatusCode
Override public PingCommand getCurrentStatus final long id try final ControlClusterStatus ccs niciraNvpApi getControlClusterStatus getApiProviderMajorityVersion ccs if equals ccs getClusterStatus
Override public Answer execute final ConfigurePortForwardingRulesOnLogicalRouterCommand command final NiciraNvpResource niciraNvpResource final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi try final List NatRule existingRules niciraNvpApi findNatRulesByLogicalRouterUuid command getLogicalRouterUuid for final PortForwardingRuleTO rule command getRules if rule isAlreadyAdded rule revoked continue if rule getDstPortRange rule getDstPortRange rule getSrcPortRange rule getSrcPortRange return new ConfigurePortForwardingRulesOnLogicalRouterAnswer command false final NatRule rulepair niciraNvpResource generatePortForwardingRulePair rule getDstIp rule getDstPortRange rule getSrcIp rule getSrcPortRange rule getProtocol NatRule incoming null NatRule outgoing null for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule
if rule isAlreadyAdded rule revoked continue if rule getDstPortRange rule getDstPortRange rule getSrcPortRange rule getSrcPortRange return new ConfigurePortForwardingRulesOnLogicalRouterAnswer command false final NatRule rulepair niciraNvpResource generatePortForwardingRulePair rule getDstIp rule getDstPortRange rule getSrcIp rule getSrcPortRange rule getProtocol NatRule incoming null NatRule outgoing null for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule s_logger debug outgoing getUuid if incoming null break else if storedRule equalsIgnoreUuid rulepair incoming storedRule
final NatRule rulepair niciraNvpResource generatePortForwardingRulePair rule getDstIp rule getDstPortRange rule getSrcIp rule getSrcPortRange rule getProtocol NatRule incoming null NatRule outgoing null for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule s_logger debug outgoing getUuid if incoming null break else if storedRule equalsIgnoreUuid rulepair incoming storedRule s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null
NatRule incoming null NatRule outgoing null for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule s_logger debug outgoing getUuid if incoming null break else if storedRule equalsIgnoreUuid rulepair incoming storedRule s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null if rule revoked
break else if storedRule equalsIgnoreUuid rulepair incoming storedRule s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null if rule revoked s_logger debug incoming getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid incoming getUuid s_logger debug outgoing getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid outgoing getUuid else if rule revoked s_logger warn rule getSrcIp rule getDstIp
else if storedRule equalsIgnoreUuid rulepair incoming storedRule s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null if rule revoked s_logger debug incoming getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid incoming getUuid s_logger debug outgoing getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid outgoing getUuid else if rule revoked s_logger warn rule getSrcIp rule getDstIp break
Override public Answer execute ConfigureSharedNetworkUuidCommand command NiciraNvpResource niciraNvpResource final String logicalRouterUuid command getLogicalRouterUuid final String logicalSwitchUuid command getLogicalSwitchUuid final String portIpAddress command getPortIpAddress final List NiciraNvpTag tags new ArrayList NiciraNvpTag tags add new NiciraNvpTag command getOwnerName final long networkId command getNetworkId final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi
Override public Answer execute ConfigureSharedNetworkUuidCommand command NiciraNvpResource niciraNvpResource final String logicalRouterUuid command getLogicalRouterUuid final String logicalSwitchUuid command getLogicalSwitchUuid final String portIpAddress command getPortIpAddress final List NiciraNvpTag tags new ArrayList NiciraNvpTag tags add new NiciraNvpTag command getOwnerName final long networkId command getNetworkId final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi s_logger debug logicalSwitchUuid logicalRouterUuid networkId
final String logicalSwitchUuid command getLogicalSwitchUuid final String portIpAddress command getPortIpAddress final List NiciraNvpTag tags new ArrayList NiciraNvpTag tags add new NiciraNvpTag command getOwnerName final long networkId command getNetworkId final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi s_logger debug logicalSwitchUuid logicalRouterUuid networkId s_logger info logicalSwitchUuid String logicalSwitchDisplayName try List LogicalSwitch lSwitchList niciraNvpApi findLogicalSwitch logicalSwitchUuid if lSwitchList null if lSwitchList size logicalSwitchDisplayName lSwitchList get getDisplayName else
tags add new NiciraNvpTag command getOwnerName final long networkId command getNetworkId final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi s_logger debug logicalSwitchUuid logicalRouterUuid networkId s_logger info logicalSwitchUuid String logicalSwitchDisplayName try List LogicalSwitch lSwitchList niciraNvpApi findLogicalSwitch logicalSwitchUuid if lSwitchList null if lSwitchList size logicalSwitchDisplayName lSwitchList get getDisplayName else s_logger error logicalSwitchUuid throw new CloudRuntimeException logicalSwitchUuid else
if lSwitchList null if lSwitchList size logicalSwitchDisplayName lSwitchList get getDisplayName else s_logger error logicalSwitchUuid throw new CloudRuntimeException logicalSwitchUuid else s_logger error logicalSwitchUuid throw new CloudRuntimeException logicalSwitchUuid catch NiciraNvpApiException e s_logger warn logicalSwitchUuid final CommandRetryUtility retryUtility niciraNvpResource getRetryUtility retryUtility addRetry command NUM_RETRIES return retryUtility retry command ConfigureSharedNetworkUuidAnswer class e catch CloudRuntimeException e
return retryUtility retry command ConfigureSharedNetworkUuidAnswer class e catch CloudRuntimeException e s_logger info e getMessage return new ConfigureSharedNetworkUuidAnswer command false e getMessage s_logger info logicalSwitchDisplayName logicalSwitchUuid s_logger debug logicalRouterUuid LogicalRouterPort lRouterPort null try lRouterPort new LogicalRouterPort lRouterPort setAdminStatusEnabled true lRouterPort setDisplayName niciraNvpResource truncate logicalSwitchDisplayName NAME_MAX_LEN lRouterPort setTags tags final List String ipAddresses new ArrayList String ipAddresses add portIpAddress lRouterPort setIpAddresses ipAddresses
return retryUtility retry command ConfigureSharedNetworkUuidAnswer class e catch CloudRuntimeException e s_logger info e getMessage return new ConfigureSharedNetworkUuidAnswer command false e getMessage s_logger info logicalSwitchDisplayName logicalSwitchUuid s_logger debug logicalRouterUuid LogicalRouterPort lRouterPort null try lRouterPort new LogicalRouterPort lRouterPort setAdminStatusEnabled true lRouterPort setDisplayName niciraNvpResource truncate logicalSwitchDisplayName NAME_MAX_LEN lRouterPort setTags tags final List String ipAddresses new ArrayList String ipAddresses add portIpAddress lRouterPort setIpAddresses ipAddresses
lRouterPort new LogicalRouterPort lRouterPort setAdminStatusEnabled true lRouterPort setDisplayName niciraNvpResource truncate logicalSwitchDisplayName NAME_MAX_LEN lRouterPort setTags tags final List String ipAddresses new ArrayList String ipAddresses add portIpAddress lRouterPort setIpAddresses ipAddresses lRouterPort niciraNvpApi createLogicalRouterPort logicalRouterUuid lRouterPort catch NiciraNvpApiException e s_logger warn logicalRouterUuid e getMessage return handleException e command niciraNvpResource s_logger debug lRouterPort getUuid lRouterPort getDisplayName logicalRouterUuid s_logger debug logicalSwitchUuid logicalSwitchDisplayName LogicalSwitchPort lSwitchPort null try
lRouterPort new LogicalRouterPort lRouterPort setAdminStatusEnabled true lRouterPort setDisplayName niciraNvpResource truncate logicalSwitchDisplayName NAME_MAX_LEN lRouterPort setTags tags final List String ipAddresses new ArrayList String ipAddresses add portIpAddress lRouterPort setIpAddresses ipAddresses lRouterPort niciraNvpApi createLogicalRouterPort logicalRouterUuid lRouterPort catch NiciraNvpApiException e s_logger warn logicalRouterUuid e getMessage return handleException e command niciraNvpResource s_logger debug lRouterPort getUuid lRouterPort getDisplayName logicalRouterUuid s_logger debug logicalSwitchUuid logicalSwitchDisplayName LogicalSwitchPort lSwitchPort null try
catch NiciraNvpApiException e s_logger warn logicalRouterUuid e getMessage return handleException e command niciraNvpResource s_logger debug lRouterPort getUuid lRouterPort getDisplayName logicalRouterUuid s_logger debug logicalSwitchUuid logicalSwitchDisplayName LogicalSwitchPort lSwitchPort null try lSwitchPort new LogicalSwitchPort niciraNvpResource truncate NAME_MAX_LEN tags true lSwitchPort niciraNvpApi createLogicalSwitchPort logicalSwitchUuid lSwitchPort catch NiciraNvpApiException e s_logger warn logicalSwitchUuid logicalSwitchDisplayName e getMessage cleanupLRouterPort logicalRouterUuid lRouterPort niciraNvpApi return handleException e command niciraNvpResource s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName logicalSwitchUuid logicalSwitchDisplayName s_logger debug lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName
catch NiciraNvpApiException e s_logger warn logicalRouterUuid e getMessage return handleException e command niciraNvpResource s_logger debug lRouterPort getUuid lRouterPort getDisplayName logicalRouterUuid s_logger debug logicalSwitchUuid logicalSwitchDisplayName LogicalSwitchPort lSwitchPort null try lSwitchPort new LogicalSwitchPort niciraNvpResource truncate NAME_MAX_LEN tags true lSwitchPort niciraNvpApi createLogicalSwitchPort logicalSwitchUuid lSwitchPort catch NiciraNvpApiException e s_logger warn logicalSwitchUuid logicalSwitchDisplayName e getMessage cleanupLRouterPort logicalRouterUuid lRouterPort niciraNvpApi return handleException e command niciraNvpResource s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName logicalSwitchUuid logicalSwitchDisplayName s_logger debug lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName
lSwitchPort niciraNvpApi createLogicalSwitchPort logicalSwitchUuid lSwitchPort catch NiciraNvpApiException e s_logger warn logicalSwitchUuid logicalSwitchDisplayName e getMessage cleanupLRouterPort logicalRouterUuid lRouterPort niciraNvpApi return handleException e command niciraNvpResource s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName logicalSwitchUuid logicalSwitchDisplayName s_logger debug lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName try niciraNvpApi updateLogicalRouterPortAttachment logicalRouterUuid lRouterPort getUuid new PatchAttachment lSwitchPort getUuid catch NiciraNvpApiException e s_logger warn lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName e getMessage cleanupLRouterPort logicalRouterUuid lRouterPort niciraNvpApi cleanupLSwitchPort logicalSwitchUuid lSwitchPort niciraNvpApi return handleException e command niciraNvpResource s_logger debug lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName
lSwitchPort niciraNvpApi createLogicalSwitchPort logicalSwitchUuid lSwitchPort catch NiciraNvpApiException e s_logger warn logicalSwitchUuid logicalSwitchDisplayName e getMessage cleanupLRouterPort logicalRouterUuid lRouterPort niciraNvpApi return handleException e command niciraNvpResource s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName logicalSwitchUuid logicalSwitchDisplayName s_logger debug lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName try niciraNvpApi updateLogicalRouterPortAttachment logicalRouterUuid lRouterPort getUuid new PatchAttachment lSwitchPort getUuid catch NiciraNvpApiException e s_logger warn lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName e getMessage cleanupLRouterPort logicalRouterUuid lRouterPort niciraNvpApi cleanupLSwitchPort logicalSwitchUuid lSwitchPort niciraNvpApi return handleException e command niciraNvpResource s_logger debug lRouterPort getUuid lRouterPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName
Override public Answer execute ConfigureSharedNetworkVlanIdCommand command NiciraNvpResource niciraNvpResource final String logicalSwitchUuid command getLogicalSwitchUuid final String l2GatewayServiceUuid command getL2GatewayServiceUuid long vlanId command getVlanId final List NiciraNvpTag tags new ArrayList NiciraNvpTag tags add new NiciraNvpTag command getOwnerName final long networkId command getNetworkId
Override public Answer execute ConfigureSharedNetworkVlanIdCommand command NiciraNvpResource niciraNvpResource final String logicalSwitchUuid command getLogicalSwitchUuid final String l2GatewayServiceUuid command getL2GatewayServiceUuid long vlanId command getVlanId final List NiciraNvpTag tags new ArrayList NiciraNvpTag tags add new NiciraNvpTag command getOwnerName final long networkId command getNetworkId s_logger debug logicalSwitchUuid l2GatewayServiceUuid vlanId networkId final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi
final long networkId command getNetworkId s_logger debug logicalSwitchUuid l2GatewayServiceUuid vlanId networkId final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi s_logger debug logicalSwitchUuid LogicalSwitchPort lSwitchPort null try lSwitchPort new LogicalSwitchPort lSwitchPort setAdminStatusEnabled true lSwitchPort setDisplayName niciraNvpResource truncate networkId NAME_MAX_LEN lSwitchPort setTags tags lSwitchPort niciraNvpApi createLogicalSwitchPort logicalSwitchUuid lSwitchPort catch NiciraNvpApiException e s_logger warn logicalSwitchUuid e getMessage return handleException e command niciraNvpResource s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName logicalSwitchUuid
catch NiciraNvpApiException e s_logger warn logicalSwitchUuid e getMessage return handleException e command niciraNvpResource s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName logicalSwitchUuid s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName command getVlanId try final L2GatewayAttachment attachment new L2GatewayAttachment l2GatewayServiceUuid if command getVlanId attachment setVlanId command getVlanId niciraNvpApi updateLogicalSwitchPortAttachment logicalSwitchUuid lSwitchPort getUuid attachment catch NiciraNvpApiException e s_logger warn lSwitchPort getUuid lSwitchPort getDisplayName lSwitchPort getUuid lSwitchPort getDisplayName e getMessage e getErrorCode cleanup logicalSwitchUuid lSwitchPort niciraNvpApi return handleException e command niciraNvpResource s_logger debug lSwitchPort getUuid lSwitchPort getDisplayName command getVlanId
Override public Answer execute final ConfigureStaticNatRulesOnLogicalRouterCommand command final NiciraNvpResource niciraNvpResource final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi try final List NatRule existingRules niciraNvpApi findNatRulesByLogicalRouterUuid command getLogicalRouterUuid for final StaticNatRuleTO rule command getRules final NatRule rulepair niciraNvpResource generateStaticNatRulePair rule getDstIp rule getSrcIp NatRule incoming null NatRule outgoing null for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule
final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi try final List NatRule existingRules niciraNvpApi findNatRulesByLogicalRouterUuid command getLogicalRouterUuid for final StaticNatRuleTO rule command getRules final NatRule rulepair niciraNvpResource generateStaticNatRulePair rule getDstIp rule getSrcIp NatRule incoming null NatRule outgoing null for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule s_logger debug outgoing getUuid if incoming null break else if storedRule equalsIgnoreUuid rulepair incoming storedRule
NatRule incoming null NatRule outgoing null for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule s_logger debug outgoing getUuid if incoming null break else if storedRule equalsIgnoreUuid rulepair incoming storedRule s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null if rule revoked
for final NatRule storedRule existingRules if storedRule equalsIgnoreUuid rulepair outgoing storedRule s_logger debug outgoing getUuid if incoming null break else if storedRule equalsIgnoreUuid rulepair incoming storedRule s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null if rule revoked s_logger debug incoming getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid incoming getUuid
else if storedRule equalsIgnoreUuid rulepair incoming storedRule s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null if rule revoked s_logger debug incoming getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid incoming getUuid s_logger debug outgoing getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid outgoing getUuid else if rule revoked s_logger warn rule getSrcIp rule getDstIp break
s_logger debug incoming getUuid if outgoing null break if incoming null outgoing null if rule revoked s_logger debug incoming getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid incoming getUuid s_logger debug outgoing getUuid niciraNvpApi deleteLogicalRouterNatRule command getLogicalRouterUuid outgoing getUuid else if rule revoked s_logger warn rule getSrcIp rule getDstIp break rulepair niciraNvpApi createLogicalRouterNatRule command getLogicalRouterUuid rulepair s_logger debug niciraNvpResource natRuleToString rulepair
Override public Answer execute final CreateLogicalRouterCommand command final NiciraNvpResource niciraNvpResource final String routerName command getName final String gatewayServiceUuid command getGatewayServiceUuid final String logicalSwitchUuid command getLogicalSwitchUuid final List NiciraNvpTag tags new ArrayList NiciraNvpTag tags add new NiciraNvpTag command getOwnerName final String publicNetworkNextHopIp command getPublicNextHop final String publicNetworkIpAddress command getPublicIpCidr final String internalNetworkAddress command getInternalIpCidr
Override public Answer execute DeleteLogicalRouterPortCommand command NiciraNvpResource niciraNvpResource final String logicalRouterUuid command getLogicalRouterUuid final String logicalRouterPortUuid command getLogicalRouterPortUuid final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi
Override public Answer execute FindL2GatewayServiceCommand command NiciraNvpResource niciraNvpResource final GatewayServiceConfig config command getGatewayServiceConfig final String uuid config getUuid final String type config getType final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi
Override public Answer execute FindLogicalRouterPortCommand command NiciraNvpResource niciraNvpResource final String logicalRouterUuid command getLogicalRouterUuid final String attachmentLswitchUuid command getAttachmentLswitchUuid final NiciraNvpApi niciraNvpApi niciraNvpResource getNiciraNvpApi
Override public void reserve NicProfile nic Network network VirtualMachineProfile vm DeployDestination dest ReservationContext context throws InsufficientVirtualNetworkCapacityException InsufficientAddressCapacityException super reserve nic network vm dest context Long physicalNetworkId network getPhysicalNetworkId List OpenDaylightControllerVO devices openDaylightControllerMappingDao listByPhysicalNetwork physicalNetworkId if devices isEmpty
Override public boolean release NicProfile nic VirtualMachineProfile vm String reservationId boolean success super release nic vm reservationId if success NetworkVO network _networkDao findById nic getNetworkId Long physicalNetworkId network getPhysicalNetworkId List OpenDaylightControllerVO devices openDaylightControllerMappingDao listByPhysicalNetwork physicalNetworkId if devices isEmpty
gre_key i break catch NeutronRestApiException e s_logger error e return new ConfigureNetworkAnswer cmd e NeutronNetwork newNetwork new NeutronNetwork newNetwork setName cmd getName newNetwork setTenantId cmd getTenantId newNetwork setNetworkType newNetwork setShared false newNetwork setSegmentationId gre_key newNetwork setId UUID randomUUID NeutronNetworkWrapper wrapper new NeutronNetworkWrapper wrapper setNetwork newNetwork try
NeutronPort newPort new NeutronPort newPort setId cmd getPortId newPort setTenantId cmd getTennantId newPort setAdminStateUp true newPort setName cmd getPortId toString newPort setNetworkId cmd getNetworkId newPort setMacAddress cmd getMacAddress newPort setDeviceId UUID randomUUID newPort setStatus newPort setFixedIps Collections String emptyList NeutronPortWrapper portWrapper new NeutronPortWrapper portWrapper setPort newPort try portWrapper configurePort createNeutronPort portWrapper catch NeutronRestApiException e
String formattedUrl neutronUrl toString uri url new URL formattedUrl toString Constructor extends HttpMethodBase httpMethodConstructor httpClazz getConstructor String class HttpMethodBase httpMethod httpMethodConstructor newInstance url return httpMethod catch MalformedURLException e String error s_logger error error e throw new NeutronRestApiException error e catch NoSuchMethodException e String error s_logger error error e throw new NeutronRestApiException error e catch SecurityException e String error
return httpMethod catch MalformedURLException e String error s_logger error error e throw new NeutronRestApiException error e catch NoSuchMethodException e String error s_logger error error e throw new NeutronRestApiException error e catch SecurityException e String error s_logger error error e throw new NeutronRestApiException error e catch InstantiationException e String error
s_logger error error e throw new NeutronRestApiException error e catch NoSuchMethodException e String error s_logger error error e throw new NeutronRestApiException error e catch SecurityException e String error s_logger error error e throw new NeutronRestApiException error e catch InstantiationException e String error s_logger error error e throw new NeutronRestApiException error e catch IllegalAccessException e
String error s_logger error error e throw new NeutronRestApiException error e catch SecurityException e String error s_logger error error e throw new NeutronRestApiException error e catch InstantiationException e String error s_logger error error e throw new NeutronRestApiException error e catch IllegalAccessException e String error s_logger error error e throw new NeutronRestApiException error e
catch SecurityException e String error s_logger error error e throw new NeutronRestApiException error e catch InstantiationException e String error s_logger error error e throw new NeutronRestApiException error e catch IllegalAccessException e String error s_logger error error e throw new NeutronRestApiException error e catch IllegalArgumentException e String error s_logger error error e
NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi GetMethod class GetMethod getMethod GetMethod neutronRestApi createMethod url uri try getMethod setRequestHeader CONTENT_TYPE JSON_CONTENT_TYPE String encodedCredentials encodeCredentials getMethod setRequestHeader encodedCredentials if parameters null parameters isEmpty List NameValuePair nameValuePairs new ArrayList NameValuePair parameters size for Entry String String e parameters entrySet nameValuePairs add new NameValuePair e getKey e getValue getMethod setQueryString nameValuePairs toArray new NameValuePair neutronRestApi executeMethod getMethod if getMethod getStatusCode HttpStatus SC_OK String errorMessage responseToErrorMessage getMethod
try getMethod setRequestHeader CONTENT_TYPE JSON_CONTENT_TYPE String encodedCredentials encodeCredentials getMethod setRequestHeader encodedCredentials if parameters null parameters isEmpty List NameValuePair nameValuePairs new ArrayList NameValuePair parameters size for Entry String String e parameters entrySet nameValuePairs add new NameValuePair e getKey e getValue getMethod setQueryString nameValuePairs toArray new NameValuePair neutronRestApi executeMethod getMethod if getMethod getStatusCode HttpStatus SC_OK String errorMessage responseToErrorMessage getMethod getMethod releaseConnection s_logger error errorMessage throw new NeutronRestApiException errorMessage
validateCredentials catch NeutronInvalidCredentialsException e throw new NeutronRestApiException e NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi PostMethod class PostMethod postMethod PostMethod neutronRestApi createMethod url uri try postMethod setRequestHeader CONTENT_TYPE JSON_CONTENT_TYPE postMethod setRequestEntity entity String encodedCredentials encodeCredentials postMethod setRequestHeader encodedCredentials neutronRestApi executeMethod postMethod if postMethod getStatusCode HttpStatus SC_CREATED String errorMessage responseToErrorMessage postMethod postMethod releaseConnection
validateCredentials catch NeutronInvalidCredentialsException e throw new NeutronRestApiException e NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi PutMethod class PutMethod putMethod PutMethod neutronRestApi createMethod url uri try putMethod setRequestHeader CONTENT_TYPE JSON_CONTENT_TYPE putMethod setRequestEntity entity String encodedCredentials encodeCredentials putMethod setRequestHeader encodedCredentials neutronRestApi executeMethod putMethod if putMethod getStatusCode HttpStatus SC_OK String errorMessage responseToErrorMessage putMethod putMethod releaseConnection
throw new NeutronRestApiException e NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi PutMethod class PutMethod putMethod PutMethod neutronRestApi createMethod url uri try putMethod setRequestHeader CONTENT_TYPE JSON_CONTENT_TYPE putMethod setRequestEntity entity String encodedCredentials encodeCredentials putMethod setRequestHeader encodedCredentials neutronRestApi executeMethod putMethod if putMethod getStatusCode HttpStatus SC_OK String errorMessage responseToErrorMessage putMethod putMethod releaseConnection s_logger error errorMessage throw new NeutronRestApiException errorMessage
protected String executePut final String uri throws NeutronRestApiException try validateCredentials catch NeutronInvalidCredentialsException e throw new NeutronRestApiException e NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi PutMethod class PutMethod putMethod PutMethod neutronRestApi createMethod url uri try String encodedCredentials encodeCredentials putMethod setRequestHeader encodedCredentials neutronRestApi executeMethod putMethod if putMethod getStatusCode HttpStatus SC_OK String errorMessage responseToErrorMessage putMethod putMethod releaseConnection
catch NeutronInvalidCredentialsException e throw new NeutronRestApiException e NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi PutMethod class PutMethod putMethod PutMethod neutronRestApi createMethod url uri try String encodedCredentials encodeCredentials putMethod setRequestHeader encodedCredentials neutronRestApi executeMethod putMethod if putMethod getStatusCode HttpStatus SC_OK String errorMessage responseToErrorMessage putMethod putMethod releaseConnection s_logger error errorMessage throw new NeutronRestApiException errorMessage return putMethod getResponseBodyAsString
try validateCredentials catch NeutronInvalidCredentialsException e throw new NeutronRestApiException e NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi DeleteMethod class DeleteMethod deleteMethod DeleteMethod neutronRestApi createMethod url uri try deleteMethod setRequestHeader CONTENT_TYPE JSON_CONTENT_TYPE String encodedCredentials encodeCredentials deleteMethod setRequestHeader encodedCredentials neutronRestApi executeMethod deleteMethod if deleteMethod getStatusCode HttpStatus SC_NO_CONTENT String errorMessage responseToErrorMessage deleteMethod deleteMethod releaseConnection
catch NeutronInvalidCredentialsException e throw new NeutronRestApiException e NeutronRestFactory factory NeutronRestFactory getInstance NeutronRestApi neutronRestApi factory getNeutronApi DeleteMethod class DeleteMethod deleteMethod DeleteMethod neutronRestApi createMethod url uri try deleteMethod setRequestHeader CONTENT_TYPE JSON_CONTENT_TYPE String encodedCredentials encodeCredentials deleteMethod setRequestHeader encodedCredentials neutronRestApi executeMethod deleteMethod if deleteMethod getStatusCode HttpStatus SC_NO_CONTENT String errorMessage responseToErrorMessage deleteMethod deleteMethod releaseConnection s_logger error errorMessage throw new NeutronRestApiException errorMessage
protected boolean canHandle final Network network final Service service
Override public boolean implement final Network network final NetworkOffering offering final DeployDestination dest final ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException
private void handleCreateTunnelAnswer Answer answers OvsCreateTunnelAnswer r OvsCreateTunnelAnswer answers String s String format r getFromIp r getToIp r getBridge r getKey r getInPortName Long from r getFrom Long to r getTo long networkId r getNetworkId OvsTunnelNetworkVO tunnel _tunnelNetworkDao findByFromToNetwork from to networkId if tunnel null throw new CloudRuntimeException String format from to networkId if r getResult tunnel setState OvsTunnel State Failed name s_logger warn from to r getDetails s else tunnel setState OvsTunnel State Established name tunnel setPortName r getInPortName
HypervisorType hvType host getHypervisorType String label null switch hvType case XenServer label physNetTT getXenNetworkLabel if label null label equals physNetLabel label break case KVM label physNetTT getKvmNetworkLabel if label null label equals physNetLabel label break default throw new CloudRuntimeException hvType toString OvsTunnelInterfaceVO tunnelIface _tunnelInterfaceDao getByHostAndLabel host getId physNetLabel if tunnelIface null Commands fetchIfaceCmds new Commands new OvsFetchInterfaceCommand physNetLabel
List Long toHostIds new ArrayList Long List Long fromHostIds new ArrayList Long List Long networkSpannedHosts _ovsNetworkToplogyGuru getNetworkSpanedHosts nw getId for Long rh networkSpannedHosts if rh hostId continue OvsTunnelNetworkVO ta _tunnelNetworkDao findByFromToNetwork hostId rh longValue nw getId if ta null ta getState equals OvsTunnel State Failed name s_logger debug hostId rh longValue if ta null createTunnelRecord hostId rh longValue nw getId key if toHostIds contains rh toHostIds add rh ta _tunnelNetworkDao findByFromToNetwork rh longValue hostId nw getId if ta null ta getState equals OvsTunnel State Failed name
toHostIds add rh ta _tunnelNetworkDao findByFromToNetwork rh longValue hostId nw getId if ta null ta getState equals OvsTunnel State Failed name s_logger debug rh longValue hostId if ta null createTunnelRecord rh longValue hostId nw getId key if fromHostIds contains rh fromHostIds add rh try String myIp getGreEndpointIP host nw if myIp null throw new GreTunnelException host getId boolean noHost true for Long i toHostIds HostVO rHost _hostDao findById i String otherIp getGreEndpointIP rHost nw
ta _tunnelNetworkDao findByFromToNetwork rh longValue hostId nw getId if ta null ta getState equals OvsTunnel State Failed name s_logger debug rh longValue hostId if ta null createTunnelRecord rh longValue hostId nw getId key if fromHostIds contains rh fromHostIds add rh try String myIp getGreEndpointIP host nw if myIp null throw new GreTunnelException host getId boolean noHost true for Long i toHostIds HostVO rHost _hostDao findById i String otherIp getGreEndpointIP rHost nw if otherIp null throw new GreTunnelException rHost getId
if fromHostIds contains rh fromHostIds add rh try String myIp getGreEndpointIP host nw if myIp null throw new GreTunnelException host getId boolean noHost true for Long i toHostIds HostVO rHost _hostDao findById i String otherIp getGreEndpointIP rHost nw if otherIp null throw new GreTunnelException rHost getId Commands cmds new Commands new OvsCreateTunnelCommand otherIp key Long valueOf hostId i nw getId myIp bridgeName nw getUuid s_logger debug hostId i nw getId s_logger debug hostId i Answer answers _agentMgr send hostId cmds handleCreateTunnelAnswer answers
String myIp getGreEndpointIP host nw if myIp null throw new GreTunnelException host getId boolean noHost true for Long i toHostIds HostVO rHost _hostDao findById i String otherIp getGreEndpointIP rHost nw if otherIp null throw new GreTunnelException rHost getId Commands cmds new Commands new OvsCreateTunnelCommand otherIp key Long valueOf hostId i nw getId myIp bridgeName nw getUuid s_logger debug hostId i nw getId s_logger debug hostId i Answer answers _agentMgr send hostId cmds handleCreateTunnelAnswer answers noHost false for Long i fromHostIds HostVO rHost _hostDao findById i
if vmIds null vmIds isEmpty return List extends Network vpcNetworks _vpcMgr getVpcNetworks nw getVpcId try for Network network vpcNetworks int key getGreKey nw String bridgeName generateBridgeName nw key List OvsTunnelNetworkVO peers _tunnelNetworkDao listByToNetwork host getId nw getId for OvsTunnelNetworkVO p peers if p getState equals OvsTunnel State Established name Command cmd new OvsDestroyTunnelCommand p getNetworkId bridgeName p getPortName s_logger debug host getId p getFrom Answer ans _agentMgr send p getFrom cmd handleDestroyTunnelAnswer ans p getFrom p getTo p getNetworkId Command cmd new OvsDestroyBridgeCommand nw getId generateBridgeNameForVpc nw getVpcId host getId
Answer ans _agentMgr send p getFrom cmd handleDestroyTunnelAnswer ans p getFrom p getTo p getNetworkId Command cmd new OvsDestroyBridgeCommand nw getId generateBridgeNameForVpc nw getVpcId host getId s_logger debug nw getId host getId Answer ans _agentMgr send host getId cmd handleDestroyBridgeAnswer ans host getId nw getId catch Exception e s_logger info e getLocalizedMessage else List Long vmIds _ovsNetworkToplogyGuru getActiveVmsInNetworkOnHost nw getId host getId true if vmIds null vmIds isEmpty return try int key getGreKey nw String bridgeName generateBridgeName nw key
Answer ans _agentMgr send host getId cmd handleDestroyBridgeAnswer ans host getId nw getId catch Exception e s_logger info e getLocalizedMessage else List Long vmIds _ovsNetworkToplogyGuru getActiveVmsInNetworkOnHost nw getId host getId true if vmIds null vmIds isEmpty return try int key getGreKey nw String bridgeName generateBridgeName nw key Command cmd new OvsDestroyBridgeCommand nw getId bridgeName host getId s_logger debug nw getId host getId Answer ans _agentMgr send host getId cmd handleDestroyBridgeAnswer ans host getId nw getId
DB protected void checkAndCreateVpcTunnelNetworks Host host long vpcId long hostId host getId String bridgeName generateBridgeNameForVpc vpcId List Long vmIds _ovsNetworkToplogyGuru getActiveVmsInVpcOnHost vpcId hostId if vmIds null vmIds isEmpty try Commands cmds new Commands new OvsSetupBridgeCommand bridgeName hostId null
DB protected void checkAndCreateVpcTunnelNetworks Host host long vpcId long hostId host getId String bridgeName generateBridgeNameForVpc vpcId List Long vmIds _ovsNetworkToplogyGuru getActiveVmsInVpcOnHost vpcId hostId if vmIds null vmIds isEmpty try Commands cmds new Commands new OvsSetupBridgeCommand bridgeName hostId null s_logger debug hostId vpcId Answer answers _agentMgr send hostId cmds handleSetupBridgeAnswer answers catch OperationTimedoutException AgentUnavailableException e s_logger warn e OvsVpcRoutingPolicyConfigCommand cmd prepareVpcRoutingPolicyUpdate vpcId cmd setSequenceNumber getNextRoutingPolicyUpdateSequenceNumber vpcId if sendVpcRoutingPolicyChangeUpdate cmd hostId bridgeName
OvsVpcRoutingPolicyConfigCommand cmd prepareVpcRoutingPolicyUpdate vpcId cmd setSequenceNumber getNextRoutingPolicyUpdateSequenceNumber vpcId if sendVpcRoutingPolicyChangeUpdate cmd hostId bridgeName s_logger debug hostId List extends Network vpcNetworks _vpcMgr getVpcNetworks vpcId List Long vpcSpannedHostIds _ovsNetworkToplogyGuru getVpcSpannedHosts vpcId for Network vpcNetwork vpcNetworks if vpcNetwork getState Network State Implemented vpcNetwork getState Network State Implementing vpcNetwork getState Network State Setup continue int key getGreKey vpcNetwork List Long toHostIds new ArrayList Long List Long fromHostIds new ArrayList Long OvsTunnelNetworkVO tunnelRecord null for Long rh vpcSpannedHostIds if rh hostId continue
List Long vpcSpannedHostIds _ovsNetworkToplogyGuru getVpcSpannedHosts vpcId for Network vpcNetwork vpcNetworks if vpcNetwork getState Network State Implemented vpcNetwork getState Network State Implementing vpcNetwork getState Network State Setup continue int key getGreKey vpcNetwork List Long toHostIds new ArrayList Long List Long fromHostIds new ArrayList Long OvsTunnelNetworkVO tunnelRecord null for Long rh vpcSpannedHostIds if rh hostId continue tunnelRecord _tunnelNetworkDao findByFromToNetwork hostId rh longValue vpcNetwork getId if tunnelRecord null tunnelRecord getState equals OvsTunnel State Failed name s_logger debug hostId rh longValue if tunnelRecord null createTunnelRecord hostId rh longValue vpcNetwork getId key
if tunnelRecord null createTunnelRecord hostId rh longValue vpcNetwork getId key if toHostIds contains rh toHostIds add rh tunnelRecord _tunnelNetworkDao findByFromToNetwork rh longValue hostId vpcNetwork getId if tunnelRecord null tunnelRecord getState equals OvsTunnel State Failed name s_logger debug rh longValue hostId if tunnelRecord null createTunnelRecord rh longValue hostId vpcNetwork getId key if fromHostIds contains rh fromHostIds add rh try String myIp getGreEndpointIP host vpcNetwork if myIp null throw new GreTunnelException host getId boolean noHost true
createTunnelRecord hostId rh longValue vpcNetwork getId key if toHostIds contains rh toHostIds add rh tunnelRecord _tunnelNetworkDao findByFromToNetwork rh longValue hostId vpcNetwork getId if tunnelRecord null tunnelRecord getState equals OvsTunnel State Failed name s_logger debug rh longValue hostId if tunnelRecord null createTunnelRecord rh longValue hostId vpcNetwork getId key if fromHostIds contains rh fromHostIds add rh try String myIp getGreEndpointIP host vpcNetwork if myIp null throw new GreTunnelException host getId boolean noHost true for Long i toHostIds
if tunnelRecord null tunnelRecord getState equals OvsTunnel State Failed name s_logger debug rh longValue hostId if tunnelRecord null createTunnelRecord rh longValue hostId vpcNetwork getId key if fromHostIds contains rh fromHostIds add rh try String myIp getGreEndpointIP host vpcNetwork if myIp null throw new GreTunnelException host getId boolean noHost true for Long i toHostIds HostVO rHost _hostDao findById i String otherIp getGreEndpointIP rHost vpcNetwork if otherIp null throw new GreTunnelException rHost getId Commands cmds new Commands new OvsCreateTunnelCommand otherIp key Long valueOf hostId i vpcNetwork getId myIp bridgeName vpcNetwork getUuid
public boolean sendVpcTopologyChangeUpdate OvsVpcPhysicalTopologyConfigCommand updateCmd long hostId String bridgeName try
public boolean sendVpcTopologyChangeUpdate OvsVpcPhysicalTopologyConfigCommand updateCmd long hostId String bridgeName try s_logger debug hostId updateCmd setHostId hostId updateCmd setBridgeName bridgeName Answer ans _agentMgr send hostId updateCmd if ans getResult
private boolean sendVpcRoutingPolicyChangeUpdate OvsVpcRoutingPolicyConfigCommand updateCmd long hostId String bridgeName try
private boolean sendVpcRoutingPolicyChangeUpdate OvsVpcRoutingPolicyConfigCommand updateCmd long hostId String bridgeName try s_logger debug hostId updateCmd setHostId hostId updateCmd setBridgeName bridgeName Answer ans _agentMgr send hostId updateCmd if ans getResult
Override public boolean implement Network network NetworkOffering offering DeployDestination dest ReservationContext context throws ResourceUnavailableException ConcurrentOperationException InsufficientNetworkCapacityException DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Basic
Override public boolean shutdown Network network ReservationContext context boolean cleanup throws ResourceUnavailableException ConcurrentOperationException DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Basic
String guestVlanGateway cmd getAccessDetail NetworkElementCommand GUEST_NETWORK_GATEWAY String cidr cmd getAccessDetail NetworkElementCommand GUEST_NETWORK_CIDR long cidrSize NetUtils cidrToLong cidr String guestVlanSubnet NetUtils getCidrSubNet guestVlanGateway cidrSize Long publicVlanTag null if ip getBroadcastUri null String parsedVlanTag parsePublicVlanTag ip getBroadcastUri if parsedVlanTag equals try publicVlanTag Long parseLong parsedVlanTag catch Exception e throw new ExecutionException parsedVlanTag ArrayList IPaloAltoCommand commandList new ArrayList IPaloAltoCommand if ip isAdd implementGuestNetwork commandList type publicVlanTag sourceNatIpAddress guestVlanTag guestVlanGateway guestVlanSubnet cidrSize
private Answer execute SetFirewallRulesCommand cmd int numRetries FirewallRuleTO rules cmd getRules try ArrayList IPaloAltoCommand commandList new ArrayList IPaloAltoCommand for FirewallRuleTO rule rules if rule revoked manageFirewallRule commandList PaloAltoPrimative ADD rule else manageFirewallRule commandList PaloAltoPrimative DELETE rule boolean status requestWithCommit commandList return new Answer cmd catch ExecutionException e s_logger error e if numRetries refreshPaloAltoConnection int numRetriesRemaining numRetries
private Answer execute SetStaticNatRulesCommand cmd int numRetries StaticNatRuleTO rules cmd getRules try ArrayList IPaloAltoCommand commandList new ArrayList IPaloAltoCommand for StaticNatRuleTO rule rules if rule revoked manageStcNatRule commandList PaloAltoPrimative ADD rule else manageStcNatRule commandList PaloAltoPrimative DELETE rule boolean status requestWithCommit commandList return new Answer cmd catch ExecutionException e s_logger error e if numRetries refreshPaloAltoConnection int numRetriesRemaining numRetries
private Answer execute SetPortForwardingRulesCommand cmd int numRetries PortForwardingRuleTO rules cmd getRules try ArrayList IPaloAltoCommand commandList new ArrayList IPaloAltoCommand for PortForwardingRuleTO rule rules if rule revoked manageDstNatRule commandList PaloAltoPrimative ADD rule else manageDstNatRule commandList PaloAltoPrimative DELETE rule boolean status requestWithCommit commandList return new Answer cmd catch ExecutionException e s_logger error e if numRetries refreshPaloAltoConnection int numRetriesRemaining numRetries
public boolean managePrivateInterface ArrayList IPaloAltoCommand cmdList PaloAltoPrimative prim long privateVlanTag String privateGateway throws ExecutionException String interfaceName genPrivateInterfaceName privateVlanTag switch prim case CHECK_IF_EXISTS Map String String params new HashMap String String params put params put params put _privateInterfaceType _privateInterface interfaceName String response request PaloAltoMethod GET params boolean result validResponse response responseNotEmpty response
if rule getSrcVlanTag null publicInterfaceName genPublicInterfaceName new Long else publicVlanTag parsePublicVlanTag rule getSrcVlanTag if publicVlanTag equals publicInterfaceName genPublicInterfaceName new Long else publicInterfaceName genPublicInterfaceName new Long publicVlanTag switch prim case CHECK_IF_EXISTS Map String String params new HashMap String String params put params put params put dstNatName String response request PaloAltoMethod GET params boolean result validResponse response responseNotEmpty response
if rule getSrcVlanTag null publicInterfaceName genPublicInterfaceName new Long else publicVlanTag parsePublicVlanTag rule getSrcVlanTag if publicVlanTag equals publicInterfaceName genPublicInterfaceName new Long else publicInterfaceName genPublicInterfaceName new Long publicVlanTag switch prim case CHECK_IF_EXISTS Map String String params new HashMap String String params put params put params put stcNatName String response request PaloAltoMethod GET params boolean result validResponse response responseNotEmpty response
if _logProfile null action equals xml _logProfile boolean has_default false String defaultEgressRule if rule getTrafficType FirewallRule TrafficType Egress Map String String e_params new HashMap String String e_params put e_params put e_params put rule getSrcVlanTag String e_response request PaloAltoMethod GET e_params has_default validResponse e_response responseNotEmpty e_response if has_default s_logger debug ruleName NodeList response_body Document doc getDocument e_response
public boolean manageNetworkIsolation ArrayList IPaloAltoCommand cmdList PaloAltoPrimative prim long privateVlanTag String privateSubnet String privateGateway throws ExecutionException String ruleName genNetworkIsolationName privateVlanTag switch prim case CHECK_IF_EXISTS Map String String params new HashMap String String params put params put params put ruleName String response request PaloAltoMethod GET params boolean result validResponse response responseNotEmpty response
public boolean managePingProfile ArrayList IPaloAltoCommand cmdList PaloAltoPrimative prim throws ExecutionException switch prim case CHECK_IF_EXISTS Map String String params new HashMap String String params put params put params put _pingManagementProfile String response request PaloAltoMethod GET params boolean result validResponse response responseNotEmpty response
public boolean manageService ArrayList IPaloAltoCommand cmdList PaloAltoPrimative prim String protocol String dstPorts String srcPorts throws ExecutionException String serviceName genServiceName protocol dstPorts srcPorts switch prim case CHECK_IF_EXISTS Map String String params new HashMap String String params put params put params put serviceName String response request PaloAltoMethod GET params boolean result validResponse response responseNotEmpty response
URI base new URI apiUrl req setURI new URI base getScheme base getUserInfo base getHost base getPort path null null catch URISyntaxException e s_logger error apiUrl path e return null try String content null try content getHttpClient execute req new BasicResponseHandler s_logger info req catch HttpResponseException e s_logger info req e if e getStatusCode HttpStatus SC_UNAUTHORIZED login req reset content getHttpClient execute req new BasicResponseHandler
catch URISyntaxException e s_logger error apiUrl path e return null try String content null try content getHttpClient execute req new BasicResponseHandler s_logger info req catch HttpResponseException e s_logger info req e if e getStatusCode HttpStatus SC_UNAUTHORIZED login req reset content getHttpClient execute req new BasicResponseHandler s_logger info req return content
return null try String content null try content getHttpClient execute req new BasicResponseHandler s_logger info req catch HttpResponseException e s_logger info req e if e getStatusCode HttpStatus SC_UNAUTHORIZED login req reset content getHttpClient execute req new BasicResponseHandler s_logger info req return content catch ClientProtocolException e s_logger error req e
private boolean canHandle Network network if canHandle _physicalNetworkDao findById network getPhysicalNetworkId if _ntwkSrvcDao canProviderSupportServiceInNetwork network getId Service Connectivity getProvider
Override public boolean createNetwork Network network NetworkOffering offering DeployDestination dest ReservationContext context if _sspUuidDao findUuidByNetwork network null
return false String tenantUuid _sspTenantDao findUuidByZone network getDataCenterId if tenantUuid null tenantUuid _configDao getValueAndInitIfNotExist null boolean processed false for SspClient client fetchSspClients network getPhysicalNetworkId network getDataCenterId true SspClient TenantNetwork sspNet client createTenantNetwork tenantUuid network getName if sspNet null SspUuidVO uuid new SspUuidVO uuid setUuid sspNet uuid uuid setObjClass SspUuidVO objClassNetwork uuid setObjId network getId _sspUuidDao persist uuid return true processed true
if tenantUuid null tenantUuid _configDao getValueAndInitIfNotExist null boolean processed false for SspClient client fetchSspClients network getPhysicalNetworkId network getDataCenterId true SspClient TenantNetwork sspNet client createTenantNetwork tenantUuid network getName if sspNet null SspUuidVO uuid new SspUuidVO uuid setUuid sspNet uuid uuid setObjClass SspUuidVO objClassNetwork uuid setObjId network getId _sspUuidDao persist uuid return true processed true if processed s_logger error network toString
Override public boolean createNicEnv Network network NicProfile nic DeployDestination dest ReservationContext context String tenantNetworkUuid _sspUuidDao findUuidByNetwork network if tenantNetworkUuid null
s_logger info reservationId return true String tenantPortUuid null for SspClient client fetchSspClients network getPhysicalNetworkId network getDataCenterId true SspClient TenantPort sspPort client createTenantPort tenantNetworkUuid if sspPort null tenantPortUuid sspPort uuid nic setReservationId reservationId SspUuidVO uuid new SspUuidVO uuid setUuid tenantPortUuid uuid setObjClass SspUuidVO objClassNicProfile uuid setObjId nic getId uuid setReservationId reservationId _sspUuidDao persist uuid break
SspUuidVO uuid new SspUuidVO uuid setUuid tenantPortUuid uuid setObjClass SspUuidVO objClassNicProfile uuid setObjId nic getId uuid setReservationId reservationId _sspUuidDao persist uuid break if tenantPortUuid null s_logger debug network toString return false for SspClient client fetchSspClients network getPhysicalNetworkId network getDataCenterId true SspClient TenantPort sspPort client updateTenantVifBinding tenantPortUuid dest getHost getPrivateIpAddress if sspPort null if sspPort vlanId null nic setBroadcastType BroadcastDomainType Vlan
Override public boolean deleteNicEnv Network network NicProfile nic ReservationContext context if context null
private void initDriver isDriverEnabled true final OutOfBandManagementDriverResponse output IPMITOOL executeCommands Arrays asList IpmiToolPath value if output isSuccess output getResult startsWith isIpmiToolBinAvailable true
Override public List StoragePool select DiskProfile dskCh VirtualMachineProfile vmProfile DeploymentPlan plan ExcludeList avoid int returnUpTo List StoragePool suitablePools new ArrayList StoragePool long dcId plan getDataCenterId Long podId plan getPodId Long clusterId plan getClusterId if podId null return null s_logger debug dcId podId clusterId List StoragePoolVO pools storagePoolDao listBy dcId podId clusterId ScopeType CLUSTER if pools size if s_logger isDebugEnabled s_logger debug return suitablePools Collections shuffle pools if s_logger isDebugEnabled
s_logger debug dcId podId clusterId List StoragePoolVO pools storagePoolDao listBy dcId podId clusterId ScopeType CLUSTER if pools size if s_logger isDebugEnabled s_logger debug return suitablePools Collections shuffle pools if s_logger isDebugEnabled s_logger debug pools size for StoragePoolVO pool pools if suitablePools size returnUpTo break StoragePool pol StoragePool this dataStoreMgr getPrimaryDataStore pool getId if filter avoid pol dskCh plan suitablePools add pol
Override public String createEntityExtractUrl DataStore store String installPath ImageFormat format DataObject dataObject EndPoint ep _epSelector select store String path installPath String uuid UUID randomUUID toString format getFileExtension CreateEntityDownloadURLCommand cmd new CreateEntityDownloadURLCommand ImageStoreEntity store getMountPoint path uuid dataObject getTO Answer ans null if ep null String errMsg
Override public void deleteEntityExtractUrl DataStore store String installPath String downloadUrl Upload Type entityType EndPoint ep _epSelector select store downloadUrl DeleteEntityDownloadURLCommand cmd new DeleteEntityDownloadURLCommand installPath entityType downloadUrl ImageStoreEntity store getMountPoint Answer ans null if ep null String errMsg
Override public String createEntityExtractUrl DataStore store String key ImageFormat format DataObject dataObject S3TO s3 S3TO getStoreTO store if s_logger isDebugEnabled
Override public String createEntityExtractUrl DataStore store String installPath ImageFormat format DataObject dataObject SwiftTO swiftTO SwiftTO store getTO String tempKey UUID randomUUID toString boolean result SwiftUtil setTempKey swiftTO tempKey if result String errMsg tempKey
Override public void createAsync DataStore dataStore DataObject data AsyncCompletionCallback CreateCmdResult callback Long maxTemplateSizeInBytes getMaxTemplateSizeInBytes VirtualMachineTemplate tmpl _templateDao findById data getId DataStore cacheStore cacheManager getCacheStorage dataStore getScope DownloadCommand dcmd new DownloadCommand TemplateObjectTO data getTO maxTemplateSizeInBytes dcmd setCacheStore cacheStore getTO dcmd setProxy getHttpProxy EndPoint ep _epSelector select data if ep null String errMsg
Override public DataStore initialize Map String Object dsInfos Long dcId Long dsInfos get String url String dsInfos get String name String dsInfos get ScopeType scope ScopeType dsInfos get String providerName String dsInfos get DataStoreRole role DataStoreRole dsInfos get Map String String details Map String String dsInfos get
s_logger info SnapshotObjectTO snapshotTO SnapshotObjectTO snapshot getTO String volumeid snapshotTO getVolume getUuid String snapshotname snapshotTO getName Answer answer ElastistorUtil createElastistorVolumeSnapshot volumeid snapshotname if answer getResult false s_logger info throw new CloudRuntimeException else s_logger info snapshotTO setPath answer getDetails CreateObjectAnswer createObjectAnswer new CreateObjectAnswer snapshotTO result new CreateCmdResult null createObjectAnswer result setResult null catch Throwable e
private boolean createStoragePool long hostId StoragePool pool
List StoragePoolHostVO hostPoolRecords _storagePoolHostDao listByPoolId store getId StoragePool pool StoragePool store HypervisorType hType null if hostPoolRecords size hType getHypervisorType hostPoolRecords get getHostId StoragePoolVO storagePoolVO _storagePoolDao findById store getId if storagePoolVO isManaged for StoragePoolHostVO host hostPoolRecords DeleteStoragePoolCommand deleteCmd new DeleteStoragePoolCommand pool final Answer answer agentMgr easySend host getHostId deleteCmd if answer null answer getResult if HypervisorType KVM hType break else if answer null
public static UpdateTsmCmdResponse updateElastistorTsmIOPS String capacityIOPs String uuid throws Throwable
Override public List Class getCommands List Class cmdList new ArrayList Class cmdList add ListElastistorVolumeCmd class cmdList add ListElastistorPoolCmd class cmdList add ListElastistorInterfaceCmd class
List ListElastistorVolumeResponse volumeResponses new ArrayList ListElastistorVolumeResponse ListElastistorVolumeResponse volumeResponse volumeResponse new ListElastistorVolumeResponse volumeResponse setId listVolumeResponse getUuid volumeResponse setName listVolumeResponse getName volumeResponse setGraceAllowed listVolumeResponse getGraceallowed volumeResponse setDeduplication listVolumeResponse getDeduplication volumeResponse setCompression listVolumeResponse getCompression volumeResponse setSync listVolumeResponse getSync volumeResponse setObjectName volumeResponses add volumeResponse ListResponse ListElastistorVolumeResponse response new ListResponse ListElastistorVolumeResponse response setResponses volumeResponses return response catch Throwable e
for int i i listPools getPools getCount i elastistorPoolResponse new ListElastistorPoolResponse elastistorPoolResponse setId listPools getPools getPool i getUuid elastistorPoolResponse setName listPools getPools getPool i getName elastistorPoolResponse setAvailIOPS Long parseLong listPools getPools getPool i getAvailIOPS elastistorPoolResponse setCurrentAvailableSpace Long parseLong listPools getPools getPool i getAvailableSpace elastistorPoolResponse setState listPools getPools getPool i getState elastistorPoolResponse setControllerid listPools getPools getPool i getControllerid elastistorPoolResponse setGateway listPools getPools getPool i getGateway elastistorPoolResponse setObjectName poolResponses add elastistorPoolResponse ListResponse ListElastistorPoolResponse response new ListResponse ListElastistorPoolResponse response setResponses poolResponses return response catch Throwable e
try ListInterfacesResponse listInterfacesResponse ElastistorUtil ListElastistorInterfaces cmd getControllerId List ListElastistorInterfaceResponse interfaceResponses new ArrayList ListElastistorInterfaceResponse ListElastistorInterfaceResponse interfaceResponse for int i i listInterfacesResponse getInterfaces getCount i interfaceResponse new ListElastistorInterfaceResponse interfaceResponse setId listInterfacesResponse getInterfaces getInterface i getUuid interfaceResponse setName listInterfacesResponse getInterfaces getInterface i getName interfaceResponse setStatus listInterfacesResponse getInterfaces getInterface i getStatus interfaceResponse setObjectName interfaceResponses add interfaceResponse ListResponse ListElastistorInterfaceResponse response new ListResponse ListElastistorInterfaceResponse response setResponses interfaceResponses return response catch Throwable e
Override public boolean grantAccess DataObject dataObject Host host DataStore dataStore s_logger debug Preconditions checkArgument dataObject null Preconditions checkArgument host null Preconditions checkArgument dataStore null long storagePoolId dataStore getId DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao String appInstanceName getAppInstanceName dataObject DateraObject AppInstance appInstance getDateraAppInstance conn appInstanceName Preconditions checkArgument appInstance null long clusterId host getClusterId ClusterVO cluster _clusterDao findById clusterId GlobalLock lock GlobalLock getInternLock cluster getUuid if lock lock s_lockTimeInSeconds
DateraObject AppInstance appInstance getDateraAppInstance conn appInstanceName Preconditions checkArgument appInstance null long clusterId host getClusterId ClusterVO cluster _clusterDao findById clusterId GlobalLock lock GlobalLock getInternLock cluster getUuid if lock lock s_lockTimeInSeconds s_logger debug cluster getUuid try DateraObject InitiatorGroup initiatorGroup null String initiatorGroupKey DateraUtil getInitiatorGroupKey storagePoolId List HostVO hosts _hostDao findByClusterId clusterId if DateraUtil hostsSupport_iScsi hosts s_logger debug return false String initiatorGroupName DateraUtil INITIATOR_GROUP_PREFIX cluster getUuid
ClusterVO cluster _clusterDao findById clusterId GlobalLock lock GlobalLock getInternLock cluster getUuid if lock lock s_lockTimeInSeconds s_logger debug cluster getUuid try DateraObject InitiatorGroup initiatorGroup null String initiatorGroupKey DateraUtil getInitiatorGroupKey storagePoolId List HostVO hosts _hostDao findByClusterId clusterId if DateraUtil hostsSupport_iScsi hosts s_logger debug return false String initiatorGroupName DateraUtil INITIATOR_GROUP_PREFIX cluster getUuid s_logger debug String valueOf initiatorGroupName initiatorGroup DateraUtil getInitiatorGroup conn initiatorGroupName if initiatorGroup null
initiatorGroup DateraUtil getInitiatorGroup conn initiatorGroupName if initiatorGroup null s_logger debug String valueOf initiatorGroupName initiatorGroup DateraUtil createInitiatorGroup conn initiatorGroupName ClusterDetailsVO clusterDetail new ClusterDetailsVO clusterId initiatorGroupKey initiatorGroupName _clusterDetailsDao persist clusterDetail else initiatorGroup DateraUtil getInitiatorGroup conn initiatorGroupName Preconditions checkNotNull initiatorGroup addClusterHostsToInitiatorGroup conn clusterId initiatorGroupName if isInitiatorGroupAssignedToAppInstance conn initiatorGroup appInstance DateraUtil assignGroupToAppInstance conn initiatorGroupName appInstanceName int retries DateraUtil DEFAULT_RETRIES while isInitiatorGroupAssignedToAppInstance conn initiatorGroup appInstance retries Thread sleep DateraUtil POLL_TIMEOUT_MS
s_logger debug String valueOf initiatorGroupName initiatorGroup DateraUtil createInitiatorGroup conn initiatorGroupName ClusterDetailsVO clusterDetail new ClusterDetailsVO clusterId initiatorGroupKey initiatorGroupName _clusterDetailsDao persist clusterDetail else initiatorGroup DateraUtil getInitiatorGroup conn initiatorGroupName Preconditions checkNotNull initiatorGroup addClusterHostsToInitiatorGroup conn clusterId initiatorGroupName if isInitiatorGroupAssignedToAppInstance conn initiatorGroup appInstance DateraUtil assignGroupToAppInstance conn initiatorGroupName appInstanceName int retries DateraUtil DEFAULT_RETRIES while isInitiatorGroupAssignedToAppInstance conn initiatorGroup appInstance retries Thread sleep DateraUtil POLL_TIMEOUT_MS retries Preconditions checkArgument isInitiatorGroupAssignedToAppInstance conn initiatorGroup appInstance
private void addClusterHostsToInitiatorGroup DateraObject DateraConnection conn long clusterId String initiatorGroupName throws DateraObject DateraError UnsupportedEncodingException List HostVO clusterHosts _hostDao findByClusterId clusterId DateraObject InitiatorGroup initiatorGroup DateraUtil getInitiatorGroup conn initiatorGroupName for HostVO host clusterHosts String iqn host getStorageUrl DateraObject Initiator initiator DateraUtil getInitiator conn iqn String initiatorName if initiator null initiatorName DateraUtil INITIATOR_PREFIX host getUuid initiator DateraUtil createInitiator conn initiatorName iqn
Override public void revokeAccess DataObject dataObject Host host DataStore dataStore s_logger debug Preconditions checkArgument dataObject null Preconditions checkArgument host null Preconditions checkArgument dataStore null String appInstanceName getAppInstanceName dataObject long clusterId host getClusterId long storagePoolId dataStore getId ClusterVO cluster _clusterDao findById clusterId GlobalLock lock GlobalLock getInternLock cluster getUuid if lock lock s_lockTimeInSeconds
name add DateraUtil APPINSTANCE_PREFIX String dataObjectTypeString dataObject getType name String dataObjectTypeBrief dataObjectTypeBrief org apache commons lang StringUtils substring dataObjectTypeString name add dataObjectTypeBrief switch dataObject getType case TEMPLATE TemplateInfo templateInfo TemplateInfo dataObject name add dataObject getUuid name add String valueOf dataObject getDataStore getId break case VOLUME VolumeInfo volumeInfo VolumeInfo dataObject String volumeName volumeInfo getName name add String valueOf volumeName name add dataObject getUuid VolumeVO volumeVo _volumeDao findById dataObject getId
catch DateraObject DateraError dateraError String errMesg storagePool getId s_logger warn errMesg dateraError throw new CloudRuntimeException errMesg List SnapshotVO lstSnapshots _snapshotDao listAll if lstSnapshots null for SnapshotVO snapshot lstSnapshots SnapshotDetailsVO snapshotDetails _snapshotDetailsDao findDetail snapshot getId DateraUtil STORAGE_POOL_ID if snapshotDetails null snapshotDetails getValue null Long parseLong snapshotDetails getValue storagePool getId snapshotDetails _snapshotDetailsDao findDetail snapshot getId DateraUtil VOLUME_SIZE if snapshotDetails null snapshotDetails getValue null long snapshotSize Long parseLong snapshotDetails getValue usedSpaceBytes snapshotSize List VMTemplateStoragePoolVO lstTemplatePoolRefs tmpltPoolDao listByPoolId storagePool getId if lstTemplatePoolRefs null
private String createVolume VolumeInfo volumeInfo long storagePoolId s_logger debug Preconditions checkArgument volumeInfo null Preconditions checkArgument storagePoolId verifySufficientBytesForStoragePool volumeInfo storagePoolId DateraObject AppInstance appInstance DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao long csSnapshotId getCsIdForCloning volumeInfo getId long csTemplateId getCsIdForCloning volumeInfo getId
appInstance DateraUtil getAppInstance conn appInstanceName else s_logger debug appInstance createDateraVolume conn volumeInfo storagePoolId catch UnsupportedEncodingException DateraObject DateraError e String errMesg e getMessage s_logger warn errMesg throw new CloudRuntimeException errMesg e if appInstance null String errMesg s_logger warn errMesg throw new CloudRuntimeException errMesg Preconditions checkNotNull appInstance String iqn appInstance getIqn String iqnPath DateraUtil generateIqnPath iqn
appInstance DateraUtil getAppInstance conn appInstanceName else s_logger debug appInstance createDateraVolume conn volumeInfo storagePoolId catch UnsupportedEncodingException DateraObject DateraError e String errMesg e getMessage s_logger warn errMesg throw new CloudRuntimeException errMesg e if appInstance null String errMesg s_logger warn errMesg throw new CloudRuntimeException errMesg Preconditions checkNotNull appInstance String iqn appInstance getIqn String iqnPath DateraUtil generateIqnPath iqn
int minIops Ints checkedCast volumeInfo getMinIops null volumeInfo getMinIops getDefaultMinIops storagePoolId int maxIops Ints checkedCast volumeInfo getMaxIops null volumeInfo getMaxIops getDefaultMaxIops storagePoolId if maxIops maxIops Ints checkedCast getDefaultMaxIops storagePoolId int replicas getNumReplicas storagePoolId String volumePlacement getVolPlacement storagePoolId String ipPool getIpPool storagePoolId long volumeSizeBytes getDataObjectSizeIncludingHypervisorSnapshotReserve volumeInfo _storagePoolDao findById storagePoolId int volumeSizeGib DateraUtil bytesToGib volumeSizeBytes if volumePlacement null appInstance DateraUtil createAppInstance conn getAppInstanceName volumeInfo volumeSizeGib maxIops replicas else appInstance DateraUtil createAppInstance conn getAppInstanceName volumeInfo volumeSizeGib maxIops replicas volumePlacement ipPool catch Exception ex s_logger debug
else if dataType DataObjectType TEMPLATE s_logger debug VMTemplateStoragePoolVO templatePoolRef tmpltPoolDao findByPoolTemplate storagePoolId dataObjectId if templatePoolRef null baseAppInstanceName templatePoolRef getLocalDownloadPath if baseAppInstanceName null throw new CloudRuntimeException volumeInfo getId dataType appInstance DateraUtil cloneAppInstanceFromVolume conn clonedAppInstanceName baseAppInstanceName ipPool if dataType DataObjectType TEMPLATE if volumeInfo getMaxIops null int totalIops Math min DateraUtil MAX_IOPS Ints checkedCast volumeInfo getMaxIops DateraUtil updateAppInstanceIops conn clonedAppInstanceName totalIops appInstance DateraUtil getAppInstance conn clonedAppInstanceName String newPlacementMode getVolPlacement storagePoolId if newPlacementMode null
SnapshotDetailsVO snapshotDetails snapshotDetailsDao findDetail csSnapshotId DateraUtil SNAPSHOT_ID if snapshotDetails null snapshotDetails getValue null throw new CloudRuntimeException DateraUtil SNAPSHOT_ID DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao snapshotDetails snapshotDetailsDao findDetail csSnapshotId if snapshotDetails null snapshotDetails getValue null snapshotDetails getValue equalsIgnoreCase snapshotDetails snapshotDetailsDao findDetail csSnapshotId DateraUtil SNAPSHOT_ID String snapshotName snapshotDetails getValue String clonedAppInstanceName getAppInstanceName snapshotInfo DateraObject AppInstance clonedAppInstance try clonedAppInstance DateraUtil cloneAppInstanceFromSnapshot conn clonedAppInstanceName snapshotName ipPool DateraUtil pollAppInstanceAvailable conn clonedAppInstanceName catch DateraObject DateraError UnsupportedEncodingException e String errMesg csSnapshotId e getMessage
snapshotDetails snapshotDetailsDao findDetail csSnapshotId if snapshotDetails null snapshotDetails getValue null snapshotDetails getValue equalsIgnoreCase snapshotDetails snapshotDetailsDao findDetail csSnapshotId DateraUtil SNAPSHOT_ID String snapshotName snapshotDetails getValue String clonedAppInstanceName getAppInstanceName snapshotInfo DateraObject AppInstance clonedAppInstance try clonedAppInstance DateraUtil cloneAppInstanceFromSnapshot conn clonedAppInstanceName snapshotName ipPool DateraUtil pollAppInstanceAvailable conn clonedAppInstanceName catch DateraObject DateraError UnsupportedEncodingException e String errMesg csSnapshotId e getMessage s_logger error errMesg e throw new CloudRuntimeException errMesg e if clonedAppInstance null throw new CloudRuntimeException snapshotName
DateraObject AppInstance clonedAppInstance try clonedAppInstance DateraUtil cloneAppInstanceFromSnapshot conn clonedAppInstanceName snapshotName ipPool DateraUtil pollAppInstanceAvailable conn clonedAppInstanceName catch DateraObject DateraError UnsupportedEncodingException e String errMesg csSnapshotId e getMessage s_logger error errMesg e throw new CloudRuntimeException errMesg e if clonedAppInstance null throw new CloudRuntimeException snapshotName s_logger debug clonedAppInstanceName addTempVolumeToDb csSnapshotId clonedAppInstanceName handleSnapshotDetails csSnapshotId DiskTO IQN DateraUtil generateIqnPath clonedAppInstance getIqn else if snapshotDetails null snapshotDetails getValue null snapshotDetails getValue equalsIgnoreCase snapshotDetails snapshotDetailsDao findDetail csSnapshotId DateraUtil VOLUME_ID
public String createTemplateVolume TemplateInfo templateInfo long storagePoolId s_logger debug verifySufficientBytesForStoragePool templateInfo storagePoolId DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao String iqn null String appInstanceName null try long templateSizeBytes getDataObjectSizeIncludingHypervisorSnapshotReserve templateInfo storagePoolDao findById storagePoolId
public String createTemplateVolume TemplateInfo templateInfo long storagePoolId s_logger debug verifySufficientBytesForStoragePool templateInfo storagePoolId DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao String iqn null String appInstanceName null try long templateSizeBytes getDataObjectSizeIncludingHypervisorSnapshotReserve templateInfo storagePoolDao findById storagePoolId s_logger debug toHumanReadableSize templateSizeBytes int templateSizeGib DateraUtil bytesToGib templateSizeBytes int templateIops DateraUtil MAX_IOPS int replicaCount getNumReplicas storagePoolId appInstanceName getAppInstanceName templateInfo String volumePlacement getVolPlacement storagePoolId String ipPool getIpPool storagePoolId
throw new CloudRuntimeException templateInfo getId iqn appInstance getIqn VMTemplateStoragePoolVO templatePoolRef tmpltPoolDao findByPoolTemplate storagePoolId templateInfo getId templatePoolRef setInstallPath DateraUtil generateIqnPath iqn templatePoolRef setLocalDownloadPath appInstance getName templatePoolRef setTemplateSize DateraUtil gibToBytes appInstance getSize tmpltPoolDao update templatePoolRef getId templatePoolRef StoragePoolVO storagePool storagePoolDao findById storagePoolId long capacityBytes storagePool getCapacityBytes long usedBytes getUsedBytes storagePool storagePool setUsedBytes usedBytes capacityBytes capacityBytes usedBytes storagePoolDao update storagePoolId storagePool catch UnsupportedEncodingException DateraObject DateraError dateraError if DateraObject DateraErrorTypes ConflictError equals dateraError String errMesg appInstanceName
VMTemplateStoragePoolVO templatePoolRef tmpltPoolDao findByPoolTemplate storagePoolId templateInfo getId templatePoolRef setInstallPath DateraUtil generateIqnPath iqn templatePoolRef setLocalDownloadPath appInstance getName templatePoolRef setTemplateSize DateraUtil gibToBytes appInstance getSize tmpltPoolDao update templatePoolRef getId templatePoolRef StoragePoolVO storagePool storagePoolDao findById storagePoolId long capacityBytes storagePool getCapacityBytes long usedBytes getUsedBytes storagePool storagePool setUsedBytes usedBytes capacityBytes capacityBytes usedBytes storagePoolDao update storagePoolId storagePool catch UnsupportedEncodingException DateraObject DateraError dateraError if DateraObject DateraErrorTypes ConflictError equals dateraError String errMesg appInstanceName s_logger debug errMesg dateraError else
Override public void createAsync DataStore dataStore DataObject dataObject AsyncCompletionCallback CreateCmdResult callback String iqn null String errMsg null try if dataObject getType DataObjectType VOLUME s_logger debug iqn createVolume VolumeInfo dataObject dataStore getId else if dataObject getType DataObjectType SNAPSHOT s_logger debug createTempVolume SnapshotInfo dataObject dataStore getId else if dataObject getType DataObjectType TEMPLATE s_logger debug iqn createTemplateVolume TemplateInfo dataObject dataStore getId else errMsg dataObject getType
try if dataObject getType DataObjectType VOLUME s_logger debug iqn createVolume VolumeInfo dataObject dataStore getId else if dataObject getType DataObjectType SNAPSHOT s_logger debug createTempVolume SnapshotInfo dataObject dataStore getId else if dataObject getType DataObjectType TEMPLATE s_logger debug iqn createTemplateVolume TemplateInfo dataObject dataStore getId else errMsg dataObject getType s_logger error errMsg catch Exception ex errMsg ex getMessage
String errMsg null try if dataObject getType DataObjectType VOLUME s_logger debug deleteVolume VolumeInfo dataObject dataStore getId else if dataObject getType DataObjectType SNAPSHOT s_logger debug deleteSnapshot SnapshotInfo dataObject dataStore getId else if dataObject getType DataObjectType TEMPLATE s_logger debug deleteTemplate TemplateInfo dataObject dataStore getId else errMsg dataObject getType catch Exception ex errMsg ex getMessage
Override public void takeSnapshot SnapshotInfo snapshotInfo AsyncCompletionCallback CreateCmdResult callback s_logger debug CreateCmdResult result try VolumeInfo volumeInfo snapshotInfo getBaseVolume VolumeVO volumeVO _volumeDao findById volumeInfo getId long storagePoolId volumeVO getPoolId DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao String baseAppInstanceName getAppInstanceName volumeInfo DateraObject AppInstance baseAppInstance DateraUtil getAppInstance conn baseAppInstanceName Preconditions checkNotNull baseAppInstance SnapshotObjectTO snapshotObjectTo SnapshotObjectTO snapshotInfo getTO if shouldTakeSnapshot snapshotInfo getId DateraObject VolumeSnapshot volumeSnapshot DateraUtil takeVolumeSnapshot conn baseAppInstanceName if volumeSnapshot null
VolumeVO volumeVO _volumeDao findById volumeInfo getId long storagePoolId volumeVO getPoolId DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao String baseAppInstanceName getAppInstanceName volumeInfo DateraObject AppInstance baseAppInstance DateraUtil getAppInstance conn baseAppInstanceName Preconditions checkNotNull baseAppInstance SnapshotObjectTO snapshotObjectTo SnapshotObjectTO snapshotInfo getTO if shouldTakeSnapshot snapshotInfo getId DateraObject VolumeSnapshot volumeSnapshot DateraUtil takeVolumeSnapshot conn baseAppInstanceName if volumeSnapshot null s_logger error baseAppInstanceName volumeInfo getId throw new CloudRuntimeException volumeInfo getId String snapshotName baseAppInstanceName volumeSnapshot getTimestamp updateSnapshotDetails snapshotInfo getId baseAppInstanceName snapshotName storagePoolId baseAppInstance getSize snapshotObjectTo setPath snapshotName
String volumePlacement getVolPlacement storagePoolId String ipPool getIpPool storagePoolId usedBytes volumeSizeBytes if usedBytes capacityBytes throw new CloudRuntimeException String appInstanceName getAppInstanceName snapshotInfo DateraObject AppInstance snapshotAppInstance DateraUtil createAppInstance conn appInstanceName volumeSizeGib DateraUtil MAX_IOPS getNumReplicas storagePoolId volumePlacement ipPool snapshotObjectTo setPath snapshotAppInstance getName String iqnPath DateraUtil generateIqnPath snapshotAppInstance getIqn updateSnapshotDetails snapshotInfo getId snapshotAppInstance getName storagePoolId snapshotAppInstance getSize iqnPath snapshotObjectTo setPath snapshotAppInstance getName storagePool setUsedBytes usedBytes _storagePoolDao update storagePoolId storagePool CreateObjectAnswer createObjectAnswer new CreateObjectAnswer snapshotObjectTo result new CreateCmdResult null createObjectAnswer
VolumeVO volume _volumeDao findById snapshot getVolumeId if volume null volume _volumeDao findByIdIncludingRemoved snapshot getVolumeId if shouldDeleteVolume snapshot getVolumeId snapshot getId DateraUtil deleteAppInstance conn volume getFolder else snapshotDetails snapshotDetailsDao findDetail csSnapshotId DateraUtil VOLUME_ID String appInstanceName snapshotDetails getValue DateraUtil deleteAppInstance conn appInstanceName snapshotDetailsDao removeDetails csSnapshotId StoragePoolVO storagePool storagePoolDao findById storagePoolId long usedBytes getUsedBytes storagePool storagePool setUsedBytes usedBytes usedBytes storagePoolDao update storagePoolId storagePool catch Exception ex
Override public void revertSnapshot SnapshotInfo snapshotInfo SnapshotInfo snapshotOnPrimaryStore AsyncCompletionCallback CommandResult callback VolumeInfo volumeInfo snapshotInfo getBaseVolume VolumeVO volumeVO _volumeDao findById volumeInfo getId long storagePoolId volumeVO getPoolId long csSnapshotId snapshotInfo getId
long storagePoolId volumeVO getPoolId long csSnapshotId snapshotInfo getId s_logger info String valueOf csSnapshotId volumeVO getName DateraObject AppInstance appInstance try if volumeVO null volumeVO getRemoved null String errMsg CommandResult commandResult new CommandResult commandResult setResult errMsg callback complete commandResult return DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao SnapshotDetailsVO snapshotDetails snapshotDetailsDao findDetail csSnapshotId DateraUtil SNAPSHOT_ID if snapshotDetails null snapshotDetails getValue null String snapshotName snapshotDetails getValue
CommandResult commandResult new CommandResult commandResult setResult errMsg callback complete commandResult return DateraObject DateraConnection conn DateraUtil getDateraConnection storagePoolId _storagePoolDetailsDao SnapshotDetailsVO snapshotDetails snapshotDetailsDao findDetail csSnapshotId DateraUtil SNAPSHOT_ID if snapshotDetails null snapshotDetails getValue null String snapshotName snapshotDetails getValue s_logger info snapshotName appInstance DateraUtil restoreVolumeSnapshot conn snapshotName Preconditions checkNotNull appInstance updateVolumeDetails volumeInfo getId appInstance getSize CommandResult commandResult new CommandResult callback complete commandResult catch Exception ex
String volPlacement DateraUtil getVolPlacement url String clusterAdminUsername DateraUtil getValue DateraUtil CLUSTER_ADMIN_USERNAME url String clusterAdminPassword DateraUtil getValue DateraUtil CLUSTER_ADMIN_PASSWORD url String uuid String randomString PrimaryDataStoreParameters parameters new PrimaryDataStoreParameters if clusterId null if podId null throw new CloudRuntimeException if zoneId null throw new CloudRuntimeException ClusterVO cluster _clusterDao findById clusterId String clusterUuid cluster getUuid randomString DateraUtil generateUUID clusterUuid uuid DateraUtil PROVIDER_NAME clusterUuid randomString
throw new CloudRuntimeException ClusterVO cluster _clusterDao findById clusterId String clusterUuid cluster getUuid randomString DateraUtil generateUUID clusterUuid uuid DateraUtil PROVIDER_NAME clusterUuid randomString s_logger debug uuid parameters setPodId podId parameters setClusterId clusterId HypervisorType hypervisorType getHypervisorTypeForCluster clusterId if isSupportedHypervisorType hypervisorType throw new CloudRuntimeException hypervisorType else DataCenterVO zone zoneDao findById zoneId String zoneUuid zone getUuid randomString DateraUtil generateUUID zoneUuid
HypervisorType hypervisorType getHypervisorTypeForCluster clusterId if isSupportedHypervisorType hypervisorType throw new CloudRuntimeException hypervisorType else DataCenterVO zone zoneDao findById zoneId String zoneUuid zone getUuid randomString DateraUtil generateUUID zoneUuid uuid DateraUtil PROVIDER_NAME zoneUuid randomString s_logger debug uuid if capacityBytes null capacityBytes throw new IllegalArgumentException if capacityIops null capacityIops throw new IllegalArgumentException if domainName null domainName
Override public boolean hostConnect long hostId long storagePoolId HostVO host _hostDao findById hostId if host null
Override public boolean hostRemoved long hostId long clusterId ClusterVO clusterVO _clusterDao findById clusterId HostVO hostVO _hostDao findByIdIncludingRemoved hostId String initiatorName DateraUtil INITIATOR_PREFIX hostVO getUuid int s_lockTimeInSeconds GlobalLock lock GlobalLock getInternLock clusterVO getUuid if lock lock s_lockTimeInSeconds String errMsg clusterVO getUuid
public Answer createVolume VolumeInfo volume throws StorageUnavailableException if s_logger isDebugEnabled
Answer answer null CreateCmdResult result new CreateCmdResult null null if data getType DataObjectType VOLUME try answer createVolume VolumeInfo data if answer null answer getResult result setSuccess false if answer null result setResult answer getDetails else result setAnswer answer catch StorageUnavailableException e s_logger debug e errMsg e toString catch Exception e
try EndPoint ep null if data getType DataObjectType VOLUME ep epSelector select data StorageAction DELETEVOLUME else ep epSelector select data if ep null String errMsg s_logger error errMsg result setResult errMsg else Answer answer ep sendMessage cmd if answer null answer getResult result setResult answer getDetails catch Exception ex
templateObjectTO setPhysicalSize srcdata getSize templateObjectTO setFormat Storage ImageFormat RAW CopyCmdAnswer answer new CopyCmdAnswer templateObjectTO CopyCommandResult result new CopyCommandResult answer callback complete result else if srcdata getType DataObjectType TEMPLATE destData getType DataObjectType VOLUME int primaryStorageDownloadWait StorageManager PRIMARY_STORAGE_DOWNLOAD_WAIT value StoragePoolVO storagePoolVO primaryStoreDao findById store getId DataStore imageStore templateManager getImageStore storagePoolVO getDataCenterId srcdata getId DataObject srcData templateDataFactory getTemplate srcdata getId imageStore CopyCommand cmd new CopyCommand srcData getTO destData getTO primaryStorageDownloadWait true EndPoint ep epSelector select srcData destData Answer answer null if ep null String errMsg
CreateObjectCommand cmd new CreateObjectCommand snapshotTO EndPoint ep epSelector select snapshot StorageAction TAKESNAPSHOT Answer answer null if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd result new CreateCmdResult null answer if answer null answer getResult result setResult answer getDetails callback complete result return catch Exception e
Override public void revertSnapshot SnapshotInfo snapshot SnapshotInfo snapshotOnPrimaryStore AsyncCompletionCallback CommandResult callback SnapshotObjectTO snapshotTO SnapshotObjectTO snapshot getTO RevertSnapshotCommand cmd new RevertSnapshotCommand snapshotTO CommandResult result new CommandResult try EndPoint ep epSelector select snapshotOnPrimaryStore if ep null String errMsg
Override public void revertSnapshot SnapshotInfo snapshot SnapshotInfo snapshotOnPrimaryStore AsyncCompletionCallback CommandResult callback SnapshotObjectTO snapshotTO SnapshotObjectTO snapshot getTO RevertSnapshotCommand cmd new RevertSnapshotCommand snapshotTO CommandResult result new CommandResult try EndPoint ep epSelector select snapshotOnPrimaryStore if ep null String errMsg s_logger error errMsg result setResult errMsg else Answer answer ep sendMessage cmd if answer null answer getResult result setResult answer getDetails catch Exception ex
Override public void resize DataObject data AsyncCompletionCallback CreateCmdResult callback VolumeObject vol VolumeObject data StoragePool pool StoragePool data getDataStore ResizeVolumePayload resizeParameter ResizeVolumePayload vol getpayload ResizeVolumeCommand resizeCmd new ResizeVolumeCommand vol getPath new StorageFilerTO pool vol getSize resizeParameter newSize resizeParameter shrinkOk resizeParameter instanceName CreateCmdResult result new CreateCmdResult null null try ResizeVolumeAnswer answer ResizeVolumeAnswer storageMgr sendToPool pool resizeParameter hosts resizeCmd if answer null answer getResult long finalSize answer getNewSize
ResizeVolumeCommand resizeCmd new ResizeVolumeCommand vol getPath new StorageFilerTO pool vol getSize resizeParameter newSize resizeParameter shrinkOk resizeParameter instanceName CreateCmdResult result new CreateCmdResult null null try ResizeVolumeAnswer answer ResizeVolumeAnswer storageMgr sendToPool pool resizeParameter hosts resizeCmd if answer null answer getResult long finalSize answer getNewSize s_logger debug toHumanReadableSize vol getSize toHumanReadableSize finalSize vol setSize finalSize vol update else if answer null result setResult answer getDetails else s_logger debug result setResult catch Exception e
else if uri getScheme equalsIgnoreCase String uriPath uri getPath if uriPath null throw new InvalidParameterValueException else if uri getScheme equalsIgnoreCase String uriHost uri getHost String uriPath uri getPath if uriHost null uriPath null uriHost trim isEmpty uriPath trim isEmpty throw new InvalidParameterValueException catch URISyntaxException e throw new InvalidParameterValueException url String tags String dsInfos get Map String String details Map String String dsInfos get parameters setTags tags parameters setDetails details
String uriPath uri getPath if uriHost null uriPath null uriHost trim isEmpty uriPath trim isEmpty throw new InvalidParameterValueException catch URISyntaxException e throw new InvalidParameterValueException url String tags String dsInfos get Map String String details Map String String dsInfos get parameters setTags tags parameters setDetails details String scheme uri getScheme String storageHost uri getHost String hostPath null try hostPath URLDecoder decode uri getPath catch UnsupportedEncodingException e
protected boolean createStoragePool long hostId StoragePool pool
List StoragePoolHostVO hostPoolRecords _storagePoolHostDao listByPoolId store getId StoragePool pool StoragePool store boolean deleteFlag false HypervisorType hType null if hostPoolRecords size hType getHypervisorType hostPoolRecords get getHostId for StoragePoolHostVO host hostPoolRecords DeleteStoragePoolCommand deleteCmd new DeleteStoragePoolCommand pool final Answer answer agentMgr easySend host getHostId deleteCmd if answer null answer getResult deleteFlag true if HypervisorType KVM hType break else if answer null
public NmsResponse execute Class responseClass String object String method Object params StringBuilder sb new StringBuilder NmsRequest nmsRequest new NmsRequest object method params if logger isDebugEnabled
Override public void createAsync DataStore dataStore DataObject vol AsyncCompletionCallback CreateCmdResult callback EndPoint ep selector select vol if ep null String errMsg
Override public void createAsync DataStore dataStore DataObject dataObject AsyncCompletionCallback CreateCmdResult callback String iqn null String errMsg null try if dataObject getType DataObjectType VOLUME iqn createVolume VolumeInfo dataObject dataStore getId else if dataObject getType DataObjectType SNAPSHOT createTempVolume SnapshotInfo dataObject dataStore getId else if dataObject getType DataObjectType TEMPLATE iqn createTemplateVolume TemplateInfo dataObject dataStore getId else errMsg dataObject getType LOGGER error errMsg catch Exception ex errMsg ex getMessage
sfNewSnapshotName StringUtils left volumeInfo getName volumeInfo getName length trimRequired snapshotInfo getUuid long sfNewSnapshotId SolidFireUtil createSnapshot sfConnection sfVolumeId SolidFireUtil getSolidFireVolumeName sfNewSnapshotName getSnapshotAttributes snapshotInfo updateSnapshotDetails snapshotInfo getId volumeInfo getId sfVolumeId sfNewSnapshotId storagePoolId sfVolumeSize snapshotObjectTo setPath sfNewSnapshotId else String sfNewVolumeName volumeInfo getName snapshotInfo getUuid final Iops iops getIops MIN_IOPS_FOR_SNAPSHOT_VOLUME MAX_IOPS_FOR_SNAPSHOT_VOLUME storagePoolId long sfNewVolumeId SolidFireUtil createVolume sfConnection SolidFireUtil getSolidFireVolumeName sfNewVolumeName sfVolume getAccountId sfVolumeSize sfVolume isEnable512e getSnapshotAttributes snapshotInfo iops getMinIops iops getMaxIops iops getBurstIops SolidFireUtil SolidFireVolume sfNewVolume SolidFireUtil getVolume sfConnection sfNewVolumeId updateSnapshotDetails snapshotInfo getId sfNewVolumeId storagePoolId sfVolumeSize sfNewVolume getIqn snapshotObjectTo setPath sfNewVolumeId storagePoolDao update storagePoolId storagePool CreateObjectAnswer createObjectAnswer new CreateObjectAnswer snapshotObjectTo result new CreateCmdResult null createObjectAnswer result setResult null
SolidFireUtil SolidFireConnection sfConnection SolidFireUtil getSolidFireConnection storagePoolId storagePoolDetailsDao if isBasicDeleteByFolder volumeId performBasicDeleteByFolder sfConnection volumeId else if isBasicDelete volumeId performBasicDelete sfConnection volumeId else if isBasicDeleteFailure volumeId performBasicDeleteFailure sfConnection volumeId else deleteSolidFireVolume sfConnection volumeInfo volumeDetailsDao removeDetails volumeId StoragePoolVO storagePool storagePoolDao findById storagePoolId long usedBytes getUsedBytes storagePool volumeId storagePool setUsedBytes usedBytes usedBytes storagePoolDao update storagePoolId storagePool catch Exception ex
SolidFireUtil SolidFireConnection sfConnection SolidFireUtil getSolidFireConnection storagePoolId storagePoolDetailsDao SnapshotDetailsVO snapshotDetails snapshotDetailsDao findDetail csSnapshotId SolidFireUtil SNAPSHOT_ID if snapshotDetails null snapshotDetails getValue null long sfSnapshotId Long parseLong snapshotDetails getValue deleteSolidFireSnapshot sfConnection csSnapshotId sfSnapshotId else snapshotDetails snapshotDetailsDao findDetail csSnapshotId SolidFireUtil VOLUME_ID long sfVolumeId Long parseLong snapshotDetails getValue SolidFireUtil deleteVolume sfConnection sfVolumeId snapshotDetailsDao removeDetails csSnapshotId StoragePoolVO storagePool storagePoolDao findById storagePoolId long usedBytes getUsedBytes storagePool storagePool setUsedBytes usedBytes usedBytes storagePoolDao update storagePoolId storagePool catch Exception ex
details put SolidFireUtil MANAGEMENT_PORT String valueOf managementPort String clusterAdminUsername SolidFireUtil getValue SolidFireUtil CLUSTER_ADMIN_USERNAME url String clusterAdminPassword SolidFireUtil getValue SolidFireUtil CLUSTER_ADMIN_PASSWORD url details put SolidFireUtil CLUSTER_ADMIN_USERNAME clusterAdminUsername details put SolidFireUtil CLUSTER_ADMIN_PASSWORD clusterAdminPassword if capacityBytes SolidFireUtil MIN_VOLUME_SIZE capacityBytes SolidFireUtil MIN_VOLUME_SIZE long lMinIops long lMaxIops long lBurstIops try String minIops SolidFireUtil getValue SolidFireUtil MIN_IOPS url if minIops null minIops trim length lMinIops Long parseLong minIops catch Exception ex
capacityBytes SolidFireUtil MIN_VOLUME_SIZE long lMinIops long lMaxIops long lBurstIops try String minIops SolidFireUtil getValue SolidFireUtil MIN_IOPS url if minIops null minIops trim length lMinIops Long parseLong minIops catch Exception ex LOGGER info ex getLocalizedMessage try String maxIops SolidFireUtil getValue SolidFireUtil MAX_IOPS url if maxIops null maxIops trim length lMaxIops Long parseLong maxIops catch Exception ex
Long clusterId null Long hostId null for StoragePoolHostVO host hostPoolRecords DeleteStoragePoolCommand deleteCmd new DeleteStoragePoolCommand storagePool if HypervisorType VMware equals hypervisorType deleteCmd setRemoveDatastore true Map String String details new HashMap StoragePoolDetailVO storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil DATASTORE_NAME details put DeleteStoragePoolCommand DATASTORE_NAME storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil IQN details put DeleteStoragePoolCommand IQN storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil STORAGE_VIP details put DeleteStoragePoolCommand STORAGE_HOST storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil STORAGE_PORT details put DeleteStoragePoolCommand STORAGE_PORT storagePoolDetail getValue
details put DeleteStoragePoolCommand DATASTORE_NAME storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil IQN details put DeleteStoragePoolCommand IQN storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil STORAGE_VIP details put DeleteStoragePoolCommand STORAGE_HOST storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil STORAGE_PORT details put DeleteStoragePoolCommand STORAGE_PORT storagePoolDetail getValue deleteCmd setDetails details final Answer answer agentMgr easySend host getHostId deleteCmd if answer null answer getResult LOGGER info host getHostId HostVO hostVO hostDao findById host getHostId if hostVO null clusterId hostVO getClusterId hostId hostVO getId
details put DeleteStoragePoolCommand IQN storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil STORAGE_VIP details put DeleteStoragePoolCommand STORAGE_HOST storagePoolDetail getValue storagePoolDetail storagePoolDetailsDao findDetail storagePool getId SolidFireUtil STORAGE_PORT details put DeleteStoragePoolCommand STORAGE_PORT storagePoolDetail getValue deleteCmd setDetails details final Answer answer agentMgr easySend host getHostId deleteCmd if answer null answer getResult LOGGER info host getHostId HostVO hostVO hostDao findById host getHostId if hostVO null clusterId hostVO getClusterId hostId hostVO getId break else
Override public boolean hostAdded long hostId HostVO host hostDao findById hostId if host null
Override public boolean hostAdded long hostId HostVO host hostDao findById hostId if host null
private static SolidFireVag createClusterVagIfDoesntExist List SolidFireUtil SolidFireVag sfVags SolidFireConnection sfConnection String clusterUuId Map SolidFireUtil SolidFireVag List String sfVagToIqnsMap long sfVolumeId SolidFireVag sfVagMatchingClusterId sfVags stream filter vag vag getName equals clusterUuId findFirst orElse null if sfVagMatchingClusterId null
private void createCloudstackUserAccount LdapUser user String accountName Domain domain Account account _accountService getActiveAccountByName accountName domain getId if account null
List LdapUser users try if StringUtils isNotBlank groupName users _ldapManager getUsersInGroup groupName domainId else users _ldapManager getUsers domainId catch NoLdapUserMatchingQueryException ex users new ArrayList LdapUser s_logger info ex getMessage List LdapUser addedUsers new ArrayList LdapUser for LdapUser user users Domain domain getDomain user try createCloudstackUserAccount user getAccountName user domain addedUsers add user
Override public void execute throws ServerApiException try LinkAccountToLdapResponse response _ldapManager linkAccountToLdap this if admin null LdapUser ldapUser null try ldapUser _ldapManager getUser admin type ldapDomain domainId catch NoLdapUserMatchingQueryException e LOGGER debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId
LinkAccountToLdapResponse response _ldapManager linkAccountToLdap this if admin null LdapUser ldapUser null try ldapUser _ldapManager getUser admin type ldapDomain domainId catch NoLdapUserMatchingQueryException e LOGGER debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId LOGGER info admin domainId catch Exception e
LdapUser ldapUser null try ldapUser _ldapManager getUser admin type ldapDomain domainId catch NoLdapUserMatchingQueryException e LOGGER debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId LOGGER info admin domainId catch Exception e LOGGER info admin domainId e else
ldapUser _ldapManager getUser admin type ldapDomain domainId catch NoLdapUserMatchingQueryException e LOGGER debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId LOGGER info admin domainId catch Exception e LOGGER info admin domainId e else LOGGER debug admin domainId else
Override public void execute throws ServerApiException try LinkDomainToLdapResponse response _ldapManager linkDomainToLdap this if admin null LdapUser ldapUser null try ldapUser _ldapManager getUser admin type getLdapDomain domainId catch NoLdapUserMatchingQueryException e s_logger debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId
LinkDomainToLdapResponse response _ldapManager linkDomainToLdap this if admin null LdapUser ldapUser null try ldapUser _ldapManager getUser admin type getLdapDomain domainId catch NoLdapUserMatchingQueryException e s_logger debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId s_logger info admin domainId catch Exception e
LdapUser ldapUser null try ldapUser _ldapManager getUser admin type getLdapDomain domainId catch NoLdapUserMatchingQueryException e s_logger debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId s_logger info admin domainId catch Exception e s_logger info admin domainId e else
ldapUser _ldapManager getUser admin type getLdapDomain domainId catch NoLdapUserMatchingQueryException e s_logger debug admin e if ldapUser null ldapUser isDisabled Account account _accountService getActiveAccountByName admin domainId if account null try UserAccount userAccount _accountService createUserAccount admin ldapUser getFirstname ldapUser getLastname ldapUser getEmail null admin Account ACCOUNT_TYPE_DOMAIN_ADMIN RoleType DomainAdmin getId domainId null null UUID randomUUID toString UUID randomUUID toString User Source LDAP response setAdminId String valueOf userAccount getAccountId s_logger info admin domainId catch Exception e s_logger info admin domainId e else s_logger debug admin domainId else
String generateADGroupSearchFilter String groupName Long domainId final StringBuilder userObjectFilter new StringBuilder userObjectFilter append userObjectFilter append _ldapConfiguration getUserObject domainId userObjectFilter append final StringBuilder memberOfFilter new StringBuilder String groupCnName _ldapConfiguration getCommonNameAttribute groupName _ldapConfiguration getBaseDn domainId memberOfFilter append append getMemberOfAttribute domainId append memberOfFilter append groupCnName memberOfFilter append final StringBuilder result new StringBuilder result append result append userObjectFilter result append memberOfFilter result append
Override public Pair Boolean ActionOnFailedAuthentication authenticate final String username final String password final Long domainId final Map String Object requestParameters Pair Boolean ActionOnFailedAuthentication rc new Pair Boolean ActionOnFailedAuthentication false null if LOGGER isDebugEnabled
private void logAndDisable UserAccount userAccount String msg boolean remove if LOGGER isInfoEnabled
private LinkDomainToLdapResponse linkDomainToLdap Long domainId String type String name short accountType Validate notNull type Validate notNull domainId Validate notEmpty name Validate isTrue accountType accountType LinkType linkType LdapManager LinkType valueOf type toUpperCase LdapTrustMapVO vo _ldapTrustMapDao persist new LdapTrustMapVO domainId linkType name accountType DomainVO domain domainDao findById vo getDomainId String domainUuid if domain null
Validate notEmpty cmd getAccountName Validate notEmpty cmd getLdapDomain Validate notNull cmd getType Validate notEmpty cmd getLdapDomain LinkType linkType LdapManager LinkType valueOf cmd getType toUpperCase Account account accountDao findActiveAccount cmd getAccountName cmd getDomainId if account null account new AccountVO cmd getAccountName cmd getDomainId null cmd getAccountType UUID randomUUID toString accountDao persist AccountVO account Long accountId account getAccountId clearOldAccountMapping cmd LdapTrustMapVO vo _ldapTrustMapDao persist new LdapTrustMapVO cmd getDomainId linkType cmd getLdapDomain cmd getAccountType accountId DomainVO domain domainDao findById vo getDomainId String domainUuid if domain null
private void clearOldAccountMapping LinkAccountToLdapCmd cmd LdapTrustMapVO oldVo _ldapTrustMapDao findGroupInDomain cmd getDomainId cmd getLdapDomain if oldVo null if oldVo getAccountId 0l AccountVO oldAcount accountDao findByIdIncludingRemoved oldVo getAccountId String msg String format cmd getLdapDomain oldVo getAccountId cmd getDomainId if null oldAcount getRemoved msg
LdapTrustMapVO oldVo _ldapTrustMapDao findGroupInDomain cmd getDomainId cmd getLdapDomain if oldVo null if oldVo getAccountId 0l AccountVO oldAcount accountDao findByIdIncludingRemoved oldVo getAccountId String msg String format cmd getLdapDomain oldVo getAccountId cmd getDomainId if null oldAcount getRemoved msg LOGGER error msg throw new CloudRuntimeException msg else msg LOGGER warn msg _ldapTrustMapDao expunge oldVo getId else String msg String format cmd getLdapDomain cmd getDomainId
private String getMemberOfGroupString String group String memberOfAttribute final StringBuilder memberOfFilter new StringBuilder if null group if LOGGER isDebugEnabled
Override public List LdapUser getUsersInGroup String groupName LdapContext context Long domainId throws NamingException String attributeName _ldapConfiguration getGroupUniqueMemberAttribute domainId final SearchControls controls new SearchControls controls setSearchScope _ldapConfiguration getScope controls setReturningAttributes new String attributeName NamingEnumeration SearchResult result context search _ldapConfiguration getBaseDn domainId generateGroupSearchFilter groupName domainId controls final List LdapUser users new ArrayList LdapUser if result hasMoreElements Attribute attribute result nextElement getAttributes get attributeName NamingEnumeration values attribute getAll while values hasMoreElements String userdn String valueOf values nextElement try users add getUserForDn userdn context domainId catch NamingException e
Override public Pair Boolean ActionOnFailedAuthentication authenticate String username String password Long domainId Map String Object requestParameters if s_logger isDebugEnabled
Override public Pair Boolean UserAuthenticator ActionOnFailedAuthentication authenticate String username String password Long domainId Map String Object requestParameters if s_logger isDebugEnabled
Override public Pair Boolean ActionOnFailedAuthentication authenticate String username String password Long domainId Map String Object requestParameters if s_logger isDebugEnabled
if params containsKey ApiConstants DOMAIN domainPath String params get ApiConstants DOMAIN if domainPath null domainPath isEmpty if domainPath startsWith domainPath domainPath if domainPath endsWith domainPath domainPath SAMLProviderMetadata spMetadata samlAuthManager getSPMetadata SAMLProviderMetadata idpMetadata samlAuthManager getIdPMetadata idpId if idpMetadata null throw new ServerApiException ApiErrorCode PARAM_ERROR apiServer getSerializedApiError ApiErrorCode PARAM_ERROR getHttpCode idpId params responseType if idpMetadata getSsoUrl null idpMetadata getSsoUrl isEmpty throw new ServerApiException ApiErrorCode PARAM_ERROR apiServer getSerializedApiError ApiErrorCode PARAM_ERROR getHttpCode idpId idpMetadata getContactPersonName idpMetadata getContactPersonEmail params responseType String authnId SAMLUtils generateSecureRandomId samlAuthManager saveToken authnId domainPath idpMetadata getEntityId
Override public String authenticate String command Map String Object params HttpSession session InetAddress remoteAddress String responseType StringBuilder auditTrailSb final HttpServletRequest req final HttpServletResponse resp throws ServerApiException auditTrailSb append LogoutCmdResponse response new LogoutCmdResponse response setDescription response setResponseName getCommandName String responseString ApiResponseSerializer toSerializedString response responseType if session null try resp sendRedirect SAML2AuthManager SAMLCloudStackRedirectionUrl value catch IOException ignored s_logger info ignored return responseString try DefaultBootstrap bootstrap catch ConfigurationException FactoryConfigurationError e
catch IOException ignored s_logger info ignored return responseString try DefaultBootstrap bootstrap catch ConfigurationException FactoryConfigurationError e s_logger error e getMessage throw new ServerApiException ApiErrorCode ACCOUNT_ERROR _apiServer getSerializedApiError ApiErrorCode ACCOUNT_ERROR getHttpCode params responseType if params null params containsKey try final String samlResponse String params get SAMLPluginConstants SAML_RESPONSE Response processedSAMLResponse SAMLUtils decodeSAMLResponse samlResponse String statusCode processedSAMLResponse getStatus getStatusCode getValue if statusCode equals StatusCode SUCCESS_URI throw new ServerApiException ApiErrorCode INTERNAL_ERROR _apiServer getSerializedApiError ApiErrorCode INTERNAL_ERROR getHttpCode params responseType
try final String samlResponse String params get SAMLPluginConstants SAML_RESPONSE Response processedSAMLResponse SAMLUtils decodeSAMLResponse samlResponse String statusCode processedSAMLResponse getStatus getStatusCode getValue if statusCode equals StatusCode SUCCESS_URI throw new ServerApiException ApiErrorCode INTERNAL_ERROR _apiServer getSerializedApiError ApiErrorCode INTERNAL_ERROR getHttpCode params responseType catch ConfigurationException FactoryConfigurationError ParserConfigurationException SAXException IOException UnmarshallingException e s_logger error e getMessage try resp sendRedirect SAML2AuthManager SAMLCloudStackRedirectionUrl value catch IOException ignored s_logger info ignored return responseString String idpId String session getAttribute SAMLPluginConstants SAML_IDPID SAMLProviderMetadata idpMetadata _samlAuthManager getIdPMetadata idpId
catch ConfigurationException FactoryConfigurationError ParserConfigurationException SAXException IOException UnmarshallingException e s_logger error e getMessage try resp sendRedirect SAML2AuthManager SAMLCloudStackRedirectionUrl value catch IOException ignored s_logger info ignored return responseString String idpId String session getAttribute SAMLPluginConstants SAML_IDPID SAMLProviderMetadata idpMetadata _samlAuthManager getIdPMetadata idpId String nameId String session getAttribute SAMLPluginConstants SAML_NAMEID if idpMetadata null nameId null nameId isEmpty try resp sendRedirect SAML2AuthManager SAMLCloudStackRedirectionUrl value catch IOException ignored s_logger info ignored
private void addIdpToMap EntityDescriptor descriptor Map String SAMLProviderMetadata idpMap SAMLProviderMetadata idpMetadata new SAMLProviderMetadata idpMetadata setEntityId descriptor getEntityID
if initSP s_logger error return false _timer new Timer final HttpClient client new HttpClient final String idpMetaDataUrl getSAMLIdentityProviderMetadataURL if SAMLTimeout value null SAMLTimeout value SAMLPluginConstants SAML_REFRESH_INTERVAL _refreshInterval SAMLTimeout value try DefaultBootstrap bootstrap if idpMetaDataUrl startsWith _idpMetaDataProvider new HTTPMetadataProvider _timer client idpMetaDataUrl else File metadataFile PropertiesUtil findConfigFile idpMetaDataUrl if metadataFile null
_timer new Timer final HttpClient client new HttpClient final String idpMetaDataUrl getSAMLIdentityProviderMetadataURL if SAMLTimeout value null SAMLTimeout value SAMLPluginConstants SAML_REFRESH_INTERVAL _refreshInterval SAMLTimeout value try DefaultBootstrap bootstrap if idpMetaDataUrl startsWith _idpMetaDataProvider new HTTPMetadataProvider _timer client idpMetaDataUrl else File metadataFile PropertiesUtil findConfigFile idpMetaDataUrl if metadataFile null s_logger error idpMetaDataUrl return false else
else File metadataFile PropertiesUtil findConfigFile idpMetaDataUrl if metadataFile null s_logger error idpMetaDataUrl return false else s_logger debug metadataFile getAbsolutePath _idpMetaDataProvider new FilesystemMetadataProvider _timer metadataFile _idpMetaDataProvider setRequireValidMetadata true _idpMetaDataProvider setParserPool new BasicParserPool _idpMetaDataProvider initialize _timer scheduleAtFixedRate new MetadataRefreshTask _refreshInterval catch MetadataProviderException e s_logger error e getMessage s_logger error
if metadataFile null s_logger error idpMetaDataUrl return false else s_logger debug metadataFile getAbsolutePath _idpMetaDataProvider new FilesystemMetadataProvider _timer metadataFile _idpMetaDataProvider setRequireValidMetadata true _idpMetaDataProvider setParserPool new BasicParserPool _idpMetaDataProvider initialize _timer scheduleAtFixedRate new MetadataRefreshTask _refreshInterval catch MetadataProviderException e s_logger error e getMessage s_logger error return false catch ConfigurationException FactoryConfigurationError e
Override public Pair Boolean ActionOnFailedAuthentication authenticate String username String password Long domainId Map String Object requestParameters if s_logger isDebugEnabled
Override public Pair Boolean ActionOnFailedAuthentication authenticate String username String password Long domainId Map String Object requestParameters if s_logger isDebugEnabled
long dcId plan getDataCenterId Long podId plan getPodId Long clusterId plan getClusterId ServiceOffering offering vmProfile getServiceOffering VMTemplateVO template VMTemplateVO vmProfile getTemplate Account account vmProfile getOwner boolean isVMDeployedWithUefi false UserVmDetailVO userVmDetailVO _userVmDetailsDao findDetail vmProfile getId if userVmDetailVO null if equalsIgnoreCase userVmDetailVO getValue equalsIgnoreCase userVmDetailVO getValue isVMDeployedWithUefi true s_logger info isVMDeployedWithUefi if type Host Type Storage return new ArrayList Host if s_logger isDebugEnabled
s_logger info isVMDeployedWithUefi if type Host Type Storage return new ArrayList Host if s_logger isDebugEnabled s_logger debug dcId podId clusterId String hostTagOnOffering offering getHostTag String hostTagOnTemplate template getTemplateTag String hostTagUefi boolean hasSvcOfferingTag hostTagOnOffering null true false boolean hasTemplateTag hostTagOnTemplate null true false List HostVO clusterHosts new ArrayList HostVO List HostVO hostsMatchingUefiTag new ArrayList HostVO if isVMDeployedWithUefi hostsMatchingUefiTag _hostDao listByHostCapability type clusterId podId dcId Host HOST_UEFI_ENABLE if s_logger isDebugEnabled
boolean hasSvcOfferingTag hostTagOnOffering null true false boolean hasTemplateTag hostTagOnTemplate null true false List HostVO clusterHosts new ArrayList HostVO List HostVO hostsMatchingUefiTag new ArrayList HostVO if isVMDeployedWithUefi hostsMatchingUefiTag _hostDao listByHostCapability type clusterId podId dcId Host HOST_UEFI_ENABLE if s_logger isDebugEnabled s_logger debug hostTagUefi hostsMatchingUefiTag String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if haVmTag null clusterHosts _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null clusterHosts _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else
List HostVO hostsMatchingUefiTag new ArrayList HostVO if isVMDeployedWithUefi hostsMatchingUefiTag _hostDao listByHostCapability type clusterId podId dcId Host HOST_UEFI_ENABLE if s_logger isDebugEnabled s_logger debug hostTagUefi hostsMatchingUefiTag String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if haVmTag null clusterHosts _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null clusterHosts _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else List HostVO hostsMatchingOfferingTag new ArrayList HostVO List HostVO hostsMatchingTemplateTag new ArrayList HostVO if hasSvcOfferingTag
if s_logger isDebugEnabled s_logger debug hostTagUefi hostsMatchingUefiTag String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if haVmTag null clusterHosts _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null clusterHosts _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else List HostVO hostsMatchingOfferingTag new ArrayList HostVO List HostVO hostsMatchingTemplateTag new ArrayList HostVO if hasSvcOfferingTag if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsMatchingOfferingTag _hostDao listByHostTag type clusterId podId dcId hostTagOnOffering
String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if haVmTag null clusterHosts _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null clusterHosts _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else List HostVO hostsMatchingOfferingTag new ArrayList HostVO List HostVO hostsMatchingTemplateTag new ArrayList HostVO if hasSvcOfferingTag if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsMatchingOfferingTag _hostDao listByHostTag type clusterId podId dcId hostTagOnOffering if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsMatchingOfferingTag
else if hostTagOnOffering null hostTagOnTemplate null clusterHosts _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else List HostVO hostsMatchingOfferingTag new ArrayList HostVO List HostVO hostsMatchingTemplateTag new ArrayList HostVO if hasSvcOfferingTag if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsMatchingOfferingTag _hostDao listByHostTag type clusterId podId dcId hostTagOnOffering if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsMatchingOfferingTag if hasTemplateTag if s_logger isDebugEnabled s_logger debug hostTagOnTemplate
if type Host Type Storage return suitableHosts String hostTagOnOffering offering getHostTag String hostTagOnTemplate template getTemplateTag boolean hasSvcOfferingTag hostTagOnOffering null true false boolean hasTemplateTag hostTagOnTemplate null true false String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if haVmTag null hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null hostsCopy retainAll _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else if hasSvcOfferingTag if s_logger isDebugEnabled
String hostTagOnOffering offering getHostTag String hostTagOnTemplate template getTemplateTag boolean hasSvcOfferingTag hostTagOnOffering null true false boolean hasTemplateTag hostTagOnTemplate null true false String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if haVmTag null hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null hostsCopy retainAll _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else if hasSvcOfferingTag if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId hostTagOnOffering
boolean hasTemplateTag hostTagOnTemplate null true false String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag if haVmTag null hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null hostsCopy retainAll _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else if hasSvcOfferingTag if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId hostTagOnOffering if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsCopy if hasTemplateTag
hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId haVmTag else if hostTagOnOffering null hostTagOnTemplate null hostsCopy retainAll _resourceMgr listAllUpAndEnabledNonHAHosts type clusterId podId dcId else if hasSvcOfferingTag if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId hostTagOnOffering if s_logger isDebugEnabled s_logger debug hostTagOnOffering hostsCopy if hasTemplateTag if s_logger isDebugEnabled s_logger debug hostTagOnTemplate hostsCopy retainAll _hostDao listByHostTag type clusterId podId dcId hostTagOnTemplate
else if _allocationAlgorithm equals hosts reorderHostsByCapacity plan hosts if s_logger isDebugEnabled s_logger debug hosts size hosts hosts prioritizeHosts template offering hosts if s_logger isDebugEnabled s_logger debug hosts size hosts if s_logger isDebugEnabled s_logger debug offering getCpu offering getSpeed offering getRamSize long serviceOfferingId offering getId List Host suitableHosts new ArrayList Host ServiceOfferingDetailsVO offeringDetails null for Host host hosts if suitableHosts size returnUpTo break
s_logger debug hosts size hosts hosts prioritizeHosts template offering hosts if s_logger isDebugEnabled s_logger debug hosts size hosts if s_logger isDebugEnabled s_logger debug offering getCpu offering getSpeed offering getRamSize long serviceOfferingId offering getId List Host suitableHosts new ArrayList Host ServiceOfferingDetailsVO offeringDetails null for Host host hosts if suitableHosts size returnUpTo break if avoid shouldAvoid host if s_logger isDebugEnabled s_logger debug host getName host getId
if s_logger isDebugEnabled s_logger debug offering getCpu offering getSpeed offering getRamSize long serviceOfferingId offering getId List Host suitableHosts new ArrayList Host ServiceOfferingDetailsVO offeringDetails null for Host host hosts if suitableHosts size returnUpTo break if avoid shouldAvoid host if s_logger isDebugEnabled s_logger debug host getName host getId continue if _capacityMgr checkIfHostReachMaxGuestLimit host if s_logger isDebugEnabled s_logger debug host getName host getId
continue if _capacityMgr checkIfHostReachMaxGuestLimit host if s_logger isDebugEnabled s_logger debug host getName host getId avoid addHost host getId continue if offeringDetails _serviceOfferingDetailsDao findDetail serviceOfferingId GPU Keys vgpuType toString null ServiceOfferingDetailsVO groupName _serviceOfferingDetailsDao findDetail serviceOfferingId GPU Keys pciDevice toString if _resourceMgr isGPUDeviceAvailable host getId groupName getValue offeringDetails getValue s_logger info host getName host getId avoid addHost host getId continue int cpu_requested offering getCpu offering getSpeed long ram_requested offering getRamSize 1024L 1024L Cluster cluster _clusterDao findById host getClusterId
s_logger debug host getName host getId avoid addHost host getId continue if offeringDetails _serviceOfferingDetailsDao findDetail serviceOfferingId GPU Keys vgpuType toString null ServiceOfferingDetailsVO groupName _serviceOfferingDetailsDao findDetail serviceOfferingId GPU Keys pciDevice toString if _resourceMgr isGPUDeviceAvailable host getId groupName getValue offeringDetails getValue s_logger info host getName host getId avoid addHost host getId continue int cpu_requested offering getCpu offering getSpeed long ram_requested offering getRamSize 1024L 1024L Cluster cluster _clusterDao findById host getClusterId ClusterDetailsVO clusterDetailsCpuOvercommit _clusterDetailsDao findDetail cluster getId ClusterDetailsVO clusterDetailsRamOvercommmt _clusterDetailsDao findDetail cluster getId Float cpuOvercommitRatio Float parseFloat clusterDetailsCpuOvercommit getValue
return hosts String templateGuestOSCategory getTemplateGuestOSCategory template List Host prioritizedHosts new ArrayList Host List Host noHvmHosts new ArrayList Host List Host hostsToCheck new ArrayList Host if template isRequiresHvm for Host host hosts if hostSupportsHVM host hostsToCheck add host else noHvmHosts add host else hostsToCheck addAll hosts if s_logger isDebugEnabled if noHvmHosts size
List Host hosts super allocateTo vm plan type avoid returnUpTo if hosts null hosts isEmpty return hosts s_logger debug VirtualMachine Type vmType vm getType if vmType VirtualMachine Type User s_logger debug return new ArrayList Host DataCenter dc _dcDao findById plan getDataCenterId List PodCluster pcs _resourceMgr listByDataCenter dc getId if dc getNetworkType equals NetworkType Basic s_logger debug List VolumeVO vols _volsDao findByInstance vm getId VolumeVO vol vols get long podId vol getPodId
Override public Pair Pod Long allocateTo VirtualMachineTemplate template ServiceOffering offering DataCenter zone long accountId Set Long avoids long zoneId zone getId List HostPodVO podsInZone _podDao listByDataCenterId zoneId if podsInZone size
if podsInZone size s_logger debug zone getName return null List HostPodVO availablePods new ArrayList HostPodVO Map Long Long podHostCandidates new HashMap Long Long for HostPodVO pod podsInZone long podId pod getId if avoids contains podId if template null templateAvailableInPod template getId pod getDataCenterId podId continue if offering null long hostCandiates new long boolean enoughCapacity dataCenterAndPodHasEnoughCapacity zoneId podId offering getRamSize 1024L 1024L Capacity CAPACITY_TYPE_MEMORY hostCandiates if enoughCapacity if s_logger isDebugEnabled
Map Long Long podHostCandidates new HashMap Long Long for HostPodVO pod podsInZone long podId pod getId if avoids contains podId if template null templateAvailableInPod template getId pod getDataCenterId podId continue if offering null long hostCandiates new long boolean enoughCapacity dataCenterAndPodHasEnoughCapacity zoneId podId offering getRamSize 1024L 1024L Capacity CAPACITY_TYPE_MEMORY hostCandiates if enoughCapacity if s_logger isDebugEnabled s_logger debug zoneId podId continue enoughCapacity dataCenterAndPodHasEnoughCapacity zoneId podId long offering getCpu offering getSpeed Capacity CAPACITY_TYPE_CPU hostCandiates if enoughCapacity
enoughCapacity dataCenterAndPodHasEnoughCapacity zoneId podId long offering getCpu offering getSpeed Capacity CAPACITY_TYPE_CPU hostCandiates if enoughCapacity if s_logger isDebugEnabled s_logger debug zoneId podId continue podHostCandidates put podId hostCandiates List UserVmVO vmsInPod _vmDao listByAccountAndPod accountId pod getId if vmsInPod isEmpty return new Pair Pod Long pod podHostCandidates get podId List VolumeVO volumesInPod _volumeDao findByAccountAndPod accountId pod getId if volumesInPod isEmpty return new Pair Pod Long pod podHostCandidates get podId availablePods add pod if availablePods size s_logger debug zone getName
private boolean skipCalculation VMInstanceVO vm if vm getState State Expunging if s_logger isDebugEnabled
break case Capacity CAPACITY_TYPE_DIRECT_ATTACHED_PUBLIC_IP msgSubject dc getName totalStr Double toString totalCapacity usedStr Double toString usedCapacity msgContent totalStr usedStr pctStr alertType AlertManager AlertType ALERT_TYPE_DIRECT_ATTACHED_PUBLIC_IP break case Capacity CAPACITY_TYPE_VLAN msgSubject dc getName totalStr Double toString totalCapacity usedStr Double toString usedCapacity msgContent totalStr usedStr pctStr alertType AlertManager AlertType ALERT_TYPE_VLAN break try if s_logger isDebugEnabled
case Capacity CAPACITY_TYPE_DIRECT_ATTACHED_PUBLIC_IP msgSubject dc getName totalStr Double toString totalCapacity usedStr Double toString usedCapacity msgContent totalStr usedStr pctStr alertType AlertManager AlertType ALERT_TYPE_DIRECT_ATTACHED_PUBLIC_IP break case Capacity CAPACITY_TYPE_VLAN msgSubject dc getName totalStr Double toString totalCapacity usedStr Double toString usedCapacity msgContent totalStr usedStr pctStr alertType AlertManager AlertType ALERT_TYPE_VLAN break try if s_logger isDebugEnabled s_logger debug msgSubject
msgContent totalStr usedStr pctStr alertType AlertManager AlertType ALERT_TYPE_DIRECT_ATTACHED_PUBLIC_IP break case Capacity CAPACITY_TYPE_VLAN msgSubject dc getName totalStr Double toString totalCapacity usedStr Double toString usedCapacity msgContent totalStr usedStr pctStr alertType AlertManager AlertType ALERT_TYPE_VLAN break try if s_logger isDebugEnabled s_logger debug msgSubject s_logger debug msgContent _emailAlert sendAlert alertType dc getId podId clusterId msgSubject msgContent catch Exception ex
private void onClusterNodeJoined Object sender ClusterNodeJoinEventArgs args if s_logger isDebugEnabled for ManagementServerHostVO mshost args getJoinedNodes
private void onClusterNodeLeft Object sender ClusterNodeLeftEventArgs args if s_logger isDebugEnabled for ManagementServerHostVO mshost args getLeftNodes
Override public boolean configure String name Map String Object params throws ConfigurationException if s_logger isInfoEnabled
if acctIdStr null accountObject _entityMgr findById Account class Long parseLong acctIdStr CallContext ctx CallContext register user accountObject if contextDetails null Type objectMapType new TypeToken Map Object Object getType ctx putContextParameters Map Object Object gson fromJson contextDetails objectMapType try _dispatcher dispatch cmdObj params true _asyncJobMgr completeAsyncJob job getId JobInfo Status SUCCEEDED ApiSerializerHelper toSerializedString cmdObj getResponseObject catch InvalidParameterValueException ipve throw new ServerApiException ApiErrorCode PARAM_ERROR ipve getMessage finally CallContext unregister catch Throwable e
GuestOS guestOs ApiDBUtils findGuestOSById instance getGuestOSId if guestOs null snapshotResponse setOsTypeId guestOs getUuid snapshotResponse setOsDisplayName guestOs getDisplayName snapshotResponse setCreated snapshot getCreated snapshotResponse setName snapshot getName snapshotResponse setIntervalType ApiDBUtils getSnapshotIntervalTypes snapshot getId snapshotResponse setState snapshot getState snapshotResponse setLocationType ApiDBUtils getSnapshotLocationType snapshot getId SnapshotInfo snapshotInfo null if snapshot SnapshotInfo snapshotInfo SnapshotInfo snapshot else DataStoreRole dataStoreRole getDataStoreRole snapshot _snapshotStoreDao _dataStoreMgr snapshotInfo snapshotfactory getSnapshot snapshot getId dataStoreRole
if view ResponseView Full if templateOwner null templateOwnerDomain templateOwner getDomainId TemplatePermissionsResponse response new TemplatePermissionsResponse response setId template getUuid response setPublicTemplate template isPublicTemplate if view ResponseView Full templateOwnerDomain null Domain domain ApiDBUtils findDomainById templateOwnerDomain if domain null response setDomainId domain getUuid List String projectIds new ArrayList String List String regularAccounts new ArrayList String for String accountName accountNames Account account ApiDBUtils findAccountByNameDomain accountName templateOwner getDomainId if account null
private void populateAccount ControlledEntityResponse response long accountId Account account ApiDBUtils findAccountById accountId if account null
else nameField serializedParts int index result indexOf token nameField token content result substring index nameField length Class clz try clz Class forName clzName catch ClassNotFoundException e return null Gson gson ApiGsonHelper getBuilder create Object obj gson fromJson content clz if nameField null ResponseObject obj setObjectName nameField return obj return null
Override public boolean start Security addProvider new BouncyCastleProvider Integer apiPort IntegrationAPIPort value final Long snapshotLimit ConcurrentSnapshotsThresholdPerHost value if snapshotLimit null snapshotLimit longValue
List Field fields ReflectUtil getAllFieldsForClass cmdClass BaseCmd class for Field field fields Parameter parameterAnnotation field getAnnotation Parameter class if parameterAnnotation null parameterAnnotation expose continue Object paramObj parameterMap get parameterAnnotation name if paramObj null if parameterAnnotation acceptedOnAdminPort throw new ServerApiException ApiErrorCode ACCOUNT_ERROR parameterAnnotation name CallContext register accountMgr getSystemUser accountMgr getSystemAccount sb insert User UID_SYSTEM Account ACCOUNT_ID_SYSTEM null final String responseText handleRequest parameterMap responseType sb sb append responseText null responseText length writeResponse response responseText HttpStatus SC_OK responseType null catch final ServerApiException se
throw new ServerApiException ApiErrorCode UNSUPPORTED_ACTION_ERROR else if authManager getAPIAuthenticator command null return null final Map String String paramMap new HashMap String String final Set keys params keySet final Iterator keysIter keys iterator while keysIter hasNext final String key String keysIter next if equalsIgnoreCase key continue final String value String params get key paramMap put key value Class cmdClass getCmdClass command if cmdClass null
buildAuditTrail auditTrailSb command log toString else final String errorString command s_logger warn errorString auditTrailSb append errorString throw new ServerApiException ApiErrorCode UNSUPPORTED_ACTION_ERROR errorString catch final InvalidParameterValueException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final IllegalArgumentException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final PermissionDeniedException ex final ArrayList ExceptionProxyObject idList ex getIdProxyList if idList null
else final String errorString command s_logger warn errorString auditTrailSb append errorString throw new ServerApiException ApiErrorCode UNSUPPORTED_ACTION_ERROR errorString catch final InvalidParameterValueException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final IllegalArgumentException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final PermissionDeniedException ex final ArrayList ExceptionProxyObject idList ex getIdProxyList if idList null final StringBuffer buf new StringBuffer
s_logger warn errorString auditTrailSb append errorString throw new ServerApiException ApiErrorCode UNSUPPORTED_ACTION_ERROR errorString catch final InvalidParameterValueException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final IllegalArgumentException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final PermissionDeniedException ex final ArrayList ExceptionProxyObject idList ex getIdProxyList if idList null final StringBuffer buf new StringBuffer for final ExceptionProxyObject obj idList buf append obj getDescription
catch final InvalidParameterValueException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final IllegalArgumentException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final PermissionDeniedException ex final ArrayList ExceptionProxyObject idList ex getIdProxyList if idList null final StringBuffer buf new StringBuffer for final ExceptionProxyObject obj idList buf append obj getDescription buf append buf append obj getUuid buf append
catch final IllegalArgumentException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final PermissionDeniedException ex final ArrayList ExceptionProxyObject idList ex getIdProxyList if idList null final StringBuffer buf new StringBuffer for final ExceptionProxyObject obj idList buf append obj getDescription buf append buf append obj getUuid buf append s_logger info ex getMessage buf toString else s_logger info ex getMessage
throw new ServerApiException ApiErrorCode PARAM_ERROR ex getMessage ex catch final PermissionDeniedException ex final ArrayList ExceptionProxyObject idList ex getIdProxyList if idList null final StringBuffer buf new StringBuffer for final ExceptionProxyObject obj idList buf append obj getDescription buf append buf append obj getUuid buf append s_logger info ex getMessage buf toString else s_logger info ex getMessage throw new ServerApiException ApiErrorCode ACCOUNT_ERROR ex getMessage ex catch final AccountLimitException ex
for final ExceptionProxyObject obj idList buf append obj getDescription buf append buf append obj getUuid buf append s_logger info ex getMessage buf toString else s_logger info ex getMessage throw new ServerApiException ApiErrorCode ACCOUNT_ERROR ex getMessage ex catch final AccountLimitException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode ACCOUNT_RESOURCE_LIMIT_ERROR ex getMessage ex catch final InsufficientCapacityException ex s_logger info ex getMessage String errorMsg ex getMessage
buf append obj getUuid buf append s_logger info ex getMessage buf toString else s_logger info ex getMessage throw new ServerApiException ApiErrorCode ACCOUNT_ERROR ex getMessage ex catch final AccountLimitException ex s_logger info ex getMessage throw new ServerApiException ApiErrorCode ACCOUNT_RESOURCE_LIMIT_ERROR ex getMessage ex catch final InsufficientCapacityException ex s_logger info ex getMessage String errorMsg ex getMessage if accountMgr isRootAdmin CallContext current getCallingAccount getId errorMsg BaseCmd USER_ERROR_MESSAGE throw new ServerApiException ApiErrorCode INSUFFICIENT_CAPACITY_ERROR errorMsg ex
String apiKey null String secretKey null String signature null String unsignedRequest null final String command String requestParameters get ApiConstants COMMAND if command null s_logger info return false final String commandName command if userId null final User user ApiDBUtils findUserById userId return commandAvailable remoteAddress commandName user else if s_apiNameCmdClassMap containsKey commandName commandName equals commandName equals final String errorMessage commandName remoteAddress getHostAddress
final Date now new Date System currentTimeMillis if expiresTS before now s_logger debug signature apiKey return false final TransactionLegacy txn TransactionLegacy open TransactionLegacy CLOUD_DB txn close User user null final Pair User Account userAcctPair accountMgr findUserByApiKey apiKey if userAcctPair null s_logger debug apiKey return false user userAcctPair first final Account account userAcctPair second if user getState Account State enabled account getState equals Account State enabled s_logger info user getId user getUsername user getState account getState
if userDomain null userDomain getId 1L throw new CloudAuthenticationException domainPath else domainId userDomain getId final UserAccount userAcct accountMgr authenticateUser username password domainId loginIpAddress requestParameters if userAcct null final String timezone userAcct getTimezone float offsetInHrs 0f if timezone null final TimeZone t TimeZone getTimeZone timezone s_logger info timezone final java util Date date new java util Date final long longDate date getTime final float offsetInMs t getOffset longDate offsetInHrs offsetInMs
resp setStatusCode statusCode resp setReasonPhrase reasonPhrase final BasicHttpEntity body new BasicHttpEntity if HttpUtils RESPONSE_TYPE_JSON equalsIgnoreCase responseType body setContentType JSONcontentType value if responseText null body setContent new ByteArrayInputStream getBytes HttpUtils UTF_8 else body setContentType if responseText null body setContent new ByteArrayInputStream getBytes HttpUtils UTF_8 if responseText null body setContent new ByteArrayInputStream responseText getBytes HttpUtils UTF_8 resp setEntity body catch final Exception ex
catch UnknownHostException e s_logger warn e final String response apiServer getSerializedApiError HttpServletResponse SC_INTERNAL_SERVER_ERROR null HttpUtils RESPONSE_TYPE_XML HttpUtils writeHttpResponse resp response HttpServletResponse SC_INTERNAL_SERVER_ERROR HttpUtils RESPONSE_TYPE_XML ApiServer JSONcontentType value return final StringBuilder auditTrailSb new StringBuilder auditTrailSb append append remoteAddress getHostAddress auditTrailSb append append req getMethod append String responseType HttpUtils RESPONSE_TYPE_XML final Map String Object params new HashMap String Object params putAll req getParameterMap utf8Fixup req params String reqStr String cleanQueryString StringUtils cleanString req getQueryString if s_logger isDebugEnabled
final String command String params get ApiConstants COMMAND if command null s_logger info auditTrailSb append HttpServletResponse SC_BAD_REQUEST final String serializedResponse apiServer getSerializedApiError HttpServletResponse SC_BAD_REQUEST params responseType HttpUtils writeHttpResponse resp serializedResponse HttpServletResponse SC_BAD_REQUEST responseType ApiServer JSONcontentType value return final User user entityMgr findById User class userId CallContext register user Account accountObj else try session invalidate catch final IllegalStateException ise auditTrailSb append HttpServletResponse SC_UNAUTHORIZED final String serializedResponse apiServer getSerializedApiError HttpServletResponse SC_UNAUTHORIZED params responseType
private static Method getGetMethod Object o String propName Method method null String methodName getGetMethodName propName try method o getClass getMethod methodName catch SecurityException e1 s_logger error o getClass getName propName catch NoSuchMethodException e1 if s_logger isTraceEnabled s_logger trace o getClass getName methodName propName if method null return method methodName getGetMethodName propName try method o getClass getMethod methodName catch SecurityException e1
SuppressWarnings public void processParameters final BaseCmd cmd final Map params final Map Object AccessType entitiesToAccess new HashMap Object AccessType final List Field cmdFields cmd getParamFields for final Field field cmdFields final Parameter parameterAnnotation field getAnnotation Parameter class final Object paramObj params get parameterAnnotation name if paramObj null if parameterAnnotation required throw new ServerApiException ApiErrorCode PARAM_ERROR cmd getCommandName substring cmd getCommandName length parameterAnnotation name continue try validateField paramObj parameterAnnotation setFieldValue field cmd paramObj parameterAnnotation catch final IllegalArgumentException argEx if s_logger isDebugEnabled
final Parameter parameterAnnotation field getAnnotation Parameter class final Object paramObj params get parameterAnnotation name if paramObj null if parameterAnnotation required throw new ServerApiException ApiErrorCode PARAM_ERROR cmd getCommandName substring cmd getCommandName length parameterAnnotation name continue try validateField paramObj parameterAnnotation setFieldValue field cmd paramObj parameterAnnotation catch final IllegalArgumentException argEx if s_logger isDebugEnabled s_logger debug cmd getCommandName paramObj parameterAnnotation name throw new ServerApiException ApiErrorCode PARAM_ERROR cmd getCommandName substring cmd getCommandName length paramObj parameterAnnotation name catch final ParseException parseEx if s_logger isDebugEnabled
continue try validateField paramObj parameterAnnotation setFieldValue field cmd paramObj parameterAnnotation catch final IllegalArgumentException argEx if s_logger isDebugEnabled s_logger debug cmd getCommandName paramObj parameterAnnotation name throw new ServerApiException ApiErrorCode PARAM_ERROR cmd getCommandName substring cmd getCommandName length paramObj parameterAnnotation name catch final ParseException parseEx if s_logger isDebugEnabled s_logger debug paramObj cmd getCommandName substring cmd getCommandName length throw new ServerApiException ApiErrorCode PARAM_ERROR paramObj cmd getCommandName substring cmd getCommandName length catch final InvalidParameterValueException invEx throw new ServerApiException ApiErrorCode PARAM_ERROR cmd getCommandName substring cmd getCommandName length invEx getMessage catch final CloudRuntimeException cloudEx
final String token st nextToken final CommandType listType annotation collectionType switch listType case INTEGER listParam add Integer valueOf token break case UUID if token isEmpty break final Long internalId translateUuidToInternalId token annotation listParam add internalId break case LONG listParam add Long valueOf token break case SHORT listParam add Short valueOf token break case STRING listParam add token
listParam add Long valueOf token break case SHORT listParam add Short valueOf token break case STRING listParam add token break field set cmdObj listParam break case UUID final Long internalId translateUuidToInternalId paramObj toString annotation field set cmdObj internalId break case LONG field set cmdObj Long valueOf paramObj toString break case SHORT field set cmdObj Short valueOf paramObj toString break
static void addDir File dirObj ZipOutputStream out throws IOException File files dirObj listFiles byte tmpBuf new byte String pathToDir s_dirName for int i i files length i if files i isDirectory addDir files i out continue try FileInputStream in new FileInputStream files i getPath out putNextEntry new ZipEntry files i getPath substring pathToDir length int len while len in read tmpBuf out write tmpBuf len out closeEntry catch IOException ex
else if name null sc addAnd SearchCriteria Op EQ name else if keyword null SearchCriteria DataCenterJoinVO ssc _dcJoinDao createSearchCriteria ssc addOr SearchCriteria Op LIKE keyword ssc addOr SearchCriteria Op LIKE keyword sc addAnd SearchCriteria Op SC ssc if domainId null sc addAnd SearchCriteria Op EQ domainId if _accountMgr isNormalUser account getId SearchCriteria DataCenterJoinVO sdc _dcJoinDao createSearchCriteria sdc addOr SearchCriteria Op EQ account getId sdc addOr SearchCriteria Op NULL sc addAnd SearchCriteria Op SC sdc
if domainRecord null s_logger error account getAccountName throw new CloudAuthenticationException account getAccountName domainIds add domainRecord getId while domainRecord getParent null domainRecord _domainDao findById domainRecord getParent domainIds add domainRecord getId SearchCriteria DataCenterJoinVO sdc _dcJoinDao createSearchCriteria sdc addOr SearchCriteria Op IN domainIds toArray sdc addOr SearchCriteria Op NULL sc addAnd SearchCriteria Op SC sdc sc addAnd SearchCriteria Op NEQ Grouping AllocationState Disabled SearchCriteria DataCenterJoinVO sdc2 _dcJoinDao createSearchCriteria sdc2 addOr SearchCriteria Op EQ account getId sdc2 addOr SearchCriteria Op NULL
VMTemplateVO template null Filter searchFilter new Filter TemplateJoinVO class SortKeyAscending value startIndex pageSize searchFilter addOrderBy TemplateJoinVO class SortKeyAscending value SearchBuilder TemplateJoinVO sb _templateJoinDao createSearchBuilder if showUnique sb select null Func DISTINCT sb entity getId else sb select null Func DISTINCT sb entity getTempZonePair if ids null ids isEmpty sb and sb entity getId SearchCriteria Op IN SearchCriteria TemplateJoinVO sc sb create if templateId null template _templateDao findByIdIncludingRemoved templateId if template null throw new InvalidParameterValueException
if showUnique sb select null Func DISTINCT sb entity getId else sb select null Func DISTINCT sb entity getTempZonePair if ids null ids isEmpty sb and sb entity getId SearchCriteria Op IN SearchCriteria TemplateJoinVO sc sb create if templateId null template _templateDao findByIdIncludingRemoved templateId if template null throw new InvalidParameterValueException if isIso template getFormat ImageFormat ISO s_logger error templateId InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject template getUuid
Override public List RouterHealthCheckResultResponse listRouterHealthChecks GetRouterHealthCheckResultsCmd cmd
CapacityVO capacityCpu _capacityDao lockRow capacityCpuId true CapacityVO capacityMemory _capacityDao lockRow capacityMemoryId true CapacityVO capacityCpuCore _capacityDao lockRow capacityCpuCoreId true long usedCpu capacityCpu getUsedCapacity long usedMem capacityMemory getUsedCapacity long usedCpuCore capacityCpuCore getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMemory getReservedCapacity long reservedCpuCore capacityCpuCore getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity float cpuOvercommitRatio Float parseFloat _clusterDetailsDao findDetail clusterIdFinal getValue float memoryOvercommitRatio Float parseFloat _clusterDetailsDao findDetail clusterIdFinal getValue int vmCPU svo getCpu svo getSpeed int vmCPUCore svo getCpu long vmMem svo getRamSize 1024L 1024L
CapacityVO capacityMemory _capacityDao lockRow capacityMemoryId true CapacityVO capacityCpuCore _capacityDao lockRow capacityCpuCoreId true long usedCpu capacityCpu getUsedCapacity long usedMem capacityMemory getUsedCapacity long usedCpuCore capacityCpuCore getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMemory getReservedCapacity long reservedCpuCore capacityCpuCore getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity float cpuOvercommitRatio Float parseFloat _clusterDetailsDao findDetail clusterIdFinal getValue float memoryOvercommitRatio Float parseFloat _clusterDetailsDao findDetail clusterIdFinal getValue int vmCPU svo getCpu svo getSpeed int vmCPUCore svo getCpu long vmMem svo getRamSize 1024L 1024L long actualTotalMem capacityMemory getTotalCapacity
if usedCpu vmCPU capacityCpu setUsedCapacity usedCpu vmCPU if usedMem vmMem capacityMemory setUsedCapacity usedMem vmMem if usedCpuCore vmCPUCore capacityCpuCore setUsedCapacity usedCpuCore vmCPUCore if moveToReservered if reservedCpu vmCPU totalCpu capacityCpu setReservedCapacity reservedCpu vmCPU if reservedMem vmMem totalMem capacityMemory setReservedCapacity reservedMem vmMem capacityCpuCore setReservedCapacity reservedCpuCore vmCPUCore else if reservedCpu vmCPU capacityCpu setReservedCapacity reservedCpu vmCPU
if usedCpu vmCPU capacityCpu setUsedCapacity usedCpu vmCPU if usedMem vmMem capacityMemory setUsedCapacity usedMem vmMem if usedCpuCore vmCPUCore capacityCpuCore setUsedCapacity usedCpuCore vmCPUCore if moveToReservered if reservedCpu vmCPU totalCpu capacityCpu setReservedCapacity reservedCpu vmCPU if reservedMem vmMem totalMem capacityMemory setReservedCapacity reservedMem vmMem capacityCpuCore setReservedCapacity reservedCpuCore vmCPUCore else if reservedCpu vmCPU capacityCpu setReservedCapacity reservedCpu vmCPU
Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status CapacityVO capacityCpu _capacityDao lockRow capacityCpuId true CapacityVO capacityMem _capacityDao lockRow capacityMemId true CapacityVO capacityCpuCore _capacityDao lockRow capacityCpuCoreId true long usedCpu capacityCpu getUsedCapacity long usedMem capacityMem getUsedCapacity long usedCpuCore capacityCpuCore getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMem getReservedCapacity long reservedCpuCore capacityCpuCore getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity long actualTotalMem capacityMem getTotalCapacity long totalCpu long actualTotalCpu cpuOvercommitRatio long totalMem long actualTotalMem memoryOvercommitRatio
long usedCpu capacityCpu getUsedCapacity long usedMem capacityMem getUsedCapacity long usedCpuCore capacityCpuCore getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMem getReservedCapacity long reservedCpuCore capacityCpuCore getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity long actualTotalMem capacityMem getTotalCapacity long totalCpu long actualTotalCpu cpuOvercommitRatio long totalMem long actualTotalMem memoryOvercommitRatio if s_logger isDebugEnabled s_logger debug actualTotalCpu totalCpu long freeCpu totalCpu reservedCpu usedCpu long freeMem totalMem reservedMem usedMem if s_logger isDebugEnabled
long usedMem capacityMem getUsedCapacity long usedCpuCore capacityCpuCore getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMem getReservedCapacity long reservedCpuCore capacityCpuCore getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity long actualTotalMem capacityMem getTotalCapacity long totalCpu long actualTotalCpu cpuOvercommitRatio long totalMem long actualTotalMem memoryOvercommitRatio if s_logger isDebugEnabled s_logger debug actualTotalCpu totalCpu long freeCpu totalCpu reservedCpu usedCpu long freeMem totalMem reservedMem usedMem if s_logger isDebugEnabled s_logger debug hostId
long totalCpu long actualTotalCpu cpuOvercommitRatio long totalMem long actualTotalMem memoryOvercommitRatio if s_logger isDebugEnabled s_logger debug actualTotalCpu totalCpu long freeCpu totalCpu reservedCpu usedCpu long freeMem totalMem reservedMem usedMem if s_logger isDebugEnabled s_logger debug hostId s_logger debug usedCpu freeCpu cpu s_logger debug toHumanReadableSize usedMem toHumanReadableSize freeMem toHumanReadableSize ram capacityCpu setUsedCapacity usedCpu cpu capacityMem setUsedCapacity usedMem ram capacityCpuCore setUsedCapacity usedCpuCore cpucore if fromLastHost if s_logger isDebugEnabled
long totalMem long actualTotalMem memoryOvercommitRatio if s_logger isDebugEnabled s_logger debug actualTotalCpu totalCpu long freeCpu totalCpu reservedCpu usedCpu long freeMem totalMem reservedMem usedMem if s_logger isDebugEnabled s_logger debug hostId s_logger debug usedCpu freeCpu cpu s_logger debug toHumanReadableSize usedMem toHumanReadableSize freeMem toHumanReadableSize ram capacityCpu setUsedCapacity usedCpu cpu capacityMem setUsedCapacity usedMem ram capacityCpuCore setUsedCapacity usedCpuCore cpucore if fromLastHost if s_logger isDebugEnabled s_logger debug
capacityCpu setUsedCapacity usedCpu cpu capacityMem setUsedCapacity usedMem ram capacityCpuCore setUsedCapacity usedCpuCore cpucore if fromLastHost if s_logger isDebugEnabled s_logger debug s_logger debug reservedCpu cpu s_logger debug toHumanReadableSize reservedMem toHumanReadableSize ram if reservedCpu cpu reservedMem ram capacityCpu setReservedCapacity reservedCpu cpu capacityMem setReservedCapacity reservedMem ram capacityCpuCore setReservedCapacity reservedCpuCore cpucore else if reservedCpu usedCpu cpu totalCpu reservedMem usedMem ram totalMem if s_logger isDebugEnabled
capacityCpu setUsedCapacity usedCpu cpu capacityMem setUsedCapacity usedMem ram capacityCpuCore setUsedCapacity usedCpuCore cpucore if fromLastHost if s_logger isDebugEnabled s_logger debug s_logger debug reservedCpu cpu s_logger debug toHumanReadableSize reservedMem toHumanReadableSize ram if reservedCpu cpu reservedMem ram capacityCpu setReservedCapacity reservedCpu cpu capacityMem setReservedCapacity reservedMem ram capacityCpuCore setReservedCapacity reservedCpuCore cpucore else if reservedCpu usedCpu cpu totalCpu reservedMem usedMem ram totalMem if s_logger isDebugEnabled
Override public boolean checkIfHostHasCpuCapability long hostId Integer cpuNum Integer cpuSpeed Host host _hostDao findById hostId boolean isCpuNumGood host getCpus intValue cpuNum boolean isCpuSpeedGood host getSpeed intValue cpuSpeed if isCpuNumGood isCpuSpeedGood if s_logger isDebugEnabled
Override public boolean checkIfHostHasCapacity long hostId Integer cpu long ram boolean checkFromReservedCapacity float cpuOvercommitRatio float memoryOvercommitRatio boolean considerReservedCapacity boolean hasCapacity false if s_logger isDebugEnabled
if capacityCpu null if s_logger isDebugEnabled s_logger debug hostId if capacityMem null if s_logger isDebugEnabled s_logger debug hostId return false long usedCpu capacityCpu getUsedCapacity long usedMem capacityMem getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMem getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity long actualTotalMem capacityMem getTotalCapacity long totalCpu long actualTotalCpu cpuOvercommitRatio long totalMem long actualTotalMem memoryOvercommitRatio
s_logger debug hostId return false long usedCpu capacityCpu getUsedCapacity long usedMem capacityMem getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMem getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity long actualTotalMem capacityMem getTotalCapacity long totalCpu long actualTotalCpu cpuOvercommitRatio long totalMem long actualTotalMem memoryOvercommitRatio if s_logger isDebugEnabled s_logger debug actualTotalCpu totalCpu String failureReason if checkFromReservedCapacity long freeCpu reservedCpu
return false long usedCpu capacityCpu getUsedCapacity long usedMem capacityMem getUsedCapacity long reservedCpu capacityCpu getReservedCapacity long reservedMem capacityMem getReservedCapacity long actualTotalCpu capacityCpu getTotalCapacity long actualTotalMem capacityMem getTotalCapacity long totalCpu long actualTotalCpu cpuOvercommitRatio long totalMem long actualTotalMem memoryOvercommitRatio if s_logger isDebugEnabled s_logger debug actualTotalCpu totalCpu String failureReason if checkFromReservedCapacity long freeCpu reservedCpu long freeMem reservedMem
if s_logger isDebugEnabled s_logger debug s_logger debug freeCpu cpu s_logger debug toHumanReadableSize freeMem toHumanReadableSize ram if reservedCpu cpu if reservedMem ram hasCapacity true else failureReason else failureReason else long reservedCpuValueToUse reservedCpu long reservedMemValueToUse reservedMem if considerReservedCapacity
s_logger debug s_logger debug freeCpu cpu s_logger debug toHumanReadableSize freeMem toHumanReadableSize ram if reservedCpu cpu if reservedMem ram hasCapacity true else failureReason else failureReason else long reservedCpuValueToUse reservedCpu long reservedMemValueToUse reservedMem if considerReservedCapacity if s_logger isDebugEnabled
else failureReason else long reservedCpuValueToUse reservedCpu long reservedMemValueToUse reservedMem if considerReservedCapacity if s_logger isDebugEnabled s_logger debug considerReservedCapacity reservedCpuValueToUse reservedMemValueToUse long freeCpu totalCpu reservedCpuValueToUse usedCpu long freeMem totalMem reservedMemValueToUse usedMem if s_logger isDebugEnabled s_logger debug freeCpu cpu s_logger debug toHumanReadableSize freeMem toHumanReadableSize ram
else failureReason else long reservedCpuValueToUse reservedCpu long reservedMemValueToUse reservedMem if considerReservedCapacity if s_logger isDebugEnabled s_logger debug considerReservedCapacity reservedCpuValueToUse reservedMemValueToUse long freeCpu totalCpu reservedCpuValueToUse usedCpu long freeMem totalMem reservedMemValueToUse usedMem if s_logger isDebugEnabled s_logger debug freeCpu cpu s_logger debug toHumanReadableSize freeMem toHumanReadableSize ram
else long reservedCpuValueToUse reservedCpu long reservedMemValueToUse reservedMem if considerReservedCapacity if s_logger isDebugEnabled s_logger debug considerReservedCapacity reservedCpuValueToUse reservedMemValueToUse long freeCpu totalCpu reservedCpuValueToUse usedCpu long freeMem totalMem reservedMemValueToUse usedMem if s_logger isDebugEnabled s_logger debug freeCpu cpu s_logger debug toHumanReadableSize freeMem toHumanReadableSize ram if reservedCpuValueToUse usedCpu cpu totalCpu if reservedMemValueToUse usedMem ram totalMem
long reservedCpuValueToUse reservedCpu long reservedMemValueToUse reservedMem if considerReservedCapacity if s_logger isDebugEnabled s_logger debug considerReservedCapacity reservedCpuValueToUse reservedMemValueToUse long freeCpu totalCpu reservedCpuValueToUse usedCpu long freeMem totalMem reservedMemValueToUse usedMem if s_logger isDebugEnabled s_logger debug freeCpu cpu s_logger debug toHumanReadableSize freeMem toHumanReadableSize ram if reservedCpuValueToUse usedCpu cpu totalCpu if reservedMemValueToUse usedMem ram totalMem hasCapacity true
if considerReservedCapacity if s_logger isDebugEnabled s_logger debug considerReservedCapacity reservedCpuValueToUse reservedMemValueToUse long freeCpu totalCpu reservedCpuValueToUse usedCpu long freeMem totalMem reservedMemValueToUse usedMem if s_logger isDebugEnabled s_logger debug freeCpu cpu s_logger debug toHumanReadableSize freeMem toHumanReadableSize ram if reservedCpuValueToUse usedCpu cpu totalCpu if reservedMemValueToUse usedMem ram totalMem hasCapacity true else failureReason
Map Long ServiceOfferingVO offeringsMap new HashMap Long ServiceOfferingVO for ServiceOfferingVO offering offerings offeringsMap put offering getId offering long usedCpuCore long reservedCpuCore long usedCpu long usedMemory long reservedMemory long reservedCpu final CapacityState capacityState host getResourceState ResourceState Enabled CapacityState Enabled CapacityState Disabled List VMInstanceVO vms _vmDao listUpByHostId host getId if s_logger isDebugEnabled s_logger debug vms size host getId final List VMInstanceVO vosMigrating _vmDao listVmsMigratingFromHost host getId if s_logger isDebugEnabled
reservedCpu Integer parseInt vmDetails get UsageEventVO DynamicParameters cpuNumber name so getSpeed cpuOvercommitRatio clusterCpuOvercommitRatio reservedCpuCore Integer parseInt vmDetails get UsageEventVO DynamicParameters cpuNumber name else reservedMemory so getRamSize 1024L 1024L ramOvercommitRatio clusterRamOvercommitRatio reservedCpu so getCpu so getSpeed cpuOvercommitRatio clusterCpuOvercommitRatio reservedCpuCore so getCpu else UserVmDetailVO messageSentFlag _userVmDetailsDao findDetail vm getId VmDetailConstants MESSAGE_RESERVED_CAPACITY_FREED_FLAG if messageSentFlag null Boolean valueOf messageSentFlag getValue _messageBus publish _name PublishScope LOCAL vm if vm getType VirtualMachine Type User UserVmVO userVM _userVMDao findById vm getId _userVMDao loadDetails userVM userVM setDetail VmDetailConstants MESSAGE_RESERVED_CAPACITY_FREED_FLAG _userVMDao saveDetails userVM
else reservedMemory so getRamSize 1024L 1024L ramOvercommitRatio clusterRamOvercommitRatio reservedCpu so getCpu so getSpeed cpuOvercommitRatio clusterCpuOvercommitRatio reservedCpuCore so getCpu else UserVmDetailVO messageSentFlag _userVmDetailsDao findDetail vm getId VmDetailConstants MESSAGE_RESERVED_CAPACITY_FREED_FLAG if messageSentFlag null Boolean valueOf messageSentFlag getValue _messageBus publish _name PublishScope LOCAL vm if vm getType VirtualMachine Type User UserVmVO userVM _userVMDao findById vm getId _userVMDao loadDetails userVM userVM setDetail VmDetailConstants MESSAGE_RESERVED_CAPACITY_FREED_FLAG _userVMDao saveDetails userVM CapacityVO cpuCap _capacityDao findByHostIdType host getId Capacity CAPACITY_TYPE_CPU CapacityVO memCap _capacityDao findByHostIdType host getId Capacity CAPACITY_TYPE_MEMORY
else UserVmDetailVO messageSentFlag _userVmDetailsDao findDetail vm getId VmDetailConstants MESSAGE_RESERVED_CAPACITY_FREED_FLAG if messageSentFlag null Boolean valueOf messageSentFlag getValue _messageBus publish _name PublishScope LOCAL vm if vm getType VirtualMachine Type User UserVmVO userVM _userVMDao findById vm getId _userVMDao loadDetails userVM userVM setDetail VmDetailConstants MESSAGE_RESERVED_CAPACITY_FREED_FLAG _userVMDao saveDetails userVM CapacityVO cpuCap _capacityDao findByHostIdType host getId Capacity CAPACITY_TYPE_CPU CapacityVO memCap _capacityDao findByHostIdType host getId Capacity CAPACITY_TYPE_MEMORY CapacityVO cpuCoreCap _capacityDao findByHostIdType host getId CapacityVO CAPACITY_TYPE_CPU_CORE if cpuCoreCap null long hostTotalCpuCore host getCpus longValue if cpuCoreCap getTotalCapacity hostTotalCpuCore
CapacityVO memCap _capacityDao findByHostIdType host getId Capacity CAPACITY_TYPE_MEMORY CapacityVO cpuCoreCap _capacityDao findByHostIdType host getId CapacityVO CAPACITY_TYPE_CPU_CORE if cpuCoreCap null long hostTotalCpuCore host getCpus longValue if cpuCoreCap getTotalCapacity hostTotalCpuCore s_logger debug host getId cpuCoreCap getTotalCapacity hostTotalCpuCore cpuCoreCap setTotalCapacity hostTotalCpuCore if cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap getReservedCapacity reservedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity cpuCoreCap getReservedCapacity else if cpuCoreCap getReservedCapacity reservedCpuCore s_logger debug host getId cpuCoreCap getReservedCapacity reservedCpuCore cpuCoreCap setReservedCapacity reservedCpuCore if cpuCoreCap getUsedCapacity usedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity usedCpuCore
long hostTotalCpuCore host getCpus longValue if cpuCoreCap getTotalCapacity hostTotalCpuCore s_logger debug host getId cpuCoreCap getTotalCapacity hostTotalCpuCore cpuCoreCap setTotalCapacity hostTotalCpuCore if cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap getReservedCapacity reservedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity cpuCoreCap getReservedCapacity else if cpuCoreCap getReservedCapacity reservedCpuCore s_logger debug host getId cpuCoreCap getReservedCapacity reservedCpuCore cpuCoreCap setReservedCapacity reservedCpuCore if cpuCoreCap getUsedCapacity usedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap setUsedCapacity usedCpuCore try _capacityDao update cpuCoreCap getId cpuCoreCap
if cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap getReservedCapacity reservedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity cpuCoreCap getReservedCapacity else if cpuCoreCap getReservedCapacity reservedCpuCore s_logger debug host getId cpuCoreCap getReservedCapacity reservedCpuCore cpuCoreCap setReservedCapacity reservedCpuCore if cpuCoreCap getUsedCapacity usedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap setUsedCapacity usedCpuCore try _capacityDao update cpuCoreCap getId cpuCoreCap catch Exception e s_logger error host getId e else final long usedCpuCoreFinal usedCpuCore
else if cpuCoreCap getReservedCapacity reservedCpuCore s_logger debug host getId cpuCoreCap getReservedCapacity reservedCpuCore cpuCoreCap setReservedCapacity reservedCpuCore if cpuCoreCap getUsedCapacity usedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap setUsedCapacity usedCpuCore try _capacityDao update cpuCoreCap getId cpuCoreCap catch Exception e s_logger error host getId e else final long usedCpuCoreFinal usedCpuCore final long reservedCpuCoreFinal reservedCpuCore Transaction execute new TransactionCallbackNoReturn
s_logger debug host getId cpuCoreCap getReservedCapacity reservedCpuCore cpuCoreCap setReservedCapacity reservedCpuCore if cpuCoreCap getUsedCapacity usedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap setUsedCapacity usedCpuCore try _capacityDao update cpuCoreCap getId cpuCoreCap catch Exception e s_logger error host getId e else final long usedCpuCoreFinal usedCpuCore final long reservedCpuCoreFinal reservedCpuCore Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status CapacityVO capacity new CapacityVO host getId host getDataCenterId host getPodId host getClusterId usedCpuCoreFinal host getCpus longValue CapacityVO CAPACITY_TYPE_CPU_CORE
if cpuCoreCap getUsedCapacity usedCpuCore s_logger debug host getId cpuCoreCap getUsedCapacity usedCpuCore cpuCoreCap setUsedCapacity usedCpuCore try _capacityDao update cpuCoreCap getId cpuCoreCap catch Exception e s_logger error host getId e else final long usedCpuCoreFinal usedCpuCore final long reservedCpuCoreFinal reservedCpuCore Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status CapacityVO capacity new CapacityVO host getId host getDataCenterId host getPodId host getClusterId usedCpuCoreFinal host getCpus longValue CapacityVO CAPACITY_TYPE_CPU_CORE capacity setReservedCapacity reservedCpuCoreFinal capacity setCapacityState capacityState
try _capacityDao update cpuCoreCap getId cpuCoreCap catch Exception e s_logger error host getId e else final long usedCpuCoreFinal usedCpuCore final long reservedCpuCoreFinal reservedCpuCore Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status CapacityVO capacity new CapacityVO host getId host getDataCenterId host getPodId host getClusterId usedCpuCoreFinal host getCpus longValue CapacityVO CAPACITY_TYPE_CPU_CORE capacity setReservedCapacity reservedCpuCoreFinal capacity setCapacityState capacityState _capacityDao persist capacity if cpuCap null memCap null
_capacityDao update cpuCoreCap getId cpuCoreCap catch Exception e s_logger error host getId e else final long usedCpuCoreFinal usedCpuCore final long reservedCpuCoreFinal reservedCpuCore Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status CapacityVO capacity new CapacityVO host getId host getDataCenterId host getPodId host getClusterId usedCpuCoreFinal host getCpus longValue CapacityVO CAPACITY_TYPE_CPU_CORE capacity setReservedCapacity reservedCpuCoreFinal capacity setCapacityState capacityState _capacityDao persist capacity if cpuCap null memCap null if host getTotalMemory null
s_logger error host getId e else final long usedCpuCoreFinal usedCpuCore final long reservedCpuCoreFinal reservedCpuCore Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status CapacityVO capacity new CapacityVO host getId host getDataCenterId host getPodId host getClusterId usedCpuCoreFinal host getCpus longValue CapacityVO CAPACITY_TYPE_CPU_CORE capacity setReservedCapacity reservedCpuCoreFinal capacity setCapacityState capacityState _capacityDao persist capacity if cpuCap null memCap null if host getTotalMemory null memCap setTotalCapacity host getTotalMemory long hostTotalCpu host getCpus longValue host getSpeed longValue
else final long usedCpuCoreFinal usedCpuCore final long reservedCpuCoreFinal reservedCpuCore Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status CapacityVO capacity new CapacityVO host getId host getDataCenterId host getPodId host getClusterId usedCpuCoreFinal host getCpus longValue CapacityVO CAPACITY_TYPE_CPU_CORE capacity setReservedCapacity reservedCpuCoreFinal capacity setCapacityState capacityState _capacityDao persist capacity if cpuCap null memCap null if host getTotalMemory null memCap setTotalCapacity host getTotalMemory long hostTotalCpu host getCpus longValue host getSpeed longValue if cpuCap getTotalCapacity hostTotalCpu
capacity setReservedCapacity reservedCpuCoreFinal capacity setCapacityState capacityState _capacityDao persist capacity if cpuCap null memCap null if host getTotalMemory null memCap setTotalCapacity host getTotalMemory long hostTotalCpu host getCpus longValue host getSpeed longValue if cpuCap getTotalCapacity hostTotalCpu s_logger debug host getId cpuCap getTotalCapacity hostTotalCpu cpuCap setTotalCapacity hostTotalCpu if capacityState cpuCap getCapacityState s_logger debug host getId cpuCap getTotalCapacity hostTotalCpu cpuCap setCapacityState capacityState memCap setCapacityState capacityState
capacityCPU addAnd SearchCriteria Op EQ server getDataCenterId capacityCPU addAnd SearchCriteria Op EQ server getPodId capacityCPU addAnd SearchCriteria Op EQ Capacity CAPACITY_TYPE_CPU List CapacityVO capacityVOCpus _capacityDao search capacitySC null Float cpuovercommitratio Float parseFloat _clusterDetailsDao findDetail server getClusterId getValue Float memoryOvercommitRatio Float parseFloat _clusterDetailsDao findDetail server getClusterId getValue if capacityVOCpus null capacityVOCpus isEmpty CapacityVO CapacityVOCpu capacityVOCpus get long newTotalCpu long server getCpus longValue server getSpeed longValue cpuovercommitratio if CapacityVOCpu getTotalCapacity newTotalCpu CapacityVOCpu getUsedCapacity CapacityVOCpu getReservedCapacity newTotalCpu CapacityVOCpu setTotalCapacity newTotalCpu else if CapacityVOCpu getUsedCapacity CapacityVOCpu getReservedCapacity newTotalCpu CapacityVOCpu getUsedCapacity newTotalCpu CapacityVOCpu setReservedCapacity CapacityVOCpu setTotalCapacity newTotalCpu else
else CapacityVO capacity new CapacityVO server getId server getDataCenterId server getPodId server getClusterId 0L server getCpus longValue server getSpeed longValue Capacity CAPACITY_TYPE_CPU _capacityDao persist capacity SearchCriteria CapacityVO capacityMem _capacityDao createSearchCriteria capacityMem addAnd SearchCriteria Op EQ server getId capacityMem addAnd SearchCriteria Op EQ server getDataCenterId capacityMem addAnd SearchCriteria Op EQ server getPodId capacityMem addAnd SearchCriteria Op EQ Capacity CAPACITY_TYPE_MEMORY List CapacityVO capacityVOMems _capacityDao search capacityMem null if capacityVOMems null capacityVOMems isEmpty CapacityVO CapacityVOMem capacityVOMems get long newTotalMem long server getTotalMemory memoryOvercommitRatio if CapacityVOMem getTotalCapacity newTotalMem CapacityVOMem getUsedCapacity CapacityVOMem getReservedCapacity newTotalMem CapacityVOMem setTotalCapacity newTotalMem else if CapacityVOMem getUsedCapacity CapacityVOMem getReservedCapacity newTotalMem CapacityVOMem getUsedCapacity newTotalMem
Override public boolean checkIfClusterCrossesThreshold Long clusterId Integer cpuRequested long ramRequested Float clusterCpuOverProvisioning getClusterOverProvisioningFactor clusterId Capacity CAPACITY_TYPE_CPU Float clusterMemoryOverProvisioning getClusterOverProvisioningFactor clusterId Capacity CAPACITY_TYPE_MEMORY Float clusterCpuCapacityDisableThreshold DeploymentClusterPlanner ClusterCPUCapacityDisableThreshold valueIn clusterId Float clusterMemoryCapacityDisableThreshold DeploymentClusterPlanner ClusterMemoryCapacityDisableThreshold valueIn clusterId float cpuConsumption _capacityDao findClusterConsumption clusterId Capacity CAPACITY_TYPE_CPU cpuRequested if cpuConsumption clusterCpuOverProvisioning clusterCpuCapacityDisableThreshold
Override public boolean checkIfHostReachMaxGuestLimit Host host Long vmCount _vmDao countActiveByHostId host getId HypervisorType hypervisorType host getHypervisorType String hypervisorVersion host getHypervisorVersion Long maxGuestLimit _hypervisorCapabilitiesDao getMaxGuestsLimit hypervisorType hypervisorVersion if vmCount longValue maxGuestLimit longValue
Override DB public String updateConfiguration final long userId final String name final String category final String value final String scope final Long resourceId final String validationMsg validateConfigurationValue name value scope if validationMsg null
else accountDetailVO setValue value _accountDetailsDao update accountDetailVO getId accountDetailVO break case ImageStore final ImageStoreVO imgStore _imageStoreDao findById resourceId Preconditions checkState imgStore null _imageStoreDetailsDao addDetail resourceId name value true break case Domain final DomainVO domain _domainDao findById resourceId if domain null throw new InvalidParameterValueException resourceId DomainDetailVO domainDetailVO _domainDetailsDao findDetail resourceId name if domainDetailVO null domainDetailVO new DomainDetailVO resourceId name value _domainDetailsDao persist domainDetailVO
private String validateConfigurationValue final String name String value final String scope final ConfigurationVO cfg _configDao findByName name if cfg null
if configKey null s_logger warn name return null type configKey type else type c getType String errMsg null try if type equals Integer class errMsg value name Integer parseInt value else if type equals Float class errMsg value name Float parseFloat value else if type equals Long class
else if type equals Float class errMsg value name Float parseFloat value else if type equals Long class errMsg value name Long parseLong value catch final Exception e s_logger error errMsg return errMsg if value null if type equals Boolean class return if overprovisioningFactorsForValidation contains name final String msg name s_logger error msg
else if type equals Long class errMsg value name Long parseLong value catch final Exception e s_logger error errMsg return errMsg if value null if type equals Boolean class return if overprovisioningFactorsForValidation contains name final String msg name s_logger error msg return msg return null value value trim
catch final Exception e s_logger error errMsg return errMsg if value null if type equals Boolean class return if overprovisioningFactorsForValidation contains name final String msg name s_logger error msg return msg return null value value trim try if overprovisioningFactorsForValidation contains name Float parseFloat value 1f final String msg name
if overprovisioningFactorsForValidation contains name final String msg name s_logger error msg return msg return null value value trim try if overprovisioningFactorsForValidation contains name Float parseFloat value 1f final String msg name s_logger error msg throw new InvalidParameterValueException msg catch final NumberFormatException e final String msg name s_logger error msg throw new InvalidParameterValueException msg
catch final NumberFormatException e final String msg name s_logger error msg throw new InvalidParameterValueException msg if type equals Boolean class if value equals value equals s_logger error name value return return null if type equals Integer class NetworkModel MACIdentifier key equalsIgnoreCase name try final int val Integer parseInt value if val val throw new InvalidParameterValueException name catch final NumberFormatException e
s_logger error name value return return null if type equals Integer class NetworkModel MACIdentifier key equalsIgnoreCase name try final int val Integer parseInt value if val val throw new InvalidParameterValueException name catch final NumberFormatException e s_logger error name throw new InvalidParameterValueException name if type equals Integer class configValuesForValidation contains name try final int val Integer parseInt value if val
catch final NumberFormatException e s_logger error name throw new InvalidParameterValueException name if type equals Integer class configValuesForValidation contains name try final int val Integer parseInt value if val throw new InvalidParameterValueException name if equalsIgnoreCase name val throw new InvalidParameterValueException name if equalsIgnoreCase name if val throw new InvalidParameterValueException name if val throw new InvalidParameterValueException name
throw new InvalidParameterValueException name if type equals Integer class configValuesForValidation contains name try final int val Integer parseInt value if val throw new InvalidParameterValueException name if equalsIgnoreCase name val throw new InvalidParameterValueException name if equalsIgnoreCase name if val throw new InvalidParameterValueException name if val throw new InvalidParameterValueException name catch final NumberFormatException e s_logger error name
try final int val Integer parseInt value if val throw new InvalidParameterValueException name if equalsIgnoreCase name val throw new InvalidParameterValueException name if equalsIgnoreCase name if val throw new InvalidParameterValueException name if val throw new InvalidParameterValueException name catch final NumberFormatException e s_logger error name throw new InvalidParameterValueException name if type equals Float class
throw new InvalidParameterValueException name if c null return null final String range c getRange if range null return null if type equals String class if range equals try if NetUtils isSiteLocalAddress value s_logger error value name return catch final NullPointerException e s_logger error name throw new InvalidParameterValueException
if range equals try if NetUtils isSiteLocalAddress value s_logger error value name return catch final NullPointerException e s_logger error name throw new InvalidParameterValueException else if range equals if NetUtils isValidIp4Netmask value s_logger error value name return else if range equals final String hypervisors value split if hypervisors null
if foundRange throw new InvalidParameterValueException startIp endIp podId final StringBuilder newPodIpRange new StringBuilder boolean first true for String podIpRange newPodIpRanges if first first false else newPodIpRange append newPodIpRange append podIpRange try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status pod setDescription newPodIpRange toString HostPodVO lock null try lock _podDao acquireInLockTable podId
private VlanVO commitVlanAndIpRange final long zoneId final long networkId final long physicalNetworkId final Long podId final String startIP final String endIP final String vlanGateway final String vlanNetmask final String vlanId final Domain domain final Account vlanOwner final String vlanIp6Gateway final String vlanIp6Cidr final boolean ipv4 final DataCenterVO zone final VlanType vlanType final String ipv6Range final String ipRange final boolean forSystemVms return Transaction execute new TransactionCallback VlanVO Override public VlanVO doInTransaction final TransactionStatus status VlanVO vlan new VlanVO vlanType vlanId vlanGateway vlanNetmask zone getId ipRange networkId physicalNetworkId vlanIp6Gateway vlanIp6Cidr ipv6Range
boolean isAccountSpecific false final List AccountVlanMapVO acctVln _accountVlanMapDao listAccountVlanMapsByVlan vlanRange getId if acctVln null acctVln isEmpty isAccountSpecific true boolean isDomainSpecific false List DomainVlanMapVO domainVlan _domainVlanMapDao listDomainVlanMapsByVlan vlanRange getId if domainVlan null domainVlan isEmpty isDomainSpecific true final List IPAddressVO ips _publicIpAddressDao listByVlanId vlanDbId if isAccountSpecific int resourceCountToBeDecrement try vlanRange _vlanDao acquireInLockTable vlanDbId if vlanRange null throw new CloudRuntimeException vlanDbId
throw new InvalidParameterValueException vlanDbId ip if ip getAllocatedTime null success _ipAddrMgr disassociatePublicIpAddress ip getId userId caller if success s_logger warn vlanDbId else resourceCountToBeDecrement UsageEventUtils publishUsageEvent EventTypes EVENT_NET_IP_RELEASE acctVln get getAccountId ip getDataCenterId ip getId ip getAddress toString ip isSourceNat vlanRange getVlanType toString ip getSystem ip getClass getName ip getUuid finally _vlanDao releaseFromLockTable vlanDbId if resourceCountToBeDecrement _resourceLimitMgr decrementResourceCount acctVln get getAccountId ResourceType public_ip new Long resourceCountToBeDecrement else final NicIpAliasVO ipAlias _nicIpAliasDao findByGatewayAndNetworkIdAndState vlanRange getVlanGateway vlanRange getNetworkId NicIpAlias State active if ipAlias null vlanDbId _publicIpAddressDao findByIpAndSourceNetworkId vlanRange getNetworkId ipAlias getIp4Address getVlanId
if ip getAllocatedTime null success _ipAddrMgr disassociatePublicIpAddress ip getId userId caller if success s_logger warn vlanDbId else resourceCountToBeDecrement UsageEventUtils publishUsageEvent EventTypes EVENT_NET_IP_RELEASE acctVln get getAccountId ip getDataCenterId ip getId ip getAddress toString ip isSourceNat vlanRange getVlanType toString ip getSystem ip getClass getName ip getUuid finally _vlanDao releaseFromLockTable vlanDbId if resourceCountToBeDecrement _resourceLimitMgr decrementResourceCount acctVln get getAccountId ResourceType public_ip new Long resourceCountToBeDecrement else final NicIpAliasVO ipAlias _nicIpAliasDao findByGatewayAndNetworkIdAndState vlanRange getVlanGateway vlanRange getNetworkId NicIpAlias State active if ipAlias null vlanDbId _publicIpAddressDao findByIpAndSourceNetworkId vlanRange getNetworkId ipAlias getIp4Address getVlanId throw new InvalidParameterValueException vlanDbId ipAlias getIp4Address
else resourceCountToBeDecrement UsageEventUtils publishUsageEvent EventTypes EVENT_NET_IP_RELEASE acctVln get getAccountId ip getDataCenterId ip getId ip getAddress toString ip isSourceNat vlanRange getVlanType toString ip getSystem ip getClass getName ip getUuid finally _vlanDao releaseFromLockTable vlanDbId if resourceCountToBeDecrement _resourceLimitMgr decrementResourceCount acctVln get getAccountId ResourceType public_ip new Long resourceCountToBeDecrement else final NicIpAliasVO ipAlias _nicIpAliasDao findByGatewayAndNetworkIdAndState vlanRange getVlanGateway vlanRange getNetworkId NicIpAlias State active if ipAlias null vlanDbId _publicIpAddressDao findByIpAndSourceNetworkId vlanRange getNetworkId ipAlias getIp4Address getVlanId throw new InvalidParameterValueException vlanDbId ipAlias getIp4Address final long allocIpCount _publicIpAddressDao countIPs vlanRange getDataCenterId vlanDbId true if allocIpCount throw new InvalidParameterValueException allocIpCount Transaction execute new TransactionCallbackNoReturn
boolean isDomainSpecific false final List DomainVlanMapVO domainVlan _domainVlanMapDao listDomainVlanMapsByVlan vlanDbId if domainVlan null domainVlan isEmpty isDomainSpecific true if isAccountSpecific isDomainSpecific throw new InvalidParameterValueException vlanDbId final long allocIpCount _publicIpAddressDao countIPs vlan getDataCenterId vlanDbId true final List IPAddressVO ips _publicIpAddressDao listByVlanId vlanDbId boolean success true final List IPAddressVO ipsInUse new ArrayList IPAddressVO if allocIpCount try vlan _vlanDao acquireInLockTable vlanDbId if vlan null throw new CloudRuntimeException vlanDbId
isDomainSpecific true if isAccountSpecific isDomainSpecific throw new InvalidParameterValueException vlanDbId final long allocIpCount _publicIpAddressDao countIPs vlan getDataCenterId vlanDbId true final List IPAddressVO ips _publicIpAddressDao listByVlanId vlanDbId boolean success true final List IPAddressVO ipsInUse new ArrayList IPAddressVO if allocIpCount try vlan _vlanDao acquireInLockTable vlanDbId if vlan null throw new CloudRuntimeException vlanDbId if s_logger isDebugEnabled s_logger debug vlanDbId for final IPAddressVO ip ips
Override ActionEvent eventType EventTypes EVENT_ACCOUNT_MARK_DEFAULT_ZONE eventDescription async true public AccountVO markDefaultZone final String accountName final long domainId final long defaultZoneId final Account account _accountDao findEnabledAccount accountName domainId if account null
s_logger info Map String String configs _configDao getConfiguration params String value configs get if value null _consoleProxyUrlPort NumbersUtil parseInt value ConsoleProxyManager DEFAULT_PROXY_URL_PORT value configs get if value null _consoleProxyPort NumbersUtil parseInt value ConsoleProxyManager DEFAULT_PROXY_VNC_PORT value configs get if value null value equalsIgnoreCase _sslEnabled true _consoleProxyUrlDomain configs get _listener new ConsoleProxyListener new AgentBasedAgentHook _instanceDao _hostDao _configDao _ksMgr _agentMgr _keysMgr _agentMgr registerForHostEvents _listener true true false if s_logger isInfoEnabled
HostVO host findHost userVm if host null HostVO allocatedHost null List HostVO hosts _hostDao listAllIncludingRemoved for HostVO hv hosts if hv getType Host Type ConsoleProxy hv getPublicIpAddress equalsIgnoreCase host getPublicIpAddress allocatedHost hv break if allocatedHost null for HostVO hv hosts if hv getType Host Type ConsoleProxy hv getPodId equals host getPodId allocatedHost hv break if allocatedHost null if s_logger isDebugEnabled
HostVO allocatedHost null List HostVO hosts _hostDao listAllIncludingRemoved for HostVO hv hosts if hv getType Host Type ConsoleProxy hv getPublicIpAddress equalsIgnoreCase host getPublicIpAddress allocatedHost hv break if allocatedHost null for HostVO hv hosts if hv getType Host Type ConsoleProxy hv getPodId equals host getPodId allocatedHost hv break if allocatedHost null if s_logger isDebugEnabled s_logger debug host getName host getPodId userVmId return null
allocatedHost hv break if allocatedHost null for HostVO hv hosts if hv getType Host Type ConsoleProxy hv getPodId equals host getPodId allocatedHost hv break if allocatedHost null if s_logger isDebugEnabled s_logger debug host getName host getPodId userVmId return null if s_logger isDebugEnabled s_logger debug allocatedHost getName userVmId allocatedHost getPublicIpAddress String publicIp allocatedHost getPublicIpAddress if publicIp null
Override public AgentControlAnswer onConsoleAccessAuthentication ConsoleAccessAuthenticationCommand cmd Long vmId null String ticketInUrl cmd getTicket if ticketInUrl null
Long vmId null String ticketInUrl cmd getTicket if ticketInUrl null s_logger error cmd getVmId return new ConsoleAccessAuthenticationAnswer cmd false if s_logger isDebugEnabled s_logger debug cmd getHost cmd getPort cmd getVmId ticketInUrl if cmd isReauthenticating String ticket ConsoleProxyServlet genAccessTicket cmd getHost cmd getPort cmd getSid cmd getVmId if s_logger isDebugEnabled s_logger debug cmd getHost cmd getPort cmd getVmId ticket if ticket equals ticketInUrl Date now new Date String minuteEarlyTicket ConsoleProxyServlet genAccessTicket cmd getHost cmd getPort cmd getSid cmd getVmId new Date now getTime if s_logger isDebugEnabled
if ticketInUrl null s_logger error cmd getVmId return new ConsoleAccessAuthenticationAnswer cmd false if s_logger isDebugEnabled s_logger debug cmd getHost cmd getPort cmd getVmId ticketInUrl if cmd isReauthenticating String ticket ConsoleProxyServlet genAccessTicket cmd getHost cmd getPort cmd getSid cmd getVmId if s_logger isDebugEnabled s_logger debug cmd getHost cmd getPort cmd getVmId ticket if ticket equals ticketInUrl Date now new Date String minuteEarlyTicket ConsoleProxyServlet genAccessTicket cmd getHost cmd getPort cmd getSid cmd getVmId new Date now getTime if s_logger isDebugEnabled s_logger debug cmd getHost cmd getPort cmd getVmId minuteEarlyTicket if minuteEarlyTicket equals ticketInUrl
s_logger debug cmd getHost cmd getPort cmd getVmId ticket if ticket equals ticketInUrl Date now new Date String minuteEarlyTicket ConsoleProxyServlet genAccessTicket cmd getHost cmd getPort cmd getSid cmd getVmId new Date now getTime if s_logger isDebugEnabled s_logger debug cmd getHost cmd getPort cmd getVmId minuteEarlyTicket if minuteEarlyTicket equals ticketInUrl s_logger error cmd getVmId ticketInUrl ticket minuteEarlyTicket return new ConsoleAccessAuthenticationAnswer cmd false if cmd getVmId null cmd getVmId isEmpty if s_logger isDebugEnabled s_logger debug return new ConsoleAccessAuthenticationAnswer cmd false VirtualMachine vm _instanceDao findByUuid cmd getVmId if vm null
s_logger debug return new ConsoleAccessAuthenticationAnswer cmd false VirtualMachine vm _instanceDao findByUuid cmd getVmId if vm null vm _instanceDao findById Long parseLong cmd getVmId if vm null s_logger error cmd getVmId return new ConsoleAccessAuthenticationAnswer cmd false if vm getHostId null s_logger warn vmId return new ConsoleAccessAuthenticationAnswer cmd false HostVO host _hostDao findById vm getHostId if host null s_logger warn vmId return new ConsoleAccessAuthenticationAnswer cmd false
if vm null vm _instanceDao findById Long parseLong cmd getVmId if vm null s_logger error cmd getVmId return new ConsoleAccessAuthenticationAnswer cmd false if vm getHostId null s_logger warn vmId return new ConsoleAccessAuthenticationAnswer cmd false HostVO host _hostDao findById vm getHostId if host null s_logger warn vmId return new ConsoleAccessAuthenticationAnswer cmd false String sid cmd getSid if sid null sid equals vm getVncPassword s_logger warn sid
s_logger error cmd getVmId return new ConsoleAccessAuthenticationAnswer cmd false if vm getHostId null s_logger warn vmId return new ConsoleAccessAuthenticationAnswer cmd false HostVO host _hostDao findById vm getHostId if host null s_logger warn vmId return new ConsoleAccessAuthenticationAnswer cmd false String sid cmd getSid if sid null sid equals vm getVncPassword s_logger warn sid return new ConsoleAccessAuthenticationAnswer cmd false if cmd isReauthenticating ConsoleAccessAuthenticationAnswer authenticationAnswer new ConsoleAccessAuthenticationAnswer cmd true
if consoleProxyUrlDomain null consoleProxyUrlDomain isEmpty s_logger debug else ksBits _ksMgr getKeystoreBits ConsoleProxyManager CERTIFICATE_NAME ConsoleProxyManager CERTIFICATE_NAME storePassword cmd new StartConsoleProxyAgentHttpHandlerCommand ksBits storePassword cmd setEncryptorPassword getEncryptorPassword HostVO consoleProxyHost findConsoleProxyHost startupCmd assert consoleProxyHost null if consoleProxyHost null Answer answer _agentMgr send consoleProxyHost getId cmd if answer null answer getResult s_logger error else s_logger info catch NoSuchAlgorithmException e
else ksBits _ksMgr getKeystoreBits ConsoleProxyManager CERTIFICATE_NAME ConsoleProxyManager CERTIFICATE_NAME storePassword cmd new StartConsoleProxyAgentHttpHandlerCommand ksBits storePassword cmd setEncryptorPassword getEncryptorPassword HostVO consoleProxyHost findConsoleProxyHost startupCmd assert consoleProxyHost null if consoleProxyHost null Answer answer _agentMgr send consoleProxyHost getId cmd if answer null answer getResult s_logger error else s_logger info catch NoSuchAlgorithmException e s_logger error e catch AgentUnavailableException e
ksBits _ksMgr getKeystoreBits ConsoleProxyManager CERTIFICATE_NAME ConsoleProxyManager CERTIFICATE_NAME storePassword cmd new StartConsoleProxyAgentHttpHandlerCommand ksBits storePassword cmd setEncryptorPassword getEncryptorPassword HostVO consoleProxyHost findConsoleProxyHost startupCmd assert consoleProxyHost null if consoleProxyHost null Answer answer _agentMgr send consoleProxyHost getId cmd if answer null answer getResult s_logger error else s_logger info catch NoSuchAlgorithmException e s_logger error e catch AgentUnavailableException e s_logger error startupCmd getProxyVmId e
assert consoleProxyHost null if consoleProxyHost null Answer answer _agentMgr send consoleProxyHost getId cmd if answer null answer getResult s_logger error else s_logger info catch NoSuchAlgorithmException e s_logger error e catch AgentUnavailableException e s_logger error startupCmd getProxyVmId e catch OperationTimedoutException e s_logger error startupCmd getProxyVmId e catch OutOfMemoryError e s_logger error
VMInstanceVO vm _instanceDao findById vmId if vm null s_logger warn vmId vmId return null if vm null vm getState State Starting vm getState State Running vm getState State Stopping vm getState State Migrating if s_logger isInfoEnabled s_logger info vmId return null if _allocProxyLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try if vm getProxyId null proxy _consoleProxyDao findById vm getProxyId if proxy null if isInAssignableState proxy if s_logger isInfoEnabled
if proxy null if isInAssignableState proxy if s_logger isInfoEnabled s_logger info vmId proxy null else if _consoleProxyDao getProxyActiveLoad proxy getId _capacityPerProxy hasPreviousSession proxy vm if s_logger isTraceEnabled s_logger trace vmId if proxy getActiveSession _capacityPerProxy s_logger warn vmId else proxy null if proxy null proxy assignProxyFromRunningPool dataCenterId
public ConsoleProxyVO startNew long dataCenterId throws ConcurrentOperationException if s_logger isDebugEnabled
VMTemplateVO template null HypervisorType availableHypervisor _resourceMgr getAvailableHypervisor dataCenterId template _templateDao findSystemVMReadyTemplate dataCenterId availableHypervisor if template null throw new CloudRuntimeException dataCenterId Map String Object context createProxyInstance dataCenterId template long proxyVmId Long context get if proxyVmId if s_logger isTraceEnabled s_logger trace dataCenterId return null ConsoleProxyVO proxy _consoleProxyDao findById proxyVmId if proxy null SubscriptionMgr getInstance notifySubscribers ConsoleProxyManager ALERT_SUBJECT this new ConsoleProxyAlertEventArgs ConsoleProxyAlertEventArgs PROXY_CREATED dataCenterId proxy getId proxy null return proxy
private boolean allowToLaunchNew long dcId if isConsoleProxyVmRequired dcId if s_logger isDebugEnabled
private void allocCapacity long dataCenterId if s_logger isTraceEnabled s_logger trace dataCenterId ConsoleProxyVO proxy null String errorString null try boolean consoleProxyVmFromStoppedPool false proxy assignProxyFromStoppedPool dataCenterId if proxy null if s_logger isInfoEnabled s_logger info if _allocProxyLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try proxy startNew dataCenterId catch ConcurrentOperationException e
proxy assignProxyFromStoppedPool dataCenterId if proxy null if s_logger isInfoEnabled s_logger info if _allocProxyLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try proxy startNew dataCenterId catch ConcurrentOperationException e s_logger info e finally _allocProxyLock unlock else if s_logger isInfoEnabled s_logger info else
proxy startNew dataCenterId catch ConcurrentOperationException e s_logger info e finally _allocProxyLock unlock else if s_logger isInfoEnabled s_logger info else if s_logger isInfoEnabled s_logger info proxy getId consoleProxyVmFromStoppedPool true if proxy null long proxyVmId proxy getId proxy startProxy proxyVmId false
finally _allocProxyLock unlock else if s_logger isInfoEnabled s_logger info else if s_logger isInfoEnabled s_logger info proxy getId consoleProxyVmFromStoppedPool true if proxy null long proxyVmId proxy getId proxy startProxy proxyVmId false if proxy null if s_logger isInfoEnabled s_logger info proxy getHostName
public boolean isZoneReady Map Long ZoneHostInfo zoneHostInfoMap long dataCenterId ZoneHostInfo zoneHostInfo zoneHostInfoMap get dataCenterId if zoneHostInfo null isZoneHostReady zoneHostInfo VMTemplateVO template _templateDao findSystemVMReadyTemplate dataCenterId HypervisorType Any if template null if s_logger isDebugEnabled
if template isDirectDownload templateHostRef _vmTemplateStoreDao findByTemplate template getId DataStoreRole Image else templateHostRef _vmTemplateStoreDao findByTemplateZoneDownloadStatus template getId dataCenterId Status DOWNLOADED if templateHostRef null boolean useLocalStorage false Boolean useLocal ConfigurationManagerImpl SystemVMUseLocalStorage valueIn dataCenterId if useLocal null useLocalStorage useLocal booleanValue List Pair Long Integer l _consoleProxyDao getDatacenterStoragePoolHostInfo dataCenterId useLocalStorage if l null l size l get second intValue return true else if s_logger isDebugEnabled s_logger debug
Override public boolean stopProxy long proxyVmId ConsoleProxyVO proxy _consoleProxyDao findById proxyVmId if proxy null if s_logger isDebugEnabled
Override public ConsoleProxyManagementState getManagementState String value _configDao getValue Config ConsoleProxyManagementState key if value null ConsoleProxyManagementState state ConsoleProxyManagementState valueOf value if state null
private ConsoleProxyManagementState getLastManagementState String value _configDao getValue Config ConsoleProxyManagementLastState key if value null ConsoleProxyManagementState state ConsoleProxyManagementState valueOf value if state null
Override public boolean destroyProxy long vmId ConsoleProxyVO proxy _consoleProxyDao findById vmId try _itMgr expunge proxy getUuid proxy setPublicIpAddress null proxy setPublicMacAddress null proxy setPublicNetmask null proxy setPrivateMacAddress null proxy setPrivateIpAddress null _consoleProxyDao update proxy getId proxy _consoleProxyDao remove vmId HostVO host _hostDao findByTypeNameAndZoneId proxy getDataCenterId proxy getHostName Host Type ConsoleProxy if host null
Override public boolean configure String name Map String Object params throws ConfigurationException if s_logger isInfoEnabled
s_logger warn _sslEnabled false value configs get Config ConsoleProxyCapacityScanInterval key _capacityScanInterval NumbersUtil parseLong value DEFAULT_CAPACITY_SCAN_INTERVAL _capacityPerProxy NumbersUtil parseInt configs get DEFAULT_PROXY_CAPACITY _standbyCapacity NumbersUtil parseInt configs get DEFAULT_STANDBY_CAPACITY _proxySessionTimeoutValue NumbersUtil parseInt configs get DEFAULT_PROXY_SESSION_TIMEOUT value configs get if value null _consoleProxyPort NumbersUtil parseInt value ConsoleProxyManager DEFAULT_PROXY_VNC_PORT value configs get Config ConsoleProxyDisableRpFilter key if value null value equalsIgnoreCase _disableRpFilter true value configs get if value null value equalsIgnoreCase
_sslEnabled false value configs get Config ConsoleProxyCapacityScanInterval key _capacityScanInterval NumbersUtil parseLong value DEFAULT_CAPACITY_SCAN_INTERVAL _capacityPerProxy NumbersUtil parseInt configs get DEFAULT_PROXY_CAPACITY _standbyCapacity NumbersUtil parseInt configs get DEFAULT_STANDBY_CAPACITY _proxySessionTimeoutValue NumbersUtil parseInt configs get DEFAULT_PROXY_SESSION_TIMEOUT value configs get if value null _consoleProxyPort NumbersUtil parseInt value ConsoleProxyManager DEFAULT_PROXY_VNC_PORT value configs get Config ConsoleProxyDisableRpFilter key if value null value equalsIgnoreCase _disableRpFilter true value configs get if value null value equalsIgnoreCase _useStorageVm true
_useStorageVm true if s_logger isInfoEnabled s_logger info _capacityPerProxy s_logger info _standbyCapacity _instance configs get if _instance null _instance Map String String agentMgrConfigs _configDao getConfiguration params value agentMgrConfigs get _mgmtPort NumbersUtil parseInt value _listener new ConsoleProxyListener new VmBasedAgentHook _instanceDao _hostDao _configDao _ksMgr _agentMgr _keysMgr _agentMgr registerForHostEvents _listener true true false _itMgr registerGuru VirtualMachine Type ConsoleProxy this String cpvmSrvcOffIdStr configs get Config ConsoleProxyServiceOffering key if cpvmSrvcOffIdStr null
buf append append deviceId append append nic getIPv4Address buf append append deviceId append append nic getIPv4Netmask if nic isDefaultNic buf append append nic getIPv4Gateway if nic getTrafficType TrafficType Management String mgmt_cidr _configDao getValue Config ManagementNetwork key if NetUtils isValidIp4Cidr mgmt_cidr buf append append mgmt_cidr buf append append dest getPod getGateway if externalDhcp buf append DataCenterVO dc _dcDao findById profile getVirtualMachine getDataCenterId buf append append dc getInternalDns1 if dc getInternalDns2 null buf append append dc getInternalDns2
private void handleResetSuspending List ConsoleProxyVO runningProxies _consoleProxyDao getProxyListInStates State Running for ConsoleProxyVO proxy runningProxies
Override public boolean isPoolReadyForScan Long pool long dataCenterId pool longValue if isZoneReady _zoneHostInfoMap dataCenterId if s_logger isDebugEnabled
int cpu_requested offering getCpu offering getSpeed long ram_requested offering getRamSize 1024L 1024L VirtualMachine vm vmProfile getVirtualMachine DataCenter dc _dcDao findById vm getDataCenterId if vm getType VirtualMachine Type User vm getType VirtualMachine Type DomainRouter checkForNonDedicatedResources vmProfile dc avoids if s_logger isDebugEnabled s_logger debug planner s_logger debug plan getDataCenterId plan getPodId plan getClusterId cpu_requested toHumanReadableSize ram_requested s_logger debug plan getPoolId null String haVmTag String vmProfile getParameter VirtualMachineProfile Param HaTag String uefiFlag String vmProfile getParameter VirtualMachineProfile Param UefiFlag if plan getHostId null haVmTag null Long hostIdSpecified plan getHostId if s_logger isDebugEnabled
String uefiFlag String vmProfile getParameter VirtualMachineProfile Param UefiFlag if plan getHostId null haVmTag null Long hostIdSpecified plan getHostId if s_logger isDebugEnabled s_logger debug hostIdSpecified HostVO host _hostDao findById hostIdSpecified if host null StringUtils isNotBlank uefiFlag equalsIgnoreCase uefiFlag _hostDao loadDetails host if MapUtils isNotEmpty host getDetails host getDetails containsKey Host HOST_UEFI_ENABLE equalsIgnoreCase host getDetails get Host HOST_UEFI_ENABLE s_logger debug return null if host null s_logger debug else if avoids shouldAvoid host s_logger debug
Cluster cluster _clusterDao findById host getClusterId if cluster getAllocationState Grouping AllocationState Enabled s_logger warn cluster getId return null if vm getHypervisorType HypervisorType BareMetal DeployDestination dest new DeployDestination dc pod cluster host new HashMap Volume StoragePool s_logger debug dest return dest DataCenterDeployment lastPlan new DataCenterDeployment host getDataCenterId host getPodId host getClusterId hostIdSpecified plan getPoolId null plan getReservationContext Pair Map Volume List StoragePool List Volume result findSuitablePoolsForVolumes vmProfile lastPlan avoids HostAllocator RETURN_UPTO_ALL Map Volume List StoragePool suitableVolumeStoragePools result first List Volume readyAndReusedVolumes result second if suitableVolumeStoragePools isEmpty List Host suitableHosts new ArrayList Host suitableHosts add host
return dest DataCenterDeployment lastPlan new DataCenterDeployment host getDataCenterId host getPodId host getClusterId hostIdSpecified plan getPoolId null plan getReservationContext Pair Map Volume List StoragePool List Volume result findSuitablePoolsForVolumes vmProfile lastPlan avoids HostAllocator RETURN_UPTO_ALL Map Volume List StoragePool suitableVolumeStoragePools result first List Volume readyAndReusedVolumes result second if suitableVolumeStoragePools isEmpty List Host suitableHosts new ArrayList Host suitableHosts add host Pair Host Map Volume StoragePool potentialResources findPotentialDeploymentResources suitableHosts suitableVolumeStoragePools avoids getPlannerUsage planner vmProfile plan avoids readyAndReusedVolumes plan getPreferredHosts if potentialResources null pod _podDao findById host getPodId cluster _clusterDao findById host getClusterId Map Volume StoragePool storageVolMap potentialResources second for Volume vol readyAndReusedVolumes storageVolMap remove vol
Pair Map Volume List StoragePool List Volume result findSuitablePoolsForVolumes vmProfile lastPlan avoids HostAllocator RETURN_UPTO_ALL Map Volume List StoragePool suitableVolumeStoragePools result first List Volume readyAndReusedVolumes result second if suitableVolumeStoragePools isEmpty List Host suitableHosts new ArrayList Host suitableHosts add host Pair Host Map Volume StoragePool potentialResources findPotentialDeploymentResources suitableHosts suitableVolumeStoragePools avoids getPlannerUsage planner vmProfile plan avoids readyAndReusedVolumes plan getPreferredHosts if potentialResources null pod _podDao findById host getPodId cluster _clusterDao findById host getClusterId Map Volume StoragePool storageVolMap potentialResources second for Volume vol readyAndReusedVolumes storageVolMap remove vol DeployDestination dest new DeployDestination dc pod cluster host storageVolMap s_logger debug dest
for Volume vol readyAndReusedVolumes storageVolMap remove vol DeployDestination dest new DeployDestination dc pod cluster host storageVolMap s_logger debug dest return dest s_logger debug return null long vmGroupCount _affinityGroupVMMapDao countAffinityGroupsForVm vm getId if vmGroupCount for AffinityGroupProcessor processor _affinityProcessors processor process vmProfile plan avoids if s_logger isDebugEnabled s_logger debug avoids getPodsToAvoid avoids getClustersToAvoid avoids getHostsToAvoid if avoids shouldAvoid dc if s_logger isDebugEnabled
s_logger debug return null long vmGroupCount _affinityGroupVMMapDao countAffinityGroupsForVm vm getId if vmGroupCount for AffinityGroupProcessor processor _affinityProcessors processor process vmProfile plan avoids if s_logger isDebugEnabled s_logger debug avoids getPodsToAvoid avoids getClustersToAvoid avoids getHostsToAvoid if avoids shouldAvoid dc if s_logger isDebugEnabled s_logger debug dc getId return null if planner null String plannerName offering getDeploymentPlanner if plannerName null
planner getDeploymentPlannerByName plannerName if vm getLastHostId null haVmTag null s_logger debug vm getLastHostId HostVO host _hostDao findById vm getLastHostId ServiceOfferingDetailsVO offeringDetails null if host null s_logger debug else if avoids shouldAvoid host s_logger debug else if plan getClusterId null host getClusterId null plan getClusterId equals host getClusterId s_logger debug plan getClusterId else if _capacityMgr checkIfHostReachMaxGuestLimit host s_logger debug host getId else if offeringDetails _serviceOfferingDetailsDao findDetail offering getId GPU Keys vgpuType toString null ServiceOfferingDetailsVO groupName _serviceOfferingDetailsDao findDetail offering getId GPU Keys pciDevice toString
else final PlannerResourceUsage hostResourceTypeFinal hostResourceType return Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status final PlannerHostReservationVO lockedEntry _plannerHostReserveDao lockRow id true if lockedEntry null s_logger error hostId return false if lockedEntry getResourceUsage null lockedEntry setResourceUsage resourceUsageRequired _plannerHostReserveDao persist lockedEntry return true else if lockedEntry getResourceUsage resourceUsageRequired return true
DB public boolean checkHostReservationRelease final Long hostId if hostId null PlannerHostReservationVO reservationEntry _plannerHostReserveDao findByHostId hostId if reservationEntry null reservationEntry getResourceUsage null List VMInstanceVO vms _vmInstanceDao listUpByHostId hostId if vms size if s_logger isDebugEnabled
DB public boolean checkHostReservationRelease final Long hostId if hostId null PlannerHostReservationVO reservationEntry _plannerHostReserveDao findByHostId hostId if reservationEntry null reservationEntry getResourceUsage null List VMInstanceVO vms _vmInstanceDao listUpByHostId hostId if vms size if s_logger isDebugEnabled s_logger debug vms size hostId return false List VMInstanceVO vmsByLastHostId _vmInstanceDao listByLastHostId hostId if vmsByLastHostId size for VMInstanceVO stoppedVM vmsByLastHostId long secondsSinceLastUpdate DateUtil currentGMTTime getTime stoppedVM getUpdateTime getTime if secondsSinceLastUpdate _vmCapacityReleaseInterval if s_logger isDebugEnabled
if vms size if s_logger isDebugEnabled s_logger debug vms size hostId return false List VMInstanceVO vmsByLastHostId _vmInstanceDao listByLastHostId hostId if vmsByLastHostId size for VMInstanceVO stoppedVM vmsByLastHostId long secondsSinceLastUpdate DateUtil currentGMTTime getTime stoppedVM getUpdateTime getTime if secondsSinceLastUpdate _vmCapacityReleaseInterval if s_logger isDebugEnabled s_logger debug stoppedVM hostId return false List VMInstanceVO vmsStoppingMigratingByHostId _vmInstanceDao findByHostInStates hostId State Stopping State Migrating State Starting if vmsStoppingMigratingByHostId size if s_logger isDebugEnabled
for VMInstanceVO stoppedVM vmsByLastHostId long secondsSinceLastUpdate DateUtil currentGMTTime getTime stoppedVM getUpdateTime getTime if secondsSinceLastUpdate _vmCapacityReleaseInterval if s_logger isDebugEnabled s_logger debug stoppedVM hostId return false List VMInstanceVO vmsStoppingMigratingByHostId _vmInstanceDao findByHostInStates hostId State Stopping State Migrating State Starting if vmsStoppingMigratingByHostId size if s_logger isDebugEnabled s_logger debug vmsStoppingMigratingByHostId size hostId return false List VMInstanceVO vmsStartingNoHost _vmInstanceDao listStartingWithNoHostId if vmsStartingNoHost size if s_logger isDebugEnabled s_logger debug vms size
return false List VMInstanceVO vmsStoppingMigratingByHostId _vmInstanceDao findByHostInStates hostId State Stopping State Migrating State Starting if vmsStoppingMigratingByHostId size if s_logger isDebugEnabled s_logger debug vmsStoppingMigratingByHostId size hostId return false List VMInstanceVO vmsStartingNoHost _vmInstanceDao listStartingWithNoHostId if vmsStartingNoHost size if s_logger isDebugEnabled s_logger debug vms size return false if s_logger isDebugEnabled s_logger debug hostId final long id reservationEntry getId return Transaction execute new TransactionCallback Boolean
Override public boolean configure final String name final Map String Object params throws ConfigurationException _agentMgr registerForHostEvents this true false true VirtualMachine State getStateMachine registerListener this _messageBus subscribe new MessageSubscriber Override public void onPublishMessage String senderAddress String subject Object obj VMInstanceVO vm VMInstanceVO obj
Pod pod _podDao findById clusterVO getPodId if pod getAllocationState Grouping AllocationState Enabled List Host suitableHosts findSuitableHosts vmProfile potentialPlan avoid HostAllocator RETURN_UPTO_ALL if suitableHosts null suitableHosts isEmpty if vmProfile getHypervisorType HypervisorType BareMetal DeployDestination dest new DeployDestination dc pod clusterVO suitableHosts get return dest Pair Map Volume List StoragePool List Volume result findSuitablePoolsForVolumes vmProfile potentialPlan avoid StoragePoolAllocator RETURN_UPTO_ALL Map Volume List StoragePool suitableVolumeStoragePools result first List Volume readyAndReusedVolumes result second if suitableVolumeStoragePools isEmpty Pair Host Map Volume StoragePool potentialResources findPotentialDeploymentResources suitableHosts suitableVolumeStoragePools avoid resourceUsageRequired readyAndReusedVolumes plan getPreferredHosts if potentialResources null Host host _hostDao findById potentialResources first getId Map Volume StoragePool storageVolMap potentialResources second
Pair Map Volume List StoragePool List Volume result findSuitablePoolsForVolumes vmProfile potentialPlan avoid StoragePoolAllocator RETURN_UPTO_ALL Map Volume List StoragePool suitableVolumeStoragePools result first List Volume readyAndReusedVolumes result second if suitableVolumeStoragePools isEmpty Pair Host Map Volume StoragePool potentialResources findPotentialDeploymentResources suitableHosts suitableVolumeStoragePools avoid resourceUsageRequired readyAndReusedVolumes plan getPreferredHosts if potentialResources null Host host _hostDao findById potentialResources first getId Map Volume StoragePool storageVolMap potentialResources second for Volume vol readyAndReusedVolumes storageVolMap remove vol DeployDestination dest new DeployDestination dc pod clusterVO host storageVolMap s_logger debug dest return dest else s_logger debug clusterId
boolean hostAffinityCheck false if readyAndReusedVolumes null readyAndReusedVolumes new ArrayList Volume Map Volume StoragePool storage new HashMap Volume StoragePool TreeSet Volume volumesOrderBySizeDesc new TreeSet Volume new Comparator Volume Override public int compare Volume v1 Volume v2 if v1 getSize v2 getSize return else return volumesOrderBySizeDesc addAll suitableVolumeStoragePools keySet boolean multipleVolume volumesOrderBySizeDesc size for Host potentialHost suitableHosts Map StoragePool List Volume volumeAllocationMap new HashMap StoragePool List Volume for Volume vol volumesOrderBySizeDesc haveEnoughSpace false
List Volume requestVolumes null if volumeAllocationMap containsKey potentialSPool requestVolumes volumeAllocationMap get potentialSPool else requestVolumes new ArrayList Volume requestVolumes add vol if _storageMgr storagePoolHasEnoughIops requestVolumes potentialSPool _storageMgr storagePoolHasEnoughSpace requestVolumes potentialSPool potentialHost getClusterId continue volumeAllocationMap put potentialSPool requestVolumes storage put vol potentialSPool haveEnoughSpace true break if hostCanAccessPool break if haveEnoughSpace s_logger warn break if hostAffinityCheck
private boolean isEnabledForAllocation long zoneId Long podId Long clusterId DataCenterVO zone _dcDao findById zoneId if zone null Grouping AllocationState Disabled zone getAllocationState
Override public List Long orderClusters VirtualMachineProfile vmProfile DeploymentPlan plan ExcludeList avoid throws InsufficientServerCapacityException VirtualMachine vm vmProfile getVirtualMachine DataCenter dc dcDao findById vm getDataCenterId if avoid shouldAvoid dc if s_logger isDebugEnabled
else s_logger debug avoid addCluster plan getClusterId return null else if plan getPodId null Long podIdSpecified plan getPodId s_logger debug podIdSpecified HostPodVO pod podDao findById podIdSpecified if pod null if avoid shouldAvoid pod s_logger debug else clusterList scanClustersForDestinationInZoneOrPod podIdSpecified false vmProfile plan avoid if clusterList null avoid addPod plan getPodId
private List Long scanPodsForDestination VirtualMachineProfile vmProfile DeploymentPlan plan ExcludeList avoid ServiceOffering offering vmProfile getServiceOffering int requiredCpu offering getCpu offering getSpeed long requiredRam offering getRamSize 1024L 1024L List Long prioritizedPodIds new ArrayList Long Pair List Long Map Long Double podCapacityInfo listPodsByCapacity plan getDataCenterId requiredCpu requiredRam List Long podsWithCapacity podCapacityInfo first if podsWithCapacity isEmpty if avoid getPodsToAvoid null if s_logger isDebugEnabled
ServiceOffering offering vmProfile getServiceOffering int requiredCpu offering getCpu offering getSpeed long requiredRam offering getRamSize 1024L 1024L List Long prioritizedPodIds new ArrayList Long Pair List Long Map Long Double podCapacityInfo listPodsByCapacity plan getDataCenterId requiredCpu requiredRam List Long podsWithCapacity podCapacityInfo first if podsWithCapacity isEmpty if avoid getPodsToAvoid null if s_logger isDebugEnabled s_logger debug avoid getPodsToAvoid podsWithCapacity removeAll avoid getPodsToAvoid if isRootAdmin vmProfile List Long disabledPods listDisabledPods plan getDataCenterId if disabledPods isEmpty if s_logger isDebugEnabled
List Short capacityList getCapacitiesForCheckingThreshold List Long clustersCrossingThreshold new ArrayList Long ServiceOffering offering vmProfile getServiceOffering int cpu_requested offering getCpu offering getSpeed long ram_requested offering getRamSize 1024L 1024L for short capacity capacityList if clusterListForVmAllocation null clusterListForVmAllocation size return if capacity Capacity CAPACITY_TYPE_CPU clustersCrossingThreshold capacityDao listClustersCrossingThreshold capacity plan getDataCenterId ClusterCPUCapacityDisableThreshold key cpu_requested else if capacity Capacity CAPACITY_TYPE_MEMORY clustersCrossingThreshold capacityDao listClustersCrossingThreshold capacity plan getDataCenterId ClusterMemoryCapacityDisableThreshold key ram_requested if clustersCrossingThreshold null clustersCrossingThreshold size avoid addClusterList clustersCrossingThreshold clusterListForVmAllocation removeAll clustersCrossingThreshold
private List Long scanClustersForDestinationInZoneOrPod long id boolean isZone VirtualMachineProfile vmProfile DeploymentPlan plan ExcludeList avoid VirtualMachine vm vmProfile getVirtualMachine ServiceOffering offering vmProfile getServiceOffering DataCenter dc dcDao findById vm getDataCenterId int requiredCpu offering getCpu offering getSpeed long requiredRam offering getRamSize 1024L 1024L Pair List Long Map Long Double clusterCapacityInfo listClustersByCapacity id requiredCpu requiredRam avoid isZone List Long prioritizedClusterIds clusterCapacityInfo first if prioritizedClusterIds isEmpty if avoid getClustersToAvoid null if s_logger isDebugEnabled
Pair List Long Map Long Double clusterCapacityInfo listClustersByCapacity id requiredCpu requiredRam avoid isZone List Long prioritizedClusterIds clusterCapacityInfo first if prioritizedClusterIds isEmpty if avoid getClustersToAvoid null if s_logger isDebugEnabled s_logger debug avoid getClustersToAvoid prioritizedClusterIds removeAll avoid getClustersToAvoid if isRootAdmin vmProfile List Long disabledClusters new ArrayList Long if isZone disabledClusters listDisabledClusters plan getDataCenterId null else disabledClusters listDisabledClusters plan getDataCenterId id if disabledClusters isEmpty if s_logger isDebugEnabled
protected Pair List Long Map Long Double listClustersByCapacity long id int requiredCpu long requiredRam ExcludeList avoid boolean isZone if s_logger isDebugEnabled
protected Pair List Long Map Long Double listPodsByCapacity long zoneId int requiredCpu long requiredRam if s_logger isDebugEnabled
private void removeClustersWithoutMatchingTag List Long clusterListForVmAllocation String hostTagOnOffering List Long matchingClusters hostDao listClustersByHostTag hostTagOnOffering clusterListForVmAllocation retainAll matchingClusters if s_logger isDebugEnabled
private static long getDomainId long accountId AccountVO account s_accountDao findByIdIncludingRemoved accountId if account null
protected Status testIpAddress Long hostId String testHostIp try Answer pingTestAnswer _agentMgr send hostId new PingTestCommand testHostIp if pingTestAnswer null if s_logger isDebugEnabled
Answer pingTestAnswer _agentMgr send hostId new PingTestCommand testHostIp if pingTestAnswer null if s_logger isDebugEnabled s_logger debug testHostIp return Status Unknown if pingTestAnswer getResult if s_logger isDebugEnabled s_logger debug testHostIp return Status Up else if s_logger isDebugEnabled s_logger debug testHostIp return Status Unknown catch AgentUnavailableException e if s_logger isDebugEnabled
return Status Unknown if pingTestAnswer getResult if s_logger isDebugEnabled s_logger debug testHostIp return Status Up else if s_logger isDebugEnabled s_logger debug testHostIp return Status Unknown catch AgentUnavailableException e if s_logger isDebugEnabled s_logger debug testHostIp e getLocalizedMessage return Status Unknown catch OperationTimedoutException e if s_logger isDebugEnabled
Override public boolean isVmAlive VirtualMachine vm Host host throws UnknownVM CheckVirtualMachineCommand cmd new CheckVirtualMachineCommand vm getInstanceName try CheckVirtualMachineAnswer answer CheckVirtualMachineAnswer _agentMgr send vm getHostId cmd if answer getResult
sb new StringBuilder sb append for int i i vms size i VMInstanceVO vm vms get i if vm getType VirtualMachine Type User reorderedVMList add vm else reorderedVMList add vm if vm isHaEnabled sb append vm getHostName HostPodVO podVO _podDao findById host getPodId String hostDesc host getName host getId dcVO getName podVO getName _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_HOST host getDataCenterId host getPodId hostDesc hostDesc sb null sb toString for VMInstanceVO vm reorderedVMList ServiceOfferingVO vmOffering _serviceOfferingDao findById vm getServiceOfferingId
VMInstanceVO vm vms get i if vm getType VirtualMachine Type User reorderedVMList add vm else reorderedVMList add vm if vm isHaEnabled sb append vm getHostName HostPodVO podVO _podDao findById host getPodId String hostDesc host getName host getId dcVO getName podVO getName _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_HOST host getDataCenterId host getPodId hostDesc hostDesc sb null sb toString for VMInstanceVO vm reorderedVMList ServiceOfferingVO vmOffering _serviceOfferingDao findById vm getServiceOfferingId if vmOffering isUseLocalStorage if s_logger isDebugEnabled s_logger debug vm
else reorderedVMList add vm if vm isHaEnabled sb append vm getHostName HostPodVO podVO _podDao findById host getPodId String hostDesc host getName host getId dcVO getName podVO getName _alertMgr sendAlert AlertManager AlertType ALERT_TYPE_HOST host getDataCenterId host getPodId hostDesc hostDesc sb null sb toString for VMInstanceVO vm reorderedVMList ServiceOfferingVO vmOffering _serviceOfferingDao findById vm getServiceOfferingId if vmOffering isUseLocalStorage if s_logger isDebugEnabled s_logger debug vm continue if s_logger isDebugEnabled s_logger debug vm getId vm getInstanceName
Override public void scheduleStop VMInstanceVO vm long hostId WorkType type assert type WorkType CheckStop type WorkType ForceStop type WorkType Stop if _haDao hasBeenScheduled vm getId type
Override public boolean scheduleMigration final VMInstanceVO vm if vm getHostId null final HaWorkVO work new HaWorkVO vm getId vm getType WorkType Migration Step Scheduled vm getHostId vm getState vm getUpdated _haDao persist work
public Long migrate final HaWorkVO work long vmId work getInstanceId long srcHostId work getHostId VMInstanceVO vm _instanceDao findById vmId if vm null
Override public void scheduleDestroy VMInstanceVO vm long hostId final HaWorkVO work new HaWorkVO vm getId vm getType WorkType Destroy Step Scheduled hostId vm getState vm getUpdated _haDao persist work if s_logger isDebugEnabled
protected Long destroyVM final HaWorkVO work final VirtualMachine vm _itMgr findById work getInstanceId
protected Long destroyVM final HaWorkVO work final VirtualMachine vm _itMgr findById work getInstanceId s_logger info vm toString try if vm getState State Destroyed
final VirtualMachine vm _itMgr findById work getInstanceId s_logger info vm toString try if vm getState State Destroyed s_logger info vm toString return null if vm getHostId null _itMgr destroy vm getUuid false s_logger info vm return null else if s_logger isDebugEnabled s_logger debug vm return null catch final AgentUnavailableException e
try if vm getState State Destroyed s_logger info vm toString return null if vm getHostId null _itMgr destroy vm getUuid false s_logger info vm return null else if s_logger isDebugEnabled s_logger debug vm return null catch final AgentUnavailableException e s_logger debug e getMessage catch OperationTimedoutException e
s_logger info vm toString return null if vm getHostId null _itMgr destroy vm getUuid false s_logger info vm return null else if s_logger isDebugEnabled s_logger debug vm return null catch final AgentUnavailableException e s_logger debug e getMessage catch OperationTimedoutException e s_logger debug e getMessage catch ConcurrentOperationException e
Override public void cancelScheduledMigrations final HostVO host WorkType type host getType HostVO Type Storage WorkType Stop WorkType Migration
return null List HostVO hosts _resourceMgr listAllHostsInCluster host getClusterId FenceCommand fence new FenceCommand vm host int i for HostVO h hosts if h getHypervisorType HypervisorType KVM h getHypervisorType HypervisorType LXC if h getStatus Status Up continue i if h getId host getId continue FenceAnswer answer try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e
FenceCommand fence new FenceCommand vm host int i for HostVO h hosts if h getHypervisorType HypervisorType KVM h getHypervisorType HypervisorType LXC if h getStatus Status Up continue i if h getId host getId continue FenceAnswer answer try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e s_logger info h toString e continue
continue i if h getId host getId continue FenceAnswer answer try answer FenceAnswer _agentMgr send h getId fence catch AgentUnavailableException e s_logger info h toString e continue catch OperationTimedoutException e s_logger info h toString e continue if answer null answer getResult return true
Override public Boolean fenceOff VirtualMachine vm Host host VirtualMachine Type type vm getType if type VirtualMachine Type ConsoleProxy type VirtualMachine Type DomainRouter type VirtualMachine Type SecondaryStorageVm if s_logger isDebugEnabled
Override public boolean isVmAlive VirtualMachine vm Host host throws UnknownVM if vm getType VirtualMachine Type User if s_logger isDebugEnabled
Override public boolean isVmAlive VirtualMachine vm Host host throws UnknownVM if vm getType VirtualMachine Type User if s_logger isDebugEnabled s_logger debug vm throw new UnknownVM if s_logger isDebugEnabled s_logger debug vm UserVmVO userVm _userVmDao findById vm getId List extends Nic nics _networkMgr getNicsForTraffic userVm getId TrafficType Guest for Nic nic nics if nic getIPv4Address null continue List VirtualRouter routers _vnaMgr getRoutersForNetwork nic getNetworkId if routers null routers isEmpty if s_logger isDebugEnabled
List extends Nic nics _networkMgr getNicsForTraffic userVm getId TrafficType Guest for Nic nic nics if nic getIPv4Address null continue List VirtualRouter routers _vnaMgr getRoutersForNetwork nic getNetworkId if routers null routers isEmpty if s_logger isDebugEnabled s_logger debug nic getNetworkId vm continue Boolean result null for VirtualRouter router routers result testUserVM vm nic router if result null break if result null
String routerPrivateIp router getPrivateIpAddress List Long otherHosts new ArrayList Long if vm getHypervisorType HypervisorType XenServer vm getHypervisorType HypervisorType KVM otherHosts add router getHostId else otherHosts findHostByPod router getPodIdToDeployIn null for Long hostId otherHosts try Answer pingTestAnswer _agentMgr easySend hostId new PingTestCommand routerPrivateIp privateIp if pingTestAnswer null pingTestAnswer getResult if s_logger isDebugEnabled s_logger debug vm getHostName privateIp router getHostName return Boolean TRUE catch Exception e if s_logger isDebugEnabled
otherHosts add router getHostId else otherHosts findHostByPod router getPodIdToDeployIn null for Long hostId otherHosts try Answer pingTestAnswer _agentMgr easySend hostId new PingTestCommand routerPrivateIp privateIp if pingTestAnswer null pingTestAnswer getResult if s_logger isDebugEnabled s_logger debug vm getHostName privateIp router getHostName return Boolean TRUE catch Exception e if s_logger isDebugEnabled s_logger debug e continue if s_logger isDebugEnabled
DataCenterVO zone _zoneDao findByToken zoneToken if zone null zone _zoneDao findByName zoneToken if zone null try long zoneId Long parseLong zoneToken zone _zoneDao findById zoneId if zone null throw new AgentAuthnException zoneToken catch NumberFormatException nfe throw new AgentAuthnException zoneToken if s_logger isDebugEnabled s_logger debug HostPodVO pod findPod startup zone getId Host Type Routing Long podId null
if to getLimitCpuUse VirtualMachine vm vmProfile getVirtualMachine HostVO host _hostDao findById vm getHostId if host null throw new CloudRuntimeException vm getHostId s_logger debug vm getUuid host getUuid double hostMaxSpeed getHostCPUSpeed host double maxSpeed getVmSpeed to try BigDecimal percent new BigDecimal maxSpeed hostMaxSpeed percent percent setScale RoundingMode HALF_DOWN if percent compareTo new BigDecimal s_logger debug vm getUuid host getUuid percent new BigDecimal to setCpuQuotaPercentage percent doubleValue
HostVO host _hostDao findById vm getHostId if host null throw new CloudRuntimeException vm getHostId s_logger debug vm getUuid host getUuid double hostMaxSpeed getHostCPUSpeed host double maxSpeed getVmSpeed to try BigDecimal percent new BigDecimal maxSpeed hostMaxSpeed percent percent setScale RoundingMode HALF_DOWN if percent compareTo new BigDecimal s_logger debug vm getUuid host getUuid percent new BigDecimal to setCpuQuotaPercentage percent doubleValue s_logger debug host getUuid hostMaxSpeed vm getUuid maxSpeed percent doubleValue catch NumberFormatException e
throw new CloudRuntimeException agentIp Integer validityPeriod CAManager CertValidityPeriod value if validityPeriod validityPeriod final SSHCmdHelper SSHCmdResult keystoreSetupResult SSHCmdHelper sshExecuteCmdWithResult sshConnection String format KeyStoreUtils KS_SETUP_SCRIPT KeyStoreUtils KS_FILENAME PasswordGenerator generateRandomPassword validityPeriod KeyStoreUtils CSR_FILENAME if keystoreSetupResult isSuccess throw new CloudRuntimeException agentIp final Certificate certificate caManager issueCertificate keystoreSetupResult getStdOut Arrays asList agentHostname agentIp Collections singletonList agentIp null null if certificate null certificate getClientCertificate null throw new CloudRuntimeException agentIp final SetupCertificateCommand certificateCommand new SetupCertificateCommand certificate final SSHCmdHelper SSHCmdResult setupCertResult SSHCmdHelper sshExecuteCmdWithResult sshConnection String format KeyStoreUtils KS_IMPORT_SCRIPT KeyStoreUtils KS_FILENAME KeyStoreUtils SSH_MODE KeyStoreUtils CERT_FILENAME certificateCommand getEncodedCertificate KeyStoreUtils CACERT_FILENAME certificateCommand getEncodedCaCertificates KeyStoreUtils PKEY_FILENAME certificateCommand getEncodedPrivateKey if setupCertResult null setupCertResult isSuccess throw new CloudRuntimeException if s_logger isDebugEnabled
Map String String details new HashMap String String if uri getScheme equals String msg uri s_logger debug msg return null Connection sshConnection null String agentIp null try String hostname uri getHost InetAddress ia InetAddress getByName hostname agentIp ia getHostAddress String guid UUID nameUUIDFromBytes agentIp getBytes toString List HostVO existingHosts _resourceMgr listAllHostsInOneZoneByType Host Type Routing dcId if existingHosts null for HostVO existingHost existingHosts
if account null s_logger debug accountId return String publicIp _networkModel getIp lb getSourceIpAddressId getAddress addr DataCenterVO zone _dcDao findById network getDataCenterId String statsEntryIdentifier account getAccountName zone getName networkId externalLoadBalancer getName long newCurrentBytesSent long newCurrentBytesReceived if publicIp null long bytesSentAndReceived null statsEntryIdentifier publicIp boolean inline _networkModel isNetworkInlineMode network if externalLoadBalancer getType equals Host Type ExternalLoadBalancer inline InlineLoadBalancerNicMapVO mapping _inlineLoadBalancerNicMapDao findByPublicIpAddress publicIp if mapping null
long oldNetBytesReceived userStats getNetBytesReceived long oldCurrentBytesSent userStats getCurrentBytesSent long oldCurrentBytesReceived userStats getCurrentBytesReceived String warning userStats getDataCenterId userStats getAccountId userStats setCurrentBytesSent newCurrentBytesSent if oldCurrentBytesSent newCurrentBytesSent s_logger warn warning toHumanReadableSize oldCurrentBytesSent toHumanReadableSize newCurrentBytesSent userStats setNetBytesSent oldNetBytesSent oldCurrentBytesSent userStats setCurrentBytesReceived newCurrentBytesReceived if oldCurrentBytesReceived newCurrentBytesReceived s_logger warn warning toHumanReadableSize oldCurrentBytesReceived toHumanReadableSize newCurrentBytesReceived userStats setNetBytesReceived oldNetBytesReceived oldCurrentBytesReceived if _userStatsDao update userStats getId userStats s_logger debug statsEntryIdentifier else
if ntwkDevice null url null username null resource null password null throw new InvalidParameterValueException pNetwork _physicalNetworkDao findById physicalNetworkId if pNetwork null throw new InvalidParameterValueException physicalNetworkId zoneId pNetwork getDataCenterId final PhysicalNetworkServiceProviderVO ntwkSvcProvider _physicalNetworkServiceProviderDao findByServiceProvider pNetwork getId ntwkDevice getNetworkServiceProvder if ntwkSvcProvider null throw new CloudRuntimeException ntwkDevice getNetworkServiceProvder physicalNetworkId else if ntwkSvcProvider getState PhysicalNetworkServiceProvider State Shutdown throw new CloudRuntimeException ntwkSvcProvider getProviderName physicalNetworkId URI uri try uri new URI url catch Exception e
HostVO externalFirewall _hostDao findById hostId if externalFirewall null throw new InvalidParameterValueException hostId DetailVO fwHostDetails _hostDetailDao findDetail hostId ApiConstants FIREWALL_DEVICE_ID long fwDeviceId Long parseLong fwHostDetails getValue List NetworkExternalFirewallVO networks _networkExternalFirewallDao listByFirewallDeviceId fwDeviceId if networks null networks isEmpty throw new CloudRuntimeException try externalFirewall setResourceState ResourceState Maintenance _hostDao update hostId externalFirewall _resourceMgr deleteHost hostId false false _externalFirewallDeviceDao remove fwDeviceId return true catch Exception e
IpAddressTO ips new IpAddressTO ips ip IpAssocCommand cmd new IpAssocCommand ips cmd setAccessDetail NetworkElementCommand GUEST_NETWORK_GATEWAY guestVlanGateway cmd setAccessDetail NetworkElementCommand GUEST_NETWORK_CIDR guestVlanCidr cmd setAccessDetail NetworkElementCommand GUEST_VLAN_TAG String valueOf guestVlanTag Answer answer _agentMgr easySend externalFirewall getId cmd List String reservedIpAddressesForGuestNetwork _nicDao listIpAddressInNetwork network getId if answer null answer getResult String action add String answerDetails answer null answer getDetails String msg action zone getName answerDetails s_logger error msg if add reservedIpAddressesForGuestNetwork contains network getGateway s_logger error
cmd setAccessDetail NetworkElementCommand GUEST_NETWORK_CIDR guestVlanCidr cmd setAccessDetail NetworkElementCommand GUEST_VLAN_TAG String valueOf guestVlanTag Answer answer _agentMgr easySend externalFirewall getId cmd List String reservedIpAddressesForGuestNetwork _nicDao listIpAddressInNetwork network getId if answer null answer getResult String action add String answerDetails answer null answer getDetails String msg action zone getName answerDetails s_logger error msg if add reservedIpAddressesForGuestNetwork contains network getGateway s_logger error return true throw new ResourceUnavailableException msg DataCenter class zoneId if add reservedIpAddressesForGuestNetwork contains network getGateway _networkMgr savePlaceholderNic network network getGateway null null
public boolean applyStaticNatRules Network network List extends StaticNat rules throws ResourceUnavailableException long zoneId network getDataCenterId DataCenterVO zone _dcDao findById zoneId ExternalFirewallDeviceVO fwDeviceVO getExternalFirewallForNetwork network HostVO externalFirewall _hostDao findById fwDeviceVO getHostId assert externalFirewall null if network getState Network State Allocated
protected void sendFirewallRules List FirewallRuleTO firewallRules DataCenter zone long externalFirewallId throws ResourceUnavailableException if firewallRules isEmpty SetFirewallRulesCommand cmd new SetFirewallRulesCommand firewallRules Answer answer _agentMgr easySend externalFirewallId cmd if answer null answer getResult String details answer null answer getDetails String msg zone getName details
protected void sendStaticNatRules List StaticNatRuleTO staticNatRules DataCenter zone long externalFirewallId throws ResourceUnavailableException if staticNatRules isEmpty SetStaticNatRulesCommand cmd new SetStaticNatRulesCommand staticNatRules null Answer answer _agentMgr easySend externalFirewallId cmd if answer null answer getResult String details answer null answer getDetails String msg zone getName details
protected void sendPortForwardingRules List PortForwardingRuleTO portForwardingRules DataCenter zone long externalFirewallId throws ResourceUnavailableException if portForwardingRules isEmpty SetPortForwardingRulesCommand cmd new SetPortForwardingRulesCommand portForwardingRules Answer answer _agentMgr easySend externalFirewallId cmd if answer null answer getResult String details answer null answer getDetails String msg zone getName details
List VpnUser addUsers new ArrayList VpnUser List VpnUser removeUsers new ArrayList VpnUser for VpnUser user vpnUsers if user getState VpnUser State Add user getState VpnUser State Active addUsers add user else if user getState VpnUser State Revoke removeUsers add user VpnUsersCfgCommand addUsersCmd new VpnUsersCfgCommand addUsers removeUsers addUsersCmd setAccessDetail NetworkElementCommand ACCOUNT_ID String valueOf network getAccountId addUsersCmd setAccessDetail NetworkElementCommand GUEST_NETWORK_CIDR network getCidr Answer answer _agentMgr easySend externalFirewall getId addUsersCmd if answer null answer getResult String details answer null answer getDetails DataCenterVO zone _dcDao findById network getDataCenterId String msg zone getName details
Override public boolean applyPortForwardingRules Network network List extends PortForwardingRule rules throws ResourceUnavailableException long zoneId network getDataCenterId DataCenterVO zone _dcDao findById zoneId ExternalFirewallDeviceVO fwDeviceVO getExternalFirewallForNetwork network HostVO externalFirewall _hostDao findById fwDeviceVO getHostId assert externalFirewall null if network getState Network State Allocated
finally deviceMapLock unlock finally deviceMapLock releaseRef if tryLbProvisioning List ExternalLoadBalancerDeviceVO providerLbDevices _externalLoadBalancerDeviceDao listByProviderAndDeviceAllocationState physicalNetworkId provider LBDeviceAllocationState Provider if providerLbDevices null providerLbDevices isEmpty for ExternalLoadBalancerDeviceVO lbProviderDevice providerLbDevices if lbProviderDevice getState LBDeviceState Enabled DataCenterIpAddressVO dcPrivateIp _dcDao allocatePrivateIpAddress guestConfig getDataCenterId lbProviderDevice getUuid if dcPrivateIp null throw new InsufficientNetworkCapacityException guestConfig getDataCenterId DataCenter class guestConfig getDataCenterId Pod pod _podDao findById dcPrivateIp getPodId String lbIP dcPrivateIp getIpAddress String netmask NetUtils getCidrNetmask pod getCidrSize
finally deviceMapLock releaseRef if tryLbProvisioning List ExternalLoadBalancerDeviceVO providerLbDevices _externalLoadBalancerDeviceDao listByProviderAndDeviceAllocationState physicalNetworkId provider LBDeviceAllocationState Provider if providerLbDevices null providerLbDevices isEmpty for ExternalLoadBalancerDeviceVO lbProviderDevice providerLbDevices if lbProviderDevice getState LBDeviceState Enabled DataCenterIpAddressVO dcPrivateIp _dcDao allocatePrivateIpAddress guestConfig getDataCenterId lbProviderDevice getUuid if dcPrivateIp null throw new InsufficientNetworkCapacityException guestConfig getDataCenterId DataCenter class guestConfig getDataCenterId Pod pod _podDao findById dcPrivateIp getPodId String lbIP dcPrivateIp getIpAddress String netmask NetUtils getCidrNetmask pod getCidrSize String gateway pod getGateway CreateLoadBalancerApplianceCommand lbProvisionCmd new CreateLoadBalancerApplianceCommand lbIP netmask gateway
return lbDevice else return null if lbDevice null Host lbHost _hostDao findById lbDevice getHostId String lbIP lbHost getPrivateIpAddress DestroyLoadBalancerApplianceCommand lbDeleteCmd new DestroyLoadBalancerApplianceCommand lbIP DestroyLoadBalancerApplianceAnswer answer null try answer DestroyLoadBalancerApplianceAnswer _agentMgr easySend lbDevice getParentHostId lbDeleteCmd if answer null answer getResult s_logger warn guestConfig getId answer null answer getDetails catch Exception e s_logger warn guestConfig getId e getMessage
DestroyLoadBalancerApplianceCommand lbDeleteCmd new DestroyLoadBalancerApplianceCommand lbIP DestroyLoadBalancerApplianceAnswer answer null try answer DestroyLoadBalancerApplianceAnswer _agentMgr easySend lbDevice getParentHostId lbDeleteCmd if answer null answer getResult s_logger warn guestConfig getId answer null answer getDetails catch Exception e s_logger warn guestConfig getId e getMessage if s_logger isDebugEnabled s_logger debug guestConfig getId deviceMapLock unlock deleteExternalLoadBalancer lbHost getId _dcDao releasePrivateIpAddress lbHost getPrivateIpAddress guestConfig getDataCenterId null DetailVO publicIpDetail _hostDetailDao findDetail lbHost getId IPAddressVO ipVo _ipAddressDao findByIpAndDcId guestConfig getDataCenterId publicIpDetail toString
answer DestroyLoadBalancerApplianceAnswer _agentMgr easySend lbDevice getParentHostId lbDeleteCmd if answer null answer getResult s_logger warn guestConfig getId answer null answer getDetails catch Exception e s_logger warn guestConfig getId e getMessage if s_logger isDebugEnabled s_logger debug guestConfig getId deviceMapLock unlock deleteExternalLoadBalancer lbHost getId _dcDao releasePrivateIpAddress lbHost getPrivateIpAddress guestConfig getDataCenterId null DetailVO publicIpDetail _hostDetailDao findDetail lbHost getId IPAddressVO ipVo _ipAddressDao findByIpAndDcId guestConfig getDataCenterId publicIpDetail toString _ipAddrMgr disassociatePublicIpAddress ipVo getId _accountMgr getSystemUser getId _accountMgr getSystemAccount else deviceMapLock unlock
Nic loadBalancingIpNic null MappingNic nic new MappingNic nic setState MappingState Unchanged if revoked if mapping null String loadBalancingIpAddress existedGuestIp if loadBalancingIpAddress null if network getGuestType Network GuestType Isolated loadBalancingIpAddress _ipAddrMgr acquireGuestIpAddress network null else if network getGuestType Network GuestType Shared try PublicIp directIp _ipAddrMgr assignPublicIpAddress network getDataCenterId null _accountDao findById network getAccountId VlanType DirectAttached network getId null true false loadBalancingIpAddress directIp getAddress addr catch InsufficientCapacityException capException String msg
if mapping null String loadBalancingIpAddress existedGuestIp if loadBalancingIpAddress null if network getGuestType Network GuestType Isolated loadBalancingIpAddress _ipAddrMgr acquireGuestIpAddress network null else if network getGuestType Network GuestType Shared try PublicIp directIp _ipAddrMgr assignPublicIpAddress network getDataCenterId null _accountDao findById network getAccountId VlanType DirectAttached network getId null true false loadBalancingIpAddress directIp getAddress addr catch InsufficientCapacityException capException String msg s_logger error msg throw new ResourceUnavailableException msg DataCenter class network getDataCenterId if loadBalancingIpAddress null String msg
DataCenterVO zone _dcDao findById zoneId if loadBalancingRules null loadBalancingRules isEmpty return true HostVO externalLoadBalancer null if isNccServiceProvider network externalLoadBalancer getNetScalerControlCenterForNetwork network else ExternalLoadBalancerDeviceVO lbDeviceVO getExternalLoadBalancerForNetwork network if lbDeviceVO null s_logger warn return true else externalLoadBalancer _hostDao findById lbDeviceVO getHostId boolean externalLoadBalancerIsInline _networkMgr isNetworkInlineMode network if network getState Network State Allocated
protected IpDeployer getIpDeployerForInlineMode Network network List Provider providers _networkMgr getProvidersForServiceInNetwork network Service Firewall if providers null
DataCenterVO zone _dcDao findById zoneId if loadBalancingRules null loadBalancingRules isEmpty return null HostVO externalLoadBalancer null if isNccServiceProvider network externalLoadBalancer getNetScalerControlCenterForNetwork network else ExternalLoadBalancerDeviceVO lbDeviceVO getExternalLoadBalancerForNetwork network if lbDeviceVO null s_logger warn return null else externalLoadBalancer _hostDao findById lbDeviceVO getHostId boolean externalLoadBalancerIsInline _networkMgr isNetworkInlineMode network if network getState Network State Allocated
protected boolean cleanupIpResources long ipId long userId Account caller boolean success true try
catch ResourceUnavailableException e s_logger warn ipId e success false try s_logger debug Purpose PortForwarding Purpose StaticNat ipId if _rulesMgr revokeAllPFAndStaticNatRulesForIp ipId userId caller s_logger warn ipId success false catch ResourceUnavailableException e s_logger warn ipId e success false s_logger debug Purpose LoadBalancing ipId if _lbMgr removeAllLoadBalanacersForIp ipId caller userId s_logger warn ipId success false
if s_logger isDebugEnabled s_logger debug addrId ip isSourceNat if ip getAssociatedWithNetworkId null Network network _networksDao findById ip getAssociatedWithNetworkId try if applyIpAssociations network rulesContinueOnErrFlag s_logger warn network success false catch ResourceUnavailableException e throw new CloudRuntimeException e else if ip getState IpAddress State Releasing _ipAddressDao unassignIpAddress ip getId if success if ip isPortable
Override public void doInTransactionWithoutResult TransactionStatus status Account owner _accountMgr getAccount addr getAllocatedToAccountId if _ipAddressDao lockRow addr getId true null final IPAddressVO userIp _ipAddressDao findById addr getId if userIp getState IpAddress State Allocating addr getState IpAddress State Free addr setState IpAddress State Allocated if _ipAddressDao update addr getId addr if owner getAccountId Account ACCOUNT_ID_SYSTEM VlanVO vlan _vlanDao findById addr getVlanId String guestType vlan getVlanType toString if isIpDedicated addr UsageEventUtils publishUsageEvent EventTypes EVENT_NET_IP_ASSIGN owner getId addr getDataCenterId addr getId addr getAddress toString addr isSourceNat guestType addr getSystem addr getClass getName addr getUuid if updateIpResourceCount addr _resourceLimitMgr incrementResourceCount owner getId ResourceType public_ip else
if _ipAddressDao lockRow addr getId true null final IPAddressVO userIp _ipAddressDao findById addr getId if userIp getState IpAddress State Allocating addr getState IpAddress State Free addr setState IpAddress State Allocated if _ipAddressDao update addr getId addr if owner getAccountId Account ACCOUNT_ID_SYSTEM VlanVO vlan _vlanDao findById addr getVlanId String guestType vlan getVlanType toString if isIpDedicated addr UsageEventUtils publishUsageEvent EventTypes EVENT_NET_IP_ASSIGN owner getId addr getDataCenterId addr getId addr getAddress toString addr isSourceNat guestType addr getSystem addr getClass getName addr getUuid if updateIpResourceCount addr _resourceLimitMgr incrementResourceCount owner getId ResourceType public_ip else s_logger error addr getId addr getAddress else
if owner null ConcurrentOperationException ex new ConcurrentOperationException throw ex if s_logger isDebugEnabled s_logger debug ownerId boolean displayIp true if guestNtwkId null Network ntwk _networksDao findById guestNtwkId displayIp ntwk getDisplayNetwork else if vpcId null VpcVO vpc _vpcDao findById vpcId displayIp vpc isDisplay return fetchNewPublicIp dcId null null owner VlanType VirtualNetwork guestNtwkId isSourceNat true null false vpcId displayIp false if ip getState State Allocated
s_logger debug ownerId boolean displayIp true if guestNtwkId null Network ntwk _networksDao findById guestNtwkId displayIp ntwk getDisplayNetwork else if vpcId null VpcVO vpc _vpcDao findById vpcId displayIp vpc isDisplay return fetchNewPublicIp dcId null null owner VlanType VirtualNetwork guestNtwkId isSourceNat true null false vpcId displayIp false if ip getState State Allocated s_logger error ip getId ip getAddress return ip finally if owner null
if guestNtwkId null Network ntwk _networksDao findById guestNtwkId displayIp ntwk getDisplayNetwork else if vpcId null VpcVO vpc _vpcDao findById vpcId displayIp vpc isDisplay return fetchNewPublicIp dcId null null owner VlanType VirtualNetwork guestNtwkId isSourceNat true null false vpcId displayIp false if ip getState State Allocated s_logger error ip getId ip getAddress return ip finally if owner null if s_logger isDebugEnabled s_logger debug ownerId
if element IpDeployingRequester throw new CloudRuntimeException element deployer IpDeployingRequester element getIpDeployer network if deployer null throw new CloudRuntimeException element Set Service services new HashSet Service for PublicIpAddress ip ips if ipToServices containsKey ip continue services addAll ipToServices get ip deployer applyIps network ips services catch ResourceUnavailableException e success false if continueOnError throw e
s_logger debug callerUserId ipOwner getId accountToLock _accountDao acquireInLockTable ipOwner getId if accountToLock null s_logger warn ipOwner getId throw new ConcurrentOperationException if s_logger isDebugEnabled s_logger debug ip Transaction execute new TransactionCallbackWithException PublicIp InsufficientAddressCapacityException Override public PublicIp doInTransaction TransactionStatus status throws InsufficientAddressCapacityException PublicIp ip fetchNewPublicIp zone getId null null ipOwner vlanType null false assign ipaddress isSystem null displayIp false if ip null InsufficientAddressCapacityException ex new InsufficientAddressCapacityException DataCenter class zone getId ex addProxyObject ApiDBUtils findZoneById zone getId getUuid throw ex CallContext current setEventDetails ip getId
if s_logger isDebugEnabled s_logger debug ip Transaction execute new TransactionCallbackWithException PublicIp InsufficientAddressCapacityException Override public PublicIp doInTransaction TransactionStatus status throws InsufficientAddressCapacityException PublicIp ip fetchNewPublicIp zone getId null null ipOwner vlanType null false assign ipaddress isSystem null displayIp false if ip null InsufficientAddressCapacityException ex new InsufficientAddressCapacityException DataCenter class zone getId ex addProxyObject ApiDBUtils findZoneById zone getId getUuid throw ex CallContext current setEventDetails ip getId Ip ipAddress ip getAddress s_logger debug ipAddress ipOwner getId zone getId return ip finally
throw new InvalidParameterValueException DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Advanced if network getGuestType Network GuestType Shared if isSharedNetworkOfferingWithServices network getNetworkOfferingId _accountMgr checkAccess CallContext current getCallingAccount AccessType UseEntry false network else throw new InvalidParameterValueException else _accountMgr checkAccess caller null true ipToAssoc owner _accountMgr getAccount ipToAssoc getAllocatedToAccountId else s_logger debug ipId return null if ipToAssoc getAssociatedWithNetworkId null
_accountMgr checkAccess CallContext current getCallingAccount AccessType UseEntry false network else throw new InvalidParameterValueException else _accountMgr checkAccess caller null true ipToAssoc owner _accountMgr getAccount ipToAssoc getAllocatedToAccountId else s_logger debug ipId return null if ipToAssoc getAssociatedWithNetworkId null s_logger debug ipToAssoc networkId return ipToAssoc Network network _networksDao findById networkId if network null _accountMgr checkAccess owner AccessType UseEntry false network
Network network _networksDao findById networkId if network null _accountMgr checkAccess owner AccessType UseEntry false network else s_logger debug ipId return null DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if network getTrafficType TrafficType Guest throw new InvalidParameterValueException TrafficType Guest if network getAccountId owner getId if zone getNetworkType NetworkType Basic zone getNetworkType NetworkType Advanced network getGuestType Network GuestType Shared throw new InvalidParameterValueException if zone getNetworkType NetworkType Advanced if network getGuestType GuestType Isolated _networkModel areServicesSupportedInNetwork network getId Service SourceNat if releaseOnFailure ipToAssoc null
if network getTrafficType TrafficType Guest throw new InvalidParameterValueException TrafficType Guest if network getAccountId owner getId if zone getNetworkType NetworkType Basic zone getNetworkType NetworkType Advanced network getGuestType Network GuestType Shared throw new InvalidParameterValueException if zone getNetworkType NetworkType Advanced if network getGuestType GuestType Isolated _networkModel areServicesSupportedInNetwork network getId Service SourceNat if releaseOnFailure ipToAssoc null s_logger warn ipToAssoc _ipAddressDao unassignIpAddress ipToAssoc getId throw new InvalidParameterValueException NetworkType Advanced GuestType Isolated Service SourceNat getName if network getGuestType GuestType Shared isSharedNetworkOfferingWithServices network getNetworkOfferingId if releaseOnFailure ipToAssoc null s_logger warn ipToAssoc _ipAddressDao unassignIpAddress ipToAssoc getId
IPAddressVO ipToAssoc _ipAddressDao findById ipId if ipToAssoc null if ipToAssoc getAssociatedWithNetworkId null throw new InvalidParameterValueException ipToAssoc if ipToAssoc getAssociatedWithNetworkId network getId throw new InvalidParameterValueException ipToAssoc networkId DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if zone getNetworkType NetworkType Advanced if network getGuestType Network GuestType Shared assert isSharedNetworkOfferingWithServices network getNetworkOfferingId _accountMgr checkAccess CallContext current getCallingAccount AccessType UseEntry false network else _accountMgr checkAccess caller null true ipToAssoc owner _accountMgr getAccount ipToAssoc getAllocatedToAccountId else
else s_logger debug ipId return null DataCenter zone _entityMgr findById DataCenter class network getDataCenterId if network getAccountId owner getId if zone getNetworkType NetworkType Basic zone getNetworkType NetworkType Advanced network getGuestType Network GuestType Shared throw new InvalidParameterValueException List PublicIpAddress ipList new ArrayList PublicIpAddress PublicIp publicIp PublicIp createFromAddrAndVlan ipToAssoc _vlanDao findById ipToAssoc getVlanId ipList add publicIp Map PublicIpAddress Set Service ipToServices _networkModel getIpToServices ipList false true if ipToServices isEmpty Set Service services ipToServices get publicIp if services null services isEmpty throw new InvalidParameterValueException ipToAssoc networkId
else addr setSourceNat false addr setAssociatedWithNetworkId guestNetwork getId addr setVpcId guestNetwork getVpcId addr setAllocatedTime new Date addr setAllocatedInDomainId owner getDomainId addr setAllocatedToAccountId owner getId addr setSystem false addr setState IpAddress State Allocating markPublicIpAsAllocated addr return new Ternary Boolean List NetworkOfferingVO Network createNetwork requiredOfferings guestNetwork catch Exception e1 ExceptionUtil rethrowRuntime e1 ExceptionUtil rethrow e1 InsufficientCapacityException class
Override DB public void allocateDirectIp final NicProfile nic final DataCenter dc final VirtualMachineProfile vm final Network network final String requestedIpv4 final String requestedIpv6 throws InsufficientVirtualNetworkCapacityException InsufficientAddressCapacityException Transaction execute new TransactionCallbackWithExceptionNoReturn InsufficientAddressCapacityException Override public void doInTransactionWithoutResult TransactionStatus status throws InsufficientAddressCapacityException boolean ipv4 false if network getGateway null if nic getIPv4Address null PublicIp ip null if requestedIpv4 null vm getType VirtualMachine Type DomainRouter Nic placeholderNic _networkModel getPlaceholderNicForRouter network null if placeholderNic null IPAddressVO userIp _ipAddressDao findByIpAndSourceNetworkId network getId placeholderNic getIPv4Address ip PublicIp createFromAddrAndVlan userIp _vlanDao findById userIp getVlanId
Override DB public void allocateNicValues final NicProfile nic final DataCenter dc final VirtualMachineProfile vm final Network network final String requestedIpv4 final String requestedIpv6 throws InsufficientVirtualNetworkCapacityException InsufficientAddressCapacityException Transaction execute new TransactionCallbackWithExceptionNoReturn InsufficientAddressCapacityException Override public void doInTransactionWithoutResult TransactionStatus status throws InsufficientAddressCapacityException boolean ipv4 false if network getGateway null if nic getIPv4Address null ipv4 true if requestedIpv4 null vm getType VirtualMachine Type DomainRouter
Override public void setNicIp6Address final NicProfile nic final DataCenter dc final Network network if network getIp6Gateway null if nic getIPv6Address null
Override public void setNicIp6Address final NicProfile nic final DataCenter dc final Network network if network getIp6Gateway null if nic getIPv6Address null s_logger debug network getIp6Cidr network nic setIPv6Cidr network getIp6Cidr nic setIPv6Gateway network getIp6Gateway IPv6Address ipv6addr NetUtils EUI64Address network getIp6Cidr nic getMacAddress
Override public long makeCopyOfNetwork Network network NetworkOffering networkOffering Long vpcId if s_logger isDebugEnabled
networkCopy nw networkCopyId networkCopy getId else networkCopyId networks get getId NetworkVO originalNetwork _networksDao findById originalNetworkId originalNetwork setRelated networkCopyId _networksDao update originalNetworkId originalNetwork NetworkVO copiedNetwork _networksDao findById networkCopyId copiedNetwork setRelated originalNetworkId copiedNetwork setDisplayNetwork false copiedNetwork setBroadcastUri network getBroadcastUri copiedNetwork setState network getState _networksDao update networkCopyId copiedNetwork copyNetworkDetails originalNetworkId networkCopyId copyFirewallRulesToNewNetwork network networkCopyId
Override public Long makeCopyOfVpc long vpcId long vpcOfferingId VpcVO vpc _vpcDao findById vpcId if s_logger isDebugEnabled
throw ex Vpc copyOfVpc long copyOfVpcId try copyOfVpc _vpcService createVpc vpc getZoneId vpcOfferingId vpc getAccountId vpc getName vpc getDisplayText vpc getCidr vpc getNetworkDomain vpc isDisplay copyOfVpcId copyOfVpc getId _resourceTagDao persist new ResourceTagVO MIGRATION Long toString vpcId vpc getAccountId vpc getDomainId copyOfVpcId ResourceTag ResourceObjectType Vpc null vpc getUuid VpcVO copyVpcVO _vpcDao findById copyOfVpcId vpc setDisplay false swapUuids vpc copyVpcVO reassignACLRulesToNewVpc vpcId copyOfVpcId reassignPublicIpsToNewVpc vpcId copyOfVpc copyVpcDetails vpcId copyOfVpcId reassignGatewayToNewVpc vpcId copyOfVpcId copyVpcResourceTagsToNewVpc vpcId copyOfVpcId
private void copyFirewallRulesToNewNetwork Network srcNetwork long dstNetworkId List FirewallRuleVO firewallRules _firewallDao listByNetworkPurposeTrafficType srcNetwork getId FirewallRule Purpose Firewall FirewallRule TrafficType Egress firewallRules addAll _firewallDao listByNetworkPurposeTrafficType srcNetwork getId FirewallRule Purpose Firewall FirewallRule TrafficType Ingress if s_logger isDebugEnabled
final VMNetworkMapVO vno new VMNetworkMapVO vmVO getId networkInNewPhysicalNet getId _vmNetworkMapDao persist vno NicVO newNic _nicDao findById nicProfile getId copyNicDetails originalNic getId newNic getId moveServices originalNic newNic if originalNic getState Nic State Reserved final VirtualMachine vm vmProfile getVirtualMachine final Host host _hostDao findById vm getHostId final DeployDestination dest new DeployDestination dc null null host try nicProfile _networkMgr prepareNic vmProfile dest context nicProfile getId networkInNewPhysicalNet _itMgr replugNic networkInNewPhysicalNet _itMgr toNicTO nicProfile host getHypervisorType _itMgr toVmTO vmProfile context dest catch ResourceUnavailableException InsufficientCapacityException e throw new CloudRuntimeException e markAsNonDefault originalNic
Override public UserDataServiceProvider getUserDataUpdateProvider Network network String userDataProvider _ntwkSrvcDao getProviderForServiceInNetwork network getId Service UserData if userDataProvider null
String label null switch hypervisorType case XenServer label mgmtTraffic getXenNetworkLabel break case KVM label mgmtTraffic getKvmNetworkLabel break case VMware label mgmtTraffic getVmwareNetworkLabel break case Hyperv label mgmtTraffic getHypervNetworkLabel break case Ovm3 label mgmtTraffic getOvm3NetworkLabel break return label catch Exception ex if s_logger isDebugEnabled
String label null switch hypervisorType case XenServer label storageTraffic getXenNetworkLabel break case KVM label storageTraffic getKvmNetworkLabel break case VMware label storageTraffic getVmwareNetworkLabel break case Hyperv label storageTraffic getHypervNetworkLabel break case Ovm3 label storageTraffic getOvm3NetworkLabel break return label catch Exception ex if s_logger isDebugEnabled
String label null switch hypervisorType case XenServer label publicTraffic getXenNetworkLabel break case KVM label publicTraffic getKvmNetworkLabel break case VMware label publicTraffic getVmwareNetworkLabel break case Hyperv label publicTraffic getHypervNetworkLabel break case Ovm3 label publicTraffic getOvm3NetworkLabel break return label catch Exception ex if s_logger isDebugEnabled
String label null switch hypervisorType case XenServer label guestTraffic getXenNetworkLabel break case KVM label guestTraffic getKvmNetworkLabel break case VMware label guestTraffic getVmwareNetworkLabel break case Hyperv label guestTraffic getHypervNetworkLabel break case Ovm3 label guestTraffic getOvm3NetworkLabel break return label catch Exception ex if s_logger isDebugEnabled
boolean isServiceEnabledInNetwork long physicalNetworkId long networkId Service service if areServicesSupportedInNetwork networkId service
Override public boolean start for NetworkElement element networkElements Map Service Map Capability String capabilities element getCapabilities Provider implementedProvider element getProvider if implementedProvider null if s_providerToNetworkElementMap containsKey implementedProvider getName
Override ActionEvent eventType EventTypes EVENT_NET_IP_ASSIGN eventDescription create true public IpAddress allocateIP Account ipOwner long zoneId Long networkId Boolean displayIp String ipaddress throws ResourceAllocationException InsufficientAddressCapacityException ConcurrentOperationException Account caller CallContext current getCallingAccount long callerUserId CallContext current getCallingUserId DataCenter zone _entityMgr findById DataCenter class zoneId if networkId null Network network _networksDao findById networkId if network null throw new InvalidParameterValueException if network getGuestType Network GuestType Shared if zone null throw new InvalidParameterValueException if zone getNetworkType NetworkType Advanced if isSharedNetworkOfferingWithServices network getNetworkOfferingId _accountMgr checkAccess caller AccessType UseEntry false network if s_logger isDebugEnabled
long callerUserId CallContext current getCallingUserId DataCenter zone _entityMgr findById DataCenter class zoneId if networkId null vpcId null networkId null vpcId null throw new InvalidParameterValueException if networkId null Network network _networksDao findById networkId if network null throw new InvalidParameterValueException if network getGuestType Network GuestType Shared if zone null throw new InvalidParameterValueException if zone getNetworkType NetworkType Advanced if isSharedNetworkOfferingWithServices network getNetworkOfferingId _accountMgr checkAccess caller AccessType UseEntry false network if s_logger isDebugEnabled
throw new InvalidParameterValueException nicId if nicVO getVmType VirtualMachine Type User throw new InvalidParameterValueException String format nicVO getUuid VirtualMachine vm _userVmDao findById nicVO getInstanceId if vm null throw new InvalidParameterValueException String format nicVO getUuid final long networkId nicVO getNetworkId final Account ipOwner _accountMgr getAccount vm getAccountId _accountMgr checkAccess caller null true vm Network network _networksDao findById networkId if network null throw new InvalidParameterValueException int maxAllowedIpsPerNic NumbersUtil parseInt _configDao getValue Config MaxNumberOfSecondaryIPsPerNIC key Long nicWiseIpCount _nicSecondaryIpDao countByNicId nicId if nicWiseIpCount intValue maxAllowedIpsPerNic
Override DB ActionEvent eventType EventTypes EVENT_NIC_SECONDARY_IP_UNASSIGN eventDescription async true public boolean releaseSecondaryIpFromNic long ipAddressId Account caller CallContext current getCallingAccount boolean success false NicSecondaryIpVO secIpVO _nicSecondaryIpDao findById ipAddressId if secIpVO null throw new InvalidParameterValueException VirtualMachine vm _userVmDao findById secIpVO getVmId if vm null throw new InvalidParameterValueException _accountMgr checkAccess caller null true vm Network network _networksDao findById secIpVO getNetworkId if network null throw new InvalidParameterValueException NetworkOfferingVO ntwkOff _networkOfferingDao findById network getNetworkOfferingId Long nicId secIpVO getNicId
throw new InvalidParameterValueException _accountMgr checkAccess caller null true vm Network network _networksDao findById secIpVO getNetworkId if network null throw new InvalidParameterValueException NetworkOfferingVO ntwkOff _networkOfferingDao findById network getNetworkOfferingId Long nicId secIpVO getNicId s_logger debug ipAddressId nicId List NicSecondaryIpVO ipList _nicSecondaryIpDao listByNicId nicId boolean lastIp false if ipList size lastIp true DataCenter dc _dcDao findById network getDataCenterId if dc null throw new InvalidParameterValueException
NetworkOfferingVO ntwkOff _networkOfferingDao findById network getNetworkOfferingId Long nicId secIpVO getNicId s_logger debug ipAddressId nicId List NicSecondaryIpVO ipList _nicSecondaryIpDao listByNicId nicId boolean lastIp false if ipList size lastIp true DataCenter dc _dcDao findById network getDataCenterId if dc null throw new InvalidParameterValueException s_logger debug secIpVO getIp4Address if dc getNetworkType NetworkType Advanced network getGuestType Network GuestType Isolated String secondaryIp secIpVO getIp4Address List FirewallRuleVO fwRulesList _firewallDao listByNetworkAndPurpose network getId Purpose PortForwarding if fwRulesList size
List NicSecondaryIpVO ipList _nicSecondaryIpDao listByNicId nicId boolean lastIp false if ipList size lastIp true DataCenter dc _dcDao findById network getDataCenterId if dc null throw new InvalidParameterValueException s_logger debug secIpVO getIp4Address if dc getNetworkType NetworkType Advanced network getGuestType Network GuestType Isolated String secondaryIp secIpVO getIp4Address List FirewallRuleVO fwRulesList _firewallDao listByNetworkAndPurpose network getId Purpose PortForwarding if fwRulesList size for FirewallRuleVO rule fwRulesList if _portForwardingDao findByIdAndIp rule getId secondaryIp null s_logger debug secondaryIp
lastIp true DataCenter dc _dcDao findById network getDataCenterId if dc null throw new InvalidParameterValueException s_logger debug secIpVO getIp4Address if dc getNetworkType NetworkType Advanced network getGuestType Network GuestType Isolated String secondaryIp secIpVO getIp4Address List FirewallRuleVO fwRulesList _firewallDao listByNetworkAndPurpose network getId Purpose PortForwarding if fwRulesList size for FirewallRuleVO rule fwRulesList if _portForwardingDao findByIdAndIp rule getId secondaryIp null s_logger debug secondaryIp throw new InvalidParameterValueException secondaryIp IPAddressVO publicIpVO _ipAddressDao findByIpAndNetworkId secIpVO getNetworkId secondaryIp if publicIpVO null
isDomainSpecific true else if subdomainAccess null throw new InvalidParameterValueException if aclType ACLType Domain owner _accountDao findById Account ACCOUNT_ID_SYSTEM if AllowDuplicateNetworkName valueIn owner getAccountId List NetworkVO existingNetwork _networksDao listByAccountIdNetworkName owner getId name if existingNetwork isEmpty throw new InvalidParameterValueException owner getAccountName boolean ipv4 true ipv6 false if startIP null ipv4 true if startIPv6 null ipv6 true if gateway null
if network null throwInvalidIdException networkId toString if network getState Network State Implemented network getState Network State Setup throw new InvalidParameterValueException Network State Implemented Network State Setup if network getBroadcastDomainType BroadcastDomainType Lswitch throw new InvalidParameterException Account callerAccount _accountMgr getActiveAccountById user getAccountId _accountMgr checkAccess callerAccount null true network if network isRedundant makeRedundant network setRedundant true if _networksDao update network getId network throw new CloudRuntimeException cleanup true boolean success _networkMgr restartNetwork networkId callerAccount user cleanup if success
throw new InvalidParameterValueException NetworkType Basic if network getGuestType GuestType Isolated throw new InvalidParameterValueException GuestType Isolated if networkOfferingChanged throw new InvalidParameterValueException if network getState Network State Implemented throw new InvalidParameterValueException Network State Implemented network getState if NetUtils isValidIp4Cidr guestVmCidr throw new InvalidParameterValueException if NetUtils validateGuestCidr guestVmCidr throw new InvalidParameterValueException if networkCidr null if NetUtils isNetworkAWithinNetworkB guestVmCidr networkCidr throw new InvalidParameterValueException networkCidr else
String guestVmCidrPair guestVmCidr split Long size Long valueOf guestVmCidrPair List NicVO nicsPresent _nicDao listByNetworkId networkId String cidrIpRange NetUtils getIpRangeFromCidr guestVmCidrPair size s_logger info cidrIpRange cidrIpRange long startIp NetUtils ip2Long cidrIpRange long endIp NetUtils ip2Long cidrIpRange long range endIp startIp s_logger info range for NicVO nic nicsPresent long nicIp NetUtils ip2Long nic getIPv4Address if nicIp startIp nicIp endIp nic getState Nic State Deallocating throw new InvalidParameterValueException nic getIPv4Address if network getNetworkCidr null if NetUtils isSameIpRange guestVmCidr network getCidr guestVmCidr equals network getCidr
if servicesNotInNewOffering null servicesNotInNewOffering isEmpty _networkMgr cleanupConfigForServicesInNetwork servicesNotInNewOffering network catch Throwable e s_logger debug e getMessage boolean validStateToShutdown network getState Network State Implemented network getState Network State Setup network getState Network State Allocated try do if restartNetwork if validStateToShutdown if changeCidr s_logger debug networkId if _networkMgr shutdownNetworkElementsAndResources context true network s_logger warn network CloudRuntimeException ex new CloudRuntimeException ex addProxyObject network getUuid
if resume Network networkInNewPhysicalNet network networkCopy new NetworkCopy network getRelated networkInNewPhysicalNet if networkInNewPhysicalNet getNetworkOfferingId newNtwkOff getId throw new InvalidParameterValueException newNtwkOff getUuid else networkCopy Transaction execute TransactionCallback NetworkCopy status migrateNetworkInDb network oldNtwkOff newNtwkOff oldVpcId newVpcId newPhysicalNetworkId Long networkIdInOldPhysicalNet networkCopy getNetworkIdInOldPhysicalNet Network networkInNewPhysicalNet networkCopy getNetworkInNewPhysicalNet ReservationContext context new ReservationContextImpl null null callerUser callerAccount DataCenter zone _dcDao findById network getDataCenterId NetworkVO networkInOldPhysNet _networksDao findById networkIdInOldPhysicalNet boolean shouldImplement newNtwkOff isPersistent networkInOldPhysNet getState Network State Implemented networkInNewPhysicalNet getState Network State Implemented if shouldImplement DeployDestination dest new DeployDestination zone null null null
protected boolean canUpgrade Network network long oldNetworkOfferingId long newNetworkOfferingId NetworkOffering oldNetworkOffering _networkOfferingDao findByIdIncludingRemoved oldNetworkOfferingId NetworkOffering newNetworkOffering _networkOfferingDao findById newNetworkOfferingId if areServicesSupportedByNetworkOffering oldNetworkOfferingId Service SecurityGroup areServicesSupportedByNetworkOffering newNetworkOfferingId Service SecurityGroup
tempVnets removeAll vnetsInDb if removeVnets null removeVnets size vnetsInDb removeAll removeVnets if tempVnets size addVnets new ArrayList String addVnets addAll tempVnets vnetsInDb addAll tempVnets if vnetsInDb size comaSeperatedStingOfVnetRanges generateVnetString new ArrayList String vnetsInDb network setVnet comaSeperatedStingOfVnetRanges final List String addVnetsFinal addVnets final List String removeVnetsFinal removeVnets Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status if addVnetsFinal null
if removeVnets null removeVnets size vnetsInDb removeAll removeVnets if tempVnets size addVnets new ArrayList String addVnets addAll tempVnets vnetsInDb addAll tempVnets if vnetsInDb size comaSeperatedStingOfVnetRanges generateVnetString new ArrayList String vnetsInDb network setVnet comaSeperatedStingOfVnetRanges final List String addVnetsFinal addVnets final List String removeVnetsFinal removeVnets Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status if addVnetsFinal null s_logger debug addVnetsFinal toString network getId network getDataCenterId
private List Pair Integer Integer validateVlanRange PhysicalNetworkVO network String listOfRanges Integer StartVnet Integer EndVnet List Pair Integer Integer vlanTokens new ArrayList Pair Integer Integer for String vlanRange listOfRanges String VnetRange vlanRange split long minVnet MIN_VLAN_ID long maxVnet MAX_VLAN_ID
Integer StartVnet Integer EndVnet List Pair Integer Integer vlanTokens new ArrayList Pair Integer Integer for String vlanRange listOfRanges String VnetRange vlanRange split long minVnet MIN_VLAN_ID long maxVnet MAX_VLAN_ID s_logger debug network getIsolationMethods if network getIsolationMethods contains minVnet MIN_GRE_KEY maxVnet MAX_GRE_KEY else if network getIsolationMethods contains minVnet MIN_VXLAN_VNI maxVnet MAX_VXLAN_VNI for String vnet VnetRange
long minVnet MIN_VLAN_ID long maxVnet MAX_VLAN_ID s_logger debug network getIsolationMethods if network getIsolationMethods contains minVnet MIN_GRE_KEY maxVnet MAX_GRE_KEY else if network getIsolationMethods contains minVnet MIN_VXLAN_VNI maxVnet MAX_VXLAN_VNI for String vnet VnetRange s_logger debug vnet network getDataCenterId List DataCenterVnetVO vnis _datacneterVnet findVnet network getDataCenterId vnet if vnis null vnis isEmpty for DataCenterVnetVO vni vnis if vni getPhysicalNetworkId network getId
PhysicalNetworkServiceProviderVO provider _pNSPDao findById id if provider null throw new InvalidParameterValueException id NetworkElement element _networkModel getElementImplementingProvider provider getProviderName if element null throw new InvalidParameterValueException provider getProviderName PhysicalNetworkServiceProvider State state null if stateStr null stateStr isEmpty try state PhysicalNetworkServiceProvider State valueOf stateStr catch IllegalArgumentException ex throw new InvalidParameterValueException stateStr boolean update false if state null if s_logger isDebugEnabled
if NetUtils isValidIp4Netmask netmask throw new InvalidParameterValueException final String cidr NetUtils ipAndNetMaskToCidr gateway netmask URI uri BroadcastDomainType fromString broadcastUriString final String uriString uri toString BroadcastDomainType tiep BroadcastDomainType getSchemeValue uri if tiep BroadcastDomainType Vlan tiep BroadcastDomainType Lswitch throw new InvalidParameterValueException broadcastUriString final NetworkOfferingVO ntwkOffFinal ntwkOff try return Transaction execute new TransactionCallbackWithException Network Exception Override public Network doInTransaction TransactionStatus status throws ResourceAllocationException InsufficientCapacityException DataCenterVO dc _dcDao lockRow pNtwk getDataCenterId true Network privateNetwork _networksDao getPrivateNetwork uriString cidr networkOwnerId pNtwk getDataCenterId networkOfferingId vpcId if privateNetwork null
return Transaction execute new TransactionCallbackWithException Network Exception Override public Network doInTransaction TransactionStatus status throws ResourceAllocationException InsufficientCapacityException DataCenterVO dc _dcDao lockRow pNtwk getDataCenterId true Network privateNetwork _networksDao getPrivateNetwork uriString cidr networkOwnerId pNtwk getDataCenterId networkOfferingId vpcId if privateNetwork null privateNetwork _networkMgr createPrivateNetwork ntwkOffFinal getId networkName displayText gateway cidr uriString bypassVlanOverlapCheck owner pNtwk vpcId if privateNetwork null s_logger debug privateNetwork else throw new CloudRuntimeException else s_logger debug privateNetwork throw new InvalidParameterValueException uriString cidr vpcId _entityMgr findById DataCenter class pNtwk getDataCenterId getName if vpcId null PrivateIpVO privateIp _privateIpDao findByIpAndSourceNetworkIdAndVpcId privateNetwork getId startIp vpcId
Override public Host addTrafficMonitor AddTrafficMonitorCmd cmd long zoneId cmd getZoneId DataCenterVO zone _dcDao findById zoneId String zoneName if zone null throw new InvalidParameterValueException zoneId else zoneName zone getName List HostVO trafficMonitorsInZone _resourceMgr listAllHostsInOneZoneByType Host Type TrafficMonitor zoneId if trafficMonitorsInZone size throw new InvalidParameterValueException zoneName URI uri try uri new URI cmd getUrl catch Exception e
DB public PortProfileVO addPortProfile String portProfName long vsmId int vlanId PortType pType BindingType bType if _portProfileDao findByName portProfName null
DB public PortProfileVO addPortProfile String portProfName long vsmId int lowVlanId int highVlanId PortType pType BindingType bType PortProfileVO portProfileObj portProfileObj _portProfileDao findByName portProfName if portProfileObj null
throw new CloudRuntimeException zoneId nws size final NetworkVO nw nws get checkOverlapPrivateIpRange podId startIp endIp checkOverlapStorageIpRange podId startIp endIp StorageNetworkIpRangeVO range null final String endIpFinal endIp return Transaction execute new TransactionCallbackWithException StorageNetworkIpRangeVO SQLException Override public StorageNetworkIpRangeVO doInTransaction TransactionStatus status throws SQLException StorageNetworkIpRangeVO range new StorageNetworkIpRangeVO zoneId podId nw getId startIp endIpFinal vlan netmask cmd getGateWay _sNwIpRangeDao persist range try createStorageIpEntires TransactionLegacy currentTxn range getId startIp endIpFinal zoneId catch SQLException e StringBuilder err new StringBuilder err append
long autoscaleUserId cmd getAutoscaleUserId DataCenter zone _entityMgr findById DataCenter class zoneId if zone null throw new InvalidParameterValueException ServiceOffering serviceOffering _entityMgr findById ServiceOffering class serviceOfferingId if serviceOffering null throw new InvalidParameterValueException HashMap String String deployParams cmd getDeployParamMap if deployParams containsKey deployParams get length throw new InvalidParameterValueException dispatchChainFactory getStandardDispatchChain dispatch new DispatchTask ComponentContext inject DeployVMCmd class deployParams AutoScaleVmProfileVO profileVO new AutoScaleVmProfileVO cmd getZoneId cmd getDomainId cmd getAccountId cmd getServiceOfferingId cmd getTemplateId cmd getOtherDeployParams cmd getCounterParamList cmd getDestroyVmGraceperiod autoscaleUserId if cmd getDisplay null profileVO setDisplay cmd getDisplay profileVO checkValidityAndPersist profileVO
if autoscaleUserId null vmProfile setAutoscaleUserId autoscaleUserId if counterParamList null vmProfile setCounterParamsForUpdate counterParamList if destroyVmGraceperiod null vmProfile setDestroyVmGraceperiod destroyVmGraceperiod if cmd getCustomId null vmProfile setUuid cmd getCustomId if cmd getDisplay null vmProfile setDisplay cmd getDisplay List AutoScaleVmGroupVO vmGroupList _autoScaleVmGroupDao listByAll null profileId for AutoScaleVmGroupVO vmGroupVO vmGroupList if physicalParameterUpdate vmGroupVO getState equals AutoScaleVmGroup State_Disabled throw new InvalidParameterValueException vmProfile checkValidityAndPersist vmProfile
if duration null policy setDuration duration if quietTime null policy setQuietTime quietTime List AutoScaleVmGroupPolicyMapVO vmGroupPolicyList _autoScaleVmGroupPolicyMapDao listByPolicyId policyId for AutoScaleVmGroupPolicyMapVO vmGroupPolicy vmGroupPolicyList AutoScaleVmGroupVO vmGroupVO _autoScaleVmGroupDao findById vmGroupPolicy getVmGroupId if vmGroupVO null s_logger warn vmGroupPolicy getVmGroupId continue if vmGroupVO getState equals AutoScaleVmGroup State_Disabled throw new InvalidParameterValueException if policy getDuration vmGroupVO getInterval throw new InvalidParameterValueException policy checkValidityAndPersist policy conditionIds
int maxMembers cmd getMaxMembers Integer interval cmd getInterval Boolean forDisplay cmd getDisplay if interval null interval NetUtils DEFAULT_AUTOSCALE_POLICY_INTERVAL_TIME LoadBalancerVO loadBalancer getEntityInDatabase CallContext current getCallingAccount ApiConstants LBID cmd getLbRuleId _lbDao Long zoneId _ipAddressDao findById loadBalancer getSourceIpAddressId getDataCenterId if _autoScaleVmGroupDao isAutoScaleLoadBalancer loadBalancer getId throw new InvalidParameterValueException if _lb2VmMapDao isVmAttachedToLoadBalancer loadBalancer getId throw new InvalidParameterValueException AutoScaleVmGroupVO vmGroupVO new AutoScaleVmGroupVO cmd getLbRuleId zoneId loadBalancer getDomainId loadBalancer getAccountId minMembers maxMembers loadBalancer getDefaultPortStart interval null cmd getProfileId AutoScaleVmGroup State_New if forDisplay null vmGroupVO setDisplay forDisplay vmGroupVO checkValidityAndPersist vmGroupVO cmd getScaleUpPolicyIds cmd getScaleDownPolicyIds
autoScaleVmGroupVO setState bakupState _autoScaleVmGroupDao persist autoScaleVmGroupVO finally if success s_logger warn id return false return Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean success _autoScaleVmGroupDao remove id if success s_logger warn return false success _autoScaleVmGroupPolicyMapDao removeByGroupId id if success s_logger warn
Override ActionEvent eventType EventTypes EVENT_CONDITION_CREATE eventDescription create true public Condition createCondition CreateConditionCmd cmd checkCallerAccess cmd getAccountName cmd getDomainId String opr cmd getRelationalOperator toUpperCase long cid cmd getCounterId long threshold cmd getThreshold Condition Operator op try op Condition Operator valueOf opr catch IllegalArgumentException ex throw new InvalidParameterValueException opr CounterVO counter _counterDao findById cid if counter null throw new InvalidParameterValueException ConditionVO condition null condition _conditionDao persist new ConditionVO cid threshold cmd getEntityOwnerId cmd getDomainId op
Override public void cleanUpAutoScaleResources Long accountId int count count _autoScaleVmProfileDao removeByAccountId accountId if count
catch final ResourceUnavailableException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_UNAVAILABLE_ERROR ex getMessage catch ResourceAllocationException ex s_logger warn ex throw new ServerApiException ApiErrorCode RESOURCE_ALLOCATION_ERROR ex getMessage catch ConcurrentOperationException ex s_logger warn ex throw new ServerApiException ApiErrorCode INTERNAL_ERROR ex getMessage catch InsufficientCapacityException ex StringBuilder message new StringBuilder ex getMessage if ex InsufficientServerCapacityException if InsufficientServerCapacityException ex isAffinityApplied message append s_logger info ex
Override public void doScaleUp long groupId Integer numVm AutoScaleVmGroupVO asGroup _autoScaleVmGroupDao findById groupId if asGroup null
s_logger error asGroup getId break if startNewVM vmId if assignLBruleToNewVm vmId asGroup AutoScaleVmGroupVmMapVO GroupVmVO new AutoScaleVmGroupVmMapVO asGroup getId vmId _autoScaleVmGroupVmMapDao persist GroupVmVO List AutoScaleVmGroupPolicyMapVO GroupPolicyVOs _autoScaleVmGroupPolicyMapDao listByVmGroupId groupId for AutoScaleVmGroupPolicyMapVO GroupPolicyVO GroupPolicyVOs AutoScalePolicyVO vo _autoScalePolicyDao findById GroupPolicyVO getPolicyId if vo getAction equals vo setLastQuiteTime new Date _autoScalePolicyDao persist vo break else s_logger error
Override public void doScaleDown final long groupId AutoScaleVmGroupVO asGroup _autoScaleVmGroupDao findById groupId if asGroup null
SuppressWarnings UserVmVO uservm _userVmDao findById vm getId _userVmDao loadDetails uservm String password String vm getParameter VirtualMachineProfile Param VmPassword String userData uservm getUserData String sshPublicKey uservm getDetail Commands cmds new Commands Command OnError Continue if password null nic isDefaultNic SavePasswordCommand cmd new SavePasswordCommand password nic getIPv4Address uservm getHostName _networkMgr getExecuteInSeqNtwkElmtCmd cmds addCommand cmd String serviceOffering _serviceOfferingDao findByIdIncludingRemoved uservm getServiceOfferingId getDisplayText String zoneName _dcDao findById network getDataCenterId getName String destHostname VirtualMachineManager getHypervisorHostname dest getHost getName cmds addCommand generateVmDataCommand nic getIPv4Address userData serviceOffering zoneName nic getIPv4Address uservm getHostName uservm getInstanceName uservm getId uservm getUuid sshPublicKey destHostname try _agentManager send dest getHost getId cmds
String sshPublicKey uservm getDetail Commands cmds new Commands Command OnError Continue if password null nic isDefaultNic SavePasswordCommand cmd new SavePasswordCommand password nic getIPv4Address uservm getHostName _networkMgr getExecuteInSeqNtwkElmtCmd cmds addCommand cmd String serviceOffering _serviceOfferingDao findByIdIncludingRemoved uservm getServiceOfferingId getDisplayText String zoneName _dcDao findById network getDataCenterId getName String destHostname VirtualMachineManager getHypervisorHostname dest getHost getName cmds addCommand generateVmDataCommand nic getIPv4Address userData serviceOffering zoneName nic getIPv4Address uservm getHostName uservm getInstanceName uservm getId uservm getUuid sshPublicKey destHostname try _agentManager send dest getHost getId cmds catch OperationTimedoutException e s_logger debug dest getHost return false Answer dataAnswer cmds getAnswer
SavePasswordCommand cmd new SavePasswordCommand password nic getIPv4Address uservm getHostName _networkMgr getExecuteInSeqNtwkElmtCmd cmds addCommand cmd String serviceOffering _serviceOfferingDao findByIdIncludingRemoved uservm getServiceOfferingId getDisplayText String zoneName _dcDao findById network getDataCenterId getName String destHostname VirtualMachineManager getHypervisorHostname dest getHost getName cmds addCommand generateVmDataCommand nic getIPv4Address userData serviceOffering zoneName nic getIPv4Address uservm getHostName uservm getInstanceName uservm getId uservm getUuid sshPublicKey destHostname try _agentManager send dest getHost getId cmds catch OperationTimedoutException e s_logger debug dest getHost return false Answer dataAnswer cmds getAnswer if dataAnswer null dataAnswer getResult s_logger info uservm getInstanceName return true
private boolean deleteConfigDriveIso final VirtualMachine vm throws ResourceUnavailableException DataStore dataStore _dataStoreMgr getImageStoreWithFreeCapacity vm getDataCenterId Long agentId findAgentIdForImageStore dataStore if VirtualMachineManager VmConfigDriveOnPrimaryPool value List VolumeVO volumes _volumeDao findByInstanceAndType vm getId Volume Type ROOT if volumes null volumes size dataStore _dataStoreMgr getDataStore volumes get getPoolId DataStoreRole Primary agentId vm getHostId null vm getHostId vm getLastHostId if agentId null dataStore null throw new ResourceUnavailableException ConfigDriveNetworkElement class 0L LOG debug vm getInstanceName final String isoPath ConfigDrive createConfigDrivePath vm getInstanceName final HandleConfigDriveIsoCommand configDriveIsoCommand new HandleConfigDriveIsoCommand isoPath null dataStore getTO false final Answer answer agentManager easySend agentId configDriveIsoCommand if answer getResult
Override public boolean applyFWRules final Network network final List extends FirewallRule rules throws ResourceUnavailableException boolean result true if canHandle network Service Firewall final List DomainRouterVO routers getRouters network if routers null routers isEmpty
Override public boolean applyStaticNats final Network network final List extends StaticNat rules throws ResourceUnavailableException boolean result true if canHandle network Service StaticNat final List DomainRouterVO routers getRouters network if routers null routers isEmpty
if canHandle network null return false final List DomainRouterVO routers _routerDao listByNetworkAndRole network getId Role VIRTUAL_ROUTER if routers null routers isEmpty s_logger debug network getId return true final VirtualMachineProfile uservm vm final DataCenterVO dcVO _dcDao findById network getDataCenterId final NetworkTopology networkTopology networkTopologyContext retrieveNetworkTopology dcVO boolean savePasswordResult true boolean isVrRunning false for final VirtualRouter router routers if router getState State Running final boolean result networkTopology savePasswordToRouter network nic uservm router if result
Override public VirtualRouterProvider configure final ConfigureVirtualRouterElementCmd cmd final VirtualRouterProviderVO element _vrProviderDao findById cmd getId if element null element getType Type VirtualRouter element getType Type VPCVirtualRouter
Override public OvsProvider configure final ConfigureOvsElementCmd cmd final OvsProviderVO element _ovsProviderDao findById cmd getId if element null
Override public boolean applyPFRules final Network network final List PortForwardingRule rules throws ResourceUnavailableException boolean result true if canHandle network Service PortForwarding final List DomainRouterVO routers _routerDao listByNetworkAndRole network getId Role VIRTUAL_ROUTER if routers null routers isEmpty
protected void configureGuestNetwork final Network network final List DomainRouterVO routers throws ConcurrentOperationException InsufficientCapacityException ResourceUnavailableException
Override public boolean shutdown final Network network final ReservationContext context final boolean cleanup throws ConcurrentOperationException ResourceUnavailableException final Long vpcId network getVpcId if vpcId null
Override public boolean shutdown final Network network final ReservationContext context final boolean cleanup throws ConcurrentOperationException ResourceUnavailableException final Long vpcId network getVpcId if vpcId null s_logger debug network return true boolean success true final List extends VirtualRouter routers _routerDao listByVpcId vpcId for final VirtualRouter router routers if _networkMdl isVmPartOfNetwork router getId network getId s_logger debug router network continue success success _vpcRouterMgr removeVpcRouterFromGuestNetwork router network if success s_logger warn network router else
Override public boolean destroy final Network config final ReservationContext context throws ConcurrentOperationException ResourceUnavailableException final Long vpcId config getVpcId if vpcId null
Override public boolean destroy final Network config final ReservationContext context throws ConcurrentOperationException ResourceUnavailableException final Long vpcId config getVpcId if vpcId null s_logger debug config return true boolean success true final List extends VirtualRouter routers _routerDao listByVpcId vpcId for final VirtualRouter router routers if _networkMdl isVmPartOfNetwork router getId config getId s_logger debug router config continue success success _vpcRouterMgr removeVpcRouterFromGuestNetwork router config if success s_logger warn config router else
List DomainRouterVO routers super getRouters network dest if routers size return routers final Long vpcId network getVpcId if vpcId null s_logger error network return routers final Vpc vpc _vpcMgr getActiveVpc vpcId if vpc null s_logger warn vpcId return routers final RouterDeploymentDefinition routerDeploymentDefinition routerDeploymentDefinitionBuilder create setGuestNetwork network setVpc vpc setDeployDestination dest setAccountOwner _accountMgr getAccount vpc getAccountId build try routers routerDeploymentDefinition deployVirtualRouter catch final ConcurrentOperationException e
return routers final Long vpcId network getVpcId if vpcId null s_logger error network return routers final Vpc vpc _vpcMgr getActiveVpc vpcId if vpc null s_logger warn vpcId return routers final RouterDeploymentDefinition routerDeploymentDefinition routerDeploymentDefinitionBuilder create setGuestNetwork network setVpc vpc setDeployDestination dest setAccountOwner _accountMgr getAccount vpc getAccountId build try routers routerDeploymentDefinition deployVirtualRouter catch final ConcurrentOperationException e s_logger error e catch final InsufficientCapacityException e
final Long vpcId network getVpcId if vpcId null s_logger error network return routers final Vpc vpc _vpcMgr getActiveVpc vpcId if vpc null s_logger warn vpcId return routers final RouterDeploymentDefinition routerDeploymentDefinition routerDeploymentDefinitionBuilder create setGuestNetwork network setVpc vpc setDeployDestination dest setAccountOwner _accountMgr getAccount vpc getAccountId build try routers routerDeploymentDefinition deployVirtualRouter catch final ConcurrentOperationException e s_logger error e catch final InsufficientCapacityException e s_logger error e
final List DomainRouterVO routers _vpcRouterMgr getVpcRouters gateway getVpcId if routers null routers isEmpty s_logger debug getName gateway getVpcId return true s_logger info routers size final DataCenterVO dcVO _dcDao findById gateway getZoneId final NetworkTopology networkTopology networkTopologyContext retrieveNetworkTopology dcVO boolean result true final Network network _networkDao findById gateway getNetworkId final boolean isPrivateGateway true for final DomainRouterVO domainRouterVO routers if networkTopology setupPrivateGateway gateway domainRouterVO try final List NetworkACLItemVO rules _networkACLItemDao listByACL gateway getNetworkACLId result result networkTopology applyNetworkACLs network rules domainRouterVO isPrivateGateway
Override public boolean applyNetworkACLs final Network network final List extends NetworkACLItem rules throws ResourceUnavailableException boolean result true if canHandle network Service NetworkACL final List DomainRouterVO routers _routerDao listByNetworkAndRole network getId Role VIRTUAL_ROUTER if routers null routers isEmpty
Override public boolean applyStaticRoutes final Vpc vpc final List StaticRouteProfile routes throws ResourceUnavailableException final List DomainRouterVO routers _routerDao listByVpcId vpc getId if routers null routers isEmpty
Override public boolean applyACLItemsToPrivateGw final PrivateGateway gateway final List extends NetworkACLItem rules throws ResourceUnavailableException final Network network _networkDao findById gateway getNetworkId final boolean isPrivateGateway true final List DomainRouterVO routers _vpcRouterMgr getVpcRouters gateway getVpcId if routers null routers isEmpty
Override ActionEvent eventType EventTypes EVENT_FIREWALL_CLOSE eventDescription async true public boolean revokeFirewallRulesForIp long ipId long userId Account caller throws ResourceUnavailableException List FirewallRule rules new ArrayList FirewallRule List FirewallRuleVO fwRules _firewallDao listByIpAndPurposeAndNotRevoked ipId Purpose Firewall if s_logger isDebugEnabled
Override ActionEvent eventType EventTypes EVENT_FIREWALL_CLOSE eventDescription async true public boolean revokeAllFirewallRulesForNetwork long networkId long userId Account caller throws ResourceUnavailableException List FirewallRule rules new ArrayList FirewallRule List FirewallRuleVO fwRules _firewallDao listByNetworkAndPurposeAndNotRevoked networkId Purpose Firewall if s_logger isDebugEnabled
if vm null return false List PortForwardingRuleVO pfRules _pfRulesDao listByVm vmId List FirewallRuleVO staticNatRules _firewallDao listStaticNatByVmId vm getId List FirewallRuleVO firewallRules new ArrayList FirewallRuleVO for PortForwardingRuleVO pfRule pfRules FirewallRuleVO relatedRule _firewallDao findByRelatedId pfRule getId if relatedRule null firewallRules add relatedRule for FirewallRuleVO staticNatRule staticNatRules FirewallRuleVO relatedRule _firewallDao findByRelatedId staticNatRule getId if relatedRule null firewallRules add relatedRule Set Long ipsToReprogram new HashSet Long if firewallRules isEmpty
List PortForwardingRuleVO pfRules _pfRulesDao listByVm vmId List FirewallRuleVO staticNatRules _firewallDao listStaticNatByVmId vm getId List FirewallRuleVO firewallRules new ArrayList FirewallRuleVO for PortForwardingRuleVO pfRule pfRules FirewallRuleVO relatedRule _firewallDao findByRelatedId pfRule getId if relatedRule null firewallRules add relatedRule for FirewallRuleVO staticNatRule staticNatRules FirewallRuleVO relatedRule _firewallDao findByRelatedId staticNatRule getId if relatedRule null firewallRules add relatedRule Set Long ipsToReprogram new HashSet Long if firewallRules isEmpty s_logger debug vmId return true
protected boolean isMyIsolationMethod PhysicalNetwork physicalNetwork for IsolationMethod m this getIsolationMethods List String isolationMethods physicalNetwork getIsolationMethods if CollectionUtils isNotEmpty isolationMethods for String method isolationMethods
Override DB public void deallocate final Network network final NicProfile nic VirtualMachineProfile vm if s_logger isDebugEnabled
Override DB public boolean trash Network network NetworkOffering offering try long id network getId final List NicVO nics _nicDao listPlaceholderNicsByNetworkId id if nics null Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status for Nic nic nics if nic getIPv4Address null
Override DB public boolean trash Network network NetworkOffering offering try long id network getId final List NicVO nics _nicDao listPlaceholderNicsByNetworkId id if nics null Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status for Nic nic nics if nic getIPv4Address null s_logger debug nic getIPv4Address nic IPAddressVO ip _ipAddressDao findByIpAndSourceNetworkId nic getNetworkId nic getIPv4Address if ip null _ipAddrMgr markIpAsUnavailable ip getId _ipAddressDao unassignIpAddress ip getId
if nics null Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status for Nic nic nics if nic getIPv4Address null s_logger debug nic getIPv4Address nic IPAddressVO ip _ipAddressDao findByIpAndSourceNetworkId nic getNetworkId nic getIPv4Address if ip null _ipAddrMgr markIpAsUnavailable ip getId _ipAddressDao unassignIpAddress ip getId s_logger debug nic _nicDao remove nic getId return true catch Exception e
final DataCenter dc _dcDao findById pod getDataCenterId Transaction execute new TransactionCallbackWithExceptionNoReturn InsufficientAddressCapacityException Override public void doInTransactionWithoutResult TransactionStatus status throws InsufficientAddressCapacityException PublicIp ip null List PodVlanMapVO podRefs _podVlanDao listPodVlanMapsByPod pod getId VlanVO vlan _vlanDao findById podRefs get getVlanDbId if nic getIPv4Address null String podRangeGateway null if podRefs isEmpty podRangeGateway vlan getVlanGateway if vm getType VirtualMachine Type DomainRouter Nic placeholderNic _networkModel getPlaceholderNicForRouter network pod getId if placeholderNic null IPAddressVO userIp _ipAddressDao findByIpAndSourceNetworkId network getId placeholderNic getIPv4Address ip PublicIp createFromAddrAndVlan userIp _vlanDao findById userIp getVlanId
s_logger debug placeholderNic getIPv4Address network podRangeGateway if ip null ip _ipAddrMgr assignPublicIpAddress dc getId pod getId vm getOwner VlanType DirectAttached network getId null false false nic setIPv4Address ip getAddress toString nic setFormat AddressFormat Ip4 nic setIPv4Gateway ip getGateway nic setIPv4Netmask ip getNetmask if ip getVlanTag null ip getVlanTag equalsIgnoreCase Vlan UNTAGGED nic setIsolationUri IsolationType Ec2 toUri Vlan UNTAGGED nic setBroadcastUri BroadcastDomainType Vlan toUri Vlan UNTAGGED nic setBroadcastType BroadcastDomainType Native nic setReservationId String valueOf ip getVlanTag nic setMacAddress ip getMacAddress if vm getType VirtualMachine Type DomainRouter Nic placeholderNic _networkModel getPlaceholderNicForRouter network pod getId
nic setIPv4Gateway ip getGateway nic setIPv4Netmask ip getNetmask if ip getVlanTag null ip getVlanTag equalsIgnoreCase Vlan UNTAGGED nic setIsolationUri IsolationType Ec2 toUri Vlan UNTAGGED nic setBroadcastUri BroadcastDomainType Vlan toUri Vlan UNTAGGED nic setBroadcastType BroadcastDomainType Native nic setReservationId String valueOf ip getVlanTag nic setMacAddress ip getMacAddress if vm getType VirtualMachine Type DomainRouter Nic placeholderNic _networkModel getPlaceholderNicForRouter network pod getId if placeholderNic null s_logger debug nic getIPv4Address network _networkMgr savePlaceholderNic network nic getIPv4Address null VirtualMachine Type DomainRouter if vlan getIp6Cidr null if nic getIPv6Address null
nic setIsolationUri IsolationType Ec2 toUri Vlan UNTAGGED nic setBroadcastUri BroadcastDomainType Vlan toUri Vlan UNTAGGED nic setBroadcastType BroadcastDomainType Native nic setReservationId String valueOf ip getVlanTag nic setMacAddress ip getMacAddress if vm getType VirtualMachine Type DomainRouter Nic placeholderNic _networkModel getPlaceholderNicForRouter network pod getId if placeholderNic null s_logger debug nic getIPv4Address network _networkMgr savePlaceholderNic network nic getIPv4Address null VirtualMachine Type DomainRouter if vlan getIp6Cidr null if nic getIPv6Address null s_logger debug vlan getIp6Cidr vlan getId nic setIPv6Cidr vlan getIp6Cidr nic setIPv6Gateway vlan getIp6Gateway
Override DB public void deallocate final Network network final NicProfile nic final VirtualMachineProfile vm if network getSpecifyIpRanges if s_logger isDebugEnabled
if result null throw new InsufficientAddressCapacityException Pod class pod getId Integer vlan result getVlan nic setIPv4Address result getIpAddress nic setMacAddress NetUtils long2Mac NetUtils createSequenceBasedMacAddress result getMacAddress NetworkModel MACIdentifier value nic setIPv4Gateway pod getGateway nic setFormat AddressFormat Ip4 String netmask NetUtils getCidrNetmask pod getCidrSize nic setIPv4Netmask netmask nic setBroadcastType BroadcastDomainType Native if vlan null nic setBroadcastUri BroadcastDomainType Native toUri vlan else nic setBroadcastUri null nic setIsolationUri null
Override public boolean release NicProfile nic VirtualMachineProfile vm String reservationId _dcDao releasePrivateIpAddress nic getId nic getReservationId nic deallocate if s_logger isDebugEnabled
Override public void deallocate Network network NicProfile nic VirtualMachineProfile vm if s_logger isDebugEnabled
Override DB public void deallocate Network network NicProfile nic VirtualMachineProfile vm if s_logger isDebugEnabled
Integer vlan null StorageNetworkIpAddressVO ip _sNwMgr acquireIpAddress pod getId if ip null throw new InsufficientAddressCapacityException Pod class pod getId vlan ip getVlan nic setIPv4Address ip getIpAddress nic setMacAddress NetUtils long2Mac NetUtils createSequenceBasedMacAddress ip getMac NetworkModel MACIdentifier value nic setFormat AddressFormat Ip4 nic setIPv4Netmask ip getNetmask nic setBroadcastType BroadcastDomainType Storage nic setIPv4Gateway ip getGateway if vlan null nic setBroadcastUri BroadcastDomainType Storage toUri vlan else nic setBroadcastUri null
Override public boolean configure String name Map String Object params throws ConfigurationException _configs _configDao getConfiguration params if s_logger isInfoEnabled
final LoadBalancerVO loadBalancer _lbDao findById vmGroup getLoadBalancerId FirewallRule State backupState loadBalancer getState if vmGroup getState equals AutoScaleVmGroup State_New loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer else if loadBalancer getState FirewallRule State Active vmGroup getState equals AutoScaleVmGroup State_Revoke loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer try success applyAutoScaleConfig loadBalancer vmGroup currentState catch ResourceUnavailableException e s_logger warn loadBalancer getId e if isRollBackAllowedForProvider loadBalancer loadBalancer setState backupState _lbDao persist loadBalancer
try success applyAutoScaleConfig loadBalancer vmGroup currentState catch ResourceUnavailableException e s_logger warn loadBalancer getId e if isRollBackAllowedForProvider loadBalancer loadBalancer setState backupState _lbDao persist loadBalancer s_logger debug loadBalancer getId throw e finally if success s_logger warn vmGroupid if success if vmGroup getState equals AutoScaleVmGroup State_New Transaction execute new TransactionCallbackNoReturn
s_logger warn loadBalancer getId e if isRollBackAllowedForProvider loadBalancer loadBalancer setState backupState _lbDao persist loadBalancer s_logger debug loadBalancer getId throw e finally if success s_logger warn vmGroupid if success if vmGroup getState equals AutoScaleVmGroup State_New Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status loadBalancer setState FirewallRule State Active s_logger debug loadBalancer getId
_lbDao persist loadBalancer s_logger debug loadBalancer getId throw e finally if success s_logger warn vmGroupid if success if vmGroup getState equals AutoScaleVmGroup State_New Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status loadBalancer setState FirewallRule State Active s_logger debug loadBalancer getId _lbDao persist loadBalancer vmGroup setState AutoScaleVmGroup State_Enabled _autoScaleVmGroupDao persist vmGroup
Override public boolean validateLbRule LoadBalancingRule lbRule Network network _networkDao findById lbRule getNetworkId Purpose purpose lbRule getPurpose if purpose Purpose LoadBalancing
if stickinessPolicy getId cmd getEntityId backupState loadBalancer getState loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer else oldStickinessPolicyId stickinessPolicy getId stickinessPolicy setRevoke true _lb2stickinesspoliciesDao persist stickinessPolicy try applyLoadBalancerConfig cmd getLbRuleId catch ResourceUnavailableException e s_logger warn cmd getLbRuleId e if isRollBackAllowedForProvider loadBalancer loadBalancer setState backupState _lbDao persist loadBalancer
Override DB ActionEvent eventType EventTypes EVENT_LB_HEALTHCHECKPOLICY_CREATE eventDescription async true public boolean applyLBHealthCheckPolicy CreateLBHealthCheckPolicyCmd cmd boolean success true LoadBalancerVO loadBalancer _lbDao findById cmd getLbRuleId if loadBalancer null throw new InvalidParameterException cmd getLbRuleId FirewallRule State backupState loadBalancer getState loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer try applyLoadBalancerConfig cmd getLbRuleId catch ResourceUnavailableException e s_logger warn cmd getLbRuleId e if isRollBackAllowedForProvider loadBalancer loadBalancer setState backupState _lbDao persist loadBalancer
if stickinessPolicy null throw new InvalidParameterException stickinessPolicyId LoadBalancerVO loadBalancer _lbDao findById Long valueOf stickinessPolicy getLoadBalancerId if loadBalancer null throw new InvalidParameterException stickinessPolicy getLoadBalancerId stickinessPolicyId long loadBalancerId loadBalancer getId FirewallRule State backupState loadBalancer getState _accountMgr checkAccess caller getCallingAccount null true loadBalancer if apply if loadBalancer getState FirewallRule State Active loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer boolean backupStickyState stickinessPolicy isRevoke stickinessPolicy setRevoke true _lb2stickinesspoliciesDao persist stickinessPolicy
if loadBalancer getState FirewallRule State Active loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer boolean backupStickyState stickinessPolicy isRevoke stickinessPolicy setRevoke true _lb2stickinesspoliciesDao persist stickinessPolicy s_logger debug loadBalancerId stickinessPolicyId try if applyLoadBalancerConfig loadBalancerId s_logger warn loadBalancerId stickinessPolicyId throw new CloudRuntimeException loadBalancerId stickinessPolicyId catch ResourceUnavailableException e if isRollBackAllowedForProvider loadBalancer stickinessPolicy setRevoke backupStickyState _lb2stickinesspoliciesDao persist stickinessPolicy
if healthCheckPolicy null throw new InvalidParameterException healthCheckPolicyId LoadBalancerVO loadBalancer _lbDao findById Long valueOf healthCheckPolicy getLoadBalancerId if loadBalancer null throw new InvalidParameterException healthCheckPolicy getLoadBalancerId healthCheckPolicyId final long loadBalancerId loadBalancer getId FirewallRule State backupState loadBalancer getState _accountMgr checkAccess caller getCallingAccount null true loadBalancer if apply if loadBalancer getState FirewallRule State Active loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer boolean backupStickyState healthCheckPolicy isRevoke healthCheckPolicy setRevoke true _lb2healthcheckDao persist healthCheckPolicy
throw new InvalidParameterException healthCheckPolicy getLoadBalancerId healthCheckPolicyId final long loadBalancerId loadBalancer getId FirewallRule State backupState loadBalancer getState _accountMgr checkAccess caller getCallingAccount null true loadBalancer if apply if loadBalancer getState FirewallRule State Active loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer boolean backupStickyState healthCheckPolicy isRevoke healthCheckPolicy setRevoke true _lb2healthcheckDao persist healthCheckPolicy s_logger debug loadBalancerId healthCheckPolicyId final List LoadBalancerVMMapVO maps _lb2VmMapDao listByLoadBalancerId loadBalancerId if maps null Transaction execute new TransactionCallbackNoReturn
if maps null Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status s_logger debug loadBalancerId for LoadBalancerVMMapVO map maps map setState null _lb2VmMapDao persist map try if applyLoadBalancerConfig loadBalancerId s_logger warn loadBalancerId healthCheckPolicyId throw new CloudRuntimeException loadBalancerId healthCheckPolicyId catch ResourceUnavailableException e if isRollBackAllowedForProvider loadBalancer healthCheckPolicy setRevoke backupStickyState
if nicInSameNetwork null InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject vm getUuid throw ex String priIp nicInSameNetwork getIPv4Address if existingVmIdIps containsKey instanceId List String mappedIps existingVmIdIps get instanceId List String newIps vmIdIpMap get instanceId if newIps null newIps new ArrayList String newIps add priIp for String newIp newIps if mappedIps contains newIp throw new InvalidParameterValueException instanceId newIp List String vmIpsList vmIdIpMap get instanceId
LoadBalancerCertMapVO certMapRule _lbCertMapDao findByLbRuleId loadBalancer getId if certMapRule null throw new InvalidParameterValueException if loadBalancer getLbProtocol null loadBalancer getLbProtocol equals NetUtils SSL_PROTO throw new InvalidParameterValueException loadBalancer getLbProtocol boolean success false FirewallRule State backupState loadBalancer getState try loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer LoadBalancerCertMapVO certMap new LoadBalancerCertMapVO lbRuleId certId false _lbCertMapDao persist certMap applyLoadBalancerConfig loadBalancer getId success true catch ResourceUnavailableException e if isRollBackAllowedForProvider loadBalancer loadBalancer setState backupState
try loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer lbCertMap setRevoke true _lbCertMapDao persist lbCertMap if applyLoadBalancerConfig lbRuleId s_logger warn lbRuleId CloudRuntimeException ex new CloudRuntimeException lbRuleId ex addProxyObject loadBalancer getUuid throw ex success true catch ResourceUnavailableException e if isRollBackAllowedForProvider loadBalancer lbCertMap setRevoke false _lbCertMapDao persist lbCertMap
if instanceIds null vmIdIpMap isEmpty vmIdIpMap new HashMap Long List String for long instanceId instanceIds vmIdIpMap put instanceId null boolean success false FirewallRule State backupState loadBalancer getState Set Long vmIds vmIdIpMap keySet try loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer for long instanceId vmIds List String lbVmIps vmIdIpMap get instanceId if lbVmIps null lbVmIps isEmpty List LoadBalancerVMMapVO lbVms _lb2VmMapDao listByLoadBalancerIdAndVmId loadBalancerId instanceId if lbVms null
FirewallRule State backupState loadBalancer getState Set Long vmIds vmIdIpMap keySet try loadBalancer setState FirewallRule State Add _lbDao persist loadBalancer for long instanceId vmIds List String lbVmIps vmIdIpMap get instanceId if lbVmIps null lbVmIps isEmpty List LoadBalancerVMMapVO lbVms _lb2VmMapDao listByLoadBalancerIdAndVmId loadBalancerId instanceId if lbVms null throw new InvalidParameterValueException instanceId loadBalancerId for LoadBalancerVMMapVO lbvm lbVms lbvm setRevoke true _lb2VmMapDao persist lbvm s_logger debug loadBalancerId instanceId
else for String vmIp lbVmIps LoadBalancerVMMapVO map _lb2VmMapDao findByLoadBalancerIdAndVmIdVmIp loadBalancerId instanceId vmIp if map null throw new InvalidParameterValueException instanceId loadBalancerId map setRevoke true _lb2VmMapDao persist map s_logger debug loadBalancerId instanceId vmIp if _autoScaleVmGroupDao isAutoScaleLoadBalancer loadBalancerId _lb2VmMapDao remove loadBalancer getId instanceIds null return true if applyLoadBalancerConfig loadBalancerId s_logger warn loadBalancerId instanceIds CloudRuntimeException ex new CloudRuntimeException instanceIds ex addProxyObject loadBalancer getUuid
map setRevoke true _lb2VmMapDao persist map s_logger debug loadBalancerId instanceId vmIp if _autoScaleVmGroupDao isAutoScaleLoadBalancer loadBalancerId _lb2VmMapDao remove loadBalancer getId instanceIds null return true if applyLoadBalancerConfig loadBalancerId s_logger warn loadBalancerId instanceIds CloudRuntimeException ex new CloudRuntimeException instanceIds ex addProxyObject loadBalancer getUuid throw ex success true catch ResourceUnavailableException e if rollBack isRollBackAllowedForProvider loadBalancer for long instanceId vmIds
if _autoScaleVmGroupDao isAutoScaleLoadBalancer loadBalancerId _lb2VmMapDao remove loadBalancer getId instanceIds null return true if applyLoadBalancerConfig loadBalancerId s_logger warn loadBalancerId instanceIds CloudRuntimeException ex new CloudRuntimeException instanceIds ex addProxyObject loadBalancer getUuid throw ex success true catch ResourceUnavailableException e if rollBack isRollBackAllowedForProvider loadBalancer for long instanceId vmIds List String lbVmIps vmIdIpMap get instanceId if lbVmIps null lbVmIps isEmpty LoadBalancerVMMapVO map _lb2VmMapDao findByLoadBalancerIdAndVmId loadBalancerId instanceId
Override public boolean removeVmFromLoadBalancers long instanceId boolean success true List LoadBalancerVMMapVO maps _lb2VmMapDao listByInstanceId instanceId if maps null maps isEmpty return true Map Long List Long lbsToReconfigure new HashMap Long List Long for LoadBalancerVMMapVO map maps long lbId map getLoadBalancerId List Long instances lbsToReconfigure get lbId if instances null instances new ArrayList Long instances add map getInstanceId lbsToReconfigure put lbId instances map setRevoke true _lb2VmMapDao persist map
List LoadBalancerVMMapVO backupMaps Transaction execute new TransactionCallback List LoadBalancerVMMapVO Override public List LoadBalancerVMMapVO doInTransaction TransactionStatus status boolean generateUsageEvent false if lb getState FirewallRule State Staged if s_logger isDebugEnabled s_logger debug lb generateUsageEvent true else if lb getState FirewallRule State Add lb getState FirewallRule State Active lb setState FirewallRule State Revoke _lbDao persist lb generateUsageEvent true List LoadBalancerVMMapVO backupMaps _lb2VmMapDao listByLoadBalancerId loadBalancerId List LoadBalancerVMMapVO maps _lb2VmMapDao listByLoadBalancerId loadBalancerId if maps null for LoadBalancerVMMapVO map maps
for LBHealthCheckPolicyVO lbHealthCheck hcPolicies lbHealthCheck setRevoke true _lb2healthcheckDao persist lbHealthCheck if generateUsageEvent Network network _networkModel getNetwork lb getNetworkId UsageEventUtils publishUsageEvent EventTypes EVENT_LOAD_BALANCER_DELETE lb getAccountId network getDataCenterId lb getId null LoadBalancingRule class getName lb getUuid return backupMaps NetworkVO network _networkDao findById lb getNetworkId if network null if _networkModel networkIsConfiguredForExternalNetworking network getDataCenterId network getId _externalDeviceUsageMgr updateExternalLoadBalancerNetworkUsageStats loadBalancerId if apply try if applyLoadBalancerConfig loadBalancerId
if generateUsageEvent Network network _networkModel getNetwork lb getNetworkId UsageEventUtils publishUsageEvent EventTypes EVENT_LOAD_BALANCER_DELETE lb getAccountId network getDataCenterId lb getId null LoadBalancingRule class getName lb getUuid return backupMaps NetworkVO network _networkDao findById lb getNetworkId if network null if _networkModel networkIsConfiguredForExternalNetworking network getDataCenterId network getId _externalDeviceUsageMgr updateExternalLoadBalancerNetworkUsageStats loadBalancerId if apply try if applyLoadBalancerConfig loadBalancerId s_logger warn return false catch ResourceUnavailableException e
if _networkModel networkIsConfiguredForExternalNetworking network getDataCenterId network getId _externalDeviceUsageMgr updateExternalLoadBalancerNetworkUsageStats loadBalancerId if apply try if applyLoadBalancerConfig loadBalancerId s_logger warn return false catch ResourceUnavailableException e if rollBack isRollBackAllowedForProvider lb if backupMaps null for LoadBalancerVMMapVO map backupMaps _lb2VmMapDao persist map s_logger debug loadBalancerId map getInstanceId lb setState backupState _lbDao persist lb
if result null IpAddress systemIp null NetworkOffering off _entityMgr findById NetworkOffering class network getNetworkOfferingId if off isElasticLb ipVO null network getVpcId null systemIp _ipAddrMgr assignSystemIp networkId lbOwner true false if systemIp null ipVO _ipAddressDao findById systemIp getId if ipVO null throw new InvalidParameterValueException else if ipVO isOneToOneNat throw new NetworkRuleConflictException ipVO getAddress boolean performedIpAssoc false try if ipVO getAssociatedWithNetworkId null boolean assignToVpcNtwk network getVpcId null ipVO getVpcId null ipVO getVpcId longValue network getVpcId
Ip sourceIp getSourceIp newRule LoadBalancingRule loadBalancing new LoadBalancingRule newRule new ArrayList LbDestination new ArrayList LbStickinessPolicy new ArrayList LbHealthCheckPolicy sourceIp null lbProtocol if validateLbRule loadBalancing throw new InvalidParameterValueException return Transaction execute new TransactionCallbackWithException LoadBalancerVO NetworkRuleConflictException Override public LoadBalancerVO doInTransaction TransactionStatus status throws NetworkRuleConflictException LoadBalancerVO newRule new LoadBalancerVO xId name description sourceIpId srcPort destPort algorithm networkId ipAddr getAllocatedToAccountId ipAddr getAllocatedInDomainId lbProtocol if forDisplay null newRule setDisplay forDisplay Ip sourceIp getSourceIp newRule LoadBalancingRule loadBalancing new LoadBalancingRule newRule new ArrayList LbDestination new ArrayList LbStickinessPolicy new ArrayList LbHealthCheckPolicy sourceIp null lbProtocol if validateLbRule loadBalancing throw new InvalidParameterValueException newRule _lbDao persist newRule if openFirewall
Override public boolean revokeLoadBalancersForNetwork long networkId Scheme scheme throws ResourceUnavailableException List LoadBalancerVO lbs _lbDao listByNetworkIdAndScheme networkId scheme if s_logger isDebugEnabled
Override public boolean applyLoadBalancersForNetwork long networkId Scheme scheme throws ResourceUnavailableException List LoadBalancerVO lbs _lbDao listByNetworkIdAndScheme networkId scheme if lbs null
rules add getLoadBalancerRuleToApply lb if applyLbRules rules false s_logger debug return false if updateRulesInDB for final LoadBalancerVO lb lbs boolean checkForReleaseElasticIp Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean checkForReleaseElasticIp false if lb getState FirewallRule State Revoke removeLBRule lb s_logger debug lb getId checkForReleaseElasticIp true else if lb getState FirewallRule State Add lb setState FirewallRule State Active
for final LoadBalancerVO lb lbs boolean checkForReleaseElasticIp Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean checkForReleaseElasticIp false if lb getState FirewallRule State Revoke removeLBRule lb s_logger debug lb getId checkForReleaseElasticIp true else if lb getState FirewallRule State Add lb setState FirewallRule State Active s_logger debug lb getId _lbDao persist lb List LoadBalancerVMMapVO lbVmMaps _lb2VmMapDao listByLoadBalancerId lb getId true List Long instanceIds new ArrayList Long for LoadBalancerVMMapVO lbVmMap lbVmMaps
if lb getState FirewallRule State Revoke removeLBRule lb s_logger debug lb getId checkForReleaseElasticIp true else if lb getState FirewallRule State Add lb setState FirewallRule State Active s_logger debug lb getId _lbDao persist lb List LoadBalancerVMMapVO lbVmMaps _lb2VmMapDao listByLoadBalancerId lb getId true List Long instanceIds new ArrayList Long for LoadBalancerVMMapVO lbVmMap lbVmMaps instanceIds add lbVmMap getInstanceId _lb2VmMapDao remove lb getId lbVmMap getInstanceId lbVmMap getInstanceIp null s_logger debug lb getId lbVmMap getInstanceId lbVmMap getInstanceIp if _lb2VmMapDao listByLoadBalancerId lb getId isEmpty
else if lb getState FirewallRule State Add lb setState FirewallRule State Active s_logger debug lb getId _lbDao persist lb List LoadBalancerVMMapVO lbVmMaps _lb2VmMapDao listByLoadBalancerId lb getId true List Long instanceIds new ArrayList Long for LoadBalancerVMMapVO lbVmMap lbVmMaps instanceIds add lbVmMap getInstanceId _lb2VmMapDao remove lb getId lbVmMap getInstanceId lbVmMap getInstanceIp null s_logger debug lb getId lbVmMap getInstanceId lbVmMap getInstanceIp if _lb2VmMapDao listByLoadBalancerId lb getId isEmpty lb setState FirewallRule State Add _lbDao persist lb s_logger debug lb getId List LBStickinessPolicyVO stickinesspolicies _lb2stickinesspoliciesDao listByLoadBalancerId lb getId true
_lbDao persist lb List LoadBalancerVMMapVO lbVmMaps _lb2VmMapDao listByLoadBalancerId lb getId true List Long instanceIds new ArrayList Long for LoadBalancerVMMapVO lbVmMap lbVmMaps instanceIds add lbVmMap getInstanceId _lb2VmMapDao remove lb getId lbVmMap getInstanceId lbVmMap getInstanceIp null s_logger debug lb getId lbVmMap getInstanceId lbVmMap getInstanceIp if _lb2VmMapDao listByLoadBalancerId lb getId isEmpty lb setState FirewallRule State Add _lbDao persist lb s_logger debug lb getId List LBStickinessPolicyVO stickinesspolicies _lb2stickinesspoliciesDao listByLoadBalancerId lb getId true if stickinesspolicies isEmpty _lb2stickinesspoliciesDao remove lb getId true s_logger debug lb getId
for LoadBalancerVMMapVO lbVmMap lbVmMaps instanceIds add lbVmMap getInstanceId _lb2VmMapDao remove lb getId lbVmMap getInstanceId lbVmMap getInstanceIp null s_logger debug lb getId lbVmMap getInstanceId lbVmMap getInstanceIp if _lb2VmMapDao listByLoadBalancerId lb getId isEmpty lb setState FirewallRule State Add _lbDao persist lb s_logger debug lb getId List LBStickinessPolicyVO stickinesspolicies _lb2stickinesspoliciesDao listByLoadBalancerId lb getId true if stickinesspolicies isEmpty _lb2stickinesspoliciesDao remove lb getId true s_logger debug lb getId List LBHealthCheckPolicyVO healthCheckpolicies _lb2healthcheckDao listByLoadBalancerId lb getId true if healthCheckpolicies isEmpty _lb2healthcheckDao remove lb getId true
protected boolean handleSystemLBIpRelease LoadBalancerVO lb IpAddress ip _ipAddressDao findById lb getSourceIpAddressId boolean success true if ip getSystem
Override public boolean removeAllLoadBalanacersForIp long ipId Account caller long callerUserId List FirewallRuleVO rules _firewallDao listByIpAndPurpose ipId Purpose LoadBalancing if rules null
Override public boolean removeAllLoadBalanacersForNetwork long networkId Account caller long callerUserId List FirewallRuleVO rules _firewallDao listByNetworkAndPurposeAndNotRevoked networkId Purpose LoadBalancing if rules null
LoadBalancingRule rule getLoadBalancerRuleToApply lb if validateLbRule rule throw new InvalidParameterValueException lbRuleId LoadBalancerVO tmplbVo _lbDao findById lbRuleId boolean success _lbDao update lbRuleId lb if algorithm null tmplbVo getAlgorithm compareTo algorithm try lb setState FirewallRule State Add _lbDao persist lb applyLoadBalancerConfig lbRuleId catch ResourceUnavailableException e if isRollBackAllowedForProvider lb if lbBackup getName null lb setName lbBackup getName if lbBackup getDescription null
Account caller CallContext current getCallingAccount Long loadBalancerId cmd getId Boolean applied cmd isApplied if applied null applied Boolean TRUE LoadBalancerVO loadBalancer _lbDao findById loadBalancerId if loadBalancer null return null _accountMgr checkAccess caller null true loadBalancer List UserVmVO loadBalancerInstances new ArrayList UserVmVO List String serviceStates new ArrayList String List LoadBalancerVMMapVO vmLoadBalancerMappings null vmLoadBalancerMappings _lb2VmMapDao listByLoadBalancerId loadBalancerId if vmLoadBalancerMappings null String msg
private TrafficType getNetworkTrafficType Network network final VpcGatewayVO gateway _vpcGatewayDao getVpcGatewayByNetworkId network getId if gateway null
Override public boolean sendCommandsToRouter final VirtualRouter router final Commands cmds throws AgentUnavailableException ResourceUnavailableException if checkRouterVersion router
Override public VirtualRouter destroyRouter final long routerId final Account caller final Long callerUserId throws ResourceUnavailableException ConcurrentOperationException if s_logger isDebugEnabled
protected DomainRouterVO start DomainRouterVO router final User user final Account caller final Map Param Object params final DeploymentPlan planToDeploy throws StorageUnavailableException InsufficientCapacityException ConcurrentOperationException ResourceUnavailableException
protected DomainRouterVO waitRouter final DomainRouterVO router DomainRouterVO vm _routerDao findById router getId if s_logger isDebugEnabled
Override public DomainRouterVO deployRouter final RouterDeploymentDefinition routerDeploymentDefinition final boolean startRouter throws InsufficientAddressCapacityException InsufficientServerCapacityException InsufficientCapacityException StorageUnavailableException ResourceUnavailableException final ServiceOfferingVO routerOffering _serviceOfferingDao findById routerDeploymentDefinition getServiceOfferingId final Account owner routerDeploymentDefinition getOwner final List HypervisorType hypervisors getHypervisors routerDeploymentDefinition int allocateRetry int startRetry DomainRouterVO router null for final Iterator HypervisorType iter hypervisors iterator iter hasNext final HypervisorType hType iter next try final long id _routerDao getNextInSequence Long class if s_logger isDebugEnabled
final ServiceOfferingVO routerOffering _serviceOfferingDao findById routerDeploymentDefinition getServiceOfferingId final Account owner routerDeploymentDefinition getOwner final List HypervisorType hypervisors getHypervisors routerDeploymentDefinition int allocateRetry int startRetry DomainRouterVO router null for final Iterator HypervisorType iter hypervisors iterator iter hasNext final HypervisorType hType iter next try final long id _routerDao getNextInSequence Long class if s_logger isDebugEnabled s_logger debug String format id routerDeploymentDefinition getDest getDataCenter hType final String templateName retrieveTemplateName hType routerDeploymentDefinition getDest getDataCenter getId final VMTemplateVO template _templateDao findRoutingTemplate hType templateName if template null
router setDynamicallyScalable template isDynamicallyScalable router setRole Role VIRTUAL_ROUTER router _routerDao persist router reallocateRouterNetworks routerDeploymentDefinition router template null router _routerDao findById router getId catch final InsufficientCapacityException ex if allocateRetry iter hasNext s_logger debug hType continue else throw ex finally allocateRetry if startRouter try
if pubNet getBroadcastDomainType BroadcastDomainType Vxlan defaultNic setBroadcastType BroadcastDomainType Vxlan defaultNic setBroadcastUri BroadcastDomainType Vxlan toUri sourceNatIp getVlanTag defaultNic setIsolationUri BroadcastDomainType Vxlan toUri sourceNatIp getVlanTag else defaultNic setBroadcastType BroadcastDomainType Vlan defaultNic setBroadcastUri BroadcastDomainType Vlan toUri sourceNatIp getVlanTag defaultNic setIsolationUri IsolationType Vlan toUri sourceNatIp getVlanTag if hasGuestNic defaultNic setDeviceId final NetworkOffering publicOffering _networkModel getSystemAccountNetworkOfferings NetworkOffering SystemPublicNetwork get final List extends Network publicNetworks _networkMgr setupNetwork s_systemAccount publicOffering routerDeploymentDefinition getPlan null null false final String publicIp defaultNic getIPv4Address final NicVO peerNic _nicDao findByIp4AddressAndNetworkId publicIp publicNetworks get getId if peerNic null
Override public LinkedHashMap Network List extends NicProfile configureGuestNic final RouterDeploymentDefinition routerDeploymentDefinition throws ConcurrentOperationException InsufficientAddressCapacityException final LinkedHashMap Network List extends NicProfile networks new LinkedHashMap Network List extends NicProfile final Network guestNetwork routerDeploymentDefinition getGuestNetwork if guestNetwork null
Override public LinkedHashMap Network List extends NicProfile configureGuestNic final RouterDeploymentDefinition routerDeploymentDefinition throws ConcurrentOperationException InsufficientAddressCapacityException final LinkedHashMap Network List extends NicProfile networks new LinkedHashMap Network List extends NicProfile final Network guestNetwork routerDeploymentDefinition getGuestNetwork if guestNetwork null s_logger debug guestNetwork String defaultNetworkStartIp null defaultNetworkStartIpv6 null final Nic placeholder _networkModel getPlaceholderNicForRouter guestNetwork routerDeploymentDefinition getPodId if routerDeploymentDefinition isPublicNetwork if guestNetwork getCidr null if placeholder null placeholder getIPv4Address null
final Network guestNetwork routerDeploymentDefinition getGuestNetwork if guestNetwork null s_logger debug guestNetwork String defaultNetworkStartIp null defaultNetworkStartIpv6 null final Nic placeholder _networkModel getPlaceholderNicForRouter guestNetwork routerDeploymentDefinition getPodId if routerDeploymentDefinition isPublicNetwork if guestNetwork getCidr null if placeholder null placeholder getIPv4Address null s_logger debug placeholder getIPv4Address guestNetwork defaultNetworkStartIp placeholder getIPv4Address else final String startIp _networkModel getStartIpAddress guestNetwork getId if startIp null _ipAddressDao findByIpAndSourceNetworkId guestNetwork getId startIp getAllocatedTime null defaultNetworkStartIp startIp else if s_logger isDebugEnabled
String defaultNetworkStartIp null defaultNetworkStartIpv6 null final Nic placeholder _networkModel getPlaceholderNicForRouter guestNetwork routerDeploymentDefinition getPodId if routerDeploymentDefinition isPublicNetwork if guestNetwork getCidr null if placeholder null placeholder getIPv4Address null s_logger debug placeholder getIPv4Address guestNetwork defaultNetworkStartIp placeholder getIPv4Address else final String startIp _networkModel getStartIpAddress guestNetwork getId if startIp null _ipAddressDao findByIpAndSourceNetworkId guestNetwork getId startIp getAllocatedTime null defaultNetworkStartIp startIp else if s_logger isDebugEnabled s_logger debug startIp guestNetwork getId if guestNetwork getIp6Cidr null if placeholder null placeholder getIPv6Address null
else final String startIp _networkModel getStartIpAddress guestNetwork getId if startIp null _ipAddressDao findByIpAndSourceNetworkId guestNetwork getId startIp getAllocatedTime null defaultNetworkStartIp startIp else if s_logger isDebugEnabled s_logger debug startIp guestNetwork getId if guestNetwork getIp6Cidr null if placeholder null placeholder getIPv6Address null s_logger debug placeholder getIPv6Address guestNetwork defaultNetworkStartIpv6 placeholder getIPv6Address else final String startIpv6 _networkModel getStartIpv6Address guestNetwork getId if startIpv6 null _ipv6Dao findByNetworkIdAndIp guestNetwork getId startIpv6 null defaultNetworkStartIpv6 startIpv6 else if s_logger isDebugEnabled
Override public boolean validateHAProxyLBRule final LoadBalancingRule rule final String timeEndChar int haproxy_stats_port Integer parseInt _configDao getValue Config NetworkLBHaproxyStatsPort key if rule getSourcePortStart haproxy_stats_port if s_logger isDebugEnabled
DB public void processStopOrRebootAnswer final DomainRouterVO router final Answer answer Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final List Long routerGuestNtwkIds _routerDao getRouterNetworks router getId for final Long guestNtwkId routerGuestNtwkIds final UserStatisticsVO userStats _userStatsDao lock router getAccountId router getDataCenterId guestNtwkId null router getId router getType toString if userStats null final long currentBytesRcvd userStats getCurrentBytesReceived userStats setCurrentBytesReceived userStats setNetBytesReceived userStats getNetBytesReceived currentBytesRcvd final long currentBytesSent userStats getCurrentBytesSent userStats setCurrentBytesSent userStats setNetBytesSent userStats getNetBytesSent currentBytesSent _userStatsDao update userStats getId userStats
cal add Calendar MILLISECOND aggDate cal getTime getTime _dailyOrHourly true else aggDate cal getTime getTime _dailyOrHourly false if _usageAggregationRange UsageUtils USAGE_AGGREGATION_RANGE_MIN s_logger warn UsageUtils USAGE_AGGREGATION_RANGE_MIN _usageAggregationRange UsageUtils USAGE_AGGREGATION_RANGE_MIN final long initialDelay aggDate System currentTimeMillis if initialDelay s_logger warn _networkStatsUpdateExecutor scheduleAtFixedRate new NetworkStatsUpdateTask initialDelay _usageAggregationRange TimeUnit MILLISECONDS if _routerCheckInterval _checkExecutor scheduleAtFixedRate new CheckRouterTask _routerCheckInterval _routerCheckInterval TimeUnit SECONDS
updated true else if privateIP null final CheckRouterCommand command new CheckRouterCommand command setAccessDetail NetworkElementCommand ROUTER_IP _routerControlHelper getRouterControlIp router getId command setAccessDetail NetworkElementCommand ROUTER_NAME router getInstanceName command setWait final Answer origAnswer _agentMgr easySend router getHostId command CheckRouterAnswer answer null if origAnswer CheckRouterAnswer answer CheckRouterAnswer origAnswer else s_logger warn router getHostName RedundantState state RedundantState UNKNOWN if answer null if answer getResult
protected void recoverRedundantNetwork final DomainRouterVO masterRouter final DomainRouterVO backupRouter if masterRouter getState VirtualMachine State Running backupRouter getState VirtualMachine State Running final HostVO masterHost _hostDao findById masterRouter getHostId final HostVO backupHost _hostDao findById backupRouter getHostId if masterHost getState Status Up backupHost getState Status Up final String title backupRouter getInstanceName if s_logger isDebugEnabled
private boolean restartVpcInDomainRouter DomainRouterJoinVO router User user try
private boolean restartGuestNetworkInDomainRouter DomainRouterJoinVO router User user try
private List RouterHealthCheckResult parseHealthCheckResults final Map String Map String Map String String checksJson final long routerId final Map String Map String RouterHealthCheckResultVO checksInDb getHealthChecksFromDb routerId List RouterHealthCheckResult healthChecks new ArrayList final String lastRunKey for String checkType checksJson keySet if checksJson get checkType containsKey lastRunKey Map String String lastRun checksJson get checkType get lastRunKey
private List RouterHealthCheckResult parseHealthCheckResults final Map String Map String Map String String checksJson final long routerId final Map String Map String RouterHealthCheckResultVO checksInDb getHealthChecksFromDb routerId List RouterHealthCheckResult healthChecks new ArrayList final String lastRunKey for String checkType checksJson keySet if checksJson get checkType containsKey lastRunKey Map String String lastRun checksJson get checkType get lastRunKey s_logger info checkType lastRun get lastRun get lastRun get for String checkName checksJson get checkType keySet if lastRunKey equals checkName continue try final RouterHealthCheckResultVO hcVo parseHealthCheckVOFromJson routerId checkName checkType checksJson get checkType get checkName checksInDb healthChecks add hcVo catch Exception ex
if RouterHealthChecksEnabled value return false SetMonitorServiceCommand command createMonitorServiceCommand router null true true String controlIP getRouterControlIP router if StringUtils isBlank controlIP controlIP equals s_logger debug router getUuid return false s_logger info router getUuid Answer origAnswer null try origAnswer _agentMgr easySend router getHostId command catch final Exception e s_logger error router getInstanceName e return false if origAnswer null
s_logger debug router getUuid return false s_logger info router getUuid Answer origAnswer null try origAnswer _agentMgr easySend router getHostId command catch final Exception e s_logger error router getInstanceName e return false if origAnswer null s_logger error router getHostName return false GroupAnswer answer null if origAnswer GroupAnswer answer GroupAnswer origAnswer
s_logger info router getUuid Answer origAnswer null try origAnswer _agentMgr easySend router getHostId command catch final Exception e s_logger error router getInstanceName e return false if origAnswer null s_logger error router getHostName return false GroupAnswer answer null if origAnswer GroupAnswer answer GroupAnswer origAnswer else s_logger error router getHostName origAnswer getDetails
protected void getRouterAlerts try final List DomainRouterVO routers _routerDao listByStateAndManagementServer VirtualMachine State Running mgmtSrvrId
type if _disableRpFilter rpFilter if _disableRpFilter rpFilter buf append type rpFilter final String domain_suffix dc getDetail ZoneConfig DnsSearchOrder getName if domain_suffix null buf append append domain_suffix if profile getHypervisorType HypervisorType VMware profile getHypervisorType HypervisorType Hyperv buf append _routerExtraPublicNics if dnsProvided dhcpProvided if defaultDns1 null buf append append defaultDns1 if defaultDns2 null
Override public boolean finalizeCommandsOnStart final Commands cmds final VirtualMachineProfile profile final DomainRouterVO router _routerDao findById profile getId final NicProfile controlNic getControlNic profile if controlNic null
protected void finalizeUserDataAndDhcpOnStart final Commands cmds final DomainRouterVO router final Provider provider final Long guestNetworkId if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service Dhcp provider _networkModel isProviderSupportServiceInNetwork guestNetworkId Service Dns provider
final List StaticNat staticNats new ArrayList StaticNat final List FirewallRule firewallRulesIngress new ArrayList FirewallRule for final PublicIpAddress ip publicIps if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service PortForwarding provider pfRules addAll _pfRulesDao listForApplication ip getId if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service StaticNat provider staticNatFirewallRules addAll _rulesDao listByIpAndPurpose ip getId Purpose StaticNat if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service Firewall provider firewallRulesIngress addAll _rulesDao listByIpAndPurpose ip getId Purpose Firewall if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service Vpn provider final RemoteAccessVpn vpn _vpnDao findByPublicIpAddress ip getId if vpn null vpns add vpn if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service StaticNat provider if ip isOneToOneNat
if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service Firewall provider firewallRulesIngress addAll _rulesDao listByIpAndPurpose ip getId Purpose Firewall if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service Vpn provider final RemoteAccessVpn vpn _vpnDao findByPublicIpAddress ip getId if vpn null vpns add vpn if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service StaticNat provider if ip isOneToOneNat boolean revoke false if ip getState IpAddress State Releasing s_logger debug ip getAddress revoke true final StaticNatImpl staticNat new StaticNatImpl ip getAccountId ip getDomainId guestNetworkId ip getId ip getVmIp revoke staticNats add staticNat s_logger debug staticNats size router
if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service Vpn provider final RemoteAccessVpn vpn _vpnDao findByPublicIpAddress ip getId if vpn null vpns add vpn if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service StaticNat provider if ip isOneToOneNat boolean revoke false if ip getState IpAddress State Releasing s_logger debug ip getAddress revoke true final StaticNatImpl staticNat new StaticNatImpl ip getAccountId ip getDomainId guestNetworkId ip getId ip getVmIp revoke staticNats add staticNat s_logger debug staticNats size router if staticNats isEmpty _commandSetupHelper createApplyStaticNatCommands staticNats router cmds guestNetworkId
if vpn null vpns add vpn if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service StaticNat provider if ip isOneToOneNat boolean revoke false if ip getState IpAddress State Releasing s_logger debug ip getAddress revoke true final StaticNatImpl staticNat new StaticNatImpl ip getAccountId ip getDomainId guestNetworkId ip getId ip getVmIp revoke staticNats add staticNat s_logger debug staticNats size router if staticNats isEmpty _commandSetupHelper createApplyStaticNatCommands staticNats router cmds guestNetworkId s_logger debug firewallRulesIngress size router if firewallRulesIngress isEmpty
boolean revoke false if ip getState IpAddress State Releasing s_logger debug ip getAddress revoke true final StaticNatImpl staticNat new StaticNatImpl ip getAccountId ip getDomainId guestNetworkId ip getId ip getVmIp revoke staticNats add staticNat s_logger debug staticNats size router if staticNats isEmpty _commandSetupHelper createApplyStaticNatCommands staticNats router cmds guestNetworkId s_logger debug firewallRulesIngress size router if firewallRulesIngress isEmpty _commandSetupHelper createFirewallRulesCommands firewallRulesIngress router cmds guestNetworkId s_logger debug pfRules size router if pfRules isEmpty _commandSetupHelper createApplyPortForwardingRulesCommands pfRules router cmds guestNetworkId
if firewallRulesIngress isEmpty _commandSetupHelper createFirewallRulesCommands firewallRulesIngress router cmds guestNetworkId s_logger debug pfRules size router if pfRules isEmpty _commandSetupHelper createApplyPortForwardingRulesCommands pfRules router cmds guestNetworkId s_logger debug staticNatFirewallRules size router if staticNatFirewallRules isEmpty final List StaticNatRule staticNatRules new ArrayList StaticNatRule for final FirewallRule rule staticNatFirewallRules staticNatRules add _rulesMgr buildStaticNatRule rule false _commandSetupHelper createApplyStaticNatRulesCommands staticNatRules router cmds guestNetworkId s_logger debug vpns size router if vpns isEmpty for final RemoteAccessVpn vpn vpns _commandSetupHelper createApplyVpnCommands true vpn router cmds
protected void finalizeIpAssocForNetwork final Commands cmds final VirtualRouter router final Provider provider final Long guestNetworkId final Map String String vlanMacAddress final ArrayList extends PublicIpAddress publicIps getPublicIpsToApply router provider guestNetworkId if publicIps null publicIps isEmpty
protected ArrayList extends PublicIpAddress getPublicIpsToApply final VirtualRouter router final Provider provider final Long guestNetworkId final com cloud network IpAddress State skipInStates final long ownerId router getAccountId final List extends IpAddress userIps final Network guestNetwork _networkDao findById guestNetworkId if guestNetwork getGuestType GuestType Shared userIps _networkModel listPublicIpsAssignedToGuestNtwk guestNetworkId null else userIps _networkModel listPublicIpsAssignedToGuestNtwk ownerId guestNetworkId null final List PublicIp allPublicIps new ArrayList PublicIp if userIps null userIps isEmpty boolean addIp true for final IpAddress userIp userIps if skipInStates null for final IpAddress State stateToSkip skipInStates if userIp getState stateToSkip
Override public boolean finalizeStart final VirtualMachineProfile profile final long hostId final Commands cmds final ReservationContext context final DomainRouterVO router _routerDao findById profile getId for final Answer answer cmds getAnswers if answer getResult final String cmdClassName answer getClass getCanonicalName replace final String errorMessage cmdClassName final String errorDetails answer getDetails answer toString _alertMgr sendAlert AlertService AlertType ALERT_TYPE_DOMAIN_ROUTER router getDataCenterId router getPodIdToDeployIn errorMessage errorDetails
Override public void finalizeStop final VirtualMachineProfile profile final Answer answer if answer null final VirtualMachine vm profile getVirtualMachine final DomainRouterVO domR _routerDao findById vm getId processStopOrRebootAnswer domR answer final List extends Nic routerNics _nicDao listByVmId profile getId for final Nic nic routerNics final Network network _networkModel getNetwork nic getNetworkId final DataCenterVO dcVO _dcDao findById network getDataCenterId if network getTrafficType TrafficType Guest nic getBroadcastUri null nic getBroadcastUri getScheme equals final NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri false final NetworkTopology networkTopology _networkTopologyContext retrieveNetworkTopology dcVO try networkTopology setupDhcpForPvlan false domR domR getHostId nicProfile catch final ResourceUnavailableException e
s_logger warn throw new ResourceUnavailableException DataCenter class network getDataCenterId for final VirtualRouter router routers if router getState VirtualMachine State Running s_logger warn router getState throw new ResourceUnavailableException router getState DataCenter class network getDataCenterId final Commands cmds new Commands Command OnError Stop _commandSetupHelper createApplyVpnCommands true vpn router cmds if _nwHelper sendCommandsToRouter router cmds throw new AgentUnavailableException router getHostId Answer answer cmds getAnswer if answer null s_logger error router getDataCenterId vpn getAccountId router getInstanceName throw new ResourceUnavailableException router getDataCenterId vpn getAccountId router getInstanceName DataCenter class router getDataCenterId if answer getResult
if router getState VirtualMachine State Running s_logger warn router getState throw new ResourceUnavailableException router getState DataCenter class network getDataCenterId final Commands cmds new Commands Command OnError Stop _commandSetupHelper createApplyVpnCommands true vpn router cmds if _nwHelper sendCommandsToRouter router cmds throw new AgentUnavailableException router getHostId Answer answer cmds getAnswer if answer null s_logger error router getDataCenterId vpn getAccountId router getInstanceName throw new ResourceUnavailableException router getDataCenterId vpn getAccountId router getInstanceName DataCenter class router getDataCenterId if answer getResult s_logger error router getDataCenterId vpn getAccountId router getInstanceName answer getDetails throw new ResourceUnavailableException router getDataCenterId vpn getAccountId router getInstanceName answer getDetails DataCenter class router getDataCenterId answer cmds getAnswer
Override public DomainRouterVO stop final VirtualRouter router final boolean forced final User user final Account caller throws ConcurrentOperationException ResourceUnavailableException
Override public boolean removeDhcpSupportForSubnet final Network network final List DomainRouterVO routers throws ResourceUnavailableException if routers null routers isEmpty s_logger warn throw new ResourceUnavailableException network getId DataCenter class network getDataCenterId for final DomainRouterVO router routers if router getState VirtualMachine State Running s_logger warn throw new ResourceUnavailableException router getState DataCenter class network getDataCenterId final Commands cmds new Commands Command OnError Continue final List NicIpAliasVO revokedIpAliasVOs _nicIpAliasDao listByNetworkIdAndState network getId NicIpAlias State revoked s_logger debug revokedIpAliasVOs size final List IpAliasTO revokedIpAliasTOs new ArrayList IpAliasTO for final NicIpAliasVO revokedAliasVO revokedIpAliasVOs revokedIpAliasTOs add new IpAliasTO revokedAliasVO getIp4Address revokedAliasVO getNetmask revokedAliasVO getAliasCount toString final List NicIpAliasVO aliasVOs _nicIpAliasDao listByNetworkIdAndState network getId NicIpAlias State active
Override public void processConnect final Host host final StartupCommand cmd final boolean forRebalance throws ConnectionException final List DomainRouterVO routers _routerDao listIsolatedByHostId host getId for DomainRouterVO router routers if router isStopPending
continue if answer null if answer getResult s_logger warn router getInstanceName router getHostId answer getDetails continue try if answer getBytesReceived answer getBytesSent s_logger debug continue final NetworkUsageAnswer answerFinal answer Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final UserStatisticsVO stats _userStatsDao lock router getAccountId router getDataCenterId network getId forVpc routerNic getIPv4Address null router getId routerType if stats null s_logger warn router getAccountId
s_logger warn router getInstanceName router getHostId answer getDetails continue try if answer getBytesReceived answer getBytesSent s_logger debug continue final NetworkUsageAnswer answerFinal answer Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final UserStatisticsVO stats _userStatsDao lock router getAccountId router getDataCenterId network getId forVpc routerNic getIPv4Address null router getId routerType if stats null s_logger warn router getAccountId return if previousStats null previousStats getCurrentBytesReceived stats getCurrentBytesReceived previousStats getCurrentBytesSent stats getCurrentBytesSent s_logger debug answerFinal getRouterName answerFinal getBytesReceived answerFinal getBytesSent
s_logger debug continue final NetworkUsageAnswer answerFinal answer Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final UserStatisticsVO stats _userStatsDao lock router getAccountId router getDataCenterId network getId forVpc routerNic getIPv4Address null router getId routerType if stats null s_logger warn router getAccountId return if previousStats null previousStats getCurrentBytesReceived stats getCurrentBytesReceived previousStats getCurrentBytesSent stats getCurrentBytesSent s_logger debug answerFinal getRouterName answerFinal getBytesReceived answerFinal getBytesSent return if stats getCurrentBytesReceived answerFinal getBytesReceived if s_logger isDebugEnabled s_logger debug answerFinal getRouterName toHumanReadableSize answerFinal getBytesReceived toHumanReadableSize stats getCurrentBytesReceived
private List Long rebootRouters final List DomainRouterVO routers final List Long jobIds new ArrayList Long for final DomainRouterVO router routers if _nwHelper checkRouterVersion router
for final DomainRouterVO router routers if _nwHelper checkRouterVersion router s_logger debug router getId final Map String String params new HashMap String String params put params put router getAccountId final RebootRouterCmd cmd new RebootRouterCmd ComponentContext inject cmd params put router getId params put final AsyncJobVO job new AsyncJobVO User UID_SYSTEM router getAccountId RebootRouterCmd class getName ApiGsonHelper getBuilder create toJson params router getId cmd getInstanceType null cmd getInstanceType toString null null job setDispatcher _asyncDispatcher getName final long jobId _asyncMgr submitAsyncJob job jobIds add jobId else
Override public boolean postStateTransitionEvent final StateMachine2 Transition VirtualMachine State VirtualMachine Event transition final VirtualMachine vo final boolean status final Object opaque final VirtualMachine State newState transition getToState final VirtualMachine Event event transition getEvent if vo getType VirtualMachine Type DomainRouter event VirtualMachine Event FollowAgentPowerOnReport newState VirtualMachine State Running isOutOfBandMigrated opaque
try _routerDao addRouterToGuestNetwork router network final NicProfile guestNic _itMgr addVmToNetwork router network null if guestNic null result setupVpcGuestNetwork network router true guestNic else s_logger warn router network result false if result boolean reprogramNetwork params null params get Param ReProgramGuestNetworks null Boolean params get Param ReProgramGuestNetworks true sendNetworkRulesToRouter router getId network getId reprogramNetwork catch final Exception ex s_logger warn router network ex result false finally
final NicProfile guestNic _itMgr addVmToNetwork router network null if guestNic null result setupVpcGuestNetwork network router true guestNic else s_logger warn router network result false if result boolean reprogramNetwork params null params get Param ReProgramGuestNetworks null Boolean params get Param ReProgramGuestNetworks true sendNetworkRulesToRouter router getId network getId reprogramNetwork catch final Exception ex s_logger warn router network ex result false finally if result s_logger debug router network
else s_logger warn router network result false if result boolean reprogramNetwork params null params get Param ReProgramGuestNetworks null Boolean params get Param ReProgramGuestNetworks true sendNetworkRulesToRouter router getId network getId reprogramNetwork catch final Exception ex s_logger warn router network ex result false finally if result s_logger debug router network if removeVpcRouterFromGuestNetwork router network s_logger debug router network else
if nic getTrafficType TrafficType Public defaultDns1 nic getIPv4Dns1 defaultDns2 nic getIPv4Dns2 s_logger debug nic nic getTrafficType it remove final StringBuilder buf profile getBootArgsBuilder final Vpc vpc _entityMgr findById Vpc class vpcId buf append vpc getCidr vpc getNetworkDomain buf append append defaultDns1 if defaultDns2 null buf append append defaultDns2 VpcGatewayVO privateGatewayForVpc _vpcGatewayDao getPrivateGatewayForVpc domainRouterVO getVpcId if privateGatewayForVpc null String ip4Address privateGatewayForVpc getIp4Address buf append append ip4Address
_userStatsDao persist stats if sourceNat isEmpty _commandSetupHelper createVpcAssociatePublicIPCommands domainRouterVO sourceNat cmds vlanMacAddress for final Pair Nic Network nicNtwk guestNics final Nic guestNic nicNtwk first final PlugNicCommand plugNicCmd new PlugNicCommand _nwHelper getNicTO domainRouterVO guestNic getNetworkId null domainRouterVO getInstanceName domainRouterVO getType details cmds addCommand plugNicCmd if _networkModel isPrivateGateway guestNic getNetworkId final VirtualMachine vm _vmDao findById domainRouterVO getId final NicProfile nicProfile _networkModel getNicProfile vm guestNic getNetworkId null final SetupGuestNetworkCommand setupCmd _commandSetupHelper createSetupGuestNetworkCommand domainRouterVO true nicProfile cmds addCommand setupCmd else final PrivateIpVO ipVO _privateIpDao findByIpAndSourceNetworkId guestNic getNetworkId guestNic getIPv4Address final Network network _networkDao findById guestNic getNetworkId
else final PrivateIpVO ipVO _privateIpDao findByIpAndSourceNetworkId guestNic getNetworkId guestNic getIPv4Address final Network network _networkDao findById guestNic getNetworkId BroadcastDomainType getValue network getBroadcastUri final String netmask NetUtils getCidrNetmask network getCidr final PrivateIpAddress ip new PrivateIpAddress ipVO network getBroadcastUri toString network getGateway netmask guestNic getMacAddress final List PrivateIpAddress privateIps new ArrayList PrivateIpAddress privateIps add ip _commandSetupHelper createVpcAssociatePrivateIPCommands domainRouterVO privateIps cmds true final Long privateGwAclId _vpcGatewayDao getNetworkAclIdForPrivateIp ipVO getVpcId ipVO getNetworkId ipVO getIpAddress if privateGwAclId null final List NetworkACLItemVO networkACLs _networkACLItemDao listByACL privateGwAclId s_logger debug networkACLs size domainRouterVO ipVO getIpAddress _commandSetupHelper createNetworkACLsCommands networkACLs domainRouterVO cmds ipVO getNetworkId true catch final Exception ex
Override protected void finalizeNetworkRulesForNetwork final Commands cmds final DomainRouterVO domainRouterVO final Provider provider final Long guestNetworkId super finalizeNetworkRulesForNetwork cmds domainRouterVO provider guestNetworkId if domainRouterVO getVpcId null if domainRouterVO getState State Starting domainRouterVO getState State Running if _networkModel isProviderSupportServiceInNetwork guestNetworkId Service NetworkACL Provider VPCVirtualRouter final List NetworkACLItemVO networkACLs _networkACLMgr listNetworkACLItems guestNetworkId if networkACLs null networkACLs isEmpty
protected boolean setupVpcPrivateNetwork final VirtualRouter router final boolean add final NicProfile privateNic throws ResourceUnavailableException if router getState State Running final PrivateIpVO ipVO _privateIpDao findByIpAndSourceNetworkId privateNic getNetworkId privateNic getIPv4Address final Network network _networkDao findById privateNic getNetworkId final String netmask NetUtils getCidrNetmask network getCidr final PrivateIpAddress ip new PrivateIpAddress ipVO network getBroadcastUri toString network getGateway netmask privateNic getMacAddress final List PrivateIpAddress privateIps new ArrayList PrivateIpAddress privateIps add ip final Commands cmds new Commands Command OnError Stop _commandSetupHelper createVpcAssociatePrivateIPCommands router privateIps cmds add try if _nwHelper sendCommandsToRouter router cmds
final List PrivateIpAddress privateIps new ArrayList PrivateIpAddress privateIps add ip final Commands cmds new Commands Command OnError Stop _commandSetupHelper createVpcAssociatePrivateIPCommands router privateIps cmds add try if _nwHelper sendCommandsToRouter router cmds s_logger debug ip network return true else s_logger warn ip network return false catch final Exception ex s_logger warn add network return false else if router getState State Stopped router getState State Stopping
Override public boolean destroyPrivateGateway final PrivateGateway gateway final VirtualRouter router throws ConcurrentOperationException ResourceUnavailableException boolean result true if _networkModel isVmPartOfNetwork router getId gateway getNetworkId
if _networkModel isVmPartOfNetwork router getId gateway getNetworkId s_logger debug gateway return result final Network privateNetwork _networkModel getNetwork gateway getNetworkId final NicProfile nicProfile _networkModel getNicProfile router privateNetwork getId null s_logger debug gateway router result setupVpcPrivateNetwork router false nicProfile if result s_logger warn gateway router return false if _networkACLMgr revokeACLItemsForPrivateGw gateway s_logger debug gateway router return false s_logger debug router privateNetwork result result _itMgr removeVmFromNetwork router privateNetwork null
ip setState IpAddress State Releasing if ip getState IpAddress State Releasing final Nic nic _nicDao findByIp4AddressAndNetworkIdAndInstanceId publicNtwkId router getId ip getAddress addr if nic null nicsToUnplug put ip getVlanTag ip s_logger debug ip ip getVlanTag publicNtwkId for final PublicIpAddress ip publicIps final URI broadcastUri BroadcastDomainType Vlan toUri ip getVlanTag final long publicNtwkId ip getNetworkId if _vpcMgr isIpAllocatedToVpc ip ip setState IpAddress State Releasing if ip getState IpAddress State Allocated ip getState IpAddress State Allocating final Nic nic _nicDao findByNetworkIdInstanceIdAndBroadcastUri publicNtwkId router getId broadcastUri toString if nic null nicsToPlug get ip getVlanTag null nicsToPlug put ip getVlanTag ip
for final PublicIpAddress ip publicIps final URI broadcastUri BroadcastDomainType Vlan toUri ip getVlanTag final long publicNtwkId ip getNetworkId if _vpcMgr isIpAllocatedToVpc ip ip setState IpAddress State Releasing if ip getState IpAddress State Allocated ip getState IpAddress State Allocating final Nic nic _nicDao findByNetworkIdInstanceIdAndBroadcastUri publicNtwkId router getId broadcastUri toString if nic null nicsToPlug get ip getVlanTag null nicsToPlug put ip getVlanTag ip s_logger debug ip ip getVlanTag publicNtwkId else final PublicIpAddress nicToUnplug nicsToUnplug get ip getVlanTag if nicToUnplug null final NicVO nicVO _nicDao findByIp4AddressAndNetworkIdAndInstanceId publicNtwkId router getId nicToUnplug getAddress addr nicVO setIPv4Address ip getAddress addr
final Commands cmds new Commands Command OnError Stop _commandSetupHelper createApplyVpnCommands true vpn router cmds try _agentMgr send router getHostId cmds catch final OperationTimedoutException e s_logger debug e throw new AgentUnavailableException router getHostId e Answer answer cmds getAnswer if answer null answer getResult String errorMessage answer null answer getDetails s_logger error router getDataCenterId vpn getAccountId router getInstanceName errorMessage throw new ResourceUnavailableException router getDataCenterId vpn getAccountId router getInstanceName errorMessage DataCenter class router getDataCenterId answer cmds getAnswer if answer null answer getResult String errorMessage answer null answer getDetails
ip setState IpAddress State Releasing if ip getState IpAddress State Releasing Nic nic nicDao findByIp4AddressAndNetworkIdAndInstanceId publicNtwkId _router getId ip getAddress addr if nic null nicsToUnplug put ip getVlanTag ip s_logger debug ip ip getVlanTag publicNtwkId for PublicIpAddress ip _ipAddresses URI broadcastUri BroadcastDomainType Vlan toUri ip getVlanTag long publicNtwkId ip getNetworkId if vpcMgr isIpAllocatedToVpc ip ip setState IpAddress State Releasing if ip getState IpAddress State Allocated ip getState IpAddress State Allocating Nic nic nicDao findByNetworkIdInstanceIdAndBroadcastUri publicNtwkId _router getId broadcastUri toString if nic null nicsToPlug get ip getVlanTag null nicsToPlug put ip getVlanTag ip
for PublicIpAddress ip _ipAddresses URI broadcastUri BroadcastDomainType Vlan toUri ip getVlanTag long publicNtwkId ip getNetworkId if vpcMgr isIpAllocatedToVpc ip ip setState IpAddress State Releasing if ip getState IpAddress State Allocated ip getState IpAddress State Allocating Nic nic nicDao findByNetworkIdInstanceIdAndBroadcastUri publicNtwkId _router getId broadcastUri toString if nic null nicsToPlug get ip getVlanTag null nicsToPlug put ip getVlanTag ip s_logger debug ip ip getVlanTag publicNtwkId else final PublicIpAddress nicToUnplug nicsToUnplug get ip getVlanTag if nicToUnplug null NicVO nicVO nicDao findByIp4AddressAndNetworkIdAndInstanceId publicNtwkId _router getId nicToUnplug getAddress addr nicVO setIPv4Address ip getAddress addr
final NicProfileHelper nicProfileHelper visitor getVirtualNetworkApplianceFactory getNicProfileHelper final NicProfile requested nicProfileHelper createPrivateNicProfileForGateway _privateGateway _router final NetworkHelper networkHelper visitor getVirtualNetworkApplianceFactory getNetworkHelper if networkHelper checkRouterVersion _router s_logger warn _router getId return false final VirtualMachineManager itMgr visitor getVirtualNetworkApplianceFactory getItMgr _nicProfile itMgr addVmToNetwork _router _network requested if _nicProfile null _isAddOperation true result visitor visit this catch final Exception ex s_logger warn _privateGateway _router ex finally if result
s_logger warn _router getId return false final VirtualMachineManager itMgr visitor getVirtualNetworkApplianceFactory getItMgr _nicProfile itMgr addVmToNetwork _router _network requested if _nicProfile null _isAddOperation true result visitor visit this catch final Exception ex s_logger warn _privateGateway _router ex finally if result s_logger debug _privateGateway _router _isAddOperation false final boolean isRemoved destroyPrivateGateway visitor if isRemoved
protected boolean destroyPrivateGateway final NetworkTopologyVisitor visitor throws ConcurrentOperationException ResourceUnavailableException final NetworkModel networkModel visitor getVirtualNetworkApplianceFactory getNetworkModel if networkModel isVmPartOfNetwork _router getId _privateGateway getNetworkId
return true final Network privateNetwork networkModel getNetwork _privateGateway getNetworkId s_logger debug _privateGateway _router _nicProfile networkModel getNicProfile _router privateNetwork getId null boolean result visitor visit this if result s_logger warn _privateGateway _router return false final NetworkACLManager networkACLMgr visitor getVirtualNetworkApplianceFactory getNetworkACLMgr if networkACLMgr revokeACLItemsForPrivateGw _privateGateway s_logger debug _privateGateway _router return false s_logger debug _router privateNetwork final VirtualMachineManager itMgr visitor getVirtualNetworkApplianceFactory getItMgr result result itMgr removeVmFromNetwork _router privateNetwork null
final Account caller ctx getCallingAccount final Long ipAddrId rule getSourceIpAddressId IPAddressVO ipAddress _ipAddressDao findById ipAddrId if ipAddress null throw new InvalidParameterValueException ipAddrId else if ipAddress isOneToOneNat throw new InvalidParameterValueException ipAddrId final Long networkId rule getNetworkId Network network _networkModel getNetwork networkId boolean performedIpAssoc false Nic guestNic if ipAddress getAssociatedWithNetworkId null boolean assignToVpcNtwk network getVpcId null ipAddress getVpcId null ipAddress getVpcId longValue network getVpcId if assignToVpcNtwk _networkModel checkIpForService ipAddress Service PortForwarding networkId
if network null throw new InvalidParameterValueException guestNic _networkModel getNicInNetwork vmId networkId if guestNic null throw new InvalidParameterValueException dstIp guestNic getIPv4Address if _networkModel areServicesSupportedInNetwork network getId Service StaticNat throw new InvalidParameterValueException if isSystemVm UserVmVO vm _vmDao findById vmId if vm null throw new InvalidParameterValueException ipId vmId if ipAddress getAssociatedWithNetworkId null boolean assignToVpcNtwk network getVpcId null ipAddress getVpcId null ipAddress getVpcId longValue network getVpcId if assignToVpcNtwk
if _networkModel areServicesSupportedInNetwork network getId Service StaticNat throw new InvalidParameterValueException if isSystemVm UserVmVO vm _vmDao findById vmId if vm null throw new InvalidParameterValueException ipId vmId if ipAddress getAssociatedWithNetworkId null boolean assignToVpcNtwk network getVpcId null ipAddress getVpcId null ipAddress getVpcId longValue network getVpcId if assignToVpcNtwk _networkModel checkIpForService ipAddress Service StaticNat networkId s_logger debug networkId try ipAddress _ipAddrMgr associateIPToGuestNetwork ipId networkId false performedIpAssoc true catch Exception ex
if loadBalancingRules null loadBalancingRules isEmpty throw new NetworkRuleConflictException ipAddress else if ipAddress getAssociatedWithVmId null ipAddress getAssociatedWithVmId longValue vmId throw new NetworkRuleConflictException ipAddress vmId IPAddressVO oldIP _ipAddressDao findByAssociatedVmIdAndVmIp vmId vmIp if oldIP null Long networkId oldIP getAssociatedWithNetworkId VMInstanceVO vm _vmInstanceDao findById vmId boolean reassignStaticNat false if networkId null Network guestNetwork _networkModel getNetwork networkId NetworkOffering offering _entityMgr findById NetworkOffering class guestNetwork getNetworkOfferingId if offering isElasticIp reassignStaticNat true if reassignStaticNat
protected boolean applyPortForwardingRules long ipId boolean continueOnError Account caller List PortForwardingRuleVO rules _portForwardingDao listForApplication ipId if rules size
protected boolean applyStaticNatRulesForIp long sourceIpId boolean continueOnError Account caller boolean forRevoke List extends FirewallRule rules _firewallDao listByIpAndPurpose sourceIpId Purpose StaticNat List StaticNatRule staticNatRules new ArrayList StaticNatRule if rules size
Override public boolean applyPortForwardingRulesForNetwork long networkId boolean continueOnError Account caller List PortForwardingRuleVO rules listByNetworkId networkId if rules size
Override public boolean applyStaticNatRulesForNetwork long networkId boolean continueOnError Account caller List FirewallRuleVO rules _firewallDao listByNetworkAndPurpose networkId Purpose StaticNat List StaticNatRule staticNatRules new ArrayList StaticNatRule if rules size
Override public boolean applyStaticNatsForNetwork long networkId boolean continueOnError Account caller List IPAddressVO ips _ipAddressDao listStaticNatPublicIps networkId if ips isEmpty
Override public boolean revokeAllPFAndStaticNatRulesForIp long ipId long userId Account caller throws ResourceUnavailableException List FirewallRule rules new ArrayList FirewallRule List PortForwardingRuleVO pfRules _portForwardingDao listByIpAndNotRevoked ipId if s_logger isDebugEnabled
revokeStaticNatRuleInternal rule getId caller userId false IPAddressVO ipAddress _ipAddressDao findById ipId Long vmId ipAddress getAssociatedWithVmId Long networkId ipAddress getAssociatedWithNetworkId boolean success true success success applyPortForwardingRules ipId _ipAddrMgr RulesContinueOnError value caller success success applyStaticNatRulesForIp ipId _ipAddrMgr RulesContinueOnError value caller true if vmId null networkId null Network guestNetwork _networkModel getNetwork networkId Nic guestNic _networkModel getNicInNetwork vmId guestNetwork getId if applyStaticNatForIp ipId false caller true if ipAddress getState IpAddress State Releasing applyUserData vmId guestNetwork guestNic else success false
Override public boolean revokeAllPFStaticNatRulesForNetwork long networkId long userId Account caller throws ResourceUnavailableException List FirewallRule rules new ArrayList FirewallRule List PortForwardingRuleVO pfRules _portForwardingDao listByNetwork networkId if s_logger isDebugEnabled
List FirewallRuleVO staticNatRules _firewallDao listByNetworkAndPurpose networkId Purpose StaticNat if s_logger isDebugEnabled s_logger debug staticNatRules size networkId for PortForwardingRuleVO rule pfRules revokePortForwardingRuleInternal rule getId caller userId false for FirewallRuleVO rule staticNatRules revokeStaticNatRuleInternal rule getId caller userId false boolean success true success success applyPortForwardingRulesForNetwork networkId true caller success success applyPortForwardingRulesForNetwork networkId _ipAddrMgr RulesContinueOnError value caller success success applyStaticNatRulesForNetwork networkId true caller success success applyStaticNatRulesForNetwork networkId _ipAddrMgr RulesContinueOnError value caller rules addAll _portForwardingDao listByNetworkAndNotRevoked networkId rules addAll _firewallDao listByNetworkAndPurposeAndNotRevoked networkId Purpose StaticNat if s_logger isDebugEnabled
Override public boolean applyStaticNatForNetwork long networkId boolean continueOnError Account caller boolean forRevoke List extends IpAddress staticNatIps _ipAddressDao listStaticNatPublicIps networkId List StaticNat staticNats new ArrayList StaticNat for IpAddress staticNatIp staticNatIps staticNats addAll createStaticNatForIp staticNatIp caller forRevoke if staticNats null staticNats isEmpty if forRevoke s_logger debug staticNats size networkId try if _ipAddrMgr applyStaticNats staticNats continueOnError forRevoke return false catch ResourceUnavailableException ex s_logger warn ex return false else
protected List StaticNat createStaticNatForIp IpAddress sourceIp Account caller boolean forRevoke List StaticNat staticNats new ArrayList StaticNat if sourceIp isOneToOneNat
Override public List FirewallRuleVO listAssociatedRulesForGuestNic Nic nic
Override public List FirewallRuleVO listAssociatedRulesForGuestNic Nic nic s_logger debug nic getId List FirewallRuleVO result new ArrayList FirewallRuleVO result addAll _portForwardingDao listByNetworkAndDestIpAddr nic getIPv4Address nic getNetworkId if result size
List FirewallRuleVO result new ArrayList FirewallRuleVO result addAll _portForwardingDao listByNetworkAndDestIpAddr nic getIPv4Address nic getNetworkId if result size s_logger debug result size nic getNetworkId List FirewallRuleVO staticNatRules _firewallDao listStaticNatByVmId nic getInstanceId for FirewallRuleVO rule staticNatRules if rule getNetworkId nic getNetworkId result add rule s_logger debug rule getId rule getPurpose List extends IpAddress staticNatIps _ipAddressDao listStaticNatPublicIps nic getNetworkId for IpAddress ip staticNatIps if ip getVmIp null ip getVmIp equals nic getIPv4Address VMInstanceVO vm _vmInstanceDao findById nic getInstanceId FirewallRuleVO staticNatRule new FirewallRuleVO null ip getId NetUtils ALL_PROTO toString nic getNetworkId vm getAccountId vm getDomainId Purpose StaticNat null null null null null result add staticNatRule
for FirewallRuleVO rule staticNatRules if rule getNetworkId nic getNetworkId result add rule s_logger debug rule getId rule getPurpose List extends IpAddress staticNatIps _ipAddressDao listStaticNatPublicIps nic getNetworkId for IpAddress ip staticNatIps if ip getVmIp null ip getVmIp equals nic getIPv4Address VMInstanceVO vm _vmInstanceDao findById nic getInstanceId FirewallRuleVO staticNatRule new FirewallRuleVO null ip getId NetUtils ALL_PROTO toString nic getNetworkId vm getAccountId vm getDomainId Purpose StaticNat null null null null null result add staticNatRule s_logger debug staticNatRule getId staticNatRule getPurpose List LoadBalancerVMMapVO lbMapList _loadBalancerVMMapDao listByInstanceId nic getInstanceId for LoadBalancerVMMapVO lb lbMapList FirewallRuleVO lbRule _firewallDao findById lb getLoadBalancerId if lbRule getNetworkId nic getNetworkId
Override public boolean processAnswers long agentId long seq Answer answers List Long affectedVms new ArrayList Long for Answer ans answers if ans SecurityGroupRuleAnswer SecurityGroupRuleAnswer ruleAnswer SecurityGroupRuleAnswer ans if ans getResult
for Answer ans answers if ans SecurityGroupRuleAnswer SecurityGroupRuleAnswer ruleAnswer SecurityGroupRuleAnswer ans if ans getResult s_logger debug ruleAnswer toString agentId _workDao updateStep ruleAnswer getVmId ruleAnswer getLogSequenceNumber Step Done recordSuccess ruleAnswer getVmId else _workDao updateStep ruleAnswer getVmId ruleAnswer getLogSequenceNumber Step Error s_logger debug ruleAnswer toString agentId ruleAnswer getDetails if ruleAnswer getReason FailureReason CANNOT_BRIDGE_FIREWALL s_logger debug ruleAnswer getVmId agentId else if ruleAnswer getReason FailureReason PROGRAMMING_FAILED if checkShouldRetryOnFailure ruleAnswer getVmId
if ans getResult s_logger debug ruleAnswer toString agentId _workDao updateStep ruleAnswer getVmId ruleAnswer getLogSequenceNumber Step Done recordSuccess ruleAnswer getVmId else _workDao updateStep ruleAnswer getVmId ruleAnswer getLogSequenceNumber Step Error s_logger debug ruleAnswer toString agentId ruleAnswer getDetails if ruleAnswer getReason FailureReason CANNOT_BRIDGE_FIREWALL s_logger debug ruleAnswer getVmId agentId else if ruleAnswer getReason FailureReason PROGRAMMING_FAILED if checkShouldRetryOnFailure ruleAnswer getVmId s_logger debug ruleAnswer getVmId affectedVms add ruleAnswer getVmId else
throw new InvalidParameterValueException authorizedAccountName securityGroupId protocol startPortOrType endPortOrCode SecurityGroupVO groupVO _securityGroupDao findByAccountAndName authorizedAccount getId group if groupVO null throw new InvalidParameterValueException group authorizedAccountName domainId if domainId groupVO getDomainId throw new PermissionDeniedException groupVO getDomainId authorizedGroups add groupVO final Set SecurityGroupVO authorizedGroups2 new TreeSet SecurityGroupVO new SecurityGroupVOComparator authorizedGroups2 addAll authorizedGroups final Integer startPortOrTypeFinal startPortOrType final Integer endPortOrCodeFinal endPortOrCode final String protocolFinal protocol List SecurityGroupRuleVO newRules Transaction execute new TransactionCallback List SecurityGroupRuleVO Override public List SecurityGroupRuleVO doInTransaction TransactionStatus status SecurityGroup securityGroup _securityGroupDao acquireInLockTable securityGroupId
private boolean revokeSecurityGroupRule final Long id SecurityRuleType type Account caller CallContext current getCallingAccount final SecurityGroupRuleVO rule _securityGroupRuleDao findById id if rule null
if type rule getRuleType s_logger debug id throw new InvalidParameterValueException id SecurityGroup securityGroup _securityGroupDao findById rule getSecurityGroupId _accountMgr checkAccess caller AccessType OperateEntry true securityGroup long securityGroupId rule getSecurityGroupId Boolean result Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status SecurityGroupVO groupHandle null try groupHandle _securityGroupDao acquireInLockTable rule getSecurityGroupId if groupHandle null s_logger warn rule getSecurityGroupId return false _securityGroupRuleDao remove id
s_logger warn rule getSecurityGroupId return false _securityGroupRuleDao remove id s_logger debug id return true catch Exception e s_logger warn e throw new CloudRuntimeException e finally if groupHandle null _securityGroupDao releaseFromLockTable groupHandle getId try final ArrayList Long affectedVms new ArrayList Long affectedVms addAll _securityGroupVMMapDao listVmIdsBySecurityGroup securityGroupId
Override public SecurityGroupVO createSecurityGroup String name String description Long domainId Long accountId String accountName SecurityGroupVO group _securityGroupDao findByAccountAndName accountId name if group null group new SecurityGroupVO name description domainId accountId group _securityGroupDao persist group
Override public boolean configure String name Map String Object params throws ConfigurationException Map String String configs _configDao getConfiguration params _numWorkerThreads NumbersUtil parseInt configs get Config SecurityGroupWorkerThreads key WORKER_THREAD_COUNT _timeBetweenCleanups NumbersUtil parseInt configs get Config SecurityGroupWorkCleanupInterval key TIME_BETWEEN_CLEANUPS _globalWorkLockTimeout NumbersUtil parseInt configs get Config SecurityGroupWorkGlobalLockTimeout key VirtualMachine State getStateMachine registerListener this _answerListener new SecurityGroupListener this _agentMgr _workDao _agentMgr registerForHostEvents _answerListener true true true _serverId ManagementServerNode getManagementServerId
if work getStep Step Done if s_logger isDebugEnabled s_logger debug userVmId ArrayList Long affectedVms new ArrayList Long affectedVms add userVmId scheduleRulesetUpdateToHosts affectedVms false _timeBetweenCleanups 1000l return s_logger debug work Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status UserVm vm null Long seqnum null boolean locked false try vm _userVMDao acquireInLockTable work getInstanceId
VmRulesetLogVO log _rulesetLogDao findByVmId userVmId if log null s_logger warn userVmId return seqnum log getLogsequence if vm null vm getState State Running Map PortAndProto Set String ingressRules generateRulesForVM userVmId SecurityRuleType IngressRule Map PortAndProto Set String egressRules generateRulesForVM userVmId SecurityRuleType EgressRule agentId vm getHostId if agentId null NicVO nic _nicDao findFirstNicForVM vm getId List String nicSecIps null if nic null if nic getSecondaryIp nicSecIps _nicSecIpDao getSecondaryIpAddressesForNic nic getId
SecurityGroupVO group _securityGroupDao findById groupId if group null throw new InvalidParameterValueException groupId if newName null s_logger debug groupId return group if StringUtils isBlank newName throw new InvalidParameterValueException _accountMgr checkAccess caller null true group return Transaction execute new TransactionCallback SecurityGroupVO Override public SecurityGroupVO doInTransaction TransactionStatus status SecurityGroupVO group _securityGroupDao lockRow groupId true if group null throw new InvalidParameterValueException groupId if newName equals group getName
if StringUtils isBlank newName throw new InvalidParameterValueException _accountMgr checkAccess caller null true group return Transaction execute new TransactionCallback SecurityGroupVO Override public SecurityGroupVO doInTransaction TransactionStatus status SecurityGroupVO group _securityGroupDao lockRow groupId true if group null throw new InvalidParameterValueException groupId if newName equals group getName s_logger debug groupId return group else if newName equalsIgnoreCase SecurityGroupManager DEFAULT_GROUP_NAME throw new InvalidParameterValueException SecurityGroupManager DEFAULT_GROUP_NAME if group getName equalsIgnoreCase SecurityGroupManager DEFAULT_GROUP_NAME throw new InvalidParameterValueException
_accountMgr checkAccess caller null true group return Transaction execute new TransactionCallbackWithException Boolean ResourceInUseException Override public Boolean doInTransaction TransactionStatus status throws ResourceInUseException SecurityGroupVO group _securityGroupDao lockRow groupId true if group null throw new InvalidParameterValueException groupId if group getName equalsIgnoreCase SecurityGroupManager DEFAULT_GROUP_NAME throw new InvalidParameterValueException List SecurityGroupRuleVO allowingRules _securityGroupRuleDao listByAllowedSecurityGroupId groupId List SecurityGroupVMMapVO securityGroupVmMap _securityGroupVMMapDao listBySecurityGroup groupId if allowingRules isEmpty throw new ResourceInUseException else if securityGroupVmMap isEmpty throw new ResourceInUseException _securityGroupDao expunge groupId
public void cleanupFinishedWork Date before new Date System currentTimeMillis 1000l int numDeleted _workDao deleteFinishedWork before if numDeleted
private void cleanupUnfinishedWork Date before new Date System currentTimeMillis _timeBetweenCleanups 1000l List SecurityGroupWorkVO unfinished _workDao findUnfinishedWork before if unfinished size
Account caller CallContext current getCallingAccount if secondaryIp null throw new InvalidParameterValueException NicVO nic _nicDao findById nicId long vmId nic getInstanceId UserVm vm _userVMDao findById vmId if vm null vm getType VirtualMachine Type User throw new InvalidParameterValueException _accountMgr checkAccess caller null false vm List SecurityGroupVO vmSgGrps getSecurityGroupsForVm vmId if vmSgGrps isEmpty s_logger debug return true Network network _networkModel getNetwork nic getNetworkId if _networkModel isSecurityGroupSupportedInNetwork network
Network network _networkModel getNetwork nic getNetworkId if _networkModel isSecurityGroupSupportedInNetwork network s_logger debug network return true String vmMac nic getMacAddress String vmName vm getInstanceName if vmMac null vmName null throw new InvalidParameterValueException NetworkRulesVmSecondaryIpCommand cmd new NetworkRulesVmSecondaryIpCommand vmName vmMac secondaryIp ruleAction s_logger debug Commands cmds null cmds new Commands cmd try _agentMgr send vm getHostId cmds catch AgentUnavailableException e
Set Long workItems new TreeSet Long workItems addAll affectedVms workItems removeAll _disabledVms if s_logger isDebugEnabled s_logger debug affectedVms size workItems size _workQueue size Profiler p new Profiler p start int updated if updateSeqno updated _rulesetLogDao createOrUpdate workItems if updated workItems size throw new CloudRuntimeException int newJobs _workQueue submitWorkForVms workItems _mBean logScheduledDetails workItems p stop
List SecurityGroupWork workItems try workItems _workQueue getWork for SecurityGroupWork work workItems if s_logger isTraceEnabled s_logger trace work getInstanceId try VmRulesetLogVO rulesetLog _rulesetLogDao findByVmId work getInstanceId if rulesetLog null s_logger warn work getInstanceId continue work setLogsequenceNumber rulesetLog getLogsequence sendRulesetUpdates work _mBean logUpdateDetails work getInstanceId work getLogsequenceNumber catch Exception e
s_logger trace userVmId vm getState Map PortAndProto Set String ingressRules generateRulesForVM userVmId SecurityRuleType IngressRule Map PortAndProto Set String egressRules generateRulesForVM userVmId SecurityRuleType EgressRule Long agentId vm getHostId if agentId null NicVO nic _nicDao findFirstNicForVM vm getId List String nicSecIps null if nic null if nic getSecondaryIp nicSecIps _nicSecIpDao getSecondaryIpAddressesForNic nic getId else return SecurityGroupRulesCmd cmd generateRulesetCmd vm getInstanceName nic getIPv4Address nic getIPv6Address vm getPrivateMacAddress vm getId null work getLogsequenceNumber ingressRules egressRules nicSecIps cmd setMsId _serverId if s_logger isDebugEnabled
List String nicSecIps null if nic null if nic getSecondaryIp nicSecIps _nicSecIpDao getSecondaryIpAddressesForNic nic getId else return SecurityGroupRulesCmd cmd generateRulesetCmd vm getInstanceName nic getIPv4Address nic getIPv6Address vm getPrivateMacAddress vm getId null work getLogsequenceNumber ingressRules egressRules nicSecIps cmd setMsId _serverId if s_logger isDebugEnabled s_logger debug vm getInstanceName cmd getIngressRuleSet size cmd getEgressRuleSet size cmd getTotalNumCidrs cmd getSignature Commands cmds new Commands cmd try _agentMgr send agentId cmds _answerListener if s_logger isTraceEnabled s_logger trace vm getInstanceName _workQueue size
DB private void revokeRule final NetworkACLItemVO rule if rule getState State Staged if s_logger isDebugEnabled
Override public boolean revokeACLItemsForNetwork final long networkId throws ResourceUnavailableException final Network network _networkDao findById networkId if network getNetworkACLId null return true final List NetworkACLItemVO aclItems _networkACLItemDao listByACL network getNetworkACLId if aclItems isEmpty s_logger debug networkId return true if s_logger isDebugEnabled s_logger debug aclItems size networkId for final NetworkACLItemVO aclItem aclItems if aclItem getState State Add aclItem getState State Active aclItem setState State Revoke final boolean success applyACLItemsToNetwork network getId aclItems if s_logger isDebugEnabled success
Override public boolean revokeACLItemsForPrivateGw final PrivateGateway gateway throws ResourceUnavailableException final long networkACLId gateway getNetworkACLId final List NetworkACLItemVO aclItems _networkACLItemDao listByACL networkACLId if aclItems isEmpty
final Network network _networkDao findById networkId boolean handled false boolean foundProvider false for final NetworkACLServiceProvider element _networkAclElements final Network Provider provider element getProvider final boolean isAclProvider _networkModel isProviderSupportServiceInNetwork network getId Service NetworkACL provider if isAclProvider continue foundProvider true s_logger debug network getId handled element applyNetworkACLs network rules if handled _messageBus publish _name PublishScope LOCAL network break if foundProvider
protected Long createAclListForNetworkAndReturnAclListId CreateNetworkACLCmd aclItemCmd Network network
protected void validateAclConsistency MoveNetworkAclItemCmd moveNetworkAclItemCmd NetworkACLVO lockedAcl List NetworkACLItemVO allAclRules if CollectionUtils isEmpty allAclRules
Override DB public boolean configure final String name final Map String Object params throws ConfigurationException Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status if _vpcOffDao findByUniqueName VpcOffering defaultVPCOfferingName null
if _vpcOffDao findByUniqueName VpcOffering defaultVPCOfferingName null s_logger debug VpcOffering defaultVPCOfferingName final Map Service Set Provider svcProviderMap new HashMap Service Set Provider final Set Provider defaultProviders new HashSet Provider defaultProviders add Provider VPCVirtualRouter for final Service svc getSupportedServices if svc Service Lb final Set Provider lbProviders new HashSet Provider lbProviders add Provider VPCVirtualRouter lbProviders add Provider InternalLbVm svcProviderMap put svc lbProviders else svcProviderMap put svc defaultProviders createVpcOffering VpcOffering defaultVPCOfferingName VpcOffering defaultVPCOfferingName svcProviderMap true State Enabled null false false false if _vpcOffDao findByUniqueName VpcOffering defaultVPCNSOfferingName null
createVpcOffering VpcOffering defaultVPCOfferingName VpcOffering defaultVPCOfferingName svcProviderMap true State Enabled null false false false if _vpcOffDao findByUniqueName VpcOffering defaultVPCNSOfferingName null s_logger debug VpcOffering defaultVPCNSOfferingName final Map Service Set Provider svcProviderMap new HashMap Service Set Provider final Set Provider defaultProviders new HashSet Provider defaultProviders add Provider VPCVirtualRouter for final Service svc getSupportedServices if svc Service Lb final Set Provider lbProviders new HashSet Provider lbProviders add Provider Netscaler lbProviders add Provider InternalLbVm svcProviderMap put svc lbProviders else svcProviderMap put svc defaultProviders createVpcOffering VpcOffering defaultVPCNSOfferingName VpcOffering defaultVPCNSOfferingName svcProviderMap false State Enabled null false false false
if _vpcOffDao update vpcOffId offering return null List VpcOfferingDetailsVO detailsVO new ArrayList if filteredDomainIds equals existingDomainIds filteredZoneIds equals existingZoneIds SearchBuilder VpcOfferingDetailsVO sb vpcOfferingDetailsDao createSearchBuilder sb and sb entity getResourceId SearchCriteria Op EQ sb and sb entity getName SearchCriteria Op EQ sb done SearchCriteria VpcOfferingDetailsVO sc sb create sc setParameters String valueOf vpcOffId if filteredDomainIds equals existingDomainIds sc setParameters ApiConstants DOMAIN_ID vpcOfferingDetailsDao remove sc for Long domainId filteredDomainIds detailsVO add new VpcOfferingDetailsVO vpcOffId ApiConstants DOMAIN_ID String valueOf domainId false
Override DB public boolean destroyVpc final Vpc vpc final Account caller final Long callerUserId throws ConcurrentOperationException ResourceUnavailableException
if vpc getState Vpc State Inactive s_logger debug vpc Vpc State Inactive final VpcVO vpcVO _vpcDao findById vpc getId vpcVO setState Vpc State Inactive Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status _vpcDao update vpc getId vpcVO _resourceLimitMgr decrementResourceCount vpc getAccountId ResourceType vpc if shutdownVpc vpc getId s_logger warn vpc return false if cleanupVpcResources vpc getId caller callerUserId s_logger warn vpc return false
final Account caller CallContext current getCallingAccount final VpcVO vpcToUpdate _vpcDao findById vpcId if vpcToUpdate null throw new InvalidParameterValueException vpcId _accountMgr checkAccess caller null false vpcToUpdate final VpcVO vpc _vpcDao createForUpdate vpcId if vpcName null vpc setName vpcName if displayText null vpc setDisplayText displayText if customId null vpc setUuid customId if displayVpc null vpc setDisplay displayVpc if _vpcDao update vpcId vpc
throw ex _accountMgr checkAccess caller null false vpc final DataCenter dc _entityMgr findById DataCenter class vpc getZoneId final DeployDestination dest new DeployDestination dc null null null final ReservationContext context new ReservationContextImpl null null callerUser _accountMgr getAccount vpc getAccountId boolean result true try if startVpc vpc dest context s_logger warn vpc result false catch final Exception ex s_logger warn vpc ex result false finally if result destroyOnFailure
protected boolean startVpc final Vpc vpc final DeployDestination dest final ReservationContext context throws ConcurrentOperationException ResourceUnavailableException InsufficientCapacityException boolean success true final List Provider providersToImplement getVpcProviders vpc getId for final VpcProvider element getVpcElements if providersToImplement contains element getProvider if element implementVpc vpc dest context
public boolean cleanupVpcResources final long vpcId final Account caller final long callerUserId throws ResourceUnavailableException ConcurrentOperationException
public boolean cleanupVpcResources final long vpcId final Account caller final long callerUserId throws ResourceUnavailableException ConcurrentOperationException s_logger debug vpcId boolean success true s_logger debug _s2sVpnMgr cleanupVpnConnectionByVpc vpcId s_logger debug _s2sVpnMgr cleanupVpnGatewayByVpc vpcId final List IPAddressVO ipsToRelease _ipAddressDao listByAssociatedVpc vpcId null
public boolean cleanupVpcResources final long vpcId final Account caller final long callerUserId throws ResourceUnavailableException ConcurrentOperationException s_logger debug vpcId boolean success true s_logger debug _s2sVpnMgr cleanupVpnConnectionByVpc vpcId s_logger debug _s2sVpnMgr cleanupVpnGatewayByVpc vpcId final List IPAddressVO ipsToRelease _ipAddressDao listByAssociatedVpc vpcId null s_logger debug vpcId for final IPAddressVO ipToRelease ipsToRelease if ipToRelease isPortable ipToRelease setVpcId null ipToRelease setAssociatedWithNetworkId null _ipAddressDao update ipToRelease getId ipToRelease
s_logger debug _s2sVpnMgr cleanupVpnGatewayByVpc vpcId final List IPAddressVO ipsToRelease _ipAddressDao listByAssociatedVpc vpcId null s_logger debug vpcId for final IPAddressVO ipToRelease ipsToRelease if ipToRelease isPortable ipToRelease setVpcId null ipToRelease setAssociatedWithNetworkId null _ipAddressDao update ipToRelease getId ipToRelease s_logger debug ipToRelease else success success _ipAddrMgr disassociatePublicIpAddress ipToRelease getId callerUserId caller if success s_logger warn ipToRelease vpcId if success
else success success _ipAddrMgr disassociatePublicIpAddress ipToRelease getId callerUserId caller if success s_logger warn ipToRelease vpcId if success s_logger debug vpcId else s_logger warn vpcId if revokeStaticRoutesForVpc vpcId caller s_logger warn vpcId return false final List PrivateGateway gateways getVpcPrivateGateways vpcId if gateways null for final PrivateGateway gateway gateways if gateway null
if success s_logger warn ipToRelease vpcId if success s_logger debug vpcId else s_logger warn vpcId if revokeStaticRoutesForVpc vpcId caller s_logger warn vpcId return false final List PrivateGateway gateways getVpcPrivateGateways vpcId if gateways null for final PrivateGateway gateway gateways if gateway null s_logger debug gateway vpcId if deleteVpcPrivateGateway gateway getId
if success s_logger debug vpcId else s_logger warn vpcId if revokeStaticRoutesForVpc vpcId caller s_logger warn vpcId return false final List PrivateGateway gateways getVpcPrivateGateways vpcId if gateways null for final PrivateGateway gateway gateways if gateway null s_logger debug gateway vpcId if deleteVpcPrivateGateway gateway getId success false s_logger debug gateway vpcId
boolean forceCleanup cleanUp if vpc isRedundant makeRedundant final VpcOfferingVO redundantOffering _vpcOffDao findByUniqueName VpcOffering redundantVPCOfferingName final VpcVO entity _vpcDao findById vpcId entity setRedundant true entity setVpcOfferingId redundantOffering getId if _vpcDao update vpc getId entity vpc entity forceCleanup true if forceCleanup if rollingRestartVpc vpc context s_logger warn vpc restartRequired true return false return true
if _vpcDao update vpc getId entity vpc entity forceCleanup true if forceCleanup if rollingRestartVpc vpc context s_logger warn vpc restartRequired true return false return true restartVPCNetworks vpcId callerAccount user cleanUp s_logger debug vpc if startVpc vpcId false s_logger warn vpc restartRequired true return false
forceCleanup true if forceCleanup if rollingRestartVpc vpc context s_logger warn vpc restartRequired true return false return true restartVPCNetworks vpcId callerAccount user cleanUp s_logger debug vpc if startVpc vpcId false s_logger warn vpc restartRequired true return false s_logger debug vpc return true
PhysicalNetwork physNet null if physicalNetworkId null final List extends PhysicalNetwork pNtwks _ntwkModel getPhysicalNtwksSupportingTrafficType vpc getZoneId TrafficType Guest if pNtwks isEmpty pNtwks size throw new InvalidParameterValueException physNet pNtwks get physicalNetworkId physNet getId if physNet null physNet _entityMgr findById PhysicalNetwork class physicalNetworkId final Long dcId physNet getDataCenterId final Long physicalNetworkIdFinal physicalNetworkId final PhysicalNetwork physNetFinal physNet VpcGatewayVO gatewayVO null try gatewayVO Transaction execute new TransactionCallbackWithException VpcGatewayVO Exception
physNet pNtwks get physicalNetworkId physNet getId if physNet null physNet _entityMgr findById PhysicalNetwork class physicalNetworkId final Long dcId physNet getDataCenterId final Long physicalNetworkIdFinal physicalNetworkId final PhysicalNetwork physNetFinal physNet VpcGatewayVO gatewayVO null try gatewayVO Transaction execute new TransactionCallbackWithException VpcGatewayVO Exception Override public VpcGatewayVO doInTransaction final TransactionStatus status throws ResourceAllocationException ConcurrentOperationException InsufficientCapacityException s_logger debug vpc Network privateNtwk null if BroadcastDomainType getSchemeValue BroadcastDomainType fromString broadcastUri BroadcastDomainType Lswitch final String cidr NetUtils ipAndNetMaskToCidr gateway netmask
physNet _entityMgr findById PhysicalNetwork class physicalNetworkId final Long dcId physNet getDataCenterId final Long physicalNetworkIdFinal physicalNetworkId final PhysicalNetwork physNetFinal physNet VpcGatewayVO gatewayVO null try gatewayVO Transaction execute new TransactionCallbackWithException VpcGatewayVO Exception Override public VpcGatewayVO doInTransaction final TransactionStatus status throws ResourceAllocationException ConcurrentOperationException InsufficientCapacityException s_logger debug vpc Network privateNtwk null if BroadcastDomainType getSchemeValue BroadcastDomainType fromString broadcastUri BroadcastDomainType Lswitch final String cidr NetUtils ipAndNetMaskToCidr gateway netmask privateNtwk _ntwkDao getPrivateNetwork broadcastUri cidr gatewayOwnerId dcId networkOfferingId vpcId if privateNtwk null s_logger info vpc broadcastUri
Override public VpcGatewayVO doInTransaction final TransactionStatus status throws ResourceAllocationException ConcurrentOperationException InsufficientCapacityException s_logger debug vpc Network privateNtwk null if BroadcastDomainType getSchemeValue BroadcastDomainType fromString broadcastUri BroadcastDomainType Lswitch final String cidr NetUtils ipAndNetMaskToCidr gateway netmask privateNtwk _ntwkDao getPrivateNetwork broadcastUri cidr gatewayOwnerId dcId networkOfferingId vpcId if privateNtwk null s_logger info vpc broadcastUri final String networkName vpc getName privateNtwk _ntwkSvc createPrivateNetwork networkName networkName physicalNetworkIdFinal broadcastUri ipAddress null gateway netmask gatewayOwnerId vpcId isSourceNat networkOfferingId bypassVlanOverlapCheck else s_logger info vpc broadcastUri final DataCenterVO dc _dcDao lockRow physNetFinal getDataCenterId true PrivateIpVO privateIp _privateIpDao findByIpAndSourceNetworkId privateNtwk getId ipAddress if privateIp null
Override ActionEvent eventType EventTypes EVENT_PRIVATE_GATEWAY_CREATE eventDescription async true public PrivateGateway applyVpcPrivateGateway final long gatewayId final boolean destroyOnFailure throws ConcurrentOperationException ResourceUnavailableException final VpcGatewayVO vo _vpcGatewayDao findById gatewayId boolean success true try final List Provider providersToImplement getVpcProviders vo getVpcId final PrivateGateway gateway getVpcPrivateGateway gatewayId for final VpcProvider provider getVpcElements if providersToImplement contains provider getProvider if provider createPrivateGateway gateway success false if success s_logger debug gateway if vo getState VpcGateway State Ready vo setState VpcGateway State Ready _vpcGatewayDao update vo getId vo
success false if success s_logger debug gateway if vo getState VpcGateway State Ready vo setState VpcGateway State Ready _vpcGatewayDao update vo getId vo s_logger debug gateway VpcGateway State Ready CallContext current setEventDetails gatewayId return getVpcPrivateGateway gatewayId else s_logger warn gateway return null finally if success if destroyOnFailure
Override ActionEvent eventType EventTypes EVENT_PRIVATE_GATEWAY_DELETE eventDescription DB public boolean deleteVpcPrivateGateway final long gatewayId throws ConcurrentOperationException ResourceUnavailableException final VpcGatewayVO gatewayToBeDeleted _vpcGatewayDao findById gatewayId if gatewayToBeDeleted null
final VpcGatewayVO gatewayToBeDeleted _vpcGatewayDao findById gatewayId if gatewayToBeDeleted null s_logger debug gatewayId return true final VpcGatewayVO gatewayVO _vpcGatewayDao acquireInLockTable gatewayId if gatewayVO null gatewayVO getType VpcGateway Type Private throw new ConcurrentOperationException gatewayId try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final long routeCount _staticRouteDao countRoutesByGateway gatewayVO getId if routeCount throw new CloudRuntimeException gatewayVO routeCount gatewayVO setState VpcGateway State Deleting _vpcGatewayDao update gatewayVO getId gatewayVO
throw new ConcurrentOperationException gatewayId try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final long routeCount _staticRouteDao countRoutesByGateway gatewayVO getId if routeCount throw new CloudRuntimeException gatewayVO routeCount gatewayVO setState VpcGateway State Deleting _vpcGatewayDao update gatewayVO getId gatewayVO s_logger debug gatewayVO VpcGateway State Deleting final List Provider providersToImplement getVpcProviders gatewayVO getVpcId final PrivateGateway gateway getVpcPrivateGateway gatewayId for final VpcProvider provider getVpcElements if providersToImplement contains provider getProvider
final long routeCount _staticRouteDao countRoutesByGateway gatewayVO getId if routeCount throw new CloudRuntimeException gatewayVO routeCount gatewayVO setState VpcGateway State Deleting _vpcGatewayDao update gatewayVO getId gatewayVO s_logger debug gatewayVO VpcGateway State Deleting final List Provider providersToImplement getVpcProviders gatewayVO getVpcId final PrivateGateway gateway getVpcPrivateGateway gatewayId for final VpcProvider provider getVpcElements if providersToImplement contains provider getProvider if provider deletePrivateGateway gateway s_logger debug gateway else s_logger warn gateway
DB protected boolean deletePrivateGatewayFromTheDB final PrivateGateway gateway final long networkId gateway getNetworkId vpcTxCallable setGateway gateway final ExecutorService txExecutor Executors newSingleThreadExecutor final Future Boolean futureResult txExecutor submit vpcTxCallable boolean deleteNetworkFinal try deleteNetworkFinal futureResult get if deleteNetworkFinal final User callerUser _accountMgr getActiveUser CallContext current getCallingUserId final Account owner _accountMgr getAccount Account ACCOUNT_ID_SYSTEM final ReservationContext context new ReservationContextImpl null null callerUser owner _ntwkMgr destroyNetwork networkId context false
DB protected boolean deletePrivateGatewayFromTheDB final PrivateGateway gateway final long networkId gateway getNetworkId vpcTxCallable setGateway gateway final ExecutorService txExecutor Executors newSingleThreadExecutor final Future Boolean futureResult txExecutor submit vpcTxCallable boolean deleteNetworkFinal try deleteNetworkFinal futureResult get if deleteNetworkFinal final User callerUser _accountMgr getActiveUser CallContext current getCallingUserId final Account owner _accountMgr getAccount Account ACCOUNT_ID_SYSTEM final ReservationContext context new ReservationContextImpl null null callerUser owner _ntwkMgr destroyNetwork networkId context false s_logger debug networkId catch final InterruptedException e
vpcTxCallable setGateway gateway final ExecutorService txExecutor Executors newSingleThreadExecutor final Future Boolean futureResult txExecutor submit vpcTxCallable boolean deleteNetworkFinal try deleteNetworkFinal futureResult get if deleteNetworkFinal final User callerUser _accountMgr getActiveUser CallContext current getCallingUserId final Account owner _accountMgr getAccount Account ACCOUNT_ID_SYSTEM final ReservationContext context new ReservationContextImpl null null callerUser owner _ntwkMgr destroyNetwork networkId context false s_logger debug networkId catch final InterruptedException e s_logger error networkId e catch final ExecutionException e
final Map Long VpcGateway gatewayMap new HashMap Long VpcGateway for final StaticRoute route routes VpcGateway gateway gatewayMap get route getVpcGatewayId if gateway null gateway _vpcGatewayDao findById route getVpcGatewayId gatewayMap put gateway getId gateway staticRouteProfiles add new StaticRouteProfile route gateway if applyStaticRoutes staticRouteProfiles s_logger warn return false else if updateRoutesInDB for final StaticRoute route routes if route getState StaticRoute State Revoke _staticRouteDao remove route getId
gatewayMap put gateway getId gateway staticRouteProfiles add new StaticRouteProfile route gateway if applyStaticRoutes staticRouteProfiles s_logger warn return false else if updateRoutesInDB for final StaticRoute route routes if route getState StaticRoute State Revoke _staticRouteDao remove route getId s_logger debug route else if route getState StaticRoute State Add final StaticRouteVO ruleVO _staticRouteDao findById route getId ruleVO setState StaticRoute State Active _staticRouteDao update ruleVO getId ruleVO
DB protected boolean revokeStaticRoutesForVpc final long vpcId final Account caller throws ResourceUnavailableException final List StaticRouteVO routes _staticRouteDao listByVpcId vpcId
protected void markStaticRouteForRevoke final StaticRouteVO route final Account caller
s_logger debug ipId return null final Vpc vpc _vpcDao findById vpcId if vpc null throw new InvalidParameterValueException _accountMgr checkAccess caller null true owner vpc s_logger debug ipToAssoc vpc final boolean isSourceNatFinal isSrcNatIpRequired vpc getVpcOfferingId getExistingSourceNatInVpc owner getId vpcId null Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final IPAddressVO ip _ipAddressDao findById ipId ip setVpcId vpcId ip setSourceNat isSourceNatFinal _ipAddressDao update ipId ip _ipAddrMgr markPublicIpAsAllocated ip
final IPAddressVO ip _ipAddressDao findById ipId if isIpAllocatedToVpc ip return if ip null ip getVpcId null return s_logger debug ip networkId final long vpcId ip getVpcId boolean success false try success _ipAddrMgr applyIpAssociations _ntwkModel getNetwork networkId true catch final ResourceUnavailableException ex throw new CloudRuntimeException networkId ipId ex if success ip setAssociatedWithNetworkId null _ipAddressDao update ipId ip
if ip null ip getVpcId null return s_logger debug ip networkId final long vpcId ip getVpcId boolean success false try success _ipAddrMgr applyIpAssociations _ntwkModel getNetwork networkId true catch final ResourceUnavailableException ex throw new CloudRuntimeException networkId ipId ex if success ip setAssociatedWithNetworkId null _ipAddressDao update ipId ip s_logger debug ip vpcId else throw new CloudRuntimeException networkId ipId
s_logger debug vpc _ntwkMgr destroyExpendableRouters _routerDao listByVpcId vpc getId context final DeployDestination dest new DeployDestination _dcDao findById vpc getZoneId null null null final List DomainRouterVO oldRouters _routerDao listByVpcId vpc getId if oldRouters size vpc setRollingRestart true startVpc vpc dest context if oldRouters size vpc setRollingRestart false if vpc isRedundant oldRouters size oldRouters get getIsRedundantRouter try Thread sleep NetworkOrchestrationService RVRHandoverTime catch final InterruptedException ignored for final DomainRouterVO oldRouter oldRouters _routerService stopRouter oldRouter getId true
Override public Boolean call throws Exception final long networkId gateway getNetworkId Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final List PrivateIpVO privateIps _privateIpDao listByNetworkId networkId if privateIps size privateIps get getIpAddress equalsIgnoreCase gateway getIp4Address
Override DB ActionEvent eventType EventTypes EVENT_REMOTE_ACCESS_VPN_DESTROY eventDescription async true public boolean destroyRemoteAccessVpnForIp long ipId Account caller final boolean forceCleanup throws ResourceUnavailableException final RemoteAccessVpnVO vpn _remoteAccessVpnDao findByPublicIpAddress ipId if vpn null
s_logger debug ipId return true _accountMgr checkAccess caller AccessType OperateEntry true vpn RemoteAccessVpn State prevState vpn getState vpn setState RemoteAccessVpn State Removed _remoteAccessVpnDao update vpn getId vpn boolean success false try for RemoteAccessVPNServiceProvider element _vpnServiceProviders if element stopVpn vpn success true break catch ResourceUnavailableException ex vpn setState prevState _remoteAccessVpnDao update vpn getId vpn
catch ResourceUnavailableException ex vpn setState prevState _remoteAccessVpnDao update vpn getId vpn s_logger debug vpn getId RemoteAccessVpn State Running success false finally if success forceCleanup final List extends FirewallRule vpnFwRules _rulesDao listByIpAndPurpose ipId Purpose Vpn boolean applyFirewall false final List FirewallRuleVO fwRules new ArrayList FirewallRuleVO if vpnFwRules size _rulesDao findByRelatedId vpnFwRules get getId null applyFirewall true if applyFirewall Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status
vpn setState prevState _remoteAccessVpnDao update vpn getId vpn s_logger debug vpn getId RemoteAccessVpn State Running success false finally if success forceCleanup final List extends FirewallRule vpnFwRules _rulesDao listByIpAndPurpose ipId Purpose Vpn boolean applyFirewall false final List FirewallRuleVO fwRules new ArrayList FirewallRuleVO if vpnFwRules size _rulesDao findByRelatedId vpnFwRules get getId null applyFirewall true if applyFirewall Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status for FirewallRule vpnFwRule vpnFwRules
Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status for FirewallRule vpnFwRule vpnFwRules _firewallMgr revokeRelatedFirewallRule vpnFwRule getId false fwRules add _rulesDao findByRelatedId vpnFwRule getId s_logger debug fwRules size s_logger debug ipId success _firewallMgr applyIngressFirewallRules ipId caller if success forceCleanup try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status _remoteAccessVpnDao remove vpn getId List VpnUserVO vpnUsers _vpnUsersDao listByAccount vpn getAccountId
DB Override public boolean applyVpnUsers long vpnOwnerId String userName throws ResourceUnavailableException Account caller CallContext current getCallingAccount Account owner _accountDao findById vpnOwnerId _accountMgr checkAccess caller null true owner
DB Override public boolean applyVpnUsers long vpnOwnerId String userName throws ResourceUnavailableException Account caller CallContext current getCallingAccount Account owner _accountDao findById vpnOwnerId _accountMgr checkAccess caller null true owner s_logger debug owner List RemoteAccessVpnVO vpns _remoteAccessVpnDao findByAccount vpnOwnerId if CollectionUtils isEmpty vpns
_accountMgr checkAccess caller null true owner s_logger debug owner List RemoteAccessVpnVO vpns _remoteAccessVpnDao findByAccount vpnOwnerId if CollectionUtils isEmpty vpns s_logger debug owner return false RemoteAccessVpnVO vpnTemp null List VpnUserVO users _vpnUsersDao listByAccount vpnOwnerId for VpnUserVO user users if user getState State Active user setState State Add _vpnUsersDao update user getId user boolean success true Boolean finals new Boolean users size for RemoteAccessVPNServiceProvider element _vpnServiceProviders
user setState State Add _vpnUsersDao update user getId user boolean success true Boolean finals new Boolean users size for RemoteAccessVPNServiceProvider element _vpnServiceProviders s_logger debug element getName for RemoteAccessVpnVO vpn vpns try String results element applyVpnUsers vpn users if results null int indexUser for int i i results length i indexUser if indexUser users size indexUser
DB Override public boolean deleteProject Account caller long callerUserId final ProjectVO project boolean updateResult Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status
DB private boolean cleanupProject final Project project AccountVO caller Long callerUserId boolean result true AccountVO account _accountDao findById project getProjectAccountId
DB private boolean cleanupProject final Project project AccountVO caller Long callerUserId boolean result true AccountVO account _accountDao findById project getProjectAccountId s_logger debug project account getId result result _accountMgr deleteAccount account callerUserId caller if result result Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean result true
s_logger debug project account getId result result _accountMgr deleteAccount account callerUserId caller if result result Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean result true s_logger debug project List extends ProjectAccount projectAccounts _projectAccountDao listByProjectId project getId for ProjectAccount projectAccount projectAccounts result result unassignAccountFromProject projectAccount getProjectId projectAccount getAccountId s_logger debug project _projectInvitationDao cleanupInvitations project getId return result if result
Override public boolean unassignAccountFromProject long projectId long accountId ProjectAccountVO projectAccount _projectAccountDao findByProjectIdAccountId projectId accountId if projectAccount null
Override DB public boolean deleteAccountFromProject final long projectId final long accountId return Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean success true ProjectAccountVO projectAccount _projectAccountDao findByProjectIdAccountId projectId accountId success _projectAccountDao remove projectAccount getId if success
if project getState State Active InvalidParameterValueException ex new InvalidParameterValueException project getState ex addProxyObject project getUuid throw ex User user userDao getUserByName username project getDomainId if user null InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject String valueOf username throw ex CallContext current setProject project _accountMgr checkAccess caller AccessType ModifyProject true _accountMgr getAccount project getProjectAccountId Account userAccount _accountDao findById user getAccountId if _projectAccountDao findByProjectIdAccountId projectId userAccount getAccountId null throw new InvalidParameterValueException userAccount getAccountId ProjectAccount projectAccountUser _projectAccountDao findByProjectIdUserId projectId user getAccountId user getId
final ProjectVO project getProject projectId if project null throw new InvalidParameterValueException projectId _accountMgr checkAccess caller AccessType ModifyProject true _accountMgr getAccount project getProjectAccountId Transaction execute new TransactionCallbackWithExceptionNoReturn ResourceAllocationException Override public void doInTransactionWithoutResult TransactionStatus status throws ResourceAllocationException if displayText null project setDisplayText displayText _projectDao update projectId project if newOwnerName null Account futureOwnerAccount _accountMgr getActiveAccountByName newOwnerName project getDomainId if futureOwnerAccount null throw new InvalidParameterValueException newOwnerName project getDomainId Account currentOwnerAccount getProjectOwner projectId if currentOwnerAccount null
throw ex Account account null if accountName null account _accountMgr getActiveAccountByName accountName project getDomainId if account null InvalidParameterValueException ex new InvalidParameterValueException accountName DomainVO domain ApiDBUtils findDomainById project getDomainId String domainUuid String valueOf project getDomainId if domain null domainUuid domain getUuid ex addProxyObject domainUuid throw ex CallContext current setProject project _accountMgr checkAccess caller AccessType ModifyProject true _accountMgr getAccount project getProjectAccountId ProjectAccount projectAccount _projectAccountDao findByProjectIdAccountId projectId account getId
private void deletePendingInvite Long projectId User user ProjectInvitation invite _projectInvitationDao findByUserIdProjectId user getId user getAccountId projectId if invite null boolean success _projectInvitationDao remove invite getId if success
DB private boolean deleteUserFromProject Long projectId User user return Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean success true ProjectAccountVO projectAccount _projectAccountDao findByProjectIdUserId projectId user getAccountId user getId success _projectAccountDao remove projectAccount getId if success
Override public Boolean doInTransaction TransactionStatus status ProjectInvitationVO invite null if accountId null invite _projectInvitationDao findByAccountIdProjectId accountId project getId else if userId null invite _projectInvitationDao findByUserIdProjectId userId accountId project getId else if email null invite _projectInvitationDao findByEmailAndProjectId email project getId if invite null if invite getState ProjectInvitation State Completed invite getState ProjectInvitation State Pending _projectInvitationDao isActive invite getId _invitationTimeOut return true else if invite getState ProjectInvitation State Pending expireInvitation invite if accountId null
if accountId null invite _projectInvitationDao findByAccountIdProjectId accountId project getId else if userId null invite _projectInvitationDao findByUserIdProjectId userId accountId project getId else if email null invite _projectInvitationDao findByEmailAndProjectId email project getId if invite null if invite getState ProjectInvitation State Completed invite getState ProjectInvitation State Pending _projectInvitationDao isActive invite getId _invitationTimeOut return true else if invite getState ProjectInvitation State Pending expireInvitation invite if accountId null s_logger debug invite getState accountId project else if userId null
else if userId null invite _projectInvitationDao findByUserIdProjectId userId accountId project getId else if email null invite _projectInvitationDao findByEmailAndProjectId email project getId if invite null if invite getState ProjectInvitation State Completed invite getState ProjectInvitation State Pending _projectInvitationDao isActive invite getId _invitationTimeOut return true else if invite getState ProjectInvitation State Pending expireInvitation invite if accountId null s_logger debug invite getState accountId project else if userId null s_logger debug invite getState userId project else if email null
private boolean expireInvitation ProjectInvitationVO invite
ProjectInvitationVO invite null if token null if accountName null invite _projectInvitationDao findByAccountIdProjectId accountId projectId ProjectInvitation State Pending else invite _projectInvitationDao findByUserIdProjectId user getId user getAccountId projectId ProjectInvitation State Pending else invite _projectInvitationDao findPendingByTokenAndProjectId token projectId ProjectInvitation State Pending if invite null if _projectInvitationDao isActive invite getId _invitationTimeOut accept expireInvitation invite throw new InvalidParameterValueException accountName projectId else final ProjectInvitationVO inviteFinal invite final Long accountIdFinal accountId
else invite _projectInvitationDao findPendingByTokenAndProjectId token projectId ProjectInvitation State Pending if invite null if _projectInvitationDao isActive invite getId _invitationTimeOut accept expireInvitation invite throw new InvalidParameterValueException accountName projectId else final ProjectInvitationVO inviteFinal invite final Long accountIdFinal accountId final String accountNameFinal accountName final User finalUser user ProjectInvitationVO finalInvite invite result Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean result true
if _projectInvitationDao isActive invite getId _invitationTimeOut accept expireInvitation invite throw new InvalidParameterValueException accountName projectId else final ProjectInvitationVO inviteFinal invite final Long accountIdFinal accountId final String accountNameFinal accountName final User finalUser user ProjectInvitationVO finalInvite invite result Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean result true ProjectInvitation State newState accept ProjectInvitation State Completed ProjectInvitation State Declined s_logger debug inviteFinal newState inviteFinal setState newState
private boolean suspendProject ProjectVO project throws ConcurrentOperationException ResourceUnavailableException
else if event equals ResourceListener EVENT_DELETE_HOST_AFTER l processDeletHostEventAfter HostVO params eventName else if event equals ResourceListener EVENT_CANCEL_MAINTENANCE_BEFORE l processCancelMaintenaceEventBefore Long params eventName else if event equals ResourceListener EVENT_CANCEL_MAINTENANCE_AFTER l processCancelMaintenaceEventAfter Long params eventName else if event equals ResourceListener EVENT_PREPARE_MAINTENANCE_BEFORE l processPrepareMaintenaceEventBefore Long params eventName else if event equals ResourceListener EVENT_PREPARE_MAINTENANCE_AFTER l processPrepareMaintenaceEventAfter Long params eventName
throw ex final HostPodVO pod _podDao findById podId if pod null throw new InvalidParameterValueException podId if _podDao findById podId null throw new InvalidParameterValueException podId if Long valueOf pod getDataCenterId equals dcId final InvalidParameterValueException ex new InvalidParameterValueException dcId ex addProxyObject pod getUuid ex addProxyObject zone getUuid throw ex if clusterName null clusterName isEmpty throw new InvalidParameterValueException if cmd getHypervisor null cmd getHypervisor isEmpty throw new InvalidParameterValueException
Override public void doInTransactionWithoutResult final TransactionStatus status _dcDao releasePrivateIpAddress host getPrivateIpAddress host getDataCenterId null _agentMgr disconnectWithoutInvestigation hostId Status Event Remove _hostDetailsDao deleteDetails hostId _hostGpuGroupsDao deleteGpuEntries hostId _hostTagsDao deleteTags hostId host setGuid null final Long clusterId host getClusterId host setClusterId null _hostDao update host getId host _hostDao remove hostId if clusterId null final List HostVO hosts listAllHostsInCluster clusterId if hosts size final ClusterVO cluster _clusterDao findById clusterId
cluster setGuid null _clusterDao update clusterId cluster try resourceStateTransitTo host ResourceState Event DeleteHost _nodeId catch final NoTransitionException e s_logger debug host getId e _storagePoolHostDao deletePrimaryRecordsForHost hostId final List VMInstanceVO vms _vmDao listByHostId hostId for final VMInstanceVO vm vms vm setState State Stopped vm setHostId null _vmDao persist vm for final StoragePoolHostVO pool pools final Long poolId pool getPoolId final StoragePoolVO storagePool _storagePoolDao findById poolId
Override DB public boolean deleteCluster final DeleteClusterCmd cmd try Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status final ClusterVO cluster _clusterDao lockRow cmd getId true if cluster null if s_logger isDebugEnabled
Override public void doInTransactionWithoutResult final TransactionStatus status final ClusterVO cluster _clusterDao lockRow cmd getId true if cluster null if s_logger isDebugEnabled s_logger debug cmd getId throw new CloudRuntimeException cmd getId final Hypervisor HypervisorType hypervisorType cluster getHypervisorType final List HostVO hosts listAllHostsInCluster cmd getId if hosts size if s_logger isDebugEnabled s_logger debug cmd getId throw new CloudRuntimeException cmd getId final List StoragePoolVO storagePools _storagePoolDao listPoolsByCluster cmd getId if storagePools size if s_logger isDebugEnabled
throw new CloudRuntimeException cmd getId final List StoragePoolVO storagePools _storagePoolDao listPoolsByCluster cmd getId if storagePools size if s_logger isDebugEnabled s_logger debug cmd getId throw new CloudRuntimeException cmd getId if _clusterDao remove cmd getId _capacityDao removeBy null null null cluster getId null if hypervisorType HypervisorType VMware Boolean parseBoolean _configDao getValue Config VmwareUseNexusVSwitch toString _clusterVSMMapDao removeByClusterId cmd getId final DedicatedResourceVO dr _dedicatedDao findByClusterId cluster getId if dr null _dedicatedDao remove dr getId return true
String clusterType cmd getClusterType String hypervisor cmd getHypervisor String allocationState cmd getAllocationState String managedstate cmd getManagedstate String name cmd getClusterName boolean doUpdate false if org apache commons lang StringUtils isNotBlank name if cluster getHypervisorType HypervisorType VMware throw new InvalidParameterValueException s_logger debug name cluster setName name doUpdate true if hypervisor null hypervisor isEmpty final Hypervisor HypervisorType hypervisorType Hypervisor HypervisorType getType hypervisor if hypervisorType null
doUpdate true if hypervisor null hypervisor isEmpty final Hypervisor HypervisorType hypervisorType Hypervisor HypervisorType getType hypervisor if hypervisorType null s_logger error hypervisor throw new InvalidParameterValueException hypervisor else cluster setHypervisorType hypervisor doUpdate true Cluster ClusterType newClusterType null if clusterType null clusterType isEmpty try newClusterType Cluster ClusterType valueOf clusterType catch final IllegalArgumentException ex throw new InvalidParameterValueException clusterType
Cluster ClusterType newClusterType null if clusterType null clusterType isEmpty try newClusterType Cluster ClusterType valueOf clusterType catch final IllegalArgumentException ex throw new InvalidParameterValueException clusterType if newClusterType null s_logger error clusterType throw new InvalidParameterValueException clusterType else cluster setClusterType newClusterType doUpdate true Grouping AllocationState newAllocationState null if allocationState null allocationState isEmpty try
private boolean doMaintain final long hostId final HostVO host _hostDao findById hostId
catch final NoTransitionException e final String err host getId ResourceState Maintenance s_logger debug err e throw new CloudRuntimeException err e getMessage ActionEventUtils onStartedActionEvent CallContext current getCallingUserId CallContext current getCallingAccountId EventTypes EVENT_MAINTENANCE_PREPARE hostId true _agentMgr pullAgentToMaintenance hostId if host getType Host Type Routing final List VMInstanceVO vms _vmDao listByHostId hostId if vms size return true final List HostVO hosts listAllUpAndEnabledHosts Host Type Routing host getClusterId host getPodId host getDataCenterId for final VMInstanceVO vm vms if hosts null hosts isEmpty answer getMigrate _serviceOfferingDetailsDao findDetail vm getServiceOfferingId GPU Keys vgpuType toString null s_logger error _haMgr scheduleStop vm hostId WorkType ForceStop
Override public Host maintain final PrepareForMaintenanceCmd cmd final Long hostId cmd getId final HostVO host _hostDao findById hostId if host null
protected boolean setHostIntoMaintenance HostVO host throws NoTransitionException
protected boolean setHostIntoErrorInMaintenance HostVO host List VMInstanceVO errorVms throws NoTransitionException
protected boolean setHostIntoErrorInPrepareForMaintenance HostVO host List VMInstanceVO errorVms throws NoTransitionException
protected boolean setHostIntoPrepareForMaintenanceAfterErrorsFixed HostVO host throws NoTransitionException
protected boolean attemptMaintain HostVO host throws NoTransitionException final long hostId host getId
protected boolean attemptMaintain HostVO host throws NoTransitionException final long hostId host getId s_logger info host getName final List VMInstanceVO allVmsOnHost _vmDao listByHostId hostId final boolean hasMigratingAwayVms CollectionUtils isNotEmpty _vmDao listVmsMigratingFromHost hostId boolean hasPendingMigrationRetries false for VMInstanceVO vmInstanceVO allVmsOnHost if _haMgr hasPendingMigrationsWork vmInstanceVO getId
private Object dispatchToStateAdapters final ResourceStateAdapter Event event final boolean singleTaker final Object args synchronized _resourceStateAdapters final Iterator Map Entry String ResourceStateAdapter it _resourceStateAdapters entrySet iterator Object result null while it hasNext final Map Entry String ResourceStateAdapter item it next final ResourceStateAdapter adapter item getValue final String msg event item getKey
s_logger debug msg if event ResourceStateAdapter Event CREATE_HOST_VO_FOR_CONNECTED result adapter createHostVOForConnectedAgent HostVO args StartupCommand args if result null singleTaker break else if event ResourceStateAdapter Event CREATE_HOST_VO_FOR_DIRECT_CONNECT result adapter createHostVOForDirectConnectAgent HostVO args StartupCommand args ServerResource args Map String String args List String args if result null singleTaker break else if event ResourceStateAdapter Event DELETE_HOST try result adapter deleteHost HostVO args Boolean args Boolean args if result null break catch final UnableDeleteHostException e
String pod startup getPod final String cluster startup getCluster if pod null dataCenter null pod equalsIgnoreCase dataCenter equalsIgnoreCase final List HostPodVO pods _podDao listAllIncludingRemoved for final HostPodVO hpv pods if checkCIDR hpv startup getPrivateIpAddress startup getPrivateNetmask pod hpv getName dataCenter _dcDao findById hpv getDataCenterId getName break long dcId DataCenterVO dc _dcDao findByName dataCenter if dc null try dcId Long parseLong dataCenter dc _dcDao findById dcId
long dcId DataCenterVO dc _dcDao findByName dataCenter if dc null try dcId Long parseLong dataCenter dc _dcDao findById dcId catch final NumberFormatException e s_logger debug dataCenter if dc null throw new IllegalArgumentException startup getPrivateIpAddress dataCenter dcId dc getId HostPodVO p _podDao findByName pod dcId if p null try final long podId Long parseLong pod
host setPrivateIpAddress startup getPrivateIpAddress host setPrivateNetmask startup getPrivateNetmask host setPrivateMacAddress startup getPrivateMacAddress host setPublicIpAddress startup getPublicIpAddress host setPublicMacAddress startup getPublicMacAddress host setPublicNetmask startup getPublicNetmask host setStorageIpAddress startup getStorageIpAddress host setStorageMacAddress startup getStorageMacAddress host setStorageNetmask startup getStorageNetmask host setVersion startup getVersion host setName startup getName host setManagementServerId _nodeId host setStorageUrl startup getIqn host setLastPinged System currentTimeMillis host setHostTags hostTags
host setPublicNetmask startup getPublicNetmask host setStorageIpAddress startup getStorageIpAddress host setStorageMacAddress startup getStorageMacAddress host setStorageNetmask startup getStorageNetmask host setVersion startup getVersion host setName startup getName host setManagementServerId _nodeId host setStorageUrl startup getIqn host setLastPinged System currentTimeMillis host setHostTags hostTags host setDetails details if startup getStorageIpAddressDeux null host setStorageIpAddressDeux startup getStorageIpAddressDeux host setStorageMacAddressDeux startup getStorageMacAddressDeux host setStorageNetmaskDeux startup getStorageNetmaskDeux
if cmds null s_logger info return null if this getClass getPackage getImplementationVersion null for final StartupCommand cmd cmds if cmd getVersion null cmd setVersion Long toString System currentTimeMillis if s_logger isDebugEnabled new Request 1l 1l cmds true false logD true if old final StartupCommand firstCmd cmds host findHostByGuid firstCmd getGuid if host null host findHostByGuid firstCmd getGuidWithoutResource if host null host getRemoved null
if cmds null s_logger info return null if this getClass getPackage getImplementationVersion null for final StartupCommand cmd cmds if cmd getVersion null cmd setVersion Long toString System currentTimeMillis if s_logger isDebugEnabled new Request 1l 1l cmds true false logD true if old final StartupCommand firstCmd cmds host findHostByGuid firstCmd getGuid if host null host findHostByGuid firstCmd getGuidWithoutResource if host null host getRemoved null
Override public HostVO fillRoutingHostVO final HostVO host final StartupRoutingCommand ssCmd final HypervisorType hyType Map String String details final List String hostTags if host getPodId null
Override public void deleteRoutingHost final HostVO host final boolean isForced final boolean forceDestroyStorage throws UnableDeleteHostException if host getType Host Type Routing throw new CloudRuntimeException host getId if s_logger isDebugEnabled s_logger debug host getId host getGuid if forceDestroyStorage final StoragePoolVO storagePool _storageMgr findLocalStorageOnHost host getId if storagePool null if storagePool getStatus StoragePoolStatus Up storagePool getStatus StoragePoolStatus ErrorInMaintenance try final StoragePool pool _storageSvr preparePrimaryStorageForMaintenance storagePool getId if pool null s_logger debug throw new UnableDeleteHostException catch final Exception e
final StoragePoolVO storagePool _storageMgr findLocalStorageOnHost host getId if storagePool null if storagePool getStatus StoragePoolStatus Up storagePool getStatus StoragePoolStatus ErrorInMaintenance try final StoragePool pool _storageSvr preparePrimaryStorageForMaintenance storagePool getId if pool null s_logger debug throw new UnableDeleteHostException catch final Exception e s_logger debug e toString throw new UnableDeleteHostException e toString final List VMInstanceVO vmsOnLocalStorage _storageMgr listByStoragePool storagePool getId for final VMInstanceVO vm vmsOnLocalStorage try _vmMgr destroy vm getUuid false
catch final Exception e s_logger debug e toString throw new UnableDeleteHostException e toString final List VMInstanceVO vmsOnLocalStorage _storageMgr listByStoragePool storagePool getId for final VMInstanceVO vm vmsOnLocalStorage try _vmMgr destroy vm getUuid false catch final Exception e final String errorMsg vm host getId s_logger debug errorMsg e throw new UnableDeleteHostException errorMsg e getMessage else final List VMInstanceVO vms _vmDao listByHostId host getId if vms isEmpty if isForced
final List VMInstanceVO vmsOnLocalStorage _storageMgr listByStoragePool storagePool getId for final VMInstanceVO vm vmsOnLocalStorage try _vmMgr destroy vm getUuid false catch final Exception e final String errorMsg vm host getId s_logger debug errorMsg e throw new UnableDeleteHostException errorMsg e getMessage else final List VMInstanceVO vms _vmDao listByHostId host getId if vms isEmpty if isForced for final VMInstanceVO vm vms if vm isHaEnabled vm getState State Stopping s_logger debug vm host getId
for final VMInstanceVO vm vmsOnLocalStorage try _vmMgr destroy vm getUuid false catch final Exception e final String errorMsg vm host getId s_logger debug errorMsg e throw new UnableDeleteHostException errorMsg e getMessage else final List VMInstanceVO vms _vmDao listByHostId host getId if vms isEmpty if isForced for final VMInstanceVO vm vms if vm isHaEnabled vm getState State Stopping s_logger debug vm host getId try
return true if ResourceState isMaintenanceState host getResourceState throw new CloudRuntimeException host getResourceState hostId _haMgr cancelScheduledMigrations host boolean vms_migrating false final List VMInstanceVO vms _haMgr findTakenMigrationWork for final VMInstanceVO vm vms if vm getHostId null vm getHostId hostId s_logger warn vm hostId vms_migrating true handleAgentIfNotConnected host vms_migrating try resourceStateTransitTo host ResourceState Event AdminCancelMaintenance _nodeId _agentMgr pullAgentOutMaintenance hostId catch final NoTransitionException e
private boolean doUmanageHost final long hostId final HostVO host _hostDao findById hostId if host null
Override public boolean migrateAwayFailed final long hostId final long vmId final HostVO host _hostDao findById hostId if host null if s_logger isDebugEnabled
Override public GPUDeviceTO getGPUDevice final long hostId final String groupName final String vgpuType final List HostGpuGroupsVO gpuDeviceList listAvailableGPUDevice hostId groupName vgpuType if CollectionUtils isEmpty gpuDeviceList final String errorMsg hostId groupName vgpuType
Override DB ActionEvent eventType EventTypes EVENT_HOST_RESERVATION_RELEASE eventDescription async true public boolean releaseHostReservation final Long hostId try return Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction final TransactionStatus status final PlannerHostReservationVO reservationEntry _plannerHostReserveDao findByHostId hostId if reservationEntry null final long id reservationEntry getId final PlannerHostReservationVO hostReservation _plannerHostReserveDao lockRow id true if hostReservation null if s_logger isDebugEnabled
try return Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction final TransactionStatus status final PlannerHostReservationVO reservationEntry _plannerHostReserveDao findByHostId hostId if reservationEntry null final long id reservationEntry getId final PlannerHostReservationVO hostReservation _plannerHostReserveDao lockRow id true if hostReservation null if s_logger isDebugEnabled s_logger debug hostId return false hostReservation setResourceUsage null _plannerHostReserveDao persist hostReservation return true if s_logger isDebugEnabled
final PlannerHostReservationVO hostReservation _plannerHostReserveDao lockRow id true if hostReservation null if s_logger isDebugEnabled s_logger debug hostId return false hostReservation setResourceUsage null _plannerHostReserveDao persist hostReservation return true if s_logger isDebugEnabled s_logger debug hostId return false catch final CloudRuntimeException e throw e catch final Throwable t
private void cancelHostMaintenance Host host if resourceManager cancelMaintenance host getId String message host getUuid
private void putHostIntoMaintenance Host host throws InterruptedException AgentUnavailableException
private Ternary Boolean Boolean String reCheckCapacityBeforeMaintenanceOnHost Cluster cluster Host host Boolean forced List HostSkipped hostsSkipped Pair Boolean String capacityCheckBeforeMaintenance performCapacityChecksBeforeHostInMaintenance host cluster if capacityCheckBeforeMaintenance first String errorMsg host getUuid capacityCheckBeforeMaintenance second if forced
private boolean isMaintenanceStageAvoided Host host Map Long String hostsToAvoidMaintenance List HostSkipped hostsSkipped if hostsToAvoidMaintenance containsKey host getId
private void performPreFlightChecks List Host hosts int timeout String payload Boolean forced Map Long String hostsToAvoidMaintenance throws InterruptedException for Host host hosts Ternary Boolean String Boolean result performStageOnHost host Stage PreFlight timeout payload forced if result third hostsToAvoidMaintenance containsKey host getId
private Pair Boolean String performCapacityChecksBeforeHostInMaintenance Host host Cluster cluster List HostVO hosts hostDao findByClusterId cluster getId List Host hostsInCluster hosts stream filter x x getId host getId x getClusterId equals cluster getId x getResourceState ResourceState Enabled x getStatus Status Up collect Collectors toList if CollectionUtils isEmpty hostsInCluster throw new CloudRuntimeException cluster getUuid cluster getName host getUuid host getName List VMInstanceVO vmsRunning vmInstanceDao listByHostId host getId if CollectionUtils isEmpty vmsRunning return new Pair true List String hostTags hostTagsDao gethostTags host getId int sucessfullyCheckedVmMigrations for VMInstanceVO runningVM vmsRunning boolean canMigrateVm false ServiceOfferingVO serviceOffering serviceOfferingDao findById runningVM getServiceOfferingId for Host hostInCluster hostsInCluster if checkHostTags hostTags hostTagsDao gethostTags hostInCluster getId serviceOffering getHostTag
return new Pair true List String hostTags hostTagsDao gethostTags host getId int sucessfullyCheckedVmMigrations for VMInstanceVO runningVM vmsRunning boolean canMigrateVm false ServiceOfferingVO serviceOffering serviceOfferingDao findById runningVM getServiceOfferingId for Host hostInCluster hostsInCluster if checkHostTags hostTags hostTagsDao gethostTags hostInCluster getId serviceOffering getHostTag s_logger debug host getUuid hostInCluster getUuid continue DeployDestination deployDestination new DeployDestination null null null host VirtualMachineProfileImpl vmProfile new VirtualMachineProfileImpl runningVM boolean affinityChecks true for AffinityGroupProcessor affinityProcessor _affinityProcessors affinityChecks affinityChecks affinityProcessor check vmProfile deployDestination
domainId project getDomainId else domainId account getDomainId while domainId null DomainVO domain _domainDao findById domainId if domainId Domain ROOT_DOMAIN long domainResourceLimit findCorrectResourceLimitForDomain domain type long currentDomainResourceCount _resourceCountDao getResourceCount domainId ResourceOwnerType Domain type long requestedDomainResourceCount currentDomainResourceCount numResources String messageSuffix type domainId toHumanReadableSize domainResourceLimit toHumanReadableSize currentDomainResourceCount toHumanReadableSize numResources if s_logger isDebugEnabled s_logger debug messageSuffix if domainResourceLimit Resource RESOURCE_UNLIMITED requestedDomainResourceCount domainResourceLimit String message messageSuffix ResourceAllocationException e new ResourceAllocationException message type
long currentResourceCount _resourceCountDao getResourceCount account getId ResourceOwnerType Account type long requestedResourceCount currentResourceCount numResources String convertedAccountResourceLimit String valueOf accountResourceLimit String convertedCurrentResourceCount String valueOf currentResourceCount String convertedNumResources String valueOf numResources if type ResourceType secondary_storage type ResourceType primary_storage convertedAccountResourceLimit toHumanReadableSize accountResourceLimit convertedCurrentResourceCount toHumanReadableSize currentResourceCount convertedNumResources toHumanReadableSize numResources String messageSuffix type project null account getAccountName project getName account getDomainId convertedAccountResourceLimit convertedCurrentResourceCount convertedNumResources if s_logger isDebugEnabled s_logger debug messageSuffix if accountResourceLimit Resource RESOURCE_UNLIMITED requestedResourceCount accountResourceLimit String message messageSuffix ResourceAllocationException e new ResourceAllocationException message type
if type ResourceType secondary_storage type ResourceType primary_storage convertedDelta toHumanReadableSize delta s_logger debug type accountId increment convertedDelta try return Transaction execute new TransactionCallback Boolean Override public Boolean doInTransaction TransactionStatus status boolean result true List ResourceCountVO rowsToUpdate lockAccountAndOwnerDomainRows accountId type for ResourceCountVO rowToUpdate rowsToUpdate if _resourceCountDao updateById rowToUpdate getId increment delta s_logger trace rowToUpdate result false return result catch Exception ex
String resouce rs1 getString if resouce null continue if resouce equalsIgnoreCase resouce equalsIgnoreCase resouce equalsIgnoreCase resouce equalsIgnoreCase resouce equalsIgnoreCase pvdriverversion break _configDao getValueAndInitIfNotExist Config XenServerPVdriverVersion key Config XenServerPVdriverVersion getCategory pvdriverversion Config XenServerPVdriverVersion getDescription sql pstmt txn prepareAutoCloseStatement sql rs2 pstmt executeQuery List Long tmpl_ids new ArrayList Long while rs2 next tmpl_ids add rs2 getLong for Long tmpl_id tmpl_ids templateDetailsInitIfNotExist tmpl_id pvdriverversion catch Exception e
if userid startsWith return if Boolean valueOf _configDao getValue return String already _configDao getValue if already null TransactionLegacy txn TransactionLegacy currentTxn try String rpassword _mgrService generateRandomPassword String wSql PreparedStatement stmt txn prepareAutoCloseStatement wSql stmt setString DBEncryptionUtil encrypt rpassword stmt executeUpdate s_logger info catch SQLException e
else privkeyfile new File homeDir pubkeyfile new File homeDir if already null already isEmpty if s_logger isInfoEnabled s_logger info boolean onWindows isOnWindows if onWindows Script runSimpleBashScript privkeyfile privkeyfile privkeyfile privkeyfile final String privateKey final String publicKey try privateKey new String Files readAllBytes privkeyfile toPath catch IOException e s_logger error e
final int accountExpectedCount accountSupportedResourceTypes size final int domainExpectedCount domainSupportedResourceTypes size if domainResourceCount size domainExpectedCount domains size s_logger debug for final DomainVO domain domains Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status _domainDao lockRow domain getId true List ResourceCountVO domainCounts _resourceCountDao listByOwnerId domain getId ResourceOwnerType Domain List String domainCountStr new ArrayList String for ResourceCountVO domainCount domainCounts domainCountStr add domainCount getType toString if domainCountStr size domainExpectedCount for ResourceType resourceType domainSupportedResourceTypes if domainCountStr contains resourceType toString
if domainCountStr contains resourceType toString ResourceCountVO resourceCountVO new ResourceCountVO resourceType domain getId ResourceOwnerType Domain s_logger debug resourceType domain getId _resourceCountDao persist resourceCountVO if accountResourceCount size accountExpectedCount accounts size s_logger debug for final AccountVO account accounts Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult TransactionStatus status _accountDao lockRow account getId true List ResourceCountVO accountCounts _resourceCountDao listByOwnerId account getId ResourceOwnerType Account List String accountCountStr new ArrayList String for ResourceCountVO accountCount accountCounts accountCountStr add accountCount getType toString
if s_logger isDebugEnabled s_logger debug throw new PermissionDeniedException final VMInstanceVO vm _vmInstanceDao findById vmId if vm null final InvalidParameterValueException ex new InvalidParameterValueException throw ex if vm getState State Running if s_logger isDebugEnabled s_logger debug vm final InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject vm getUuid throw ex UserVmDetailVO userVmDetailVO _UserVmDetailsDao findDetail vm getId ApiConstants BootType UEFI toString if userVmDetailVO null
final VMInstanceVO vm _vmInstanceDao findById vmId if vm null final InvalidParameterValueException ex new InvalidParameterValueException throw ex if vm getState State Running if s_logger isDebugEnabled s_logger debug vm final InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject vm getUuid throw ex UserVmDetailVO userVmDetailVO _UserVmDetailsDao findDetail vm getId ApiConstants BootType UEFI toString if userVmDetailVO null s_logger info vm getInstanceName if equalsIgnoreCase userVmDetailVO getValue equalsIgnoreCase userVmDetailVO getValue return new Ternary Pair List extends Host Integer List extends Host Map Host Boolean new Pair List extends Host Integer new ArrayList HostVO new Integer new ArrayList Host new HashMap Host Boolean
throw ex if vm getState State Running if s_logger isDebugEnabled s_logger debug vm final InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject vm getUuid throw ex UserVmDetailVO userVmDetailVO _UserVmDetailsDao findDetail vm getId ApiConstants BootType UEFI toString if userVmDetailVO null s_logger info vm getInstanceName if equalsIgnoreCase userVmDetailVO getValue equalsIgnoreCase userVmDetailVO getValue return new Ternary Pair List extends Host Integer List extends Host Map Host Boolean new Pair List extends Host Integer new ArrayList HostVO new Integer new ArrayList Host new HashMap Host Boolean if _serviceOfferingDetailsDao findDetail vm getServiceOfferingId GPU Keys pciDevice toString null s_logger info vm getInstanceName return new Ternary Pair List extends Host Integer List extends Host Map Host Boolean new Pair List extends Host Integer new ArrayList HostVO new Integer new ArrayList Host new HashMap Host Boolean
throw ex UserVmDetailVO userVmDetailVO _UserVmDetailsDao findDetail vm getId ApiConstants BootType UEFI toString if userVmDetailVO null s_logger info vm getInstanceName if equalsIgnoreCase userVmDetailVO getValue equalsIgnoreCase userVmDetailVO getValue return new Ternary Pair List extends Host Integer List extends Host Map Host Boolean new Pair List extends Host Integer new ArrayList HostVO new Integer new ArrayList Host new HashMap Host Boolean if _serviceOfferingDetailsDao findDetail vm getServiceOfferingId GPU Keys pciDevice toString null s_logger info vm getInstanceName return new Ternary Pair List extends Host Integer List extends Host Map Host Boolean new Pair List extends Host Integer new ArrayList HostVO new Integer new ArrayList Host new HashMap Host Boolean if vm getHypervisorType equals HypervisorType XenServer vm getHypervisorType equals HypervisorType VMware vm getHypervisorType equals HypervisorType KVM vm getHypervisorType equals HypervisorType Ovm vm getHypervisorType equals HypervisorType Hyperv vm getHypervisorType equals HypervisorType LXC vm getHypervisorType equals HypervisorType Simulator vm getHypervisorType equals HypervisorType Ovm3 if s_logger isDebugEnabled s_logger debug vm throw new InvalidParameterValueException if vm getType equals VirtualMachine Type User vm getHypervisorType equals HypervisorType LXC throw new InvalidParameterValueException
else if storagePool isManaged if srcHost getClusterId host getClusterId requiresStorageMotion put host true plan new DataCenterDeployment srcHost getDataCenterId null null null null null else final Long cluster srcHost getClusterId if s_logger isDebugEnabled s_logger debug cluster vm allHostsPair searchForServers startIndex pageSize null hostType null null null cluster null keyword null null null null allHosts allHostsPair first allHosts remove srcHost plan new DataCenterDeployment srcHost getDataCenterId srcHost getPodId srcHost getClusterId null null null final Pair List extends Host Integer otherHosts new Pair List extends Host Integer allHosts allHostsPair second List Host suitableHosts new ArrayList Host
throw new PermissionDeniedException final VolumeVO volume _volumeDao findById volumeId if volume null final InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject volumeId toString throw ex List extends StoragePool allPools new ArrayList StoragePool List extends StoragePool suitablePools new ArrayList StoragePool if Volume State Ready equals volume getState s_logger info volume return new Pair List extends StoragePool List extends StoragePool allPools suitablePools final Long instanceId volume getInstanceId VMInstanceVO vm null if instanceId null vm _vmInstanceDao findById instanceId
final VolumeVO volume _volumeDao findById volumeId if volume null final InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject volumeId toString throw ex List extends StoragePool allPools new ArrayList StoragePool List extends StoragePool suitablePools new ArrayList StoragePool if Volume State Ready equals volume getState s_logger info volume return new Pair List extends StoragePool List extends StoragePool allPools suitablePools final Long instanceId volume getInstanceId VMInstanceVO vm null if instanceId null vm _vmInstanceDao findById instanceId if vm null
final InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject volumeId toString throw ex List extends StoragePool allPools new ArrayList StoragePool List extends StoragePool suitablePools new ArrayList StoragePool if Volume State Ready equals volume getState s_logger info volume return new Pair List extends StoragePool List extends StoragePool allPools suitablePools final Long instanceId volume getInstanceId VMInstanceVO vm null if instanceId null vm _vmInstanceDao findById instanceId if vm null s_logger info volume else if vm getState State Running
final Long instanceId volume getInstanceId VMInstanceVO vm null if instanceId null vm _vmInstanceDao findById instanceId if vm null s_logger info volume else if vm getState State Running s_logger info volume else s_logger info volume boolean storageMotionSupported false final Long hostId vm getHostId if hostId null final HostVO host _hostDao findById hostId HypervisorCapabilitiesVO capabilities null
vm _vmInstanceDao findById instanceId if vm null s_logger info volume else if vm getState State Running s_logger info volume else s_logger info volume boolean storageMotionSupported false final Long hostId vm getHostId if hostId null final HostVO host _hostDao findById hostId HypervisorCapabilitiesVO capabilities null if host null capabilities _hypervisorCapabilitiesDao findByHypervisorTypeAndVersion host getHypervisorType host getHypervisorVersion else
if vm null s_logger info volume else if vm getState State Running s_logger info volume else s_logger info volume boolean storageMotionSupported false final Long hostId vm getHostId if hostId null final HostVO host _hostDao findById hostId HypervisorCapabilitiesVO capabilities null if host null capabilities _hypervisorCapabilitiesDao findByHypervisorTypeAndVersion host getHypervisorType host getHypervisorVersion else s_logger error vm volume
private String signRequest final String request final String key try
private String signRequest final String request final String key try s_logger info request
private boolean updateHostsInCluster final UpdateHostPasswordCmd command final List HostVO hosts _resourceMgr listAllHostsInCluster command getClusterId Transaction execute new TransactionCallbackNoReturn Override public void doInTransactionWithoutResult final TransactionStatus status for final HostVO h hosts if s_logger isDebugEnabled
private void enableAdminUser final String password String encodedPassword null final UserVO adminUser _userDao getUser if adminUser null final String msg
protected void init Map String String configs _executor Executors newScheduledThreadPool new NamedThreadFactory hostStatsInterval NumbersUtil parseLong configs get ONE_MINUTE_IN_MILLISCONDS hostAndVmStatsInterval NumbersUtil parseLong configs get ONE_MINUTE_IN_MILLISCONDS storageStatsInterval NumbersUtil parseLong configs get ONE_MINUTE_IN_MILLISCONDS volumeStatsInterval NumbersUtil parseLong configs get ONE_MINUTE_IN_MILLISCONDS autoScaleStatsInterval NumbersUtil parseLong configs get ONE_MINUTE_IN_MILLISCONDS String statsUri statsOutputUri value if StringUtils isNotBlank statsUri try URI uri new URI statsUri externalStatsScheme uri getScheme try externalStatsType ExternalStatsProtocol valueOf externalStatsScheme toUpperCase catch IllegalArgumentException e
try externalStatsType ExternalStatsProtocol valueOf externalStatsScheme toUpperCase catch IllegalArgumentException e s_logger error externalStatsScheme if StringUtils isNotEmpty uri getHost externalStatsHost uri getHost externalStatsPort retrieveExternalStatsPortFromUri uri databaseName configureDatabaseName uri if StringUtils isEmpty uri getPath externalStatsPrefix uri getPath substring if StringUtils isEmpty externalStatsPrefix externalStatsPrefix else externalStatsPrefix catch URISyntaxException e
else externalStatsPrefix catch URISyntaxException e s_logger error e if hostStatsInterval _executor scheduleWithFixedDelay new HostCollector 15000L hostStatsInterval TimeUnit MILLISECONDS if hostAndVmStatsInterval _executor scheduleWithFixedDelay new VmStatsCollector 15000L hostAndVmStatsInterval TimeUnit MILLISECONDS if storageStatsInterval _executor scheduleWithFixedDelay new StorageCollector 15000L storageStatsInterval TimeUnit MILLISECONDS if autoScaleStatsInterval _executor scheduleWithFixedDelay new AutoScaleMonitor 15000L autoScaleStatsInterval TimeUnit MILLISECONDS if vmDiskStatsInterval value if vmDiskStatsInterval value vmDiskStatsIntervalMin value s_logger debug vmDiskStatsInterval value vmDiskStatsIntervalMin value
protected void sendVmMetricsToGraphiteHost Map Object Object metrics HostVO host
public String encryptText String text if text null text isEmpty return text try Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher ENCRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes cipher doFinal text getBytes return Base64 encodeBase64URLSafeString encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e
Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher ENCRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes cipher doFinal text getBytes return Base64 encodeBase64URLSafeString encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e
byte encryptedBytes cipher doFinal text getBytes return Base64 encodeBase64URLSafeString encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e
catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e s_logger error e return null
public String decryptText String encryptedText if encryptedText null encryptedText isEmpty return encryptedText try Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher DECRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes Base64 decodeBase64 encryptedText return new String cipher doFinal encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e
Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher DECRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes Base64 decodeBase64 encryptedText return new String cipher doFinal encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e
byte encryptedBytes Base64 decodeBase64 encryptedText return new String cipher doFinal encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e
catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e s_logger error e return null
return HostVO host _ms getHostBy vm getHostId if host null s_logger warn vmId sendResponse resp return String rootUrl _ms getConsoleAccessUrlRoot vmId if rootUrl null sendResponse resp return int w DEFAULT_THUMBNAIL_WIDTH int h DEFAULT_THUMBNAIL_HEIGHT String value req getParameter try w Integer parseInt value
sendResponse resp return String rootUrl _ms getConsoleAccessUrlRoot vmId if rootUrl null sendResponse resp return int w DEFAULT_THUMBNAIL_WIDTH int h DEFAULT_THUMBNAIL_HEIGHT String value req getParameter try w Integer parseInt value catch NumberFormatException e s_logger info value value req getParameter try
if rootUrl null sendResponse resp return int w DEFAULT_THUMBNAIL_WIDTH int h DEFAULT_THUMBNAIL_HEIGHT String value req getParameter try w Integer parseInt value catch NumberFormatException e s_logger info value value req getParameter try h Integer parseInt value catch NumberFormatException e s_logger info value
return if Hypervisor HypervisorType LXC equals vm getHypervisorType sendResponse resp return String rootUrl _ms getConsoleAccessUrlRoot vmId if rootUrl null sendResponse resp return String vmName vm getHostName if vm getType VirtualMachine Type User UserVm userVm _entityMgr findById UserVm class vmId String displayName userVm getDisplayName if displayName null displayName isEmpty displayName equals vmName vmName displayName StringBuffer sb new StringBuffer
static public Ternary String String String parseHostInfo String hostInfo String host null String tunnelUrl null String tunnelSession null
ConsoleProxyPasswordBasedEncryptor encryptor new ConsoleProxyPasswordBasedEncryptor getEncryptorPassword ConsoleProxyClientParam param new ConsoleProxyClientParam param setClientHostAddress parsedHostInfo first param setClientHostPort portInfo second param setClientHostPassword sid param setClientTag tag param setTicket ticket if portInfo second param setHypervHost host param setUsername _ms findDetail hostVo getId getValue param setPassword _ms findDetail hostVo getId getValue if parsedHostInfo second null parsedHostInfo third null param setClientTunnelUrl parsedHostInfo second param setClientTunnelSession parsedHostInfo third sb append encryptor encryptObject ConsoleProxyClientParam class param
param setClientHostPort port param setClientHostPassword sid param setClientTag tag param setTicket ticket if details null param setLocale details getValue if portInfo second param setHypervHost host param setUsername _ms findDetail hostVo getId getValue param setPassword _ms findDetail hostVo getId getValue if parsedHostInfo second null parsedHostInfo third null param setClientTunnelUrl parsedHostInfo second param setClientTunnelSession parsedHostInfo third if param getHypervHost null ConsoleProxyManager NoVncConsoleDefault value sb append encryptor encryptObject ConsoleProxyClientParam class param
private boolean checkSessionPermision HttpServletRequest req long vmId Account accountObj VirtualMachine vm _vmMgr findById vmId if vm null
private boolean checkSessionPermision HttpServletRequest req long vmId Account accountObj VirtualMachine vm _vmMgr findById vmId if vm null s_logger debug vmId return false if _accountMgr isRootAdmin accountObj getId return true switch vm getType case User try _accountMgr checkAccess accountObj null true vm catch PermissionDeniedException ex if _accountMgr isNormalUser accountObj getId if s_logger isDebugEnabled s_logger debug vm getAccountId accountObj getId else if _accountMgr isDomainAdmin accountObj getId accountObj getType Account ACCOUNT_TYPE_READ_ONLY_ADMIN if s_logger isDebugEnabled
if unsignedRequest null unsignedRequest paramName URLEncoder encode paramValue replaceAll else unsignedRequest unsignedRequest paramName URLEncoder encode paramValue replaceAll if signature null apiKey null if s_logger isDebugEnabled s_logger debug signature apiKey return false TransactionLegacy txn TransactionLegacy open TransactionLegacy CLOUD_DB txn close User user null Pair User Account userAcctPair _accountMgr findUserByApiKey apiKey if userAcctPair null s_logger debug apiKey return false
private boolean prepareNodes String clusterName List HostVO hosts PrepareOCFS2NodesCommand cmd new PrepareOCFS2NodesCommand clusterName marshalNodes hosts for HostVO h hosts Answer ans _agentMgr easySend h getId cmd if ans null
String errMsg String format host getId host getDataCenterId host getPodId host getClusterId if host getHypervisorType HypervisorType Ovm return boolean hasOcfs2 false List StoragePoolHostVO poolRefs _poolHostDao listByHostId host getId for StoragePoolHostVO poolRef poolRefs StoragePoolVO pool _poolDao findById poolRef getPoolId if pool getPoolType StoragePoolType OCFS2 hasOcfs2 true break if hasOcfs2 try if prepareNodes host getClusterId s_logger warn errMsg catch Exception e
Override public boolean configure String name Map String Object params Map String String configs _configDao getConfiguration params _storagePoolAcquisitionWaitSeconds NumbersUtil parseInt configs get
if isLocal null useLocalStorageForSystemVM isLocal booleanValue if dc isLocalStorageEnabled useLocalStorageForSystemVM return null DataStore store try String hostAddress pInfo getHost if host getHypervisorType Hypervisor HypervisorType VMware hostAddress pInfo getHostPath StoragePoolVO pool _storagePoolDao findPoolByHostPath host getDataCenterId host getPodId hostAddress pInfo getHostPath pInfo getUuid if pool null host getHypervisorType HypervisorType VMware if pInfo getHostPath length pool _storagePoolDao findPoolByHostPath host getDataCenterId host getPodId hostAddress pInfo getUuid if pool null pool _storagePoolDao findPoolByHostPath host getDataCenterId host getPodId hostAddress null pInfo getUuid
Override public void removeStoragePoolFromCluster long hostId String iScsiName StoragePool storagePool final Map String String details new HashMap details put DeleteStoragePoolCommand DATASTORE_NAME iScsiName details put DeleteStoragePoolCommand IQN iScsiName details put DeleteStoragePoolCommand STORAGE_HOST storagePool getHostAddress details put DeleteStoragePoolCommand STORAGE_PORT String valueOf storagePool getPort final DeleteStoragePoolCommand cmd new DeleteStoragePoolCommand cmd setDetails details cmd setRemoveDatastore true final Answer answer _agentMgr easySend hostId cmd if answer null answer getResult String errMsg StringUtils isNotBlank answer getDetails answer getDetails
if sPool getStatus StoragePoolStatus Maintenance s_logger warn id throw new InvalidParameterValueException id Pair Long Long vlms _volsDao getCountAndTotalByPool id if forced if vlms first Pair Long Long nonDstrdVlms _volsDao getNonDestroyedCountAndTotalByPool id if nonDstrdVlms first throw new CloudRuntimeException sPool getName List VolumeVO vols _volsDao listVolumesToBeDestroyed for VolumeVO vol vols AsyncCallFuture VolumeApiResult future volService expungeVolumeAsync volFactory getVolume vol getId try future get catch InterruptedException e
s_logger warn id throw new InvalidParameterValueException id Pair Long Long vlms _volsDao getCountAndTotalByPool id if forced if vlms first Pair Long Long nonDstrdVlms _volsDao getNonDestroyedCountAndTotalByPool id if nonDstrdVlms first throw new CloudRuntimeException sPool getName List VolumeVO vols _volsDao listVolumesToBeDestroyed for VolumeVO vol vols AsyncCallFuture VolumeApiResult future volService expungeVolumeAsync volFactory getVolume vol getId try future get catch InterruptedException e s_logger debug vol getId e
if nonDstrdVlms first throw new CloudRuntimeException sPool getName List VolumeVO vols _volsDao listVolumesToBeDestroyed for VolumeVO vol vols AsyncCallFuture VolumeApiResult future volService expungeVolumeAsync volFactory getVolume vol getId try future get catch InterruptedException e s_logger debug vol getId e catch ExecutionException e s_logger debug vol getId e else if vlms first throw new CloudRuntimeException sPool getName StoragePoolVO lock _storagePoolDao acquireInLockTable sPool getId
Override public void createCapacityEntry StoragePoolVO storagePool short capacityType long allocated SearchCriteria CapacityVO capacitySC _capacityDao createSearchCriteria capacitySC addAnd SearchCriteria Op EQ storagePool getId capacitySC addAnd SearchCriteria Op EQ storagePool getDataCenterId capacitySC addAnd SearchCriteria Op EQ capacityType List CapacityVO capacities _capacityDao search capacitySC null long totalOverProvCapacity if storagePool getPoolType supportsOverProvisioning BigDecimal overProvFactor getStorageOverProvisioningFactor storagePool getId totalOverProvCapacity overProvFactor multiply new BigDecimal storagePool getCapacityBytes longValue
Override public void createCapacityEntry StoragePoolVO storagePool short capacityType long allocated SearchCriteria CapacityVO capacitySC _capacityDao createSearchCriteria capacitySC addAnd SearchCriteria Op EQ storagePool getId capacitySC addAnd SearchCriteria Op EQ storagePool getDataCenterId capacitySC addAnd SearchCriteria Op EQ capacityType List CapacityVO capacities _capacityDao search capacitySC null long totalOverProvCapacity if storagePool getPoolType supportsOverProvisioning BigDecimal overProvFactor getStorageOverProvisioningFactor storagePool getId totalOverProvCapacity overProvFactor multiply new BigDecimal storagePool getCapacityBytes longValue s_logger debug storagePool getName storagePool getPoolType toString overProvFactor toString
if storagePool getScope ScopeType HOST List StoragePoolHostVO stoargePoolHostVO _storagePoolHostDao listByPoolId storagePool getId if stoargePoolHostVO null stoargePoolHostVO isEmpty HostVO host _hostDao findById stoargePoolHostVO get getHostId if host null capacityState host getResourceState ResourceState Disabled CapacityState Disabled CapacityState Enabled if capacities size CapacityVO capacity new CapacityVO storagePool getId storagePool getDataCenterId storagePool getPodId storagePool getClusterId allocated totalOverProvCapacity capacityType capacity setCapacityState capacityState _capacityDao persist capacity else CapacityVO capacity capacities get if capacity getTotalCapacity totalOverProvCapacity allocated capacity getUsedCapacity capacity getCapacityState capacityState capacity setTotalCapacity totalOverProvCapacity capacity setUsedCapacity allocated
if hostIds remove hostIdsToTryFirst i hostIds add hostIdsToTryFirst i if hostIdsToAvoid null hostIds removeAll hostIdsToAvoid if hostIds null hostIds isEmpty throw new StorageUnavailableException pool getId pool getId for Long hostId hostIds try List Answer answers new ArrayList Answer Command cmdArray cmds toCommands for Command cmd cmdArray long targetHostId _hvGuruMgr getGuruProcessedCommandTargetHost hostId cmd answers add _agentMgr send targetHostId cmd return new Pair Long Answer hostId answers toArray new Answer answers size catch AgentUnavailableException e
if hostIdsToAvoid null hostIds removeAll hostIdsToAvoid if hostIds null hostIds isEmpty throw new StorageUnavailableException pool getId pool getId for Long hostId hostIds try List Answer answers new ArrayList Answer Command cmdArray cmds toCommands for Command cmd cmdArray long targetHostId _hvGuruMgr getGuruProcessedCommandTargetHost hostId cmd answers add _agentMgr send targetHostId cmd return new Pair Long Answer hostId answers toArray new Answer answers size catch AgentUnavailableException e s_logger debug pool hostId e catch OperationTimedoutException e
Override public void cleanupStorage boolean recurring GlobalLock scanLock GlobalLock getInternLock try if scanLock lock try if TemplateCleanupEnabled value List StoragePoolVO storagePools _storagePoolDao listAll for StoragePoolVO pool storagePools try List VMTemplateStoragePoolVO unusedTemplatesInPool _tmpltMgr getUnusedTemplatesInPool pool
Override public void cleanupStorage boolean recurring GlobalLock scanLock GlobalLock getInternLock try if scanLock lock try if TemplateCleanupEnabled value List StoragePoolVO storagePools _storagePoolDao listAll for StoragePoolVO pool storagePools try List VMTemplateStoragePoolVO unusedTemplatesInPool _tmpltMgr getUnusedTemplatesInPool pool s_logger debug unusedTemplatesInPool size pool getName for VMTemplateStoragePoolVO templatePoolVO unusedTemplatesInPool if templatePoolVO getDownloadState VMTemplateStorageResourceAssoc Status DOWNLOADED
if scanLock lock try if TemplateCleanupEnabled value List StoragePoolVO storagePools _storagePoolDao listAll for StoragePoolVO pool storagePools try List VMTemplateStoragePoolVO unusedTemplatesInPool _tmpltMgr getUnusedTemplatesInPool pool s_logger debug unusedTemplatesInPool size pool getName for VMTemplateStoragePoolVO templatePoolVO unusedTemplatesInPool if templatePoolVO getDownloadState VMTemplateStorageResourceAssoc Status DOWNLOADED s_logger debug templatePoolVO getTemplateId templatePoolVO getPoolId continue if templatePoolVO getMarkedForGC templatePoolVO setMarkedForGC true _vmTemplatePoolDao update templatePoolVO getId templatePoolVO
s_logger debug templatePoolVO getTemplateId templatePoolVO getPoolId continue if templatePoolVO getMarkedForGC templatePoolVO setMarkedForGC true _vmTemplatePoolDao update templatePoolVO getId templatePoolVO s_logger debug templatePoolVO getTemplateId templatePoolVO getPoolId continue _tmpltMgr evictTemplateFromStoragePool templatePoolVO catch Exception e s_logger warn pool e List SnapshotDataStoreVO ssSnapshots _snapshotStoreDao listByState ObjectInDataStoreStateMachine State Destroying for SnapshotDataStoreVO ssSnapshotVO ssSnapshots try _snapshotService deleteSnapshot snapshotFactory getSnapshot ssSnapshotVO getSnapshotId DataStoreRole Image catch Exception e
s_logger warn pool e List SnapshotDataStoreVO ssSnapshots _snapshotStoreDao listByState ObjectInDataStoreStateMachine State Destroying for SnapshotDataStoreVO ssSnapshotVO ssSnapshots try _snapshotService deleteSnapshot snapshotFactory getSnapshot ssSnapshotVO getSnapshotId DataStoreRole Image catch Exception e s_logger debug ssSnapshotVO getId cleanupSecondaryStorage recurring List VolumeVO vols _volsDao listVolumesToBeDestroyed new Date System currentTimeMillis long StorageCleanupDelay value for VolumeVO vol vols try handleManagedStorage vol catch Exception e s_logger warn vol getUuid e try
catch Exception e s_logger warn vol getUuid e List SnapshotVO snapshots _snapshotDao listAllByStatus Snapshot State Error for SnapshotVO snapshotVO snapshots try List SnapshotDataStoreVO storeRefs _snapshotStoreDao findBySnapshotId snapshotVO getId for SnapshotDataStoreVO ref storeRefs _snapshotStoreDao expunge ref getId _snapshotDao expunge snapshotVO getId catch Exception e s_logger warn snapshotVO getUuid e List VolumeDataStoreVO volumeDataStores _volumeDataStoreDao listByVolumeState Volume State UploadError Volume State UploadAbandoned for VolumeDataStoreVO volumeDataStore volumeDataStores VolumeVO volume _volumeDao findById volumeDataStore getVolumeId if volume null
Override DB public void cleanupSecondaryStorage boolean recurring try List DataStore imageStores _dataStoreMgr getImageStoresByScope new ZoneScope null for DataStore store imageStores try long storeId store getId List TemplateDataStoreVO destroyedTemplateStoreVOs _templateStoreDao listDestroyed storeId
Override DB public void cleanupSecondaryStorage boolean recurring try List DataStore imageStores _dataStoreMgr getImageStoresByScope new ZoneScope null for DataStore store imageStores try long storeId store getId List TemplateDataStoreVO destroyedTemplateStoreVOs _templateStoreDao listDestroyed storeId s_logger debug destroyedTemplateStoreVOs size store getName for TemplateDataStoreVO destroyedTemplateStoreVO destroyedTemplateStoreVOs if s_logger isDebugEnabled
List DataStore imageStores _dataStoreMgr getImageStoresByScope new ZoneScope null for DataStore store imageStores try long storeId store getId List TemplateDataStoreVO destroyedTemplateStoreVOs _templateStoreDao listDestroyed storeId s_logger debug destroyedTemplateStoreVOs size store getName for TemplateDataStoreVO destroyedTemplateStoreVO destroyedTemplateStoreVOs if s_logger isDebugEnabled s_logger debug destroyedTemplateStoreVO _templateStoreDao remove destroyedTemplateStoreVO getId catch Exception e s_logger warn store getName e for DataStore store imageStores try List SnapshotDataStoreVO destroyedSnapshotStoreVOs _snapshotStoreDao listDestroyed store getId
List TemplateDataStoreVO destroyedTemplateStoreVOs _templateStoreDao listDestroyed storeId s_logger debug destroyedTemplateStoreVOs size store getName for TemplateDataStoreVO destroyedTemplateStoreVO destroyedTemplateStoreVOs if s_logger isDebugEnabled s_logger debug destroyedTemplateStoreVO _templateStoreDao remove destroyedTemplateStoreVO getId catch Exception e s_logger warn store getName e for DataStore store imageStores try List SnapshotDataStoreVO destroyedSnapshotStoreVOs _snapshotStoreDao listDestroyed store getId s_logger debug destroyedSnapshotStoreVOs size store getName for SnapshotDataStoreVO destroyedSnapshotStoreVO destroyedSnapshotStoreVOs SnapshotInfo snap snapshotFactory getSnapshot destroyedSnapshotStoreVO getSnapshotId store if snap getChild null
if s_logger isDebugEnabled s_logger debug destroyedTemplateStoreVO _templateStoreDao remove destroyedTemplateStoreVO getId catch Exception e s_logger warn store getName e for DataStore store imageStores try List SnapshotDataStoreVO destroyedSnapshotStoreVOs _snapshotStoreDao listDestroyed store getId s_logger debug destroyedSnapshotStoreVOs size store getName for SnapshotDataStoreVO destroyedSnapshotStoreVO destroyedSnapshotStoreVOs SnapshotInfo snap snapshotFactory getSnapshot destroyedSnapshotStoreVO getSnapshotId store if snap getChild null s_logger debug destroyedSnapshotStoreVO continue if s_logger isDebugEnabled
catch Exception e s_logger warn store getName e for DataStore store imageStores try List SnapshotDataStoreVO destroyedSnapshotStoreVOs _snapshotStoreDao listDestroyed store getId s_logger debug destroyedSnapshotStoreVOs size store getName for SnapshotDataStoreVO destroyedSnapshotStoreVO destroyedSnapshotStoreVOs SnapshotInfo snap snapshotFactory getSnapshot destroyedSnapshotStoreVO getSnapshotId store if snap getChild null s_logger debug destroyedSnapshotStoreVO continue if s_logger isDebugEnabled s_logger debug destroyedSnapshotStoreVO _snapshotDao remove destroyedSnapshotStoreVO getSnapshotId SnapshotDataStoreVO snapshotOnPrimary _snapshotStoreDao findDestroyedReferenceBySnapshot destroyedSnapshotStoreVO getSnapshotId DataStoreRole Primary
s_logger debug destroyedSnapshotStoreVOs size store getName for SnapshotDataStoreVO destroyedSnapshotStoreVO destroyedSnapshotStoreVOs SnapshotInfo snap snapshotFactory getSnapshot destroyedSnapshotStoreVO getSnapshotId store if snap getChild null s_logger debug destroyedSnapshotStoreVO continue if s_logger isDebugEnabled s_logger debug destroyedSnapshotStoreVO _snapshotDao remove destroyedSnapshotStoreVO getSnapshotId SnapshotDataStoreVO snapshotOnPrimary _snapshotStoreDao findDestroyedReferenceBySnapshot destroyedSnapshotStoreVO getSnapshotId DataStoreRole Primary if snapshotOnPrimary null if s_logger isDebugEnabled s_logger debug snapshotOnPrimary _snapshotStoreDao remove snapshotOnPrimary getId _snapshotStoreDao remove destroyedSnapshotStoreVO getId
Override DB public PrimaryDataStoreInfo preparePrimaryStorageForMaintenance Long primaryStorageId throws ResourceUnavailableException InsufficientCapacityException StoragePoolVO primaryStorage null primaryStorage _storagePoolDao findById primaryStorageId if primaryStorage null String msg
Override DB public PrimaryDataStoreInfo cancelPrimaryStorageForMaintenance CancelPrimaryStorageMaintenanceCmd cmd throws ResourceUnavailableException Long primaryStorageId cmd getId StoragePoolVO primaryStorage null primaryStorage _storagePoolDao findById primaryStorageId if primaryStorage null String msg
Override public void onManagementNodeLeft List extends ManagementServerHost nodeList long selfNodeId for ManagementServerHost vo nodeList if vo getMsid _serverId
else if uri getScheme equalsIgnoreCase if uri getHost null uri getHost equalsIgnoreCase uri getPath null uri getPath equalsIgnoreCase throw new InvalidParameterValueException else if uri getScheme equalsIgnoreCase URI cifsUri new URI newUrl String warnMsg UriUtils getCifsUriParametersProblems cifsUri if warnMsg null throw new InvalidParameterValueException warnMsg catch URISyntaxException e throw new InvalidParameterValueException newUrl String oldUrl secHost getStorageUrl URI oldUri null try oldUri new URI UriUtils encodeURIComponent oldUrl if oldUri getScheme equalsIgnoreCase uri getScheme
if pool isManaged return true StatsCollector sc StatsCollector getInstance double storageUsedThreshold CapacityManager StorageCapacityDisableThreshold valueIn pool getDataCenterId if sc null long totalSize pool getCapacityBytes StorageStats stats sc getStoragePoolStats pool getId if stats null stats sc getStorageStats pool getId if stats null double usedPercentage double stats getByteUsed double totalSize if s_logger isDebugEnabled s_logger debug pool getId toHumanReadableSize pool getCapacityBytes toHumanReadableSize stats getByteUsed usedPercentage storageUsedThreshold if usedPercentage storageUsedThreshold if s_logger isDebugEnabled
return false if s_logger isDebugEnabled s_logger debug pool getId final StoragePoolVO poolVO _storagePoolDao findById pool getId long allocatedSizeWithTemplate _capacityMgr getAllocatedPoolCapacity poolVO null long totalAskingSize for Volume volume volumes VolumeVO volumeVO _volumeDao findById volume getId if volumeVO getHypervisorSnapshotReserve null volService updateHypervisorSnapshotReserveForVolume getDiskOfferingVO volumeVO volumeVO getId getHypervisorType volumeVO volumeVO _volumeDao findById volume getId if volume getTemplateId null VMTemplateVO tmpl _templateDao findByIdIncludingRemoved volume getTemplateId if tmpl null ImageFormat ISO equals tmpl getFormat allocatedSizeWithTemplate _capacityMgr getAllocatedPoolCapacity poolVO tmpl
private boolean checkPoolforSpace StoragePool pool long allocatedSizeWithTemplate long totalAskingSize StoragePoolVO poolVO _storagePoolDao findById pool getId long totalOverProvCapacity if pool getPoolType supportsOverProvisioning BigDecimal overProvFactor getStorageOverProvisioningFactor pool getId totalOverProvCapacity overProvFactor multiply new BigDecimal pool getCapacityBytes longValue
private boolean checkPoolforSpace StoragePool pool long allocatedSizeWithTemplate long totalAskingSize StoragePoolVO poolVO _storagePoolDao findById pool getId long totalOverProvCapacity if pool getPoolType supportsOverProvisioning BigDecimal overProvFactor getStorageOverProvisioningFactor pool getId totalOverProvCapacity overProvFactor multiply new BigDecimal pool getCapacityBytes longValue s_logger debug poolVO getName pool getPoolType toString overProvFactor toString
if pool getPoolType supportsOverProvisioning BigDecimal overProvFactor getStorageOverProvisioningFactor pool getId totalOverProvCapacity overProvFactor multiply new BigDecimal pool getCapacityBytes longValue s_logger debug poolVO getName pool getPoolType toString overProvFactor toString s_logger debug overProvFactor toHumanReadableSize pool getCapacityBytes else totalOverProvCapacity pool getCapacityBytes s_logger debug poolVO getName pool getPoolType toString s_logger debug poolVO getName pool getId toHumanReadableSize totalOverProvCapacity double storageAllocatedThreshold CapacityManager StorageAllocatedCapacityDisableThreshold valueIn pool getDataCenterId if s_logger isDebugEnabled s_logger debug pool getId toHumanReadableSize totalOverProvCapacity toHumanReadableSize allocatedSizeWithTemplate toHumanReadableSize totalAskingSize storageAllocatedThreshold double usedPercentage allocatedSizeWithTemplate totalAskingSize double totalOverProvCapacity if usedPercentage storageAllocatedThreshold if s_logger isDebugEnabled
s_logger debug overProvFactor toHumanReadableSize pool getCapacityBytes else totalOverProvCapacity pool getCapacityBytes s_logger debug poolVO getName pool getPoolType toString s_logger debug poolVO getName pool getId toHumanReadableSize totalOverProvCapacity double storageAllocatedThreshold CapacityManager StorageAllocatedCapacityDisableThreshold valueIn pool getDataCenterId if s_logger isDebugEnabled s_logger debug pool getId toHumanReadableSize totalOverProvCapacity toHumanReadableSize allocatedSizeWithTemplate toHumanReadableSize totalAskingSize storageAllocatedThreshold double usedPercentage allocatedSizeWithTemplate totalAskingSize double totalOverProvCapacity if usedPercentage storageAllocatedThreshold if s_logger isDebugEnabled s_logger debug pool getId usedPercentage storageAllocatedThreshold return false if totalOverProvCapacity allocatedSizeWithTemplate totalAskingSize if s_logger isDebugEnabled
_volumeStoreDao expunge volumeOnImageStore getId catch Throwable th s_logger warn volumeOnImageStore getExtractUrl volumeOnImageStore getVolumeId th for Long volumeId expiredVolumeIds if activeVolumeIds contains volumeId continue Volume volume _volumeDao findById volumeId if volume null volume getState Volume State Expunged _volumeDao remove volumeId List TemplateDataStoreVO templatesOnImageStoreList _templateStoreDao listTemplateDownloadUrls for TemplateDataStoreVO templateOnImageStore templatesOnImageStoreList try long downloadUrlCurrentAgeInSecs DateUtil getTimeDifference DateUtil now templateOnImageStore getExtractUrlCreated if downloadUrlCurrentAgeInSecs _downloadUrlExpirationInterval continue
if Grouping AllocationState Disabled zone getAllocationState _accountMgr isRootAdmin caller getId throw new PermissionDeniedException zoneId if url null if url toLowerCase contains throw new InvalidParameterValueException UriUtils validateUrl format url if VolumeUrlCheck value s_logger debug url UriUtils checkUrlExistence url _resourceLimitMgr checkResourceLimit _accountMgr getAccount ownerId ResourceType secondary_storage UriUtils getRemoteSize url else _resourceLimitMgr checkResourceLimit _accountMgr getAccount ownerId ResourceType secondary_storage try ImageFormat valueOf format toUpperCase catch IllegalArgumentException e
if cmd getSnapshotId null volume createVolumeFromSnapshot volume cmd getSnapshotId cmd getVirtualMachineId if volume getState Volume State Ready created false if cmd getVirtualMachineId null try attachVolumeToVM cmd getVirtualMachineId volume getId volume getDeviceId catch Exception ex StringBuilder message new StringBuilder message append volume getUuid message append message append cmd getVirtualMachineId message append message append ex getMessage if s_logger isDebugEnabled
protected void expungeVolumesInPrimaryStorageIfNeeded VolumeVO volume throws InterruptedException ExecutionException VolumeInfo volOnPrimary volFactory getVolume volume getId DataStoreRole Primary if volOnPrimary null
protected void expungeVolumesInSecondaryStorageIfNeeded VolumeVO volume throws InterruptedException ExecutionException VolumeInfo volOnSecondary volFactory getVolume volume getId DataStoreRole Image if volOnSecondary null
Override ActionEvent eventType EventTypes EVENT_VOLUME_DESTROY eventDescription public Volume destroyVolume long volumeId Account caller boolean expunge boolean forceExpunge VolumeVO volume retrieveAndValidateVolume volumeId caller if expunge final Long userId caller getAccountId if forceExpunge _accountMgr isAdmin userId AllowUserExpungeRecoverVolume valueIn userId throw new PermissionDeniedException else if volume getState Volume State Allocated volume getState Volume State Uploaded throw new InvalidParameterValueException destroyVolumeIfPossible volume if expunge if volume getState Volume State Allocated _volsDao remove volume getId try stateTransitTo volume Volume Event DestroyRequested catch NoTransitionException e
if volume null throw new InvalidParameterValueException volume if _accountMgr isAdmin userId AllowUserExpungeRecoverVolume valueIn userId throw new PermissionDeniedException _accountMgr checkAccess caller null true volume if volume getState Volume State Destroy throw new InvalidParameterValueException try _resourceLimitMgr checkResourceLimit _accountMgr getAccount volume getAccountId ResourceType primary_storage volume isDisplayVolume volume getSize catch ResourceAllocationException e s_logger error e throw new InvalidParameterValueException e getMessage try stateTransitTo volume Volume Event RecoverRequested catch NoTransitionException e
HypervisorType volumeToAttachHyperType _volsDao getHypervisorType volumeToAttach getId VolumeInfo newVolumeOnPrimaryStorage volumeToAttach StoragePoolVO destPrimaryStorage null if exstingVolumeOfVm null exstingVolumeOfVm getState equals Volume State Allocated destPrimaryStorage _storagePoolDao findById exstingVolumeOfVm getPoolId boolean volumeOnSecondary volumeToAttach getState Volume State Uploaded if destPrimaryStorage null volumeToAttach getState Volume State Allocated volumeOnSecondary try newVolumeOnPrimaryStorage _volumeMgr createVolumeOnPrimaryStorage vm volumeToAttach rootDiskHyperType destPrimaryStorage catch NoTransitionException e s_logger debug e throw new CloudRuntimeException e newVolumeOnPrimaryStorage volFactory getVolume newVolumeOnPrimaryStorage getId boolean moveVolumeNeeded needMoveVolume exstingVolumeOfVm newVolumeOnPrimaryStorage if moveVolumeNeeded
if exstingVolumeOfVm null exstingVolumeOfVm getState equals Volume State Allocated destPrimaryStorage _storagePoolDao findById exstingVolumeOfVm getPoolId boolean volumeOnSecondary volumeToAttach getState Volume State Uploaded if destPrimaryStorage null volumeToAttach getState Volume State Allocated volumeOnSecondary try newVolumeOnPrimaryStorage _volumeMgr createVolumeOnPrimaryStorage vm volumeToAttach rootDiskHyperType destPrimaryStorage catch NoTransitionException e s_logger debug e throw new CloudRuntimeException e newVolumeOnPrimaryStorage volFactory getVolume newVolumeOnPrimaryStorage getId boolean moveVolumeNeeded needMoveVolume exstingVolumeOfVm newVolumeOnPrimaryStorage if moveVolumeNeeded PrimaryDataStoreInfo primaryStore PrimaryDataStoreInfo newVolumeOnPrimaryStorage getDataStore if primaryStore isLocal throw new CloudRuntimeException volumeToAttach getName vm getDisplayName
if diskOffering isUseLocalStorage throw new InvalidParameterValueException diskOffering getName List VMSnapshotVO vmSnapshots _vmSnapshotDao findByVm vmId if vmSnapshots size throw new InvalidParameterValueException if vm getBackupOfferingId null vm getBackupVolumeList size throw new InvalidParameterValueException _accountMgr checkAccess caller null true volumeToAttach vm if Volume State Allocated equals volumeToAttach getState Volume State Ready equals volumeToAttach getState Volume State Uploaded equals volumeToAttach getState throw new InvalidParameterValueException Account owner _accountDao findById volumeToAttach getAccountId if volumeToAttach getState Volume State Allocated volumeToAttach getState Volume State Ready try _resourceLimitMgr checkResourceLimit owner ResourceType primary_storage volumeToAttach getSize catch ResourceAllocationException e
vmId cmmd getVirtualMachineId _accountMgr checkAccess caller null true volume if vmId null throw new InvalidParameterValueException UserVmVO vm _userVmDao findById vmId if vm getState State Running vm getState State Stopped vm getState State Destroyed throw new InvalidParameterValueException if volume getVolumeType Volume Type ROOT volume getVolumeType Volume Type DATADISK throw new InvalidParameterValueException Volume Type DATADISK toString Volume Type ROOT toString if volume getVolumeType Volume Type ROOT validateRootVolumeDetachAttach volume vm List VMSnapshotVO vmSnapshots _vmSnapshotDao findByVm vmId if vmSnapshots size throw new InvalidParameterValueException if vm getBackupOfferingId null vm getBackupVolumeList size
DB protected Volume liveMigrateVolume Volume volume StoragePool destPool throws StorageUnavailableException VolumeInfo vol volFactory getVolume volume getId DataStore dataStoreTarget dataStoreMgr getDataStore destPool getId DataStoreRole Primary AsyncCallFuture VolumeApiResult future volService migrateVolume vol dataStoreTarget try VolumeApiResult result future get if result isFailed
String mode cmd getMode Account account CallContext current getCallingAccount if _accountMgr isRootAdmin account getId ApiDBUtils isExtractionDisabled throw new PermissionDeniedException VolumeVO volume _volsDao findById volumeId if volume null InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject volumeId toString throw ex _accountMgr checkAccess account null true volume if _dcDao findById zoneId null throw new InvalidParameterValueException if volume getPoolId null throw new InvalidParameterValueException if volume getInstanceId null ApiDBUtils findVMInstanceById volume getInstanceId getState State Stopped
private String orchestrateExtractVolume long volumeId long zoneId VolumeVO volume _volsDao findById volumeId if volume null volume getState Volume State Ready throw new InvalidParameterValueException ImageStoreEntity secStore ImageStoreEntity dataStoreMgr getImageStoreWithFreeCapacity zoneId if secStore null throw new InvalidParameterValueException String format zoneId String value _configDao getValue Config CopyVolumeWait toString NumbersUtil parseInt value Integer parseInt Config CopyVolumeWait getDefaultValue VolumeInfo srcVol volFactory getVolume volumeId AsyncCallFuture VolumeApiResult cvAnswer volService copyVolume srcVol secStore VolumeApiResult cvResult null try cvResult cvAnswer get catch InterruptedException e1
throw new InvalidParameterValueException ImageStoreEntity secStore ImageStoreEntity dataStoreMgr getImageStoreWithFreeCapacity zoneId if secStore null throw new InvalidParameterValueException String format zoneId String value _configDao getValue Config CopyVolumeWait toString NumbersUtil parseInt value Integer parseInt Config CopyVolumeWait getDefaultValue VolumeInfo srcVol volFactory getVolume volumeId AsyncCallFuture VolumeApiResult cvAnswer volService copyVolume srcVol secStore VolumeApiResult cvResult null try cvResult cvAnswer get catch InterruptedException e1 s_logger debug e1 throw new CloudRuntimeException e1 catch ExecutionException e1
DataTO volTO volFactory getVolume volumeToAttach getId getTO deviceId getDeviceId vm deviceId DiskTO disk storageMgr getDiskWithThrottling volTO volumeToAttach getVolumeType deviceId volumeToAttach getPath vm getServiceOfferingId volumeToAttach getDiskOfferingId AttachCommand cmd new AttachCommand disk vm getInstanceName ChapInfo chapInfo volService getChapInfo volFactory getVolume volumeToAttach getId dataStore Map String String details new HashMap String String disk setDetails details details put DiskTO MANAGED String valueOf volumeToAttachStoragePool isManaged details put DiskTO STORAGE_HOST volumeToAttachStoragePool getHostAddress details put DiskTO STORAGE_PORT String valueOf volumeToAttachStoragePool getPort details put DiskTO VOLUME_SIZE String valueOf volumeToAttach getSize details put DiskTO IQN volumeToAttach get_iScsiName details put DiskTO MOUNT_POINT volumeToAttach get_iScsiName details put DiskTO PROTOCOL_TYPE volumeToAttach getPoolType null volumeToAttach getPoolType toString null if chapInfo null
final Account callingAccount context getCallingAccount final VMInstanceVO vm _vmInstanceDao findById vmId VmWorkJobVO workJob new VmWorkJobVO context getContextId workJob setDispatcher VmWorkConstants VM_WORK_JOB_DISPATCHER workJob setCmd VmWorkAttachVolume class getName workJob setAccountId callingAccount getId workJob setUserId callingUser getId workJob setStep VmWorkJobVO Step Starting workJob setVmType VirtualMachine Type Instance workJob setVmInstanceId vm getId workJob setRelated AsyncJobExecutionContext getOriginJobId VmWorkAttachVolume workInfo new VmWorkAttachVolume callingUser getId callingAccount getId vm getId VolumeApiServiceImpl VM_WORK_JOB_HANDLER volumeId deviceId workJob setCmdInfo VmWorkSerializer serialize workInfo _jobMgr submitAsyncJob workJob VmWorkConstants VM_WORK_QUEUE vm getId AsyncJobVO jobVo _jobMgr getAsyncJob workJob getId
Override public void processConnect Host agent StartupCommand cmd boolean forRebalance throws ConnectionException if cmd StartupRoutingCommand List HypervisorType hypers _resourceMgr listAvailHypervisorInZone agent getId agent getDataCenterId HypervisorType hostHyper agent getHypervisorType if hypers contains hostHyper return _imageSrv handleSysTemplateDownload hostHyper agent getDataCenterId _imageSrv associateCrosszoneTemplatesToZone agent getDataCenterId else if cmd StartupSecondaryStorageCommand try List DataStore imageStores _storeMgr getImageStoresByScope new ZoneScope agent getDataCenterId for DataStore store imageStores _volumeSrv handleVolumeSync store _imageSrv handleTemplateSync store catch Exception e
List StoragePoolVO zoneStoragePoolsByTags _poolDao findZoneWideStoragePoolsByTags host getDataCenterId null List StoragePoolVO zoneStoragePoolsByHypervisor _poolDao findZoneWideStoragePoolsByHypervisor host getDataCenterId scCmd getHypervisorType zoneStoragePoolsByTags retainAll zoneStoragePoolsByHypervisor pools addAll zoneStoragePoolsByTags List StoragePoolVO zoneStoragePoolsByAnyHypervisor _poolDao findZoneWideStoragePoolsByHypervisor host getDataCenterId HypervisorType Any pools addAll zoneStoragePoolsByAnyHypervisor for StoragePoolVO pool pools if pool getStatus StoragePoolStatus Up continue if pool isShared continue if pool getPoolType StoragePoolType OCFS2 _ocfs2Mgr prepareNodes pool getClusterId throw new ConnectionException true pool getId Long hostId host getId if s_logger isDebugEnabled
if volume getState Volume State Ready throw new InvalidParameterValueException Long instanceId volume getInstanceId if instanceId null UserVmVO vm _vmDao findById instanceId if vm getState State Stopped vm getState State Shutdown throw new InvalidParameterValueException List VMSnapshotVO vmSnapshots _vmSnapshotDao findByVm instanceId if vmSnapshots size throw new InvalidParameterValueException DataStoreRole dataStoreRole getDataStoreRole snapshot _snapshotStoreDao dataStoreMgr SnapshotInfo snapshotInfo snapshotFactory getSnapshot snapshotId dataStoreRole if snapshotInfo null throw new CloudRuntimeException snapshotId SnapshotStrategy snapshotStrategy _storageStrategyFactory getSnapshotStrategy snapshot SnapshotOperation REVERT
throw new InvalidParameterValueException if volume getState Volume State Ready throw new InvalidParameterValueException _accountMgr checkAccess CallContext current getCallingAccount null true volume SnapshotInfo snapshot snapshotFactory getSnapshot snapshotId DataStoreRole Primary if snapshot null s_logger debug throw new CloudRuntimeException try postCreateSnapshot volumeId snapshot getId policyId SnapshotVO freshSnapshot _snapshotDao findById snapshot getId if freshSnapshot null UsageEventUtils publishUsageEvent EventTypes EVENT_SNAPSHOT_CREATE snapshot getAccountId snapshot getDataCenterId snapshotId snapshot getName null null volume getSize snapshot getClass getName snapshot getUuid _resourceLimitMgr incrementResourceCount snapshotOwner getId ResourceType snapshot catch Exception e
if snapshotStrategy null s_logger error snapshotId return false DataStoreRole dataStoreRole getDataStoreRole snapshotCheck _snapshotStoreDao dataStoreMgr SnapshotDataStoreVO snapshotStoreRef _snapshotStoreDao findBySnapshot snapshotId dataStoreRole try boolean result snapshotStrategy deleteSnapshot snapshotId if result if snapshotCheck getState Snapshot State BackedUp UsageEventUtils publishUsageEvent EventTypes EVENT_SNAPSHOT_DELETE snapshotCheck getAccountId snapshotCheck getDataCenterId snapshotId snapshotCheck getName null null 0L snapshotCheck getClass getName snapshotCheck getUuid if snapshotCheck getState Snapshot State Error snapshotCheck getState Snapshot State Destroyed _resourceLimitMgr decrementResourceCount snapshotCheck getAccountId ResourceType snapshot if snapshotCheck getState Snapshot State BackedUp if snapshotStoreRef null _resourceLimitMgr decrementResourceCount snapshotCheck getAccountId ResourceType secondary_storage new Long snapshotStoreRef getPhysicalSize
for VolumeVO volume volumes if volume getPoolId null continue Long volumeId volume getId Long dcId volume getDataCenterId if _snapshotDao listByVolumeIdIncludingRemoved volumeId isEmpty continue List DataStore ssHosts dataStoreMgr getImageStoresByScope new ZoneScope dcId for DataStore ssHost ssHosts String snapshotDir TemplateConstants DEFAULT_SNAPSHOT_ROOT_DIR accountId volumeId DeleteSnapshotsDirCommand cmd new DeleteSnapshotsDirCommand ssHost getTO snapshotDir EndPoint ep _epSelector select ssHost Answer answer null if ep null String errMsg
Long dcId volume getDataCenterId if _snapshotDao listByVolumeIdIncludingRemoved volumeId isEmpty continue List DataStore ssHosts dataStoreMgr getImageStoresByScope new ZoneScope dcId for DataStore ssHost ssHosts String snapshotDir TemplateConstants DEFAULT_SNAPSHOT_ROOT_DIR accountId volumeId DeleteSnapshotsDirCommand cmd new DeleteSnapshotsDirCommand ssHost getTO snapshotDir EndPoint ep _epSelector select ssHost Answer answer null if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd
for DataStore ssHost ssHosts String snapshotDir TemplateConstants DEFAULT_SNAPSHOT_ROOT_DIR accountId volumeId DeleteSnapshotsDirCommand cmd new DeleteSnapshotsDirCommand ssHost getTO snapshotDir EndPoint ep _epSelector select ssHost Answer answer null if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if answer null answer getResult s_logger debug volumeId accountId else success false
if ep null String errMsg s_logger error errMsg answer new Answer cmd false errMsg else answer ep sendMessage cmd if answer null answer getResult s_logger debug volumeId accountId else success false if answer null s_logger warn volumeId ssHost getUri s_logger error answer getDetails List SnapshotVO snapshots listSnapsforVolume volumeId for SnapshotVO snapshot snapshots
CreateSnapshotPayload payload CreateSnapshotPayload volume getpayload updateSnapshotPayload volume getPoolId payload Long snapshotId payload getSnapshotId Account snapshotOwner payload getAccount SnapshotInfo snapshot snapshotFactory getSnapshot snapshotId volume getDataStore snapshot addPayload payload try SnapshotStrategy snapshotStrategy _storageStrategyFactory getSnapshotStrategy snapshot SnapshotOperation TAKE if snapshotStrategy null throw new CloudRuntimeException snapshotId SnapshotInfo snapshotOnPrimary snapshotStrategy takeSnapshot snapshot boolean backupSnapToSecondary BackupSnapshotAfterTakingSnapshot value null BackupSnapshotAfterTakingSnapshot value if backupSnapToSecondary backupSnapshotToSecondary payload getAsyncBackup snapshotStrategy snapshotOnPrimary else
DataStoreRole dataStoreRole getDataStoreRole snapshot _snapshotStoreDao dataStoreMgr SnapshotDataStoreVO snapshotStoreRef _snapshotStoreDao findBySnapshot snapshotId dataStoreRole if snapshotStoreRef null snapshotStoreRef _snapshotStoreDao findBySnapshot snapshotId DataStoreRole Primary if snapshotStoreRef null throw new CloudRuntimeException UsageEventUtils publishUsageEvent EventTypes EVENT_SNAPSHOT_CREATE snapshot getAccountId snapshot getDataCenterId snapshotId snapshot getName null null snapshotStoreRef getPhysicalSize volume getSize snapshot getClass getName snapshot getUuid _resourceLimitMgr decrementResourceCount snapshotOwner getId ResourceType secondary_storage new Long volume getSize snapshotStoreRef getPhysicalSize catch Exception e s_logger debug e catch CloudRuntimeException cre if s_logger isDebugEnabled s_logger debug cre getLocalizedMessage _resourceLimitMgr decrementResourceCount snapshotOwner getId ResourceType snapshot _resourceLimitMgr decrementResourceCount snapshotOwner getId ResourceType secondary_storage new Long volume getSize
Override public boolean start List SnapshotVO snapshots _snapshotDao listAllByStatus Snapshot State Destroying for SnapshotVO snapshotVO snapshots try if deleteSnapshot snapshotVO getId
private Date getNextScheduledTime final long policyId final Date currentTimestamp final SnapshotPolicyVO policy _snapshotPolicyDao findById policyId Date nextTimestamp null if policy null final short intervalType policy getInterval final IntervalType type DateUtil getIntervalType intervalType final String schedule policy getSchedule final String timezone policy getTimezone nextTimestamp DateUtil getNextRunTime type schedule timezone currentTimestamp final String currentTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE currentTimestamp final String nextScheduledTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE nextTimestamp
DB protected void scheduleSnapshots String displayTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE _currentTimestamp
DB protected void scheduleSnapshots String displayTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE _currentTimestamp s_logger debug displayTime final List SnapshotScheduleVO snapshotsToBeExecuted _snapshotScheduleDao getSchedulesToExecute _currentTimestamp
s_logger debug displayTime final List SnapshotScheduleVO snapshotsToBeExecuted _snapshotScheduleDao getSchedulesToExecute _currentTimestamp s_logger debug snapshotsToBeExecuted size displayTime for final SnapshotScheduleVO snapshotToBeExecuted snapshotsToBeExecuted SnapshotScheduleVO tmpSnapshotScheduleVO null final long snapshotScheId snapshotToBeExecuted getId final long policyId snapshotToBeExecuted getPolicyId final long volumeId snapshotToBeExecuted getVolumeId try final VolumeVO volume _volsDao findById volumeId if volume getPoolId null continue Account volAcct _acctDao findById volume getAccountId if volAcct null volAcct getState Account State disabled if s_logger isDebugEnabled
final long volumeId snapshotToBeExecuted getVolumeId try final VolumeVO volume _volsDao findById volumeId if volume getPoolId null continue Account volAcct _acctDao findById volume getAccountId if volAcct null volAcct getState Account State disabled if s_logger isDebugEnabled s_logger debug volume getUuid continue if _snapshotPolicyDao findById policyId null _snapshotScheduleDao remove snapshotToBeExecuted getId if s_logger isDebugEnabled final Date scheduledTimestamp snapshotToBeExecuted getScheduledTimestamp displayTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE scheduledTimestamp
Override public String handleAnswer UploadAnswer answer if s_logger isDebugEnabled
Override public void extractVolume UploadVO uploadVolumeObj DataStore secStore VolumeVO volume String url Long dataCenterId String installPath long eventId long asyncJobId AsyncJobManager asyncMgr uploadVolumeObj setUploadState Upload Status NOT_UPLOADED _uploadDao update uploadVolumeObj getId uploadVolumeObj start UploadCommand ucmd new UploadCommand url volume getId volume getSize installPath Type VOLUME UploadListener ul new UploadListener secStore _timer _uploadDao uploadVolumeObj this ucmd volume getAccountId volume getName Type VOLUME eventId asyncJobId asyncMgr _listenerMap put uploadVolumeObj ul try EndPoint ep _epSelector select secStore if ep null String errMsg
DataStore secStore storeMgr getImageStoreWithFreeCapacity dataCenterId if secStore null s_logger error return null UploadVO uploadTemplateObj new UploadVO secStore getId template getId new Date Upload Status NOT_UPLOADED type url Mode FTP_UPLOAD _uploadDao persist uploadTemplateObj if vmTemplateHost null start UploadCommand ucmd new UploadCommand template url vmTemplateHost getInstallPath vmTemplateHost getSize UploadListener ul new UploadListener secStore _timer _uploadDao uploadTemplateObj this ucmd template getAccountId template getName type eventId asyncJobId asyncMgr _listenerMap put uploadTemplateObj ul try EndPoint ep _epSelector select secStore if ep null String errMsg
Override public UploadVO createEntityDownloadURL VMTemplateVO template TemplateDataStoreVO vmTemplateHost Long dataCenterId long eventId String errorString boolean success false Type type template getFormat ImageFormat ISO Type ISO Type TEMPLATE DataStore store storeMgr getDataStore vmTemplateHost getDataStoreId DataStoreRole Image EndPoint ep _epSelector select store if ep null String errMsg
DataStore secStore storeMgr getDataStore ApiDBUtils findUploadById uploadId getDataStoreId DataStoreRole Image EndPoint ep _epSelector select secStore if ep null errorString secStore getName throw new CloudRuntimeException errorString CreateEntityDownloadURLCommand cmd new CreateEntityDownloadURLCommand ImageStoreEntity secStore getMountPoint path uuid null Answer ans ep sendMessage cmd if ans null ans getResult errorString type entityId ans null ans getDetails s_logger warn errorString throw new CloudRuntimeException errorString List SecondaryStorageVmVO ssVms _secStorageVmDao getSecStorageVmListInStates SecondaryStorageVm Role templateProcessor dataCenterId State Running if ssVms size SecondaryStorageVmVO ssVm ssVms get if ssVm getPublicIpAddress null
Override DB ActionEvent eventType EventTypes EVENT_TAGS_DELETE eventDescription public boolean deleteTags List String resourceIds ResourceObjectType resourceType Map String String tags Account caller CallContext current getCallingAccount if s_logger isDebugEnabled
if imageStores null imageStores size throw new CloudRuntimeException profile getTemplate Set Long zoneSet new HashSet Long Collections shuffle imageStores for DataStore imageStore imageStores Long zoneId imageStore getScope getScopeId if zoneId null DataCenterVO zone _dcDao findById zoneId if zone null s_logger warn zoneId imageStore getId continue if Grouping AllocationState Disabled zone getAllocationState s_logger info zoneId imageStore getId continue if _statsCollector imageStoreHasEnoughCapacity imageStore
Long zoneId null if profile getZoneIdList null zoneId profile getZoneIdList get List DataStore imageStores storeMgr getImageStoresByScope new ZoneScope zoneId if imageStores null imageStores size throw new CloudRuntimeException profile getTemplate List TemplateOrVolumePostUploadCommand payloads new LinkedList Set Long zoneSet new HashSet Long Collections shuffle imageStores for DataStore imageStore imageStores Long zoneId_is imageStore getScope getScopeId if zoneId null DataCenterVO zone _dcDao findById zoneId_is if zone null s_logger warn zoneId_is imageStore getId continue
Override DB public boolean delete TemplateProfile profile boolean success false VMTemplateVO template profile getTemplate Account account _accountDao findByIdIncludingRemoved template getAccountId if profile getZoneIdList null profile getZoneIdList size throw new CloudRuntimeException Long zoneId null if profile getZoneIdList null zoneId profile getZoneIdList get List DataStore imageStores templateMgr getImageStoreByTemplate template getId zoneId if imageStores null imageStores size success true
Account account _accountDao findByIdIncludingRemoved template getAccountId if profile getZoneIdList null profile getZoneIdList size throw new CloudRuntimeException Long zoneId null if profile getZoneIdList null zoneId profile getZoneIdList get List DataStore imageStores templateMgr getImageStoreByTemplate template getId zoneId if imageStores null imageStores size success true s_logger info template getName else for DataStore store imageStores long storeId store getId List TemplateDataStoreVO templateStores _tmpltStoreDao listByTemplateStore template getId storeId for TemplateDataStoreVO templateStore templateStores if templateStore getDownloadState Status DOWNLOAD_IN_PROGRESS String errorMsg
if templateStore getDownloadState Status DOWNLOAD_IN_PROGRESS String errorMsg s_logger debug template getName store getName throw new CloudRuntimeException errorMsg String eventType if template getFormat equals ImageFormat ISO eventType EventTypes EVENT_ISO_DELETE else eventType EventTypes EVENT_TEMPLATE_DELETE for DataStore imageStore imageStores Long sZoneId ImageStoreEntity imageStore getDataCenterId if sZoneId null UsageEventUtils publishUsageEvent eventType template getAccountId sZoneId template getId null VirtualMachineTemplate class getName template getUuid boolean dataDiskDeletetionResult true List VMTemplateVO dataDiskTemplates templateDao listByParentTemplatetId template getId
s_logger debug template getName store getName throw new CloudRuntimeException errorMsg String eventType if template getFormat equals ImageFormat ISO eventType EventTypes EVENT_ISO_DELETE else eventType EventTypes EVENT_TEMPLATE_DELETE for DataStore imageStore imageStores Long sZoneId ImageStoreEntity imageStore getDataCenterId if sZoneId null UsageEventUtils publishUsageEvent eventType template getAccountId sZoneId template getId null VirtualMachineTemplate class getName template getUuid boolean dataDiskDeletetionResult true List VMTemplateVO dataDiskTemplates templateDao listByParentTemplatetId template getId if dataDiskTemplates null dataDiskTemplates size s_logger info template getId
for VMTemplateVO dataDiskTemplate dataDiskTemplates s_logger info dataDiskTemplate getId imageStore getName AsyncCallFuture TemplateApiResult future imageService deleteTemplateAsync imageFactory getTemplate dataDiskTemplate getId imageStore try TemplateApiResult result future get dataDiskDeletetionResult result isSuccess if dataDiskDeletetionResult s_logger warn dataDiskTemplate imageStore getName result getResult break List VMTemplateZoneVO templateZones templateZoneDao listByZoneTemplate sZoneId dataDiskTemplate getId if templateZones null for VMTemplateZoneVO templateZone templateZones templateZoneDao remove templateZone getId List DataStore iStores templateMgr getImageStoreByTemplate dataDiskTemplate getId null if iStores null iStores size
templateZoneDao remove templateZone getId List DataStore iStores templateMgr getImageStoreByTemplate dataDiskTemplate getId null if iStores null iStores size dataDiskTemplate setState VirtualMachineTemplate State Inactive _tmpltDao update dataDiskTemplate getId dataDiskTemplate _resourceLimitMgr recalculateResourceCount dataDiskTemplate getAccountId account getDomainId ResourceType secondary_storage getOrdinal catch Exception e s_logger debug e throw new CloudRuntimeException e if dataDiskDeletetionResult s_logger info template getId imageStore getName AsyncCallFuture TemplateApiResult future imageService deleteTemplateAsync imageFactory getTemplate template getId imageStore try TemplateApiResult result future get success result isSuccess
private void prepareTemplateInOneStoragePool final VMTemplateVO template final StoragePoolVO pool
Override DB public VMTemplateStoragePoolVO prepareTemplateForCreate VMTemplateVO templ StoragePool pool VMTemplateVO template _tmpltDao findById templ getId true long poolId pool getId long templateId template getId VMTemplateStoragePoolVO templateStoragePoolRef null TemplateDataStoreVO templateStoreRef null templateStoragePoolRef _tmpltPoolDao findByPoolTemplate poolId templateId if templateStoragePoolRef null templateStoragePoolRef setMarkedForGC false _tmpltPoolDao update templateStoragePoolRef getId templateStoragePoolRef if templateStoragePoolRef getDownloadState Status DOWNLOADED if s_logger isDebugEnabled
templateStoragePoolRef setMarkedForGC false _tmpltPoolDao update templateStoragePoolRef getId templateStoragePoolRef if templateStoragePoolRef getDownloadState Status DOWNLOADED if s_logger isDebugEnabled s_logger debug templateId poolId return templateStoragePoolRef templateStoreRef _tmplStoreDao findByTemplateZoneDownloadStatus templateId pool getDataCenterId VMTemplateStorageResourceAssoc Status DOWNLOADED if templateStoreRef null s_logger error return null List StoragePoolHostVO vos _poolHostDao listByHostStatus poolId com cloud host Status Up if vos null vos isEmpty throw new CloudRuntimeException templateId poolId if templateStoragePoolRef null if s_logger isDebugEnabled
templateStoreRef _tmplStoreDao findByTemplateZoneDownloadStatus templateId pool getDataCenterId VMTemplateStorageResourceAssoc Status DOWNLOADED if templateStoreRef null s_logger error return null List StoragePoolHostVO vos _poolHostDao listByHostStatus poolId com cloud host Status Up if vos null vos isEmpty throw new CloudRuntimeException templateId poolId if templateStoragePoolRef null if s_logger isDebugEnabled s_logger debug templateId poolId DataStore srcSecStore _dataStoreMgr getDataStore templateStoreRef getDataStoreId DataStoreRole Image TemplateInfo srcTemplate _tmplFactory getTemplate templateId srcSecStore AsyncCallFuture TemplateApiResult future _tmpltSvr prepareTemplateOnPrimary srcTemplate pool try TemplateApiResult result future get
s_logger error return null List StoragePoolHostVO vos _poolHostDao listByHostStatus poolId com cloud host Status Up if vos null vos isEmpty throw new CloudRuntimeException templateId poolId if templateStoragePoolRef null if s_logger isDebugEnabled s_logger debug templateId poolId DataStore srcSecStore _dataStoreMgr getDataStore templateStoreRef getDataStoreId DataStoreRole Image TemplateInfo srcTemplate _tmplFactory getTemplate templateId srcSecStore AsyncCallFuture TemplateApiResult future _tmpltSvr prepareTemplateOnPrimary srcTemplate pool try TemplateApiResult result future get if result isFailed s_logger debug result getResult
Override public String getChecksum DataStore store String templatePath String algorithm EndPoint ep _epSelector select store ComputeChecksumCommand cmd new ComputeChecksumCommand store getTO templatePath algorithm Answer answer null if ep null String errMsg
String copyEventType if template getFormat equals ImageFormat ISO copyEventType EventTypes EVENT_ISO_COPY else copyEventType EventTypes EVENT_TEMPLATE_COPY TemplateInfo srcTemplate _tmplFactory getTemplate template getId srcSecStore for DataStore dstSecStore dstSecStores TemplateDataStoreVO dstTmpltStore _tmplStoreDao findByStoreTemplate dstSecStore getId tmpltId if dstTmpltStore null dstTmpltStore getDownloadState Status DOWNLOADED return true if dstTmpltStore null dstTmpltStore getDownloadState Status DOWNLOAD_IN_PROGRESS _tmplStoreDao removeByTemplateStore tmpltId dstSecStore getId AsyncCallFuture TemplateApiResult future _tmpltSvr copyTemplate srcTemplate dstSecStore try TemplateApiResult result future get
for DataStore dstSecStore dstSecStores TemplateDataStoreVO dstTmpltStore _tmplStoreDao findByStoreTemplate dstSecStore getId tmpltId if dstTmpltStore null dstTmpltStore getDownloadState Status DOWNLOADED return true if dstTmpltStore null dstTmpltStore getDownloadState Status DOWNLOAD_IN_PROGRESS _tmplStoreDao removeByTemplateStore tmpltId dstSecStore getId AsyncCallFuture TemplateApiResult future _tmpltSvr copyTemplate srcTemplate dstSecStore try TemplateApiResult result future get if result isFailed s_logger debug dstSecStore getName result getResult continue _tmpltDao addTemplateToZone template dstZoneId if account getId Account ACCOUNT_ID_SYSTEM UsageEventUtils publishUsageEvent copyEventType account getId dstZoneId tmpltId null null null srcTmpltStore getPhysicalSize srcTmpltStore getSize template getClass getName template getUuid
_tmplStoreDao removeByTemplateStore tmpltId dstSecStore getId AsyncCallFuture TemplateApiResult future _tmpltSvr copyTemplate srcTemplate dstSecStore try TemplateApiResult result future get if result isFailed s_logger debug dstSecStore getName result getResult continue _tmpltDao addTemplateToZone template dstZoneId if account getId Account ACCOUNT_ID_SYSTEM UsageEventUtils publishUsageEvent copyEventType account getId dstZoneId tmpltId null null null srcTmpltStore getPhysicalSize srcTmpltStore getSize template getClass getName template getUuid List VMTemplateVO dataDiskTemplates _tmpltDao listByParentTemplatetId template getId if dataDiskTemplates null dataDiskTemplates isEmpty for VMTemplateVO dataDiskTemplate dataDiskTemplates s_logger debug dataDiskTemplates size template getId dstSecStore getName TemplateInfo srcDataDiskTemplate _tmplFactory getTemplate dataDiskTemplate getId srcSecStore
if result isFailed s_logger debug dstSecStore getName result getResult continue _tmpltDao addTemplateToZone template dstZoneId if account getId Account ACCOUNT_ID_SYSTEM UsageEventUtils publishUsageEvent copyEventType account getId dstZoneId tmpltId null null null srcTmpltStore getPhysicalSize srcTmpltStore getSize template getClass getName template getUuid List VMTemplateVO dataDiskTemplates _tmpltDao listByParentTemplatetId template getId if dataDiskTemplates null dataDiskTemplates isEmpty for VMTemplateVO dataDiskTemplate dataDiskTemplates s_logger debug dataDiskTemplates size template getId dstSecStore getName TemplateInfo srcDataDiskTemplate _tmplFactory getTemplate dataDiskTemplate getId srcSecStore AsyncCallFuture TemplateApiResult dataDiskCopyFuture _tmpltSvr copyTemplate srcDataDiskTemplate dstSecStore try TemplateApiResult dataDiskCopyResult dataDiskCopyFuture get if dataDiskCopyResult isFailed
continue _tmpltDao addTemplateToZone template dstZoneId if account getId Account ACCOUNT_ID_SYSTEM UsageEventUtils publishUsageEvent copyEventType account getId dstZoneId tmpltId null null null srcTmpltStore getPhysicalSize srcTmpltStore getSize template getClass getName template getUuid List VMTemplateVO dataDiskTemplates _tmpltDao listByParentTemplatetId template getId if dataDiskTemplates null dataDiskTemplates isEmpty for VMTemplateVO dataDiskTemplate dataDiskTemplates s_logger debug dataDiskTemplates size template getId dstSecStore getName TemplateInfo srcDataDiskTemplate _tmplFactory getTemplate dataDiskTemplate getId srcSecStore AsyncCallFuture TemplateApiResult dataDiskCopyFuture _tmpltSvr copyTemplate srcDataDiskTemplate dstSecStore try TemplateApiResult dataDiskCopyResult dataDiskCopyFuture get if dataDiskCopyResult isFailed s_logger error srcDataDiskTemplate getId dstSecStore getName dataDiskCopyResult getResult continue
dataCenterVOs put destZoneId dstZone _accountMgr checkAccess caller AccessType OperateEntry true template List String failedZones new ArrayList boolean success false if template getHypervisorType HypervisorType BareMetal if template isCrossZones s_logger debug templateId return template for Long destZoneId destZoneIds if addTemplateToZone template destZoneId sourceZoneId failedZones add dataCenterVOs get destZoneId getName else DataStore srcSecStore null if sourceZoneId null srcSecStore getImageStore sourceZoneId templateId
if template getHypervisorType HypervisorType BareMetal if template isCrossZones s_logger debug templateId return template for Long destZoneId destZoneIds if addTemplateToZone template destZoneId sourceZoneId failedZones add dataCenterVOs get destZoneId getName else DataStore srcSecStore null if sourceZoneId null srcSecStore getImageStore sourceZoneId templateId else srcSecStore getImageStore templateId if srcSecStore null throw new InvalidParameterValueException templateId
Override DB public void evictTemplateFromStoragePool VMTemplateStoragePoolVO templatePoolVO VMTemplateStoragePoolVO templatePoolRef _tmpltPoolDao acquireInLockTable templatePoolVO getId if templatePoolRef null
if templatePoolRef null s_logger debug templatePoolVO getId return PrimaryDataStore pool PrimaryDataStore _dataStoreMgr getPrimaryDataStore templatePoolVO getPoolId TemplateInfo template _tmplFactory getTemplate templatePoolRef getTemplateId pool try if s_logger isDebugEnabled s_logger debug templatePoolVO if pool isManaged AsyncCallFuture TemplateApiResult future _tmpltSvr deleteTemplateOnPrimary template pool TemplateApiResult result future get if result isFailed s_logger debug template getId pool getId else if _tmpltPoolDao remove templatePoolVO getId
try if s_logger isDebugEnabled s_logger debug templatePoolVO if pool isManaged AsyncCallFuture TemplateApiResult future _tmpltSvr deleteTemplateOnPrimary template pool TemplateApiResult result future get if result isFailed s_logger debug template getId pool getId else if _tmpltPoolDao remove templatePoolVO getId s_logger debug template getName pool getName else DestroyCommand cmd new DestroyCommand pool templatePoolVO Answer answer _storageMgr sendToPool pool cmd if answer null answer getResult
s_logger debug templatePoolVO if pool isManaged AsyncCallFuture TemplateApiResult future _tmpltSvr deleteTemplateOnPrimary template pool TemplateApiResult result future get if result isFailed s_logger debug template getId pool getId else if _tmpltPoolDao remove templatePoolVO getId s_logger debug template getName pool getName else DestroyCommand cmd new DestroyCommand pool templatePoolVO Answer answer _storageMgr sendToPool pool cmd if answer null answer getResult if _tmpltPoolDao remove templatePoolVO getId s_logger debug template getName pool getName
if pool isManaged AsyncCallFuture TemplateApiResult future _tmpltSvr deleteTemplateOnPrimary template pool TemplateApiResult result future get if result isFailed s_logger debug template getId pool getId else if _tmpltPoolDao remove templatePoolVO getId s_logger debug template getName pool getName else DestroyCommand cmd new DestroyCommand pool templatePoolVO Answer answer _storageMgr sendToPool pool cmd if answer null answer getResult if _tmpltPoolDao remove templatePoolVO getId s_logger debug template getName pool getName else
Override public boolean templateIsDeleteable VMTemplateHostVO templateHostRef VMTemplateVO template _tmpltDao findByIdIncludingRemoved templateHostRef getTemplateId long templateId template getId HostVO secondaryStorageHost _hostDao findById templateHostRef getHostId long zoneId secondaryStorageHost getDataCenterId DataCenterVO zone _dcDao findById zoneId List VMInstanceVO nonExpungedVms _vmInstanceDao listNonExpungedByZoneAndTemplate zoneId templateId if nonExpungedVms isEmpty
HostVO secondaryStorageHost _hostDao findById templateHostRef getHostId long zoneId secondaryStorageHost getDataCenterId DataCenterVO zone _dcDao findById zoneId List VMInstanceVO nonExpungedVms _vmInstanceDao listNonExpungedByZoneAndTemplate zoneId templateId if nonExpungedVms isEmpty s_logger debug template getName zone getName return false List UserVmVO userVmUsingIso _userVmDao listByIsoId templateId if userVmUsingIso isEmpty s_logger debug template getName zone getName userVmUsingIso size return false List VolumeVO volumes _volumeDao findByTemplateAndZone templateId zoneId for VolumeVO volume volumes List SnapshotVO snapshots _snapshotDao listByVolumeIdVersion volume getId if snapshots isEmpty
Override public boolean templateIsDeleteable long templateId List UserVmJoinVO userVmUsingIso _userVmJoinDao listActiveByIsoId templateId if userVmUsingIso isEmpty
if cmd UpdateIsoPermissionsCmd mediaType if template getFormat equals ImageFormat ISO throw new InvalidParameterValueException if projectIds null if accountNames null accountNames new ArrayList String for Long projectId projectIds Project project _projectMgr getProject projectId if project null throw new InvalidParameterValueException projectId if _projectMgr canAccessProjectAccount caller project getProjectAccountId throw new InvalidParameterValueException caller projectId accountNames add _accountMgr getAccount project getProjectAccountId getAccountName _accountMgr checkAccess caller AccessType OperateEntry true template
SnapshotStrategy snapshotStrategy _storageStrategyFactory getSnapshotStrategy snapshot SnapshotOperation BACKUP snapshotStrategy backupSnapshot snapInfo snapInfo _snapshotFactory getSnapshot snapshotId dataStoreRole if snapInfo null throw new CloudRuntimeException snapshotId DataStore snapStore snapInfo getDataStore if snapStore null store snapStore future _tmpltSvr createTemplateFromSnapshotAsync snapInfo tmplInfo store else if volumeId null VolumeInfo volInfo _volFactory getVolume volumeId future _tmpltSvr createTemplateFromVolumeAsync volInfo tmplInfo store else throw new CloudRuntimeException CommandResult result null
throw new InvalidParameterValueException snapshotId Snapshot State BackedUp hyperType snapshot getHypervisorType _resourceLimitMgr checkResourceLimit templateOwner ResourceType template _resourceLimitMgr checkResourceLimit templateOwner ResourceType secondary_storage new Long volume null volume getSize snapshot getSize longValue if isAdmin featured null featured Boolean FALSE Long guestOSId cmd getOsTypeId GuestOSVO guestOS _guestOSDao findById guestOSId if guestOS null throw new InvalidParameterValueException guestOSId Long nextTemplateId _tmpltDao getNextInSequence Long class String description cmd getDisplayText boolean isExtractable false Long sourceTemplateId null if volume null
System out println file getAbsolutePath DOMConfigurator configureAndWatch file getAbsolutePath else System out println if args length s_logger error else try DatabaseConfig config ComponentContext inject DatabaseConfig class config doVersionCheck config doConfig System exit catch Exception ex System out print ex printStackTrace
final File configFile new File _configFileName SAXParserFactory spfactory SAXParserFactory newInstance final SAXParser saxParser spfactory newSAXParser final DbConfigXMLHandler handler new DbConfigXMLHandler handler setParent this Transaction execute new TransactionCallbackWithExceptionNoReturn Exception Override public void doInTransactionWithoutResult TransactionStatus status throws Exception saxParser parse configFile handler saveVMTemplate saveRootDomain saveDefaultConfiguations pzc checkAllPodCidrSubnets catch Exception ex System out print ex
String hypervisor _currentObjectParams get String insertSql1 TransactionLegacy txn TransactionLegacy currentTxn try PreparedStatement stmt txn prepareAutoCloseStatement insertSql1 stmt setLong id stmt setString name stmt setLong dataCenterId stmt setLong podId stmt setString hypervisor stmt setString stmt setString stmt executeUpdate catch SQLException ex System out println ex getMessage
else stmt setString storageType stmt setLong stmt setLong dataCenterId stmt setLong stmt setLong stmt setString hostAddress stmt setString hostPath stmt setDate new Date DateUtil currentGMTTime getTime stmt setLong podId stmt setString Status Up toString stmt setLong clusterId stmt executeUpdate catch SQLException ex System out println ex getMessage
stmt setLong destPhysicalNetworkId stmt setInt vpn stmt setInt dhcp stmt setInt dns stmt setInt gateway stmt setInt firewall stmt setInt sourceNat stmt setInt lb stmt setInt staticNat stmt setInt pf stmt setInt userData stmt setInt securityGroup stmt executeUpdate catch SQLException ex System out println ex getMessage
long nspId Long parseLong _currentObjectParams get String uuid UUID randomUUID toString String type _currentObjectParams get String insertSql1 TransactionLegacy txn TransactionLegacy currentTxn try PreparedStatement stmt txn prepareAutoCloseStatement insertSql1 stmt setLong id stmt setLong nspId stmt setString uuid stmt setString type stmt setInt stmt executeUpdate catch SQLException ex System out println ex getMessage
return String insertNWRateSql String insertMCRateSql TransactionLegacy txn TransactionLegacy currentTxn try PreparedStatement stmt if saveNetworkThrottlingRate stmt txn prepareAutoCloseStatement insertNWRateSql stmt setString _networkThrottlingRate stmt executeUpdate if saveMulticastThrottlingRate stmt txn prepareAutoCloseStatement insertMCRateSql stmt setString _multicastThrottlingRate stmt executeUpdate catch SQLException ex
final String insertAdminAccount txn TransactionLegacy currentTxn try PreparedStatement stmt txn prepareAutoCloseStatement insertAdminAccount stmt setLong id stmt setString username stmt executeUpdate catch SQLException ex s_logger error ex final String insertUser txn TransactionLegacy currentTxn try PreparedStatement stmt txn prepareAutoCloseStatement insertUser stmt setLong id stmt setString username
List AccountVO accounts _accountDao listAccounts accountName domainId filter if accounts size userAccount accounts get if userAccount null accountId userAccount getId else throw new InvalidParameterValueException accountName domainId else throw new PermissionDeniedException boolean isAdmin false boolean isDomainAdmin false if accountId null accountId caller getId if _accountService isRootAdmin caller getId isAdmin true
throw new InvalidParameterValueException accountName domainId else throw new PermissionDeniedException boolean isAdmin false boolean isDomainAdmin false if accountId null accountId caller getId if _accountService isRootAdmin caller getId isAdmin true else if _accountService isDomainAdmin caller getId isDomainAdmin true s_logger debug accountId Date startDate cmd getStartDate Date endDate cmd getEndDate if startDate after endDate
if jobExecTime null String segments jobExecTime split if segments length String timeZoneStr _configDao getValue Config UsageExecutionTimezone toString if timeZoneStr null timeZoneStr TimeZone tz TimeZone getTimeZone timeZoneStr Calendar cal Calendar getInstance tz cal setTime new Date long curTS cal getTimeInMillis cal set Calendar HOUR_OF_DAY Integer parseInt segments cal set Calendar MINUTE Integer parseInt segments cal set Calendar SECOND cal set Calendar MILLISECOND long execTS cal getTimeInMillis
Override public void checkAccess Account caller Domain domain throws PermissionDeniedException for SecurityChecker checker _securityCheckers if checker checkAccess caller domain if s_logger isDebugEnabled
Override public boolean deleteAccount AccountVO account long callerUserId Account caller long accountId account getId if _accountDao remove accountId
protected boolean cleanupAccount AccountVO account long callerUserId Account caller long accountId account getId boolean accountCleanupNeeded false try List UserVO users _userDao listByAccount accountId for UserVO user users if _userDao remove user getId
try List UserVO users _userDao listByAccount accountId for UserVO user users if _userDao remove user getId s_logger error user account accountCleanupNeeded true List org apache cloudstack region gslb GlobalLoadBalancerRuleVO gslbRules _gslbRuleDao listByAccount accountId if gslbRules null gslbRules isEmpty _gslbService revokeAllGslbRulesForAccount caller accountId _projectAccountDao removeAccountFromProjects accountId if account getType Account ACCOUNT_TYPE_PROJECT _messageBus publish _name MESSAGE_REMOVE_ACCOUNT_EVENT PublishScope LOCAL accountId List InstanceGroupVO groups _vmGroupDao listByAccountId accountId for InstanceGroupVO group groups if _vmMgr deleteVmGroup group getId
s_logger error user account accountCleanupNeeded true List org apache cloudstack region gslb GlobalLoadBalancerRuleVO gslbRules _gslbRuleDao listByAccount accountId if gslbRules null gslbRules isEmpty _gslbService revokeAllGslbRulesForAccount caller accountId _projectAccountDao removeAccountFromProjects accountId if account getType Account ACCOUNT_TYPE_PROJECT _messageBus publish _name MESSAGE_REMOVE_ACCOUNT_EVENT PublishScope LOCAL accountId List InstanceGroupVO groups _vmGroupDao listByAccountId accountId for InstanceGroupVO group groups if _vmMgr deleteVmGroup group getId s_logger error group getId accountCleanupNeeded true boolean success _snapMgr deleteSnapshotDirsForAccount accountId if success
boolean success _snapMgr deleteSnapshotDirsForAccount accountId if success s_logger debug accountId List VMTemplateVO userTemplates _templateDao listByAccountId accountId boolean allTemplatesDeleted true for VMTemplateVO template userTemplates if template getRemoved null try allTemplatesDeleted _tmpltMgr delete callerUserId template getId null catch Exception e s_logger warn template getName e allTemplatesDeleted false if allTemplatesDeleted s_logger warn accountId accountCleanupNeeded true
s_logger debug accountId List VMTemplateVO userTemplates _templateDao listByAccountId accountId boolean allTemplatesDeleted true for VMTemplateVO template userTemplates if template getRemoved null try allTemplatesDeleted _tmpltMgr delete callerUserId template getId null catch Exception e s_logger warn template getName e allTemplatesDeleted false if allTemplatesDeleted s_logger warn accountId accountCleanupNeeded true List VMSnapshotVO vmSnapshots _vmSnapshotDao listByAccountId Long valueOf accountId for VMSnapshot vmSnapshot vmSnapshots
if s_logger isDebugEnabled s_logger debug accountId vms size for UserVmVO vm vms if vm getState VirtualMachine State Destroyed vm getState VirtualMachine State Expunging try _vmMgr destroyVm vm getId false catch Exception e e printStackTrace s_logger warn vm getUuid if _vmMgr expunge vm callerUserId caller s_logger error vm getId accountCleanupNeeded true List VolumeVO volumes _volumeDao findDetachedByAccount accountId for VolumeVO volume volumes try
for UserVmVO vm vms if vm getState VirtualMachine State Destroyed vm getState VirtualMachine State Expunging try _vmMgr destroyVm vm getId false catch Exception e e printStackTrace s_logger warn vm getUuid if _vmMgr expunge vm callerUserId caller s_logger error vm getId accountCleanupNeeded true List VolumeVO volumes _volumeDao findDetachedByAccount accountId for VolumeVO volume volumes try volumeService deleteVolume volume getId caller catch Exception ex
s_logger error vm getId accountCleanupNeeded true List VolumeVO volumes _volumeDao findDetachedByAccount accountId for VolumeVO volume volumes try volumeService deleteVolume volume getId caller catch Exception ex s_logger warn accountId ex accountCleanupNeeded true List RemoteAccessVpnVO remoteAccessVpns _remoteAccessVpnDao findByAccount accountId List VpnUserVO vpnUsers _vpnUser listByAccount accountId for VpnUserVO vpnUser vpnUsers _remoteAccessVpnMgr removeVpnUser accountId vpnUser getUsername caller try for RemoteAccessVpnVO vpn remoteAccessVpns
s_logger warn accountId ex accountCleanupNeeded true List RemoteAccessVpnVO remoteAccessVpns _remoteAccessVpnDao findByAccount accountId List VpnUserVO vpnUsers _vpnUser listByAccount accountId for VpnUserVO vpnUser vpnUsers _remoteAccessVpnMgr removeVpnUser accountId vpnUser getUsername caller try for RemoteAccessVpnVO vpn remoteAccessVpns _remoteAccessVpnMgr destroyRemoteAccessVpnForIp vpn getServerAddressId caller false catch ResourceUnavailableException ex s_logger warn accountId ex accountCleanupNeeded true int numRemoved _securityGroupDao removeByAccountId accountId s_logger info numRemoved accountId int numAGRemoved _affinityGroupDao removeByAccountId accountId
List RemoteAccessVpnVO remoteAccessVpns _remoteAccessVpnDao findByAccount accountId List VpnUserVO vpnUsers _vpnUser listByAccount accountId for VpnUserVO vpnUser vpnUsers _remoteAccessVpnMgr removeVpnUser accountId vpnUser getUsername caller try for RemoteAccessVpnVO vpn remoteAccessVpns _remoteAccessVpnMgr destroyRemoteAccessVpnForIp vpn getServerAddressId caller false catch ResourceUnavailableException ex s_logger warn accountId ex accountCleanupNeeded true int numRemoved _securityGroupDao removeByAccountId accountId s_logger info numRemoved accountId int numAGRemoved _affinityGroupDao removeByAccountId accountId s_logger info numAGRemoved accountId boolean networksDeleted true
try for RemoteAccessVpnVO vpn remoteAccessVpns _remoteAccessVpnMgr destroyRemoteAccessVpnForIp vpn getServerAddressId caller false catch ResourceUnavailableException ex s_logger warn accountId ex accountCleanupNeeded true int numRemoved _securityGroupDao removeByAccountId accountId s_logger info numRemoved accountId int numAGRemoved _affinityGroupDao removeByAccountId accountId s_logger info numAGRemoved accountId boolean networksDeleted true s_logger debug account getId List NetworkVO networks _networkDao listByOwner accountId if networks null for NetworkVO network networks
int numAGRemoved _affinityGroupDao removeByAccountId accountId s_logger info numAGRemoved accountId boolean networksDeleted true s_logger debug account getId List NetworkVO networks _networkDao listByOwner accountId if networks null for NetworkVO network networks ReservationContext context new ReservationContextImpl null null getActiveUser callerUserId caller if _networkMgr destroyNetwork network getId context false s_logger warn network accountId accountCleanupNeeded true networksDeleted false else s_logger debug network getId accountId boolean vpcsDeleted true
if networks null for NetworkVO network networks ReservationContext context new ReservationContextImpl null null getActiveUser callerUserId caller if _networkMgr destroyNetwork network getId context false s_logger warn network accountId accountCleanupNeeded true networksDeleted false else s_logger debug network getId accountId boolean vpcsDeleted true s_logger debug account getId List extends Vpc vpcs _vpcMgr getVpcsForAccount account getId for Vpc vpc vpcs if _vpcMgr destroyVpc vpc caller callerUserId s_logger warn vpc accountId
s_logger warn network accountId accountCleanupNeeded true networksDeleted false else s_logger debug network getId accountId boolean vpcsDeleted true s_logger debug account getId List extends Vpc vpcs _vpcMgr getVpcsForAccount account getId for Vpc vpc vpcs if _vpcMgr destroyVpc vpc caller callerUserId s_logger warn vpc accountId accountCleanupNeeded true vpcsDeleted false else s_logger debug vpc getId accountId
else s_logger debug network getId accountId boolean vpcsDeleted true s_logger debug account getId List extends Vpc vpcs _vpcMgr getVpcsForAccount account getId for Vpc vpc vpcs if _vpcMgr destroyVpc vpc caller callerUserId s_logger warn vpc accountId accountCleanupNeeded true vpcsDeleted false else s_logger debug vpc getId accountId if networksDeleted vpcsDeleted List extends IpAddress ipsToRelease _ipAddressDao listByAccount accountId for IpAddress ip ipsToRelease
if networksDeleted vpcsDeleted List extends IpAddress ipsToRelease _ipAddressDao listByAccount accountId for IpAddress ip ipsToRelease s_logger debug ip accountId if _ipAddrMgr disassociatePublicIpAddress ip getId callerUserId caller s_logger warn ip accountId accountCleanupNeeded true s_logger debug accountId if _vpnMgr deleteCustomerGatewayByAccount accountId s_logger warn accountId try _autoscaleMgr cleanUpAutoScaleResources accountId catch CloudRuntimeException ex s_logger warn accountId ex accountCleanupNeeded true
Override ActionEvent eventType EventTypes EVENT_USER_UPDATE eventDescription public UserAccount updateUser UpdateUserCmd updateUserCmd UserVO user retrieveAndValidateUser updateUserCmd
if account getId Account ACCOUNT_ID_SYSTEM throw new PermissionDeniedException userId checkAccess caller AccessType OperateEntry true account boolean success true if user getState equals State locked return _userAccountDao findById userId else if user getState equals State enabled success doSetUserStatus user getId State locked boolean lockAccount true List UserVO allUsersByAccount _userDao listByAccount user getAccountId for UserVO oneUser allUsersByAccount if oneUser getState equals State enabled lockAccount false break if lockAccount
Override ActionEvent eventType EventTypes EVENT_ACCOUNT_DELETE eventDescription async true public boolean deleteUserAccount long accountId CallContext ctx CallContext current long callerUserId ctx getCallingUserId Account caller ctx getCallingAccount AccountVO account _accountDao findById accountId if account null account getRemoved null if account null
Long accountId cmd getId Long domainId cmd getDomainId Long roleId cmd getRoleId String accountName cmd getAccountName String newAccountName cmd getNewName String networkDomain cmd getNetworkDomain final Map String String details cmd getDetails boolean success false Account account null if accountId null account _accountDao findById accountId else account _accountDao findEnabledAccount accountName domainId final AccountVO acctForUpdate _accountDao findById account getId if account null account getType Account ACCOUNT_TYPE_PROJECT
private long getNewAccountId long domainId String accountName Long accountId Account newAccount null if StringUtils isNotBlank accountName if s_logger isDebugEnabled
protected UserVO createUser long accountId String userName String password String firstName String lastName String email String timezone String userUUID User Source source if s_logger isDebugEnabled
StringBuffer unsignedRequestBuffer new StringBuffer List String parameterNames new ArrayList String for Object paramNameObj requestParameters keySet parameterNames add String paramNameObj Collections sort parameterNames try for String paramName parameterNames String paramValue String requestParameters get paramName if equalsIgnoreCase paramName signature paramValue else if equalsIgnoreCase paramName String timestampStr paramValue try timestamp Long parseLong timestampStr
Collections sort parameterNames try for String paramName parameterNames String paramValue String requestParameters get paramName if equalsIgnoreCase paramName signature paramValue else if equalsIgnoreCase paramName String timestampStr paramValue try timestamp Long parseLong timestampStr long currentTime System currentTimeMillis if Math abs currentTime timestamp tolerance if s_logger isDebugEnabled s_logger debug currentTime timestamp
else if equalsIgnoreCase paramName String timestampStr paramValue try timestamp Long parseLong timestampStr long currentTime System currentTimeMillis if Math abs currentTime timestamp tolerance if s_logger isDebugEnabled s_logger debug currentTime timestamp return null catch NumberFormatException nfe if s_logger isDebugEnabled s_logger debug timestampStr return null if unsignedRequestBuffer length
return null catch NumberFormatException nfe if s_logger isDebugEnabled s_logger debug timestampStr return null if unsignedRequestBuffer length unsignedRequestBuffer append unsignedRequestBuffer append paramName append append URLEncoder encode paramValue if signature null timestamp 0L if s_logger isDebugEnabled s_logger debug signature timestamp return null unsignedRequest unsignedRequestBuffer toString toLowerCase replaceAll Mac mac Mac getInstance SecretKeySpec keySpec new SecretKeySpec key getBytes
Mac mac Mac getInstance SecretKeySpec keySpec new SecretKeySpec key getBytes mac init keySpec mac update unsignedRequest getBytes byte encryptedBytes mac doFinal String computedSignature new String Base64 encodeBase64 encryptedBytes boolean equalSig ConstantTimeComparator compareStrings signature computedSignature if equalSig s_logger info signature computedSignature else user _userAccountDao getUserAccount username domainId catch Exception ex s_logger error ex return null if user null
String computedSignature new String Base64 encodeBase64 encryptedBytes boolean equalSig ConstantTimeComparator compareStrings signature computedSignature if equalSig s_logger info signature computedSignature else user _userAccountDao getUserAccount username domainId catch Exception ex s_logger error ex return null if user null if user getId User UID_SYSTEM s_logger error username domainId return null if BaremetalUtils BAREMETAL_SYSTEM_ACCOUNT_NAME equals user getUsername s_logger error username domainId
private UserAccount getUserAccount String username String password Long domainId Map String Object requestParameters if s_logger isDebugEnabled
continue Pair Boolean ActionOnFailedAuthentication result authenticator authenticate username password domainId requestParameters if result first authenticated true break else if result second null actionsOnFailedAuthenticaion add result second boolean updateIncorrectLoginCount actionsOnFailedAuthenticaion contains ActionOnFailedAuthentication INCREMENT_INCORRECT_LOGIN_ATTEMPT_COUNT if authenticated Domain domain _domainMgr getDomain domainId String domainName null if domain null domainName domain getName userAccount _userAccountDao getUserAccount username domainId if userAccount getState equalsIgnoreCase Account State enabled toString userAccount getAccountState equalsIgnoreCase Account State enabled toString
else if result second null actionsOnFailedAuthenticaion add result second boolean updateIncorrectLoginCount actionsOnFailedAuthenticaion contains ActionOnFailedAuthentication INCREMENT_INCORRECT_LOGIN_ATTEMPT_COUNT if authenticated Domain domain _domainMgr getDomain domainId String domainName null if domain null domainName domain getName userAccount _userAccountDao getUserAccount username domainId if userAccount getState equalsIgnoreCase Account State enabled toString userAccount getAccountState equalsIgnoreCase Account State enabled toString if s_logger isInfoEnabled s_logger info username domainName throw new CloudAuthenticationException username domainName if isInternalAccount userAccount getId updateLoginAttempts userAccount getId false
s_logger info username domainName throw new CloudAuthenticationException username domainName if isInternalAccount userAccount getId updateLoginAttempts userAccount getId false return userAccount else if s_logger isDebugEnabled s_logger debug username domainId if userAccount null s_logger warn username domainId return null if userAccount getState equalsIgnoreCase Account State enabled toString if isInternalAccount userAccount getId int attemptsMade userAccount getLoginAttempts if updateIncorrectLoginCount
Pair User Account userAcct null int retryLimit do KeyGenerator generator KeyGenerator getInstance SecretKey key generator generateKey encodedKey Base64 encodeBase64URLSafeString key getEncoded userAcct _accountDao findUserAccountByApiKey encodedKey retryLimit while userAcct null retryLimit if userAcct null return null updatedUser setApiKey encodedKey _userDao update userId updatedUser return encodedKey catch NoSuchAlgorithmException ex
int retryLimit UserVO userBySecretKey null do KeyGenerator generator KeyGenerator getInstance SecretKey key generator generateKey encodedKey Base64 encodeBase64URLSafeString key getEncoded userBySecretKey _userDao findUserBySecretKey encodedKey retryLimit while userBySecretKey null retryLimit if userBySecretKey null return null updatedUser setSecretKey encodedKey _userDao update userId updatedUser return encodedKey catch NoSuchAlgorithmException ex
Override public void checkAccess User user ControlledEntity entity throws PermissionDeniedException for SecurityChecker checker _securityCheckers if checker checkAccess user entity if s_logger isDebugEnabled
return false try s_logger debug domain getId Domain State Inactive domain setState Domain State Inactive _domainDao update domain getId domain try long ownerId domain getAccountId if BooleanUtils toBoolean cleanup tryCleanupDomain domain ownerId else removeDomainWithNoAccountsForCleanupNetworksOrDedicatedResources domain if _configMgr releaseDomainSpecificVirtualRanges domain getId CloudRuntimeException e new CloudRuntimeException e addProxyObject domain getUuid throw e
_domainDao update domain getId domain try long ownerId domain getAccountId if BooleanUtils toBoolean cleanup tryCleanupDomain domain ownerId else removeDomainWithNoAccountsForCleanupNetworksOrDedicatedResources domain if _configMgr releaseDomainSpecificVirtualRanges domain getId CloudRuntimeException e new CloudRuntimeException e addProxyObject domain getUuid throw e else s_logger debug domain getId cleanupDomainOfferings domain getId CallContext current putContextParameter Domain class domain getUuid
protected void rollbackDomainState DomainVO domain
protected void removeDomainWithNoAccountsForCleanupNetworksOrDedicatedResources DomainVO domain boolean hasDedicatedResources false List Long networkIds _networkDomainDao listNetworkIdsByDomain domain getId List AccountVO accountsForCleanup _accountDao findCleanupsForRemovedAccounts domain getId List DedicatedResourceVO dedicatedResources _dedicatedDao listByDomainId domain getId if CollectionUtils isNotEmpty dedicatedResources
protected boolean cleanupDomain Long domainId Long ownerId throws ConcurrentOperationException ResourceUnavailableException
List DomainVO domains _domainDao search sc null SearchCriteria DomainVO sc1 _domainDao createSearchCriteria sc1 addAnd SearchCriteria Op LIKE domainHandle getPath List DomainVO domainsToBeInactivated _domainDao search sc1 null for DomainVO domain domainsToBeInactivated domain setState Domain State Inactive _domainDao update domain getId domain for DomainVO domain domains success success cleanupDomain domain getId domain getAccountId if success s_logger warn domain getId SearchCriteria AccountVO sc _accountDao createSearchCriteria sc addAnd SearchCriteria Op EQ domainId List AccountVO accounts _accountDao search sc null for AccountVO account accounts
for DomainVO domain domains success success cleanupDomain domain getId domain getAccountId if success s_logger warn domain getId SearchCriteria AccountVO sc _accountDao createSearchCriteria sc addAnd SearchCriteria Op EQ domainId List AccountVO accounts _accountDao search sc null for AccountVO account accounts if account getType Account ACCOUNT_TYPE_PROJECT s_logger debug account domainId boolean deleteAccount _accountMgr deleteAccount account CallContext current getCallingUserId getCaller if deleteAccount s_logger warn account getId success success deleteAccount else
SearchCriteria AccountVO sc _accountDao createSearchCriteria sc addAnd SearchCriteria Op EQ domainId List AccountVO accounts _accountDao search sc null for AccountVO account accounts if account getType Account ACCOUNT_TYPE_PROJECT s_logger debug account domainId boolean deleteAccount _accountMgr deleteAccount account CallContext current getCallingUserId getCaller if deleteAccount s_logger warn account getId success success deleteAccount else ProjectVO project _projectDao findByProjectAccountId account getId s_logger debug project domainId boolean deleteProject _projectMgr deleteProject getCaller CallContext current getCallingUserId project if deleteProject
for AccountVO account accounts if account getType Account ACCOUNT_TYPE_PROJECT s_logger debug account domainId boolean deleteAccount _accountMgr deleteAccount account CallContext current getCallingUserId getCaller if deleteAccount s_logger warn account getId success success deleteAccount else ProjectVO project _projectDao findByProjectAccountId account getId s_logger debug project domainId boolean deleteProject _projectMgr deleteProject getCaller CallContext current getCallingUserId project if deleteProject s_logger warn project success success deleteProject boolean networksDeleted true
s_logger warn account getId success success deleteAccount else ProjectVO project _projectDao findByProjectAccountId account getId s_logger debug project domainId boolean deleteProject _projectMgr deleteProject getCaller CallContext current getCallingUserId project if deleteProject s_logger warn project success success deleteProject boolean networksDeleted true s_logger debug domainId List Long networkIds _networkDomainDao listNetworkIdsByDomain domainId CallContext ctx CallContext current ReservationContext context new ReservationContextImpl null null _accountMgr getActiveUser ctx getCallingUserId ctx getCallingAccount for Long networkId networkIds
success success deleteAccount else ProjectVO project _projectDao findByProjectAccountId account getId s_logger debug project domainId boolean deleteProject _projectMgr deleteProject getCaller CallContext current getCallingUserId project if deleteProject s_logger warn project success success deleteProject boolean networksDeleted true s_logger debug domainId List Long networkIds _networkDomainDao listNetworkIdsByDomain domainId CallContext ctx CallContext current ReservationContext context new ReservationContextImpl null null _accountMgr getActiveUser ctx getCallingUserId ctx getCallingAccount for Long networkId networkIds s_logger debug networkId domainId
s_logger warn project success success deleteProject boolean networksDeleted true s_logger debug domainId List Long networkIds _networkDomainDao listNetworkIdsByDomain domainId CallContext ctx CallContext current ReservationContext context new ReservationContextImpl null null _accountMgr getActiveUser ctx getCallingUserId ctx getCallingAccount for Long networkId networkIds s_logger debug networkId domainId if _networkMgr destroyNetwork networkId context false s_logger warn networkId domainId networksDeleted false else s_logger debug networkId domainId if networksDeleted
s_logger debug networkId domainId if _networkMgr destroyNetwork networkId context false s_logger warn networkId domainId networksDeleted false else s_logger debug networkId domainId if networksDeleted s_logger debug domainId return false boolean deleteDomainSuccess true List AccountVO accountsForCleanup _accountDao findCleanupsForRemovedAccounts domainId if accountsForCleanup isEmpty List DedicatedResourceVO dedicatedResources _dedicatedDao listByDomainId domainId if dedicatedResources null dedicatedResources isEmpty s_logger debug domainId
Network defaultNetwork _networkDao findById defaultNic getNetworkId NicProfile defaultNicProfile new NicProfile defaultNic defaultNetwork null null null _networkModel isSecurityGroupSupportedInNetwork defaultNetwork _networkModel getNetworkTag template getHypervisorType defaultNetwork VirtualMachineProfile vmProfile new VirtualMachineProfileImpl vmInstance vmProfile setParameter VirtualMachineProfile Param VmPassword password UserDataServiceProvider element _networkMgr getPasswordResetProvider defaultNetwork if element null throw new CloudRuntimeException Service UserData getName boolean result element savePassword defaultNetwork defaultNicProfile vmProfile if result s_logger debug return false else final UserVmVO userVm _vmDao findById vmId _vmDao loadDetails userVm encryptAndStorePassword userVm password
if element null throw new CloudRuntimeException Service UserData getName boolean result element savePassword defaultNetwork defaultNicProfile vmProfile if result s_logger debug return false else final UserVmVO userVm _vmDao findById vmId _vmDao loadDetails userVm encryptAndStorePassword userVm password if vmInstance getState State Stopped s_logger debug vmInstance return true if rebootVirtualMachine userId vmId false null s_logger warn vmInstance
private boolean resetVMSSHKeyInternal Long vmId String sshPublicKey String password throws ResourceUnavailableException InsufficientCapacityException Long userId CallContext current getCallingUserId VMInstanceVO vmInstance _vmDao findById vmId VMTemplateVO template _templateDao findByIdIncludingRemoved vmInstance getTemplateId Nic defaultNic _networkModel getDefaultNic vmId if defaultNic null
if result s_logger debug return false else final UserVmVO userVm _vmDao findById vmId _vmDao loadDetails userVm userVm setDetail VmDetailConstants SSH_PUBLIC_KEY sshPublicKey if template isEnablePassword userVm setPassword password encryptAndStorePassword userVm password _vmDao saveDetails userVm if vmInstance getState State Stopped s_logger debug vmInstance return true if rebootVirtualMachine userId vmId false null
Override public boolean stopVirtualMachine long userId long vmId boolean status false if s_logger isDebugEnabled
DataCenterVO dc _dcDao findById vm getDataCenterId try if dc getNetworkType DataCenter NetworkType Advanced List Long vmNetworks _vmNetworkMapDao getNetworks vmId List DomainRouterVO routers new ArrayList DomainRouterVO for long vmNetworkId vmNetworks List DomainRouterVO router _routerDao listStopped vmNetworkId routers addAll router for DomainRouterVO routerToStart routers s_logger warn routerToStart getInstanceName vm getInstanceName _virtualNetAppliance startRouter routerToStart getId true catch ConcurrentOperationException e throw new CloudRuntimeException e catch Exception ex throw new CloudRuntimeException ex
List String hostNames _vmInstanceDao listDistinctHostNames network getId if hostNames contains vmInstance getHostName for String hostName hostNames VMInstanceVO vm _vmInstanceDao findVMByHostName hostName if _networkModel getNicInNetwork vm getId network getId null vm getHostName equals vmInstance getHostName throw new CloudRuntimeException network vmInstance getHostName NicProfile guestNic null boolean cleanUp true try guestNic _itMgr addVmToNetwork vmInstance network profile saveExtraDhcpOptions guestNic getId cmd getDhcpOptionsMap _networkMgr configureExtraDhcpOptions network guestNic getId cmd getDhcpOptionsMap cleanUp false catch ResourceUnavailableException e throw new CloudRuntimeException vmInstance e
if dc getNetworkType DataCenter NetworkType Basic throw new InvalidParameterValueException vmInstance getDataCenterId if nic getInstanceId vmId throw new InvalidParameterValueException nic vmInstance _accountMgr checkAccess caller AccessType UseEntry false network if nic isDefaultNic vmInstance getType VirtualMachine Type User throw new InvalidParameterValueException vmInstance network if _rulesMgr listAssociatedRulesForGuestNic nic size throw new InvalidParameterValueException vmInstance network boolean nicremoved false try nicremoved _itMgr removeNicFromVm vmInstance nic catch ResourceUnavailableException e throw new CloudRuntimeException network vmInstance e catch ConcurrentOperationException e
throw new CloudRuntimeException Network oldDefaultNetwork null oldDefaultNetwork _networkModel getDefaultNetworkForVm vmId String oldNicIdString Long toString _networkModel getDefaultNic vmId getId long oldNetworkOfferingId 1L if oldDefaultNetwork null oldNetworkOfferingId oldDefaultNetwork getNetworkOfferingId NicVO existingVO _nicDao findById existing id Integer chosenID nic getDeviceId Integer existingID existing getDeviceId Network newdefault null if _itMgr updateDefaultNicForVM vmInstance nic existingVO newdefault _networkModel getDefaultNetworkForVm vmId if newdefault null nic setDefaultNic false
_accountMgr checkAccess caller null true vm Account ipOwner _accountDao findByIdIncludingRemoved vm getAccountId s_logger debug DataCenter dc _dcDao findById network getDataCenterId if dc null throw new InvalidParameterValueException if dc getNetworkType NetworkType Advanced network getGuestType Network GuestType Isolated try ipaddr _ipAddrMgr allocateGuestIP network ipaddr catch InsufficientAddressCapacityException e throw new InvalidParameterValueException nicVO getUuid if ipaddr null throw new InvalidParameterValueException nicVO getUuid if _networkModel areServicesSupportedInNetwork network getId Service StaticNat IPAddressVO oldIP _ipAddressDao findByAssociatedVmId vm getId
e addProxyObject network getUuid if _networkModel areServicesSupportedInNetwork network getId Service StaticNat IPAddressVO oldIP _ipAddressDao findByAssociatedVmId vm getId if oldIP null oldIP setVmIp nicVO getIPv4Address _ipAddressDao persist oldIP throw e else if dc getNetworkType NetworkType Basic network getGuestType Network GuestType Shared Long podId null if dc getNetworkType NetworkType Basic podId vm getPodIdToDeployIn if podId null throw new InvalidParameterValueException try ipaddr _ipAddrMgr allocatePublicIpForGuestNic network podId ipOwner ipaddr
throw e else if dc getNetworkType NetworkType Basic network getGuestType Network GuestType Shared Long podId null if dc getNetworkType NetworkType Basic podId vm getPodIdToDeployIn if podId null throw new InvalidParameterValueException try ipaddr _ipAddrMgr allocatePublicIpForGuestNic network podId ipOwner ipaddr if ipaddr null throw new InvalidParameterValueException nicVO getUuid final IPAddressVO newIp _ipAddressDao findByIpAndDcId dc getId ipaddr final Vlan vlan _vlanDao findById newIp getVlanId nicVO setIPv4Gateway vlan getVlanGateway nicVO setIPv4Netmask vlan getVlanNetmask
private boolean upgradeRunningVirtualMachine Long vmId Long newServiceOfferingId Map String String customParameters throws ResourceUnavailableException ConcurrentOperationException ManagementServerException VirtualMachineMigrationException Account caller CallContext current getCallingAccount VMInstanceVO vmInstance _vmInstanceDao findById vmId if vmInstance getHypervisorType HypervisorType XenServer vmInstance getHypervisorType HypervisorType VMware vmInstance getHypervisorType HypervisorType Simulator
Override DB public UserVm recoverVirtualMachine RecoverVMCmd cmd throws ResourceAllocationException CloudRuntimeException final Long vmId cmd getId Account caller CallContext current getCallingAccount final Long userId caller getAccountId final UserVmVO vm _vmDao findById vmId if vm null throw new InvalidParameterValueException vmId if _accountMgr isAdmin userId AllowUserExpungeRecoverVm valueIn userId throw new PermissionDeniedException if vm getRemoved null if s_logger isDebugEnabled s_logger debug vmId throw new InvalidParameterValueException vmId if vm getState State Destroyed if s_logger isDebugEnabled
final Long userId caller getAccountId final UserVmVO vm _vmDao findById vmId if vm null throw new InvalidParameterValueException vmId if _accountMgr isAdmin userId AllowUserExpungeRecoverVm valueIn userId throw new PermissionDeniedException if vm getRemoved null if s_logger isDebugEnabled s_logger debug vmId throw new InvalidParameterValueException vmId if vm getState State Destroyed if s_logger isDebugEnabled s_logger debug vmId throw new InvalidParameterValueException vmId if s_logger isDebugEnabled
throw new InvalidParameterValueException vmId if vm getState State Destroyed if s_logger isDebugEnabled s_logger debug vmId throw new InvalidParameterValueException vmId if s_logger isDebugEnabled s_logger debug vmId Transaction execute new TransactionCallbackWithExceptionNoReturn ResourceAllocationException Override public void doInTransactionWithoutResult TransactionStatus status throws ResourceAllocationException Account account _accountDao lockRow vm getAccountId true if account getRemoved null throw new CloudRuntimeException ServiceOfferingVO serviceOffering _serviceOfferingDao findById vm getId vm getServiceOfferingId if VirtualMachineManager ResoureCountRunningVMsonly value resourceLimitCheck account vm isDisplayVm new Long serviceOffering getCpu new Long serviceOffering getRamSize
private boolean cleanupVmResources long vmId boolean success true _securityGroupMgr removeInstanceFromGroups vmId removeInstanceFromInstanceGroup vmId if _firewallMgr revokeFirewallRulesForVm vmId
private boolean cleanupVmResources long vmId boolean success true _securityGroupMgr removeInstanceFromGroups vmId removeInstanceFromInstanceGroup vmId if _firewallMgr revokeFirewallRulesForVm vmId s_logger debug vmId else success false s_logger warn vmId if _rulesMgr revokePortForwardingRulesForVm vmId s_logger debug vmId else success false s_logger warn vmId if _lbMgr removeVmFromLoadBalancers vmId
success false s_logger warn vmId if _rulesMgr revokePortForwardingRulesForVm vmId s_logger debug vmId else success false s_logger warn vmId if _lbMgr removeVmFromLoadBalancers vmId s_logger debug vmId else success false s_logger warn vmId List IPAddressVO ips _ipAddressDao findAllByAssociatedVmId vmId for IPAddressVO ip ips try
private void updateVmStateForFailedVmCreation Long vmId Long hostId UserVmVO vm _vmDao findById vmId if vm null if vm getState equals State Stopped
else if MapUtils isNotEmpty details if details containsKey throw new InvalidParameterValueException if caller null caller getType Account ACCOUNT_TYPE_ADMIN for final String detailName details keySet if userBlacklistedSettings contains detailName throw new InvalidParameterValueException detailName for final UserVmDetailVO detail userVmDetailsDao listDetails id if userBlacklistedSettings contains detail getName details put detail getName detail getValue for String detailName details keySet if detailName startsWith ApiConstants OVF_PROPERTIES String ovfPropKey detailName replace ApiConstants OVF_PROPERTIES TemplateOVFPropertyVO ovfPropertyVO templateOVFPropertiesDao findByTemplateAndKey vmInstance getTemplateId ovfPropKey
isDynamicallyScalable vm isDynamicallyScalable boolean isVMware vm getHypervisorType HypervisorType VMware if securityGroupIdList null isVMware throw new InvalidParameterValueException else Network defaultNetwork null try DataCenterVO zone _dcDao findById vm getDataCenterId if zone getNetworkType NetworkType Basic defaultNetwork _networkModel getExclusiveGuestNetwork zone getId else if zone isSecurityGroupEnabled NicVO defaultNic _nicDao findDefaultNicForVM vm getId if defaultNic null defaultNetwork _networkDao findById defaultNic getNetworkId catch InvalidParameterValueException e
NicVO defaultNic _nicDao findDefaultNicForVM vm getId if defaultNic null defaultNetwork _networkDao findById defaultNic getNetworkId catch InvalidParameterValueException e if s_logger isDebugEnabled s_logger debug e getMessage e defaultNetwork _networkModel getDefaultNetworkForVm id if securityGroupIdList null _networkModel isSecurityGroupSupportedInNetwork defaultNetwork _networkModel canAddDefaultSecurityGroup if vm getState State Stopped _securityGroupMgr removeInstanceFromGroups id _securityGroupMgr addInstanceToGroups id securityGroupIdList else throw new InvalidParameterValueException List extends Nic nics _nicDao listByVmId vm getId if hostName null
private boolean updateUserDataInternal UserVm vm throws ResourceUnavailableException InsufficientCapacityException VMTemplateVO template _templateDao findByIdIncludingRemoved vm getTemplateId List extends Nic nics _nicDao listByVmId vm getId if nics null nics isEmpty
long serviceOfferingId vmInstance getServiceOfferingId ServiceOfferingVO offering _serviceOfferingDao findById vmInstance getId serviceOfferingId if offering null offering getRemoved null if offering isVolatileVm return restoreVMInternal caller vmInstance null else throw new InvalidParameterValueException serviceOfferingId Boolean enterSetup cmd getBootIntoSetup if enterSetup null enterSetup HypervisorType VMware equals vmInstance getHypervisorType throw new InvalidParameterValueException vmInstance getHypervisorType UserVm userVm rebootVirtualMachine CallContext current getCallingUserId vmId enterSetup null false cmd getBootIntoSetup if userVm null final List NicVO nics _nicDao listByVmId vmId for NicVO nic nics Network network _networkModel getNetwork nic getNetworkId
throw new InvalidParameterValueException else networkList add _networkDao findById defaultNetwork getId boolean isVmWare template getHypervisorType HypervisorType VMware hypervisor null hypervisor HypervisorType VMware if securityGroupIdList null isVmWare throw new InvalidParameterValueException else if isVmWare _networkModel isSecurityGroupSupportedInNetwork defaultNetwork _networkModel canAddDefaultSecurityGroup if securityGroupIdList null securityGroupIdList isEmpty if securityGroupIdList null securityGroupIdList new ArrayList Long SecurityGroup defaultGroup _securityGroupMgr getDefaultSecurityGroup owner getId if defaultGroup null securityGroupIdList add defaultGroup getId else if s_logger isDebugEnabled
else vm setDetail key customParameters get key if key equalsIgnoreCase ApiConstants BootType UEFI toString vm setDetail key customParameters get key continue vm setDetail VmDetailConstants DEPLOY_VM if MapUtils isNotEmpty userVmOVFPropertiesMap for String key userVmOVFPropertiesMap keySet String detailKey ApiConstants OVF_PROPERTIES key String value userVmOVFPropertiesMap get key if StringUtils isNotBlank value if value equalsIgnoreCase value else if value equalsIgnoreCase value
public void validateRootDiskResize final HypervisorType hypervisorType Long rootDiskSize VMTemplateVO templateVO UserVmVO vm final Map String String customParameters throws InvalidParameterValueException if rootDiskSize templateVO getSize String error toHumanReadableSize templateVO getSize
public void validateRootDiskResize final HypervisorType hypervisorType Long rootDiskSize VMTemplateVO templateVO UserVmVO vm final Map String String customParameters throws InvalidParameterValueException if rootDiskSize templateVO getSize String error toHumanReadableSize templateVO getSize s_logger error error throw new InvalidParameterValueException error else if rootDiskSize templateVO getSize if hypervisorType HypervisorType VMware vm getDetails null vm getDetails get VmDetailConstants ROOT_DISK_CONTROLLER null s_logger warn else if hypervisorType HypervisorType VMware vm getDetails get VmDetailConstants ROOT_DISK_CONTROLLER toLowerCase contains String error vm getDetails get VmDetailConstants ROOT_DISK_CONTROLLER s_logger error error throw new InvalidParameterValueException error else s_logger debug toHumanReadableSize templateVO getSize rootDiskSize else
return for VmNetworkStatsEntry vmNetworkStat vmNetworkStats SearchCriteria NicVO sc_nic _nicDao createSearchCriteria sc_nic addAnd SearchCriteria Op EQ vmNetworkStat getMacAddress NicVO nic _nicDao search sc_nic null get List VlanVO vlan _vlanDao listVlansByNetworkId nic getNetworkId if vlan null vlan size vlan get getVlanType VlanType DirectAttached break UserStatisticsVO previousvmNetworkStats _userStatsDao findBy userVm getAccountId userVm getDataCenterId nic getNetworkId nic getIPv4Address userVm getId if previousvmNetworkStats null previousvmNetworkStats new UserStatisticsVO userVm getAccountId userVm getDataCenterId nic getIPv4Address userVm getId nic getNetworkId _userStatsDao persist previousvmNetworkStats UserStatisticsVO vmNetworkStat_lock _userStatsDao lock userVm getAccountId userVm getDataCenterId nic getNetworkId nic getIPv4Address userVm getId if vmNetworkStat getBytesSent vmNetworkStat getBytesReceived s_logger debug
sc_nic addAnd SearchCriteria Op EQ vmNetworkStat getMacAddress NicVO nic _nicDao search sc_nic null get List VlanVO vlan _vlanDao listVlansByNetworkId nic getNetworkId if vlan null vlan size vlan get getVlanType VlanType DirectAttached break UserStatisticsVO previousvmNetworkStats _userStatsDao findBy userVm getAccountId userVm getDataCenterId nic getNetworkId nic getIPv4Address userVm getId if previousvmNetworkStats null previousvmNetworkStats new UserStatisticsVO userVm getAccountId userVm getDataCenterId nic getIPv4Address userVm getId nic getNetworkId _userStatsDao persist previousvmNetworkStats UserStatisticsVO vmNetworkStat_lock _userStatsDao lock userVm getAccountId userVm getDataCenterId nic getNetworkId nic getIPv4Address userVm getId if vmNetworkStat getBytesSent vmNetworkStat getBytesReceived s_logger debug continue if vmNetworkStat_lock null s_logger warn userVm getAccountId userVm getId nic getId
UserStatisticsVO previousvmNetworkStats _userStatsDao findBy userVm getAccountId userVm getDataCenterId nic getNetworkId nic getIPv4Address userVm getId if previousvmNetworkStats null previousvmNetworkStats new UserStatisticsVO userVm getAccountId userVm getDataCenterId nic getIPv4Address userVm getId nic getNetworkId _userStatsDao persist previousvmNetworkStats UserStatisticsVO vmNetworkStat_lock _userStatsDao lock userVm getAccountId userVm getDataCenterId nic getNetworkId nic getIPv4Address userVm getId if vmNetworkStat getBytesSent vmNetworkStat getBytesReceived s_logger debug continue if vmNetworkStat_lock null s_logger warn userVm getAccountId userVm getId nic getId continue if previousvmNetworkStats null previousvmNetworkStats getCurrentBytesSent vmNetworkStat_lock getCurrentBytesSent previousvmNetworkStats getCurrentBytesReceived vmNetworkStat_lock getCurrentBytesReceived s_logger debug host getName vmNetworkStat getVmName toHumanReadableSize vmNetworkStat getBytesSent toHumanReadableSize vmNetworkStat getBytesReceived continue if vmNetworkStat_lock getCurrentBytesSent vmNetworkStat getBytesSent
private UserVm startVirtualMachine long vmId Long podId Long clusterId Long hostId Map Long DiskOffering diskOfferingMap Map VirtualMachineProfile Param Object additonalParams String deploymentPlannerToUse throws ResourceUnavailableException InsufficientCapacityException ConcurrentOperationException ResourceAllocationException UserVmVO vm _vmDao findById vmId Pair UserVmVO Map VirtualMachineProfile Param Object vmParamPair null try vmParamPair startVirtualMachine vmId podId clusterId hostId additonalParams deploymentPlannerToUse vm vmParamPair first UserVmVO tmpVm _vmDao findById vm getId if tmpVm getState equals State Running
try vmParamPair startVirtualMachine vmId podId clusterId hostId additonalParams deploymentPlannerToUse vm vmParamPair first UserVmVO tmpVm _vmDao findById vm getId if tmpVm getState equals State Running s_logger error tmpVm tmpVm getState throw new ConcurrentOperationException vm try if diskOfferingMap isEmpty List VolumeVO vols _volsDao findByInstance tmpVm getId for VolumeVO vol vols if vol getVolumeType Volume Type DATADISK DiskOffering doff _entityMgr findById DiskOffering class vol getDiskOfferingId _volService resizeVolumeOnHypervisor vol getId doff getDiskSize tmpVm getHostId vm getInstanceName catch Exception e
if nic getBroadcastUri getScheme equals NicProfile nicProfile new NicProfile nic network nic getBroadcastUri nic getIsolationUri false if setupVmForPvlan true hostId nicProfile return false boolean ipChanged false if originalIp null originalIp equalsIgnoreCase returnedIp if returnedIp null guestNic null guestNic setIPv4Address returnedIp ipChanged true if returnedIp null returnedIp equalsIgnoreCase originalIp if guestNic null guestNic setIPv4Address returnedIp ipChanged true if ipChanged _dcDao findById vm getDataCenterId
UserVmVO vm _vmDao findById vmId if vm null throw new InvalidParameterValueException vmId if vm getState State Running throw new InvalidParameterValueException vm getUuid vm getDisplayName _accountMgr checkAccess callerAccount null true vm Account owner _accountDao findById vm getAccountId if owner null throw new InvalidParameterValueException vm vm getAccountId if owner getState Account State disabled throw new PermissionDeniedException vm vm getAccountId if VirtualMachineManager ResoureCountRunningVMsonly value ServiceOfferingVO offering _serviceOfferingDao findById vm getId vm getServiceOfferingId resourceLimitCheck owner vm isDisplayVm new Long offering getCpu new Long offering getRamSize if _securityGroupMgr isVmSecurityGroupEnabled vmId _securityGroupMgr getSecurityGroupsForVm vmId isEmpty _securityGroupMgr isVmMappedToDefaultSecurityGroup vmId _networkModel canAddDefaultSecurityGroup
return List VmDiskStatsEntry vmDiskStats vmDiskStatsByName get userVm getInstanceName if vmDiskStats null return for VmDiskStatsEntry vmDiskStat vmDiskStats SearchCriteria VolumeVO sc_volume _volsDao createSearchCriteria sc_volume addAnd SearchCriteria Op EQ vmDiskStat getPath List VolumeVO volumes _volsDao search sc_volume null if volumes null volumes size break VolumeVO volume volumes get VmDiskStatisticsVO previousVmDiskStats _vmDiskStatsDao findBy userVm getAccountId userVm getDataCenterId userVm getId volume getId VmDiskStatisticsVO vmDiskStat_lock _vmDiskStatsDao lock userVm getAccountId userVm getDataCenterId userVm getId volume getId if vmDiskStat getIORead vmDiskStat getIOWrite vmDiskStat getBytesRead vmDiskStat getBytesWrite s_logger debug
return for VmDiskStatsEntry vmDiskStat vmDiskStats SearchCriteria VolumeVO sc_volume _volsDao createSearchCriteria sc_volume addAnd SearchCriteria Op EQ vmDiskStat getPath List VolumeVO volumes _volsDao search sc_volume null if volumes null volumes size break VolumeVO volume volumes get VmDiskStatisticsVO previousVmDiskStats _vmDiskStatsDao findBy userVm getAccountId userVm getDataCenterId userVm getId volume getId VmDiskStatisticsVO vmDiskStat_lock _vmDiskStatsDao lock userVm getAccountId userVm getDataCenterId userVm getId volume getId if vmDiskStat getIORead vmDiskStat getIOWrite vmDiskStat getBytesRead vmDiskStat getBytesWrite s_logger debug continue if vmDiskStat_lock null s_logger warn userVm getAccountId userVm getId volume getId
List VolumeVO volumes _volsDao search sc_volume null if volumes null volumes size break VolumeVO volume volumes get VmDiskStatisticsVO previousVmDiskStats _vmDiskStatsDao findBy userVm getAccountId userVm getDataCenterId userVm getId volume getId VmDiskStatisticsVO vmDiskStat_lock _vmDiskStatsDao lock userVm getAccountId userVm getDataCenterId userVm getId volume getId if vmDiskStat getIORead vmDiskStat getIOWrite vmDiskStat getBytesRead vmDiskStat getBytesWrite s_logger debug continue if vmDiskStat_lock null s_logger warn userVm getAccountId userVm getId volume getId continue if previousVmDiskStats null previousVmDiskStats getCurrentIORead vmDiskStat_lock getCurrentIORead previousVmDiskStats getCurrentIOWrite vmDiskStat_lock getCurrentIOWrite previousVmDiskStats getCurrentBytesRead vmDiskStat_lock getCurrentBytesRead previousVmDiskStats getCurrentBytesWrite vmDiskStat_lock getCurrentBytesWrite s_logger debug host getName vmDiskStat getVmName vmDiskStat getIORead vmDiskStat getIOWrite vmDiskStat getBytesRead vmDiskStat getBytesWrite continue
VmDiskStatisticsVO previousVmDiskStats _vmDiskStatsDao findBy userVm getAccountId userVm getDataCenterId userVm getId volume getId VmDiskStatisticsVO vmDiskStat_lock _vmDiskStatsDao lock userVm getAccountId userVm getDataCenterId userVm getId volume getId if vmDiskStat getIORead vmDiskStat getIOWrite vmDiskStat getBytesRead vmDiskStat getBytesWrite s_logger debug continue if vmDiskStat_lock null s_logger warn userVm getAccountId userVm getId volume getId continue if previousVmDiskStats null previousVmDiskStats getCurrentIORead vmDiskStat_lock getCurrentIORead previousVmDiskStats getCurrentIOWrite vmDiskStat_lock getCurrentIOWrite previousVmDiskStats getCurrentBytesRead vmDiskStat_lock getCurrentBytesRead previousVmDiskStats getCurrentBytesWrite vmDiskStat_lock getCurrentBytesWrite s_logger debug host getName vmDiskStat getVmName vmDiskStat getIORead vmDiskStat getIOWrite vmDiskStat getBytesRead vmDiskStat getBytesWrite continue if vmDiskStat_lock getCurrentIORead vmDiskStat getIORead if s_logger isDebugEnabled s_logger debug host getName vmDiskStat getVmName vmDiskStat getIORead vmDiskStat_lock getCurrentIORead vmDiskStat_lock setNetIORead vmDiskStat_lock getNetIORead vmDiskStat_lock getCurrentIORead
if vmDiskStat_lock null s_logger warn userVm getAccountId userVm getId volume getId continue if previousVmDiskStats null previousVmDiskStats getCurrentIORead vmDiskStat_lock getCurrentIORead previousVmDiskStats getCurrentIOWrite vmDiskStat_lock getCurrentIOWrite previousVmDiskStats getCurrentBytesRead vmDiskStat_lock getCurrentBytesRead previousVmDiskStats getCurrentBytesWrite vmDiskStat_lock getCurrentBytesWrite s_logger debug host getName vmDiskStat getVmName vmDiskStat getIORead vmDiskStat getIOWrite vmDiskStat getBytesRead vmDiskStat getBytesWrite continue if vmDiskStat_lock getCurrentIORead vmDiskStat getIORead if s_logger isDebugEnabled s_logger debug host getName vmDiskStat getVmName vmDiskStat getIORead vmDiskStat_lock getCurrentIORead vmDiskStat_lock setNetIORead vmDiskStat_lock getNetIORead vmDiskStat_lock getCurrentIORead vmDiskStat_lock setCurrentIORead vmDiskStat getIORead if vmDiskStat_lock getCurrentIOWrite vmDiskStat getIOWrite if s_logger isDebugEnabled s_logger debug host getName vmDiskStat getVmName vmDiskStat getIOWrite vmDiskStat_lock getCurrentIOWrite vmDiskStat_lock setNetIOWrite vmDiskStat_lock getNetIOWrite vmDiskStat_lock getCurrentIOWrite
String displayName cmd getDisplayName UserVm vm null IpAddresses addrs new IpAddresses ipAddress ip6Address macAddress Long size cmd getSize String group cmd getGroup String userData cmd getUserData String sshKeyPairName cmd getSSHKeyPairName Boolean displayVm cmd isDisplayVm String keyboard cmd getKeyboard Map Long DiskOffering dataDiskTemplateToDiskOfferingMap cmd getDataDiskTemplateToDiskOfferingMap Map String String userVmOVFProperties cmd getVmOVFProperties if zone getNetworkType NetworkType Basic if cmd getNetworkIds null throw new InvalidParameterValueException else
Boolean displayVm cmd isDisplayVm String keyboard cmd getKeyboard Map Long DiskOffering dataDiskTemplateToDiskOfferingMap cmd getDataDiskTemplateToDiskOfferingMap Map String String userVmOVFProperties cmd getVmOVFProperties if zone getNetworkType NetworkType Basic if cmd getNetworkIds null throw new InvalidParameterValueException else vm createBasicSecurityGroupVirtualMachine zone serviceOffering template getSecurityGroupIdList cmd owner name displayName diskOfferingId size group cmd getHypervisor cmd getHttpMethod userData sshKeyPairName cmd getIpToNetworkMap addrs displayVm keyboard cmd getAffinityGroupIdList cmd getDetails cmd getCustomId cmd getDhcpOptionsMap dataDiskTemplateToDiskOfferingMap userVmOVFProperties else if zone isSecurityGroupEnabled vm createAdvancedSecurityGroupVirtualMachine zone serviceOffering template cmd getNetworkIds getSecurityGroupIdList cmd owner name displayName diskOfferingId size group cmd getHypervisor cmd getHttpMethod userData sshKeyPairName cmd getIpToNetworkMap addrs displayVm keyboard cmd getAffinityGroupIdList cmd getDetails cmd getCustomId cmd getDhcpOptionsMap dataDiskTemplateToDiskOfferingMap userVmOVFProperties else if cmd getSecurityGroupIdList null cmd getSecurityGroupIdList isEmpty throw new InvalidParameterValueException
throw new PermissionDeniedException VMInstanceVO vm _vmInstanceDao findById vmId if vm null throw new InvalidParameterValueException vmId if vm getState State Running if s_logger isDebugEnabled s_logger debug vm InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject vm getUuid throw ex checkIfHostOfVMIsInPrepareForMaintenanceState vm getHostId vmId if serviceOfferingDetailsDao findDetail vm getServiceOfferingId GPU Keys pciDevice toString null throw new InvalidParameterValueException if isOnSupportedHypevisorForMigration vm if s_logger isDebugEnabled
if vm getState State Running if s_logger isDebugEnabled s_logger debug vm InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject vm getUuid throw ex checkIfHostOfVMIsInPrepareForMaintenanceState vm getHostId vmId if serviceOfferingDetailsDao findDetail vm getServiceOfferingId GPU Keys pciDevice toString null throw new InvalidParameterValueException if isOnSupportedHypevisorForMigration vm if s_logger isDebugEnabled s_logger debug vm vm getHypervisorType throw new InvalidParameterValueException if vm getType equals VirtualMachine Type User vm getHypervisorType equals HypervisorType LXC throw new InvalidParameterValueException
if isVMUsingLocalStorage vm if s_logger isDebugEnabled s_logger debug vm throw new InvalidParameterValueException long srcHostId vm getHostId if destinationHost getId srcHostId throw new InvalidParameterValueException if destinationHost getState com cloud host Status Up destinationHost getResourceState ResourceState Enabled throw new InvalidParameterValueException destinationHost getState destinationHost getResourceState if vm getType VirtualMachine Type User HostVO srcHost _hostDao findById srcHostId if srcHost null srcHost getClusterId null destinationHost getClusterId null if srcHost getClusterId longValue destinationHost getClusterId longValue throw new InvalidParameterValueException if dpdkHelper isVMDpdkEnabled vm getId dpdkHelper isHostDpdkEnabled destinationHost getId
private boolean isImplicitPlannerUsedByOffering long offeringId boolean implicitPlannerUsed false ServiceOfferingVO offering _serviceOfferingDao findByIdIncludingRemoved offeringId if offering null
resourceCountIncrement newAccount getAccountId vm isDisplayVm new Long offering getCpu new Long offering getRamSize UsageEventUtils publishUsageEvent EventTypes EVENT_VM_CREATE vm getAccountId vm getDataCenterId vm getId vm getHostName vm getServiceOfferingId vm getTemplateId vm getHypervisorType toString VirtualMachine class getName vm getUuid vm isDisplayVm VirtualMachine vmoi _itMgr findById vm getId VirtualMachineProfileImpl vmOldProfile new VirtualMachineProfileImpl vmoi List Long networkIdList cmd getNetworkIds List Long securityGroupIdList cmd getSecurityGroupIdList if zone getNetworkType NetworkType Basic if networkIdList null networkIdList isEmpty throw new InvalidParameterValueException _securityGroupMgr removeInstanceFromGroups cmd getVmId _networkMgr cleanupNics vmOldProfile _networkMgr expungeNics vmOldProfile List NetworkVO networkList new ArrayList NetworkVO Network defaultNetwork _networkModel getExclusiveGuestNetwork zone getId
if networkIdList null networkIdList isEmpty throw new InvalidParameterValueException _securityGroupMgr removeInstanceFromGroups cmd getVmId _networkMgr cleanupNics vmOldProfile _networkMgr expungeNics vmOldProfile List NetworkVO networkList new ArrayList NetworkVO Network defaultNetwork _networkModel getExclusiveGuestNetwork zone getId if defaultNetwork null throw new InvalidParameterValueException else networkList add _networkDao findById defaultNetwork getId boolean isVmWare template getHypervisorType HypervisorType VMware if securityGroupIdList null isVmWare throw new InvalidParameterValueException else if isVmWare _networkModel isSecurityGroupSupportedInNetwork defaultNetwork _networkModel canAddDefaultSecurityGroup
_networkModel checkNetworkPermissions newAccount defaultNetworkOld applicableNetworks add defaultNetworkOld requestedIPv4ForDefaultNic defaultNicOld getIPv4Address requestedIPv6ForDefaultNic defaultNicOld getIPv6Address s_logger debug defaultNetworkOld getName requestedIPv4ForDefaultNic vm getInstanceName catch PermissionDeniedException e s_logger debug _networkMgr cleanupNics vmOldProfile _networkMgr expungeNics vmOldProfile if networkIdList null networkIdList isEmpty for Long networkId networkIdList NetworkVO network _networkDao findById networkId if network null InvalidParameterValueException ex new InvalidParameterValueException ex addProxyObject networkId toString
SecurityGroup defaultGroup _securityGroupMgr getDefaultSecurityGroup newAccount getId if defaultGroup null boolean defaultGroupPresent false for Long securityGroupId securityGroupIdList if securityGroupId longValue defaultGroup getId defaultGroupPresent true break if defaultGroupPresent securityGroupIdList add defaultGroup getId else if s_logger isDebugEnabled s_logger debug newAccount defaultGroup _securityGroupMgr createSecurityGroup SecurityGroupManager DEFAULT_GROUP_NAME SecurityGroupManager DEFAULT_GROUP_DESCRIPTION newAccount getDomainId newAccount getId newAccount getAccountName securityGroupIdList add defaultGroup getId VirtualMachine vmi _itMgr findById vm getId
Set NetworkVO applicableNetworks new HashSet NetworkVO if networkIdList null networkIdList isEmpty NicVO defaultNicOld _nicDao findDefaultNicForVM vm getId if defaultNicOld null NetworkVO defaultNetworkOld _networkDao findById defaultNicOld getNetworkId if defaultNetworkOld null defaultNetworkOld getGuestType Network GuestType Shared defaultNetworkOld getAclType ACLType Domain try _networkModel checkNetworkPermissions newAccount defaultNetworkOld applicableNetworks add defaultNetworkOld catch PermissionDeniedException e s_logger debug _networkMgr cleanupNics vmOldProfile _networkMgr expungeNics vmOldProfile if networkIdList null networkIdList isEmpty for Long networkId networkIdList
NicVO defaultNicOld _nicDao findDefaultNicForVM vm getId if defaultNicOld null NetworkVO defaultNetworkOld _networkDao findById defaultNicOld getNetworkId if defaultNetworkOld null defaultNetworkOld getGuestType Network GuestType Shared defaultNetworkOld getAclType ACLType Domain try _networkModel checkNetworkPermissions newAccount defaultNetworkOld applicableNetworks add defaultNetworkOld catch PermissionDeniedException e s_logger debug _networkMgr cleanupNics vmOldProfile _networkMgr expungeNics vmOldProfile if networkIdList null networkIdList isEmpty for Long networkId networkIdList NetworkVO network _networkDao findById networkId if network null
catch ResourceUnavailableException e s_logger debug vm getUuid e CloudRuntimeException ex new CloudRuntimeException ex addProxyObject vm getUuid throw ex Volume newVol null if newTemplateId null if isISO newVol volumeMgr allocateDuplicateVolume root null vm setIsoId newTemplateId vm setGuestOSId template getGuestOSId vm setTemplateId newTemplateId _vmDao update vmId vm else newVol volumeMgr allocateDuplicateVolume root newTemplateId
throw ex Volume newVol null if newTemplateId null if isISO newVol volumeMgr allocateDuplicateVolume root null vm setIsoId newTemplateId vm setGuestOSId template getGuestOSId vm setTemplateId newTemplateId _vmDao update vmId vm else newVol volumeMgr allocateDuplicateVolume root newTemplateId vm setGuestOSId template getGuestOSId vm setTemplateId newTemplateId _vmDao update vmId vm else
_usageEventDao persist usageEvent handleManagedStorage vm root _volsDao attachVolume newVol getId vmId newVol getDeviceId _volsDao detachVolume root getId volumeMgr destroyVolume root if vm getHypervisorType HypervisorType VMware VolumeInfo volumeInStorage volFactory getVolume root getId if volumeInStorage null s_logger info root getId AsyncCallFuture VolumeApiResult future _volService expungeVolumeAsync volFactory getVolume root getId try future get catch Exception e s_logger debug root getId e Map VirtualMachineProfile Param Object params null
if vm getHypervisorType HypervisorType VMware VolumeInfo volumeInStorage volFactory getVolume root getId if volumeInStorage null s_logger info root getId AsyncCallFuture VolumeApiResult future _volService expungeVolumeAsync volFactory getVolume root getId try future get catch Exception e s_logger debug root getId e Map VirtualMachineProfile Param Object params null String password null if template isEnablePassword password _mgr generateRandomPassword boolean result resetVMPasswordInternal vmId password if result
Override public void persistDeviceBusInfo UserVmVO vm String rootDiskController String existingVmRootDiskController vm getDetail VmDetailConstants ROOT_DISK_CONTROLLER if StringUtils isEmpty existingVmRootDiskController StringUtils isEmpty rootDiskController vm setDetail VmDetailConstants ROOT_DISK_CONTROLLER rootDiskController _vmDao saveDetails vm if s_logger isDebugEnabled
List VolumeVO listVolumes null if type Volume Type ROOT listVolumes _volsDao findByInstanceAndType vmId type else if type Volume Type DATADISK listVolumes _volsDao findByInstanceAndType vmId type else listVolumes _volsDao findByInstance vmId s_logger debug listVolumes size type vmId for VolumeVO volume listVolumes Long volumeId volume getId s_logger debug volumeId List SnapshotVO ongoingSnapshots _snapshotDao listByStatus volumeId Snapshot State Creating Snapshot State CreatedOnPrimary Snapshot State BackingUp int ongoingSnapshotsCount ongoingSnapshots size s_logger debug vmId type ongoingSnapshotsCount if ongoingSnapshotsCount
private void detachVolumesFromVm List VolumeVO volumes for VolumeVO volume volumes Volume detachResult _volumeService detachVolumeViaDestroyVM volume getInstanceId volume getId if detachResult null
private void deleteVolumesFromVm List VolumeVO volumes for VolumeVO volume volumes boolean deleteResult _volumeService deleteVolume volume getId CallContext current getCallingAccount if deleteResult
if vm getState State Running vm getState State Stopped s_logger debug vmId return false if vm getHypervisorType Hypervisor HypervisorType VMware throw new UnsupportedServiceException List VolumeVO volumes _volsDao findByInstance vm getId checkUnmanagingVMOngoingVolumeSnapshots vm checkUnmanagingVMVolumes vm volumes result _itMgr unmanage vm getUuid if result cleanupUnmanageVMResources vm getId unmanageVMFromDB vm getId publishUnmanageVMUsageEvents vm volumes else throw new CloudRuntimeException vm getUuid
private void checkUnmanagingVMOngoingVolumeSnapshots UserVmVO vm
if userVmVo getHypervisorType HypervisorType KVM userVmVo getState State Running snapshotMemory throw new InvalidParameterValueException _accountMgr checkAccess caller null true userVmVo if _vmSnapshotDao findByVm vmId size _vmSnapshotMax throw new CloudRuntimeException _vmSnapshotMax List VolumeVO listVolumes _volumeDao findByInstance vmId for VolumeVO volume listVolumes List SnapshotVO activeSnapshots _snapshotDao listByInstanceId volume getInstanceId Snapshot State Creating Snapshot State CreatedOnPrimary Snapshot State BackingUp if activeSnapshots size throw new CloudRuntimeException if userVmVo getHypervisorType HypervisorType KVM volume getFormat ImageFormat QCOW2 throw new CloudRuntimeException if hasActiveVMSnapshotTasks vmId throw new CloudRuntimeException VMSnapshot Type vmSnapshotType VMSnapshot Type Disk
List VolumeVO volumeVos _volumeDao findByInstanceAndType vmId Type ROOT if volumeVos null volumeVos isEmpty throw new CloudRuntimeException VolumeVO rootVolume volumeVos get if rootVolume getState equals Volume State Ready throw new CloudRuntimeException vmId rootVolume getState VMSnapshotVO vmSnapshot _vmSnapshotDao findById vmSnapshotId if vmSnapshot null throw new CloudRuntimeException vmSnapshotId VMSnapshotOptions options new VMSnapshotOptions quiescevm vmSnapshot setOptions options try VMSnapshotStrategy strategy findVMSnapshotStrategy vmSnapshot VMSnapshot snapshot strategy takeVMSnapshot vmSnapshot return snapshot
_accountMgr checkAccess caller null true vmSnapshot List VMSnapshot State validStates Arrays asList VMSnapshot State Ready VMSnapshot State Expunging VMSnapshot State Error VMSnapshot State Allocated if validStates contains vmSnapshot getState throw new InvalidParameterValueException vmSnapshotId validStates toString if hasActiveVMSnapshotTasks vmSnapshot getVmId List VMSnapshotVO expungingSnapshots _vmSnapshotDao listByInstanceId vmSnapshot getVmId VMSnapshot State Expunging if expungingSnapshots size expungingSnapshots get getId vmSnapshot getId s_logger debug vmSnapshot getDisplayName else throw new InvalidParameterValueException if vmSnapshot getState VMSnapshot State Allocated return _vmSnapshotDao remove vmSnapshot getId else try VMSnapshotStrategy strategy findVMSnapshotStrategy vmSnapshot return strategy deleteVMSnapshot vmSnapshot catch Exception e
protected boolean upgradeUserVmServiceOffering Long vmId Long serviceOfferingId Map String String details boolean result try result _userVmManager upgradeVirtualMachine vmId serviceOfferingId details if result
if hasActiveVMSnapshotTasks vmId throw new InvalidParameterValueException Account caller getCaller _accountMgr checkAccess caller null true vmSnapshotVo if userVm getState VirtualMachine State Running userVm getState VirtualMachine State Stopped throw new InvalidParameterValueException if vmSnapshotVo getState VMSnapshot State Ready throw new InvalidParameterValueException UserVmVO vm null Long hostId null if userVm getState VirtualMachine State Stopped vmSnapshotVo getType VMSnapshot Type DiskAndMemory try _itMgr advanceStart userVm getUuid new HashMap VirtualMachineProfile Param Object null vm _userVMDao findById userVm getId hostId vm getHostId
throw new InvalidParameterValueException if vmSnapshotVo getState VMSnapshot State Ready throw new InvalidParameterValueException UserVmVO vm null Long hostId null if userVm getState VirtualMachine State Stopped vmSnapshotVo getType VMSnapshot Type DiskAndMemory try _itMgr advanceStart userVm getUuid new HashMap VirtualMachineProfile Param Object null vm _userVMDao findById userVm getId hostId vm getHostId catch Exception e s_logger error userVm getInstanceName e getMessage throw new CloudRuntimeException e getMessage else if userVm getState VirtualMachine State Running vmSnapshotVo getType VMSnapshot Type Disk
s_logger error userVm getInstanceName e getMessage throw new CloudRuntimeException e getMessage else if userVm getState VirtualMachine State Running vmSnapshotVo getType VMSnapshot Type Disk try _itMgr advanceStop userVm getUuid true catch Exception e s_logger error userVm getInstanceName e getMessage throw new CloudRuntimeException e getMessage if hasActiveVMSnapshotTasks userVm getId throw new InvalidParameterValueException try VMSnapshotStrategy strategy findVMSnapshotStrategy vmSnapshotVo strategy revertVMSnapshot vmSnapshotVo Transaction execute new TransactionCallbackWithExceptionNoReturn CloudRuntimeException
ControlledEntity ACLType aclType null Account owner null boolean domainLevel false if projectId null domainId null accountName null verifyAccessToDomainWideProcessor caller processor DomainVO domain getDomain domainId _accountMgr checkAccess caller domain owner _accountMgr getAccount Account ACCOUNT_ID_SYSTEM aclType ControlledEntity ACLType Domain domainLevel true else owner _accountMgr finalizeOwner caller accountName domainId projectId aclType ControlledEntity ACLType Account verifyAffinityGroupNameInUse owner getAccountId owner getDomainId affinityGroupName verifyDomainLevelAffinityGroupName domainLevel owner getDomainId affinityGroupName
Override DB ActionEvent eventType EventTypes EVENT_AFFINITY_GROUP_DELETE eventDescription public boolean deleteAffinityGroup Long affinityGroupId String account Long projectId Long domainId String affinityGroupName AffinityGroupVO group getAffinityGroup affinityGroupId account projectId domainId affinityGroupName Account caller CallContext current getCallingAccount _accountMgr checkAccess caller AccessType OperateEntry true group final Long affinityGroupIdFinal group getId deleteAffinityGroup affinityGroupIdFinal Pair Class Long params new Pair Class Long AffinityGroup class affinityGroupIdFinal _messageBus publish _name EntityManager MESSAGE_REMOVE_ENTITY_EVENT PublishScope LOCAL params if s_logger isDebugEnabled
for Long affinityGroupId affinityGroupIds AffinityGroupVO ag _affinityGroupDao findById affinityGroupId if ag null throw new InvalidParameterValueException affinityGroupId else if ag getAclType ACLType Domain _accountMgr checkAccess caller null false owner ag if caller getId Account ACCOUNT_ID_SYSTEM _accountMgr isRootAdmin caller getId if isAffinityGroupAvailableInDomain ag getId owner getDomainId throw new PermissionDeniedException ag else _accountMgr checkAccess caller null true owner ag if caller getId Account ACCOUNT_ID_SYSTEM _accountMgr isRootAdmin caller getId if ag getAccountId owner getAccountId throw new PermissionDeniedException ag
Override ActionEvent eventType EventTypes EVENT_ANNOTATION_REMOVE eventDescription public AnnotationResponse removeAnnotation RemoveAnnotationCmd removeAnnotationCmd String uuid removeAnnotationCmd getUuid if LOGGER isDebugEnabled
private List AnnotationVO getAnnotationsForApiCmd ListAnnotationsCmd cmd List AnnotationVO annotations if cmd getUuid null annotations new ArrayList String uuid cmd getUuid toString if LOGGER isDebugEnabled
private List AnnotationVO getAnnotationsForApiCmd ListAnnotationsCmd cmd List AnnotationVO annotations if cmd getUuid null annotations new ArrayList String uuid cmd getUuid toString if LOGGER isDebugEnabled LOGGER debug uuid annotations add annotationDao findByUuid uuid else if cmd getEntityType null cmd getEntityType isEmpty String type cmd getEntityType if LOGGER isDebugEnabled LOGGER debug type if cmd getEntityUuid null String uuid cmd getEntityUuid toString if LOGGER isDebugEnabled
validateForZone backup getZoneId final VMInstanceVO vm vmInstanceDao findById vmId if vm null throw new CloudRuntimeException accountManager checkAccess CallContext current getCallingAccount null true vm if vm getBackupOfferingId null throw new CloudRuntimeException if backup getZoneId vm getDataCenterId throw new CloudRuntimeException final VMInstanceVO vmFromBackup vmInstanceDao findByIdIncludingRemoved backup getVmId if vmFromBackup null throw new CloudRuntimeException accountManager checkAccess CallContext current getCallingAccount null true vmFromBackup Pair String String restoreInfo getRestoreVolumeHostAndDatastore vm String hostIp restoreInfo first
private void checkStatusOfCurrentlyExecutingBackups final SearchCriteria BackupScheduleVO sc backupScheduleDao createSearchCriteria sc addAnd SearchCriteria Op NNULL final List BackupScheduleVO backupSchedules backupScheduleDao search sc null for final BackupScheduleVO backupSchedule backupSchedules final Long asyncJobId backupSchedule getAsyncJobId final AsyncJobVO asyncJob asyncJobManager getAsyncJob asyncJobId switch asyncJob getStatus case SUCCEEDED case FAILED final Date nextDateTime scheduleNextBackupJob backupSchedule final String nextScheduledTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE nextDateTime
DB public void scheduleBackups String displayTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE currentTimestamp
for final BackupScheduleVO backupSchedule backupsToBeExecuted final Long backupScheduleId backupSchedule getId final Long vmId backupSchedule getVmId final VMInstanceVO vm vmInstanceDao findById vmId if vm null vm getBackupOfferingId null backupScheduleDao remove backupScheduleId continue final BackupOffering offering backupOfferingDao findById vm getBackupOfferingId if offering null offering isUserDrivenBackupAllowed continue if isDisabled vm getDataCenterId continue final Account backupAccount accountService getAccount vm getAccountId if backupAccount null backupAccount getState Account State disabled if LOG isDebugEnabled
backupScheduleDao remove backupScheduleId continue final BackupOffering offering backupOfferingDao findById vm getBackupOfferingId if offering null offering isUserDrivenBackupAllowed continue if isDisabled vm getDataCenterId continue final Account backupAccount accountService getAccount vm getAccountId if backupAccount null backupAccount getState Account State disabled if LOG isDebugEnabled LOG debug vm getUuid continue if LOG isDebugEnabled final Date scheduledTimestamp backupSchedule getScheduledTimestamp displayTime DateUtil displayDateInTimezone DateUtil GMT_TIMEZONE scheduledTimestamp
if sshAccessDetails null sshAccessDetails isEmpty cmd setAccessDetail sshAccessDetails CallContext current setEventDetails host getId final SetupCertificateAnswer answer SetupCertificateAnswer agentManager send host getId cmd if answer getResult CallContext current setEventDetails host getId else CallContext current setEventDetails host getId if answer getResult getActiveCertificatesMap put host getPrivateIpAddress certificate getClientCertificate if sshAccessDetails null reconnect null reconnect LOG info String format host getId host getName host getPublicIpAddress try agentManager reconnect host getId catch AgentUnavailableException CloudRuntimeException e
private Answer deleteDiagnosticsZipFileInsystemVm VMInstanceVO vmInstance String zipFileName final DeleteFileInVrCommand cmd new DeleteFileInVrCommand zipFileName configureNetworkElementCommand cmd vmInstance final Answer fileCleanupAnswer agentManager easySend vmInstance getHostId cmd if fileCleanupAnswer null
private Pair Boolean String copyToSecondaryStorageVMware final DataStore store final String vmSshIp String diagnosticsFile
private Pair Boolean String copyToSecondaryStorageVMware final DataStore store final String vmSshIp String diagnosticsFile LOGGER info String format diagnosticsFile vmSshIp store getUri boolean success false String mountPoint mountManager getMountPoint store getUri imageStoreDetailsUtil getNfsVersion store getId if StringUtils isBlank mountPoint
String mountPoint mountManager getMountPoint store getUri imageStoreDetailsUtil getNfsVersion store getId if StringUtils isBlank mountPoint LOGGER error store getName return new Pair false store getName String dataDirectoryInSecondaryStore String format mountPoint DIAGNOSTICS_DIRECTORY try File dataDirectory new File dataDirectoryInSecondaryStore boolean existsInSecondaryStore dataDirectory exists dataDirectory mkdir if existsInSecondaryStore File permKey new File SshHelper scpFrom vmSshIp permKey dataDirectoryInSecondaryStore diagnosticsFile File fileInSecondaryStore new File dataDirectoryInSecondaryStore diagnosticsFile replace success fileInSecondaryStore exists catch Exception e String msg String format vmSshIp dataDirectoryInSecondaryStore
private VMInstanceVO getSystemVMInstance Long vmId VMInstanceVO vmInstance instanceDao findByIdTypes vmId VirtualMachine Type ConsoleProxy VirtualMachine Type DomainRouter VirtualMachine Type SecondaryStorageVm if vmInstance null String msg String format vmId
throw new CloudRuntimeException templateId Map String String details template getDetails String url template getUrl String checksum template getChecksum Map String String headers getHeadersFromDetails details DataStore store dataStoreManager getDataStore poolId DataStoreRole Primary if store null throw new CloudRuntimeException poolId PrimaryDataStore primaryDataStore PrimaryDataStore store PrimaryDataStoreTO to PrimaryDataStoreTO primaryDataStore getTO DownloadProtocol protocol getProtocolFromUrl url DirectDownloadCommand cmd getDirectDownloadCommandFromProtocol protocol url templateId to checksum headers cmd setTemplateSize template getSize cmd setIso template getFormat ImageFormat ISO Answer answer sendDirectDownloadCommand cmd template poolId host
private Answer sendDirectDownloadCommand DirectDownloadCommand cmd VMTemplateVO template long poolId HostVO host boolean downloaded false int retry StoragePoolVO storagePoolVO primaryDataStoreDao findById poolId Long hostsToRetry getHostsToRetryOn host storagePoolVO int hostIndex Answer answer null Long hostToSendDownloadCmd hostsToRetry hostIndex boolean continueRetrying true while downloaded retry continueRetrying
DirectDownloadCertificateVO certificateVO HypervisorType hypervisorType HypervisorType getType hypervisor if hostId null hosts getRunningHostsToUploadCertificate zoneId hypervisorType String certificatePem getPretifiedCertificate certificateCer certificateSanity certificatePem certificateVO directDownloadCertificateDao findByAlias alias hypervisorType zoneId if certificateVO null throw new CloudRuntimeException alias certificateVO new DirectDownloadCertificateVO alias certificatePem hypervisorType zoneId directDownloadCertificateDao persist certificateVO else HostVO host hostDao findById hostId hosts Collections singletonList host certificateVO directDownloadCertificateDao findByAlias alias hypervisorType zoneId
hosts getRunningHostsToUploadCertificate zoneId hypervisorType String certificatePem getPretifiedCertificate certificateCer certificateSanity certificatePem certificateVO directDownloadCertificateDao findByAlias alias hypervisorType zoneId if certificateVO null throw new CloudRuntimeException alias certificateVO new DirectDownloadCertificateVO alias certificatePem hypervisorType zoneId directDownloadCertificateDao persist certificateVO else HostVO host hostDao findById hostId hosts Collections singletonList host certificateVO directDownloadCertificateDao findByAlias alias hypervisorType zoneId if certificateVO null s_logger info zoneId return false
else HostVO host hostDao findById hostId hosts Collections singletonList host certificateVO directDownloadCertificateDao findByAlias alias hypervisorType zoneId if certificateVO null s_logger info zoneId return false s_logger info alias hosts size zoneId int hostCount if CollectionUtils isNotEmpty hosts for HostVO host hosts if uploadCertificate certificateVO getId host getId String msg alias host getName host getUuid s_logger error msg throw new CloudRuntimeException msg
List DirectDownloadCertificateHostMapVO maps null if hostId null maps directDownloadCertificateHostMapDao listByCertificateId certificateVO getId else DirectDownloadCertificateHostMapVO hostMap directDownloadCertificateHostMapDao findByCertificateAndHost certificateVO getId hostId if hostMap null s_logger info certificateAlias hostId return false maps Collections singletonList hostMap s_logger info certificateAlias maps size if CollectionUtils isNotEmpty maps for DirectDownloadCertificateHostMapVO map maps Long mappingHostId map getHostId if revokeCertificateAliasFromHost certificateAlias mappingHostId String msg mappingHostId
maps directDownloadCertificateHostMapDao listByCertificateId certificateVO getId else DirectDownloadCertificateHostMapVO hostMap directDownloadCertificateHostMapDao findByCertificateAndHost certificateVO getId hostId if hostMap null s_logger info certificateAlias hostId return false maps Collections singletonList hostMap s_logger info certificateAlias maps size if CollectionUtils isNotEmpty maps for DirectDownloadCertificateHostMapVO map maps Long mappingHostId map getHostId if revokeCertificateAliasFromHost certificateAlias mappingHostId String msg mappingHostId s_logger error msg throw new CloudRuntimeException msg
public Boolean isVMAliveOnHost final Host host throws Investigator UnknownVM final HAConfig haConfig haConfigDao findHAResource host getId HAResource ResourceType Host if haConfig null if haConfig getState HAConfig HAState Fenced if LOG isDebugEnabled
public Status getHostStatus final Host host final HAConfig haConfig haConfigDao findHAResource host getId HAResource ResourceType Host if haConfig null if haConfig getState HAConfig HAState Fenced if LOG isDebugEnabled
Override public void fenceSubResources final Host r if r getState Status Down try
protected Ip getSourceIp Scheme scheme Network sourceIpNtwk String requestedIp throws InsufficientVirtualNetworkCapacityException if requestedIp null if _lbDao countBySourceIp new Ip requestedIp sourceIpNtwk getId
if certId null certVO _sslCertDao findById certId if certVO null throw new InvalidParameterValueException certId _accountMgr checkAccess caller SecurityChecker AccessType UseEntry true certVO certLbMap _lbCertDao listByCertId certId certResponseList add createCertResponse certVO certLbMap return certResponseList if lbRuleId null final LoadBalancer lb _entityMgr findById LoadBalancerVO class lbRuleId if lb null throw new InvalidParameterValueException lbRuleId _accountMgr checkAccess caller SecurityChecker AccessType UseEntry true lb LoadBalancerCertMapVO lbCertMapRule lbCertMapRule _lbCertDao findByLbRuleId lbRuleId
Override public boolean associatePublicIP final Network network final List extends PublicIpAddress ipAddresses final VirtualRouter router throws ResourceUnavailableException if ipAddresses null ipAddresses isEmpty
Override public boolean applyNetworkACLs final Network network final List extends NetworkACLItem rules final VirtualRouter router final boolean isPrivateGateway throws ResourceUnavailableException if rules null rules isEmpty
Override public boolean visit final PrivateGatewayRules privateGW throws ResourceUnavailableException final VirtualRouter router privateGW getRouter final NicProfile nicProfile privateGW getNicProfile final boolean isAddOperation privateGW isAddOperation if router getState State Running final PrivateIpVO ipVO privateGW retrivePrivateIP this final Network network privateGW retrievePrivateNetwork this final String netmask NetUtils getCidrNetmask network getCidr final PrivateIpAddress ip new PrivateIpAddress ipVO network getBroadcastUri toString network getGateway netmask nicProfile getMacAddress final List PrivateIpAddress privateIps new ArrayList PrivateIpAddress privateIps add ip final Commands cmds new Commands Command OnError Stop _commandSetupHelper createVpcAssociatePrivateIPCommands router privateIps cmds isAddOperation try if _networkGeneralHelper sendCommandsToRouter router cmds
final List PrivateIpAddress privateIps new ArrayList PrivateIpAddress privateIps add ip final Commands cmds new Commands Command OnError Stop _commandSetupHelper createVpcAssociatePrivateIPCommands router privateIps cmds isAddOperation try if _networkGeneralHelper sendCommandsToRouter router cmds s_logger debug ip network return true else s_logger warn ip network return false catch final Exception ex s_logger warn isAddOperation network return false else if router getState State Stopped router getState State Stopping
Override public boolean applyLoadBalancingRules final Network network final List LoadBalancingRule rules final VirtualRouter router throws ResourceUnavailableException if rules null rules isEmpty
Override public boolean applyFirewallRules final Network network final List extends FirewallRule rules final VirtualRouter router throws ResourceUnavailableException if rules null rules isEmpty
Override public boolean applyStaticNats final Network network final List extends StaticNat rules final VirtualRouter router throws ResourceUnavailableException if rules null rules isEmpty
Override public boolean associatePublicIP final Network network final List extends PublicIpAddress ipAddress final VirtualRouter router throws ResourceUnavailableException if ipAddress null ipAddress isEmpty
private void sendAuthError final Host host final String message try hostAlertCache asMap putIfAbsent host getId 0L Long sentCount hostAlertCache asMap get host getId if sentCount null sentCount boolean concurrentUpdateResult hostAlertCache asMap replace host getId sentCount sentCount 1L if concurrentUpdateResult final String subject String format host getId host getClusterId host getDataCenterId
Long actionTimeOut timeout if actionTimeOut null actionTimeOut ActionTimeout valueIn host getClusterId final OutOfBandManagementDriverPowerCommand cmd new OutOfBandManagementDriverPowerCommand options actionTimeOut powerOperation final OutOfBandManagementDriverResponse driverResponse driver execute cmd if driverResponse null throw new CloudRuntimeException String format powerOperation host getUuid if powerOperation equals OutOfBandManagement PowerOperation STATUS transitionPowerState driverResponse toEvent outOfBandManagementConfig if driverResponse isSuccess String errorMessage String format powerOperation host getUuid driverResponse getError if driverResponse hasAuthFailure errorMessage String format powerOperation host getUuid driverResponse getError sendAuthError host errorMessage if powerOperation equals OutOfBandManagement PowerOperation STATUS
Override public boolean configure final String name final Map String Object params throws ConfigurationException this name name this serviceId ManagementServerNode getManagementServerId final int poolSize SyncThreadPoolSize value hostAlertCache CacheBuilder newBuilder concurrencyLevel weakKeys maximumSize poolSize expireAfterWrite TimeUnit DAYS build backgroundSyncBlockingExecutor new ThreadPoolExecutor poolSize poolSize 0L TimeUnit MILLISECONDS new ArrayBlockingQueue Runnable poolSize true new ThreadPoolExecutor CallerRunsPolicy backgroundPollManager submitTask new OutOfBandManagementPowerStatePollTask
if client executeMethod method InputStream is method getResponseBodyAsStream XStream xstream new XStream new DomDriver xstream alias RegionAccount class xstream alias RegionUser class xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionUser class xstream aliasField RegionUser class try ObjectInputStream in xstream createObjectInputStream is return RegionAccount in readObject catch IOException e
xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionUser class xstream aliasField RegionUser class try ObjectInputStream in xstream createObjectInputStream is return RegionAccount in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e
xstream aliasField RegionAccount class xstream aliasField RegionAccount class xstream aliasField RegionUser class xstream aliasField RegionUser class try ObjectInputStream in xstream createObjectInputStream is return RegionAccount in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e s_logger error e getMessage return null catch IOException e
xstream aliasField RegionUser class try ObjectInputStream in xstream createObjectInputStream is return RegionAccount in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e s_logger error e getMessage return null catch IOException e s_logger error e getMessage return null catch ClassNotFoundException e
protected static RegionDomain makeDomainAPICall Region region String command List NameValuePair params try String url buildUrl buildParams command params region HttpClient client new HttpClient HttpMethod method new GetMethod url if client executeMethod method InputStream is method getResponseBodyAsStream XStream xstream new XStream new DomDriver xstream alias RegionDomain class xstream aliasField RegionDomain class xstream aliasField RegionDomain class xstream aliasField DomainVO class try ObjectInputStream in xstream createObjectInputStream is return RegionDomain in readObject catch IOException e
if client executeMethod method InputStream is method getResponseBodyAsStream XStream xstream new XStream new DomDriver xstream alias RegionDomain class xstream aliasField RegionDomain class xstream aliasField RegionDomain class xstream aliasField DomainVO class try ObjectInputStream in xstream createObjectInputStream is return RegionDomain in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e
xstream alias RegionDomain class xstream aliasField RegionDomain class xstream aliasField RegionDomain class xstream aliasField DomainVO class try ObjectInputStream in xstream createObjectInputStream is return RegionDomain in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e s_logger error e getMessage return null catch IOException e
xstream aliasField DomainVO class try ObjectInputStream in xstream createObjectInputStream is return RegionDomain in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e s_logger error e getMessage return null catch IOException e s_logger error e getMessage return null catch ClassNotFoundException e
HttpClient client new HttpClient HttpMethod method new GetMethod url if client executeMethod method InputStream is method getResponseBodyAsStream XStream xstream new XStream new DomDriver xstream alias UserAccountVO class xstream aliasField UserAccountVO class try ObjectInputStream in xstream createObjectInputStream is return UserAccountVO in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e
InputStream is method getResponseBodyAsStream XStream xstream new XStream new DomDriver xstream alias UserAccountVO class xstream aliasField UserAccountVO class try ObjectInputStream in xstream createObjectInputStream is return UserAccountVO in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e s_logger error e getMessage return null catch IOException e
xstream aliasField UserAccountVO class try ObjectInputStream in xstream createObjectInputStream is return UserAccountVO in readObject catch IOException e s_logger error e getMessage return null else return null catch HttpException e s_logger error e getMessage return null catch IOException e s_logger error e getMessage return null catch ClassNotFoundException e
if NetUtils verifyDomainName domainName throw new InvalidParameterValueException domainName GlobalLoadBalancerRuleVO gslbRuleWithDomainName _gslbRuleDao findByDomainName domainName if gslbRuleWithDomainName null throw new InvalidParameterValueException domainName Region region _regionDao findById regionId if region null throw new InvalidParameterValueException regionId String providerDnsName _globalConfigDao getValue Config CloudDnsName key if region checkIfServiceEnabled Region Service Gslb providerDnsName null throw new CloudRuntimeException region getName GlobalLoadBalancerRuleVO newGslbRule Transaction execute new TransactionCallback GlobalLoadBalancerRuleVO Override public GlobalLoadBalancerRuleVO doInTransaction TransactionStatus status GlobalLoadBalancerRuleVO newGslbRule new GlobalLoadBalancerRuleVO name description domainName algorithm stickyMethod serviceType regionId gslbOwner getId gslbOwner getDomainId GlobalLoadBalancerRule State Staged _gslbRuleDao persist newGslbRule
CallContext ctx CallContext current Account caller ctx getCallingAccount _accountMgr checkAccess caller SecurityChecker AccessType OperateEntry true gslbRule if algorithm null GlobalLoadBalancerRule Algorithm isValidAlgorithm algorithm throw new InvalidParameterValueException algorithm if stickyMethod null GlobalLoadBalancerRule Persistence isValidPersistence stickyMethod throw new InvalidParameterValueException stickyMethod if algorithm null gslbRule setAlgorithm algorithm if stickyMethod null gslbRule setPersistence stickyMethod if description null gslbRule setDescription description gslbRule setState GlobalLoadBalancerRule State Add _gslbRuleDao update gslbRule getId gslbRule
throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format userVm getInstanceName if hostSupportsServiceOffering sourceHost serviceOffering LOGGER debug String format vm getUuid final VirtualMachineProfile profile new VirtualMachineProfileImpl vm template serviceOffering owner null DeploymentPlanner ExcludeList excludeList new DeploymentPlanner ExcludeList excludeList addHost sourceHost getId final DataCenterDeployment plan new DataCenterDeployment sourceHost getDataCenterId sourceHost getPodId sourceHost getClusterId null null null DeployDestination dest null try dest deploymentPlanningManager planDeployment profile plan excludeList null catch Exception e LOGGER warn String format vm getInstanceName e cleanupFailedImportVM vm throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format vm getInstanceName if dest null
cleanupFailedImportVM vm throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format vm getInstanceName if dest null if LOGGER isDebugEnabled LOGGER debug dest if dest null cleanupFailedImportVM vm throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format vm getInstanceName try if vm getState equals VirtualMachine State Stopped VMInstanceVO vmInstanceVO vmDao findById userVm getId vmInstanceVO setHostId dest getHost getId vmInstanceVO setLastHostId dest getHost getId vmDao update vmInstanceVO getId vmInstanceVO else
else virtualMachineManager migrate vm getUuid sourceHost getId dest vm userVmManager getUserVm vm getId catch Exception e LOGGER error String format vm getInstanceName e cleanupFailedImportVM vm throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format userVm getInstanceName e getMessage for Pair DiskProfile StoragePool diskProfileStoragePool diskProfileStoragePoolList if diskProfileStoragePool null diskProfileStoragePool first null diskProfileStoragePool second null continue DiskProfile profile diskProfileStoragePool first DiskOffering dOffering diskOfferingDao findById profile getDiskOfferingId if dOffering null continue VolumeVO volumeVO volumeDao findById profile getVolumeId
if volumeVO null continue boolean poolSupportsOfferings storagePoolSupportsDiskOffering diskProfileStoragePool second dOffering if poolSupportsOfferings profile getType Volume Type ROOT poolSupportsOfferings storagePoolSupportsServiceOffering diskProfileStoragePool second serviceOffering if poolSupportsOfferings continue LOGGER debug String format volumeVO getUuid Pair List extends StoragePool List extends StoragePool poolsPair managementService listStoragePoolsForMigrationOfVolume profile getVolumeId if CollectionUtils isEmpty poolsPair first CollectionUtils isEmpty poolsPair second cleanupFailedImportVM vm throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format userVm getInstanceName volumeVO getUuid List extends StoragePool storagePools poolsPair second StoragePool storagePool null if CollectionUtils isNotEmpty storagePools
List extends StoragePool storagePools poolsPair second StoragePool storagePool null if CollectionUtils isNotEmpty storagePools for StoragePool pool storagePools if diskProfileStoragePool second getId pool getId storagePoolSupportsDiskOffering pool dOffering profile getType equals Volume Type ROOT profile getType equals Volume Type ROOT storagePoolSupportsServiceOffering pool serviceOffering storagePool pool break if storagePool null CollectionUtils isNotEmpty poolsPair first storagePools poolsPair first for StoragePool pool storagePools if diskProfileStoragePool second getId pool getId storagePoolSupportsDiskOffering pool dOffering profile getType equals Volume Type ROOT profile getType equals Volume Type ROOT storagePoolSupportsServiceOffering pool serviceOffering storagePool pool break if storagePool null cleanupFailedImportVM vm
else UsageEventUtils publishUsageEvent EventTypes EVENT_VM_CREATE userVm getAccountId userVm getAccountId userVm getDataCenterId userVm getHostName serviceOfferingVO getId userVm getTemplateId userVm getHypervisorType toString VirtualMachine class getName userVm getUuid userVm getDetails userVm isDisplayVm if userVm getState VirtualMachine State Running UsageEventUtils publishUsageEvent EventTypes EVENT_VM_START userVm getAccountId userVm getDataCenterId userVm getId userVm getHostName serviceOfferingVO getId userVm getTemplateId userVm getHypervisorType toString VirtualMachine class getName userVm getUuid userVm isDisplayVm catch Exception e LOGGER error String format userVm getInstanceName e cleanupFailedImportVM userVm throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format userVm getInstanceName resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType user_vm userVm isDisplayVm resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType cpu userVm isDisplayVm new Long serviceOfferingVO getCpu resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType memory userVm isDisplayVm new Long serviceOfferingVO getRamSize List VolumeVO volumes volumeDao findByInstance userVm getId for VolumeVO volume volumes try UsageEventUtils publishUsageEvent EventTypes EVENT_VOLUME_CREATE volume getAccountId volume getDataCenterId volume getId volume getName volume getDiskOfferingId null volume getSize Volume class getName volume getUuid volume isDisplayVolume
LOGGER error String format userVm getInstanceName e cleanupFailedImportVM userVm throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format userVm getInstanceName resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType user_vm userVm isDisplayVm resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType cpu userVm isDisplayVm new Long serviceOfferingVO getCpu resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType memory userVm isDisplayVm new Long serviceOfferingVO getRamSize List VolumeVO volumes volumeDao findByInstance userVm getId for VolumeVO volume volumes try UsageEventUtils publishUsageEvent EventTypes EVENT_VOLUME_CREATE volume getAccountId volume getDataCenterId volume getId volume getName volume getDiskOfferingId null volume getSize Volume class getName volume getUuid volume isDisplayVolume catch Exception e LOGGER error String format volume getUuid e resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType volume volume isDisplayVolume resourceLimitService incrementResourceCount userVm getAccountId Resource ResourceType primary_storage volume isDisplayVolume volume getSize List NicVO nics nicDao listByVmId userVm getId
if migrateAllowed hostSupportsServiceOffering host validatedServiceOffering throw new InvalidParameterValueException String format serviceOffering getUuid host getUuid instanceName List UnmanagedInstanceTO Disk unmanagedInstanceDisks unmanagedInstance getDisks if CollectionUtils isEmpty unmanagedInstanceDisks throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format instanceName final UnmanagedInstanceTO Disk rootDisk unmanagedInstance getDisks get if rootDisk null Strings isNullOrEmpty rootDisk getController throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format instanceName allDetails put VmDetailConstants ROOT_DISK_CONTROLLER rootDisk getController List UnmanagedInstanceTO Disk dataDisks new ArrayList try checkUnmanagedDiskAndOfferingForImport rootDisk null validatedServiceOffering owner zone cluster migrateAllowed if unmanagedInstanceDisks size dataDisks addAll unmanagedInstanceDisks dataDisks remove
if unmanagedInstance getPowerState equals UnmanagedInstanceTO PowerState PowerOn powerState VirtualMachine PowerState PowerOn try userVm userVmManager importVM zone host template instanceName displayName owner null caller true null owner getAccountId userId validatedServiceOffering null hostName cluster getHypervisorType allDetails powerState catch InsufficientCapacityException ice LOGGER error String format instanceName ice throw new ServerApiException ApiErrorCode INSUFFICIENT_CAPACITY_ERROR ice getMessage if userVm null throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format instanceName List Pair DiskProfile StoragePool diskProfileStoragePoolList new ArrayList try if rootDisk getCapacity null rootDisk getCapacity throw new InvalidParameterValueException String format rootDisk getDiskId Long minIops null if details containsKey
throw new ServerApiException ApiErrorCode INTERNAL_ERROR String format instanceName List Pair DiskProfile StoragePool diskProfileStoragePoolList new ArrayList try if rootDisk getCapacity null rootDisk getCapacity throw new InvalidParameterValueException String format rootDisk getDiskId Long minIops null if details containsKey minIops Long parseLong details get Long maxIops null if details containsKey maxIops Long parseLong details get diskProfileStoragePoolList add importDisk rootDisk userVm cluster serviceOffering Volume Type ROOT String format userVm getId rootDisk getCapacity Resource ResourceType bytesToGiB minIops maxIops template owner null for UnmanagedInstanceTO Disk disk dataDisks if disk getCapacity null disk getCapacity throw new InvalidParameterValueException String format rootDisk getDiskId
protected void unlock if tableLockId null networkDao releaseFromLockTable tableLockId if logger isDebugEnabled
Override protected void unlock if tableLockId null vpcDao releaseFromLockTable tableLockId if logger isDebugEnabled
accountVlanMaps add accountVlanMap when configurationMgr _accountVlanMapDao listAccountVlanMapsByVlan anyLong thenReturn accountVlanMaps when configurationMgr _publicIpAddressDao countIPs anyLong anyLong anyBoolean thenReturn List IPAddressVO ipAddressList new ArrayList IPAddressVO IPAddressVO ipAddress new IPAddressVO new Ip 0xaabbccddeeffL false ipAddressList add ipAddress when configurationMgr _publicIpAddressDao listByVlanId anyLong thenReturn ipAddressList when configurationMgr _firewallDao countRulesByIpId anyLong thenReturn 0L when configurationMgr _ipAddrMgr disassociatePublicIpAddress anyLong anyLong any Account class thenReturn true when configurationMgr _vlanDao releaseFromLockTable anyLong thenReturn true when configurationMgr _accountVlanMapDao remove anyLong thenReturn true try Boolean result configurationMgr releasePublicIpRange releasePublicIpRangesCmd Assert assertTrue result catch Exception e
boolean invalid false boolean unsupported false try networkService createPrivateNetwork null 1L true 1L false catch CloudRuntimeException e Assert assertEquals e getMessage invalid true try networkService createPrivateNetwork null 1L false 1L false catch InvalidParameterValueException e Assert assertEquals e getMessage unsupported true Assert assertEquals true invalid Assert assertEquals true unsupported catch ResourceAllocationException e
networkService createPrivateNetwork null 1L true 1L false catch CloudRuntimeException e Assert assertEquals e getMessage invalid true try networkService createPrivateNetwork null 1L false 1L false catch InvalidParameterValueException e Assert assertEquals e getMessage unsupported true Assert assertEquals true invalid Assert assertEquals true unsupported catch ResourceAllocationException e s_logger error e fail catch ConcurrentOperationException e
Assert assertEquals e getMessage invalid true try networkService createPrivateNetwork null 1L false 1L false catch InvalidParameterValueException e Assert assertEquals e getMessage unsupported true Assert assertEquals true invalid Assert assertEquals true unsupported catch ResourceAllocationException e s_logger error e fail catch ConcurrentOperationException e s_logger error e fail
physicalNetwork addIsolationMethod AccountGuestVlanMapVO accountGuestVlanMapVO new AccountGuestVlanMapVO 1L 1L when networkService _physicalNetworkDao findById anyLong thenReturn physicalNetwork when networkService _datacneterVnet listAllocatedVnetsInRange anyLong anyLong anyInt anyInt thenReturn null when networkService _accountGuestVlanMapDao listAccountGuestVlanMapsByPhysicalNetwork anyLong thenReturn null when networkService _accountGuestVlanMapDao persist any AccountGuestVlanMapVO class thenReturn accountGuestVlanMapVO when networkService _datacneterVnet update anyLong any DataCenterVnetVO class thenReturn true List DataCenterVnetVO dataCenterVnetList new ArrayList DataCenterVnetVO DataCenterVnetVO dataCenterVnetVO new DataCenterVnetVO 1L 1L dataCenterVnetList add dataCenterVnetVO when networkService _datacneterVnet findVnet anyLong anyString thenReturn dataCenterVnetList try GuestVlan result networkService dedicateGuestVlanRange dedicateGuestVlanRangesCmd Assert assertNotNull result catch Exception e
Override public boolean start for NetworkElement element _networkElements Provider implementedProvider element getProvider if implementedProvider null if s_providerToNetworkElementMap containsKey implementedProvider getName
Field nameField _class getDeclaredField nameField setAccessible true nameField set createCmd Field descriptionField _class getDeclaredField descriptionField setAccessible true descriptionField set createCmd Field serviceDomainField _class getDeclaredField serviceDomainField setAccessible true serviceDomainField set createCmd Field serviceTypeField _class getDeclaredField serviceTypeField setAccessible true serviceTypeField set createCmd try gslbServiceImpl createGlobalLoadBalancerRule createCmd catch Exception e
Field lbRules _class getDeclaredField lbRules setAccessible true List Long lbRuleIds new ArrayList Long lbRuleIds add new Long lbRules set assignCmd lbRuleIds NetworkVO networkVo new NetworkVO Field dcID NetworkVO class getDeclaredField dcID setAccessible true dcID set networkVo new Long when gslbServiceImpl _networkDao findById new Long thenReturn networkVo IPAddressVO ip new IPAddressVO new Ip true when gslbServiceImpl _ipAddressDao findById new Long thenReturn ip try gslbServiceImpl assignToGlobalLoadBalancerRule assignCmd catch Exception e
when gslbServiceImpl _lbDao findById new Long thenReturn lbRule2 Field lbRules _class getDeclaredField lbRules setAccessible true List Long lbRuleIds new ArrayList Long lbRuleIds add new Long lbRuleIds add new Long lbRules set assignCmd lbRuleIds NetworkVO networkVo new NetworkVO Field dcID NetworkVO class getDeclaredField dcID setAccessible true dcID set networkVo new Long when gslbServiceImpl _networkDao findById new Long thenReturn networkVo try gslbServiceImpl assignToGlobalLoadBalancerRule assignCmd catch InvalidParameterValueException e
Field gslbRuleId _class getDeclaredField gslbRuleId setAccessible true gslbRuleId set deleteCmd new Long GlobalLoadBalancerRuleVO gslbRule new GlobalLoadBalancerRuleVO GlobalLoadBalancerRule State Active when gslbServiceImpl _gslbRuleDao findById new Long thenReturn gslbRule GlobalLoadBalancerLbRuleMapVO gslbLbMap new GlobalLoadBalancerLbRuleMapVO gslbLbMap setGslbLoadBalancerId gslbLbMap setLoadBalancerId List GlobalLoadBalancerLbRuleMapVO gslbLbMapList new ArrayList GlobalLoadBalancerLbRuleMapVO gslbLbMapList add gslbLbMap when gslbServiceImpl _gslbLbMapDao listByGslbRuleId new Long thenReturn gslbLbMapList try gslbServiceImpl deleteGlobalLoadBalancerRule deleteCmd Assert assertTrue gslbRule getState GlobalLoadBalancerRule State Revoke catch Exception e
when gslbServiceImpl _accountMgr getAccount anyLong thenReturn account Field gslbRuleId _class getDeclaredField gslbRuleId setAccessible true gslbRuleId set deleteCmd new Long GlobalLoadBalancerRuleVO gslbRule new GlobalLoadBalancerRuleVO GlobalLoadBalancerRule State Active when gslbServiceImpl _gslbRuleDao findById new Long thenReturn gslbRule GlobalLoadBalancerLbRuleMapVO gslbLmMap new GlobalLoadBalancerLbRuleMapVO List GlobalLoadBalancerLbRuleMapVO gslbLbMapVos new ArrayList GlobalLoadBalancerLbRuleMapVO gslbLbMapVos add gslbLmMap when gslbServiceImpl _gslbLbMapDao listByGslbRuleId new Long thenReturn gslbLbMapVos try gslbServiceImpl deleteGlobalLoadBalancerRule deleteCmd Assert assertTrue gslbRule getState GlobalLoadBalancerRule State Revoke Assert assertTrue gslbLmMap isRevoke true catch Exception e
try handleEvent Event STREAM_CLOSE Direction IN catch Exception e s_logger info e getLocalizedMessage try handleEvent Event STREAM_CLOSE Direction OUT catch Exception e s_logger info e getLocalizedMessage try if sslSocket null sslSocket close catch Exception e s_logger info e getLocalizedMessage try socket close catch Exception e
try handleEvent Event STREAM_CLOSE Direction IN catch Exception e s_logger info e getLocalizedMessage try handleEvent Event STREAM_CLOSE Direction OUT catch Exception e s_logger info e getLocalizedMessage try if bcoSslSocket null bcoSslSocket close catch Exception e s_logger info e getLocalizedMessage try socket close catch Exception e
final SSLSocketFactory sslSocketFactory SSLSocketFactory SSLSocketFactory getDefault SSLSocket sslSocket SSLSocket sslSocketFactory createSocket socket null serverSocket getLocalPort true sslSocket setEnabledCipherSuites sslSocket getSupportedCipherSuites sslSocket setUseClientMode false sslSocket startHandshake is sslSocket getInputStream os sslSocket getOutputStream break default throw new RuntimeException packet type finally try is close catch Throwable e s_logger info e getLocalizedMessage try
private static void configProxy Properties conf s_logger info for Object key conf keySet
s_logger info String key conf getProperty String key String s conf getProperty if s null httpListenPort Integer parseInt s s_logger info s s conf getProperty if s null s equalsIgnoreCase s_logger info httpListenPort factoryClzName else factoryClzName ConsoleProxyBaseServerFactoryImpl class getName s conf getProperty if s null httpCmdListenPort Integer parseInt s
authResult setSuccess true authResult setReauthentication reauthentication authResult setHost param getClientHostAddress authResult setPort param getClientHostPort if standaloneStart return authResult if authMethod null Object result try result authMethod invoke ConsoleProxy context param getClientHostAddress String valueOf param getClientHostPort param getClientTag param getClientHostPassword param getTicket new Boolean reauthentication catch IllegalAccessException e s_logger error param getClientTag e authResult setSuccess false return authResult catch InvocationTargetException e
if authMethod null Object result try result authMethod invoke ConsoleProxy context param getClientHostAddress String valueOf param getClientHostPort param getClientTag param getClientHostPassword param getTicket new Boolean reauthentication catch IllegalAccessException e s_logger error param getClientTag e authResult setSuccess false return authResult catch InvocationTargetException e s_logger error param getClientTag e authResult setSuccess false return authResult if result null result String authResult new Gson fromJson String result ConsoleProxyAuthenticationResult class else
public static void startWithContext Properties conf Object context byte ksBits String ksPassword String password setEncryptorPassword password configLog4j Logger setFactory new ConsoleProxyLoggerFactory s_logger info if conf null for Object key conf keySet
Logger setFactory new ConsoleProxyLoggerFactory s_logger info if conf null for Object key conf keySet s_logger info String key conf getProperty String key ConsoleProxy context context ConsoleProxy ksBits ksBits ConsoleProxy ksPassword ksPassword try final ClassLoader loader Thread currentThread getContextClassLoader Class contextClazz loader loadClass authMethod contextClazz getDeclaredMethod String class String class String class String class String class Boolean class reportMethod contextClazz getDeclaredMethod String class ensureRouteMethod contextClazz getDeclaredMethod String class catch SecurityException e
if conf null for Object key conf keySet s_logger info String key conf getProperty String key ConsoleProxy context context ConsoleProxy ksBits ksBits ConsoleProxy ksPassword ksPassword try final ClassLoader loader Thread currentThread getContextClassLoader Class contextClazz loader loadClass authMethod contextClazz getDeclaredMethod String class String class String class String class String class Boolean class reportMethod contextClazz getDeclaredMethod String class ensureRouteMethod contextClazz getDeclaredMethod String class catch SecurityException e s_logger error e catch NoSuchMethodException e
s_logger info String key conf getProperty String key ConsoleProxy context context ConsoleProxy ksBits ksBits ConsoleProxy ksPassword ksPassword try final ClassLoader loader Thread currentThread getContextClassLoader Class contextClazz loader loadClass authMethod contextClazz getDeclaredMethod String class String class String class String class String class Boolean class reportMethod contextClazz getDeclaredMethod String class ensureRouteMethod contextClazz getDeclaredMethod String class catch SecurityException e s_logger error e catch NoSuchMethodException e s_logger error e catch IllegalArgumentException e
ConsoleProxy context context ConsoleProxy ksBits ksBits ConsoleProxy ksPassword ksPassword try final ClassLoader loader Thread currentThread getContextClassLoader Class contextClazz loader loadClass authMethod contextClazz getDeclaredMethod String class String class String class String class String class Boolean class reportMethod contextClazz getDeclaredMethod String class ensureRouteMethod contextClazz getDeclaredMethod String class catch SecurityException e s_logger error e catch NoSuchMethodException e s_logger error e catch IllegalArgumentException e s_logger error e
catch IllegalArgumentException e s_logger error e catch ClassNotFoundException e s_logger error e InputStream confs ConsoleProxy class getResourceAsStream Properties props new Properties if confs null final File file PropertiesUtil findConfigFile if file null s_logger info else try confs new FileInputStream file catch FileNotFoundException e s_logger info if confs null try
catch ClassNotFoundException e s_logger error e InputStream confs ConsoleProxy class getResourceAsStream Properties props new Properties if confs null final File file PropertiesUtil findConfigFile if file null s_logger info else try confs new FileInputStream file catch FileNotFoundException e s_logger info if confs null try props load confs for Object key props keySet
try ConsoleProxyServerFactory factory getHttpServerFactory if factory null s_logger error System exit HttpServer server factory createHttpServerInstance httpListenPort server createContext new ConsoleProxyThumbnailHandler server createContext new ConsoleProxyResourceHandler server createContext new ConsoleProxyAjaxHandler server createContext new ConsoleProxyAjaxImageHandler server setExecutor new ThreadExecutor server start ConsoleProxyNoVNCServer noVNCServer getNoVNCServer noVNCServer start catch Exception e
configLog4j Logger setFactory new ConsoleProxyLoggerFactory InputStream confs ConsoleProxy class getResourceAsStream Properties conf new Properties if confs null s_logger info else try conf load confs catch Exception e s_logger error e toString e finally try confs close catch IOException ioex
public static ConsoleProxyClient getVncViewer ConsoleProxyClientParam param throws Exception ConsoleProxyClient viewer null boolean reportLoadChange false String clientKey param getClientMapKey synchronized connectionMap viewer connectionMap get clientKey if viewer null viewer getClass ConsoleProxyNoVncClient class viewer getClient param viewer initClient param connectionMap put clientKey viewer
public static ConsoleProxyClient getAjaxVncViewer ConsoleProxyClientParam param String ajaxSession throws Exception boolean reportLoadChange false String clientKey param getClientMapKey synchronized connectionMap ConsoleProxyClient viewer connectionMap get clientKey if viewer null viewer getClass ConsoleProxyNoVncClient class authenticationExternally param viewer getClient param viewer initClient param connectionMap put clientKey viewer
param setUsername username param setPassword password viewer ConsoleProxy getAjaxVncViewer param ajaxSessionIdStr catch Exception e s_logger warn e getMessage e String content new String StringBuffer sb new StringBuffer for int i i content length i sb append content i sendResponse t sb toString return if event if ajaxSessionId ajaxSessionId viewer getAjaxSessionId if event InputStream is t getRequestBody handleClientEventBag viewer convertStreamToString is true
Override public void handle HttpExchange t throws IOException try if s_logger isDebugEnabled s_logger debug t getRequestURI long startTick System currentTimeMillis doHandle t if s_logger isDebugEnabled s_logger debug t getRequestURI System currentTimeMillis startTick catch IOException e throw e catch IllegalArgumentException e s_logger warn e t sendResponseHeaders catch OutOfMemoryError e s_logger error System exit catch Throwable e
Override public void handle HttpExchange t throws IOException try Thread currentThread setName Thread currentThread getId t getRemoteAddress
try Thread currentThread setName Thread currentThread getId t getRemoteAddress s_logger info t getRequestURI doHandle t catch Exception e s_logger error e toString e String response t sendResponseHeaders response length OutputStream os t getResponseBody os write response getBytes os close catch OutOfMemoryError e s_logger error System exit catch Throwable e
public void doHandle HttpExchange t throws Exception String path t getRequestURI getPath int i path indexOf String cmd path substring i
String name param split String value param split map put name value else if paramTokens length String name paramTokens String value paramTokens paramTokens map put name value else if s_logger isDebugEnabled s_logger debug param if map get null ConsoleProxyPasswordBasedEncryptor encryptor new ConsoleProxyPasswordBasedEncryptor ConsoleProxy getEncryptorPassword ConsoleProxyClientParam param encryptor decryptObject ConsoleProxyClientParam class map get guardUserInput map if param null if param getClientHostAddress null
String name paramTokens String value paramTokens paramTokens map put name value else if s_logger isDebugEnabled s_logger debug param if map get null ConsoleProxyPasswordBasedEncryptor encryptor new ConsoleProxyPasswordBasedEncryptor ConsoleProxy getEncryptorPassword ConsoleProxyClientParam param encryptor decryptObject ConsoleProxyClientParam class map get guardUserInput map if param null if param getClientHostAddress null s_logger debug param getClientHostAddress map put param getClientHostAddress else s_logger error
if s_logger isDebugEnabled s_logger debug param if map get null ConsoleProxyPasswordBasedEncryptor encryptor new ConsoleProxyPasswordBasedEncryptor ConsoleProxy getEncryptorPassword ConsoleProxyClientParam param encryptor decryptObject ConsoleProxyClientParam class map get guardUserInput map if param null if param getClientHostAddress null s_logger debug param getClientHostAddress map put param getClientHostAddress else s_logger error if param getClientHostPort s_logger debug param getClientHostPort map put String valueOf param getClientHostPort else
Override public void initClient ConsoleProxyClientParam param setClientParam param client new NoVncClient connectionAlive true updateFrontEndActivityTime Thread worker new Thread new Runnable public void run try String tunnelUrl param getClientTunnelUrl String tunnelSession param getClientTunnelSession try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl
public void run try String tunnelUrl param getClientTunnelUrl String tunnelSession param getClientTunnelSession try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl s_logger info tunnelUrl tunnelSession ConsoleProxy ensureRoute uri getHost client connectTo uri getHost uri getPort uri getPath uri getQuery tunnelSession equalsIgnoreCase uri getScheme else s_logger info getClientHostAddress getClientHostPort ConsoleProxy ensureRoute getClientHostAddress client connectTo getClientHostAddress getClientHostPort catch UnknownHostException e
String tunnelUrl param getClientTunnelUrl String tunnelSession param getClientTunnelSession try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl s_logger info tunnelUrl tunnelSession ConsoleProxy ensureRoute uri getHost client connectTo uri getHost uri getPort uri getPath uri getQuery tunnelSession equalsIgnoreCase uri getScheme else s_logger info getClientHostAddress getClientHostPort ConsoleProxy ensureRoute getClientHostAddress client connectTo getClientHostAddress getClientHostPort catch UnknownHostException e s_logger error e catch IOException e
try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl s_logger info tunnelUrl tunnelSession ConsoleProxy ensureRoute uri getHost client connectTo uri getHost uri getPort uri getPath uri getQuery tunnelSession equalsIgnoreCase uri getScheme else s_logger info getClientHostAddress getClientHostPort ConsoleProxy ensureRoute getClientHostAddress client connectTo getClientHostAddress getClientHostPort catch UnknownHostException e s_logger error e catch IOException e s_logger error e catch Throwable e
public String encryptText String text if text null text isEmpty return text try Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher ENCRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes cipher doFinal text getBytes return Base64 encodeBase64URLSafeString encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e
Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher ENCRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes cipher doFinal text getBytes return Base64 encodeBase64URLSafeString encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e
byte encryptedBytes cipher doFinal text getBytes return Base64 encodeBase64URLSafeString encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e
catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e s_logger error e return null
public String decryptText String encryptedText if encryptedText null encryptedText isEmpty return encryptedText try Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher DECRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes Base64 decodeBase64 encryptedText return new String cipher doFinal encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e
Cipher cipher Cipher getInstance SecretKeySpec keySpec new SecretKeySpec keyIvPair getKeyBytes cipher init Cipher DECRYPT_MODE keySpec new IvParameterSpec keyIvPair getIvBytes byte encryptedBytes Base64 decodeBase64 encryptedText return new String cipher doFinal encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e
byte encryptedBytes Base64 decodeBase64 encryptedText return new String cipher doFinal encryptedBytes catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e
catch NoSuchAlgorithmException e s_logger error e return null catch NoSuchPaddingException e s_logger error e return null catch IllegalBlockSizeException e s_logger error e return null catch BadPaddingException e s_logger error e return null catch InvalidKeyException e s_logger error e return null
pipeline add _socket _client pipeline link _client getId pipeline validate InetSocketAddress address new InetSocketAddress host port ConsoleProxy ensureRoute host try _workerDone false s_logger info _socket connect address catch Exception e s_logger info e getMessage finally shutdown _threadStopTime System currentTimeMillis s_logger info
Override public HttpServer createHttpServerInstance int port throws IOException try HttpsServer server HttpsServer create new InetSocketAddress port server setHttpsConfigurator new HttpsConfigurator sslContext Override public void configure HttpsParameters params InetSocketAddress remote params getClientAddress SSLContext c getSSLContext SSLParameters sslparams c getDefaultSSLParameters params setSSLParameters sslparams params setProtocols SSLUtils getRecommendedProtocols params setCipherSuites SSLUtils getRecommendedCiphers s_logger info port return server catch Exception ioe
Override public SSLServerSocket createSSLServerSocket int port throws IOException try SSLServerSocket srvSock null SSLServerSocketFactory ssf sslContext getServerSocketFactory srvSock SSLServerSocket ssf createServerSocket port srvSock setEnabledProtocols SSLUtils getRecommendedProtocols srvSock setEnabledCipherSuites SSLUtils getRecommendedCiphers
if s_logger isDebugEnabled s_logger debug t getRequestURI long startTick System currentTimeMillis doHandle t if s_logger isDebugEnabled s_logger debug t getRequestURI System currentTimeMillis startTick catch IllegalArgumentException e String response s_logger error response t getRequestURI t sendResponseHeaders response length OutputStream os t getResponseBody os write response getBytes os close catch OutOfMemoryError e s_logger error System exit catch Throwable e
os close catch OutOfMemoryError e s_logger error System exit catch Throwable e s_logger error e String queries t getRequestURI getQuery Map String String queryMap getQueryMap queries int width int height String ws queryMap get String hs queryMap get try width Integer parseInt ws height Integer parseInt hs
width Integer parseInt ws height Integer parseInt hs catch NumberFormatException ex s_logger debug ws hs ex width Math min width height Math min height BufferedImage img generateTextImage width height ByteArrayOutputStream bos new ByteArrayOutputStream javax imageio ImageIO write img bos byte bs bos toByteArray Headers hds t getResponseHeaders hds set hds set hds set t sendResponseHeaders bs length
Override public void initClient ConsoleProxyClientParam param setClientParam param client new VncClient this worker new Thread new Runnable Override public void run String tunnelUrl getClientParam getClientTunnelUrl String tunnelSession getClientParam getClientTunnelSession try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl
worker new Thread new Runnable Override public void run String tunnelUrl getClientParam getClientTunnelUrl String tunnelSession getClientParam getClientTunnelSession try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl s_logger info tunnelUrl tunnelSession ConsoleProxy ensureRoute uri getHost client connectTo uri getHost uri getPort uri getPath uri getQuery tunnelSession equalsIgnoreCase uri getScheme getClientHostPassword else s_logger info getClientHostAddress getClientHostPort ConsoleProxy ensureRoute getClientHostAddress client connectTo getClientHostAddress getClientHostPort getClientHostPassword catch UnknownHostException e
String tunnelUrl getClientParam getClientTunnelUrl String tunnelSession getClientParam getClientTunnelSession try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl s_logger info tunnelUrl tunnelSession ConsoleProxy ensureRoute uri getHost client connectTo uri getHost uri getPort uri getPath uri getQuery tunnelSession equalsIgnoreCase uri getScheme getClientHostPassword else s_logger info getClientHostAddress getClientHostPort ConsoleProxy ensureRoute getClientHostAddress client connectTo getClientHostAddress getClientHostPort getClientHostPassword catch UnknownHostException e s_logger error e catch IOException e
try if tunnelUrl null tunnelUrl isEmpty tunnelSession null tunnelSession isEmpty URI uri new URI tunnelUrl s_logger info tunnelUrl tunnelSession ConsoleProxy ensureRoute uri getHost client connectTo uri getHost uri getPort uri getPath uri getQuery tunnelSession equalsIgnoreCase uri getScheme getClientHostPassword else s_logger info getClientHostAddress getClientHostPort ConsoleProxy ensureRoute getClientHostAddress client connectTo getClientHostAddress getClientHostPort getClientHostPassword catch UnknownHostException e s_logger error e catch IOException e s_logger error e catch Throwable e
public void info Object message if factory null if logger null logger factory getLogger clazz
public void info Object message Throwable exception if factory null if logger null logger factory getLogger clazz
public void debug Object message if factory null if logger null logger factory getLogger clazz
public void debug Object message Throwable exception if factory null if logger null logger factory getLogger clazz
public void error Object message if factory null if logger null logger factory getLogger clazz
public void error Object message Throwable exception if factory null if logger null logger factory getLogger clazz
SSLContext context null try context SSLUtils getSSLContext catch NoSuchAlgorithmException e s_logger error e catch NoSuchProviderException e s_logger error e if context null throw new IOException SSLSocket ssl null try context init null trustAllCerts new SecureRandom SocketFactory factory new SecureSSLSocketFactory context ssl SSLSocket factory createSocket host port ssl setEnabledProtocols SSLUtils getSupportedProtocols ssl getEnabledProtocols catch IOException e
catch NoSuchAlgorithmException e s_logger error e catch NoSuchProviderException e s_logger error e if context null throw new IOException SSLSocket ssl null try context init null trustAllCerts new SecureRandom SocketFactory factory new SecureSSLSocketFactory context ssl SSLSocket factory createSocket host port ssl setEnabledProtocols SSLUtils getSupportedProtocols ssl getEnabledProtocols catch IOException e s_logger error e getMessage e throw e catch KeyManagementException e
s_logger error e catch NoSuchProviderException e s_logger error e if context null throw new IOException SSLSocket ssl null try context init null trustAllCerts new SecureRandom SocketFactory factory new SecureSSLSocketFactory context ssl SSLSocket factory createSocket host port ssl setEnabledProtocols SSLUtils getSupportedProtocols ssl getEnabledProtocols catch IOException e s_logger error e getMessage e throw e catch KeyManagementException e s_logger error e getMessage e
public void connectTo String host int port throws UnknownHostException IOException
public byte authenticate String password throws IOException int authType is readInt switch authType case RfbConstants CONNECTION_FAILED int length is readInt byte buf new byte length is readFully buf String reason new String buf RfbConstants CHARSET
if args length printHelpMessage System exit String host args String port args String password args try new VncClient host Integer parseInt port password false null catch NumberFormatException e s_logger error port System exit catch UnknownHostException e s_logger error host System exit catch IOException e
String host args String port args String password args try new VncClient host Integer parseInt port password false null catch NumberFormatException e s_logger error port System exit catch UnknownHostException e s_logger error host System exit catch IOException e s_logger error e getMessage System exit catch Throwable e
if receiver null receiver closeConnection if is null try is close catch Throwable e s_logger info e getLocalizedMessage if os null try os close catch Throwable e s_logger info e getLocalizedMessage if socket null try socket close catch Throwable e
public void connectTo String host int port String password throws UnknownHostException IOException
private void authenticate String password throws IOException int authType is readInt switch authType case RfbConstants CONNECTION_FAILED int length is readInt byte buf new byte length is readFully buf String reason new String buf RfbConstants CHARSET
while connectionAlive int messageType is readUnsignedByte switch messageType case RfbConstants SERVER_FRAMEBUFFER_UPDATE fburListener frameBufferPacketReceived new FramebufferUpdatePacket canvas screen is clientListener break case RfbConstants SERVER_BELL serverBell break case RfbConstants SERVER_CUT_TEXT serverCutText is break default throw new RuntimeException messageType catch Throwable e
private void serverCutText DataInputStream is throws IOException ServerCutText clipboardContent new ServerCutText is StringSelection contents new StringSelection clipboardContent getContent Toolkit getDefaultToolkit getSystemClipboard setContents contents null
private void readPacketData DataInputStream is throws IOException is skipBytes int length is readInt byte buf new byte length is readFully buf content new String buf RfbConstants CHARSET
List SecondaryStorageVmVO alreadyRunning _secStorageVmDao getSecStorageVmListInStates SecondaryStorageVm Role templateProcessor dataCenterId State Running State Migrating State Starting if alreadyRunning size s_logger info dataCenterId List SecondaryStorageVmVO stopped _secStorageVmDao getSecStorageVmListInStates SecondaryStorageVm Role templateProcessor dataCenterId State Stopped State Stopping if stopped size suspendAutoLoading List SecondaryStorageVmVO stopping _secStorageVmDao getSecStorageVmListInStates SecondaryStorageVm Role templateProcessor State Stopping if stopping size s_logger info return new Pair AfterScanAction Object AfterScanAction nop null expandPool pool SecondaryStorageVm Role templateProcessor if suspendAutoLoading if alreadyRunning size s_logger info return new Pair AfterScanAction Object AfterScanAction nop null alreadyRunning _secStorageVmDao getSecStorageVmListInStates null dataCenterId State Running State Migrating State Starting
if _useSSlCopy setupCmd new SecStorageSetupCommand ssStore getTO secUrl null else KeystoreManager Certificates certs _keystoreMgr getCertificates ConsoleProxyManager CERTIFICATE_NAME setupCmd new SecStorageSetupCommand ssStore getTO secUrl certs String nfsVersion imageStoreDetailsUtil getNfsVersion ssStore getId setupCmd setNfsVersion nfsVersion String postUploadKey _configDao getValue Config SSVMPSK key setupCmd setPostUploadKey postUploadKey Answer answer _agentMgr easySend ssHostId setupCmd if answer null answer getResult SecStorageSetupAnswer an SecStorageSetupAnswer answer if an get_dir null ImageStoreVO svo _imageStoreDao findById ssStore getId svo setParent an get_dir
else KeystoreManager Certificates certs _keystoreMgr getCertificates ConsoleProxyManager CERTIFICATE_NAME setupCmd new SecStorageSetupCommand ssStore getTO secUrl certs String nfsVersion imageStoreDetailsUtil getNfsVersion ssStore getId setupCmd setNfsVersion nfsVersion String postUploadKey _configDao getValue Config SSVMPSK key setupCmd setPostUploadKey postUploadKey Answer answer _agentMgr easySend ssHostId setupCmd if answer null answer getResult SecStorageSetupAnswer an SecStorageSetupAnswer answer if an get_dir null ImageStoreVO svo _imageStoreDao findById ssStore getId svo setParent an get_dir _imageStoreDao update ssStore getId svo if s_logger isDebugEnabled
if _allowedInternalSites null List String allowedCidrs new ArrayList String String cidrs _allowedInternalSites split for String cidr cidrs if NetUtils isValidIp4Cidr cidr NetUtils isValidIp4 cidr cidr startsWith allowedCidrs add cidr setupCmd setAllowedInternalSites allowedCidrs toArray new String allowedCidrs size String copyPasswd _configDao getValue setupCmd setCopyPassword copyPasswd setupCmd setCopyUserName TemplateConstants DEFAULT_HTTP_AUTH_USER Answer answer _agentMgr easySend ssAHostId setupCmd if answer null answer getResult if s_logger isDebugEnabled s_logger debug secStorageVm getHostName return true
if thisSecStorageVm null s_logger warn ssAHost getName return false String copyPort _useSSlCopy Integer toString TemplateConstants DEFAULT_TMPLT_COPY_PORT SecStorageFirewallCfgCommand thiscpc new SecStorageFirewallCfgCommand true thiscpc addPortConfig thisSecStorageVm getPublicIpAddress copyPort true TemplateConstants DEFAULT_TMPLT_COPY_INTF QueryBuilder HostVO sc QueryBuilder create HostVO class sc and sc entity getType Op EQ Host Type SecondaryStorageVM sc and sc entity getStatus Op IN Status Up Status Connecting List HostVO ssvms sc list for HostVO ssvm ssvms if ssvm getId ssAHostId continue Answer answer _agentMgr easySend ssvm getId thiscpc if answer null answer getResult
String copyPort _useSSlCopy Integer toString TemplateConstants DEFAULT_TMPLT_COPY_PORT SecStorageFirewallCfgCommand thiscpc new SecStorageFirewallCfgCommand true thiscpc addPortConfig thisSecStorageVm getPublicIpAddress copyPort true TemplateConstants DEFAULT_TMPLT_COPY_INTF QueryBuilder HostVO sc QueryBuilder create HostVO class sc and sc entity getType Op EQ Host Type SecondaryStorageVM sc and sc entity getStatus Op IN Status Up Status Connecting List HostVO ssvms sc list for HostVO ssvm ssvms if ssvm getId ssAHostId continue Answer answer _agentMgr easySend ssvm getId thiscpc if answer null answer getResult if s_logger isDebugEnabled s_logger debug ssvm getName else
public SecondaryStorageVmVO startNew long dataCenterId SecondaryStorageVm Role role if isSecondaryStorageVmRequired dataCenterId if s_logger isDebugEnabled
return null if s_logger isDebugEnabled s_logger debug dataCenterId Map String Object context createSecStorageVmInstance dataCenterId role long secStorageVmId Long context get if secStorageVmId if s_logger isTraceEnabled s_logger trace dataCenterId return null SecondaryStorageVmVO secStorageVm _secStorageVmDao findById secStorageVmId if secStorageVm null SubscriptionMgr getInstance notifySubscribers ALERT_SUBJECT this new SecStorageVmAlertEventArgs SecStorageVmAlertEventArgs SSVM_CREATED dataCenterId secStorageVmId secStorageVm null return secStorageVm else if s_logger isDebugEnabled
boolean secStorageVmFromStoppedPool false secStorageVm assignSecStorageVmFromStoppedPool dataCenterId role if secStorageVm null if s_logger isInfoEnabled s_logger info if _allocLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try secStorageVm startNew dataCenterId role for UploadVO upload _uploadDao listAll _uploadDao expunge upload getId finally _allocLock unlock else if s_logger isInfoEnabled s_logger info
finally _allocLock unlock else if s_logger isInfoEnabled s_logger info return else if s_logger isInfoEnabled s_logger info secStorageVm getId secStorageVmFromStoppedPool true if secStorageVm null long secStorageVmId secStorageVm getId GlobalLock secStorageVmLock GlobalLock getInternLock getSecStorageVmLockName secStorageVmId try if secStorageVmLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC
s_logger info return else if s_logger isInfoEnabled s_logger info secStorageVm getId secStorageVmFromStoppedPool true if secStorageVm null long secStorageVmId secStorageVm getId GlobalLock secStorageVmLock GlobalLock getInternLock getSecStorageVmLockName secStorageVmId try if secStorageVmLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try secStorageVm startSecStorageVm secStorageVmId finally secStorageVmLock unlock
if s_logger isInfoEnabled s_logger info secStorageVm getId secStorageVmFromStoppedPool true if secStorageVm null long secStorageVmId secStorageVm getId GlobalLock secStorageVmLock GlobalLock getInternLock getSecStorageVmLockName secStorageVmId try if secStorageVmLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try secStorageVm startSecStorageVm secStorageVmId finally secStorageVmLock unlock else if s_logger isInfoEnabled s_logger info secStorageVm getId
public boolean isZoneReady Map Long ZoneHostInfo zoneHostInfoMap long dataCenterId ZoneHostInfo zoneHostInfo zoneHostInfoMap get dataCenterId if zoneHostInfo null zoneHostInfo getFlags RunningHostInfoAgregator ZoneHostInfo ROUTING_HOST_MASK VMTemplateVO template _templateDao findSystemVMReadyTemplate dataCenterId HypervisorType Any if template null if s_logger isDebugEnabled
List DataStore stores _dataStoreMgr getImageStoresByScope new ZoneScope dataCenterId if stores size s_logger debug dataCenterId return false if template isDirectDownload templateMgr getImageStore dataCenterId template getId null if s_logger isDebugEnabled s_logger debug dataCenterId return false boolean useLocalStorage false Boolean useLocal ConfigurationManagerImpl SystemVMUseLocalStorage valueIn dataCenterId if useLocal null useLocalStorage useLocal booleanValue List Pair Long Integer l _storagePoolHostDao getDatacenterStoragePoolHostInfo dataCenterId useLocalStorage if l null l size l get second intValue return true
Override public boolean configure String name Map String Object params throws ConfigurationException if s_logger isInfoEnabled
_allowedInternalSites _configDao getValue String value configs get _capacityScanInterval NumbersUtil parseLong value DEFAULT_CAPACITY_SCAN_INTERVAL _instance configs get if _instance null _instance Map String String agentMgrConfigs _configDao getConfiguration params value agentMgrConfigs get _mgmtPort NumbersUtil parseInt value _listener new SecondaryStorageListener this _agentMgr registerForHostEvents _listener true false true _itMgr registerGuru VirtualMachine Type SecondaryStorageVm this String ssvmSrvcOffIdStr configs get Config SecondaryStorageServiceOffering key if ssvmSrvcOffIdStr null _serviceOffering _offeringDao findByUuid ssvmSrvcOffIdStr
if offerings null offerings size String msg s_logger error msg throw new ConfigurationException msg if _useServiceVM _loadScanner new SystemVmLoadScanner Long this _loadScanner initScan STARTUP_DELAY _capacityScanInterval _httpProxy configs get Config SecStorageProxy key if _httpProxy null boolean valid true String errMsg null try URI uri new URI _httpProxy if equalsIgnoreCase uri getScheme errMsg
Override public boolean stopSecStorageVm long secStorageVmId SecondaryStorageVmVO secStorageVm _secStorageVmDao findById secStorageVmId if secStorageVm null String msg secStorageVmId if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug msg return false try if secStorageVm getHostId null GlobalLock secStorageVmLock GlobalLock getInternLock getSecStorageVmLockName secStorageVm getId try if secStorageVmLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try _itMgr stop secStorageVm getUuid return true finally secStorageVmLock unlock else String msg secStorageVm toString
GlobalLock secStorageVmLock GlobalLock getInternLock getSecStorageVmLockName secStorageVm getId try if secStorageVmLock lock ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC try _itMgr stop secStorageVm getUuid return true finally secStorageVmLock unlock else String msg secStorageVm toString s_logger debug msg return false finally secStorageVmLock releaseRef return true
Override public boolean rebootSecStorageVm long secStorageVmId final SecondaryStorageVmVO secStorageVm _secStorageVmDao findById secStorageVmId if secStorageVm null secStorageVm getState State Destroyed return false if secStorageVm getState State Running secStorageVm getHostId null final RebootCommand cmd new RebootCommand secStorageVm getInstanceName _itMgr getExecuteInSequence secStorageVm getHypervisorType final Answer answer _agentMgr easySend secStorageVm getHostId cmd if answer null answer getResult if s_logger isDebugEnabled s_logger debug secStorageVm getHostName SubscriptionMgr getInstance notifySubscribers ALERT_SUBJECT this new SecStorageVmAlertEventArgs SecStorageVmAlertEventArgs SSVM_REBOOTED secStorageVm getDataCenterId secStorageVm getId secStorageVm null return true else String msg secStorageVm getHostName if s_logger isDebugEnabled
Override public boolean destroySecStorageVm long vmId SecondaryStorageVmVO ssvm _secStorageVmDao findById vmId try _itMgr expunge ssvm getUuid _secStorageVmDao remove ssvm getId HostVO host _hostDao findByTypeNameAndZoneId ssvm getDataCenterId ssvm getHostName Host Type SecondaryStorageVM if host null
Override public boolean finalizeVirtualMachineProfile VirtualMachineProfile profile DeployDestination dest ReservationContext context SecondaryStorageVmVO vm _secStorageVmDao findById profile getId Map String String details _vmDetailsDao listDetailsKeyPairs vm getId vm setDetails details DataStore secStore _dataStoreMgr getImageStoreWithFreeCapacity dest getDataCenter getId if secStore null
String mgmt_cidr _configDao getValue Config ManagementNetwork key if NetUtils isValidIp4Cidr mgmt_cidr buf append append mgmt_cidr buf append append dest getPod getGateway buf append append append deviceId else if nic getTrafficType TrafficType Public buf append append append deviceId else if nic getTrafficType TrafficType Storage buf append append nic getIPv4Address buf append append nic getIPv4Netmask buf append append nic getIPv4Gateway if externalDhcp buf append DataCenterVO dc _dcDao findById profile getVirtualMachine getDataCenterId buf append append dc getInternalDns1
Override public boolean isPoolReadyForScan Long pool long dataCenterId pool longValue if isZoneReady _zoneHostInfoMap dataCenterId if s_logger isDebugEnabled
Override public Pair AfterScanAction Object scanPool Long pool long dataCenterId pool longValue List SecondaryStorageVmVO ssVms _secStorageVmDao getSecStorageVmListInStates SecondaryStorageVm Role templateProcessor dataCenterId State Running State Migrating State Starting State Stopped State Stopping int vmSize ssVms null ssVms size List DataStore ssStores _dataStoreMgr getImageStoresByScope new ZoneScope dataCenterId int storeSize ssStores null ssStores size if storeSize vmSize
Override public void channelInactive ChannelHandlerContext ctx throws Exception if requestProcessed String message
String hostname null long contentLength for Entry String String entry request headers switch entry getKey case HEADER_SIGNATURE signature entry getValue break case HEADER_METADATA metadata entry getValue break case HEADER_EXPIRES expires entry getValue break case HEADER_HOST hostname entry getValue break case HttpHeaders Names CONTENT_LENGTH contentLength Long parseLong entry getValue break logger info signature
long contentLength for Entry String String entry request headers switch entry getKey case HEADER_SIGNATURE signature entry getValue break case HEADER_METADATA metadata entry getValue break case HEADER_EXPIRES expires entry getValue break case HEADER_HOST hostname entry getValue break case HttpHeaders Names CONTENT_LENGTH contentLength Long parseLong entry getValue break logger info signature logger info metadata
for Entry String String entry request headers switch entry getKey case HEADER_SIGNATURE signature entry getValue break case HEADER_METADATA metadata entry getValue break case HEADER_EXPIRES expires entry getValue break case HEADER_HOST hostname entry getValue break case HttpHeaders Names CONTENT_LENGTH contentLength Long parseLong entry getValue break logger info signature logger info metadata logger info expires
switch entry getKey case HEADER_SIGNATURE signature entry getValue break case HEADER_METADATA metadata entry getValue break case HEADER_EXPIRES expires entry getValue break case HEADER_HOST hostname entry getValue break case HttpHeaders Names CONTENT_LENGTH contentLength Long parseLong entry getValue break logger info signature logger info metadata logger info expires logger info hostname
break case HEADER_EXPIRES expires entry getValue break case HEADER_HOST hostname entry getValue break case HttpHeaders Names CONTENT_LENGTH contentLength Long parseLong entry getValue break logger info signature logger info metadata logger info expires logger info hostname logger info contentLength QueryStringDecoder decoderQuery new QueryStringDecoder uri Map String List String uriAttributes decoderQuery parameters uuid uriAttributes get get
break logger info signature logger info metadata logger info expires logger info hostname logger info contentLength QueryStringDecoder decoderQuery new QueryStringDecoder uri Map String List String uriAttributes decoderQuery parameters uuid uriAttributes get get logger info uuid UploadEntity uploadEntity null try storageResource validatePostUploadRequest signature metadata expires hostname contentLength uuid uploadEntity storageResource createUploadEntity uuid metadata contentLength catch InvalidParameterValueException ex
try decoder new HttpPostRequestDecoder factory request catch ErrorDataDecoderException IncompatibleDataDecoderException e logger error e responseContent append e getMessage writeResponse ctx channel HttpResponseStatus INTERNAL_SERVER_ERROR requestProcessed true return else logger warn responseContent append writeResponse ctx channel HttpResponseStatus BAD_REQUEST requestProcessed true return if decoder null
private HttpResponseStatus readFileUploadData throws IOException while decoder hasNext InterfaceHttpData data decoder next if data null try
private HttpResponseStatus readFileUploadData throws IOException while decoder hasNext InterfaceHttpData data decoder next if data null try logger info data getHttpDataType name data if data getHttpDataType HttpDataType FileUpload FileUpload fileUpload FileUpload data if fileUpload isCompleted requestProcessed true String format ImageStoreUtil checkTemplateFormat fileUpload getFile getAbsolutePath fileUpload getFilename if StringUtils isNotBlank format String errorString format
_parent String params get if _parent null throw new ConfigurationException _storage StorageLayer params get StorageLayer InstanceConfigKey if _storage null String value String params get StorageLayer ClassConfigKey if value null value try Class StorageLayer clazz Class StorageLayer Class forName value _storage ComponentContext inject clazz catch ClassNotFoundException e throw new ConfigurationException value if _storage mkdirs _parent s_logger warn _parent
String secondaryStorageUrl nfsImageStore getUrl assert secondaryStorageUrl null String templateUrl secondaryStorageUrl File separator srcData getPath Pair String String templateInfo decodeTemplateRelativePathAndNameFromUrl secondaryStorageUrl templateUrl template getName String templateRelativeFolderPath templateInfo first try String secondaryMountPoint getRootDir secondaryStorageUrl _nfsVersion s_logger info secondaryMountPoint String srcOVAFileName getTemplateOnSecStorageFilePath secondaryMountPoint templateRelativeFolderPath templateInfo second ImageFormat OVA getFileExtension String ovfFilePath getOVFFilePath srcOVAFileName if ovfFilePath null Script command new Script s_logger command add command add command add srcOVAFileName
if result null String msg srcOVAFileName s_logger error msg throw new Exception msg command new Script s_logger command add command add secondaryMountPoint File separator templateRelativeFolderPath result command execute if result null s_logger warn secondaryMountPoint File separator templateRelativeFolderPath result Script command new Script _timeout s_logger command add ovfFilePath command add ovfFilePath String result command execute if result null
s_logger error msg throw new Exception msg command new Script s_logger command add command add secondaryMountPoint File separator templateRelativeFolderPath result command execute if result null s_logger warn secondaryMountPoint File separator templateRelativeFolderPath result Script command new Script _timeout s_logger command add ovfFilePath command add ovfFilePath String result command execute if result null String msg result s_logger error msg
command add secondaryMountPoint File separator templateRelativeFolderPath result command execute if result null s_logger warn secondaryMountPoint File separator templateRelativeFolderPath result Script command new Script _timeout s_logger command add ovfFilePath command add ovfFilePath String result command execute if result null String msg result s_logger error msg s_logger debug ovfFilePath OVFHelper ovfHelper new OVFHelper List DatadiskTO disks ovfHelper getOVFVolumeInfo ovfFilePath return new GetDatadisksAnswer disks
synchronized newTmplDir intern Script command new Script _timeout s_logger command add command add newTmplDirAbsolute String result command execute if result null String msg newTmplDir secondaryStorageUrl result s_logger error msg throw new Exception msg synchronized origDisk intern Script command new Script _timeout s_logger command add origDisk command add newTmplDirAbsolute String result command execute if result null
throw new Exception msg synchronized origDisk intern Script command new Script _timeout s_logger command add origDisk command add newTmplDirAbsolute String result command execute if result null String msg result s_logger error msg throw new Exception msg command new Script _timeout s_logger command add ovfFilePath command add newTmplDirAbsolute result command execute if result null
result command execute if result null String msg result s_logger error msg throw new Exception msg String newOvfFilePath newTmplDirAbsolute File separator ovfFilePath substring ovfFilePath lastIndexOf File separator OVFHelper ovfHelper new OVFHelper ovfHelper rewriteOVFFile ovfFilePath newOvfFilePath diskName postCreatePrivateTemplate newTmplDirAbsolute templateId templateUniqueName physicalSize virtualSize writeMetaOvaForTemplate newTmplDirAbsolute ovfFilePath substring ovfFilePath lastIndexOf File separator diskName templateUniqueName physicalSize diskTemplate setId templateId if diskName endsWith diskTemplate setPath newTmplDir File separator diskName else diskTemplate setPath newTmplDir File separator templateUniqueName
protected Answer copyFromSwiftToNfs CopyCommand cmd DataTO srcData SwiftTO swiftTO DataTO destData NfsTO destImageStore final String storagePath destImageStore getUrl final String destPath destData getPath try String downloadPath determineStorageTemplatePath storagePath destPath _nfsVersion final File downloadDirectory _storage getFile downloadPath if downloadDirectory exists
final String storagePath destImageStore getUrl final String destPath destData getPath try String downloadPath determineStorageTemplatePath storagePath destPath _nfsVersion final File downloadDirectory _storage getFile downloadPath if downloadDirectory exists s_logger debug downloadPath else if downloadDirectory mkdirs final String errMsg downloadPath s_logger error errMsg return new CopyCmdAnswer errMsg File destFile SwiftUtil getObject swiftTO downloadDirectory srcData getPath return postProcessing destFile downloadPath destPath srcData destData catch Exception e
protected Answer copyFromS3ToNfs CopyCommand cmd DataTO srcData S3TO s3 DataTO destData NfsTO destImageStore final String storagePath destImageStore getUrl final String destPath destData getPath try String downloadPath determineStorageTemplatePath storagePath destPath _nfsVersion final File downloadDirectory _storage getFile downloadPath if downloadDirectory exists
try String downloadPath determineStorageTemplatePath storagePath destPath _nfsVersion final File downloadDirectory _storage getFile downloadPath if downloadDirectory exists s_logger debug downloadPath else if downloadDirectory mkdirs final String errMsg downloadPath s_logger error errMsg return new CopyCmdAnswer errMsg File destFile new File downloadDirectory substringAfterLast srcData getPath S3Utils SEPARATOR S3Utils getFile s3 s3 getBucketName srcData getPath destFile waitForCompletion return postProcessing destFile downloadPath destPath srcData destData catch Exception e final String errMsg format e getMessage
FormatInfo info processor process destPath null templateUuid TemplateLocation loc new TemplateLocation _storage destPath loc create true templateUuid loc addFormat info loc save TemplateProp prop loc getTemplateInfo TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath destData getPath File separator templateName newTemplate setFormat ImageFormat VHD newTemplate setSize prop getSize newTemplate setPhysicalSize prop getPhysicalSize newTemplate setName templateUuid return new CopyCmdAnswer newTemplate catch ConfigurationException e s_logger debug e toString
loc addFormat info loc save TemplateProp prop loc getTemplateInfo TemplateObjectTO newTemplate new TemplateObjectTO newTemplate setPath destData getPath File separator templateName newTemplate setFormat ImageFormat VHD newTemplate setSize prop getSize newTemplate setPhysicalSize prop getPhysicalSize newTemplate setName templateUuid return new CopyCmdAnswer newTemplate catch ConfigurationException e s_logger debug e toString errMsg e toString catch InternalErrorException e s_logger debug e toString
protected Answer copySnapshotToTemplateFromNfsToNfs CopyCommand cmd SnapshotObjectTO srcData NfsTO srcDataStore TemplateObjectTO destData NfsTO destDataStore if srcData getHypervisorType HypervisorType XenServer return copySnapshotToTemplateFromNfsToNfsXenserver cmd srcData srcDataStore destData destDataStore else if srcData getHypervisorType HypervisorType KVM File srcFile getFile srcData getPath srcDataStore getUrl _nfsVersion File destFile getFile destData getPath destDataStore getUrl _nfsVersion VolumeObjectTO volumeObjectTO srcData getVolume ImageFormat srcFormat null if volumeObjectTO null srcFormat volumeObjectTO getFormat else srcFormat ImageFormat QCOW2 String templateName srcFile getName String fileName templateName srcFormat getFileExtension String destFileFullPath destFile getAbsolutePath File separator fileName
HttpEntity entity response getEntity if entity null s_logger debug throw new CloudRuntimeException url String nfsMountPath getRootDir nfs getUrl _nfsVersion String filePath nfsMountPath File separator path File directory new File filePath if directory exists _storage mkdirs filePath File destFile new File filePath File separator name if destFile createNewFile s_logger warn destFile getPath try FileOutputStream outputStream new FileOutputStream destFile entity writeTo outputStream catch IOException e
throw new CloudRuntimeException url String nfsMountPath getRootDir nfs getUrl _nfsVersion String filePath nfsMountPath File separator path File directory new File filePath if directory exists _storage mkdirs filePath File destFile new File filePath File separator name if destFile createNewFile s_logger warn destFile getPath try FileOutputStream outputStream new FileOutputStream destFile entity writeTo outputStream catch IOException e s_logger debug e getMessage e return new File destFile getAbsolutePath catch IOException e
String container cmd getId String swiftPath SwiftUtil putObject swiftTO file container null long virtualSize getVirtualSize file getTemplateFormat file getName long size file length String uniqueName cmd getName File uniqDir _storage createUniqDir String metaFileName uniqDir getAbsolutePath File separator _tmpltpp _storage create uniqDir getAbsolutePath _tmpltpp File metaFile swiftWriteMetadataFile metaFileName uniqueName fileName size virtualSize SwiftUtil putObject swiftTO metaFile container _tmpltpp metaFile delete uniqDir delete String md5sum null try FileInputStream fs new FileInputStream file md5sum DigestUtils md5Hex fs
String uniqueName cmd getName File uniqDir _storage createUniqDir String metaFileName uniqDir getAbsolutePath File separator _tmpltpp _storage create uniqDir getAbsolutePath _tmpltpp File metaFile swiftWriteMetadataFile metaFileName uniqueName fileName size virtualSize SwiftUtil putObject swiftTO metaFile container _tmpltpp metaFile delete uniqDir delete String md5sum null try FileInputStream fs new FileInputStream file md5sum DigestUtils md5Hex fs catch IOException e s_logger debug file getAbsoluteFile DownloadAnswer answer new DownloadAnswer null null VMTemplateStorageResourceAssoc Status DOWNLOADED swiftPath swiftPath virtualSize file length md5sum return answer
protected Answer copyFromNfsToS3 CopyCommand cmd final DataTO srcData cmd getSrcTO final DataTO destData cmd getDestTO DataStoreTO srcDataStore srcData getDataStore NfsTO srcStore NfsTO srcDataStore DataStoreTO destDataStore destData getDataStore final S3TO s3 S3TO destDataStore try final String templatePath determineStorageTemplatePath srcStore getUrl srcData getPath _nfsVersion if s_logger isDebugEnabled
public Answer execute DeleteSnapshotsDirCommand cmd DataStoreTO dstore cmd getDataStore if dstore NfsTO NfsTO nfs NfsTO dstore String relativeSnapshotPath cmd getDirectory String parent getRootDir nfs getUrl _nfsVersion if relativeSnapshotPath startsWith File separator relativeSnapshotPath relativeSnapshotPath substring if parent endsWith File separator parent File separator String absoluteSnapshotPath parent relativeSnapshotPath File snapshotDir new File absoluteSnapshotPath String details null if snapshotDir exists details snapshotDir getName
parent File separator String absoluteSnapshotPath parent relativeSnapshotPath File snapshotDir new File absoluteSnapshotPath String details null if snapshotDir exists details snapshotDir getName s_logger debug details return new Answer cmd true details String lPath absoluteSnapshotPath String result deleteLocalFile lPath if result null String errMsg lPath result s_logger warn errMsg return new Answer cmd false errMsg if snapshotDir delete
private Answer execute ComputeChecksumCommand cmd String relativeTemplatePath cmd getTemplatePath DataStoreTO store cmd getStore if store NfsTO return new Answer cmd false NfsTO nfsStore NfsTO store String parent getRootDir nfsStore getUrl _nfsVersion if relativeTemplatePath startsWith File separator relativeTemplatePath relativeTemplatePath substring if parent endsWith File separator parent File separator String absoluteTemplatePath parent relativeTemplatePath String algorithm cmd getAlgorithm File f new File absoluteTemplatePath if s_logger isDebugEnabled
NfsTO nfsStore NfsTO store String parent getRootDir nfsStore getUrl _nfsVersion if relativeTemplatePath startsWith File separator relativeTemplatePath relativeTemplatePath substring if parent endsWith File separator parent File separator String absoluteTemplatePath parent relativeTemplatePath String algorithm cmd getAlgorithm File f new File absoluteTemplatePath if s_logger isDebugEnabled s_logger debug parent relativeTemplatePath String checksum null try InputStream is new FileInputStream f checksum DigestHelper digest algorithm is toString if s_logger isDebugEnabled
String prvKey certs getPrivKey String pubCert certs getPrivCert String certChain certs getCertChain String rootCACert certs getRootCACert try File prvKeyFile File createTempFile null String prvkeyPath prvKeyFile getAbsolutePath try BufferedWriter prvt_key_file new BufferedWriter new FileWriter prvKeyFile prvt_key_file write prvKey catch IOException e s_logger debug e toString File pubCertFile File createTempFile null String pubCertFilePath pubCertFile getAbsolutePath try BufferedWriter pub_cert_file new BufferedWriter new FileWriter pubCertFile pub_cert_file write pubCert
catch IOException e s_logger debug e toString File pubCertFile File createTempFile null String pubCertFilePath pubCertFile getAbsolutePath try BufferedWriter pub_cert_file new BufferedWriter new FileWriter pubCertFile pub_cert_file write pubCert catch IOException e s_logger debug e toString String certChainFilePath null rootCACertFilePath null File certChainFile null rootCACertFile null if certChain null certChainFile File createTempFile null certChainFilePath certChainFile getAbsolutePath try BufferedWriter cert_chain_out new BufferedWriter new FileWriter certChainFile cert_chain_out write certChain
pub_cert_file write pubCert catch IOException e s_logger debug e toString String certChainFilePath null rootCACertFilePath null File certChainFile null rootCACertFile null if certChain null certChainFile File createTempFile null certChainFilePath certChainFile getAbsolutePath try BufferedWriter cert_chain_out new BufferedWriter new FileWriter certChainFile cert_chain_out write certChain catch IOException e s_logger debug e toString if rootCACert null rootCACertFile File createTempFile null rootCACertFilePath rootCACertFile getAbsolutePath
certChainFilePath certChainFile getAbsolutePath try BufferedWriter cert_chain_out new BufferedWriter new FileWriter certChainFile cert_chain_out write certChain catch IOException e s_logger debug e toString if rootCACert null rootCACertFile File createTempFile null rootCACertFilePath rootCACertFile getAbsolutePath try BufferedWriter root_ca_cert_file new BufferedWriter new FileWriter rootCACertFile root_ca_cert_file write rootCACert catch IOException e s_logger debug e toString configureSSL prvkeyPath pubCertFilePath certChainFilePath rootCACertFilePath prvKeyFile delete pubCertFile delete
return new Answer cmd true null Answer answer null DataStoreTO dStore cmd getDataStore if dStore NfsTO String secUrl cmd getSecUrl try URI uri new URI secUrl String nfsHostIp getUriHostIp uri addRouteToInternalIpOrCidr _storageGateway _storageIp _storageNetmask nfsHostIp String dir mountUri uri cmd getNfsVersion configCerts cmd getCerts nfsIps add nfsHostIp answer new SecStorageSetupAnswer dir catch Exception e String msg secUrl e toString
b group bossGroup workerGroup b channel NioServerSocketChannel class b handler new LoggingHandler LogLevel INFO b childHandler new ChannelInitializer SocketChannel Override protected void initChannel SocketChannel ch throws Exception ChannelPipeline pipeline ch pipeline pipeline addLast new HttpRequestDecoder pipeline addLast new HttpResponseEncoder pipeline addLast new HttpContentCompressor pipeline addLast new HttpUploadServerHandler storageResource new Thread Override public void run try Channel ch b bind PORT sync channel
Override protected void initChannel SocketChannel ch throws Exception ChannelPipeline pipeline ch pipeline pipeline addLast new HttpRequestDecoder pipeline addLast new HttpResponseEncoder pipeline addLast new HttpContentCompressor pipeline addLast new HttpUploadServerHandler storageResource new Thread Override public void run try Channel ch b bind PORT sync channel s_logger info String format PORT NO_OF_WORKERS ch closeFuture sync catch InterruptedException e s_logger info
String snapshotPath obj getPath if snapshotPath startsWith File separator snapshotPath snapshotPath substring String fullSnapPath parent snapshotPath File snapDir new File fullSnapPath if snapDir exists snapDir isDirectory s_logger debug snapshotPath return new Answer cmd true null int index snapshotPath lastIndexOf String snapshotName snapshotPath substring index snapshotPath snapshotPath substring index String absoluteSnapshotPath parent snapshotPath File snapshotDir new File absoluteSnapshotPath String details null if snapshotDir exists
String parent getRootDir nfs getUrl _nfsVersion if relativeTemplatePath startsWith File separator relativeTemplatePath relativeTemplatePath substring if parent endsWith File separator parent File separator String absoluteTemplatePath parent relativeTemplatePath File tmpltPath new File absoluteTemplatePath File tmpltParent null if tmpltPath exists tmpltPath isDirectory tmpltParent tmpltPath else tmpltParent tmpltPath getParentFile String details null if tmpltParent exists details tmpltParent getName
parent File separator String absoluteTemplatePath parent relativeTemplatePath File tmpltPath new File absoluteTemplatePath File tmpltParent null if tmpltPath exists tmpltPath isDirectory tmpltParent tmpltPath else tmpltParent tmpltPath getParentFile String details null if tmpltParent exists details tmpltParent getName s_logger debug details return new Answer cmd true details File tmpltFiles tmpltParent listFiles if tmpltFiles null tmpltFiles length
return new Answer cmd true details File tmpltFiles tmpltParent listFiles if tmpltFiles null tmpltFiles length details tmpltParent getName s_logger debug details else boolean found false for File f tmpltFiles if found f getName equals _tmpltpp found true if f isDirectory f getName equals s_logger debug File haFiles f listFiles for File haFile haFiles haFile delete
if tmpltFiles null tmpltFiles length details tmpltParent getName s_logger debug details else boolean found false for File f tmpltFiles if found f getName equals _tmpltpp found true if f isDirectory f getName equals s_logger debug File haFiles f listFiles for File haFile haFiles haFile delete if f delete return new Answer cmd false f getName relativeTemplatePath
String parent getRootDir nfs getUrl _nfsVersion if relativeVolumePath startsWith File separator relativeVolumePath relativeVolumePath substring if parent endsWith File separator parent File separator String absoluteVolumePath parent relativeVolumePath File volPath new File absoluteVolumePath File tmpltParent null if volPath exists volPath isDirectory tmpltParent volPath else tmpltParent new File absoluteVolumePath getParentFile String details null if tmpltParent exists details tmpltParent getName
parent File separator String absoluteVolumePath parent relativeVolumePath File volPath new File absoluteVolumePath File tmpltParent null if volPath exists volPath isDirectory tmpltParent volPath else tmpltParent new File absoluteVolumePath getParentFile String details null if tmpltParent exists details tmpltParent getName s_logger debug details return new Answer cmd true details File tmpltFiles tmpltParent listFiles if tmpltFiles null tmpltFiles length
return new Answer cmd true details File tmpltFiles tmpltParent listFiles if tmpltFiles null tmpltFiles length details tmpltParent getName s_logger debug details else boolean found false for File f tmpltFiles if found f getName equals found true if f isDirectory f getName equals s_logger debug File haFiles f listFiles for File haFile haFiles haFile delete
if tmpltFiles null tmpltFiles length details tmpltParent getName s_logger debug details else boolean found false for File f tmpltFiles if found f getName equals found true if f isDirectory f getName equals s_logger debug File haFiles f listFiles for File haFile haFiles haFile delete if f delete return new Answer cmd false f getName tmpltParent getPath
s_logger debug localgw eth1ip eth1mask destIpOrCidr if destIpOrCidr null s_logger debug return if NetUtils isValidIp4 destIpOrCidr NetUtils isValidIp4Cidr destIpOrCidr s_logger warn destIpOrCidr return boolean inSameSubnet false if NetUtils isValidIp4 destIpOrCidr if eth1ip null eth1mask null inSameSubnet NetUtils sameSubnet eth1ip destIpOrCidr eth1mask else s_logger warn eth1ip destIpOrCidr eth1mask else inSameSubnet NetUtils isNetworkAWithinNetworkB destIpOrCidr NetUtils ipAndNetMaskToCidr eth1ip eth1mask
else s_logger warn eth1ip destIpOrCidr eth1mask else inSameSubnet NetUtils isNetworkAWithinNetworkB destIpOrCidr NetUtils ipAndNetMaskToCidr eth1ip eth1mask if inSameSubnet s_logger debug destIpOrCidr eth1ip return Script command new Script s_logger command add command add destIpOrCidr command execute command new Script s_logger command add command add destIpOrCidr localgw String result command execute
protected String mountUri URI uri String nfsVersion throws UnknownHostException String uriHostIp getUriHostIp uri String nfsPath uriHostIp uri getPath String dir UUID nameUUIDFromBytes nfsPath getBytes com cloud utils StringUtils getPreferredCharset toString String localRootPath _parent dir String remoteDevice if uri getScheme equals remoteDevice uriHostIp uri getPath
protected void mount String localRootPath String remoteDevice URI uri String nfsVersion
protected void attemptMount String localRootPath String remoteDevice URI uri String nfsVersion String result
String result s_logger debug remoteDevice localRootPath uri nfsVersion null nfsVersion Script command new Script _inSystemVM _timeout s_logger String scheme uri getScheme toLowerCase command add scheme if scheme equals if equalsIgnoreCase System getProperty command add if _inSystemVM command add nfsVersion null nfsVersion else if scheme equals String extraOpts parseCifsMountOptions uri command add extraOpts else String errMsg scheme uri toString
command add if _inSystemVM command add nfsVersion null nfsVersion else if scheme equals String extraOpts parseCifsMountOptions uri command add extraOpts else String errMsg scheme uri toString s_logger error errMsg throw new CloudRuntimeException errMsg command add remoteDevice command add localRootPath result command execute if result null String errMsg remoteDevice localRootPath result
else if scheme equals String extraOpts parseCifsMountOptions uri command add extraOpts else String errMsg scheme uri toString s_logger error errMsg throw new CloudRuntimeException errMsg command add remoteDevice command add localRootPath result command execute if result null String errMsg remoteDevice localRootPath result s_logger error errMsg File file new File localRootPath if file exists
protected String parseCifsMountOptions URI uri List NameValuePair args URLEncodedUtils parse uri boolean foundUser false boolean foundPswd false StringBuilder extraOpts new StringBuilder for NameValuePair nvp args String name nvp getName if name equals foundUser true
protected String parseCifsMountOptions URI uri List NameValuePair args URLEncodedUtils parse uri boolean foundUser false boolean foundPswd false StringBuilder extraOpts new StringBuilder for NameValuePair nvp args String name nvp getName if name equals foundUser true s_logger debug foundUser else if name equals foundPswd true s_logger debug extraOpts append name nvp getValue if s_logger isDebugEnabled
boolean foundPswd false StringBuilder extraOpts new StringBuilder for NameValuePair nvp args String name nvp getName if name equals foundUser true s_logger debug foundUser else if name equals foundPswd true s_logger debug extraOpts append name nvp getValue if s_logger isDebugEnabled s_logger error extraOpts if foundUser foundPswd String errMsg
protected boolean mountExists String localRootPath URI uri Script script null script new Script _inSystemVM _timeout s_logger List String res new ArrayList String PathParser parser new PathParser localRootPath script execute parser res addAll parser getPaths for String s res if s contains localRootPath
protected void ensureLocalRootPathExists String localRootPath URI uri
protected void ensureLocalRootPathExists String localRootPath URI uri s_logger debug localRootPath uri toString File file new File localRootPath
protected void ensureLocalRootPathExists String localRootPath URI uri s_logger debug localRootPath uri toString File file new File localRootPath s_logger debug file getPath if file exists
protected void ensureLocalRootPathExists String localRootPath URI uri s_logger debug localRootPath uri toString File file new File localRootPath s_logger debug file getPath if file exists s_logger debug file getPath _storage mkdir file getPath if file exists String errMsg localRootPath uri toString
protected String getUriHostIp URI uri throws UnknownHostException String nfsHost uri getHost InetAddress nfsHostAddr InetAddress getByName nfsHost String nfsHostIp nfsHostAddr getHostAddress
protected boolean createDir String dirName String dirLocation String mountPoint boolean dirExists false File dir new File dirLocation if dir exists if dir isDirectory
protected boolean createDir String dirName String dirLocation String mountPoint boolean dirExists false File dir new File dirLocation if dir exists if dir isDirectory s_logger debug dirName mountPoint dirExists true else if dir delete _storage mkdir dirLocation dirExists true else if _storage mkdir dirLocation dirExists true if dirExists s_logger info dirName else
File accountTemplateDir new File rootDir getTemplatePathForAccount accountId if accountTemplateDir exists FileUtils sizeOfDirectory accountTemplateDir long accountVolumeDirSize File accountVolumeDir new File rootDir getVolumePathForAccount accountId if accountVolumeDir exists accountVolumeDirSize FileUtils sizeOfDirectory accountVolumeDir long accountSnapshotDirSize File accountSnapshotDir new File rootDir getSnapshotPathForAccount accountId if accountSnapshotDir exists accountSnapshotDirSize FileUtils sizeOfDirectory accountSnapshotDir s_logger debug accountTemplateDirSize accountSnapshotDirSize accountVolumeDirSize int accountDirSizeInGB getSizeInGB accountTemplateDirSize accountSnapshotDirSize accountVolumeDirSize int defaultMaxAccountSecondaryStorageInGB Integer parseInt cmd getDefaultMaxAccountSecondaryStorage if defaultMaxAccountSecondaryStorageInGB Resource RESOURCE_UNLIMITED accountDirSizeInGB contentLengthInGB defaultMaxAccountSecondaryStorageInGB
UploadEntity ResourceType resourceType uploadEntity getResourceType String fileSavedTempLocation uploadEntity getInstallPathPrefix filename String dummyFileName uploadEntity getFormat getFileExtension if ImageStoreUtil isCompressedExtension filename String uploadedFileExtension FilenameUtils getExtension filename dummyFileName uploadedFileExtension String formatError ImageStoreUtil checkTemplateFormat fileSavedTempLocation dummyFileName if StringUtils isNotBlank formatError String errorString uploadEntity getFormat formatError s_logger error errorString return errorString int imgSizeGigs getSizeInGB _storage getSize fileSavedTempLocation int maxSize uploadEntity getMaxSizeInGB if imgSizeGigs maxSize String errorMessage imgSizeGigs maxSize
Override public Map extends ServerResource Map String String find long dcId Long podId Long clusterId URI uri String username String password List String hostTags if uri getScheme equalsIgnoreCase uri getScheme equalsIgnoreCase uri getScheme equalsIgnoreCase uri getScheme equalsIgnoreCase uri getScheme equalsIgnoreCase
LOGGER info jobId status LOGGER info td getDownloadLocalPath toHumanReadableSize td getDownloadedBytes td getDownloadError td getDownloadPercent switch status case ABORTED case NOT_STARTED case UNRECOVERABLE_ERROR dj cleanup break case UNKNOWN return case IN_PROGRESS LOGGER info jobId status td setResume true threadPool execute td break case RECOVERABLE_ERROR threadPool execute td break case DOWNLOAD_FINISHED if td S3TemplateDownloader td setDownloadError String result postRemoteDownload jobId
break case DOWNLOAD_FINISHED if td S3TemplateDownloader td setDownloadError String result postRemoteDownload jobId if result null LOGGER error result td setStatus Status UNRECOVERABLE_ERROR td setDownloadError result S3TemplateDownloader td cleanupAfterError else td setStatus Status POST_DOWNLOAD_FINISHED td setDownloadError new SimpleDateFormat format new Date else td setDownloadError String result postLocalDownload jobId
private String postLocalDownload String jobId DownloadJob dnld jobs get jobId TemplateDownloader td dnld getTemplateDownloader String resourcePath dnld getInstallPathPrefix String finalResourcePath dnld getTmpltPath ResourceType resourceType dnld getResourceType File originalTemplate new File td getDownloadLocalPath if StringUtils isBlank dnld getChecksum if LOGGER isInfoEnabled
private String checkOrCreateTheChecksum DownloadJob dnld File targetFile ChecksumValue oldValue new ChecksumValue dnld getChecksum ChecksumValue newValue null try newValue computeCheckSum oldValue getAlgorithm targetFile if LOGGER isDebugEnabled
private List String listVolumes String rootdir List String result new ArrayList String Script script new Script listVolScr LOGGER script add rootdir PathParser zpp new PathParser rootdir script execute zpp if script getExitValue
private List String listTemplates String rootdir List String result new ArrayList String Script script new Script listTmpltScr LOGGER script add rootdir PathParser zpp new PathParser rootdir script execute zpp if script getExitValue
LOGGER warn path _storage cleanup path templateDir continue catch IOException e LOGGER warn path e continue TemplateProp tInfo loc getTemplateInfo if tInfo getSize tInfo getPhysicalSize tInfo getInstallPath endsWith ImageFormat OVA getFileExtension try Processor processor _processors get OVAProcessor vmdkProcessor OVAProcessor processor long vSize vmdkProcessor getTemplateVirtualSize path tInfo getInstallPath substring tInfo getInstallPath lastIndexOf File separator tInfo setSize vSize loc updateVirtualSize vSize loc save
continue catch IOException e LOGGER warn path e continue TemplateProp tInfo loc getTemplateInfo if tInfo getSize tInfo getPhysicalSize tInfo getInstallPath endsWith ImageFormat OVA getFileExtension try Processor processor _processors get OVAProcessor vmdkProcessor OVAProcessor processor long vSize vmdkProcessor getTemplateVirtualSize path tInfo getInstallPath substring tInfo getInstallPath lastIndexOf File separator tInfo setSize vSize loc updateVirtualSize vSize loc save catch Exception e LOGGER error tInfo getInstallPath e getMessage
LOGGER warn path _storage cleanup path volumeDir continue catch IOException e LOGGER warn path e continue TemplateProp vInfo loc getTemplateInfo if vInfo getSize vInfo getPhysicalSize vInfo getInstallPath endsWith ImageFormat OVA getFileExtension try Processor processor _processors get OVAProcessor vmdkProcessor OVAProcessor processor long vSize vmdkProcessor getTemplateVirtualSize path vInfo getInstallPath substring vInfo getInstallPath lastIndexOf File separator vInfo setSize vSize loc updateVirtualSize vSize loc save
continue catch IOException e LOGGER warn path e continue TemplateProp vInfo loc getTemplateInfo if vInfo getSize vInfo getPhysicalSize vInfo getInstallPath endsWith ImageFormat OVA getFileExtension try Processor processor _processors get OVAProcessor vmdkProcessor OVAProcessor processor long vSize vmdkProcessor getTemplateVirtualSize path vInfo getInstallPath substring vInfo getInstallPath lastIndexOf File separator vInfo setSize vSize loc updateVirtualSize vSize loc save catch Exception e LOGGER error vInfo getInstallPath e getMessage
Override public String uploadPublicTemplate long id String url String name ImageFormat format Long accountId String descr String cksum String installPathPrefix String userName String passwd long templateSizeInBytes UUID uuid UUID randomUUID String jobId uuid toString String completePath parentDir File separator installPathPrefix
UUID uuid UUID randomUUID String jobId uuid toString String completePath parentDir File separator installPathPrefix s_logger debug completePath URI uri try uri new URI url catch URISyntaxException e s_logger error url throw new CloudRuntimeException url TemplateUploader tu if uri null uri getScheme null if uri getScheme equalsIgnoreCase tu new FtpTemplateUploader completePath url new Completion jobId templateSizeInBytes else
s_logger debug completePath URI uri try uri new URI url catch URISyntaxException e s_logger error url throw new CloudRuntimeException url TemplateUploader tu if uri null uri getScheme null if uri getScheme equalsIgnoreCase tu new FtpTemplateUploader completePath url new Completion jobId templateSizeInBytes else s_logger error url throw new CloudRuntimeException url else
Override public CreateEntityDownloadURLAnswer handleCreateEntityURLCommand CreateEntityDownloadURLCommand cmd boolean isApacheUp checkAndStartApache if isApacheUp String errorString
boolean isApacheUp checkAndStartApache if isApacheUp String errorString s_logger error errorString return new CreateEntityDownloadURLAnswer errorString CreateEntityDownloadURLAnswer RESULT_FAILURE String extractDir Script command new Script s_logger command add command add command add command add extractDir command add String result command execute if result null String errorString result
command add command add command add extractDir command add String result command execute if result null String errorString result s_logger error errorString return new CreateEntityDownloadURLAnswer errorString CreateEntityDownloadURLAnswer RESULT_FAILURE String uuid cmd getExtractLinkUUID command new Script s_logger command add command add cmd getParent File separator cmd getInstallPath extractDir uuid result command execute if result null
s_logger warn jobId status s_logger warn toHumanReadableSize tu getUploadedBytes tu getUploadError tu getUploadPercent switch status case ABORTED case NOT_STARTED case UNRECOVERABLE_ERROR if uj getTemplateUploader getUploadLocalPath indexOf uj cleanup break case UNKNOWN return case IN_PROGRESS s_logger info jobId status tu setResume true threadPool execute tu break case RECOVERABLE_ERROR threadPool execute tu break case UPLOAD_FINISHED tu setUploadError String result postUpload jobId
String arg iter next if arg equals host iter next if arg equals numThreads Integer parseInt iter next if arg equals numVM Integer parseInt iter next if arg equals zoneId Integer parseInt iter next if arg equals templateId Integer parseInt iter next if arg equals serviceOfferingId Integer parseInt iter next final String server host ApiPort final String developerServer host DeveloperPort ApiUrl
if arg equals serviceOfferingId Integer parseInt iter next final String server host ApiPort final String developerServer host DeveloperPort ApiUrl s_logger info numThreads numVM for int i i numThreads i new Thread new Runnable Override public void run try String username null String singlePrivateIp null Random ran new Random username Math abs ran nextInt User myUser new User username username server developerServer try
for int i i numThreads i new Thread new Runnable Override public void run try String username null String singlePrivateIp null Random ran new Random username Math abs ran nextInt User myUser new User username username server developerServer try myUser launchUser myUser registerUser catch Exception e s_logger warn e if myUser getUserId null
Override public void run try String username null String singlePrivateIp null Random ran new Random username Math abs ran nextInt User myUser new User username username server developerServer try myUser launchUser myUser registerUser catch Exception e s_logger warn e if myUser getUserId null s_logger info myUser getUserName for int i i numVM i
Random ran new Random username Math abs ran nextInt User myUser new User username username server developerServer try myUser launchUser myUser registerUser catch Exception e s_logger warn e if myUser getUserId null s_logger info myUser getUserName for int i i numVM i VirtualMachine myVM new VirtualMachine myUser getUserId myVM deployVM zoneId serviceOfferingId templateId myUser getDeveloperServer myUser getApiKey myUser getSecretKey myUser getVirtualMachines add myVM singlePrivateIp myVM getPrivateIp
username Math abs ran nextInt User myUser new User username username server developerServer try myUser launchUser myUser registerUser catch Exception e s_logger warn e if myUser getUserId null s_logger info myUser getUserName for int i i numVM i VirtualMachine myVM new VirtualMachine myUser getUserId myVM deployVM zoneId serviceOfferingId templateId myUser getDeveloperServer myUser getApiKey myUser getSecretKey myUser getVirtualMachines add myVM singlePrivateIp myVM getPrivateIp if singlePrivateIp null
Override public void run NDC push Thread currentThread getName int retry s_logger info this virtualMachines size while true try if retry
s_logger info retry Thread sleep for VirtualMachine vm this virtualMachines s_logger info this publicIp retry Connection conn new Connection this publicIp conn connect null s_logger info this publicIp boolean isAuthenticated conn authenticateWithPassword if isAuthenticated false s_logger info Session sess conn openSession String fileName Random ran new Random fileName Math abs ran nextInt String copyCommand new String vm getPrivateIp fileName
fileName Math abs ran nextInt String copyCommand new String vm getPrivateIp fileName s_logger info copyCommand sess execCommand copyCommand Thread sleep sess close sess conn openSession String downloadCommand new String s_logger info downloadCommand sess execCommand downloadCommand Thread sleep sess close conn close catch Exception ex s_logger error ex
public static void main String args List String argsList Arrays asList args Iterator String iter argsList iterator String host int numThreads while iter hasNext String arg iter next if arg equals host iter next if arg equals numThreads Integer parseInt iter next if arg equals s_numVM Integer parseInt iter next final String server host ApiPort final String developerServer host DeveloperPort ApiUrl
final String server host ApiPort final String developerServer host DeveloperPort ApiUrl s_logger info numThreads s_numVM for int i i numThreads i new Thread new Runnable Override public void run try String username null String singlePrivateIp null String singlePublicIp null Random ran new Random username Math abs ran nextInt User myUser new User username username server developerServer try myUser launchUser
String username null String singlePrivateIp null String singlePublicIp null Random ran new Random username Math abs ran nextInt User myUser new User username username server developerServer try myUser launchUser myUser registerUser catch Exception e s_logger warn e if myUser getUserId null s_logger info myUser getUserName for int i i s_numVM i VirtualMachine myVM new VirtualMachine myUser getUserId
String singlePublicIp null Random ran new Random username Math abs ran nextInt User myUser new User username username server developerServer try myUser launchUser myUser registerUser catch Exception e s_logger warn e if myUser getUserId null s_logger info myUser getUserName for int i i s_numVM i VirtualMachine myVM new VirtualMachine myUser getUserId myVM deployVM ZoneId ServiceOfferingId TemplateId myUser getDeveloperServer myUser getApiKey myUser getSecretKey myUser getVirtualMachines add myVM
myUser launchUser myUser registerUser catch Exception e s_logger warn e if myUser getUserId null s_logger info myUser getUserName for int i i s_numVM i VirtualMachine myVM new VirtualMachine myUser getUserId myVM deployVM ZoneId ServiceOfferingId TemplateId myUser getDeveloperServer myUser getApiKey myUser getSecretKey myUser getVirtualMachines add myVM singlePrivateIp myVM getPrivateIp if singlePrivateIp null s_logger info singlePrivateIp else s_logger info myUser getUserName
catch Exception e s_logger warn e if myUser getUserId null s_logger info myUser getUserName for int i i s_numVM i VirtualMachine myVM new VirtualMachine myUser getUserId myVM deployVM ZoneId ServiceOfferingId TemplateId myUser getDeveloperServer myUser getApiKey myUser getSecretKey myUser getVirtualMachines add myVM singlePrivateIp myVM getPrivateIp if singlePrivateIp null s_logger info singlePrivateIp else s_logger info myUser getUserName break myUser retrievePublicIp ZoneId
s_logger info myUser getUserName for int i i s_numVM i VirtualMachine myVM new VirtualMachine myUser getUserId myVM deployVM ZoneId ServiceOfferingId TemplateId myUser getDeveloperServer myUser getApiKey myUser getSecretKey myUser getVirtualMachines add myVM singlePrivateIp myVM getPrivateIp if singlePrivateIp null s_logger info singlePrivateIp else s_logger info myUser getUserName break myUser retrievePublicIp ZoneId singlePublicIp myUser getPublicIp get myUser getPublicIp size if singlePublicIp null s_logger info singlePublicIp myUser getUserName
private static int CreateForwardingRule User myUser String privateIp String publicIp String publicPort String privatePort throws IOException String encodedPrivateIp URLEncoder encode privateIp String encodedPublicIp URLEncoder encode publicIp String encodedPrivatePort URLEncoder encode privatePort String encodedPublicPort URLEncoder encode publicPort String encodedApiKey URLEncoder encode myUser getApiKey int responseCode String requestToSign encodedApiKey encodedPrivateIp encodedPrivatePort encodedPublicIp encodedPublicPort requestToSign requestToSign toLowerCase
private static int CreateForwardingRule User myUser String privateIp String publicIp String publicPort String privatePort throws IOException String encodedPrivateIp URLEncoder encode privateIp String encodedPublicIp URLEncoder encode publicIp String encodedPrivatePort URLEncoder encode privatePort String encodedPublicPort URLEncoder encode publicPort String encodedApiKey URLEncoder encode myUser getApiKey int responseCode String requestToSign encodedApiKey encodedPrivateIp encodedPrivatePort encodedPublicIp encodedPublicPort requestToSign requestToSign toLowerCase s_logger info requestToSign String signature TestClientWithAPI signRequest requestToSign myUser getSecretKey String encodedSignature URLEncoder encode signature String url myUser getDeveloperServer encodedPublicIp encodedPublicPort encodedPrivateIp encodedPrivatePort encodedApiKey encodedSignature
String encodedPublicIp URLEncoder encode publicIp String encodedPrivatePort URLEncoder encode privatePort String encodedPublicPort URLEncoder encode publicPort String encodedApiKey URLEncoder encode myUser getApiKey int responseCode String requestToSign encodedApiKey encodedPrivateIp encodedPrivatePort encodedPublicIp encodedPublicPort requestToSign requestToSign toLowerCase s_logger info requestToSign String signature TestClientWithAPI signRequest requestToSign myUser getSecretKey String encodedSignature URLEncoder encode signature String url myUser getDeveloperServer encodedPublicIp encodedPublicPort encodedPrivateIp encodedPrivatePort encodedApiKey encodedSignature s_logger info url HttpClient client new HttpClient HttpMethod method new GetMethod url responseCode client executeMethod method
requestToSign requestToSign toLowerCase s_logger info requestToSign String signature TestClientWithAPI signRequest requestToSign myUser getSecretKey String encodedSignature URLEncoder encode signature String url myUser getDeveloperServer encodedPublicIp encodedPublicPort encodedPrivateIp encodedPrivatePort encodedApiKey encodedSignature s_logger info url HttpClient client new HttpClient HttpMethod method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode s_logger info else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String
String signature TestClientWithAPI signRequest requestToSign myUser getSecretKey String encodedSignature URLEncoder encode signature String url myUser getDeveloperServer encodedPublicIp encodedPublicPort encodedPrivateIp encodedPrivatePort encodedApiKey encodedSignature s_logger info url HttpClient client new HttpClient HttpMethod method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode s_logger info else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String s_logger error errorInfo get errorInfo get else
public void retrievePublicIp long zoneId throws IOException String encodedApiKey URLEncoder encode this apiKey String encodedZoneId URLEncoder encode zoneId String requestToSign encodedApiKey encodedZoneId requestToSign requestToSign toLowerCase String signature TestClientWithAPI signRequest requestToSign this secretKey String encodedSignature URLEncoder encode signature String url this developerServer encodedApiKey encodedZoneId encodedSignature HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Map String String values TestClientWithAPI getSingleValueFromXML is new String this getPublicIp add values get
requestToSign requestToSign toLowerCase String signature TestClientWithAPI signRequest requestToSign this secretKey String encodedSignature URLEncoder encode signature String url this developerServer encodedApiKey encodedZoneId encodedSignature HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Map String String values TestClientWithAPI getSingleValueFromXML is new String this getPublicIp add values get s_logger info values get else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String
String encodedSignature URLEncoder encode signature String url this developerServer encodedApiKey encodedZoneId encodedSignature HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Map String String values TestClientWithAPI getSingleValueFromXML is new String this getPublicIp add values get s_logger info values get else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String s_logger error errorInfo get errorInfo get else
public void registerUser throws HttpException IOException String encodedUsername URLEncoder encode this userName String encodedPassword URLEncoder encode this password String url server encodedUsername
String encodedUsername URLEncoder encode this userName String encodedPassword URLEncoder encode this password String url server encodedUsername s_logger info this userName url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Map String String requestKeyValues TestClientWithAPI getSingleValueFromXML is new String this setApiKey requestKeyValues get this setSecretKey requestKeyValues get else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String
String url server encodedUsername s_logger info this userName url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Map String String requestKeyValues TestClientWithAPI getSingleValueFromXML is new String this setApiKey requestKeyValues get this setSecretKey requestKeyValues get else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String s_logger error errorInfo get errorInfo get else
public void deployVM long zoneId long serviceOfferingId long templateId String server String apiKey String secretKey throws IOException String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId String encodedApiKey URLEncoder encode apiKey String requestToSign encodedApiKey encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase String signature TestClientWithAPI signRequest requestToSign secretKey String encodedSignature URLEncoder encode signature String url server encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature
public void deployVM long zoneId long serviceOfferingId long templateId String server String apiKey String secretKey throws IOException String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId String encodedApiKey URLEncoder encode apiKey String requestToSign encodedApiKey encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase String signature TestClientWithAPI signRequest requestToSign secretKey String encodedSignature URLEncoder encode signature String url server encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature s_logger info url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
String encodedApiKey URLEncoder encode apiKey String requestToSign encodedApiKey encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase String signature TestClientWithAPI signRequest requestToSign secretKey String encodedSignature URLEncoder encode signature String url server encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature s_logger info url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String values TestClientWithAPI getSingleValueFromXML is new String long linuxVMId Long parseLong values get
String url server encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature s_logger info url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String values TestClientWithAPI getSingleValueFromXML is new String long linuxVMId Long parseLong values get s_logger info linuxVMId this setPrivateIp values get else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String
HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String values TestClientWithAPI getSingleValueFromXML is new String long linuxVMId Long parseLong values get s_logger info linuxVMId this setPrivateIp values get else if responseCode InputStream is method getResponseBodyAsStream Map String String errorInfo TestClientWithAPI getSingleValueFromXML is new String s_logger error errorInfo get errorInfo get else
temp temp key value catch Exception ex s_logger error key this getName this command temp else if this getCommandType CommandType MYSQL String temp this commandName Set c this urlParam entrySet Iterator it c iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue try temp temp key value catch Exception ex
String value String me getValue try temp temp key value catch Exception ex s_logger error key this getName this command temp s_logger info this command else if param get null param get null this isUserCommand false String temp this host this commandName Set c this urlParam entrySet Iterator it c iterator while it hasNext Map Entry me Map Entry it next String key String me getKey
Map Entry me Map Entry it next String key String me getKey String value String me getValue try temp temp key URLEncoder encode value catch Exception ex s_logger error key this getName this command temp else if isUserCommand true String apiKey param get String secretKey param get String temp this urlParam put apiKey this urlParam put this commandName Set c this urlParam entrySet
public void sendCommand HttpClient client Connection conn if TestCaseEngine s_printUrl true s_logger info this command if this getCommandType CommandType SCRIPT try s_logger info this command Runtime rtime Runtime getRuntime Process child rtime exec this command Thread sleep int retCode child waitFor if retCode this responseCode retCode else this responseCode catch Exception ex
Process child rtime exec this command Thread sleep int retCode child waitFor if retCode this responseCode retCode else this responseCode catch Exception ex s_logger error this command ex else if this getCommandType CommandType MYSQL try Statement stmt conn createStatement this result stmt executeQuery this command this responseCode catch Exception ex
Boolean result true if this getCommandType CommandType MYSQL Set set this setParam entrySet Iterator it set iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue try String itemName null while this result next itemName this result getString value if itemName null param put key itemName else
Set set this setParam entrySet Iterator it set iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue try String itemName null while this result next itemName this result getString value if itemName null param put key itemName else s_logger error value result false
catch Exception ex s_logger error value ex else if this getCommandType CommandType HTTP if this list false Set set this setParam entrySet Iterator it set iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue NodeList itemName this responseBody getElementsByTagName value if itemName null itemName getLength for int i i itemName getLength i Element itemNameElement Element itemName item i if itemNameElement getChildNodes getLength
if itemNameElement getChildNodes getLength param put key itemNameElement getTextContent break else s_logger error value result false else Set set this setParam entrySet Iterator it set iterator NodeList returnLst this responseBody getElementsByTagName this listName getTextContent Node requiredNode returnLst item Integer parseInt this listId getTextContent if requiredNode getNodeType Node ELEMENT_NODE Element fstElmnt Element requiredNode while it hasNext Map Entry me Map Entry it next
public boolean verifyParam boolean result true if this getCommandType CommandType HTTP if this list false Set set verifyParam entrySet Iterator it set iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue if value null
Set set verifyParam entrySet Iterator it set iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue if value null s_logger error key return false NodeList itemName this responseBody getElementsByTagName key if itemName getLength itemName null Element itemNameElement Element itemName item if itemNameElement hasChildNodes continue if verifyParam get key equals itemNameElement getTextContent equals verifyParam get key
Map Entry me Map Entry it next String key String me getKey String value String me getValue if value null s_logger error key return false NodeList itemName this responseBody getElementsByTagName key if itemName getLength itemName null Element itemNameElement Element itemName item if itemNameElement hasChildNodes continue if verifyParam get key equals itemNameElement getTextContent equals verifyParam get key s_logger error key verifyParam get key itemNameElement getTextContent result false else
s_logger error key verifyParam get key itemNameElement getTextContent result false else s_logger error key result false else Set set verifyParam entrySet Iterator it set iterator NodeList returnLst this responseBody getElementsByTagName this listName getTextContent Node requiredNode returnLst item Integer parseInt this listId getTextContent if requiredNode getNodeType Node ELEMENT_NODE Element fstElmnt Element requiredNode while it hasNext Map Entry me Map Entry it next String key String me getKey
result false else Set set verifyParam entrySet Iterator it set iterator NodeList returnLst this responseBody getElementsByTagName this listName getTextContent Node requiredNode returnLst item Integer parseInt this listId getTextContent if requiredNode getNodeType Node ELEMENT_NODE Element fstElmnt Element requiredNode while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue if value null s_logger error key return false
else Set set verifyParam entrySet Iterator it set iterator NodeList returnLst this responseBody getElementsByTagName this listName getTextContent Node requiredNode returnLst item Integer parseInt this listId getTextContent if requiredNode getNodeType Node ELEMENT_NODE Element fstElmnt Element requiredNode while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue if value null s_logger error key return false NodeList itemName fstElmnt getElementsByTagName key
String key String me getKey String value String me getValue if value null s_logger error key return false NodeList itemName fstElmnt getElementsByTagName key if itemName getLength itemName null Element itemNameElement Element itemName item if verifyParam get key equals itemNameElement getTextContent equals verifyParam get key s_logger error key verifyParam get key itemNameElement getTextContent result false else s_logger error key result false else if this getCommandType CommandType MYSQL
if itemName getLength itemName null Element itemNameElement Element itemName item if verifyParam get key equals itemNameElement getTextContent equals verifyParam get key s_logger error key verifyParam get key itemNameElement getTextContent result false else s_logger error key result false else if this getCommandType CommandType MYSQL Set set verifyParam entrySet Iterator it set iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue
if verifyParam get key equals itemNameElement getTextContent equals verifyParam get key s_logger error key verifyParam get key itemNameElement getTextContent result false else s_logger error key result false else if this getCommandType CommandType MYSQL Set set verifyParam entrySet Iterator it set iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue if value null s_logger error key
boolean result false HashMap String Integer expectedEvents new HashMap String Integer HashMap String Integer actualEvents new HashMap String Integer String key File file new File fileName if file exists Properties pro new Properties try FileInputStream in new FileInputStream file pro load in Enumeration en pro propertyNames while en hasMoreElements key String en nextElement expectedEvents put key Integer parseInt pro getProperty key String url host account level
if actualEvents containsKey element get true actualEvents put element get actualEvents get element get else actualEvents put element get method releaseConnection Iterator iterator expectedEvents keySet iterator Integer expected Integer actual int fail while iterator hasNext expected null actual null String type iterator next toString expected expectedEvents get type actual actualEvents get type
actualEvents put element get method releaseConnection Iterator iterator expectedEvents keySet iterator Integer expected Integer actual int fail while iterator hasNext expected null actual null String type iterator next toString expected expectedEvents get type actual actualEvents get type if actual null s_logger error type level expected fail
HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream ArrayList HashMap String String eventValues UtilsForTest parseMulXML is new String for int i i eventValues size i HashMap String String element eventValues get i if element get equals level if actualEvents containsKey element get true actualEvents put element get actualEvents get element get else actualEvents put element get method releaseConnection catch Exception ex
else actualEvents put element get method releaseConnection catch Exception ex s_logger error ex Iterator iterator expectedEvents keySet iterator Integer expected Integer actual int fail while iterator hasNext expected null actual null String type iterator next toString expected expectedEvents get type actual actualEvents get type
method releaseConnection catch Exception ex s_logger error ex Iterator iterator expectedEvents keySet iterator Integer expected Integer actual int fail while iterator hasNext expected null actual null String type iterator next toString expected expectedEvents get type actual actualEvents get type if actual null s_logger error type level expected
Element jobStatusTag Element returnBody getElementsByTagName item String jobStatus jobStatusTag getTextContent if jobStatus equals try Thread sleep catch InterruptedException e s_logger debug else break method releaseConnection else s_logger error code this responseCode code return null catch Exception ex
Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands if api getName equals s_logger info this getParam get try Connection conn new Connection this getParam get conn connect null s_logger info this getParam get boolean isAuthenticated conn authenticateWithPassword if isAuthenticated false s_logger info return false String restartCommand Session sess conn openSession
Connection conn new Connection this getParam get conn connect null s_logger info this getParam get boolean isAuthenticated conn authenticateWithPassword if isAuthenticated false s_logger info return false String restartCommand Session sess conn openSession s_logger info restartCommand sess execCommand restartCommand Thread sleep sess close conn close catch Exception ex
s_logger info return false String restartCommand Session sess conn openSession s_logger info restartCommand sess execCommand restartCommand Thread sleep sess close conn close catch Exception ex s_logger error ex return false else api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode api getTestCaseInfo null
Session sess conn openSession s_logger info restartCommand sess execCommand restartCommand Thread sleep sess close conn close catch Exception ex s_logger error ex return false else api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode api getTestCaseInfo null s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode
sess close conn close catch Exception ex s_logger error ex return false else api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode api getTestCaseInfo null s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false else
catch Exception ex s_logger error ex return false else api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode api getTestCaseInfo null s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false else if api verifyParam false s_logger error api getName api getUrl
return false else api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode api getTestCaseInfo null s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false else if api verifyParam false s_logger error api getName api getUrl error else if api getTestCaseInfo null
s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false else if api verifyParam false s_logger error api getName api getUrl error else if api getTestCaseInfo null s_logger info api getTestCaseInfo api getUrl else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getName api getResponseCode api getUrl api getRequired if api getRequired true
NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i boolean verify false Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands if eachElement getElementsByTagName getLength api getName equals if api getName startsWith if this denyToExecute api setResponseType ResponseType EMPTY verify true if this denyToExecute api setResponseType ResponseType ERROR api sendCommand this getClient null if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY
Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands if eachElement getElementsByTagName getLength api getName equals if api getName startsWith if this denyToExecute api setResponseType ResponseType EMPTY verify true if this denyToExecute api setResponseType ResponseType ERROR api sendCommand this getClient null if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger error api getTestCaseInfo api getUrl error else if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY
ApiCommand api new ApiCommand fstElmnt this getParam this getCommands if eachElement getElementsByTagName getLength api getName equals if api getName startsWith if this denyToExecute api setResponseType ResponseType EMPTY verify true if this denyToExecute api setResponseType ResponseType ERROR api sendCommand this getClient null if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger error api getTestCaseInfo api getUrl error else if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode
api setResponseType ResponseType EMPTY verify true if this denyToExecute api setResponseType ResponseType ERROR api sendCommand this getClient null if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger error api getTestCaseInfo api getUrl error else if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false
if this denyToExecute api setResponseType ResponseType ERROR api sendCommand this getClient null if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger error api getTestCaseInfo api getUrl error else if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false
api setResponseType ResponseType ERROR api sendCommand this getClient null if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger error api getTestCaseInfo api getUrl error else if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null
error else if verify true api getResponseType ResponseType ERROR api getResponseType ResponseType EMPTY s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getResponseCode api getUrl if api getRequired true
Override public boolean executeTest int error Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseCode error
String file null while iter hasNext String arg iter next if arg equals host iter next if arg equals file iter next Deploy deploy new Deploy ArrayList String inputFile new ArrayList String inputFile add file deploy setInputFile inputFile deploy setTestCaseName deploy getParam put host deploy getParam put deploy setCommands
Override public boolean executeTest int error Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode NodeList commandName fstElmnt getElementsByTagName Element commandElmnt Element commandName item NodeList commandNm commandElmnt getChildNodes if commandNm item getNodeValue equals NodeList mysqlList fstElmnt getElementsByTagName for int j j mysqlList getLength j Element itemVariableElement Element mysqlList item j
for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode NodeList commandName fstElmnt getElementsByTagName Element commandElmnt Element commandName item NodeList commandNm commandElmnt getChildNodes if commandNm item getNodeValue equals NodeList mysqlList fstElmnt getElementsByTagName for int j j mysqlList getLength j Element itemVariableElement Element mysqlList item j s_logger info itemVariableElement getTextContent try Statement st this getConn createStatement st executeUpdate itemVariableElement getTextContent catch Exception ex
for int j j mysqlList getLength j Element itemVariableElement Element mysqlList item j s_logger info itemVariableElement getTextContent try Statement st this getConn createStatement st executeUpdate itemVariableElement getTextContent catch Exception ex s_logger error ex return false else if commandNm item getNodeValue equals NodeList commandList fstElmnt getElementsByTagName Element commandElement Element commandList item NodeList ipList fstElmnt getElementsByTagName for int j j ipList getLength j Element itemVariableElement Element ipList item j
Statement st this getConn createStatement st executeUpdate itemVariableElement getTextContent catch Exception ex s_logger error ex return false else if commandNm item getNodeValue equals NodeList commandList fstElmnt getElementsByTagName Element commandElement Element commandList item NodeList ipList fstElmnt getElementsByTagName for int j j ipList getLength j Element itemVariableElement Element ipList item j s_logger info itemVariableElement getTextContent try Connection conn new Connection itemVariableElement getTextContent conn connect null
else if commandNm item getNodeValue equals NodeList commandList fstElmnt getElementsByTagName Element commandElement Element commandList item NodeList ipList fstElmnt getElementsByTagName for int j j ipList getLength j Element itemVariableElement Element ipList item j s_logger info itemVariableElement getTextContent try Connection conn new Connection itemVariableElement getTextContent conn connect null s_logger info itemVariableElement getTextContent boolean isAuthenticated conn authenticateWithPassword if isAuthenticated false s_logger info return false
return false Session sess conn openSession s_logger info commandElement getTextContent sess execCommand commandElement getTextContent Thread sleep sess close conn close catch Exception ex s_logger error ex return false else ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl
Session sess conn openSession s_logger info commandElement getTextContent sess execCommand commandElement getTextContent Thread sleep sess close conn close catch Exception ex s_logger error ex return false else ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error
conn close catch Exception ex s_logger error ex return false else ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo api getUrl else
s_logger error ex return false else ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo api getUrl else s_logger error api getTestCaseInfo api getUrl else
else ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo api getUrl else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else
if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo api getUrl else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam this getParam false s_logger error api getName api getUrl return false
Override public boolean executeTest int error Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient this getConn if api getResponseCode api getRequired true
Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient this getConn if api getResponseCode api getRequired true s_logger error api getName api getResponseCode api getUrl return false else if api getResponseCode api getResponseType ResponseType ERROR error s_logger error api getTestCaseInfo api getResponseCode api getUrl else if api getResponseCode api getResponseType ResponseType ERROR error
Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient this getConn if api getResponseCode api getRequired true s_logger error api getName api getResponseCode api getUrl return false else if api getResponseCode api getResponseType ResponseType ERROR error s_logger error api getTestCaseInfo api getResponseCode api getUrl else if api getResponseCode api getResponseType ResponseType ERROR error s_logger error api getTestCaseInfo api getUrl else if api setParam this getParam false
Override public boolean executeTest int error Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode
Override public boolean executeTest int error Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true
Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else
ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam this getParam false
s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam this getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null
else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam this getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode
else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam this getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl if api getRequired true s_logger info return false
Override public boolean executeTest int error Element rootElement getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt getParam getCommands api sendCommand getClient null if api getResponseType ResponseType ERROR api getResponseCode
Override public boolean executeTest int error Element rootElement getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt getParam getCommands api sendCommand getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true
Element rootElement getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt getParam getCommands api sendCommand getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else
ApiCommand api new ApiCommand fstElmnt getParam getCommands api sendCommand getClient null if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam getParam false
s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null
else if api getResponseType ResponseType ERROR api getResponseCode if api getResponseType ResponseType EMPTY if api isEmpty true s_logger info api getTestCaseInfo else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode
else s_logger error api getTestCaseInfo api getUrl else if api isEmpty false s_logger error api getTestCaseInfo api getUrl else if api setParam getParam false s_logger error api getName api getUrl return false else if api getTestCaseInfo null s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl if api getRequired true s_logger info return false
Override public boolean executeTest int error Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseCode api getRequired true
Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseCode api getRequired true s_logger error api getName api getResponseCode api getUrl return false else if api getResponseCode error s_logger error api getTestCaseInfo api getResponseCode api getUrl else if api setParam this getParam false
Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null if api getResponseCode api getRequired true s_logger error api getName api getResponseCode api getUrl return false else if api getResponseCode error s_logger error api getTestCaseInfo api getResponseCode api getUrl else if api setParam this getParam false s_logger error api getName api getUrl return false if api verifyParam false
api sendCommand this getClient null if api getResponseCode api getRequired true s_logger error api getName api getResponseCode api getUrl return false else if api getResponseCode error s_logger error api getTestCaseInfo api getResponseCode api getUrl else if api setParam this getParam false s_logger error api getName api getUrl return false if api verifyParam false s_logger error api getTestCaseInfo api getUrl error else if api getTestCaseInfo null
s_logger error api getName api getResponseCode api getUrl return false else if api getResponseCode error s_logger error api getTestCaseInfo api getResponseCode api getUrl else if api setParam this getParam false s_logger error api getName api getUrl return false if api verifyParam false s_logger error api getTestCaseInfo api getUrl error else if api getTestCaseInfo null s_logger info api getTestCaseInfo boolean eventResult ApiCommand verifyEvents this getParam get this getParam get
Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient null ArrayList String port new ArrayList String for int j j j port add Integer toString j for String portValue port try s_logger info portValue String url this getParam get portValue HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode error
api sendCommand this getClient null ArrayList String port new ArrayList String for int j j j port add Integer toString j for String portValue port try s_logger info portValue String url this getParam get portValue HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method if responseCode error s_logger error portValue url catch Exception ex
File asyncCommands null if param get null s_logger info System exit else asyncCommands new File param get try Properties pro new Properties FileInputStream in new FileInputStream asyncCommands pro load in Enumeration en pro propertyNames while en hasMoreElements String key String en nextElement commands put key pro getProperty key catch Exception ex
component setParam updateParam component setConn s_globalParameters get component setCommands if s_inputFile get key null component setInputFile s_inputFile get key if key null component setTestCaseName s_testCaseName s_result set component executeTest if s_result get toString equals s_logger error key s_failure else finalResult true s_logger info key catch Exception ex
Override public boolean executeTest int error Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient this getConn if api getResponseType ResponseType ERROR api getResponseCode
Element rootElement this getInputFile get getDocumentElement NodeList commandLst rootElement getElementsByTagName for int i i commandLst getLength i Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient this getConn if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false if api verifyParam false
Node fstNode commandLst item i Element fstElmnt Element fstNode ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient this getConn if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false if api verifyParam false s_logger error api getTestCaseInfo api getUrl error else
ApiCommand api new ApiCommand fstElmnt this getParam this getCommands api sendCommand this getClient this getConn if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getUrl error else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false if api verifyParam false s_logger error api getTestCaseInfo api getUrl error else s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode
else if api getResponseType ResponseType ERROR api getResponseCode if api setParam this getParam false s_logger error api getName api getUrl return false if api verifyParam false s_logger error api getTestCaseInfo api getUrl error else s_logger info api getTestCaseInfo else if api getResponseType ResponseType ERROR api getResponseCode s_logger error api getTestCaseInfo api getResponseCode api getUrl if api getRequired true s_logger info return false error
while iter hasNext String arg iter next if arg equals host iter next if arg equals password iter next if arg equals url iter next if host null host equals s_logger info System exit if password null s_logger info System exit try
host iter next if arg equals password iter next if arg equals url iter next if host null host equals s_logger info System exit if password null s_logger info System exit try s_logger info host Connection conn new Connection host conn connect null
password iter next if arg equals url iter next if host null host equals s_logger info System exit if password null s_logger info System exit try s_logger info host Connection conn new Connection host conn connect null s_logger info host boolean isAuthenticated conn authenticateWithPassword password
if reason null if internet s_logger info s_account get else s_logger info if cleanUp s_logger info sleepTime Thread sleep sleepTime else success true if usageIterator numThreads int eventsAndBillingResponseCode executeEventsAndBilling server developerServer s_logger info eventsAndBillingResponseCode usageIterator else
Thread sleep sleepTime else success true if usageIterator numThreads int eventsAndBillingResponseCode executeEventsAndBilling server developerServer s_logger info eventsAndBillingResponseCode usageIterator else s_logger info usageIterator numThreads usageIterator if users null accountName null s_logger info int cleanupResponseCode executeCleanup server developerServer username s_logger info cleanupResponseCode success cleanupResponseCode
else success true if usageIterator numThreads int eventsAndBillingResponseCode executeEventsAndBilling server developerServer s_logger info eventsAndBillingResponseCode usageIterator else s_logger info usageIterator numThreads usageIterator if users null accountName null s_logger info int cleanupResponseCode executeCleanup server developerServer username s_logger info cleanupResponseCode success cleanupResponseCode else
usageIterator else s_logger info usageIterator numThreads usageIterator if users null accountName null s_logger info int cleanupResponseCode executeCleanup server developerServer username s_logger info cleanupResponseCode success cleanupResponseCode else s_logger info int stopResponseCode executeStop server developerServer username s_logger info stopResponseCode success stopResponseCode else
try DocumentBuilder docBuilder factory newDocumentBuilder Document doc docBuilder parse is Element rootElement doc getDocumentElement for int i i tagNames length i NodeList targetNodes rootElement getElementsByTagName tagNames i if targetNodes getLength s_logger error tagNames i else List String valueList new ArrayList String for int j j targetNodes getLength j Node node targetNodes item j valueList add node getTextContent returnValues put tagNames i valueList catch Exception ex
NodeList allocatedIpAddrNodes rootElement getElementsByTagName for int i i allocatedIpAddrNodes getLength i Node allocatedIpAddrNode allocatedIpAddrNodes item i NodeList childNodes allocatedIpAddrNode getChildNodes String ipAddress null boolean isSourceNat true for int j j childNodes getLength j Node n childNodes item j if equals n getNodeName ipAddress n getTextContent else if equals n getNodeName isSourceNat Boolean parseBoolean n getTextContent if ipAddress null isSourceNat returnValues add ipAddress catch Exception ex
NodeList allocatedIpAddrNodes rootElement getElementsByTagName for int i i allocatedIpAddrNodes getLength i Node allocatedIpAddrNode allocatedIpAddrNodes item i NodeList childNodes allocatedIpAddrNode getChildNodes String ipAddress null boolean isSourceNat false for int j j childNodes getLength j Node n childNodes item j if equals n getNodeName ipAddress n getTextContent else if equals n getNodeName isSourceNat Boolean parseBoolean n getTextContent if ipAddress null isSourceNat returnValues add ipAddress catch Exception ex
private static String executeRegistration String server String username String password throws HttpException IOException String url server s_userId get toString
private static Integer executeDeployment String server String developerServer String username throws HttpException IOException String encodedUsername URLEncoder encode username String encryptedPassword createMD5Password username String encodedPassword URLEncoder encode encryptedPassword String url server encodedUsername encodedPassword if accountName null url server encodedUsername encodedPassword accountName HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method long userId if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get
url server encodedUsername encodedPassword accountName HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method long userId if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr s_userId set userId s_account set userIdValues get if userId
HttpMethod method new GetMethod url int responseCode client executeMethod method long userId if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr s_userId set userId s_account set userIdValues get if userId s_logger error username return
InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr s_userId set userId s_account set userIdValues get if userId s_logger error username return else s_logger error username responseCode return responseCode s_secretKey set executeRegistration server username username
s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr s_userId set userId s_account set userIdValues get if userId s_logger error username return else s_logger error username responseCode return responseCode s_secretKey set executeRegistration server username username if s_secretKey get null s_logger error username return
s_logger info s_apiKey get String networkAccount null if accountName null networkAccount accountName else networkAccount encodedUsername String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey encodedUsername requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedUsername encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode
String networkAccount null if accountName null networkAccount accountName else networkAccount encodedUsername String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey encodedUsername requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedUsername encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream
responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Map String String values getSingleValueFromXML is new String if values get null s_logger info return else s_logger info responseCode else s_logger error responseCode url return responseCode String encodedCidr URLEncoder encode url server encodedCidr encodedUsername networkAccount method new GetMethod url
InputStream is method getResponseBodyAsStream Map String String values getSingleValueFromXML is new String if values get null s_logger info return else s_logger info responseCode else s_logger error responseCode url return responseCode String encodedCidr URLEncoder encode url server encodedCidr encodedUsername networkAccount method new GetMethod url responseCode client executeMethod method if responseCode
if values get null s_logger info return else s_logger info responseCode else s_logger error responseCode url return responseCode long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId encodedApiKey URLEncoder encode s_apiKey get requestToSign encodedApiKey encodedUsername encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase
else s_logger error responseCode url return responseCode long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId encodedApiKey URLEncoder encode s_apiKey get requestToSign encodedApiKey encodedUsername encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedUsername encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method
url developerServer encodedUsername encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null values get null s_logger info return else s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId set values get
Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null values get null s_logger info return else s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId set values get s_linuxIP set values get s_linuxPassword set else s_logger error responseCode url return responseCode
s_logger info return else s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId set values get s_linuxIP set values get s_linuxPassword set else s_logger error responseCode url return responseCode url server diskOfferingId zoneId s_account get s_logger info client new HttpClient
s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId set values get s_linuxIP set values get s_linuxPassword set else s_logger error responseCode url return responseCode url server diskOfferingId zoneId s_account get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method if responseCode
s_logger error responseCode url return responseCode url server diskOfferingId zoneId s_account get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info return else
url server diskOfferingId zoneId s_account get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode String volumeId values get
else s_logger error responseCode url return responseCode url server s_newVolume get s_linuxVmId get s_logger info s_newVolume get s_linuxVmId get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info
url server s_newVolume get s_linuxVmId get s_logger info s_newVolume get s_linuxVmId get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode
else s_logger info responseCode else s_logger error responseCode url return responseCode long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId encodedApiKey URLEncoder encode s_apiKey get requestToSign encodedApiKey encodedUsername encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedUsername encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature
else s_logger error responseCode url return responseCode long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId encodedApiKey URLEncoder encode s_apiKey get requestToSign encodedApiKey encodedUsername encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedUsername encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method
String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId encodedApiKey URLEncoder encode s_apiKey get requestToSign encodedApiKey encodedUsername encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedUsername encodedZoneId encodedServiceOfferingId encodedTemplateId encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String
method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null values get null s_logger info return else s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId1 set values get else
if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null values get null s_logger info return else s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId1 set values get else s_logger error responseCode url return responseCode
private static int executeCleanup String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId
private static int executeCleanup String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info userId url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
private static int executeCleanup String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info userId url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get
String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info userId url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get s_logger error url return else
int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get s_logger error url return else s_logger error responseCode url return responseCode url server userId client new HttpClient method new GetMethod url responseCode client executeMethod method
Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get s_logger error url return else s_logger error responseCode url return responseCode url server userId client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String
s_logger error url return else s_logger error responseCode url return responseCode url server userId client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get else
method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature
Map String String success getSingleValueFromXML is new String s_logger info success get else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode
else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream
String encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get
s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient
InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method
requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url
InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method
Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode
s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream
requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String if success get null s_logger info
method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String if success get null s_logger info return else s_logger info responseCode s_logger info success get else s_logger error responseCode url
private static int executeEventsAndBilling String server String developerServer throws HttpException IOException String url server s_account get
private static int executeEventsAndBilling String server String developerServer throws HttpException IOException String url server s_account get s_logger info s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
private static int executeEventsAndBilling String server String developerServer throws HttpException IOException String url server s_account get s_logger info s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String eventDescriptions getMultipleValuesFromXML is new String List String descriptionText eventDescriptions get if descriptionText null s_logger info else for String text descriptionText
s_logger info s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String eventDescriptions getMultipleValuesFromXML is new String List String descriptionText eventDescriptions get if descriptionText null s_logger info else for String text descriptionText s_logger info text else
private static int executeStop String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId
private static int executeStop String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info username HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info username HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get if userIdStr null userId userIdStr if userId null
s_logger info username HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get if userIdStr null userId userIdStr if userId null s_logger error url return else
String userIdStr userIdValues get if userIdStr null userId userIdStr if userId null s_logger error url return else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature
return else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature s_logger info url String vmIds null client new HttpClient method new GetMethod url responseCode client executeMethod method
s_logger info url String vmIds null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String vmIdValues getMultipleValuesFromXML is new String if vmIdValues containsKey List String vmIdList vmIdValues get if vmIdList null vmIds new String vmIdList size vmIdList toArray vmIds String vmIdLogStr
String vmIds null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String vmIdValues getMultipleValuesFromXML is new String if vmIdValues containsKey List String vmIdList vmIdValues get if vmIdList null vmIds new String vmIdList size vmIdList toArray vmIds String vmIdLogStr if vmIds null vmIds length
vmIdList toArray vmIds String vmIdLogStr if vmIds null vmIds length vmIdLogStr vmIds for int i i vmIds length i vmIdLogStr vmIdLogStr vmIds i s_logger info vmIdLogStr else s_logger error responseCode url return responseCode if vmIds null for String vmId vmIds requestToSign encodedApiKey vmId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get
s_logger info vmIdLogStr else s_logger error responseCode url return responseCode if vmIds null for String vmId vmIds requestToSign encodedApiKey vmId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer vmId encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info vmId responseCode
conn connect null s_logger info s_account get host boolean success false boolean isAuthenticated conn authenticateWithPassword if isAuthenticated false return else s_logger info try SCPClient scp new SCPClient conn scp put s_logger info catch Exception ex s_logger error ex if conn null
s_logger info return null if password null s_logger info return null String result null int retry while true try if retry s_logger info retry s_account get Thread sleep s_logger info host retry s_account get Connection conn new Connection host conn connect null
if password null s_logger info return null String result null int retry while true try if retry s_logger info retry s_account get Thread sleep s_logger info host retry s_account get Connection conn new Connection host conn connect null s_logger info s_account get host boolean isAuthenticated conn authenticateWithPassword password
try if retry s_logger info retry s_account get Thread sleep s_logger info host retry s_account get Connection conn new Connection host conn connect null s_logger info s_account get host boolean isAuthenticated conn authenticateWithPassword password if isAuthenticated false s_logger info password return boolean success false String linuxCommand null if i linuxCommand
Thread sleep 300000L if accountName null s_logger info s_account get reason sshTest s_linuxIP get s_linuxPassword get snapshotTest if reason null s_logger info s_account get s_logger info s_account get reason sshTest s_linuxIP get s_linuxPassword get snapshotTest s_linuxIP set null s_windowsIP set null if reason null if internet s_logger info s_account get else s_logger info
if reason null s_logger info s_account get s_logger info s_account get reason sshTest s_linuxIP get s_linuxPassword get snapshotTest s_linuxIP set null s_windowsIP set null if reason null if internet s_logger info s_account get else s_logger info if cleanUp s_logger info sleepTime Thread sleep sleepTime else
if reason null if internet s_logger info s_account get else s_logger info if cleanUp s_logger info sleepTime Thread sleep sleepTime else success true if usageIterator numThreads int eventsAndBillingResponseCode executeEventsAndBilling server developerServer s_logger info eventsAndBillingResponseCode usageIterator else
try DocumentBuilder docBuilder factory newDocumentBuilder Document doc docBuilder parse is Element rootElement doc getDocumentElement for int i i tagNames length i NodeList targetNodes rootElement getElementsByTagName tagNames i if targetNodes getLength s_logger error tagNames i else List String valueList new ArrayList String for int j j targetNodes getLength j Node node targetNodes item j valueList add node getTextContent returnValues put tagNames i valueList catch Exception ex
NodeList allocatedIpAddrNodes rootElement getElementsByTagName for int i i allocatedIpAddrNodes getLength i Node allocatedIpAddrNode allocatedIpAddrNodes item i NodeList childNodes allocatedIpAddrNode getChildNodes String ipAddress null boolean isSourceNat true for int j j childNodes getLength j Node n childNodes item j if equals n getNodeName ipAddress n getTextContent else if equals n getNodeName isSourceNat Boolean parseBoolean n getTextContent if ipAddress null isSourceNat returnValues add ipAddress catch Exception ex
String ipAddress null String ipAddressId null boolean isSourceNat false for int j j childNodes getLength j Node n childNodes item j if equals n getNodeName ipAddressId n getTextContent else if equals n getNodeName ipAddress n getTextContent else if equals n getNodeName isSourceNat Boolean parseBoolean n getTextContent if ipAddress null isSourceNat sourceNat returnValues add ipAddressId returnValues add ipAddress catch Exception ex
private static String executeRegistration String server String username String password throws HttpException IOException String url server s_userId get toString
private static Integer executeDeployment String server String developerServer String username String snapshotTest throws HttpException IOException String encodedUsername URLEncoder encode username String encryptedPassword createMD5Password username String encodedPassword URLEncoder encode encryptedPassword String url server encodedUsername encodedUsername encodedPassword HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method long accountId if responseCode InputStream is method getResponseBodyAsStream Map String String accountValues getSingleValueFromXML is new String String accountIdStr accountValues get
String url server encodedUsername encodedUsername encodedPassword HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method long accountId if responseCode InputStream is method getResponseBodyAsStream Map String String accountValues getSingleValueFromXML is new String String accountIdStr accountValues get s_logger info username accountIdStr if accountIdStr null accountId Long parseLong accountIdStr s_accountId set accountId s_account set accountValues get if accountId
int responseCode client executeMethod method long accountId if responseCode InputStream is method getResponseBodyAsStream Map String String accountValues getSingleValueFromXML is new String String accountIdStr accountValues get s_logger info username accountIdStr if accountIdStr null accountId Long parseLong accountIdStr s_accountId set accountId s_account set accountValues get if accountId s_logger error username return else
if accountId s_logger error username return else s_logger error username responseCode url return url server encodedUsername encodedUsername client new HttpClient method new GetMethod url responseCode client executeMethod method long userId if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get
else s_logger error username responseCode url return url server encodedUsername encodedUsername client new HttpClient method new GetMethod url responseCode client executeMethod method long userId if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr
return url server encodedUsername encodedUsername client new HttpClient method new GetMethod url responseCode client executeMethod method long userId if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr s_userId set userId if userId
method new GetMethod url responseCode client executeMethod method long userId if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr s_userId set userId if userId s_logger error username return else
if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get s_logger info username userIdStr if userIdStr null userId Long parseLong userIdStr s_userId set userId if userId s_logger error username return else s_logger error username responseCode url return s_secretKey set executeRegistration server username username
return else s_logger error username responseCode url return s_secretKey set executeRegistration server username username if s_secretKey get null s_logger error username return else s_logger info s_secretKey get s_logger info s_apiKey get url server networkOfferingId encodedUsername zoneId encodedUsername encodedUsername client new HttpClient method new GetMethod url responseCode client executeMethod method
else s_logger error username responseCode url return s_secretKey set executeRegistration server username username if s_secretKey get null s_logger error username return else s_logger info s_secretKey get s_logger info s_apiKey get url server networkOfferingId encodedUsername zoneId encodedUsername encodedUsername client new HttpClient method new GetMethod url responseCode client executeMethod method if responseCode
s_logger info encodedUsername networkIdStr if networkIdStr null s_networkId set networkIdStr else s_logger error username responseCode url return String linuxVMPrivateIP null long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId String encodedApiKey URLEncoder encode s_apiKey get String encodedNetworkIds URLEncoder encode s_networkId get String requestToSign encodedApiKey diskOfferingId encodedNetworkIds encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase
else s_logger error username responseCode url return String linuxVMPrivateIP null long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId String encodedApiKey URLEncoder encode s_apiKey get String encodedNetworkIds URLEncoder encode s_networkId get String requestToSign encodedApiKey diskOfferingId encodedNetworkIds encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedZoneId encodedServiceOfferingId diskOfferingId encodedNetworkIds encodedTemplateId encodedApiKey encodedSignature
long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId String encodedApiKey URLEncoder encode s_apiKey get String encodedNetworkIds URLEncoder encode s_networkId get String requestToSign encodedApiKey diskOfferingId encodedNetworkIds encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedZoneId encodedServiceOfferingId diskOfferingId encodedNetworkIds encodedTemplateId encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream
Map String String values getSingleValueFromXML el new String if values get null values get null s_logger info url return else s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId set values get linuxVMPrivateIP values get s_linuxPassword set vmPassword s_logger info s_linuxPassword get else s_logger error responseCode url return responseCode
return else s_logger info responseCode long linuxVMId Long parseLong values get s_logger info linuxVMId s_linuxVmId set values get linuxVMPrivateIP values get s_linuxPassword set vmPassword s_logger info s_linuxPassword get else s_logger error responseCode url return responseCode String ipAddr null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey zoneId
s_logger info linuxVMId s_linuxVmId set values get linuxVMPrivateIP values get s_linuxPassword set vmPassword s_logger info s_linuxPassword get else s_logger error responseCode url return responseCode String ipAddr null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey zoneId requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey zoneId encodedSignature
String ipAddr null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey zoneId requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey zoneId encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Element associpel queryAsyncJobResult server is Map String String values getSingleValueFromXML associpel new String if values get null values get null s_logger info url
String ipAddr null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey zoneId requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey zoneId encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode InputStream is method getResponseBodyAsStream Element associpel queryAsyncJobResult server is Map String String values getSingleValueFromXML associpel new String if values get null values get null s_logger info url
if responseCode InputStream is method getResponseBodyAsStream Element associpel queryAsyncJobResult server is Map String String values getSingleValueFromXML associpel new String if values get null values get null s_logger info url return else s_logger info responseCode long publicIpId Long parseLong values get s_logger info publicIpId s_publicIpId set values get else s_logger error responseCode url return responseCode
long publicIpId Long parseLong values get s_logger info publicIpId s_publicIpId set values get else s_logger error responseCode url return responseCode String encodedPublicIpId URLEncoder encode s_publicIpId get requestToSign encodedApiKey encodedPublicIpId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedPublicIpId encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method
s_logger info publicIpId s_publicIpId set values get else s_logger error responseCode url return responseCode String encodedPublicIpId URLEncoder encode s_publicIpId get requestToSign encodedApiKey encodedPublicIpId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedPublicIpId encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info url
String encodedPublicIpId URLEncoder encode s_publicIpId get requestToSign encodedApiKey encodedPublicIpId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedPublicIpId encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info url s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream List String ipAddressValues getIPs is false if ipAddressValues null ipAddressValues isEmpty
String encodedPublicIpId URLEncoder encode s_publicIpId get requestToSign encodedApiKey encodedPublicIpId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedPublicIpId encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info url s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream List String ipAddressValues getIPs is false if ipAddressValues null ipAddressValues isEmpty
requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedPublicIpId encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info url s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream List String ipAddressValues getIPs is false if ipAddressValues null ipAddressValues isEmpty s_windowsIpId set ipAddressValues get s_windowsIP set ipAddressValues get
InputStream is method getResponseBodyAsStream List String ipAddressValues getIPs is false if ipAddressValues null ipAddressValues isEmpty s_windowsIpId set ipAddressValues get s_windowsIP set ipAddressValues get s_logger info ipAddressValues get s_logger info ipAddressValues get else s_logger error responseCode url return responseCode requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature
requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info url s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream List String ipAddressValues getIPs is true if ipAddressValues null ipAddressValues isEmpty s_linuxIpId set ipAddressValues get
method new GetMethod url responseCode client executeMethod method s_logger info url s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream List String ipAddressValues getIPs is true if ipAddressValues null ipAddressValues isEmpty s_linuxIpId set ipAddressValues get s_linuxIP set ipAddressValues get s_logger info ipAddressValues get s_logger info ipAddressValues get else s_logger error responseCode url return responseCode
InputStream is method getResponseBodyAsStream List String ipAddressValues getIPs is true if ipAddressValues null ipAddressValues isEmpty s_linuxIpId set ipAddressValues get s_linuxIP set ipAddressValues get s_logger info ipAddressValues get s_logger info ipAddressValues get else s_logger error responseCode url return responseCode String encodedSourceNatPublicIpId URLEncoder encode s_linuxIpId get String encodedVmId URLEncoder encode s_linuxVmId get String encodedIpAddress URLEncoder encode s_linuxIpId get requestToSign encodedApiKey encodedIpAddress encodedVmId requestToSign requestToSign toLowerCase
s_linuxIP set ipAddressValues get s_logger info ipAddressValues get s_logger info ipAddressValues get else s_logger error responseCode url return responseCode String encodedSourceNatPublicIpId URLEncoder encode s_linuxIpId get String encodedVmId URLEncoder encode s_linuxVmId get String encodedIpAddress URLEncoder encode s_linuxIpId get requestToSign encodedApiKey encodedIpAddress encodedVmId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedIpAddress encodedVmId encodedSignature s_logger info url
String encodedSourceNatPublicIpId URLEncoder encode s_linuxIpId get String encodedVmId URLEncoder encode s_linuxVmId get String encodedIpAddress URLEncoder encode s_linuxIpId get requestToSign encodedApiKey encodedIpAddress encodedVmId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedIpAddress encodedVmId encodedSignature s_logger info url method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String
String encodedSourceNatPublicIpId URLEncoder encode s_linuxIpId get String encodedVmId URLEncoder encode s_linuxVmId get String encodedIpAddress URLEncoder encode s_linuxIpId get requestToSign encodedApiKey encodedIpAddress encodedVmId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedIpAddress encodedVmId encodedSignature s_logger info url method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String
return responseCode if snapshotTest equals url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String if success get null s_logger error url s_logger info success get s_rootVolume set success get
url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String if success get null s_logger error url s_logger info success get s_rootVolume set success get else s_logger error responseCode url
s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String if success get null s_logger error url s_logger info success get s_rootVolume set success get else s_logger error responseCode url return responseCode String encodedTimeZone URLEncoder encode url server s_rootVolume get encodedTimeZone s_logger info client new HttpClient
return responseCode String encodedTimeZone URLEncoder encode url server s_rootVolume get encodedTimeZone s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode s_logger error responseCode url return responseCode else String windowsVMPrivateIP null long templateId String encodedZoneId URLEncoder encode zoneId
String encodedTimeZone URLEncoder encode url server s_rootVolume get encodedTimeZone s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode s_logger error responseCode url return responseCode else String windowsVMPrivateIP null long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId
client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode s_logger error responseCode url return responseCode else String windowsVMPrivateIP null long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId encodedApiKey URLEncoder encode s_apiKey get String encodedNetworkIds URLEncoder encode s_networkId get
else String windowsVMPrivateIP null long templateId String encodedZoneId URLEncoder encode zoneId String encodedServiceOfferingId URLEncoder encode serviceOfferingId String encodedTemplateId URLEncoder encode templateId encodedApiKey URLEncoder encode s_apiKey get String encodedNetworkIds URLEncoder encode s_networkId get requestToSign encodedApiKey diskOfferingId encodedNetworkIds encodedServiceOfferingId encodedTemplateId encodedZoneId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedZoneId encodedServiceOfferingId diskOfferingId encodedNetworkIds encodedTemplateId encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method
requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedZoneId encodedServiceOfferingId diskOfferingId encodedNetworkIds encodedTemplateId encodedApiKey encodedSignature method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null values get null s_logger info url return else s_logger info responseCode
private static int executeCleanup String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId
private static int executeCleanup String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info userId url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
private static int executeCleanup String server String developerServer String username throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info userId url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get
String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info userId url HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get s_logger error url return else
int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get s_logger error url return else s_logger error responseCode url return responseCode url server userId client new HttpClient method new GetMethod url responseCode client executeMethod method
Map String String userInfo getSingleValueFromXML is new String if username equals userInfo get s_logger error url return else s_logger error responseCode url return responseCode url server userId client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String
s_logger error url return else s_logger error responseCode url return responseCode url server userId client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get else
url server userId client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get else s_logger error responseCode url return responseCode url server s_linuxVmId get s_logger info client new HttpClient
method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get else s_logger error responseCode url return responseCode url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method
if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get else s_logger error responseCode url return responseCode url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream
s_logger info success get else s_logger error responseCode url return responseCode url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get s_dataVolume set success get
return responseCode url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get s_dataVolume set success get else s_logger error responseCode url return responseCode
client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get s_dataVolume set success get else s_logger error responseCode url return responseCode url server s_dataVolume get s_logger info s_dataVolume get client new HttpClient
s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String s_logger info success get s_dataVolume set success get else s_logger error responseCode url return responseCode url server s_dataVolume get s_logger info s_dataVolume get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode
s_logger info success get s_dataVolume set success get else s_logger error responseCode url return responseCode url server s_dataVolume get s_logger info s_dataVolume get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input s_logger info
s_logger error responseCode url return responseCode url server s_dataVolume get s_logger info s_dataVolume get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input s_logger info else s_logger error responseCode url return responseCode
else s_logger error responseCode url return responseCode url server s_dataVolume get s_logger info s_dataVolume get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode s_logger info else s_logger error responseCode url return responseCode url server diskOfferingId zoneId s_account get
url server s_dataVolume get s_logger info s_dataVolume get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode s_logger info else s_logger error responseCode url return responseCode url server diskOfferingId zoneId s_account get s_logger info client new HttpClient method new GetMethod url
s_logger info responseCode if responseCode s_logger info else s_logger error responseCode url return responseCode url server diskOfferingId zoneId s_account get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String
return responseCode url server diskOfferingId zoneId s_account get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode
method new GetMethod url responseCode client executeMethod method if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode long volumeId Long parseLong values get s_logger info volumeId s_newVolume set values get else
Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode long volumeId Long parseLong values get s_logger info volumeId s_newVolume set values get else s_logger error responseCode url return responseCode url server s_newVolume get s_linuxVmId get s_logger info s_newVolume get s_linuxVmId get client new HttpClient
else s_logger info responseCode long volumeId Long parseLong values get s_logger info volumeId s_newVolume set values get else s_logger error responseCode url return responseCode url server s_newVolume get s_linuxVmId get s_logger info s_newVolume get s_linuxVmId get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode
url server s_newVolume get s_linuxVmId get s_logger info s_newVolume get s_linuxVmId get client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input s_logger info else s_logger error responseCode url return responseCode url server s_linuxVmId get s_logger info
if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input s_logger info else s_logger error responseCode url return responseCode url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream
s_logger info else s_logger error responseCode url return responseCode url server s_linuxVmId get s_logger info client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String if success get null s_logger error url
client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String if success get null s_logger error url s_logger info success get s_rootVolume set success get else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get
InputStream is method getResponseBodyAsStream Map String String success getSingleValueFromXML is new String if success get null s_logger error url s_logger info success get s_rootVolume set success get else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey s_rootVolume get requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer s_rootVolume get encodedApiKey encodedSignature
if success get null s_logger error url s_logger info success get s_rootVolume set success get else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey s_rootVolume get requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer s_rootVolume get encodedApiKey encodedSignature client new HttpClient method new GetMethod url
String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey s_rootVolume get requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer s_rootVolume get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null
client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode values get s_snapshot set values get else
return else s_logger info responseCode values get s_snapshot set values get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_windowsVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_windowsVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method
return responseCode requestToSign encodedApiKey s_windowsVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_windowsVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get
requestToSign encodedApiKey s_windowsVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_windowsVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else
InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method
Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode
requestToSign encodedApiKey s_linuxVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else
encodedSignature URLEncoder encode signature url developerServer s_linuxVmId get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_account get s_account get s_snapshot get
method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_account get s_account get s_snapshot get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature
s_logger info success get else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_account get s_account get s_snapshot get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_account get s_account get s_snapshot get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream
requestToSign encodedApiKey s_account get s_account get s_snapshot get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_account get s_account get s_snapshot get encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info
method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode else s_logger error responseCode url return responseCode
Map String String values getSingleValueFromXML el new String if values get null s_logger info return else s_logger info responseCode else s_logger error responseCode url return responseCode requestToSign encodedApiKey s_windowsVmId get requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer s_windowsVmId get encodedApiKey encodedSignature client new HttpClient
private static int executeEventsAndBilling String server String developerServer throws HttpException IOException String url server s_account get
private static int executeEventsAndBilling String server String developerServer throws HttpException IOException String url server s_account get s_logger info s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
private static int executeEventsAndBilling String server String developerServer throws HttpException IOException String url server s_account get s_logger info s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String eventDescriptions getMultipleValuesFromXML is new String List String descriptionText eventDescriptions get if descriptionText null s_logger info else for String text descriptionText
s_logger info s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String eventDescriptions getMultipleValuesFromXML is new String List String descriptionText eventDescriptions get if descriptionText null s_logger info else for String text descriptionText s_logger info text else
if responseCode InputStream is method getResponseBodyAsStream Map String List String eventDescriptions getMultipleValuesFromXML is new String List String descriptionText eventDescriptions get if descriptionText null s_logger info else for String text descriptionText s_logger info text else s_logger error responseCode url return responseCode DateFormat dateFormat new SimpleDateFormat Date currentDate new Date String endDate dateFormat format currentDate
s_logger info else for String text descriptionText s_logger info text else s_logger error responseCode url return responseCode DateFormat dateFormat new SimpleDateFormat Date currentDate new Date String endDate dateFormat format currentDate s_logger info endDate url server endDate client new HttpClient method new GetMethod url responseCode client executeMethod method
else s_logger error responseCode url return responseCode DateFormat dateFormat new SimpleDateFormat Date currentDate new Date String endDate dateFormat format currentDate s_logger info endDate url server endDate client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String successStr getSingleValueFromXML is new String
Date currentDate new Date String endDate dateFormat format currentDate s_logger info endDate url server endDate client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String successStr getSingleValueFromXML is new String s_logger info successStr get else s_logger error responseCode url return responseCode
client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String successStr getSingleValueFromXML is new String s_logger info successStr get else s_logger error responseCode url return responseCode try Thread sleep catch Exception ex s_logger error ex
catch Exception ex s_logger error ex url server endDate s_account get s_logger info url client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String usageRecValues getMultipleValuesFromXML is new String if usageRecValues containsKey true usageRecValues containsKey true List String descriptions usageRecValues get List String usages usageRecValues get for int i i descriptions size i
private static boolean getNetworkStat String server try String url server s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
private static boolean getNetworkStat String server try String url server s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String requestKeyValues getSingleValueFromXML is new String int bytesReceived Integer parseInt requestKeyValues get int bytesSent Integer parseInt requestKeyValues get if bytesReceived bytesSent
try String url server s_account get HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String requestKeyValues getSingleValueFromXML is new String int bytesReceived Integer parseInt requestKeyValues get int bytesSent Integer parseInt requestKeyValues get if bytesReceived bytesSent s_logger info s_account get toHumanReadableSize bytesReceived toHumanReadableSize bytesSent return true else
HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String requestKeyValues getSingleValueFromXML is new String int bytesReceived Integer parseInt requestKeyValues get int bytesSent Integer parseInt requestKeyValues get if bytesReceived bytesSent s_logger info s_account get toHumanReadableSize bytesReceived toHumanReadableSize bytesSent return true else s_logger error s_account get toHumanReadableSize bytesReceived toHumanReadableSize bytesSent return false else
private static int executeStop String server String developerServer String username boolean destroy throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId
private static int executeStop String server String developerServer String username boolean destroy throws HttpException IOException String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info username HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method
String userId s_userId get toString String encodedUserId URLEncoder encode userId String url server encodedUserId s_logger info username HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get if userIdStr null userId userIdStr else
s_logger info username HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String String userIdValues getSingleValueFromXML is new String String userIdStr userIdValues get if userIdStr null userId userIdStr else s_logger error url return else
String userIdStr userIdValues get if userIdStr null userId userIdStr else s_logger error url return else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature
s_logger error url return else s_logger error responseCode url return responseCode String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature s_logger info url String vmIds null client new HttpClient method new GetMethod url
s_logger info url String vmIds null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String vmIdValues getMultipleValuesFromXML is new String if vmIdValues containsKey List String vmIdList vmIdValues get if vmIdList null vmIds new String vmIdList size vmIdList toArray vmIds String vmIdLogStr
String vmIds null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String vmIdValues getMultipleValuesFromXML is new String if vmIdValues containsKey List String vmIdList vmIdValues get if vmIdList null vmIds new String vmIdList size vmIdList toArray vmIds String vmIdLogStr if vmIds null vmIds length
vmIds new String vmIdList size vmIdList toArray vmIds String vmIdLogStr if vmIds null vmIds length vmIdLogStr vmIds for int i i vmIds length i vmIdLogStr vmIdLogStr vmIds i s_logger info vmIdLogStr else s_logger error responseCode url return responseCode requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature
requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature String ipAddresses null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String ipAddressValues getMultipleValuesFromXML is new String if ipAddressValues containsKey List String ipAddressList ipAddressValues get
if responseCode InputStream is method getResponseBodyAsStream Map String List String ipAddressValues getMultipleValuesFromXML is new String if ipAddressValues containsKey List String ipAddressList ipAddressValues get if ipAddressList null ipAddresses new String ipAddressList size ipAddressList toArray ipAddresses String ipAddressLogStr if ipAddresses null ipAddresses length ipAddressLogStr ipAddresses for int i i ipAddresses length i ipAddressLogStr ipAddressLogStr ipAddresses i s_logger info ipAddressLogStr else
else s_logger error responseCode url return responseCode requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature String zoneNames null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream
String zoneNames null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String zoneNameValues getMultipleValuesFromXML is new String if zoneNameValues containsKey List String zoneNameList zoneNameValues get if zoneNameList null zoneNames new String zoneNameList size zoneNameList toArray zoneNames String zoneNameLogStr if zoneNames null zoneNames length
zoneNameLogStr zoneNameLogStr zoneNames i zoneNameLogStr s_logger info zoneNameLogStr else s_logger error responseCode url return responseCode requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature String statNames null client new HttpClient method new GetMethod url responseCode client executeMethod method
requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature String statNames null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String statValues getMultipleValuesFromXML is new String if statValues containsKey List String statList statValues get
statNames new String statList size statList toArray statNames String statLogStr if statNames null zoneNames length statLogStr statNames for int i i statNames length i statLogStr statLogStr zoneNames i statLogStr s_logger info statLogStr else s_logger error responseCode url return responseCode requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get
else s_logger error responseCode url return responseCode requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature String templateNames null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream
s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String templateNameValues getMultipleValuesFromXML is new String if templateNameValues containsKey List String templateNameList templateNameValues get if templateNameList null templateNames new String templateNameList size templateNameList toArray templateNames String templateNameLogStr if templateNames null templateNames length templateNameLogStr templateNames for int i i templateNames length i templateNameLogStr templateNameLogStr templateNames i templateNameLogStr
templateNames new String templateNameList size templateNameList toArray templateNames String templateNameLogStr if templateNames null templateNames length templateNameLogStr templateNames for int i i templateNames length i templateNameLogStr templateNameLogStr templateNames i templateNameLogStr s_logger info templateNameLogStr else s_logger error responseCode url return responseCode requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get
requestToSign encodedApiKey requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature String serviceOfferingNames null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String serviceOfferingNameValues getMultipleValuesFromXML is new String if serviceOfferingNameValues containsKey List String serviceOfferingNameList serviceOfferingNameValues get
Map String List String serviceOfferingNameValues getMultipleValuesFromXML is new String if serviceOfferingNameValues containsKey List String serviceOfferingNameList serviceOfferingNameValues get if serviceOfferingNameList null serviceOfferingNames new String serviceOfferingNameList size serviceOfferingNameList toArray serviceOfferingNames String serviceOfferingNameLogStr if serviceOfferingNames null serviceOfferingNames length serviceOfferingNameLogStr serviceOfferingNames for int i i serviceOfferingNames length i serviceOfferingNameLogStr serviceOfferingNameLogStr serviceOfferingNames i s_logger info serviceOfferingNameLogStr else s_logger error responseCode url return responseCode
if serviceOfferingNames null serviceOfferingNames length serviceOfferingNameLogStr serviceOfferingNames for int i i serviceOfferingNames length i serviceOfferingNameLogStr serviceOfferingNameLogStr serviceOfferingNames i s_logger info serviceOfferingNameLogStr else s_logger error responseCode url return responseCode url server s_account get String eventDescriptions null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode
return responseCode url server s_account get String eventDescriptions null client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info responseCode if responseCode InputStream is method getResponseBodyAsStream Map String List String eventNameValues getMultipleValuesFromXML is new String if eventNameValues containsKey List String eventNameList eventNameValues get if eventNameList null eventDescriptions new String eventNameList size eventNameList toArray eventDescriptions
if eventNameList null eventDescriptions new String eventNameList size eventNameList toArray eventDescriptions String eventNameLogStr if eventDescriptions null eventDescriptions length eventNameLogStr eventDescriptions for int i i eventDescriptions length i eventNameLogStr eventNameLogStr eventDescriptions i eventNameLogStr s_logger info eventNameLogStr else s_logger error responseCode url return responseCode if vmIds null String cmdName destroy
eventNameLogStr s_logger info eventNameLogStr else s_logger error responseCode url return responseCode if vmIds null String cmdName destroy for String vmId vmIds requestToSign encodedApiKey cmdName vmId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer cmdName vmId encodedApiKey encodedSignature client new HttpClient method new GetMethod url
s_logger error responseCode url return responseCode if vmIds null String cmdName destroy for String vmId vmIds requestToSign encodedApiKey cmdName vmId requestToSign requestToSign toLowerCase signature signRequest requestToSign s_secretKey get encodedSignature URLEncoder encode signature url developerServer cmdName vmId encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info cmdName vmId responseCode if responseCode
method new GetMethod url responseCode client executeMethod method s_logger info cmdName vmId responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info cmdName success get else s_logger error cmdName responseCode url return responseCode String ipAddresses null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase
responseCode client executeMethod method s_logger info cmdName vmId responseCode if responseCode InputStream input method getResponseBodyAsStream Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info cmdName success get else s_logger error cmdName responseCode url return responseCode String ipAddresses null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get
Element el queryAsyncJobResult server input Map String String success getSingleValueFromXML el new String s_logger info cmdName success get else s_logger error cmdName responseCode url return responseCode String ipAddresses null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature client new HttpClient method new GetMethod url
s_logger info cmdName success get else s_logger error cmdName responseCode url return responseCode String ipAddresses null String encodedApiKey URLEncoder encode s_apiKey get String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info userId responseCode
String requestToSign encodedApiKey requestToSign requestToSign toLowerCase String signature signRequest requestToSign s_secretKey get String encodedSignature URLEncoder encode signature url developerServer encodedApiKey encodedSignature client new HttpClient method new GetMethod url responseCode client executeMethod method s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream List String ipAddressList getNonSourceNatIPs is ipAddresses new String ipAddressList size ipAddressList toArray ipAddresses String ipAddrLogStr
responseCode client executeMethod method s_logger info userId responseCode if responseCode InputStream is method getResponseBodyAsStream List String ipAddressList getNonSourceNatIPs is ipAddresses new String ipAddressList size ipAddressList toArray ipAddresses String ipAddrLogStr if ipAddresses null ipAddresses length ipAddrLogStr ipAddresses for int i i ipAddresses length i ipAddrLogStr ipAddrLogStr ipAddresses i s_logger info ipAddrLogStr else s_logger error responseCode url
conn connect null s_logger info s_account get host boolean success false boolean isAuthenticated conn authenticateWithPassword if isAuthenticated false return else s_logger info try SCPClient scp new SCPClient conn scp put s_logger info catch Exception ex s_logger error ex if conn null
s_logger info return null if password null s_logger info return null String result null int retry while true try if retry s_logger info retry s_account get Thread sleep s_logger info host retry s_account get Connection conn new Connection host conn connect null
if password null s_logger info return null String result null int retry while true try if retry s_logger info retry s_account get Thread sleep s_logger info host retry s_account get Connection conn new Connection host conn connect null s_logger info s_account get host boolean isAuthenticated conn authenticateWithPassword password
try if retry s_logger info retry s_account get Thread sleep s_logger info host retry s_account get Connection conn new Connection host conn connect null s_logger info s_account get host boolean isAuthenticated conn authenticateWithPassword password if isAuthenticated false s_logger info password return boolean success false String linuxCommand null if i linuxCommand downloadUrl
String arg iter next if arg equals host iter next if arg equals password iter next int i if host null host equals s_logger info System exit if password null s_logger info System exit int retry try if retry
password iter next int i if host null host equals s_logger info System exit if password null s_logger info System exit int retry try if retry s_logger info retry Thread sleep s_logger info host retry Connection conn new Connection host
int i if host null host equals s_logger info System exit if password null s_logger info System exit int retry try if retry s_logger info retry Thread sleep s_logger info host retry Connection conn new Connection host conn connect null
selenium select iso_os_type selenium click Thread sleep int i try for i System out println i selenium click i catch Exception ex s_logger info e getLocalizedMessage for int second second if second fail try if selenium isVisible break catch Exception e
selenium type String template_url System getProperty selenium type template_url String template_zone System getProperty selenium select template_zone String template_os_type System getProperty selenium select template_os_type selenium click Thread sleep int i try for i System out println i selenium click i catch Exception ex
selenium select template_os_type selenium click Thread sleep int i try for i System out println i selenium click i catch Exception ex s_logger info ex getLocalizedMessage for int second second if second fail try if selenium isVisible break catch Exception e
selenium type selenium type selenium click Thread sleep assertTrue selenium isTextPresent selenium click selenium click Thread sleep selenium click selenium click for int second second if second fail try if selenium isVisible break catch Exception e
try if selenium isVisible break catch Exception e s_logger info e getLocalizedMessage Thread sleep assertTrue selenium isTextPresent selenium click Thread sleep selenium click selenium click for int second second if second fail try if selenium isVisible break catch Exception e
Override public void run while true Script myScript new Script myScript add command myScript execute long begin System currentTimeMillis WgetInt process new WgetInt String response myScript execute process long end process getEnd if response null
public static void main String args begin System currentTimeMillis Runtime getRuntime addShutdownHook new ShutdownThread new ProxyLoadTemp ConsoleProxy proxyIp try BufferedReader consoleInput new BufferedReader new FileReader boolean eof false s_logger info while eof String line consoleInput readLine
Runtime getRuntime addShutdownHook new ShutdownThread new ProxyLoadTemp ConsoleProxy proxyIp try BufferedReader consoleInput new BufferedReader new FileReader boolean eof false s_logger info while eof String line consoleInput readLine s_logger info line if line null s_logger info numThreads eof true else String result null try
TreeMap String String param new TreeMap String String String req host prop getProperty prop getProperty String temp param put prop getProperty param put prop getProperty param put param put param put prop getProperty param put StringTokenizer str1 new StringTokenizer url while str1 hasMoreTokens String newEl str1 nextToken StringTokenizer str2 new StringTokenizer newEl String name str2 nextToken String value str2 nextToken
public static void main String args try FileOutputStream fs new FileOutputStream new File DataOutputStream out new DataOutputStream fs for int i i i out writeBytes i out writeBytes for int i i i StringBuilder imagePath new StringBuilder Formatter formatter new Formatter imagePath formatter format i out writeBytes imagePath toString out flush out close catch Exception e
Iterator String iter argsList iterator while iter hasNext String arg iter next if arg equals certFileName iter next if arg equals secretKey iter next if arg equals apiKey iter next if arg equals url iter next Properties prop new Properties try prop load new FileInputStream catch IOException ex
TreeMap String String param new TreeMap String String String req host prop getProperty prop getProperty String temp if certFileName null cert readCert certFileName param put cert param put apiKey param put prop getProperty param put prop getProperty param put param put prop getProperty StringTokenizer str1 new StringTokenizer url while str1 hasMoreTokens String newEl str1 nextToken StringTokenizer str2 new StringTokenizer newEl
param put param put prop getProperty StringTokenizer str1 new StringTokenizer url while str1 hasMoreTokens String newEl str1 nextToken StringTokenizer str2 new StringTokenizer newEl String name str2 nextToken String value str2 nextToken param put name value Set c param entrySet Iterator it c iterator while it hasNext Map Entry me Map Entry it next String key String me getKey String value String me getValue
public static void sendRequest String url try HttpClient client new HttpClient HttpMethod method new GetMethod url int responseCode client executeMethod method String is method getResponseBodyAsString
if arg equals port iter next if arg equals numThreads Integer parseInt iter next if arg equals sleepTime Long parseLong iter next if arg equals cleanUp Boolean parseBoolean iter next if cleanUp sleepTime 0L if arg equals repeat Boolean parseBoolean iter next if arg equals numOfUsers Integer parseInt iter next if arg equals internet Boolean parseBoolean iter next
if arg equals numThreads Integer parseInt iter next if arg equals sleepTime Long parseLong iter next if arg equals cleanUp Boolean parseBoolean iter next if cleanUp sleepTime 0L if arg equals repeat Boolean parseBoolean iter next if arg equals numOfUsers Integer parseInt iter next if arg equals internet Boolean parseBoolean iter next final String server host port testUrl s_logger info server numThreads
final String server host port testUrl s_logger info server numThreads if cleanUp s_logger info sleepTime if numOfUsers s_logger info numOfUsers users new String numOfUsers Random ran new Random for int i i numOfUsers i users i Math abs ran nextInt for int i i numThreads i new Thread new Runnable Override public void run do String username null try
reason sshTest method getResponseHeader getValue if reason null s_logger info s_logger info reason sshWinTest method getResponseHeader getValue if reason null if internet s_logger info else s_logger info if cleanUp s_logger info sleepTime Thread sleep sleepTime else success true
if reason null if internet s_logger info else s_logger info if cleanUp s_logger info sleepTime Thread sleep sleepTime else success true if users null s_logger info url server username username else s_logger info
s_logger info else s_logger info if cleanUp s_logger info sleepTime Thread sleep sleepTime else success true if users null s_logger info url server username username else s_logger info url server username username method new GetMethod url
else s_logger info if cleanUp s_logger info sleepTime Thread sleep sleepTime else success true if users null s_logger info url server username username else s_logger info url server username username method new GetMethod url responseCode client executeMethod method
Override public boolean configure String name Map String Object params throws ConfigurationException final String run if s_logger isDebugEnabled
Map String String configs _configDao getConfiguration params if params null mergeConfigs configs params String execTime configs get String aggregationRange configs get String execTimeZone configs get String aggreagationTimeZone configs get String sanityCheckInterval configs get String quotaEnable configs get _runQuota Boolean valueOf quotaEnable null quotaEnable usageSnapshotSelection Boolean valueOf configs get if sanityCheckInterval null _sanityCheckInterval Integer parseInt sanityCheckInterval if aggreagationTimeZone null aggreagationTimeZone isEmpty _usageTimezone TimeZone getTimeZone aggreagationTimeZone
if params null mergeConfigs configs params String execTime configs get String aggregationRange configs get String execTimeZone configs get String aggreagationTimeZone configs get String sanityCheckInterval configs get String quotaEnable configs get _runQuota Boolean valueOf quotaEnable null quotaEnable usageSnapshotSelection Boolean valueOf configs get if sanityCheckInterval null _sanityCheckInterval Integer parseInt sanityCheckInterval if aggreagationTimeZone null aggreagationTimeZone isEmpty _usageTimezone TimeZone getTimeZone aggreagationTimeZone s_logger debug aggreagationTimeZone
cal set Calendar MILLISECOND startDate cal getTime getTime cal roll Calendar HOUR_OF_DAY true cal add Calendar MILLISECOND endDate cal getTime getTime else endDate cal getTime getTime cal add Calendar MINUTE _aggregationDuration startDate cal getTime getTime parse job startDate endDate if _runQuota try _quotaManager calculateQuotaUsage catch Exception e s_logger error e
endDate cal getTime getTime else endDate cal getTime getTime cal add Calendar MINUTE _aggregationDuration startDate cal getTime getTime parse job startDate endDate if _runQuota try _quotaManager calculateQuotaUsage catch Exception e s_logger error e try _quotaStatement sendStatement catch Exception e s_logger error e
if startDateMillis endDateMillis if s_logger isInfoEnabled s_logger info startDateMillis endDateMillis TransactionLegacy jobUpdateTxn TransactionLegacy open TransactionLegacy USAGE_DB try jobUpdateTxn start _usageJobDao updateJobSuccess job getId startDateMillis endDateMillis System currentTimeMillis timeStart success if job getJobType UsageJobVO JOB_TYPE_RECURRING _usageJobDao createNewJob _hostname _pid UsageJobVO JOB_TYPE_RECURRING jobUpdateTxn commit finally jobUpdateTxn close return Date startDate new Date startDateMillis Date endDate new Date endDateMillis
hostAggregatedStat setAggBytesSent hostAggregatedStat getAggBytesSent userStat getAggBytesSent hostAggregatedStat setAggBytesReceived hostAggregatedStat getAggBytesReceived userStat getAggBytesReceived aggregatedStats put hostKey hostAggregatedStat startIndex while userStats null userStats isEmpty int numAcctsProcessed usageNetworks clear for String key aggregatedStats keySet UsageNetworkVO currentNetworkStats null if networkStats null currentNetworkStats networkStats get key createNetworkHelperEntry aggregatedStats get key currentNetworkStats endDateMillis numAcctsProcessed _usageNetworkDao saveUsageNetworks usageNetworks if s_logger isDebugEnabled
createVmDiskHelperEntry aggregatedDiskStats get key currentVmDiskStats endDateMillis numAcctsProcessed _usageVmDiskDao saveUsageVmDisks usageVmDisks if s_logger isDebugEnabled s_logger debug numAcctsProcessed usageTxn commit usageTxn start boolean parsed false numAcctsProcessed Date currentStartDate startDate Date currentEndDate endDate Date tempDate endDate Calendar aggregateCal Calendar getInstance _usageTimezone while tempDate after startDate tempDate getTime startDate getTime currentEndDate tempDate
private boolean parseHelperTables AccountVO account Date currentStartDate Date currentEndDate boolean parsed false parsed VMInstanceUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
parsed VMInstanceUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed NetworkUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VmDiskUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VolumeUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
parsed NetworkUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VmDiskUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VolumeUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed StorageUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
if parsed s_logger debug parsed account getAccountName account getId parsed VmDiskUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VolumeUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed StorageUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed SecurityGroupUsageParser parse account currentStartDate currentEndDate
parsed VmDiskUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VolumeUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed StorageUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed SecurityGroupUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
parsed VolumeUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed StorageUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed SecurityGroupUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed LoadBalancerUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
if parsed s_logger debug parsed account getAccountName account getId parsed StorageUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed SecurityGroupUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed LoadBalancerUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed PortForwardingUsageParser parse account currentStartDate currentEndDate
parsed StorageUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed SecurityGroupUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed LoadBalancerUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed PortForwardingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
parsed SecurityGroupUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed LoadBalancerUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed PortForwardingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed NetworkOfferingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
if parsed s_logger debug parsed account getAccountName account getId parsed LoadBalancerUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed PortForwardingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed NetworkOfferingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed IPAddressUsageParser parse account currentStartDate currentEndDate
parsed LoadBalancerUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed PortForwardingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed NetworkOfferingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed IPAddressUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
parsed PortForwardingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed NetworkOfferingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed IPAddressUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VPNUserUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed
if parsed s_logger debug parsed account getAccountName account getId parsed NetworkOfferingUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed IPAddressUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VPNUserUsageParser parse account currentStartDate currentEndDate if s_logger isDebugEnabled if parsed s_logger debug parsed account getAccountName account getId parsed VMSnapshotUsageParser parse account currentStartDate currentEndDate
private void createVMHelperEvent UsageEventVO event long vmId event getResourceId Long soId event getOfferingId long zoneId event getZoneId String vmName event getResourceName if EventTypes EVENT_VM_START equals event getType try SearchCriteria UsageVMInstanceVO sc _usageInstanceDao createSearchCriteria sc addAnd SearchCriteria Op EQ Long valueOf vmId sc addAnd SearchCriteria Op NULL sc addAnd SearchCriteria Op EQ UsageTypes RUNNING_VM List UsageVMInstanceVO usageInstances _usageInstanceDao search sc null if usageInstances null if usageInstances size
sc addAnd SearchCriteria Op NULL sc addAnd SearchCriteria Op EQ UsageTypes RUNNING_VM List UsageVMInstanceVO usageInstances _usageInstanceDao search sc null if usageInstances null if usageInstances size s_logger error vmId for UsageVMInstanceVO usageInstance usageInstances usageInstance setEndDate event getCreateDate _usageInstanceDao update usageInstance sc _usageInstanceDao createSearchCriteria sc addAnd SearchCriteria Op EQ Long valueOf vmId sc addAnd SearchCriteria Op NULL sc addAnd SearchCriteria Op EQ UsageTypes ALLOCATED_VM usageInstances _usageInstanceDao search sc null if usageInstances null usageInstances size
sc addAnd SearchCriteria Op EQ UsageTypes ALLOCATED_VM usageInstances _usageInstanceDao search sc null if usageInstances null usageInstances size s_logger error vmId else if usageInstances size UsageVMInstanceVO usageInstance usageInstances get if usageInstance getSerivceOfferingId soId usageInstance setEndDate event getCreateDate _usageInstanceDao update usageInstance usageInstance setServiceOfferingId soId usageInstance setStartDate event getCreateDate usageInstance setEndDate null populateDynamicComputeOfferingDetailsAndPersist usageInstance event getId Long templateId event getTemplateId String hypervisorType event getResourceType
catch Exception ex s_logger error vmId ex else if EventTypes EVENT_VM_STOP equals event getType SearchCriteria UsageVMInstanceVO sc _usageInstanceDao createSearchCriteria sc addAnd SearchCriteria Op EQ Long valueOf vmId sc addAnd SearchCriteria Op NULL sc addAnd SearchCriteria Op EQ UsageTypes RUNNING_VM List UsageVMInstanceVO usageInstances _usageInstanceDao search sc null if usageInstances null if usageInstances size s_logger warn vmId for UsageVMInstanceVO usageInstance usageInstances usageInstance setEndDate event getCreateDate _usageInstanceDao update usageInstance else if EventTypes EVENT_VM_CREATE equals event getType
else if EventTypes EVENT_VM_UPGRADE equals event getType SearchCriteria UsageVMInstanceVO sc _usageInstanceDao createSearchCriteria sc addAnd SearchCriteria Op EQ Long valueOf vmId sc addAnd SearchCriteria Op NULL sc addAnd SearchCriteria Op EQ UsageTypes ALLOCATED_VM List UsageVMInstanceVO usageInstances _usageInstanceDao search sc null if usageInstances null if usageInstances size s_logger warn vmId for UsageVMInstanceVO usageInstance usageInstances usageInstance setEndDate event getCreateDate _usageInstanceDao update usageInstance Long templateId event getTemplateId String hypervisorType event getResourceType UsageVMInstanceVO usageInstanceNew new UsageVMInstanceVO UsageTypes ALLOCATED_VM zoneId event getAccountId vmId vmName soId templateId hypervisorType event getCreateDate null
private void createNetworkHelperEntry UserStatisticsVO userStat UsageNetworkVO usageNetworkStats long timestamp long currentAccountedBytesSent 0L long currentAccountedBytesReceived 0L if usageNetworkStats null if s_logger isDebugEnabled
currentAccountedBytesSent usageNetworkStats getAggBytesSent currentAccountedBytesReceived usageNetworkStats getAggBytesReceived long bytesSent userStat getAggBytesSent currentAccountedBytesSent long bytesReceived userStat getAggBytesReceived currentAccountedBytesReceived if bytesSent s_logger warn toHumanReadableSize bytesSent toHumanReadableSize userStat getAggBytesSent toHumanReadableSize currentAccountedBytesSent bytesSent if bytesReceived s_logger warn toHumanReadableSize bytesReceived toHumanReadableSize userStat getAggBytesReceived toHumanReadableSize currentAccountedBytesReceived bytesReceived long hostId if userStat getDeviceId null hostId userStat getDeviceId UsageNetworkVO usageNetworkVO new UsageNetworkVO userStat getAccountId userStat getDataCenterId hostId userStat getDeviceType userStat getNetworkId bytesSent bytesReceived userStat getAggBytesReceived userStat getAggBytesSent timestamp if s_logger isDebugEnabled
private void createVmDiskHelperEntry VmDiskStatisticsVO vmDiskStat UsageVmDiskVO usageVmDiskStat long timestamp long currentAccountedIORead 0L long currentAccountedIOWrite 0L long currentAccountedBytesRead 0L long currentAccountedBytesWrite 0L if usageVmDiskStat null if s_logger isDebugEnabled
if ioRead s_logger warn toHumanReadableSize ioRead toHumanReadableSize vmDiskStat getAggIORead toHumanReadableSize currentAccountedIORead ioRead if ioWrite s_logger warn toHumanReadableSize ioWrite toHumanReadableSize vmDiskStat getAggIOWrite toHumanReadableSize currentAccountedIOWrite ioWrite if bytesRead s_logger warn toHumanReadableSize bytesRead toHumanReadableSize vmDiskStat getAggBytesRead toHumanReadableSize currentAccountedBytesRead bytesRead if bytesWrite s_logger warn toHumanReadableSize bytesWrite toHumanReadableSize vmDiskStat getAggBytesWrite toHumanReadableSize currentAccountedBytesWrite bytesWrite long vmId if vmDiskStat getVmId null vmId vmDiskStat getVmId
private void createIPHelperEvent UsageEventVO event String ipAddress event getResourceName if EventTypes EVENT_NET_IP_ASSIGN equals event getType if s_logger isDebugEnabled
long id event getResourceId long sourceNat event getSize boolean isSourceNat sourceNat true false boolean isSystem event getTemplateId null event getTemplateId false true UsageIPAddressVO ipAddressVO new UsageIPAddressVO id event getAccountId acct getDomainId zoneId ipAddress isSourceNat isSystem event getCreateDate null _usageIPAddressDao persist ipAddressVO else if EventTypes EVENT_NET_IP_RELEASE equals event getType SearchCriteria UsageIPAddressVO sc _usageIPAddressDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ ipAddress sc addAnd SearchCriteria Op NULL List UsageIPAddressVO ipAddressVOs _usageIPAddressDao search sc null if ipAddressVOs size s_logger warn ipAddress event getAccountId for UsageIPAddressVO ipAddressVO ipAddressVOs
private void createVolumeHelperEvent UsageEventVO event long volId event getResourceId if EventTypes EVENT_VOLUME_CREATE equals event getType SearchCriteria UsageStorageVO sc _usageStorageDao createSearchCriteria sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op EQ StorageTypes VOLUME List UsageStorageVO volumesVOs _usageStorageDao search sc null if volumesVOs null if volumesVOs size
sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op EQ StorageTypes VOLUME List UsageStorageVO volumesVOs _usageStorageDao search sc null if volumesVOs null if volumesVOs size s_logger debug volId volumesVOs get setDeleted event getCreateDate _usageStorageDao update volumesVOs get if EventTypes EVENT_VOLUME_CREATE equals event getType EventTypes EVENT_VOLUME_RESIZE equals event getType SearchCriteria UsageVolumeVO sc _usageVolumeDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op NULL List UsageVolumeVO volumesVOs _usageVolumeDao search sc null if volumesVOs size
if volumesVOs null if volumesVOs size s_logger debug volId volumesVOs get setDeleted event getCreateDate _usageStorageDao update volumesVOs get if EventTypes EVENT_VOLUME_CREATE equals event getType EventTypes EVENT_VOLUME_RESIZE equals event getType SearchCriteria UsageVolumeVO sc _usageVolumeDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op NULL List UsageVolumeVO volumesVOs _usageVolumeDao search sc null if volumesVOs size s_logger error volId event getAccountId for UsageVolumeVO volumesVO volumesVOs if s_logger isDebugEnabled
_usageStorageDao update volumesVOs get if EventTypes EVENT_VOLUME_CREATE equals event getType EventTypes EVENT_VOLUME_RESIZE equals event getType SearchCriteria UsageVolumeVO sc _usageVolumeDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op NULL List UsageVolumeVO volumesVOs _usageVolumeDao search sc null if volumesVOs size s_logger error volId event getAccountId for UsageVolumeVO volumesVO volumesVOs if s_logger isDebugEnabled s_logger debug volumesVO getId volumesVO getAccountId volumesVO setDeleted event getCreateDate _usageVolumeDao update volumesVO if s_logger isDebugEnabled
if s_logger isDebugEnabled s_logger debug volumesVO getId volumesVO getAccountId volumesVO setDeleted event getCreateDate _usageVolumeDao update volumesVO if s_logger isDebugEnabled s_logger debug volId event getAccountId Account acct _accountDao findByIdIncludingRemoved event getAccountId UsageVolumeVO volumeVO new UsageVolumeVO volId event getZoneId event getAccountId acct getDomainId event getOfferingId event getTemplateId event getSize event getCreateDate null _usageVolumeDao persist volumeVO else if EventTypes EVENT_VOLUME_DELETE equals event getType SearchCriteria UsageVolumeVO sc _usageVolumeDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op NULL List UsageVolumeVO volumesVOs _usageVolumeDao search sc null
UsageVolumeVO volumeVO new UsageVolumeVO volId event getZoneId event getAccountId acct getDomainId event getOfferingId event getTemplateId event getSize event getCreateDate null _usageVolumeDao persist volumeVO else if EventTypes EVENT_VOLUME_DELETE equals event getType SearchCriteria UsageVolumeVO sc _usageVolumeDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op NULL List UsageVolumeVO volumesVOs _usageVolumeDao search sc null if volumesVOs size s_logger warn volId event getAccountId for UsageVolumeVO volumesVO volumesVOs if s_logger isDebugEnabled s_logger debug volumesVO getId volumesVO getAccountId volumesVO setDeleted event getCreateDate _usageVolumeDao update volumesVO
else if EventTypes EVENT_VOLUME_DELETE equals event getType SearchCriteria UsageVolumeVO sc _usageVolumeDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op NULL List UsageVolumeVO volumesVOs _usageVolumeDao search sc null if volumesVOs size s_logger warn volId event getAccountId for UsageVolumeVO volumesVO volumesVOs if s_logger isDebugEnabled s_logger debug volumesVO getId volumesVO getAccountId volumesVO setDeleted event getCreateDate _usageVolumeDao update volumesVO else if EventTypes EVENT_VOLUME_UPLOAD equals event getType SearchCriteria UsageStorageVO sc _usageStorageDao createSearchCriteria
sc addAnd SearchCriteria Op NULL List UsageVolumeVO volumesVOs _usageVolumeDao search sc null if volumesVOs size s_logger warn volId event getAccountId for UsageVolumeVO volumesVO volumesVOs if s_logger isDebugEnabled s_logger debug volumesVO getId volumesVO getAccountId volumesVO setDeleted event getCreateDate _usageVolumeDao update volumesVO else if EventTypes EVENT_VOLUME_UPLOAD equals event getType SearchCriteria UsageStorageVO sc _usageStorageDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ volId sc addAnd SearchCriteria Op NULL List UsageStorageVO volumesVOs _usageStorageDao search sc null
private void createTemplateHelperEvent UsageEventVO event long templateId 1L long zoneId 1L long templateSize 1L templateId event getResourceId zoneId event getZoneId if EventTypes EVENT_TEMPLATE_CREATE equals event getType EventTypes EVENT_TEMPLATE_COPY equals event getType templateSize event getSize if templateSize
long templateId 1L long zoneId 1L long templateSize 1L templateId event getResourceId zoneId event getZoneId if EventTypes EVENT_TEMPLATE_CREATE equals event getType EventTypes EVENT_TEMPLATE_COPY equals event getType templateSize event getSize if templateSize s_logger error templateId return if zoneId 1L s_logger error templateId return if EventTypes EVENT_TEMPLATE_CREATE equals event getType EventTypes EVENT_TEMPLATE_COPY equals event getType if s_logger isDebugEnabled
s_logger debug templateId event getAccountId List UsageStorageVO storageVOs _usageStorageDao listByIdAndZone event getAccountId templateId StorageTypes TEMPLATE zoneId if storageVOs size s_logger warn templateId event getAccountId zoneId return Account acct _accountDao findByIdIncludingRemoved event getAccountId UsageStorageVO storageVO new UsageStorageVO templateId zoneId event getAccountId acct getDomainId StorageTypes TEMPLATE event getTemplateId templateSize event getVirtualSize event getCreateDate null _usageStorageDao persist storageVO else if EventTypes EVENT_TEMPLATE_DELETE equals event getType List UsageStorageVO storageVOs if zoneId 1L storageVOs _usageStorageDao listByIdAndZone event getAccountId templateId StorageTypes TEMPLATE zoneId else storageVOs _usageStorageDao listById event getAccountId templateId StorageTypes TEMPLATE if storageVOs size
List UsageStorageVO storageVOs _usageStorageDao listByIdAndZone event getAccountId isoId StorageTypes ISO zoneId if storageVOs size s_logger warn isoId event getAccountId zoneId return Account acct _accountDao findByIdIncludingRemoved event getAccountId UsageStorageVO storageVO new UsageStorageVO isoId zoneId event getAccountId acct getDomainId StorageTypes ISO null isoSize isoSize event getCreateDate null _usageStorageDao persist storageVO else if EventTypes EVENT_ISO_DELETE equals event getType List UsageStorageVO storageVOs if zoneId 1L storageVOs _usageStorageDao listByIdAndZone event getAccountId isoId StorageTypes ISO zoneId else storageVOs _usageStorageDao listById event getAccountId isoId StorageTypes ISO if storageVOs size s_logger warn isoId event getAccountId
else snapSize event getSize zoneId event getZoneId if EventTypes EVENT_SNAPSHOT_CREATE equals event getType if s_logger isDebugEnabled s_logger debug snapId event getAccountId Account acct _accountDao findByIdIncludingRemoved event getAccountId UsageStorageVO storageVO new UsageStorageVO snapId zoneId event getAccountId acct getDomainId StorageTypes SNAPSHOT null snapSize event getCreateDate null _usageStorageDao persist storageVO else if EventTypes EVENT_SNAPSHOT_DELETE equals event getType List UsageStorageVO storageVOs _usageStorageDao listById event getAccountId snapId StorageTypes SNAPSHOT if storageVOs size s_logger warn snapId event getAccountId for UsageStorageVO storageVO storageVOs if s_logger isDebugEnabled
private void createLoadBalancerHelperEvent UsageEventVO event long zoneId 1L long id event getResourceId if EventTypes EVENT_LOAD_BALANCER_CREATE equals event getType if s_logger isDebugEnabled
s_logger debug id event getAccountId zoneId event getZoneId Account acct _accountDao findByIdIncludingRemoved event getAccountId UsageLoadBalancerPolicyVO lbVO new UsageLoadBalancerPolicyVO id zoneId event getAccountId acct getDomainId event getCreateDate null _usageLoadBalancerPolicyDao persist lbVO else if EventTypes EVENT_LOAD_BALANCER_DELETE equals event getType SearchCriteria UsageLoadBalancerPolicyVO sc _usageLoadBalancerPolicyDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ id sc addAnd SearchCriteria Op NULL List UsageLoadBalancerPolicyVO lbVOs _usageLoadBalancerPolicyDao search sc null if lbVOs size s_logger warn id event getAccountId for UsageLoadBalancerPolicyVO lbVO lbVOs if s_logger isDebugEnabled
private void createPortForwardingHelperEvent UsageEventVO event long zoneId 1L long id event getResourceId if EventTypes EVENT_NET_RULE_ADD equals event getType if s_logger isDebugEnabled
s_logger debug id event getAccountId zoneId event getZoneId Account acct _accountDao findByIdIncludingRemoved event getAccountId UsagePortForwardingRuleVO pfVO new UsagePortForwardingRuleVO id zoneId event getAccountId acct getDomainId event getCreateDate null _usagePortForwardingRuleDao persist pfVO else if EventTypes EVENT_NET_RULE_DELETE equals event getType SearchCriteria UsagePortForwardingRuleVO sc _usagePortForwardingRuleDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ id sc addAnd SearchCriteria Op NULL List UsagePortForwardingRuleVO pfVOs _usagePortForwardingRuleDao search sc null if pfVOs size s_logger warn id event getAccountId for UsagePortForwardingRuleVO pfVO pfVOs if s_logger isDebugEnabled
protected void createUsageVpnUser UsageEventVO event Account account long accountId account getId long userId event getResourceId long zoneId event getZoneId long domainId account getDomainId List UsageVPNUserVO usageVpnUsers findUsageVpnUsers accountId zoneId userId domainId if usageVpnUsers size
private void createSecurityGroupEvent UsageEventVO event long zoneId 1L long vmId event getResourceId long sgId event getOfferingId if EventTypes EVENT_SECURITY_GROUP_ASSIGN equals event getType if s_logger isDebugEnabled
zoneId event getZoneId Account acct _accountDao findByIdIncludingRemoved event getAccountId UsageSecurityGroupVO securityGroup new UsageSecurityGroupVO zoneId event getAccountId acct getDomainId vmId sgId event getCreateDate null _usageSecurityGroupDao persist securityGroup else if EventTypes EVENT_SECURITY_GROUP_REMOVE equals event getType SearchCriteria UsageSecurityGroupVO sc _usageSecurityGroupDao createSearchCriteria sc addAnd SearchCriteria Op EQ event getAccountId sc addAnd SearchCriteria Op EQ vmId sc addAnd SearchCriteria Op EQ sgId sc addAnd SearchCriteria Op NULL List UsageSecurityGroupVO sgVOs _usageSecurityGroupDao search sc null if sgVOs size s_logger warn sgId vmId event getAccountId for UsageSecurityGroupVO sgVO sgVOs if s_logger isDebugEnabled
Long zoneId event getZoneId Long accountId event getAccountId long physicalsize event getSize null event getSize long virtualsize event getVirtualSize null event getVirtualSize Date created event getCreateDate Account acct _accountDao findByIdIncludingRemoved event getAccountId Long domainId acct getDomainId UsageEventDetailsVO detailVO _usageEventDetailsDao findDetail event getId UsageEventVO DynamicParameters vmSnapshotId name Long vmSnapshotId null if detailVO null String snapId detailVO getValue vmSnapshotId Long valueOf snapId UsageSnapshotOnPrimaryVO vsVO new UsageSnapshotOnPrimaryVO vmId zoneId accountId domainId vmId name virtualsize physicalsize created null vsVO setVmSnapshotId vmSnapshotId if s_logger isDebugEnabled
UsageSnapshotOnPrimaryVO vsVO new UsageSnapshotOnPrimaryVO vmId zoneId accountId domainId vmId name virtualsize physicalsize created null vsVO setVmSnapshotId vmSnapshotId if s_logger isDebugEnabled s_logger debug vsVO _usageSnapshotOnPrimaryDao persist vsVO else if EventTypes EVENT_VM_SNAPSHOT_OFF_PRIMARY equals event getType QueryBuilder UsageSnapshotOnPrimaryVO sc QueryBuilder create UsageSnapshotOnPrimaryVO class sc and sc entity getAccountId SearchCriteria Op EQ event getAccountId sc and sc entity getId SearchCriteria Op EQ vmId sc and sc entity getName SearchCriteria Op EQ name sc and sc entity getDeleted SearchCriteria Op NULL List UsageSnapshotOnPrimaryVO vmsnaps sc list if vmsnaps size s_logger warn name vmId event getAccountId for UsageSnapshotOnPrimaryVO vmsnap vmsnaps
public static void main String args UsageSanityChecker usc new UsageSanityChecker String sanityErrors try sanityErrors usc runSanityCheck if sanityErrors length
public static boolean parse AccountVO account Date startDate Date endDate if LOGGER isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord long zoneId long runningTime Date startDate Date endDate AccountVO account long ipId String ipAddress boolean isSourceNat boolean isSystem if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long lbId long zoneId if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long vmId long noId long zoneId boolean isDefault if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
String key zoneId if usageNetwork getHostId key usageNetwork getHostId NetworkInfo networkInfo networkUsageByZone get key long bytesSent usageNetwork getBytesSent long bytesReceived usageNetwork getBytesReceived if networkInfo null bytesSent networkInfo getBytesSent bytesReceived networkInfo getBytesRcvd networkUsageByZone put key new NetworkInfo zoneId usageNetwork getHostId usageNetwork getHostType usageNetwork getNetworkId bytesSent bytesReceived List UsageVO usageRecords new ArrayList UsageVO for String key networkUsageByZone keySet NetworkInfo networkInfo networkUsageByZone get key long totalBytesSent networkInfo getBytesSent long totalBytesReceived networkInfo getBytesRcvd
NetworkInfo networkInfo networkUsageByZone get key long totalBytesSent networkInfo getBytesSent long totalBytesReceived networkInfo getBytesRcvd if totalBytesSent 0L totalBytesReceived 0L if s_logger isDebugEnabled s_logger debug toHumanReadableSize totalBytesSent toHumanReadableSize totalBytesReceived account getId networkInfo getZoneId startDate endDate Long hostId null String usageDesc if networkInfo getHostId hostId networkInfo getHostId usageDesc networkInfo getHostId UsageVO usageRecord new UsageVO networkInfo getZoneId account getId account getDomainId usageDesc totalBytesSent UsageTypes NETWORK_BYTES_SENT new Double totalBytesSent hostId networkInfo getHostType networkInfo getNetworkId startDate endDate usageRecords add usageRecord usageDesc if networkInfo getHostId
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long pfId long zoneId if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long vmId long sgId long zoneId if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord long zoneId int type long runningTime Date startDate Date endDate AccountVO account long storageId Long sourceId long size Long virtualSize if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long vmId String vmName long zoneId long serviceOfferingId long templateId String hypervisorType Long cpuCores Long cpuSpeed Long memory if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
Map String UsageSnapshotOnPrimaryVO unprocessedUsage new HashMap String UsageSnapshotOnPrimaryVO for UsageSnapshotOnPrimaryVO usageRec usageUsageVMSnapshots s_logger debug usageRec toString String key usageRec getName if usageRec getPhysicalSize usageRec setDeleted new Date s_usageSnapshotOnPrimaryDao updateDeleted usageRec else unprocessedUsage put key usageRec for String key unprocessedUsage keySet UsageSnapshotOnPrimaryVO usageRec unprocessedUsage get key Date created usageRec getCreated if created before startDate created startDate Date endDateEffective endDate
private static void createUsageRecord int usageType long runningTime Date startDate Date endDate AccountVO account long vmId String name long zoneId long virtualSize long physicalSize Long vmSnapshotId if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long volId long zoneId Long doId Long vmId long size Long vmSnapshotId if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long userId String userName long zoneId if s_logger isDebugEnabled
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
long ioWrite usageVmDisk getIOWrite long bytesRead usageVmDisk getBytesRead long bytesWrite usageVmDisk getBytesWrite if vmDiskInfo null ioRead vmDiskInfo getIORead ioWrite vmDiskInfo getIOWrite bytesRead vmDiskInfo getBytesRead bytesWrite vmDiskInfo getBytesWrite vmDiskUsageByZone put key new VmDiskInfo zoneId usageVmDisk getVmId usageVmDisk getVolumeId ioRead ioWrite bytesRead bytesWrite List UsageVO usageRecords new ArrayList UsageVO for String key vmDiskUsageByZone keySet VmDiskInfo vmDiskInfo vmDiskUsageByZone get key long ioRead vmDiskInfo getIORead long ioWrite vmDiskInfo getIOWrite long bytesRead vmDiskInfo getBytesRead
volumeId vmDiskInfo getVolumeId usageDesc vmId volumeId UsageVO usageRecord new UsageVO vmDiskInfo getZoneId account getId account getDomainId usageDesc ioRead UsageTypes VM_DISK_IO_READ new Double ioRead vmId null null null vmDiskInfo getVolumeId startDate endDate usageRecords add usageRecord usageDesc if vmDiskInfo getVmId vmDiskInfo getVolumeId usageDesc vmId volumeId usageRecord new UsageVO vmDiskInfo getZoneId account getId account getDomainId usageDesc ioWrite UsageTypes VM_DISK_BYTES_WRITE new Double ioWrite vmId null null null vmDiskInfo getVolumeId startDate endDate usageRecords add usageRecord usageDesc if vmDiskInfo getVmId vmDiskInfo getVolumeId usageDesc vmId volumeId usageRecord new UsageVO vmDiskInfo getZoneId account getId account getDomainId usageDesc bytesRead UsageTypes VM_DISK_BYTES_READ new Double bytesRead vmId null null null vmDiskInfo getVolumeId startDate endDate usageRecords add usageRecord usageDesc
public static boolean parse AccountVO account Date startDate Date endDate if s_logger isDebugEnabled
private static void createUsageRecord int type long runningTime Date startDate Date endDate AccountVO account long volId long zoneId Long doId Long templateId long size if s_logger isDebugEnabled
if jsonContentType null jsonContentType isEmpty resp setContentType jsonContentType else resp setContentType JSON_CONTENT_TYPE else if RESPONSE_TYPE_XML equalsIgnoreCase responseType resp setContentType XML_CONTENT_TYPE if responseCode null resp setStatus responseCode addSecurityHeaders resp resp getWriter print response catch final IOException ioex if s_logger isTraceEnabled s_logger trace ioex catch final Exception ex if ex IllegalStateException
public static void initLog4j String log4jConfigFileName assert log4jConfigFileName null File file PropertiesUtil findConfigFile log4jConfigFileName if file null
StringBuilder swiftCmdBuilder new StringBuilder swiftCmdBuilder append getSwiftContainerCmd swift getSwiftCLIPath container if rFilename null swiftCmdBuilder append swiftCmdBuilder append rFilename Script command new Script logger command add command add swiftCmdBuilder toString OutputInterpreter AllLinesParser parser new OutputInterpreter AllLinesParser String result command execute parser if result null parser getLines null parser getLines equalsIgnoreCase return parser getLines split else if result null String errMsg result
swiftCmdBuilder append swiftCmdBuilder append rFilename Script command new Script logger command add command add swiftCmdBuilder toString OutputInterpreter AllLinesParser parser new OutputInterpreter AllLinesParser String result command execute parser if result null parser getLines null parser getLines equalsIgnoreCase return parser getLines split else if result null String errMsg result logger debug errMsg else String errMsg
int firstIndexOfSeparator swiftPath indexOf File separator String container swiftPath substring firstIndexOfSeparator String srcPath swiftPath substring firstIndexOfSeparator String destFilePath if destDirectory isDirectory destFilePath destDirectory getAbsolutePath File separator srcPath else destFilePath destDirectory getAbsolutePath Script command new Script logger command add command add getSwiftObjectCmd cfg getSwiftCLIPath container srcPath destFilePath OutputInterpreter AllLinesParser parser new OutputInterpreter AllLinesParser String result command execute parser if result null String errMsg result
else destFilePath destDirectory getAbsolutePath Script command new Script logger command add command add getSwiftObjectCmd cfg getSwiftCLIPath container srcPath destFilePath OutputInterpreter AllLinesParser parser new OutputInterpreter AllLinesParser String result command execute parser if result null String errMsg result logger debug errMsg throw new CloudRuntimeException swiftPath if parser getLines null String lines parser getLines split for String line lines if line contains line contains
public static boolean cifsCredentialsPresent URI uri List NameValuePair args URLEncodedUtils parse uri boolean foundUser false boolean foundPswd false for NameValuePair nvp args String name nvp getName if name equals foundUser true
DocumentBuilder docBuilder factory newDocumentBuilder Document doc docBuilder parse is Element rootElement doc getDocumentElement for int i i tagNames length i NodeList targetNodes rootElement getElementsByTagName tagNames i if targetNodes getLength s_logger error tagNames i else List Pair String Integer priorityList new ArrayList for int j j targetNodes getLength j Node node targetNodes item j addPriorityListElementExaminingNode tagNames i node priorityList priorityList sort Comparator comparing x x second returnValues put tagNames i getListOfFirstElements priorityList catch Exception ex
public static InputStream getInputStreamFromUrl String url String user String password try Pair String Integer hostAndPort validateUrl url HttpClient httpclient new HttpClient new MultiThreadedHttpConnectionManager if user null password null httpclient getParams setAuthenticationPreemptive true Credentials defaultcreds new UsernamePasswordCredentials user password httpclient getState setCredentials new AuthScope hostAndPort first hostAndPort second AuthScope ANY_REALM defaultcreds
try Pair String Integer hostAndPort validateUrl url HttpClient httpclient new HttpClient new MultiThreadedHttpConnectionManager if user null password null httpclient getParams setAuthenticationPreemptive true Credentials defaultcreds new UsernamePasswordCredentials user password httpclient getState setCredentials new AuthScope hostAndPort first hostAndPort second AuthScope ANY_REALM defaultcreds s_logger info user password hostAndPort first hostAndPort second GetMethod method new GetMethod url int statusCode httpclient executeMethod method if statusCode HttpStatus SC_OK s_logger error url return null return method getResponseBodyAsStream catch Exception ex
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configPortProfileDetails doc name type binding mode vlanid vdc espName editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configPortProfileDetails doc name type binding mode vlanid vdc espName editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configPortProfileDetails doc name type binding mode vlanid editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configPortProfileDetails doc name type binding mode vlanid editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configPortProfileDetails doc name mode params editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configPortProfileDetails doc name mode params editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild deletePortProfileDetails doc portName editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild deletePortProfileDetails doc portName editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild policyMapDetails doc name averageRate maxRate burstRate editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild policyMapDetails doc name averageRate maxRate burstRate editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild deletePolicyMapDetails doc name editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild deletePolicyMapDetails doc name editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild serviceDetails doc policyMap portProfile attach editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild serviceDetails doc policyMap portProfile attach editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
doc getDocumentElement appendChild get Element filter doc createElement filter setAttribute get appendChild filter Element show doc createElement filter appendChild show Element portProfile doc createElement show appendChild portProfile Element nameNode doc createElement portProfile appendChild nameNode Element profileName doc createElement profileName setTextContent name nameNode appendChild profileName return serialize domImpl doc catch ParserConfigurationException e
get appendChild filter Element show doc createElement filter appendChild show Element portProfile doc createElement show appendChild portProfile Element nameNode doc createElement portProfile appendChild nameNode Element profileName doc createElement profileName setTextContent name nameNode appendChild profileName return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
Document doc createDocument domImpl Element get doc createElement doc getDocumentElement appendChild get Element filter doc createElement filter setAttribute get appendChild filter Element show doc createElement filter appendChild show Element policyMap doc createElement show appendChild policyMap Element nameNode doc createElement nameNode setTextContent name policyMap appendChild nameNode return serialize domImpl doc catch ParserConfigurationException e
Element filter doc createElement filter setAttribute get appendChild filter Element show doc createElement filter appendChild show Element policyMap doc createElement show appendChild policyMap Element nameNode doc createElement nameNode setTextContent name policyMap appendChild nameNode return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
try DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc domImpl createDocument s_namespace null Element capabilities doc createElement Element capability doc createElement capability setTextContent capabilities appendChild capability doc getDocumentElement appendChild capabilities return serialize domImpl doc catch ParserConfigurationException e s_logger error e getMessage return null catch DOMException e
DocumentBuilderFactory docFactory DocumentBuilderFactory newInstance DocumentBuilder docBuilder docFactory newDocumentBuilder DOMImplementation domImpl docBuilder getDOMImplementation Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configVServiceNodeDetails doc vlanId ipAddr editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e
Document doc createDocument domImpl Element editConfig doc createElement doc getDocumentElement appendChild editConfig Element target doc createElement Element running doc createElement target appendChild running editConfig appendChild target Element config doc createElement config appendChild configVServiceNodeDetails doc vlanId ipAddr editConfig appendChild config return serialize domImpl doc catch ParserConfigurationException e s_logger error vlanId e getMessage return null catch DOMException e
if list getLength NodeList readOnlyList Element list item getElementsByTagName Element readOnly Element readOnlyList item for Node node readOnly getFirstChild node null node node getNextSibling String currentNode node getNodeName String value node getTextContent if equalsIgnoreCase currentNode _policyMap policyMapName value else if equalsIgnoreCase currentNode _policyMap committedRate Integer parseInt value trim else if equalsIgnoreCase currentNode _policyMap burstRate Integer parseInt value trim else if equalsIgnoreCase currentNode _policyMap peakRate Integer parseInt value trim catch DOMException e
String value node getTextContent if equalsIgnoreCase currentNode setPortBinding value else if equalsIgnoreCase currentNode _portProfile profileName value else if equalsIgnoreCase currentNode setProfileConfiguration value else if equalsIgnoreCase currentNode setPortType value else if equalsIgnoreCase currentNode if value equalsIgnoreCase _portProfile status true else if equalsIgnoreCase currentNode _portProfile maxPorts Integer parseInt value trim catch DOMException e
assert rpcError getNodeName equalsIgnoreCase for Node node rpcError getFirstChild node null node node getNextSibling if node getNodeName equalsIgnoreCase _type ErrorType valueOf node getTextContent trim else if node getNodeName equalsIgnoreCase _tag getErrorTag node getTextContent trim else if node getNodeName equalsIgnoreCase _severity ErrorSeverity valueOf node getTextContent trim else if node getNodeName equalsIgnoreCase _path node getTextContent else if node getNodeName equalsIgnoreCase _message node getTextContent else if node getNodeName equalsIgnoreCase _info node getTextContent catch DOMException e
public static void initComponentsLifeCycle if s_initializeBeans return AutowireCapableBeanFactory beanFactory s_appContext getAutowireCapableBeanFactory Map String ComponentMethodInterceptable interceptableComponents getApplicationContext getBeansOfType ComponentMethodInterceptable class for Map Entry String ComponentMethodInterceptable entry interceptableComponents entrySet Object bean getTargetObject entry getValue beanFactory configureBean bean entry getKey Map String ComponentLifecycle lifecycleComponents getApplicationContext getBeansOfType ComponentLifecycle class Map String ComponentLifecycle classifiedComponents new Map ComponentLifecycle MAX_RUN_LEVELS for int i i ComponentLifecycle MAX_RUN_LEVELS i classifiedComponents i new HashMap String ComponentLifecycle for Map Entry String ComponentLifecycle entry lifecycleComponents entrySet classifiedComponents entry getValue getRunLevel put entry getKey entry getValue Map String SystemIntegrityChecker integrityCheckers getApplicationContext getBeansOfType SystemIntegrityChecker class for Entry String SystemIntegrityChecker entry integrityCheckers entrySet
for Map Entry String ComponentMethodInterceptable entry interceptableComponents entrySet Object bean getTargetObject entry getValue beanFactory configureBean bean entry getKey Map String ComponentLifecycle lifecycleComponents getApplicationContext getBeansOfType ComponentLifecycle class Map String ComponentLifecycle classifiedComponents new Map ComponentLifecycle MAX_RUN_LEVELS for int i i ComponentLifecycle MAX_RUN_LEVELS i classifiedComponents i new HashMap String ComponentLifecycle for Map Entry String ComponentLifecycle entry lifecycleComponents entrySet classifiedComponents entry getValue getRunLevel put entry getKey entry getValue Map String SystemIntegrityChecker integrityCheckers getApplicationContext getBeansOfType SystemIntegrityChecker class for Entry String SystemIntegrityChecker entry integrityCheckers entrySet s_logger info entry getKey try entry getValue check catch Throwable e
for Map Entry String ComponentLifecycle entry lifecycleComponents entrySet classifiedComponents entry getValue getRunLevel put entry getKey entry getValue Map String SystemIntegrityChecker integrityCheckers getApplicationContext getBeansOfType SystemIntegrityChecker class for Entry String SystemIntegrityChecker entry integrityCheckers entrySet s_logger info entry getKey try entry getValue check catch Throwable e s_logger error e System exit Map String String avoidMap new HashMap String String for int i i ComponentLifecycle MAX_RUN_LEVELS i for Map Entry String ComponentLifecycle entry classifiedComponents i entrySet ComponentLifecycle component entry getValue String implClassName ComponentContext getTargetClass component getName
s_logger info entry getKey try entry getValue check catch Throwable e s_logger error e System exit Map String String avoidMap new HashMap String String for int i i ComponentLifecycle MAX_RUN_LEVELS i for Map Entry String ComponentLifecycle entry classifiedComponents i entrySet ComponentLifecycle component entry getValue String implClassName ComponentContext getTargetClass component getName s_logger info implClassName if avoidMap containsKey implClassName s_logger info implClassName continue
Map String String avoidMap new HashMap String String for int i i ComponentLifecycle MAX_RUN_LEVELS i for Map Entry String ComponentLifecycle entry classifiedComponents i entrySet ComponentLifecycle component entry getValue String implClassName ComponentContext getTargetClass component getName s_logger info implClassName if avoidMap containsKey implClassName s_logger info implClassName continue try component configure component getName component getConfigParams catch ConfigurationException e s_logger error e throw new RuntimeException implClassName e avoidMap put implClassName implClassName
for int i i ComponentLifecycle MAX_RUN_LEVELS i for Map Entry String ComponentLifecycle entry classifiedComponents i entrySet ComponentLifecycle component entry getValue String implClassName ComponentContext getTargetClass component getName s_logger info implClassName if avoidMap containsKey implClassName s_logger info implClassName continue try component configure component getName component getConfigParams catch ConfigurationException e s_logger error e throw new RuntimeException implClassName e avoidMap put implClassName implClassName avoidMap clear
s_logger info implClassName continue try component configure component getName component getConfigParams catch ConfigurationException e s_logger error e throw new RuntimeException implClassName e avoidMap put implClassName implClassName avoidMap clear for int i i ComponentLifecycle MAX_RUN_LEVELS i for Map Entry String ComponentLifecycle entry classifiedComponents i entrySet ComponentLifecycle component entry getValue String implClassName ComponentContext getTargetClass component getName s_logger info implClassName if avoidMap containsKey implClassName
public void check Properties dbProps throws IOException String encryptionType dbProps getProperty
public static HttpMethodRetryHandler getHttpMethodRetryHandler final int retryCount if LOGGER isDebugEnabled
public static void setProxy Proxy proxy HttpClient httpClient if proxy null httpClient null if LOGGER isDebugEnabled
public static void setCredentials String username String password HttpClient httpClient if username null password null httpClient null if LOGGER isDebugEnabled
Collections reverse addrs InterfaceAddress addr null for final InterfaceAddress iaddr addrs final InetAddress inet iaddr getAddress if inet isLinkLocalAddress inet isLoopbackAddress inet isMulticastAddress inet getAddress length addr iaddr break if addr null return null final String result new String result addr getAddress getHostAddress try final byte mac nic getHardwareAddress result byte2Mac mac catch final SocketException e
public static boolean isSameIpRange final String cidrA final String cidrB if NetUtils isValidIp4Cidr cidrA
public static SSLContext initClientSSLContext throws GeneralSecurityException IOException char passphrase KeyStoreUtils DEFAULT_KS_PASSPHRASE File confFile PropertiesUtil findConfigFile if confFile null
if socketChannel read peerNetData if sslEngine isInboundDone sslEngine isOutboundDone return new HandshakeHolder peerAppData peerNetData false try sslEngine closeInbound catch SSLException e s_logger warn e sslEngine closeOutbound return new HandshakeHolder peerAppData peerNetData true peerNetData flip SSLEngineResult result null try result sslEngine unwrap peerNetData peerAppData peerNetData compact catch final SSLException sslException
Override protected void init throws IOException _selector Selector open Task task null try _clientConnection SocketChannel open s_logger info _host _port final InetSocketAddress peerAddr new InetSocketAddress _host _port _clientConnection connect peerAddr _clientConnection configureBlocking false final SSLContext sslContext Link initClientSSLContext SSLEngine sslEngine sslContext createSSLEngine _host _port sslEngine setUseClientMode true sslEngine setEnabledProtocols SSLUtils getSupportedProtocols sslEngine getEnabledProtocols sslEngine beginHandshake if Link doHandshake _clientConnection sslEngine
_clientConnection SocketChannel open s_logger info _host _port final InetSocketAddress peerAddr new InetSocketAddress _host _port _clientConnection connect peerAddr _clientConnection configureBlocking false final SSLContext sslContext Link initClientSSLContext SSLEngine sslEngine sslContext createSSLEngine _host _port sslEngine setUseClientMode true sslEngine setEnabledProtocols SSLUtils getSupportedProtocols sslEngine getEnabledProtocols sslEngine beginHandshake if Link doHandshake _clientConnection sslEngine s_logger error _host _port _selector close throw new IOException _host _port s_logger info
protected void closeConnection final SelectionKey key if key null final SocketChannel channel SocketChannel key channel key cancel try if channel null if s_logger isDebugEnabled
private void logRequestExecution final HttpUriRequest request final URI uri request getURI String query uri getQuery query query null query
public T void executeUpdateObject final T newObject final String path final Map String String parameters throws CloudstackRESTException
SuppressWarnings public T T executeCreateObject final T newObject final String path final Map String String parameters throws CloudstackRESTException
public void executeDeleteObject final String path throws CloudstackRESTException
public T T executeRetrieveObject final Type returnObjectType final String path final Map String String parameters throws CloudstackRESTException
private CloseableHttpResponse createAndExecuteRequest final HttpMethods method final String path final Map String String parameters final Optional String jsonPayLoad throws CloudstackRESTException final HttpUriRequest httpRequest HttpUriRequestBuilder create path path parameters parameters jsonPayload jsonPayLoad method method build if jsonPayLoad isPresent
private CloseableHttpResponse executeRequest final HttpUriRequest httpRequest throws CloudstackRESTException final CloseableHttpResponse response client execute httpRequest
pb redirectErrorStream true if _workDir null pb directory new File _workDir _process pb start if _process null _logger warn buildCommandLine command return command BufferedReader ir new BufferedReader new InputStreamReader _process getInputStream _thread Thread currentThread ScheduledFuture String future null if _timeout future s_executors schedule this _timeout TimeUnit MILLISECONDS Task task null if interpreter null interpreter drain task new Task interpreter ir s_executors execute task
return String valueOf _process exitValue else break catch InterruptedException e if _isTimeOut _logger debug continue finally if future null future cancel false Thread interrupted TimedOutLogger log new TimedOutLogger _process Task timedoutTask new Task log ir timedoutTask run if _passwordCommand
public static String findScript String path String script
public static String findScript String path String script s_logger debug script URL url ClassLoader getSystemResource script
public static String findScript String path String script s_logger debug script URL url ClassLoader getSystemResource script s_logger debug url File file null if url null file new File url getFile
file new File url getFile s_logger debug file getAbsolutePath return file getAbsolutePath if path null s_logger warn script return null path path replace File separator if path endsWith File separator url Script class getClassLoader getResource path script else url Script class getClassLoader getResource path File separator script s_logger debug url if url null try file new File new URI url toString getPath
url Script class getClassLoader getResource path script else url Script class getClassLoader getResource path File separator script s_logger debug url if url null try file new File new URI url toString getPath s_logger debug file getAbsolutePath return file getAbsolutePath catch URISyntaxException e s_logger warn url toString if path endsWith File separator path path substring path lastIndexOf File separator if path startsWith File separator file new File path File separator script
catch URISyntaxException e s_logger warn url toString if path endsWith File separator path path substring path lastIndexOf File separator if path startsWith File separator file new File path File separator script return file exists file getAbsolutePath null s_logger debug script String search null for int i i i if i String cp Script class getResource Script class getSimpleName toExternalForm int begin cp indexOf File separator if begin begin cp indexOf int endBang cp lastIndexOf
if i String cp Script class getResource Script class getSimpleName toExternalForm int begin cp indexOf File separator if begin begin cp indexOf int endBang cp lastIndexOf int end cp lastIndexOf File separator endBang if end end cp lastIndexOf endBang if end cp cp substring begin else cp cp substring begin end s_logger debug cp search cp else if i s_logger debug try final File propsFile PropertiesUtil findConfigFile
throw new SshException sshSession execCommand cmd InputStream stdout sshSession getStdout InputStream stderr sshSession getStderr byte buffer new byte StringBuffer sbStdoutResult new StringBuffer StringBuffer sbStdErrResult new StringBuffer int currentReadBytes while true if stdout null stderr null throw new SshException if stdout available stderr available int conditions sshSession waitForCondition ChannelCondition STDOUT_DATA ChannelCondition STDERR_DATA ChannelCondition EOF ChannelCondition EXIT_STATUS if conditions ChannelCondition TIMEOUT String msg
public static void scpFrom String host int port String user File permKeyFile String localTargetDirectory String remoteTargetFile throws Exception com trilead ssh2 Connection conn null com trilead ssh2 SCPClient scpClient null try conn new com trilead ssh2 Connection host port conn connect null DEFAULT_CONNECT_TIMEOUT DEFAULT_KEX_TIMEOUT if conn authenticateWithPublicKey user permKeyFile null String msg user host
public static void scpTo String host int port String user File pemKeyFile String password String remoteTargetDirectory String localFile String fileMode int connectTimeoutInMs int kexTimeoutInMs throws Exception com trilead ssh2 Connection conn null com trilead ssh2 SCPClient scpClient null try conn new com trilead ssh2 Connection host port conn connect null connectTimeoutInMs kexTimeoutInMs if pemKeyFile null if conn authenticateWithPassword user password String msg user host
public static void scpTo String host int port String user File pemKeyFile String password String remoteTargetDirectory byte data String remoteFileName String fileMode int connectTimeoutInMs int kexTimeoutInMs throws Exception com trilead ssh2 Connection conn null com trilead ssh2 SCPClient scpClient null try conn new com trilead ssh2 Connection host port conn connect null connectTimeoutInMs kexTimeoutInMs if pemKeyFile null if conn authenticateWithPassword user password String msg user host
public static Pair Boolean String sshExecute String host int port String user File pemKeyFile String password String command int connectTimeoutInMs int kexTimeoutInMs int waitResultTimeoutInMs throws Exception com trilead ssh2 Connection conn null com trilead ssh2 Session sess null try conn new com trilead ssh2 Connection host port conn connect null connectTimeoutInMs kexTimeoutInMs if pemKeyFile null if conn authenticateWithPassword user password String msg user host
if stdout available stderr available int conditions sess waitForCondition ChannelCondition STDOUT_DATA ChannelCondition STDERR_DATA ChannelCondition EOF ChannelCondition EXIT_STATUS waitResultTimeoutInMs throwSshExceptionIfConditionsTimeout conditions if conditions ChannelCondition EXIT_STATUS break if canEndTheSshConnection waitResultTimeoutInMs sess conditions break while currentReadBytes stdout read buffer sbResult append new String buffer currentReadBytes while currentReadBytes stderr read buffer sbResult append new String buffer currentReadBytes String result sbResult toString if StringUtils isBlank result try result IOUtils toString stdout StandardCharsets UTF_8
if conditions ChannelCondition EXIT_STATUS break if canEndTheSshConnection waitResultTimeoutInMs sess conditions break while currentReadBytes stdout read buffer sbResult append new String buffer currentReadBytes while currentReadBytes stderr read buffer sbResult append new String buffer currentReadBytes String result sbResult toString if StringUtils isBlank result try result IOUtils toString stdout StandardCharsets UTF_8 catch IOException e s_logger error e getMessage return new Pair Boolean String false result
protected static void throwSshExceptionIfConditionsTimeout int conditions throws SshException if conditions ChannelCondition TIMEOUT String msg
protected static void throwSshExceptionIfStdoutOrStdeerIsNull InputStream stdout InputStream stderr throws SshException if stdout null stderr null String msg
final ClientConfiguration configuration new ClientConfiguration if clientOptions isHttps null configuration setProtocol clientOptions isHttps HTTPS HTTP if clientOptions getConnectionTimeout null configuration setConnectionTimeout clientOptions getConnectionTimeout if clientOptions getMaxErrorRetry null configuration setMaxErrorRetry clientOptions getMaxErrorRetry if clientOptions getSocketTimeout null configuration setSocketTimeout clientOptions getSocketTimeout if clientOptions getUseTCPKeepAlive null configuration setUseTcpKeepAlive clientOptions getUseTCPKeepAlive if clientOptions getConnectionTtl null configuration setConnectionTTL clientOptions getConnectionTtl if clientOptions getSigner null configuration setSignerOverride clientOptions getSigner
configuration setProtocol clientOptions isHttps HTTPS HTTP if clientOptions getConnectionTimeout null configuration setConnectionTimeout clientOptions getConnectionTimeout if clientOptions getMaxErrorRetry null configuration setMaxErrorRetry clientOptions getMaxErrorRetry if clientOptions getSocketTimeout null configuration setSocketTimeout clientOptions getSocketTimeout if clientOptions getUseTCPKeepAlive null configuration setUseTcpKeepAlive clientOptions getUseTCPKeepAlive if clientOptions getConnectionTtl null configuration setConnectionTTL clientOptions getConnectionTtl if clientOptions getSigner null configuration setSignerOverride clientOptions getSigner LOGGER debug format configuration getProtocol configuration getSignerOverride configuration getConnectionTimeout configuration getMaxErrorRetry configuration getSocketTimeout clientOptions getUseTCPKeepAlive clientOptions getConnectionTtl final AmazonS3Client client new AmazonS3Client basicAWSCredentials configuration
public static Upload putFile final ClientOptions clientOptions final File sourceFile final String bucketName final String key
public static Upload putObject final ClientOptions clientOptions final InputStream sourceStream final String bucketName final String key
public static Upload putObject final ClientOptions clientOptions final PutObjectRequest req
public static Download getFile final ClientOptions clientOptions final String bucketName final String key final File file
public static Download getFile final ClientOptions clientOptions final GetObjectRequest getObjectRequest final File file
public static URL generatePresignedUrl final ClientOptions clientOptions final String bucketName final String key final Date expiration
public static S3ObjectInputStream getObjectStream final ClientOptions clientOptions final String bucketName final String key
public static List S3ObjectSummary listDirectory final ClientOptions clientOptions final String bucketName final String directory
public static void deleteObject final ClientOptions clientOptions final String bucketName final String key
public static void deleteDirectory final ClientOptions clientOptions final String bucketName final String directoryName
StringBuilder sb new StringBuilder sb append append tag List XmlObject children new ArrayList XmlObject for Map Entry String Object e elements entrySet String key e getKey Object val e getValue if val String sb append String format key val toString else if val XmlObject children add XmlObject val else if val List children addAll Collection extends XmlObject val else throw new CloudRuntimeException String format key val getClass getName if children isEmpty text null
if file exists throw new CloudRuntimeException file getAbsolutePath if file length minimumFileSize s_logger debug return int waitedSeconds int intervalSeconds while true BasicFileAttributes attrs Files readAttributes file toPath BasicFileAttributes class long modifyIdle System currentTimeMillis attrs lastModifiedTime toMillis long accessIdle System currentTimeMillis attrs lastAccessTime toMillis if modifyIdle inactiveThresholdMilliseconds accessIdle inactiveThresholdMilliseconds s_logger debug filePath inactiveThresholdMilliseconds return else
public static String checkTemplateFormat String path String uripath String command if isCompressedExtension uripath command String output Script runSimpleBashScript command path if output contains output contains isCorrectExtension uripath s_logger debug path output return if output contains output contains output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath isCorrectExtension uripath
command String output Script runSimpleBashScript command path if output contains output contains isCorrectExtension uripath s_logger debug path output return if output contains output contains output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath
if output contains output contains isCorrectExtension uripath s_logger debug path output return if output contains output contains output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath s_logger debug path output return
if output contains output contains output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath s_logger debug path output return if output contains isCorrectExtension uripath s_logger debug path output return
stdError e getMessage if LOG isTraceEnabled LOG trace e getMessage catch TimeoutException e retVal stdError if LOG isTraceEnabled LOG trace e getMessage finally if Strings isNullOrEmpty stdError stdOutput CharStreams toString new InputStreamReader process getInputStream stdError CharStreams toString new InputStreamReader process getErrorStream process destroy if LOG isTraceEnabled LOG trace stdOutput
Override public void checkServerTrusted X509Certificate certificates String authType throws CertificateException if certificates null LOG isDebugEnabled LOG debug for int i i certificates length i
Test public void testGetIp6FromRange assertEquals NetUtils getIp6FromRange for int i i i final String ip NetUtils getIp6FromRange assertThat ip anyOf equalTo equalTo
s_logger debug vmMo getName return null ClusterConfigInfoEx configInfo getClusterConfigInfo if configInfo null s_logger debug vmMo getName return null List ClusterDasVmConfigInfo dasVmConfig configInfo getDasVmConfig for int dasVmConfigIndex dasVmConfigIndex dasVmConfig size dasVmConfigIndex ClusterDasVmConfigInfo dasVmConfigInfo dasVmConfig get dasVmConfigIndex if dasVmConfigInfo null dasVmConfigInfo getKey getValue equals vmMor getValue DasVmPriority dasVmPriority dasVmConfigInfo getRestartPriority if dasVmPriority null return dasVmPriority value else return ClusterDasVmSettingsRestartPriority CLUSTER_RESTART_PRIORITY value
ClusterDasVmSettings clusterDasVmSettings new ClusterDasVmSettings clusterDasVmSettings setRestartPriority priority ClusterDasVmConfigInfo clusterDasVmConfigInfo new ClusterDasVmConfigInfo clusterDasVmConfigInfo setKey vmMor clusterDasVmConfigInfo setDasSettings clusterDasVmSettings ClusterDasVmConfigSpec clusterDasVmConfigSpec new ClusterDasVmConfigSpec clusterDasVmConfigSpec setOperation StringUtils isNotBlank currentVmRestartPriority ArrayUpdateOperation EDIT ArrayUpdateOperation ADD clusterDasVmConfigSpec setInfo clusterDasVmConfigInfo ClusterConfigSpecEx clusterConfigSpecEx new ClusterConfigSpecEx ClusterDasConfigInfo clusterDasConfigInfo new ClusterDasConfigInfo clusterConfigSpecEx setDasConfig clusterDasConfigInfo clusterConfigSpecEx getDasVmConfigSpec add clusterDasVmConfigSpec ManagedObjectReference morTask _context getService reconfigureComputeResourceTask _mor clusterConfigSpecEx true boolean result _context getVimClient waitForTask morTask if result
Override public String getRecommendedDiskController String guestOsId throws Exception VirtualMachineConfigOption vmConfigOption _context getService queryConfigOption getEnvironmentBrowser null null GuestOsDescriptor guestOsDescriptor null String diskController null List GuestOsDescriptor guestDescriptors vmConfigOption getGuestOSDescriptor for GuestOsDescriptor descriptor guestDescriptors if guestOsId null guestOsId equalsIgnoreCase descriptor getId guestOsDescriptor descriptor break if guestOsDescriptor null diskController VmwareHelper getRecommendedDiskControllerFromDescriptor guestOsDescriptor s_logger debug guestOsId getHyperHostName diskController return diskController else String msg guestOsId getHyperHostName
try if testExistence fileExists fullPath String searchResult searchFileInSubFolders file getFileName true excludeFolders if searchResult null return true else fullPath searchResult catch Exception e s_logger info e getClass getName return true ManagedObjectReference morTask _context getService deleteDatastoreFileTask morFileManager fullPath morDc boolean result _context getVimClient waitForTask morTask if result _context waitForTaskProgressDone morTask return true
public boolean copyDatastoreFile String srcFilePath ManagedObjectReference morSrcDc ManagedObjectReference morDestDs String destFilePath ManagedObjectReference morDestDc boolean forceOverwrite throws Exception String srcDsName getName DatastoreMO destDsMo new DatastoreMO _context morDestDs String destDsName destDsMo getName ManagedObjectReference morFileManager _context getServiceContent getFileManager String srcFullPath srcFilePath if DatastoreFile isFullDatastorePath srcFullPath srcFullPath String format srcDsName srcFilePath String destFullPath destFilePath if DatastoreFile isFullDatastorePath destFullPath destFullPath String format destDsName destFilePath ManagedObjectReference morTask _context getService copyDatastoreFileTask morFileManager srcFullPath morSrcDc destFullPath morDestDc forceOverwrite boolean result _context getVimClient waitForTask morTask if result _context waitForTaskProgressDone morTask return true else
public boolean moveDatastoreFile String srcFilePath ManagedObjectReference morSrcDc ManagedObjectReference morDestDs String destFilePath ManagedObjectReference morDestDc boolean forceOverwrite throws Exception String srcDsName getName DatastoreMO destDsMo new DatastoreMO _context morDestDs String destDsName destDsMo getName ManagedObjectReference morFileManager _context getServiceContent getFileManager String srcFullPath srcFilePath if DatastoreFile isFullDatastorePath srcFullPath srcFullPath String format srcDsName srcFilePath String destFullPath destFilePath if DatastoreFile isFullDatastorePath destFullPath destFullPath String format destDsName destFilePath ManagedObjectReference morTask _context getService moveDatastoreFileTask morFileManager srcFullPath morSrcDc destFullPath morDestDc forceOverwrite boolean result _context getVimClient waitForTask morTask if result _context waitForTaskProgressDone morTask return true else
public boolean fileExists String fileFullPath throws Exception DatastoreFile file new DatastoreFile fileFullPath DatastoreFile dirFile new DatastoreFile file getDatastoreName file getDir HostDatastoreBrowserMO browserMo getHostDatastoreBrowserMO
public boolean fileExists String fileFullPath throws Exception DatastoreFile file new DatastoreFile fileFullPath DatastoreFile dirFile new DatastoreFile file getDatastoreName file getDir HostDatastoreBrowserMO browserMo getHostDatastoreBrowserMO s_logger info file getFileName dirFile getPath HostDatastoreBrowserSearchResults results browserMo searchDatastore dirFile getPath file getFileName true if results null List FileInfo info results getFile if info null info size
public long fileDiskSize String fileFullPath throws Exception long size DatastoreFile file new DatastoreFile fileFullPath DatastoreFile dirFile new DatastoreFile file getDatastoreName file getDir HostDatastoreBrowserMO browserMo getHostDatastoreBrowserMO HostDatastoreBrowserSearchSpec searchSpec new HostDatastoreBrowserSearchSpec FileQueryFlags fqf new FileQueryFlags fqf setFileSize true fqf setFileOwner true fqf setFileType true fqf setModification true searchSpec setDetails fqf searchSpec setSearchCaseInsensitive false searchSpec getMatchPattern add file getFileName
HostDatastoreBrowserSearchSpec searchSpec new HostDatastoreBrowserSearchSpec FileQueryFlags fqf new FileQueryFlags fqf setFileSize true fqf setFileOwner true fqf setFileType true fqf setModification true searchSpec setDetails fqf searchSpec setSearchCaseInsensitive false searchSpec getMatchPattern add file getFileName s_logger debug file getFileName dirFile getPath HostDatastoreBrowserSearchResults result browserMo searchDatastore dirFile getPath searchSpec if result null List FileInfo info result getFile for FileInfo fi info if file getFileName equals fi getPath
public boolean folderExists String folderParentDatastorePath String folderName throws Exception HostDatastoreBrowserMO browserMo getHostDatastoreBrowserMO HostDatastoreBrowserSearchResults results browserMo searchDatastore folderParentDatastorePath folderName true if results null List FileInfo info results getFile if info null info size
public String searchFileInSubFolders String fileName boolean caseInsensitive String excludeFolders throws Exception String datastorePath getName String rootDirectoryFilePath String format datastorePath fileName String searchExcludedFolders getSearchExcludedFolders excludeFolders if fileExists rootDirectoryFilePath return rootDirectoryFilePath String parentFolderPath String absoluteFileName null s_logger info fileName datastorePath HostDatastoreBrowserMO browserMo getHostDatastoreBrowserMO ArrayList HostDatastoreBrowserSearchResults results browserMo searchDatastoreSubFolders getName fileName caseInsensitive if results null results size s_logger warn fileName datastorePath else if results null String msg fileName datastorePath
String parentFolderPath String absoluteFileName null s_logger info fileName datastorePath HostDatastoreBrowserMO browserMo getHostDatastoreBrowserMO ArrayList HostDatastoreBrowserSearchResults results browserMo searchDatastoreSubFolders getName fileName caseInsensitive if results null results size s_logger warn fileName datastorePath else if results null String msg fileName datastorePath s_logger error msg throw new CloudException msg for HostDatastoreBrowserSearchResults result results List FileInfo info result getFile if info null info size for FileInfo fi info
if dvPortGroupExists ManagedObjectReference task _context getService addDVPortgroupTask _mor dvPortGroupSpecArray if _context getVimClient waitForTask task throw new Exception dvPortGroupSpec getName else if s_dvPortGroupCacheMap containsKey dvSwitchInstance dvPortGroupList s_dvPortGroupCacheMap get dvSwitchInstance if dvPortGroupList null dvPortGroupList new ArrayList String dvPortGroupList add dvPortGroupName else dvPortGroupList new ArrayList String dvPortGroupList add dvPortGroupName s_dvPortGroupCacheMap put dvSwitchInstance dvPortGroupList if s_logger isTraceEnabled
if s_logger isTraceEnabled s_logger trace _mor getValue vmfsDatastore poolHostAddress poolHostPort poolPath poolUuid HostDatastoreSystemMO hostDatastoreSystemMo getHostDatastoreSystemMO ManagedObjectReference morDatastore hostDatastoreSystemMo findDatastore poolUuid if morDatastore null if vmfsDatastore try morDatastore hostDatastoreSystemMo createNfsDatastore poolHostAddress poolHostPort poolPath poolUuid catch AlreadyExistsFaultMsg e s_logger info _mor getValue vmfsDatastore poolHostAddress poolHostPort poolPath poolUuid return getExistingDataStoreOnHost vmfsDatastore poolHostAddress poolHostPort poolPath poolUuid hostDatastoreSystemMo catch Exception e s_logger info _mor getValue vmfsDatastore poolHostAddress poolHostPort poolPath poolUuid e getMessage throw new Exception if morDatastore null String msg poolHostAddress poolHostPort poolPath poolUuid
catch AlreadyExistsFaultMsg e s_logger info _mor getValue vmfsDatastore poolHostAddress poolHostPort poolPath poolUuid return getExistingDataStoreOnHost vmfsDatastore poolHostAddress poolHostPort poolPath poolUuid hostDatastoreSystemMo catch Exception e s_logger info _mor getValue vmfsDatastore poolHostAddress poolHostPort poolPath poolUuid e getMessage throw new Exception if morDatastore null String msg poolHostAddress poolHostPort poolPath poolUuid s_logger error msg if s_logger isTraceEnabled s_logger trace throw new Exception msg else morDatastore _context getDatastoreMorByPath poolPath if morDatastore null String msg poolHostAddress poolHostPort poolPath poolUuid
Override public void unmountDatastore String uuid throws Exception if s_logger isTraceEnabled s_logger trace _mor getValue uuid HostDatastoreSystemMO hostDatastoreSystemMo getHostDatastoreSystemMO if hostDatastoreSystemMo deleteDatastore uuid String msg uuid
public void createPortGroup HostVirtualSwitch vSwitch String portGroupName Integer vlanId HostNetworkSecurityPolicy secPolicy HostNetworkTrafficShapingPolicy shapingPolicy long timeOutMs throws Exception assert portGroupName null String hostPortGroup _mor getValue portGroupName synchronized hostPortGroup intern if hasPortGroup vSwitch portGroupName if s_logger isDebugEnabled
public static Map String String getValidatedVsmCredentials VmwareContext context throws Exception Map String String vsmCredentials context getStockObject String msg if vsmCredentials null vsmCredentials size msg
public static void createPortProfile VmwareContext context String ethPortProfileName String networkName Integer vlanId Integer networkRateMbps long peakBandwidth long burstSize String gateway boolean configureVServiceInNexus throws Exception Map String String vsmCredentials getValidatedVsmCredentials context String vsmIp vsmCredentials get String vsmUserName vsmCredentials get String vsmPassword vsmCredentials get String msg NetconfHelper netconfClient try
public static void createPortProfile VmwareContext context String ethPortProfileName String networkName Integer vlanId Integer networkRateMbps long peakBandwidth long burstSize String gateway boolean configureVServiceInNexus throws Exception Map String String vsmCredentials getValidatedVsmCredentials context String vsmIp vsmCredentials get String vsmUserName vsmCredentials get String vsmPassword vsmCredentials get String msg NetconfHelper netconfClient try s_logger info vsmIp netconfClient new NetconfHelper vsmIp vsmUserName vsmPassword
try s_logger info vsmIp netconfClient new NetconfHelper vsmIp vsmUserName vsmPassword s_logger info vsmIp catch CloudRuntimeException e msg vsmIp vsmUserName e toString s_logger error msg throw new CloudRuntimeException msg String policyName s_policyNamePrefix int averageBandwidth if networkRateMbps null averageBandwidth networkRateMbps intValue policyName averageBandwidth try if averageBandwidth
catch CloudRuntimeException e msg vsmIp vsmUserName e toString s_logger error msg throw new CloudRuntimeException msg String policyName s_policyNamePrefix int averageBandwidth if networkRateMbps null averageBandwidth networkRateMbps intValue policyName averageBandwidth try if averageBandwidth s_logger debug policyName netconfClient addPolicyMap policyName averageBandwidth int peakBandwidth int burstSize catch CloudRuntimeException e msg policyName averageBandwidth peakBandwidth burstSize e toString
averageBandwidth networkRateMbps intValue policyName averageBandwidth try if averageBandwidth s_logger debug policyName netconfClient addPolicyMap policyName averageBandwidth int peakBandwidth int burstSize catch CloudRuntimeException e msg policyName averageBandwidth peakBandwidth burstSize e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg List Pair OperationType String params new ArrayList Pair OperationType String if vlanId null
try if averageBandwidth s_logger debug policyName netconfClient addPolicyMap policyName averageBandwidth int peakBandwidth int burstSize catch CloudRuntimeException e msg policyName averageBandwidth peakBandwidth burstSize e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg List Pair OperationType String params new ArrayList Pair OperationType String if vlanId null params add new Pair OperationType String OperationType addvlanid vlanId toString try
s_logger debug policyName netconfClient addPolicyMap policyName averageBandwidth int peakBandwidth int burstSize catch CloudRuntimeException e msg policyName averageBandwidth peakBandwidth burstSize e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg List Pair OperationType String params new ArrayList Pair OperationType String if vlanId null params add new Pair OperationType String OperationType addvlanid vlanId toString try s_logger info ethPortProfileName vlanId netconfClient updatePortProfile ethPortProfileName SwitchPortMode trunk params
throw new CloudRuntimeException msg List Pair OperationType String params new ArrayList Pair OperationType String if vlanId null params add new Pair OperationType String OperationType addvlanid vlanId toString try s_logger info ethPortProfileName vlanId netconfClient updatePortProfile ethPortProfileName SwitchPortMode trunk params s_logger info vlanId ethPortProfileName catch CloudRuntimeException e msg ethPortProfileName vlanId e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg
s_logger info ethPortProfileName vlanId netconfClient updatePortProfile ethPortProfileName SwitchPortMode trunk params s_logger info vlanId ethPortProfileName catch CloudRuntimeException e msg ethPortProfileName vlanId e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg try if vlanId null s_logger info netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access else
s_logger info vlanId ethPortProfileName catch CloudRuntimeException e msg ethPortProfileName vlanId e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg try if vlanId null s_logger info netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access else if configureVServiceInNexus s_logger info vlanId toString
s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg try if vlanId null s_logger info netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access else if configureVServiceInNexus s_logger info vlanId toString netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access vlanId intValue else String tenant vlanId intValue
try if vlanId null s_logger info netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access else if configureVServiceInNexus s_logger info vlanId toString netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access vlanId intValue else String tenant vlanId intValue String vdc tenant tenant String esp tenant s_logger info vlanId toString netconfClient addVServiceNode vlanId toString gateway s_logger info vlanId toString
netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access else if configureVServiceInNexus s_logger info vlanId toString netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access vlanId intValue else String tenant vlanId intValue String vdc tenant tenant String esp tenant s_logger info vlanId toString netconfClient addVServiceNode vlanId toString gateway s_logger info vlanId toString netconfClient addPortProfile networkName PortProfileType vethernet BindingType portbindingstatic SwitchPortMode access vlanId intValue vdc esp catch CloudRuntimeException e msg networkName e toString
try netconfClient new NetconfHelper vsmIp vsmUserName vsmPassword catch CloudRuntimeException e msg vsmIp vsmUserName e toString s_logger error msg throw new CloudRuntimeException msg PortProfile portProfile netconfClient getPortProfileByName vethPortProfileName int averageBandwidth String policyName s_policyNamePrefix if networkRateMbps null averageBandwidth networkRateMbps intValue policyName averageBandwidth if averageBandwidth PolicyMap policyMap netconfClient getPolicyMapByName portProfile inputPolicyMap if policyMap committedRate averageBandwidth policyMap peakRate peakBandwidth policyMap burstRate burstRate
PortProfile portProfile netconfClient getPortProfileByName vethPortProfileName int averageBandwidth String policyName s_policyNamePrefix if networkRateMbps null averageBandwidth networkRateMbps intValue policyName averageBandwidth if averageBandwidth PolicyMap policyMap netconfClient getPolicyMapByName portProfile inputPolicyMap if policyMap committedRate averageBandwidth policyMap peakRate peakBandwidth policyMap burstRate burstRate s_logger debug vethPortProfileName if netconfClient null netconfClient disconnect s_logger debug return else
if policyMap committedRate averageBandwidth policyMap peakRate peakBandwidth policyMap burstRate burstRate s_logger debug vethPortProfileName if netconfClient null netconfClient disconnect s_logger debug return else try s_logger info policyName netconfClient addPolicyMap policyName averageBandwidth int peakBandwidth int burstRate catch CloudRuntimeException e msg policyName averageBandwidth peakBandwidth burstRate e toString s_logger error msg if netconfClient null netconfClient disconnect
s_logger debug return else try s_logger info policyName netconfClient addPolicyMap policyName averageBandwidth int peakBandwidth int burstRate catch CloudRuntimeException e msg policyName averageBandwidth peakBandwidth burstRate e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg try s_logger info policyName vethPortProfileName
catch CloudRuntimeException e msg policyName vethPortProfileName e toString s_logger error msg if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg if vlanId null s_logger info ethPortProfileName if netconfClient null netconfClient disconnect s_logger debug return String currentVlan portProfile vlan String newVlan Integer toString vlanId intValue
if netconfClient null netconfClient disconnect s_logger debug throw new CloudRuntimeException msg if vlanId null s_logger info ethPortProfileName if netconfClient null netconfClient disconnect s_logger debug return String currentVlan portProfile vlan String newVlan Integer toString vlanId intValue if currentVlan equalsIgnoreCase newVlan if netconfClient null netconfClient disconnect
if vlanId null StringUtils containsAny vlanId createGCTag true if secondaryvlanId null spvlanid Integer parseInt secondaryvlanId if vSwitchType VirtualSwitchType VMwareDistributedVirtualSwitch DVSTrafficShapingPolicy shapingPolicy DVSSecurityPolicy secPolicy vcApiVersion getVcenterApiVersion context minVcApiVersionSupportingAutoExpand autoExpandSupported isFeatureSupportedInVcenterApiVersion vcApiVersion minVcApiVersionSupportingAutoExpand dvSwitchName physicalNetwork if dvSwitchName null s_logger warn dvSwitchName morDvSwitch dataCenterMo getDvSwitchMor dvSwitchName
secPolicy createDVSSecurityPolicy details String pvlanType MapUtils isNotEmpty details details get NetworkOffering Detail pvlanType null if vid null spvlanid null setupPVlanPair dvSwitchMo morDvSwitch vid spvlanid pvlanType VMwareDVSPortgroupPolicy portGroupPolicy null createPortGroup physicalNetwork networkName vlanId vid spvlanid dataCenterMo shapingPolicy secPolicy portGroupPolicy dvSwitchMo numPorts autoExpandSupported bWaitPortGroupReady true else if vSwitchType VirtualSwitchType NexusDistributedVirtualSwitch ethPortProfileName physicalNetwork if ethPortProfileName null s_logger warn ethPortProfileName morEthernetPortProfile dataCenterMo getDvPortGroupMor ethPortProfileName if morEthernetPortProfile null String msg ethPortProfileName
VMwareDVSPortgroupPolicy portGroupPolicy null createPortGroup physicalNetwork networkName vlanId vid spvlanid dataCenterMo shapingPolicy secPolicy portGroupPolicy dvSwitchMo numPorts autoExpandSupported bWaitPortGroupReady true else if vSwitchType VirtualSwitchType NexusDistributedVirtualSwitch ethPortProfileName physicalNetwork if ethPortProfileName null s_logger warn ethPortProfileName morEthernetPortProfile dataCenterMo getDvPortGroupMor ethPortProfileName if morEthernetPortProfile null String msg ethPortProfileName s_logger error msg throw new Exception msg else s_logger info ethPortProfileName
else if vSwitchType VirtualSwitchType NexusDistributedVirtualSwitch ethPortProfileName physicalNetwork if ethPortProfileName null s_logger warn ethPortProfileName morEthernetPortProfile dataCenterMo getDvPortGroupMor ethPortProfileName if morEthernetPortProfile null String msg ethPortProfileName s_logger error msg throw new Exception msg else s_logger info ethPortProfileName long averageBandwidth 0L if networkRateMbps null networkRateMbps intValue averageBandwidth networkRateMbps intValue 1024L 1024L
private static void setupPVlanPair DistributedVirtualSwitchMO dvSwitchMo ManagedObjectReference morDvSwitch Integer vid Integer spvlanid String pvlanType throws Exception
private static void setupPVlanPair DistributedVirtualSwitchMO dvSwitchMo ManagedObjectReference morDvSwitch Integer vid Integer spvlanid String pvlanType throws Exception s_logger debug String format dvSwitchMo getName vid spvlanid pvlanType Map Integer HypervisorHostHelper PvlanType vlanmap dvSwitchMo retrieveVlanPvlan vid spvlanid morDvSwitch if vlanmap isEmpty if vlanmap containsKey vid vlanmap get vid equals HypervisorHostHelper PvlanType promiscuous String msg vid vlanmap get vid toString
s_logger error msg throw new Exception msg VMwareDVSConfigSpec dvsSpec new VMwareDVSConfigSpec if vlanmap containsKey vid VMwareDVSPvlanConfigSpec ppvlanConfigSpec createDVPortPvlanConfigSpec vid vid PvlanType promiscuous PvlanOperation add dvsSpec getPvlanConfigSpec add ppvlanConfigSpec if vid equals spvlanid vlanmap containsKey spvlanid PvlanType selectedType StringUtils isNotBlank pvlanType PvlanType fromStr pvlanType PvlanType isolated VMwareDVSPvlanConfigSpec spvlanConfigSpec createDVPortPvlanConfigSpec vid spvlanid selectedType PvlanOperation add dvsSpec getPvlanConfigSpec add spvlanConfigSpec if dvsSpec getPvlanConfigSpec size String dvsConfigVersion dvSwitchMo getDVSConfigVersion morDvSwitch dvsSpec setConfigVersion dvsConfigVersion try dvSwitchMo updateVMWareDVSwitchGetTask morDvSwitch dvsSpec
VMwareDVSConfigSpec dvsSpec new VMwareDVSConfigSpec if vlanmap containsKey vid VMwareDVSPvlanConfigSpec ppvlanConfigSpec createDVPortPvlanConfigSpec vid vid PvlanType promiscuous PvlanOperation add dvsSpec getPvlanConfigSpec add ppvlanConfigSpec if vid equals spvlanid vlanmap containsKey spvlanid PvlanType selectedType StringUtils isNotBlank pvlanType PvlanType fromStr pvlanType PvlanType isolated VMwareDVSPvlanConfigSpec spvlanConfigSpec createDVPortPvlanConfigSpec vid spvlanid selectedType PvlanOperation add dvsSpec getPvlanConfigSpec add spvlanConfigSpec if dvsSpec getPvlanConfigSpec size String dvsConfigVersion dvSwitchMo getDVSConfigVersion morDvSwitch dvsSpec setConfigVersion dvsConfigVersion try dvSwitchMo updateVMWareDVSwitchGetTask morDvSwitch dvsSpec catch AlreadyExistsFaultMsg e s_logger info vid spvlanid
private static void createPortGroup String physicalNetwork String networkName String vlanRange Integer vid Integer spvlanid DatacenterMO dataCenterMo DVSTrafficShapingPolicy shapingPolicy DVSSecurityPolicy secPolicy VMwareDVSPortgroupPolicy portGroupPolicy DistributedVirtualSwitchMO dvSwitchMo int numPorts boolean autoExpandSupported throws Exception VmwareDistributedVirtualSwitchVlanSpec vlanSpec null VmwareDistributedVirtualSwitchPvlanSpec pvlanSpec null VMwareDVSPortSetting dvsPortSetting null DVPortgroupConfigSpec newDvPortGroupSpec if vid null spvlanid null vlanSpec createDVPortVlanSpec vid vlanRange dvsPortSetting createVmwareDVPortSettingSpec shapingPolicy secPolicy vlanSpec else if spvlanid null pvlanSpec createDVPortPvlanIdSpec spvlanid dvsPortSetting createVmwareDVPortSettingSpec shapingPolicy secPolicy pvlanSpec newDvPortGroupSpec createDvPortGroupSpec networkName dvsPortSetting autoExpandSupported if portGroupPolicy null newDvPortGroupSpec setPolicy portGroupPolicy if dataCenterMo hasDvPortGroup networkName
else if spvlanid null pvlanSpec createDVPortPvlanIdSpec spvlanid dvsPortSetting createVmwareDVPortSettingSpec shapingPolicy secPolicy pvlanSpec newDvPortGroupSpec createDvPortGroupSpec networkName dvsPortSetting autoExpandSupported if portGroupPolicy null newDvPortGroupSpec setPolicy portGroupPolicy if dataCenterMo hasDvPortGroup networkName s_logger info networkName try newDvPortGroupSpec setNumPorts numPorts dvSwitchMo createDVPortGroup newDvPortGroupSpec catch Exception e String msg networkName physicalNetwork msg VmwareHelper getExceptionMessage e throw new Exception msg
newDvPortGroupSpec createDvPortGroupSpec networkName dvsPortSetting autoExpandSupported if portGroupPolicy null newDvPortGroupSpec setPolicy portGroupPolicy if dataCenterMo hasDvPortGroup networkName s_logger info networkName try newDvPortGroupSpec setNumPorts numPorts dvSwitchMo createDVPortGroup newDvPortGroupSpec catch Exception e String msg networkName physicalNetwork msg VmwareHelper getExceptionMessage e throw new Exception msg else s_logger info networkName DVPortgroupConfigInfo currentDvPortgroupInfo dataCenterMo getDvPortGroupSpec networkName
public static boolean isSpecMatch DVPortgroupConfigInfo currentDvPortgroupInfo DVPortgroupConfigSpec newDvPortGroupSpec String dvPortGroupName newDvPortGroupSpec getName
DVSTrafficShapingPolicy newTrafficShapingPolicyInbound newDvPortGroupSpec getDefaultPortConfig getInShapingPolicy LongPolicy newAverageBandwidthPolicy newTrafficShapingPolicyInbound getAverageBandwidth LongPolicy newBurstSizePolicy newTrafficShapingPolicyInbound getBurstSize LongPolicy newPeakBandwidthPolicy newTrafficShapingPolicyInbound getPeakBandwidth BoolPolicy newIsEnabledPolicy newTrafficShapingPolicyInbound getEnabled Long newAverageBandwidth null Long newBurstSize null Long newPeakBandwidth null Boolean newIsEnabled null if newAverageBandwidthPolicy null newAverageBandwidth newAverageBandwidthPolicy getValue if newBurstSizePolicy null newBurstSize newBurstSizePolicy getValue if newPeakBandwidthPolicy null newPeakBandwidth newPeakBandwidthPolicy getValue
VMwareDVSPortSetting currentPortSetting VMwareDVSPortSetting currentDvPortgroupInfo getDefaultPortConfig VMwareDVSPortSetting newPortSetting VMwareDVSPortSetting newDvPortGroupSpec getDefaultPortConfig if currentPortSetting getSecurityPolicy null newPortSetting getSecurityPolicy null currentPortSetting getSecurityPolicy null newPortSetting getSecurityPolicy null specMatches false if currentPortSetting getSecurityPolicy null newPortSetting getSecurityPolicy null if currentPortSetting getSecurityPolicy getAllowPromiscuous null newPortSetting getSecurityPolicy getAllowPromiscuous null newPortSetting getSecurityPolicy getAllowPromiscuous isValue null newPortSetting getSecurityPolicy getAllowPromiscuous isValue equals currentPortSetting getSecurityPolicy getAllowPromiscuous isValue specMatches false if currentPortSetting getSecurityPolicy getForgedTransmits null newPortSetting getSecurityPolicy getForgedTransmits null newPortSetting getSecurityPolicy getForgedTransmits isValue null newPortSetting getSecurityPolicy getForgedTransmits isValue equals currentPortSetting getSecurityPolicy getForgedTransmits isValue specMatches false if currentPortSetting getSecurityPolicy getMacChanges null newPortSetting getSecurityPolicy getMacChanges null newPortSetting getSecurityPolicy getMacChanges isValue null newPortSetting getSecurityPolicy getMacChanges isValue equals currentPortSetting getSecurityPolicy getMacChanges isValue specMatches false VmwareDistributedVirtualSwitchVlanSpec oldVlanSpec currentPortSetting getVlan VmwareDistributedVirtualSwitchVlanSpec newVlanSpec newPortSetting getVlan int oldVlanId newVlanId if oldVlanSpec VmwareDistributedVirtualSwitchPvlanSpec newVlanSpec VmwareDistributedVirtualSwitchPvlanSpec
VMwareDVSPortSetting newPortSetting VMwareDVSPortSetting newDvPortGroupSpec getDefaultPortConfig if currentPortSetting getSecurityPolicy null newPortSetting getSecurityPolicy null currentPortSetting getSecurityPolicy null newPortSetting getSecurityPolicy null specMatches false if currentPortSetting getSecurityPolicy null newPortSetting getSecurityPolicy null if currentPortSetting getSecurityPolicy getAllowPromiscuous null newPortSetting getSecurityPolicy getAllowPromiscuous null newPortSetting getSecurityPolicy getAllowPromiscuous isValue null newPortSetting getSecurityPolicy getAllowPromiscuous isValue equals currentPortSetting getSecurityPolicy getAllowPromiscuous isValue specMatches false if currentPortSetting getSecurityPolicy getForgedTransmits null newPortSetting getSecurityPolicy getForgedTransmits null newPortSetting getSecurityPolicy getForgedTransmits isValue null newPortSetting getSecurityPolicy getForgedTransmits isValue equals currentPortSetting getSecurityPolicy getForgedTransmits isValue specMatches false if currentPortSetting getSecurityPolicy getMacChanges null newPortSetting getSecurityPolicy getMacChanges null newPortSetting getSecurityPolicy getMacChanges isValue null newPortSetting getSecurityPolicy getMacChanges isValue equals currentPortSetting getSecurityPolicy getMacChanges isValue specMatches false VmwareDistributedVirtualSwitchVlanSpec oldVlanSpec currentPortSetting getVlan VmwareDistributedVirtualSwitchVlanSpec newVlanSpec newPortSetting getVlan int oldVlanId newVlanId if oldVlanSpec VmwareDistributedVirtualSwitchPvlanSpec newVlanSpec VmwareDistributedVirtualSwitchPvlanSpec VmwareDistributedVirtualSwitchPvlanSpec oldpVlanSpec VmwareDistributedVirtualSwitchPvlanSpec oldVlanSpec
public static VmwareDistributedVirtualSwitchVlanSpec createDVPortVlanSpec Integer vlanId String vlanRange if vlanId null vlanRange null vlanRange isEmpty
final NumericRange numericRange new NumericRange if vlanRangePart contains final String range vlanRangePart split if range length range null range null numericRange setStart NumbersUtil parseInt range numericRange setEnd NumbersUtil parseInt range else continue else numericRange setStart NumbersUtil parseInt vlanRangePart numericRange setEnd NumbersUtil parseInt vlanRangePart trunkVlanSpec getVlanId add numericRange if trunkVlanSpec getVlanId size return trunkVlanSpec VmwareDistributedVirtualSwitchVlanIdSpec vlanIdSpec new VmwareDistributedVirtualSwitchVlanIdSpec
String msg networkName s_logger error msg throw new Exception msg if createGCTag NetworkMO networkMo new NetworkMO hostMo getContext morNetwork networkMo setCustomFieldValue CustomFieldConstants CLOUD_GC if syncPeerHosts ManagedObjectReference morParent hostMo getParentMor if morParent null morParent getType equals GlobalLock lock GlobalLock getInternLock morParent getValue try if lock lock DEFAULT_LOCK_TIMEOUT_SECONDS try List ManagedObjectReference hosts hostMo getContext getVimClient getDynamicProperty morParent if hosts null
protected static void setVMHardwareVersion VirtualMachineConfigSpec vmConfig ClusterMO clusterMO DatacenterMO datacenterMO throws Exception ClusterConfigInfoEx clusterConfigInfo clusterMO null clusterMO getClusterConfigInfo null String clusterHardwareVersion clusterConfigInfo null clusterConfigInfo getDefaultHardwareVersionKey null if StringUtils isNotBlank clusterHardwareVersion
public static String resolveHostNameInUrl DatacenterMO dcMo String url
if NetUtils isValidIp4 host s_logger info url return url try ManagedObjectReference morHost dcMo findHost host if morHost null HostMO hostMo new HostMO dcMo getContext morHost String managementPortGroupName if hostMo getHostType VmwareHostType ESXi managementPortGroupName String dcMo getContext getStockObject else managementPortGroupName String dcMo getContext getStockObject VmwareHypervisorHostNetworkSummary summary hostMo getHyperHostNetworkSummary managementPortGroupName if summary null s_logger warn url return url String hostIp summary getHostIp
public static void importVmFromOVF VmwareHypervisorHost host String ovfFilePath String vmName DatastoreMO dsMo String diskOption ManagedObjectReference morRp ManagedObjectReference morHost throws Exception assert morRp null OvfCreateImportSpecParams importSpecParams new OvfCreateImportSpecParams importSpecParams setHostSystem morHost importSpecParams setLocale importSpecParams setEntityName vmName importSpecParams setDeploymentOption importSpecParams setDiskProvisioning diskOption String ovfDescriptor removeOVFNetwork HttpNfcLeaseMO readOvfContent ovfFilePath VmwareContext context host getContext OvfCreateImportSpecResult ovfImportResult context getService createImportSpec context getServiceContent getOvfManager ovfDescriptor morRp dsMo getMor importSpecParams if ovfImportResult null String msg ovfFilePath vmName diskOption
OvfCreateImportSpecParams importSpecParams new OvfCreateImportSpecParams importSpecParams setHostSystem morHost importSpecParams setLocale importSpecParams setEntityName vmName importSpecParams setDeploymentOption importSpecParams setDiskProvisioning diskOption String ovfDescriptor removeOVFNetwork HttpNfcLeaseMO readOvfContent ovfFilePath VmwareContext context host getContext OvfCreateImportSpecResult ovfImportResult context getService createImportSpec context getServiceContent getOvfManager ovfDescriptor morRp dsMo getMor importSpecParams if ovfImportResult null String msg ovfFilePath vmName diskOption s_logger error msg throw new Exception msg if ovfImportResult getError isEmpty for LocalizedMethodFault fault ovfImportResult getError
if ovfImportResult null String msg ovfFilePath vmName diskOption s_logger error msg throw new Exception msg if ovfImportResult getError isEmpty for LocalizedMethodFault fault ovfImportResult getError s_logger error fault getLocalizedMessage throw new CloudException ovfFilePath if ovfImportResult getWarning isEmpty for LocalizedMethodFault fault ovfImportResult getError s_logger warn fault getLocalizedMessage DatacenterMO dcMo new DatacenterMO context host getHyperHostDatacenter ManagedObjectReference morLease context getService importVApp morRp ovfImportResult getImportSpec dcMo getVmFolder morHost if morLease null String msg ovfFilePath vmName diskOption
progressReporter reportProgress int param totalBytes bytesAlreadyWritten ovfFileItem getSize catch Exception e String erroMsg e getMessage s_logger error erroMsg importSuccess false throw new Exception erroMsg e catch Throwable th String errorMsg th getMessage s_logger error errorMsg importSuccess false throw new Exception errorMsg th finally progressReporter close
List String files new ArrayList String ManagedObjectReference morRp host getHyperHostOwnerResourcePool assert morRp null ManagedObjectReference morHost host getMor String importEntityName UUID randomUUID toString OvfCreateImportSpecParams importSpecParams new OvfCreateImportSpecParams importSpecParams setHostSystem morHost importSpecParams setLocale importSpecParams setEntityName importEntityName importSpecParams setDeploymentOption String ovfDescriptor removeOVFNetwork HttpNfcLeaseMO readOvfContent ovfFilePath VmwareContext context host getContext OvfCreateImportSpecResult ovfImportResult context getService createImportSpec context getServiceContent getOvfManager ovfDescriptor morRp dsMo getMor importSpecParams if ovfImportResult null String msg ovfFilePath
String importEntityName UUID randomUUID toString OvfCreateImportSpecParams importSpecParams new OvfCreateImportSpecParams importSpecParams setHostSystem morHost importSpecParams setLocale importSpecParams setEntityName importEntityName importSpecParams setDeploymentOption String ovfDescriptor removeOVFNetwork HttpNfcLeaseMO readOvfContent ovfFilePath VmwareContext context host getContext OvfCreateImportSpecResult ovfImportResult context getService createImportSpec context getServiceContent getOvfManager ovfDescriptor morRp dsMo getMor importSpecParams if ovfImportResult null String msg ovfFilePath s_logger error msg throw new Exception msg if ovfImportResult getError isEmpty for LocalizedMethodFault fault ovfImportResult getError
OvfCreateImportSpecResult ovfImportResult context getService createImportSpec context getServiceContent getOvfManager ovfDescriptor morRp dsMo getMor importSpecParams if ovfImportResult null String msg ovfFilePath s_logger error msg throw new Exception msg if ovfImportResult getError isEmpty for LocalizedMethodFault fault ovfImportResult getError s_logger error fault getLocalizedMessage throw new CloudException ovfFilePath if ovfImportResult getWarning isEmpty for LocalizedMethodFault fault ovfImportResult getError s_logger warn fault getLocalizedMessage VirtualMachineImportSpec importSpec VirtualMachineImportSpec ovfImportResult getImportSpec if importSpec null String msg ovfFilePath
public void parse byte vmsdFileContent throws IOException BufferedReader in null try in new BufferedReader new InputStreamReader new ByteArrayInputStream vmsdFileContent String line while line in readLine null
key String format i value _properties getProperty key out write String format key value out newLine int numDisks Integer parseInt value for int j j numDisks j key String format i j value _properties getProperty key out write String format key value out newLine key String format i j value _properties getProperty key out write String format key value out newLine catch IOException e
public boolean powerOn throws Exception if getResetSafePowerState VirtualMachinePowerState POWERED_ON return true ManagedObjectReference morTask _context getService powerOnVMTask _mor null final Boolean flags false final VirtualMachineMO vmMo this Future future MonitorServiceExecutor submit new Runnable Override public void run s_logger info while flags try VirtualMachineRuntimeInfo runtimeInfo vmMo getRuntimeInfo VirtualMachineQuestionInfo question runtimeInfo getQuestion if question null
public boolean powerOn throws Exception if getResetSafePowerState VirtualMachinePowerState POWERED_ON return true ManagedObjectReference morTask _context getService powerOnVMTask _mor null final Boolean flags false final VirtualMachineMO vmMo this Future future MonitorServiceExecutor submit new Runnable Override public void run s_logger info while flags try VirtualMachineRuntimeInfo runtimeInfo vmMo getRuntimeInfo VirtualMachineQuestionInfo question runtimeInfo getQuestion if question null s_logger info question getId
final Boolean flags false final VirtualMachineMO vmMo this Future future MonitorServiceExecutor submit new Runnable Override public void run s_logger info while flags try VirtualMachineRuntimeInfo runtimeInfo vmMo getRuntimeInfo VirtualMachineQuestionInfo question runtimeInfo getQuestion if question null s_logger info question getId s_logger info question getText if question getMessage null for VirtualMachineMessage msg question getMessage if s_logger isInfoEnabled
final VirtualMachineMO vmMo this Future future MonitorServiceExecutor submit new Runnable Override public void run s_logger info while flags try VirtualMachineRuntimeInfo runtimeInfo vmMo getRuntimeInfo VirtualMachineQuestionInfo question runtimeInfo getQuestion if question null s_logger info question getId s_logger info question getText if question getMessage null for VirtualMachineMessage msg question getMessage if s_logger isInfoEnabled s_logger info msg getId
Override public void run s_logger info while flags try VirtualMachineRuntimeInfo runtimeInfo vmMo getRuntimeInfo VirtualMachineQuestionInfo question runtimeInfo getQuestion if question null s_logger info question getId s_logger info question getText if question getMessage null for VirtualMachineMessage msg question getMessage if s_logger isInfoEnabled s_logger info msg getId s_logger info msg getText if equalsIgnoreCase msg getId
if s_logger isInfoEnabled s_logger info msg getId s_logger info msg getText if equalsIgnoreCase msg getId s_logger info msg getId vmMo answerVM question getId break if s_logger isTraceEnabled s_logger trace ChoiceOption choice question getChoice if choice null for ElementDescription info choice getChoiceInfo if s_logger isTraceEnabled s_logger trace info getKey s_logger trace info getLabel catch Throwable e
if choice null for ElementDescription info choice getChoiceInfo if s_logger isTraceEnabled s_logger trace info getKey s_logger trace info getLabel catch Throwable e s_logger error e try Thread sleep catch InterruptedException e s_logger debug s_logger info try boolean result _context getVimClient waitForTask morTask
public boolean safePowerOff int shutdownWaitMs throws Exception if getResetSafePowerState VirtualMachinePowerState POWERED_OFF return true if isVMwareToolsRunning try String vmName getName
ManagedObjectReference morTask _context getService createSnapshotTask _mor snapshotName snapshotDescription dumpMemory quiesce boolean result _context getVimClient waitForTask morTask if result _context waitForTaskProgressDone morTask ManagedObjectReference morSnapshot null long startTick System currentTimeMillis while System currentTimeMillis startTick apiTimeout morSnapshot getSnapshotMor snapshotName if morSnapshot null break try Thread sleep catch InterruptedException e s_logger debug if morSnapshot null
public String getSnapshotDiskFileDatastorePath VirtualMachineFileInfo vmFileInfo List Pair ManagedObjectReference String datastoreMounts String snapshotDiskFile throws Exception if snapshotDiskFile startsWith for Pair ManagedObjectReference String mount datastoreMounts if snapshotDiskFile startsWith mount second DatastoreMO dsMo new DatastoreMO _context mount first String dsFullPath String format dsMo getName snapshotDiskFile substring mount second length
rSpec setDiskMoveType VirtualMachineRelocateDiskMoveOptions CREATE_NEW_CHILD_DISK_BACKING value rSpec getDisk addAll diskLocator else rSpec setDiskMoveType VirtualMachineRelocateDiskMoveOptions CREATE_NEW_CHILD_DISK_BACKING value rSpec setPool morResourcePool VirtualMachineCloneSpec cloneSpec new VirtualMachineCloneSpec cloneSpec setPowerOn false cloneSpec setTemplate false cloneSpec setLocation rSpec cloneSpec setSnapshot morBaseSnapshot ManagedObjectReference morTask _context getService cloneVMTask _mor morFolder cloneName cloneSpec boolean result _context getVimClient waitForTask morTask if result _context waitForTaskProgressDone morTask return true
public List NetworkDetails getNetworksWithDetails throws Exception List NetworkDetails networks new ArrayList NetworkDetails int gcTagKey getCustomFieldKey CustomFieldConstants CLOUD_GC if gcTagKey gcTagKey getCustomFieldKey CustomFieldConstants CLOUD_GC_DVP
pfSpecArr add pfSpec List ObjectContent ocs _context getService retrieveProperties _context getPropertyCollector pfSpecArr if ocs null ocs size for ObjectContent oc ocs ArrayOfManagedObjectReference morVms null String gcTagValue null String name null for DynamicProperty prop oc getPropSet if prop getName equals name prop getVal toString else if prop getName equals morVms ArrayOfManagedObjectReference prop getVal else if prop getName startsWith CustomFieldStringValue val CustomFieldStringValue prop getVal if val null gcTagValue val getValue NetworkDetails details new NetworkDetails name oc getObj morVms null morVms getManagedObjectReference toArray new ManagedObjectReference morVms getManagedObjectReference size null gcTagValue networks add details
VirtualDeviceConfigSpec deviceConfigSpecArray new VirtualDeviceConfigSpec devices length int i for Ternary VirtualDevice VirtualDeviceConfigSpecOperation VirtualDeviceConfigSpecFileOperation deviceTernary devices VirtualDeviceConfigSpec deviceConfigSpec new VirtualDeviceConfigSpec deviceConfigSpec setDevice deviceTernary first deviceConfigSpec setOperation deviceTernary second deviceConfigSpec setFileOperation deviceTernary third deviceConfigSpecArray i deviceConfigSpec configSpec getDeviceChange addAll Arrays asList deviceConfigSpecArray ManagedObjectReference morTask _context getService reconfigVMTask _mor configSpec boolean result _context getVimClient waitForTask morTask if result _context waitForTaskProgressDone morTask return true else
public void updateVmdkAdapter String vmdkFileName String newAdapterType throws Exception Pair VmdkFileDescriptor byte vmdkInfo getVmdkFileInfo vmdkFileName VmdkFileDescriptor vmdkFileDescriptor vmdkInfo first boolean isVmfsSparseFile vmdkFileDescriptor isVmfsSparseFile if isVmfsSparseFile String currentAdapterType vmdkFileDescriptor getAdapterType if currentAdapterType equalsIgnoreCase newAdapterType
public void updateVmdkAdapter String vmdkFileName String newAdapterType throws Exception Pair VmdkFileDescriptor byte vmdkInfo getVmdkFileInfo vmdkFileName VmdkFileDescriptor vmdkFileDescriptor vmdkInfo first boolean isVmfsSparseFile vmdkFileDescriptor isVmfsSparseFile if isVmfsSparseFile String currentAdapterType vmdkFileDescriptor getAdapterType if currentAdapterType equalsIgnoreCase newAdapterType s_logger info newAdapterType vmdkFileName Pair DatacenterMO String dcInfo getOwnerDatacenter byte newVmdkContent vmdkFileDescriptor changeVmdkAdapterType vmdkInfo second newAdapterType String vmdkUploadUrl getContext composeDatastoreBrowseUrl dcInfo first getName vmdkFileName getContext uploadResourceContent vmdkUploadUrl newVmdkContent
Pair VmdkFileDescriptor byte vmdkInfo getVmdkFileInfo vmdkFileName VmdkFileDescriptor vmdkFileDescriptor vmdkInfo first boolean isVmfsSparseFile vmdkFileDescriptor isVmfsSparseFile if isVmfsSparseFile String currentAdapterTypeStr vmdkFileDescriptor getAdapterType if s_logger isTraceEnabled s_logger trace currentAdapterTypeStr vmdkFileName VmdkAdapterType currentAdapterType VmdkAdapterType getType currentAdapterTypeStr if currentAdapterType VmdkAdapterType none VmdkAdapterType newAdapterType VmdkAdapterType lsilogic s_logger debug newAdapterType currentAdapterTypeStr vmdkFileName Pair DatacenterMO String dcInfo getOwnerDatacenter byte newVmdkContent vmdkFileDescriptor changeVmdkAdapterType vmdkInfo second newAdapterType toString String vmdkUploadUrl getContext composeDatastoreBrowseUrl dcInfo first getName vmdkFileName getContext uploadResourceContent vmdkUploadUrl newVmdkContent
Override public void run s_logger info while flags try VirtualMachineRuntimeInfo runtimeInfo vmMo getRuntimeInfo VirtualMachineQuestionInfo question runtimeInfo getQuestion if question null if s_logger isTraceEnabled s_logger trace question getId s_logger trace question getText if question getMessage null for VirtualMachineMessage msg question getMessage if s_logger isTraceEnabled s_logger trace msg getId s_logger trace msg getText
s_logger trace question getId s_logger trace question getText if question getMessage null for VirtualMachineMessage msg question getMessage if s_logger isTraceEnabled s_logger trace msg getId s_logger trace msg getText if equalsIgnoreCase msg getId s_logger info msg getId vmMo answerVM question getId force ANSWER_YES ANSWER_NO break else if question getText null String text question getText String msgId String msgText
if s_logger isTraceEnabled s_logger trace msg getId s_logger trace msg getText if equalsIgnoreCase msg getId s_logger info msg getId vmMo answerVM question getId force ANSWER_YES ANSWER_NO break else if question getText null String text question getText String msgId String msgText if s_logger isDebugEnabled s_logger debug text String tokens text split msgId tokens
public void exportVm String exportDir String exportName boolean packToOva boolean leaveOvaFileOnly throws Exception ManagedObjectReference morOvf _context getServiceContent getOvfManager VirtualMachineRuntimeInfo runtimeInfo getRuntimeInfo HostMO hostMo new HostMO _context runtimeInfo getHost String hostName hostMo getHostName String vmName getVmName DatacenterMO dcMo new DatacenterMO _context hostMo getHyperHostDatacenter if runtimeInfo getPowerState VirtualMachinePowerState POWERED_OFF String msg vmName hostName
HttpNfcLeaseInfo leaseInfo leaseMo getLeaseInfo final long totalBytes leaseInfo getTotalDiskCapacityInKB long totalBytesDownloaded List HttpNfcLeaseDeviceUrl deviceUrls leaseInfo getDeviceUrl s_logger info System currentTimeMillis if deviceUrls null OvfFile ovfFiles new OvfFile deviceUrls size for int i i deviceUrls size i String deviceId deviceUrls get i getKey String deviceUrlStr deviceUrls get i getUrl String orgDiskFileName deviceUrlStr substring deviceUrlStr lastIndexOf String diskFileName String format exportName i VmwareHelper getFileExtension orgDiskFileName String diskUrlStr deviceUrlStr replace hostName diskUrlStr HypervisorHostHelper resolveHostNameInUrl dcMo diskUrlStr String diskLocalPath exportDir File separator diskFileName
ovfFile setSize lengthOfDiskFile ovfFiles i ovfFile OvfCreateDescriptorParams ovfDescParams new OvfCreateDescriptorParams ovfDescParams getOvfFiles addAll Arrays asList ovfFiles OvfCreateDescriptorResult ovfCreateDescriptorResult _context getService createDescriptor morOvf getMor ovfDescParams String ovfPath exportDir File separator exportName fileNames add ovfPath OutputStreamWriter out new OutputStreamWriter new FileOutputStream ovfPath out write ovfCreateDescriptorResult getOvfDescriptor out close if packToOva s_logger info Script commandSync new Script true s_logger commandSync execute Script command new Script false s_logger
ovfDescParams getOvfFiles addAll Arrays asList ovfFiles OvfCreateDescriptorResult ovfCreateDescriptorResult _context getService createDescriptor morOvf getMor ovfDescParams String ovfPath exportDir File separator exportName fileNames add ovfPath OutputStreamWriter out new OutputStreamWriter new FileOutputStream ovfPath out write ovfCreateDescriptorResult getOvfDescriptor out close if packToOva s_logger info Script commandSync new Script true s_logger commandSync execute Script command new Script false s_logger command setWorkDir exportDir command add exportName command add exportName
String destBaseFileName String destFileName String destParentFileName for SnapshotDescriptor DiskInfo disk disks if deviceName null deviceName equals disk getDeviceName String srcVmdkFullDsPath getSnapshotDiskFileDatastorePath vmFileInfo mounts disk getDiskFileName Pair DatastoreMO String srcDsInfo getOwnerDatastore srcVmdkFullDsPath Pair VmdkFileDescriptor byte vmdkInfo getVmdkFileInfo srcVmdkFullDsPath String srcVmdkBaseFilePath DatastoreFile getCompanionDatastorePath srcVmdkFullDsPath vmdkInfo first getBaseFileName destFileName destName snapshotInfo length i if vmdkInfo first getParentFileName null destBaseFileName destName snapshotInfo length i destParentFileName destName snapshotInfo length i else destBaseFileName destName snapshotInfo length i
for SnapshotDescriptor DiskInfo disk disks if deviceName null deviceName equals disk getDeviceName String srcVmdkFullDsPath getSnapshotDiskFileDatastorePath vmFileInfo mounts disk getDiskFileName Pair DatastoreMO String srcDsInfo getOwnerDatastore srcVmdkFullDsPath Pair VmdkFileDescriptor byte vmdkInfo getVmdkFileInfo srcVmdkFullDsPath String srcVmdkBaseFilePath DatastoreFile getCompanionDatastorePath srcVmdkFullDsPath vmdkInfo first getBaseFileName destFileName destName snapshotInfo length i if vmdkInfo first getParentFileName null destBaseFileName destName snapshotInfo length i destParentFileName destName snapshotInfo length i else destBaseFileName destName snapshotInfo length i destParentFileName null s_logger info srcVmdkBaseFilePath destDsDirectory destBaseFileName srcDsInfo first copyDatastoreFile srcVmdkBaseFilePath dcMo getMor morDestDs destDsDirectory destBaseFileName dcMo getMor true
public void copyAllVmDiskFiles DatastoreMO destDsMo String destDsDir boolean followDiskChain throws Exception VirtualDevice disks getAllDiskDevice DatacenterMO dcMo getOwnerDatacenter first if disks null for VirtualDevice disk disks List Pair String ManagedObjectReference vmdkFiles getDiskDatastorePathChain VirtualDisk disk followDiskChain for Pair String ManagedObjectReference fileItem vmdkFiles DatastoreMO srcDsMo new DatastoreMO _context fileItem second DatastoreFile srcFile new DatastoreFile fileItem first DatastoreFile destFile new DatastoreFile destDsMo getName destDsDir srcFile getFileName Pair VmdkFileDescriptor byte vmdkDescriptor null vmdkDescriptor getVmdkFileInfo fileItem first
if disks null for VirtualDevice disk disks List Pair String ManagedObjectReference vmdkFiles getDiskDatastorePathChain VirtualDisk disk followDiskChain for Pair String ManagedObjectReference fileItem vmdkFiles DatastoreMO srcDsMo new DatastoreMO _context fileItem second DatastoreFile srcFile new DatastoreFile fileItem first DatastoreFile destFile new DatastoreFile destDsMo getName destDsDir srcFile getFileName Pair VmdkFileDescriptor byte vmdkDescriptor null vmdkDescriptor getVmdkFileInfo fileItem first s_logger info srcFile getPath destFile getPath srcDsMo copyDatastoreFile fileItem first dcMo getMor destDsMo getMor destFile getPath dcMo getMor true if vmdkDescriptor null String vmdkBaseFileName vmdkDescriptor first getBaseFileName String baseFilePath srcFile getCompanionPath vmdkBaseFileName destFile new DatastoreFile destDsMo getName destDsDir vmdkBaseFileName
Deprecated public void moveAllVmDiskFiles DatastoreMO destDsMo String destDsDir boolean followDiskChain throws Exception VirtualDevice disks getAllDiskDevice DatacenterMO dcMo getOwnerDatacenter first if disks null for VirtualDevice disk disks List Pair String ManagedObjectReference vmdkFiles getDiskDatastorePathChain VirtualDisk disk followDiskChain for Pair String ManagedObjectReference fileItem vmdkFiles DatastoreMO srcDsMo new DatastoreMO _context fileItem second DatastoreFile srcFile new DatastoreFile fileItem first DatastoreFile destFile new DatastoreFile destDsMo getName destDsDir srcFile getFileName Pair VmdkFileDescriptor byte vmdkDescriptor null vmdkDescriptor getVmdkFileInfo fileItem first
if disks null for VirtualDevice disk disks List Pair String ManagedObjectReference vmdkFiles getDiskDatastorePathChain VirtualDisk disk followDiskChain for Pair String ManagedObjectReference fileItem vmdkFiles DatastoreMO srcDsMo new DatastoreMO _context fileItem second DatastoreFile srcFile new DatastoreFile fileItem first DatastoreFile destFile new DatastoreFile destDsMo getName destDsDir srcFile getFileName Pair VmdkFileDescriptor byte vmdkDescriptor null vmdkDescriptor getVmdkFileInfo fileItem first s_logger info srcFile getPath destFile getPath srcDsMo moveDatastoreFile fileItem first dcMo getMor destDsMo getMor destFile getPath dcMo getMor true if vmdkDescriptor null String vmdkBaseFileName vmdkDescriptor first getBaseFileName String baseFilePath srcFile getCompanionPath vmdkBaseFileName destFile new DatastoreFile destDsMo getName destDsDir vmdkBaseFileName
VirtualMachineConfigSpec vmConfig new VirtualMachineConfigSpec int busNum availableBusNum while busNum requiredNumScsiControllers ParaVirtualSCSIController scsiController new ParaVirtualSCSIController scsiController setSharedBus VirtualSCSISharing NO_SHARING scsiController setBusNumber busNum scsiController setKey busNum VmwareHelper MAX_SCSI_CONTROLLER_COUNT VirtualDeviceConfigSpec scsiControllerSpec new VirtualDeviceConfigSpec scsiControllerSpec setDevice scsiController scsiControllerSpec setOperation VirtualDeviceConfigSpecOperation ADD vmConfig getDeviceChange add scsiControllerSpec busNum if configureVm vmConfig throw new Exception getName else
public boolean isPvScsiSupported throws Exception int virtualHardwareVersion virtualHardwareVersion getVirtualHardwareVersion if virtualHardwareVersion
VirtualMachineConfigSpec vmConfig new VirtualMachineConfigSpec int busNum availableBusNum while busNum count VirtualLsiLogicController scsiController new VirtualLsiLogicController scsiController setSharedBus VirtualSCSISharing NO_SHARING scsiController setBusNumber busNum scsiController setKey busNum VmwareHelper MAX_SCSI_CONTROLLER_COUNT VirtualDeviceConfigSpec scsiControllerSpec new VirtualDeviceConfigSpec scsiControllerSpec setDevice scsiController scsiControllerSpec setOperation VirtualDeviceConfigSpecOperation ADD vmConfig getDeviceChange add scsiControllerSpec busNum if configureVm vmConfig throw new Exception getName else
VirtualMachineConfigSpec vmConfig new VirtualMachineConfigSpec int busNum availableBusNum while busNum count VirtualLsiLogicController scsiController new VirtualLsiLogicController scsiController setSharedBus VirtualSCSISharing NO_SHARING scsiController setBusNumber busNum scsiController setKey busNum VmwareHelper MAX_SCSI_CONTROLLER_COUNT VirtualDeviceConfigSpec scsiControllerSpec new VirtualDeviceConfigSpec scsiControllerSpec setDevice scsiController scsiControllerSpec setOperation VirtualDeviceConfigSpecOperation ADD vmConfig getDeviceChange add scsiControllerSpec busNum if configureVm vmConfig throw new Exception getName else
public Pair VirtualDisk String getDiskDevice String vmdkDatastorePath throws Exception final String zeroLengthString List VirtualDevice devices _context getVimClient getDynamicProperty _mor ArrayList Pair VirtualDisk String partialMatchingDiskDevices new ArrayList DatastoreFile dsSrcFile new DatastoreFile vmdkDatastorePath String srcBaseName dsSrcFile getFileBaseName String trimmedSrcBaseName VmwareHelper trimSnapshotDeltaPostfix srcBaseName String srcDatastoreName dsSrcFile getDatastoreName null dsSrcFile getDatastoreName zeroLengthString
public Pair VirtualDisk String getDiskDevice String vmdkDatastorePath throws Exception final String zeroLengthString List VirtualDevice devices _context getVimClient getDynamicProperty _mor ArrayList Pair VirtualDisk String partialMatchingDiskDevices new ArrayList DatastoreFile dsSrcFile new DatastoreFile vmdkDatastorePath String srcBaseName dsSrcFile getFileBaseName String trimmedSrcBaseName VmwareHelper trimSnapshotDeltaPostfix srcBaseName String srcDatastoreName dsSrcFile getDatastoreName null dsSrcFile getDatastoreName zeroLengthString s_logger info vmdkDatastorePath srcBaseName if devices null devices size for VirtualDevice device devices if device VirtualDisk
List VirtualDevice devices _context getVimClient getDynamicProperty _mor ArrayList Pair VirtualDisk String partialMatchingDiskDevices new ArrayList DatastoreFile dsSrcFile new DatastoreFile vmdkDatastorePath String srcBaseName dsSrcFile getFileBaseName String trimmedSrcBaseName VmwareHelper trimSnapshotDeltaPostfix srcBaseName String srcDatastoreName dsSrcFile getDatastoreName null dsSrcFile getDatastoreName zeroLengthString s_logger info vmdkDatastorePath srcBaseName if devices null devices size for VirtualDevice device devices if device VirtualDisk s_logger info device getControllerKey device getUnitNumber VirtualDeviceBackingInfo backingInfo device getBacking if backingInfo VirtualDiskFlatVer2BackingInfo VirtualDiskFlatVer2BackingInfo diskBackingInfo VirtualDiskFlatVer2BackingInfo backingInfo do
if device VirtualDisk s_logger info device getControllerKey device getUnitNumber VirtualDeviceBackingInfo backingInfo device getBacking if backingInfo VirtualDiskFlatVer2BackingInfo VirtualDiskFlatVer2BackingInfo diskBackingInfo VirtualDiskFlatVer2BackingInfo backingInfo do s_logger info diskBackingInfo getFileName DatastoreFile dsBackingFile new DatastoreFile diskBackingInfo getFileName String backingDatastoreName dsBackingFile getDatastoreName null dsBackingFile getDatastoreName zeroLengthString if srcDatastoreName equals zeroLengthString backingDatastoreName zeroLengthString if srcDatastoreName equalsIgnoreCase backingDatastoreName String backingBaseName dsBackingFile getFileBaseName if backingBaseName equalsIgnoreCase srcBaseName String deviceNumbering getDeviceBusName devices device
if srcDatastoreName equalsIgnoreCase backingDatastoreName String backingBaseName dsBackingFile getFileBaseName if backingBaseName equalsIgnoreCase srcBaseName String deviceNumbering getDeviceBusName devices device s_logger info diskBackingInfo getFileName deviceNumbering return new Pair VirtualDisk device deviceNumbering if backingBaseName contains trimmedSrcBaseName String deviceNumbering getDeviceBusName devices device partialMatchingDiskDevices add new Pair VirtualDisk device deviceNumbering diskBackingInfo diskBackingInfo getParent while diskBackingInfo null s_logger info vmdkDatastorePath srcBaseName if partialMatchingDiskDevices null if partialMatchingDiskDevices size VirtualDiskFlatVer2BackingInfo matchingDiskBackingInfo VirtualDiskFlatVer2BackingInfo partialMatchingDiskDevices get first getBacking
public Pair VirtualDisk String getDiskDevice String vmdkDatastorePath boolean matchExactly throws Exception List VirtualDevice devices _context getVimClient getDynamicProperty _mor DatastoreFile dsSrcFile new DatastoreFile vmdkDatastorePath String srcBaseName dsSrcFile getFileBaseName String trimmedSrcBaseName VmwareHelper trimSnapshotDeltaPostfix srcBaseName if matchExactly
DatastoreFile dsSrcFile new DatastoreFile vmdkDatastorePath String srcBaseName dsSrcFile getFileBaseName String trimmedSrcBaseName VmwareHelper trimSnapshotDeltaPostfix srcBaseName if matchExactly s_logger info vmdkDatastorePath srcBaseName else s_logger info vmdkDatastorePath trimmedSrcBaseName if devices null devices size for VirtualDevice device devices if device VirtualDisk s_logger info device getControllerKey device getUnitNumber VirtualDeviceBackingInfo backingInfo VirtualDisk device getBacking if backingInfo VirtualDiskFlatVer2BackingInfo VirtualDiskFlatVer2BackingInfo diskBackingInfo VirtualDiskFlatVer2BackingInfo backingInfo do
else s_logger info vmdkDatastorePath trimmedSrcBaseName if devices null devices size for VirtualDevice device devices if device VirtualDisk s_logger info device getControllerKey device getUnitNumber VirtualDeviceBackingInfo backingInfo VirtualDisk device getBacking if backingInfo VirtualDiskFlatVer2BackingInfo VirtualDiskFlatVer2BackingInfo diskBackingInfo VirtualDiskFlatVer2BackingInfo backingInfo do s_logger info diskBackingInfo getFileName DatastoreFile dsBackingFile new DatastoreFile diskBackingInfo getFileName String backingBaseName dsBackingFile getFileBaseName if matchExactly if backingBaseName equalsIgnoreCase srcBaseName
if device VirtualDisk s_logger info device getControllerKey device getUnitNumber VirtualDeviceBackingInfo backingInfo VirtualDisk device getBacking if backingInfo VirtualDiskFlatVer2BackingInfo VirtualDiskFlatVer2BackingInfo diskBackingInfo VirtualDiskFlatVer2BackingInfo backingInfo do s_logger info diskBackingInfo getFileName DatastoreFile dsBackingFile new DatastoreFile diskBackingInfo getFileName String backingBaseName dsBackingFile getFileBaseName if matchExactly if backingBaseName equalsIgnoreCase srcBaseName String deviceNumbering getDeviceBusName devices device s_logger info diskBackingInfo getFileName deviceNumbering return new Pair VirtualDisk String VirtualDisk device deviceNumbering else
public String getDiskCurrentTopBackingFileInChain String deviceBusName throws Exception List VirtualDevice devices _context getVimClient getDynamicProperty _mor if devices null devices size for VirtualDevice device devices if device VirtualDisk
while flags try VirtualMachineRuntimeInfo runtimeInfo vmMo getRuntimeInfo VirtualMachineQuestionInfo question runtimeInfo getQuestion if question null encounterQuestion true if s_logger isTraceEnabled s_logger trace question getId s_logger trace question getText if question getMessage null for VirtualMachineMessage msg question getMessage if s_logger isTraceEnabled s_logger trace msg getId s_logger trace msg getText if equalsIgnoreCase msg getId
s_logger trace question getText if question getMessage null for VirtualMachineMessage msg question getMessage if s_logger isTraceEnabled s_logger trace msg getId s_logger trace msg getText if equalsIgnoreCase msg getId s_logger info msg getId vmMo answerVM question getId ANSWER_NO break else if question getText null String text question getText String msgId String msgText if s_logger isDebugEnabled
s_logger trace msg getId s_logger trace msg getText if equalsIgnoreCase msg getId s_logger info msg getId vmMo answerVM question getId ANSWER_NO break else if question getText null String text question getText String msgId String msgText if s_logger isDebugEnabled s_logger debug text String tokens text split msgId tokens msgText tokens
VirtualMachineConfigSpec vmConfig new VirtualMachineConfigSpec int busNum availableBusNum while busNum count VirtualBusLogicController scsiController new VirtualBusLogicController scsiController setSharedBus VirtualSCSISharing NO_SHARING scsiController setBusNumber busNum scsiController setKey busNum VmwareHelper MAX_SCSI_CONTROLLER_COUNT VirtualDeviceConfigSpec scsiControllerSpec new VirtualDeviceConfigSpec scsiControllerSpec setDevice scsiController scsiControllerSpec setOperation VirtualDeviceConfigSpecOperation ADD vmConfig getDeviceChange add scsiControllerSpec busNum if configureVm vmConfig throw new Exception getName else
vimPort vimService getVimPort Map String Object ctxt BindingProvider vimPort getRequestContext ctxt put BindingProvider ENDPOINT_ADDRESS_PROPERTY url ctxt put BindingProvider SESSION_MAINTAIN_PROPERTY true ctxt put vCenterSessionTimeout ctxt put vCenterSessionTimeout ServiceContent serviceContent vimPort retrieveServiceContent svcInstRef SuppressWarnings Map String List String headers Map String List String BindingProvider vimPort getResponseContext get MessageContext HTTP_RESPONSE_HEADERS List String cookies headers get vimPort login serviceContent getSessionManager userName password null if cookies null SuppressWarnings Map String List String responseHeaders Map String List String BindingProvider vimPort getResponseContext get MessageContext HTTP_RESPONSE_HEADERS cookies responseHeaders get if cookies null String msg url
catch WebServiceException we s_logger warn we getLocalizedMessage TaskInfo taskInfo TaskInfo getDynamicProperty task if taskInfo isCancelable s_logger warn taskInfo getName taskInfo getKey throw new RuntimeException we getLocalizedMessage s_logger debug taskInfo getName taskInfo getKey getService cancelTask task Object result waitForValues task new String new String new Object new Object TaskInfoState SUCCESS TaskInfoState ERROR if result null result length if result equals TaskInfoState SUCCESS s_logger warn taskInfo getName taskInfo getKey retVal true if result LocalizedMethodFault MethodFault fault LocalizedMethodFault result getFault
spec getPropSet add pSpec spec getObjectSet add oSpec List PropertyFilterSpec specArr new ArrayList PropertyFilterSpec specArr add spec ManagedObjectReference propCollector getPropCol List ObjectContent ocary vimPort retrieveProperties propCollector specArr if ocary null ocary size return null for ObjectContent oc ocary ManagedObjectReference mor oc getObj List DynamicProperty propary oc getPropSet if type null type equals mor getType if propary size String propval String propary get getVal if propval null name equalsIgnoreCase propval return mor
specArr add spec ManagedObjectReference propCollector getPropCol List ObjectContent ocary vimPort retrieveProperties propCollector specArr if ocary null ocary size return null for ObjectContent oc ocary ManagedObjectReference mor oc getObj List DynamicProperty propary oc getPropSet if type null type equals mor getType if propary size String propval String propary get getVal if propval null name equalsIgnoreCase propval return mor catch InvalidPropertyFaultMsg invalidPropertyException s_logger debug name type invalidPropertyException getMessage throw invalidPropertyException
public ManagedObjectReference getDatastoreMorByPath String inventoryPath throws Exception assert inventoryPath null String tokens if inventoryPath startsWith tokens inventoryPath substring split else tokens inventoryPath split if tokens null tokens length
private static void connectWithRetry HttpURLConnection conn throws Exception boolean connected false for int i i MAX_CONNECT_RETRY connected i try conn connect connected true
public void registerContext final VmwareContext context assert context getPool this assert context getPoolKey null final String poolKey context getPoolKey intern synchronized poolKey Queue VmwareContext ctxQueue _pool get poolKey if ctxQueue null ctxQueue new ConcurrentLinkedQueue _pool put poolKey ctxQueue if ctxQueue size _maxIdleQueueLength final VmwareContext oldestContext ctxQueue remove if oldestContext null try oldestContext close catch Throwable t
public static String getExceptionMessage Throwable e boolean printStack try Class extends Throwable cls e getClass Method mth cls getDeclaredMethod Class null if mth null Object fault mth invoke e Object null if fault MethodFault final StringWriter writer new StringWriter writer append fault getClass getName writer append MethodFault fault getFaultMessage if printStack writer append e printStackTrace new PrintWriter writer return writer toString catch Exception ex
