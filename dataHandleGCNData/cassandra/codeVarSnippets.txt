Override public void log AuditLogEntry auditLogEntry
Override public boolean login throws LoginException if callbackHandler null logger info throw new LoginException NameCallback nc new NameCallback PasswordCallback pc new PasswordCallback false try callbackHandler handle new Callback nc pc username nc getName char tmpPassword pc getPassword if tmpPassword null tmpPassword new char password new char tmpPassword length System arraycopy tmpPassword password tmpPassword length pc clearPassword catch IOException UnsupportedCallbackException e
private static void setupDefaultRole if StorageService instance getTokenMetadata sortedTokens isEmpty throw new IllegalStateException try if hasExistingRoles QueryProcessor process String format SchemaConstants AUTH_KEYSPACE_NAME AuthKeyspace ROLES DEFAULT_SUPERUSER_NAME escape hashpw DEFAULT_SUPERUSER_PASSWORD consistencyForRole DEFAULT_SUPERUSER_NAME
public void setRate final int throttleInKB int endpointsCount StorageService instance getTokenMetadata getSizeOfAllEndpoints if endpointsCount int endpointThrottleInKB throttleInKB endpointsCount double throughput endpointThrottleInKB Double MAX_VALUE endpointThrottleInKB if rateLimiter getRate throughput
public int loadSaved int count long start System nanoTime File dataPath getCacheDataPath CURRENT_VERSION File crcPath getCacheCrcPath CURRENT_VERSION if dataPath exists crcPath exists DataInputStreamPlus in null try
while futures peek null futures peek isDone Future Pair K V future futures poll Pair K V entry future get if entry null entry right null put entry left entry right if futures size Thread yield while futures size Future Pair K V future null while future futures poll null Pair K V entry future get if entry null entry right null put entry left entry right catch CorruptFileException e JVMStabilityInspector inspectThrowable e logger warn String format dataPath getAbsolutePath e catch Throwable t JVMStabilityInspector inspectThrowable t
if conf commitlog_sync Config CommitLogSync batch if conf commitlog_sync_period_in_ms throw new ConfigurationException false logger debug else if conf commitlog_sync CommitLogSync group if Double isNaN conf commitlog_sync_group_window_in_ms conf commitlog_sync_group_window_in_ms 0d throw new ConfigurationException false else if conf commitlog_sync_period_in_ms throw new ConfigurationException false logger debug conf commitlog_sync_period_in_ms else if conf commitlog_sync_period_in_ms throw new ConfigurationException false else if Double isNaN conf commitlog_sync_batch_window_in_ms throw new ConfigurationException false
logger debug else if conf commitlog_sync CommitLogSync group if Double isNaN conf commitlog_sync_group_window_in_ms conf commitlog_sync_group_window_in_ms 0d throw new ConfigurationException false else if conf commitlog_sync_period_in_ms throw new ConfigurationException false logger debug conf commitlog_sync_period_in_ms else if conf commitlog_sync_period_in_ms throw new ConfigurationException false else if Double isNaN conf commitlog_sync_batch_window_in_ms throw new ConfigurationException false logger debug conf commitlog_sync_period_in_ms if conf disk_access_mode Config DiskAccessMode auto conf disk_access_mode hasLargeAddressSpace Config DiskAccessMode mmap Config DiskAccessMode standard
if Double isNaN conf commitlog_sync_group_window_in_ms conf commitlog_sync_group_window_in_ms 0d throw new ConfigurationException false else if conf commitlog_sync_period_in_ms throw new ConfigurationException false logger debug conf commitlog_sync_period_in_ms else if conf commitlog_sync_period_in_ms throw new ConfigurationException false else if Double isNaN conf commitlog_sync_batch_window_in_ms throw new ConfigurationException false logger debug conf commitlog_sync_period_in_ms if conf disk_access_mode Config DiskAccessMode auto conf disk_access_mode hasLargeAddressSpace Config DiskAccessMode mmap Config DiskAccessMode standard indexAccessMode conf disk_access_mode logger info conf disk_access_mode indexAccessMode
else if conf commitlog_sync_period_in_ms throw new ConfigurationException false logger debug conf commitlog_sync_period_in_ms else if conf commitlog_sync_period_in_ms throw new ConfigurationException false else if Double isNaN conf commitlog_sync_batch_window_in_ms throw new ConfigurationException false logger debug conf commitlog_sync_period_in_ms if conf disk_access_mode Config DiskAccessMode auto conf disk_access_mode hasLargeAddressSpace Config DiskAccessMode mmap Config DiskAccessMode standard indexAccessMode conf disk_access_mode logger info conf disk_access_mode indexAccessMode else if conf disk_access_mode Config DiskAccessMode mmap_index_only conf disk_access_mode Config DiskAccessMode standard
logger info conf disk_access_mode indexAccessMode else if conf disk_access_mode Config DiskAccessMode mmap_index_only conf disk_access_mode Config DiskAccessMode standard indexAccessMode Config DiskAccessMode mmap logger info conf disk_access_mode indexAccessMode else indexAccessMode conf disk_access_mode logger info conf disk_access_mode indexAccessMode if conf gc_warn_threshold_in_ms throw new ConfigurationException if conf phi_convict_threshold conf phi_convict_threshold throw new ConfigurationException conf phi_convict_threshold false if conf concurrent_reads throw new ConfigurationException conf concurrent_reads false if conf concurrent_writes System getProperty isEmpty
if conf native_transport_max_concurrent_requests_in_bytes_per_ip conf native_transport_max_concurrent_requests_in_bytes_per_ip Runtime getRuntime maxMemory if conf commitlog_total_space_in_mb null final int preferredSizeInMB try final long totalSpaceInBytes guessFileStore conf commitlog_directory getTotalSpace conf commitlog_total_space_in_mb calculateDefaultSpaceInMB conf commitlog_directory preferredSizeInMB totalSpaceInBytes catch IOException e logger debug e throw new ConfigurationException String format conf commitlog_directory e if conf cdc_enabled if FBUtilities isWindows conf commitlog_compression null throw new ConfigurationException if conf cdc_raw_directory null conf cdc_raw_directory storagedirFor if conf cdc_total_space_in_mb
private static void logInfo String property long actualValue long lowestAcceptedValue
public static void useOffheapMerkleTrees boolean value
public Config loadConfig URL url throws ConfigurationException try
public static void rebuildSecondaryIndex String ksName String cfName String idxNames ColumnFamilyStore cfs Keyspace open ksName getColumnFamilyStore cfName
throw new RuntimeException e long now System currentTimeMillis for ColumnFamilyStore cfs concatWithIndexes for SSTableReader sstable cfs getLiveSSTables now Math max now sstable maxDataAge truncatedAt now Runnable truncateRunnable new Runnable public void run logger debug data notifyTruncated truncatedAt if DatabaseDescriptor isAutoSnapshot snapshot Keyspace getTimestampedSnapshotNameWithPrefix name SNAPSHOT_TRUNCATE_PREFIX discardSSTables truncatedAt indexManager truncateAllIndexesBlocking truncatedAt viewManager truncateBlocking replayAfter truncatedAt SystemKeyspace saveTruncationRecord ColumnFamilyStore this truncatedAt replayAfter logger trace invalidateCaches
public static boolean verifyFullPermissions File dir String dataDir if dir isDirectory
public void removeTemporaryDirectories for File dataDir dataPaths File tmpDir new File dataDir TMP_SUBDIR if tmpDir exists
public DiskBoundaries getDiskBoundaries ColumnFamilyStore cfs if cfs getPartitioner splitter isPresent return new DiskBoundaries cfs cfs getDirectories getWriteableLocations DisallowedDirectories getDirectoriesVersion if diskBoundaries null diskBoundaries isOutOfDate synchronized this if diskBoundaries null diskBoundaries isOutOfDate logger debug cfs keyspace getName cfs getTableName DiskBoundaries oldBoundaries diskBoundaries diskBoundaries getDiskBoundaryValue cfs
private void createReplicationStrategy KeyspaceMetadata ksm
private void createReplicationStrategy KeyspaceMetadata ksm logger info ksm name ksm params replicationStrategy ksm createReplicationStrategy if ksm params replication equals replicationParams
VisibleForTesting synchronized List String importNewSSTables Options options
List Pair Directories SSTableLister String listers getSSTableListers options srcPaths Set Descriptor currentDescriptors new HashSet for SSTableReader sstable cfs getSSTables SSTableSet CANONICAL currentDescriptors add sstable descriptor List String failedDirectories new ArrayList if options verifySSTables options verifyTokens for Pair Directories SSTableLister String listerPair listers Directories SSTableLister lister listerPair left String dir listerPair right for Map Entry Descriptor Set Component entry lister list entrySet Descriptor descriptor entry getKey if currentDescriptors contains entry getKey try verifySSTableForImport descriptor entry getValue options verifyTokens options verifySSTables options extendedVerify catch Throwable t if dir null
List String failedDirectories new ArrayList if options verifySSTables options verifyTokens for Pair Directories SSTableLister String listerPair listers Directories SSTableLister lister listerPair left String dir listerPair right for Map Entry Descriptor Set Component entry lister list entrySet Descriptor descriptor entry getKey if currentDescriptors contains entry getKey try verifySSTableForImport descriptor entry getValue options verifyTokens options verifySSTables options extendedVerify catch Throwable t if dir null logger error descriptor dir t failedDirectories add dir else
Set SSTableReader newSSTables new HashSet for Pair Directories SSTableLister String listerPair listers Directories SSTableLister lister listerPair left String dir listerPair right if failedDirectories contains dir continue Set MovedSSTable movedSSTables new HashSet Set SSTableReader newSSTablesPerDirectory new HashSet for Map Entry Descriptor Set Component entry lister list entrySet try Descriptor oldDescriptor entry getKey if currentDescriptors contains oldDescriptor continue File targetDir getTargetDirectory dir oldDescriptor entry getValue Descriptor newDescriptor cfs getUniqueDescriptorFor entry getKey targetDir maybeMutateMetadata entry getKey options movedSSTables add new MovedSSTable newDescriptor entry getKey entry getValue
if failedDirectories contains dir continue Set MovedSSTable movedSSTables new HashSet Set SSTableReader newSSTablesPerDirectory new HashSet for Map Entry Descriptor Set Component entry lister list entrySet try Descriptor oldDescriptor entry getKey if currentDescriptors contains oldDescriptor continue File targetDir getTargetDirectory dir oldDescriptor entry getValue Descriptor newDescriptor cfs getUniqueDescriptorFor entry getKey targetDir maybeMutateMetadata entry getKey options movedSSTables add new MovedSSTable newDescriptor entry getKey entry getValue SSTableReader sstable SSTableReader moveAndOpenSSTable cfs entry getKey newDescriptor entry getValue newSSTablesPerDirectory add sstable catch Throwable t newSSTablesPerDirectory forEach s s selfRef release
public static void snapshotOnVersionChange throws IOException String previous getPreviousVersionString String next FBUtilities getReleaseVersionString FBUtilities setPreviousReleaseVersionString previous if previous equals NULL_VERSION toString previous equals next
public static void writePreparedStatement String loggedKeyspace MD5Digest key String cql executeInternal format PreparedStatements toString loggedKeyspace key byteBuffer cql
private static void migratePeers ColumnFamilyStore newPeers Keyspace open SchemaConstants SYSTEM_KEYSPACE_NAME getColumnFamilyStore SystemKeyspace PEERS_V2 if newPeers isEmpty return logger info peersName legacyPeersName peersName String query String format legacyPeersName String insert String format peersName UntypedResultSet rows QueryProcessor executeInternalWithPaging query int transferred
private static void migratePeers ColumnFamilyStore newPeers Keyspace open SchemaConstants SYSTEM_KEYSPACE_NAME getColumnFamilyStore SystemKeyspace PEERS_V2 if newPeers isEmpty return logger info peersName legacyPeersName peersName String query String format legacyPeersName String insert String format peersName UntypedResultSet rows QueryProcessor executeInternalWithPaging query int transferred logger info legacyPeersName peersName for UntypedResultSet Row row rows
private static void migratePeerEvents ColumnFamilyStore newPeerEvents Keyspace open SchemaConstants SYSTEM_KEYSPACE_NAME getColumnFamilyStore SystemKeyspace PEER_EVENTS_V2 if newPeerEvents isEmpty return logger info peerEventsName legacyPeerEventsName peerEventsName String query String format legacyPeerEventsName String insert String format peerEventsName UntypedResultSet rows QueryProcessor executeInternalWithPaging query int transferred for UntypedResultSet Row row rows
static void migrateTransferredRanges ColumnFamilyStore newTransferredRanges Keyspace open SchemaConstants SYSTEM_KEYSPACE_NAME getColumnFamilyStore SystemKeyspace TRANSFERRED_RANGES_V2 if newTransferredRanges isEmpty return logger info transferredRangesName legacyTransferredRangesName transferredRangesName String query String format legacyTransferredRangesName String insert String format transferredRangesName UntypedResultSet rows QueryProcessor executeInternalWithPaging query int transferred for UntypedResultSet Row row rows
static void migrateAvailableRanges ColumnFamilyStore newAvailableRanges Keyspace open SchemaConstants SYSTEM_KEYSPACE_NAME getColumnFamilyStore SystemKeyspace AVAILABLE_RANGES_V2 if newAvailableRanges isEmpty return logger info availableRangesName legacyAvailableRangesName availableRangesName String query String format legacyAvailableRangesName String insert String format availableRangesName UntypedResultSet rows QueryProcessor executeInternalWithPaging query int transferred for UntypedResultSet Row row rows
void forceRecycleAll Iterable TableId droppedTables List CommitLogSegment segmentsToRecycle new ArrayList activeSegments CommitLogSegment last segmentsToRecycle get segmentsToRecycle size advanceAllocatingFrom last last waitForModifications Keyspace writeOrder awaitNewBarrier Future future flushDataFrom segmentsToRecycle true try future get for CommitLogSegment segment activeSegments for TableId tableId droppedTables segment markClean tableId CommitLogPosition NONE segment getCurrentCommitLogPosition for CommitLogSegment segment activeSegments if segment isUnused archiveAndDiscard segment CommitLogSegment first if first activeSegments peek null first id last id logger error catch Throwable t
void archiveAndDiscard final CommitLogSegment segment boolean archiveSuccess commitLog archiver maybeWaitForArchiving segment getName if activeSegments remove segment return
public void discardCompletedSegments final TableId id final CommitLogPosition lowerBound final CommitLogPosition upperBound logger trace lowerBound upperBound id for Iterator CommitLogSegment iter segmentManager getActiveSegments iterator iter hasNext CommitLogSegment segment iter next segment markClean id lowerBound upperBound if segment isUnused
static List File filterCommitLogFiles File toFilter List File filtered new ArrayList toFilter length for File file toFilter try if shouldSkip file
if shouldSkipSegmentId file desc minPosition return CommitLogSegmentReader segmentReader try segmentReader new CommitLogSegmentReader handler desc reader tolerateTruncation catch Exception e handler handleUnrecoverableError new CommitLogReadException String format e CommitLogReadErrorReason UNRECOVERABLE_UNKNOWN_ERROR tolerateTruncation return try ReadStatusTracker statusTracker new ReadStatusTracker mutationLimit tolerateTruncation for CommitLogSegmentReader SyncSegment syncSegment segmentReader statusTracker tolerateErrorsInSection tolerateTruncation syncSegment toleratesErrorsInSection if desc id minPosition segmentId syncSegment endPosition minPosition position continue statusTracker errorContext String format syncSegment fileStartPosition desc fileName readSection handler syncSegment input minPosition syncSegment endPosition statusTracker desc if statusTracker shouldContinue break
private boolean shouldSkipSegmentId File file CommitLogDescriptor desc CommitLogPosition minPosition
Map TableId IntervalSet CommitLogPosition cfPersisted new HashMap ReplayFilter replayFilter ReplayFilter create for ColumnFamilyStore cfs ColumnFamilyStore all CommitLogPosition truncatedAt SystemKeyspace getTruncatedPosition cfs metadata id if truncatedAt null long restoreTime commitLog archiver restorePointInTime long truncatedTime SystemKeyspace getTruncatedAt cfs metadata id if truncatedTime restoreTime if replayFilter includes cfs metadata logger info cfs metadata keyspace cfs metadata name SystemKeyspace removeTruncationRecord cfs metadata id truncatedAt null IntervalSet CommitLogPosition filter persistedIntervals cfs getLiveSSTables truncatedAt cfPersisted put cfs metadata id filter CommitLogPosition globalPosition firstNotCovered cfPersisted values
public boolean shouldSkipSegmentOnError CommitLogReadException exception throws IOException if exception permissible logger error exception else if Boolean getBoolean IGNORE_REPLAY_ERRORS_PROPERTY logger error exception else if CommitLog handleCommitError exception
static void validateSSTableBoundsForAnticompaction UUID sessionID Collection SSTableReader sstables RangesAtEndpoint ranges List Range Token normalizedRanges Range normalize ranges ranges for SSTableReader sstable sstables Bounds Token bounds new Bounds sstable first getToken sstable last getToken if Iterables any normalizedRanges r r contains bounds left r contains bounds right r intersects bounds String message String format PreviewKind NONE logPrefix sessionID sstable bounds normalizedRanges
VisibleForTesting static Set SSTableReader findSSTablesToAnticompact Iterator SSTableReader sstableIterator List Range Token normalizedRanges UUID parentRepairSession Set SSTableReader fullyContainedSSTables new HashSet while sstableIterator hasNext SSTableReader sstable sstableIterator next Bounds Token sstableBounds new Bounds sstable first getToken sstable last getToken for Range Token r normalizedRanges if r contains sstable first getToken r contains sstable last getToken
public Future submitUserDefined final ColumnFamilyStore cfs final Collection Descriptor dataFiles final int gcBefore Runnable runnable new WrappedRunnable protected void runMayThrow throws Exception Collection SSTableReader sstables new ArrayList dataFiles size for Descriptor desc dataFiles SSTableReader sstable lookupSSTable cfs desc if sstable null
private void doAntiCompaction ColumnFamilyStore cfs RangesAtEndpoint ranges LifecycleTransaction txn UUID pendingRepair BooleanSupplier isCancelled int originalCount txn originals size
else unrepairedWriter append partition long bytesScanned scanners getTotalBytesScanned compactionRateLimiterAcquire limiter bytesScanned lastBytesScanned compressionRatio lastBytesScanned bytesScanned fullWriter prepareToCommit transWriter prepareToCommit unrepairedWriter prepareToCommit txn checkpoint txn obsoleteOriginals txn prepareToCommit List SSTableReader fullSSTables new ArrayList fullWriter finished List SSTableReader transSSTables new ArrayList transWriter finished List SSTableReader unrepairedSSTables new ArrayList unrepairedWriter finished fullWriter commit
public void setNewLocalCompactionStrategy CompactionParams params
private List SSTableReader getCompactionCandidates Iterable SSTableReader candidateSSTables long now int base Iterable SSTableReader candidates filterOldSSTables Lists newArrayList candidateSSTables options maxSSTableAge now List List SSTableReader buckets getBuckets createSSTableAndMinTimestampPairs candidates options baseTime base now options maxWindowSize
private static List SSTableReader getSSTablesForSTCS Collection SSTableReader sstables int minThreshold int maxThreshold SizeTieredCompactionStrategyOptions stcsOptions List SSTableReader s SizeTieredCompactionStrategy mostInterestingBucket getSTCSBuckets sstables stcsOptions minThreshold maxThreshold
for int j j compactionCounter length j logger trace j compactionCounter j for int i generations length i i if getLevelSize i if compactionCounter i NO_COMPACTION_LIMIT PartitionPosition max null PartitionPosition min null for SSTableReader candidate candidates if min null candidate first compareTo min min candidate first if max null candidate last compareTo max max candidate last if min null max null min equals max return candidates Set SSTableReader compacting cfs getTracker getCompacting Range PartitionPosition boundaries new Range min max for SSTableReader sstable getLevel i Range PartitionPosition r new Range PartitionPosition sstable first sstable last if boundaries contains r compacting contains sstable
private synchronized void removeSessionIfEmpty UUID sessionID if strategies containsKey sessionID strategies get sessionID getSSTables isEmpty return
Override protected void runMayThrow SSTableReader sstable transaction onlyOne StatsMetadata metadataBefore sstable getSSTableMetadata if level metadataBefore sstableLevel
int estimatedRemainingTasks TreeSet Long allKeys new TreeSet buckets keySet Iterator Long it allKeys descendingIterator while it hasNext Long key it next Set SSTableReader bucket buckets get key logger trace key now if bucket size minThreshold key now List Pair SSTableReader Long pairs SizeTieredCompactionStrategy createSSTableAndLengthPairs bucket List List SSTableReader stcsBuckets SizeTieredCompactionStrategy getBuckets pairs stcsOptions bucketHigh stcsOptions bucketLow stcsOptions minSSTableSize List SSTableReader stcsInterestingBucket SizeTieredCompactionStrategy mostInterestingBucket stcsBuckets minThreshold maxThreshold if stcsInterestingBucket isEmpty double remaining bucket size maxThreshold estimatedRemainingTasks remaining minThreshold Math ceil remaining maxThreshold if sstables isEmpty
List Pair SSTableReader Long pairs SizeTieredCompactionStrategy createSSTableAndLengthPairs bucket List List SSTableReader stcsBuckets SizeTieredCompactionStrategy getBuckets pairs stcsOptions bucketHigh stcsOptions bucketLow stcsOptions minSSTableSize List SSTableReader stcsInterestingBucket SizeTieredCompactionStrategy mostInterestingBucket stcsBuckets minThreshold maxThreshold if stcsInterestingBucket isEmpty double remaining bucket size maxThreshold estimatedRemainingTasks remaining minThreshold Math ceil remaining maxThreshold if sstables isEmpty logger debug pairs stcsOptions sstables stcsInterestingBucket else logger trace pairs stcsOptions else if bucket size key now double remaining bucket size maxThreshold estimatedRemainingTasks remaining minThreshold Math ceil remaining maxThreshold if sstables isEmpty
Override public boolean realAppend UnfilteredRowIterator partition RowIndexEntry rie sstableWriter append partition if sstableWriter currentWriter getEstimatedOnDiskBytesWritten currentBytesToWrite currentRatioIndex ratios length currentRatioIndex currentBytesToWrite Math round totalSize ratios currentRatioIndex switchCompactionLocation location
Map LogReplica List String linesByReplica replicas stream collect Collectors toMap Function LogReplica identity LogReplica :: readLines k v throw new IllegalStateException k LinkedHashMap :: new int maxNumLines linesByReplica values stream map List :: size reduce Integer :: max for int i i maxNumLines i String firstLine null boolean partial false for Map Entry LogReplica List String entry linesByReplica entrySet List String currentLines entry getValue if i currentLines size continue String currentLine currentLines get i if firstLine null firstLine currentLine continue if isPrefixMatch firstLine currentLine
List String currentLines entry getValue if i currentLines size continue String currentLine currentLines get i if firstLine null firstLine currentLine continue if isPrefixMatch firstLine currentLine logger error entry getKey getFileName currentLine firstLine entry getKey setError currentLine String format firstLine return false if firstLine equals currentLine if i currentLines size logger warn entry getKey getFileName currentLine firstLine if currentLine length firstLine length firstLine currentLine partial true
continue if isPrefixMatch firstLine currentLine logger error entry getKey getFileName currentLine firstLine entry getKey setError currentLine String format firstLine return false if firstLine equals currentLine if i currentLines size logger warn entry getKey getFileName currentLine firstLine if currentLine length firstLine length firstLine currentLine partial true else logger error entry getKey getFileName currentLine firstLine entry getKey setError currentLine String format firstLine return false LogRecord record LogRecord make firstLine
if firstLine equals currentLine if i currentLines size logger warn entry getKey getFileName currentLine firstLine if currentLine length firstLine length firstLine currentLine partial true else logger error entry getKey getFileName currentLine firstLine entry getKey setError currentLine String format firstLine return false LogRecord record LogRecord make firstLine if records contains record logger error record record fileName setError record return false if partial record setPartial
void append LogRecord record Throwable err Throwables perform null replicas stream map r r append record if err null if record isFinal err getSuppressed length replicas size Throwables maybeFail err
void onConflict String keyspace String name String fieldName
return new Refs Set SSTableReader sstablesToValidate new HashSet com google common base Predicate SSTableReader predicate if prs isPreview predicate prs previewKind predicate else if isIncremental predicate s parentId equals s getSSTableMetadata pendingRepair else predicate s prs isIncremental s isRepaired try ColumnFamilyStore RefViewFragment sstableCandidates cfs selectAndReference View select SSTableSet CANONICAL predicate for SSTableReader sstable sstableCandidates sstables if new Bounds sstable first getToken sstable last getToken intersects ranges sstablesToValidate add sstable sstables Refs tryRef sstablesToValidate if sstables null
public static RowIterator loggingIterator RowIterator iterator final String id TableMetadata metadata iterator metadata
public static UnfilteredRowIterator loggingIterator UnfilteredRowIterator iterator final String id final boolean fullDetails TableMetadata metadata iterator metadata
if cfs null throw new IOException tableId ComponentManifest manifest header componentManifest long totalSize manifest totalSize logger debug session planId fileSequenceNumber session peer prettyPrintMemory totalSize cfs metadata BigTableZeroCopyWriter writer null try writer createWriter cfs totalSize manifest components long bytesRead for Component component manifest components long length manifest sizeOf component logger debug session planId component session peer prettyPrintMemory length prettyPrintMemory bytesRead prettyPrintMemory totalSize writer writeComponent component type in length session progress writer descriptor filenameFor component ProgressInfo Direction IN length length bytesRead length
logger debug session planId fileSequenceNumber session peer prettyPrintMemory totalSize cfs metadata BigTableZeroCopyWriter writer null try writer createWriter cfs totalSize manifest components long bytesRead for Component component manifest components long length manifest sizeOf component logger debug session planId component session peer prettyPrintMemory length prettyPrintMemory bytesRead prettyPrintMemory totalSize writer writeComponent component type in length session progress writer descriptor filenameFor component ProgressInfo Direction IN length length bytesRead length logger debug session planId component session peer prettyPrintMemory length prettyPrintMemory bytesRead prettyPrintMemory totalSize Function StatsMetadata StatsMetadata transform stats stats mutateLevel header sstableLevel mutateRepairedMetadata messageHeader repairedAt messageHeader pendingRepair false writer descriptor getMetadataSerializer mutate writer descriptor transform return writer
public void write AsyncStreamingOutputPlus out throws IOException long totalSize manifest totalSize logger debug session planId sstable getFilename session peer sstable getSSTableMetadata repairedAt prettyPrintMemory totalSize long progress 0L for Component component manifest components SuppressWarnings FileChannel in new RandomAccessFile sstable descriptor filenameFor component getChannel long length in size
public void write AsyncStreamingOutputPlus out throws IOException long totalSize manifest totalSize logger debug session planId sstable getFilename session peer sstable getSSTableMetadata repairedAt prettyPrintMemory totalSize long progress 0L for Component component manifest components SuppressWarnings FileChannel in new RandomAccessFile sstable descriptor filenameFor component getChannel long length in size logger debug session planId sstable getKeyspaceName sstable getColumnFamilyName sstable descriptor generation component prettyPrintMemory length long bytesWritten out writeFileToChannel in limiter progress bytesWritten session progress sstable descriptor filenameFor component ProgressInfo Direction OUT bytesWritten length
Override public synchronized void read DataInputPlus in int version throws IOException CassandraStreamHeader streamHeader CassandraStreamHeader serializer deserialize in version
public void write DataOutputStreamPlus output throws IOException long totalSize totalSize
public void start if SystemKeyspace isViewBuilt ksName view name
if newRanges isEmpty pendingRanges isEmpty finish return DatabaseDescriptor getPartitioner splitter map s s split newRanges NUM_TASKS orElse newRanges forEach r pendingRanges put r Pair Token Long create null 0L List ListenableFuture Long futures pendingRanges entrySet stream map e new ViewBuilderTask baseCfs view e getKey e getValue left e getValue right peek tasks :: add map CompactionManager instance :: submitViewBuilder collect toList ListenableFuture List Long future Futures allAsList futures Futures addCallback future new FutureCallback List Long public void onSuccess List Long result keysBuilt result stream mapToLong x x sum builtRanges addAll pendingRanges keySet pendingRanges clear build public void onFailure Throwable t if t CompactionInterruptedException internalStop true
private void finish String ksName baseCfs keyspace getName if isStopped SystemKeyspace updateViewBuildStatus ksName view name range range right keysBuilt
private static Collection Token getSpecifiedTokens final TokenMetadata metadata Collection String initialTokens
private MutableCapacityGraph Vertex Integer getGraph MutableCapacityGraph Vertex Integer capacityGraph MutableCapacityGraph create for Range Token range rangesWithSources keySet if trivialRanges contains range
public void addRanges String keyspaceName ReplicaCollection replicas Keyspace keyspace Keyspace open keyspaceName AbstractReplicationStrategy strat keyspace getReplicationStrategy if strat LocalStrategy
public static EndpointsByReplica calculateRangesToFetchWithPreferredEndpoints BiFunction InetAddressAndPort EndpointsForRange EndpointsForRange snitchGetSortedListByProximity AbstractReplicationStrategy strat ReplicaCollection fetchRanges boolean useStrictConsistency TokenMetadata tmdBefore TokenMetadata tmdAfter String keyspace Collection SourceFilter sourceFilters EndpointsByRange rangeAddresses strat getRangeAddresses tmdBefore InetAddressAndPort localAddress FBUtilities getBroadcastAddressAndPort
public static EndpointsByReplica calculateRangesToFetchWithPreferredEndpoints BiFunction InetAddressAndPort EndpointsForRange EndpointsForRange snitchGetSortedListByProximity AbstractReplicationStrategy strat ReplicaCollection fetchRanges boolean useStrictConsistency TokenMetadata tmdBefore TokenMetadata tmdAfter String keyspace Collection SourceFilter sourceFilters EndpointsByRange rangeAddresses strat getRangeAddresses tmdBefore InetAddressAndPort localAddress FBUtilities getBroadcastAddressAndPort logger debug keyspace
public static EndpointsByReplica calculateRangesToFetchWithPreferredEndpoints BiFunction InetAddressAndPort EndpointsForRange EndpointsForRange snitchGetSortedListByProximity AbstractReplicationStrategy strat ReplicaCollection fetchRanges boolean useStrictConsistency TokenMetadata tmdBefore TokenMetadata tmdAfter String keyspace Collection SourceFilter sourceFilters EndpointsByRange rangeAddresses strat getRangeAddresses tmdBefore InetAddressAndPort localAddress FBUtilities getBroadcastAddressAndPort logger debug keyspace logger debug fetchRanges
public static EndpointsByReplica calculateRangesToFetchWithPreferredEndpoints BiFunction InetAddressAndPort EndpointsForRange EndpointsForRange snitchGetSortedListByProximity AbstractReplicationStrategy strat ReplicaCollection fetchRanges boolean useStrictConsistency TokenMetadata tmdBefore TokenMetadata tmdAfter String keyspace Collection SourceFilter sourceFilters EndpointsByRange rangeAddresses strat getRangeAddresses tmdBefore InetAddressAndPort localAddress FBUtilities getBroadcastAddressAndPort logger debug keyspace logger debug fetchRanges logger debug rangeAddresses Predicate Replica testSourceFilters and sourceFilters Function EndpointsForRange EndpointsForRange sorted endpoints snitchGetSortedListByProximity apply localAddress endpoints EndpointsByReplica Builder rangesToFetchWithPreferredEndpoints new EndpointsByReplica Builder for Replica toFetch fetchRanges Predicate Replica isSufficient r toFetch isTransient r isFull
logger debug rangeAddresses Predicate Replica testSourceFilters and sourceFilters Function EndpointsForRange EndpointsForRange sorted endpoints snitchGetSortedListByProximity apply localAddress endpoints EndpointsByReplica Builder rangesToFetchWithPreferredEndpoints new EndpointsByReplica Builder for Replica toFetch fetchRanges Predicate Replica isSufficient r toFetch isTransient r isFull logger debug toFetch for Range Token range rangeAddresses keySet if range contains toFetch range continue final EndpointsForRange oldEndpoints sorted apply rangeAddresses get range EndpointsForRange sources if useStrictConsistency EndpointsForRange strictEndpoints if oldEndpoints size strat getReplicationFactor allReplicas EndpointsForRange newEndpoints strat calculateNaturalReplicas toFetch range right tmdAfter
Predicate Replica testSourceFilters and sourceFilters Function EndpointsForRange EndpointsForRange sorted endpoints snitchGetSortedListByProximity apply localAddress endpoints EndpointsByReplica Builder rangesToFetchWithPreferredEndpoints new EndpointsByReplica Builder for Replica toFetch fetchRanges Predicate Replica isSufficient r toFetch isTransient r isFull logger debug toFetch for Range Token range rangeAddresses keySet if range contains toFetch range continue final EndpointsForRange oldEndpoints sorted apply rangeAddresses get range EndpointsForRange sources if useStrictConsistency EndpointsForRange strictEndpoints if oldEndpoints size strat getReplicationFactor allReplicas EndpointsForRange newEndpoints strat calculateNaturalReplicas toFetch range right tmdAfter logger debug oldEndpoints
strictEndpoints oldEndpoints without newEndpoints endpoints if strictEndpoints size throw new AssertionError strictEndpoints if all strictEndpoints testSourceFilters throw new IllegalStateException buildErrorMessage sourceFilters strictEndpoints if strictEndpoints isEmpty toFetch isTransient throw new AssertionError toFetch if any strictEndpoints isSufficient Optional Replica fullReplica Iterables Replica tryFind oldEndpoints and isSufficient testSourceFilters toJavaUtil if fullReplica isPresent strictEndpoints Endpoints concat strictEndpoints EndpointsForRange of fullReplica get else throw new IllegalStateException buildErrorMessage sourceFilters oldEndpoints else strictEndpoints sorted apply oldEndpoints filter and isSufficient testSourceFilters sources strictEndpoints else sources sorted apply oldEndpoints filter and isSufficient testSourceFilters sources sources size sources subList sources rangesToFetchWithPreferredEndpoints putAll toFetch sources Conflict NONE
public StreamResultFuture fetchAsync toFetch forEach keyspace sources
public StreamResultFuture fetchAsync toFetch forEach keyspace sources logger debug keyspace sources sources asMap forEach source fetchReplicas SystemKeyspace AvailableRanges available stateStore getAvailableRanges keyspace metadata partitioner Predicate FetchReplica isAvailable fetch boolean isInFull available full contains fetch local range boolean isInTrans available trans contains fetch local range if isInFull isInTrans return false if fetch local isFull return isInFull fetch remote isFull return true List FetchReplica remaining fetchReplicas stream filter not isAvailable collect Collectors toList if remaining size available full size available trans size List FetchReplica skipped fetchReplicas stream filter isAvailable collect Collectors toList
Predicate FetchReplica isAvailable fetch boolean isInFull available full contains fetch local range boolean isInTrans available trans contains fetch local range if isInFull isInTrans return false if fetch local isFull return isInFull fetch remote isFull return true List FetchReplica remaining fetchReplicas stream filter not isAvailable collect Collectors toList if remaining size available full size available trans size List FetchReplica skipped fetchReplicas stream filter isAvailable collect Collectors toList logger info fetchReplicas skipped available full available trans if logger isTraceEnabled logger trace description source StringUtils join remaining InetAddressAndPort self FBUtilities getBroadcastAddressAndPort RangesAtEndpoint full remaining stream filter pair pair remote isFull map pair pair local collect RangesAtEndpoint collector self RangesAtEndpoint transientReplicas remaining stream filter pair pair remote isTransient map pair pair local collect RangesAtEndpoint collector self
boolean isInFull available full contains fetch local range boolean isInTrans available trans contains fetch local range if isInFull isInTrans return false if fetch local isFull return isInFull fetch remote isFull return true List FetchReplica remaining fetchReplicas stream filter not isAvailable collect Collectors toList if remaining size available full size available trans size List FetchReplica skipped fetchReplicas stream filter isAvailable collect Collectors toList logger info fetchReplicas skipped available full available trans if logger isTraceEnabled logger trace description source StringUtils join remaining InetAddressAndPort self FBUtilities getBroadcastAddressAndPort RangesAtEndpoint full remaining stream filter pair pair remote isFull map pair pair local collect RangesAtEndpoint collector self RangesAtEndpoint transientReplicas remaining stream filter pair pair remote isTransient map pair pair local collect RangesAtEndpoint collector self logger debug fetchReplicas
public void enableEventPersistence String eventClazz try
public void disableEventPersistence String eventClazz try
public synchronized E extends DiagnosticEvent void subscribe Class E event Consumer E consumer
public synchronized void stop try BinLog binLog this binLog if binLog null
Set File pathsToClean Sets newHashSet if fullQueryLogPath null File fullQueryLogPathFile new File fullQueryLogPath if fullQueryLogPathFile exists pathsToClean add fullQueryLogPathFile if binLog null binLog path null File pathFile binLog path toFile if pathFile exists pathsToClean add pathFile logger info if binLog null logger info pathsToClean binLog stop binLog null else
long diff now lastInterpret lastInterpret now if diff MAX_LOCAL_PAUSE_IN_NANOS logger warn diff MAX_LOCAL_PAUSE_IN_NANOS lastPause now return if preciseTime now lastPause MAX_LOCAL_PAUSE_IN_NANOS logger debug return double phi hbWnd phi now if logger isTraceEnabled logger trace ep phi if PHI_FACTOR phi getPhiConvictThreshold if logger isTraceEnabled logger trace new Object ep PHI_FACTOR phi getPhiConvictThreshold hbWnd hbWnd mean for IFailureDetectionEventListener listener fdEvntListeners listener convict ep phi
public void forceConviction InetAddressAndPort ep
public void doVerb Message message if Gossiper instance isEnabled
private static long getVeryLongTime String newVLT System getProperty if newVLT null
public void convict InetAddressAndPort endpoint double phi runInGossipStageBlocking EndpointState epState endpointStateMap get endpoint if epState null return if epState isAlive return
public void removeEndpoint InetAddressAndPort endpoint checkProperThreadForStateMutation for IEndpointStateChangeSubscriber subscriber subscribers subscriber onRemove endpoint if seeds contains endpoint buildSeedsList seeds remove endpoint
public void advertiseRemoving InetAddressAndPort endpoint UUID hostId UUID localHostId EndpointState epState endpointStateMap get endpoint int generation epState getHeartBeatState getGeneration
public void advertiseRemoving InetAddressAndPort endpoint UUID hostId UUID localHostId EndpointState epState endpointStateMap get endpoint int generation epState getHeartBeatState getGeneration logger info hostId
public void advertiseRemoving InetAddressAndPort endpoint UUID hostId UUID localHostId EndpointState epState endpointStateMap get endpoint int generation epState getHeartBeatState getGeneration logger info hostId logger info StorageService RING_DELAY endpoint Uninterruptibles sleepUninterruptibly StorageService RING_DELAY TimeUnit MILLISECONDS epState endpointStateMap get endpoint if epState getHeartBeatState getGeneration generation throw new RuntimeException endpoint
public void advertiseTokenRemoved InetAddressAndPort endpoint UUID hostId EndpointState epState endpointStateMap get endpoint epState updateTimestamp epState getHeartBeatState forceNewerGenerationUnsafe long expireTime computeExpireTime epState addApplicationState ApplicationState STATUS_WITH_PORT StorageService instance valueFactory removedNonlocal hostId expireTime epState addApplicationState ApplicationState STATUS StorageService instance valueFactory removedNonlocal hostId expireTime
long now System currentTimeMillis long nowNano System nanoTime long pending JMXEnabledThreadPoolExecutor Stage GOSSIP executor metrics pendingTasks getValue if pending lastProcessedMessageAt now Uninterruptibles sleepUninterruptibly TimeUnit MILLISECONDS if lastProcessedMessageAt now logger warn pending return Set InetAddressAndPort eps endpointStateMap keySet for InetAddressAndPort endpoint eps if endpoint equals FBUtilities getBroadcastAddressAndPort continue FailureDetector instance interpret endpoint EndpointState epState endpointStateMap get endpoint if epState null if isGossipOnlyMember endpoint justRemovedEndpoints containsKey endpoint TimeUnit NANOSECONDS toMillis nowNano epState getUpdateTimestamp fatClientTimeout
Set InetAddressAndPort eps endpointStateMap keySet for InetAddressAndPort endpoint eps if endpoint equals FBUtilities getBroadcastAddressAndPort continue FailureDetector instance interpret endpoint EndpointState epState endpointStateMap get endpoint if epState null if isGossipOnlyMember endpoint justRemovedEndpoints containsKey endpoint TimeUnit NANOSECONDS toMillis nowNano epState getUpdateTimestamp fatClientTimeout logger info endpoint fatClientTimeout runInGossipStageBlocking removeEndpoint endpoint evictFromMembership endpoint long expireTime getExpireTimeForEndpoint endpoint if epState isAlive now expireTime StorageService instance getTokenMetadata isMember endpoint if logger isDebugEnabled
void notifyFailureDetector InetAddressAndPort endpoint EndpointState remoteEndpointState EndpointState localEndpointState endpointStateMap get endpoint if localEndpointState null IFailureDetector fd FailureDetector instance int localGeneration localEndpointState getHeartBeatState getGeneration int remoteGeneration remoteEndpointState getHeartBeatState getGeneration if remoteGeneration localGeneration localEndpointState updateTimestamp if localEndpointState isAlive
VisibleForTesting public void realMarkAlive final InetAddressAndPort addr final EndpointState localState checkProperThreadForStateMutation if logger isTraceEnabled logger trace addr localState markAlive localState updateTimestamp liveEndpoints add addr unreachableEndpoints remove addr expireTimeEndpointMap remove addr
VisibleForTesting public void realMarkAlive final InetAddressAndPort addr final EndpointState localState checkProperThreadForStateMutation if logger isTraceEnabled logger trace addr localState markAlive localState updateTimestamp liveEndpoints add addr unreachableEndpoints remove addr expireTimeEndpointMap remove addr logger debug addr
VisibleForTesting public void markDead InetAddressAndPort addr EndpointState localState checkProperThreadForStateMutation if logger isTraceEnabled logger trace addr localState markDead liveEndpoints remove addr unreachableEndpoints put addr System nanoTime
protected void maybeFinishShadowRound InetAddressAndPort respondent boolean isInShadowRound Map InetAddressAndPort EndpointState epStateMap if inShadowRound if isInShadowRound if seeds contains respondent logger warn respondent
public void addExpireTimeForEndpoint InetAddressAndPort endpoint long expireTime if logger isDebugEnabled
final int GOSSIP_SETTLE_MIN_WAIT_MS final int GOSSIP_SETTLE_POLL_INTERVAL_MS final int GOSSIP_SETTLE_POLL_SUCCESSES_REQUIRED logger info Uninterruptibles sleepUninterruptibly GOSSIP_SETTLE_MIN_WAIT_MS TimeUnit MILLISECONDS int totalPolls int numOkay int epSize Gossiper instance getEndpointCount while numOkay GOSSIP_SETTLE_POLL_SUCCESSES_REQUIRED Uninterruptibles sleepUninterruptibly GOSSIP_SETTLE_POLL_INTERVAL_MS TimeUnit MILLISECONDS int currentSize Gossiper instance getEndpointCount totalPolls if currentSize epSize logger debug numOkay
return try hint mutation getPartitionUpdates forEach PartitionUpdate :: validate catch MarshalException e logger warn address hostId respond message return if hostId equals StorageService instance getLocalHostUUID HintsService instance write hostId hint respond message else if StorageProxy instance appliesLocally hint mutation HintsService instance writeForAllReplicas hint respond message else hint applyFuture thenAccept o respond message exceptionally e
for Index index indexes IndexBuildingSupport buildOrRecoveryTask isFullRebuild index getBuildTaskSupport index getRecoveryTaskSupport Set Index stored byType computeIfAbsent buildOrRecoveryTask i new HashSet stored add index List Future futures new ArrayList byType size byType forEach buildingSupport groupedIndexes SecondaryIndexBuilder builder buildingSupport getIndexBuildTask baseCfs groupedIndexes sstables final SettableFuture build SettableFuture create Futures addCallback CompactionManager instance submitIndexBuild builder new FutureCallback Override public void onFailure Throwable t logAndMarkIndexesFailed groupedIndexes t false unbuiltIndexes addAll groupedIndexes build setException t Override public void onSuccess Object o groupedIndexes forEach i markIndexBuilt i isFullRebuild
MoreExecutors directExecutor futures add build FBUtilities waitOnFutures futures catch Exception e accumulatedFail e throw e finally try Set Index failedIndexes Sets difference indexes Sets union builtIndexes unbuiltIndexes if failedIndexes isEmpty logAndMarkIndexesFailed failedIndexes accumulatedFail false flushIndexesBlocking builtIndexes new FutureCallback String indexNames StringUtils join builtIndexes stream map i i getIndexMetadata name collect Collectors toList Override public void onFailure Throwable ignored
private void executeAllBlocking Stream Index indexers Function Index Callable function FutureCallback Object callback if function null
Set SSTableReader builtSSTables new HashSet sstables size for SSTableReader sstable sstables if sstable isMarkedCompacted continue File indexFile new File sstable descriptor filenameFor columnIndex getComponent if indexFile exists continue if indexFile length builtSSTables add sstable continue SSTableIndex index null try index new SSTableIndex columnIndex indexFile sstable logger info columnIndex getColumnName columnIndex getValidator getString index minTerm columnIndex getValidator getString index maxTerm keyValidator getString index minKey keyValidator getString index maxKey index getSSTable if indexes add index builtSSTables add sstable else index release catch Throwable t
if indexOptions null indexOptions isEmpty return IndexMode NOT_INDEXED Mode mode try mode indexOptions get INDEX_MODE_OPTION null Mode PREFIX Mode mode indexOptions get INDEX_MODE_OPTION catch IllegalArgumentException e throw new ConfigurationException indexOptions get INDEX_MODE_OPTION boolean isAnalyzed false Class analyzerClass null try if indexOptions get INDEX_ANALYZER_CLASS_OPTION null analyzerClass Class forName indexOptions get INDEX_ANALYZER_CLASS_OPTION isAnalyzed indexOptions get INDEX_ANALYZED_OPTION null true Boolean parseBoolean indexOptions get INDEX_ANALYZED_OPTION else if indexOptions get INDEX_ANALYZED_OPTION null isAnalyzed Boolean parseBoolean indexOptions get INDEX_ANALYZED_OPTION catch ClassNotFoundException e
boolean isAnalyzed false Class analyzerClass null try if indexOptions get INDEX_ANALYZER_CLASS_OPTION null analyzerClass Class forName indexOptions get INDEX_ANALYZER_CLASS_OPTION isAnalyzed indexOptions get INDEX_ANALYZED_OPTION null true Boolean parseBoolean indexOptions get INDEX_ANALYZED_OPTION else if indexOptions get INDEX_ANALYZED_OPTION null isAnalyzed Boolean parseBoolean indexOptions get INDEX_ANALYZED_OPTION catch ClassNotFoundException e logger error indexOptions get INDEX_ANALYZER_CLASS_OPTION boolean isLiteral false try String literalOption indexOptions get INDEX_IS_LITERAL_OPTION AbstractType validator column cellValueType isLiteral literalOption null validator UTF8Type validator AsciiType Boolean parseBoolean literalOption
public OnDiskIndexBuilder add ByteBuffer term DecoratedKey key long keyPosition if term remaining MAX_TERM_SIZE
public long index DecoratedKey key ByteBuffer value if value null value remaining return AbstractType validator index columnIndex getValidator if TypeUtil isValid value validator int size value remaining if value TypeUtil tryUpcast value validator null
public long add DecoratedKey key ByteBuffer value AbstractAnalyzer analyzer columnIndex getAnalyzer analyzer reset value duplicate long size while analyzer hasNext ByteBuffer term analyzer next if term remaining OnDiskIndexBuilder MAX_TERM_SIZE
public boolean isSatisfiedBy ByteBuffer value if TypeUtil isValid value validator int size value remaining if value TypeUtil tryUpcast value validator null
public static boolean delete Descriptor desc Set Component components
public void run try FileUtils deleteRecursive path
public static Collection SSTableReader openAll Set Map Entry Descriptor Set Component entries final TableMetadataRef metadata final Collection SSTableReader sstables new LinkedBlockingQueue ExecutorService executor DebuggableThreadPoolExecutor createWithFixedPoolSize FBUtilities getAvailableProcessors for final Map Entry Descriptor Set Component entry entries Runnable runnable new Runnable public void run SSTableReader sstable try sstable open entry getKey entry getValue metadata catch CorruptSSTableException ex JVMStabilityInspector inspectThrowable ex logger error entry ex return catch FSError ex JVMStabilityInspector inspectThrowable ex
public static SSTableReader moveAndOpenSSTable ColumnFamilyStore cfs Descriptor oldDescriptor Descriptor newDescriptor Set Component components if oldDescriptor isCompatible throw new RuntimeException String format oldDescriptor getFormat getLatestVersion oldDescriptor boolean isLive cfs getLiveSSTables stream anyMatch r r descriptor equals newDescriptor r descriptor equals oldDescriptor if isLive String message String format oldDescriptor newDescriptor
boolean isLive cfs getLiveSSTables stream anyMatch r r descriptor equals newDescriptor r descriptor equals oldDescriptor if isLive String message String format oldDescriptor newDescriptor logger error message throw new RuntimeException message if new File newDescriptor filenameFor Component DATA exists String msg String format newDescriptor filenameFor Component DATA logger error msg throw new RuntimeException msg logger info oldDescriptor newDescriptor SSTableWriter rename oldDescriptor newDescriptor components SSTableReader reader try reader SSTableReader open newDescriptor components cfs metadata catch Throwable t
public RowIndexEntry append UnfilteredRowIterator iterator DecoratedKey key iterator partitionKey if key getKey remaining FBUtilities MAX_UNSIGNED_SHORT
public void writeComponent Component Type type DataInputPlus in long size
private void write AsyncStreamingInputPlus in long size SequentialWriter writer
private static boolean livenessCheck HashMap InetAddressAndPort String reloadedMap String reloadedDefaultDCRack Set InetAddressAndPort hosts Arrays equals defaultDCRack reloadedDefaultDCRack Sets intersection StorageService instance getLiveRingMembers Sets union endpointMap keySet reloadedMap keySet StorageService instance getLiveRingMembers for InetAddressAndPort host hosts String origValue endpointMap containsKey host endpointMap get host defaultDCRack String updateValue reloadedMap containsKey host reloadedMap get host reloadedDefaultDCRack if Arrays equals origValue updateValue
VisibleForTesting static void reconnect InetAddressAndPort publicAddress InetAddressAndPort localAddress IEndpointSnitch snitch String localDc if new OutboundConnectionSettings publicAddress localAddress withDefaults ConnectionCategory MESSAGING authenticate
private static ChannelFuture bind Initializer initializer throws ConfigurationException
ByteBuffer buf bytes get final int begin buf position final int end buf limit buf limit begin size Message message null try DataInputBuffer in new DataInputBuffer buf false Message m serializer deserialize in header version if in available throw new InvalidSerializedSizeException header verb size size in available message m catch IncompatibleSchemaException e callbacks onFailedDeserialize size header e noSpamLogger info this e catch Throwable t JVMStabilityInspector inspectThrowable t false callbacks onFailedDeserialize size header t
EventLoopGroup makeEventLoopGroup int threadCount String threadNamePrefix
static SslHandler newSslHandler Channel channel SslContext sslContext Nullable InetSocketAddress peer if peer null return sslContext newHandler channel alloc
for String datacenter datacenterToPeers keys dcToRemainingPeers put datacenter new CountDownLatch Math max datacenterToPeers get datacenter size long startNanos System nanoTime Set InetAddressAndPort alivePeers Collections newSetFromMap new ConcurrentHashMap AliveListener listener new AliveListener alivePeers dcToRemainingPeers acks peerToDatacenter :: get Gossiper instance register listener sendPingMessages peers dcToRemainingPeers acks peerToDatacenter :: get for InetAddressAndPort peer peers if Gossiper instance isAlive peer alivePeers add peer acks incrementAndCheck peer String datacenter peerToDatacenter get peer if dcToRemainingPeers containsKey datacenter dcToRemainingPeers get datacenter countDown boolean succeeded true for CountDownLatch countDownLatch dcToRemainingPeers values long remainingNanos Math max timeoutNanos System nanoTime startNanos succeeded Uninterruptibles awaitUninterruptibly countDownLatch remainingNanos TimeUnit NANOSECONDS
Override protected void startSync InetAddressAndPort remote nodePair peer String message String format rangesToSync size remote
public void onSuccess StreamState result String message String format desc sessionId nodePair coordinator nodePair peer desc columnFamily
for InetAddressAndPort endpoint allEndpoints SnapshotTask snapshotTask new SnapshotTask desc endpoint snapshotTasks add snapshotTask taskExecutor execute snapshotTask allSnapshotTasks Futures allAsList snapshotTasks validations Futures transformAsync allSnapshotTasks new AsyncFunction List InetAddressAndPort List TreeResponse public ListenableFuture List TreeResponse apply List InetAddressAndPort endpoints if parallelismDegree RepairParallelism SEQUENTIAL return sendSequentialValidationRequest endpoints else return sendDCAwareValidationRequest endpoints taskExecutor else validations sendValidationRequest allEndpoints ListenableFuture List SyncStat syncResults Futures transformAsync validations session optimiseStreams session pullRepair this :: optimisedSyncing this :: standardSyncing taskExecutor Futures addCallback syncResults new FutureCallback List SyncStat public void onSuccess List SyncStat stats
TreeResponse self r1 endpoint equals local r1 r2 TreeResponse remote r2 endpoint equals local r1 r2 boolean requestRanges isTransient test self endpoint boolean transferRanges isTransient test remote endpoint pullRepair if requestRanges transferRanges continue task new LocalSyncTask desc self endpoint remote endpoint differences isIncremental desc parentSessionId null requestRanges transferRanges previewKind else if isTransient test r1 endpoint isTransient test r2 endpoint TreeResponse streamFrom isTransient test r1 endpoint r1 r2 TreeResponse streamTo isTransient test r1 endpoint r2 r1 task new AsymmetricRemoteSyncTask desc streamTo endpoint streamFrom endpoint differences previewKind else task new SymmetricRemoteSyncTask desc r1 endpoint r2 endpoint differences previewKind syncTasks add task trees get i trees release trees get trees size trees release
private ListenableFuture List TreeResponse sendValidationRequest Collection InetAddressAndPort endpoints String message String format desc columnFamily endpoints
private ListenableFuture List TreeResponse sendSequentialValidationRequest Collection InetAddressAndPort endpoints String message String format desc columnFamily endpoints
private ListenableFuture List TreeResponse sendSequentialValidationRequest Collection InetAddressAndPort endpoints String message String format desc columnFamily endpoints logger info session previewKind logPrefix desc sessionId message Tracing traceRepair message int nowInSec getNowInSeconds List ListenableFuture TreeResponse tasks new ArrayList endpoints size Queue InetAddressAndPort requests new LinkedList endpoints InetAddressAndPort address requests poll ValidationTask firstTask new ValidationTask desc address nowInSec session previewKind
int nowInSec getNowInSeconds List ListenableFuture TreeResponse tasks new ArrayList endpoints size Queue InetAddressAndPort requests new LinkedList endpoints InetAddressAndPort address requests poll ValidationTask firstTask new ValidationTask desc address nowInSec session previewKind logger info session previewKind logPrefix desc sessionId address session trackValidationCompletion Pair create desc address firstTask tasks add firstTask ValidationTask currentTask firstTask while requests size final InetAddressAndPort nextAddress requests poll final ValidationTask nextTask new ValidationTask desc nextAddress nowInSec session previewKind tasks add nextTask Futures addCallback currentTask new FutureCallback TreeResponse public void onSuccess TreeResponse result
private ListenableFuture List TreeResponse sendDCAwareValidationRequest Collection InetAddressAndPort endpoints String message String format desc columnFamily endpoints
Tracing traceRepair message int nowInSec getNowInSeconds List ListenableFuture TreeResponse tasks new ArrayList endpoints size Map String Queue InetAddressAndPort requestsByDatacenter new HashMap for InetAddressAndPort endpoint endpoints String dc DatabaseDescriptor getEndpointSnitch getDatacenter endpoint Queue InetAddressAndPort queue requestsByDatacenter get dc if queue null queue new LinkedList requestsByDatacenter put dc queue queue add endpoint for Map Entry String Queue InetAddressAndPort entry requestsByDatacenter entrySet Queue InetAddressAndPort requests entry getValue InetAddressAndPort address requests poll ValidationTask firstTask new ValidationTask desc address nowInSec session previewKind
queue add endpoint for Map Entry String Queue InetAddressAndPort entry requestsByDatacenter entrySet Queue InetAddressAndPort requests entry getValue InetAddressAndPort address requests poll ValidationTask firstTask new ValidationTask desc address nowInSec session previewKind logger info session previewKind logPrefix session getId address session trackValidationCompletion Pair create desc address firstTask tasks add firstTask ValidationTask currentTask firstTask while requests size final InetAddressAndPort nextAddress requests poll final ValidationTask nextTask new ValidationTask desc nextAddress nowInSec session previewKind tasks add nextTask Futures addCallback currentTask new FutureCallback TreeResponse public void onSuccess TreeResponse result
public void doVerb final Message RepairMessage message RepairJobDesc desc message payload desc try switch message verb case PREPARE_MSG PrepareMessage prepareMessage PrepareMessage message payload
columnFamilyStores add columnFamilyStore ActiveRepairService instance registerParentRepairSession prepareMessage parentRepairSession message from columnFamilyStores prepareMessage ranges prepareMessage isIncremental prepareMessage timestamp prepareMessage isGlobal prepareMessage previewKind MessagingService instance send message emptyResponse message from break case SNAPSHOT_MSG logger debug desc final ColumnFamilyStore cfs ColumnFamilyStore getIfExists desc keyspace desc columnFamily if cfs null logErrorAndSendFailureResponse String format desc keyspace desc columnFamily desc parentSessionId message return ActiveRepairService ParentRepairSession prs ActiveRepairService instance getParentRepairSession desc parentSessionId TableRepairManager repairManager cfs getRepairManager if prs isGlobal repairManager snapshot desc parentSessionId toString prs getRanges false else repairManager snapshot desc parentSessionId toString desc ranges true
case SNAPSHOT_MSG logger debug desc final ColumnFamilyStore cfs ColumnFamilyStore getIfExists desc keyspace desc columnFamily if cfs null logErrorAndSendFailureResponse String format desc keyspace desc columnFamily desc parentSessionId message return ActiveRepairService ParentRepairSession prs ActiveRepairService instance getParentRepairSession desc parentSessionId TableRepairManager repairManager cfs getRepairManager if prs isGlobal repairManager snapshot desc parentSessionId toString prs getRanges false else repairManager snapshot desc parentSessionId toString desc ranges true logger debug desc sessionId message from MessagingService instance send message emptyResponse message from break case VALIDATION_REQ ValidationRequest validationRequest ValidationRequest message payload
private void logErrorAndSendFailureResponse String errorMessage Message respondTo
public void notification String msg
public void notifyError Throwable error if error SomeRepairFailedException return
private void notifyStarting String message String format cmd parentSession keyspace options
private void normalRepair UUID parentSession long startTime TraceState traceState List CommonRange commonRanges String cfnames ListeningExecutorService executor createExecutor final ListenableFuture List RepairSessionResult allSessions submitRepairSessions parentSession false executor commonRanges cfnames final Collection Range Token successfulRanges new ArrayList final AtomicBoolean hasFailure new AtomicBoolean ListenableFuture repairResult Futures transformAsync allSessions new AsyncFunction List RepairSessionResult Object SuppressWarnings public ListenableFuture apply List RepairSessionResult results for RepairSessionResult sessionResult results
private void previewRepair UUID parentSession long startTime List CommonRange commonRanges String cfnames
return PreviewKind previewKind options getPreviewKind Preconditions checkState previewKind PreviewKind NONE SyncStatSummary summary new SyncStatSummary true summary consumeSessionResults results final String message if summary isEmpty message previewKind PreviewKind REPAIRED else message previewKind PreviewKind REPAIRED summary toString RepairMetrics previewFailures inc if previewKind PreviewKind REPAIRED maybeSnapshotReplicas parentSession keyspace results notification message success catch Throwable t
try Set String mismatchingTables new HashSet Set InetAddressAndPort nodes new HashSet for RepairSessionResult sessionResult results for RepairResult repairResult emptyIfNull sessionResult repairJobResults for SyncStat stat emptyIfNull repairResult stats if stat numberOfDifferences mismatchingTables add repairResult desc columnFamily nodes add stat nodes coordinator nodes add stat nodes peer String snapshotName DiagnosticSnapshotService getSnapshotName DiagnosticSnapshotService REPAIRED_DATA_MISMATCH_SNAPSHOT_PREFIX for String table mismatchingTables if Keyspace open keyspace getColumnFamilyStore table snapshotExists snapshotName logger info options getPreviewKind logPrefix parentSession keyspace table snapshotName nodes DiagnosticSnapshotService repairedDataMismatch Keyspace open keyspace getColumnFamilyStore table metadata nodes else
Set InetAddressAndPort nodes new HashSet for RepairSessionResult sessionResult results for RepairResult repairResult emptyIfNull sessionResult repairJobResults for SyncStat stat emptyIfNull repairResult stats if stat numberOfDifferences mismatchingTables add repairResult desc columnFamily nodes add stat nodes coordinator nodes add stat nodes peer String snapshotName DiagnosticSnapshotService getSnapshotName DiagnosticSnapshotService REPAIRED_DATA_MISMATCH_SNAPSHOT_PREFIX for String table mismatchingTables if Keyspace open keyspace getColumnFamilyStore table snapshotExists snapshotName logger info options getPreviewKind logPrefix parentSession keyspace table snapshotName nodes DiagnosticSnapshotService repairedDataMismatch Keyspace open keyspace getColumnFamilyStore table metadata nodes else logger info options getPreviewKind logPrefix parentSession keyspace table snapshotName catch Exception e
private ListenableFuture List RepairSessionResult submitRepairSessions UUID parentSession boolean isIncremental ListeningExecutorService executor List CommonRange commonRanges String cfnames List ListenableFuture RepairSessionResult futures new ArrayList options getRanges size boolean force options isForcedRepair isIncremental for CommonRange commonRange commonRanges
if terminated return logger info previewKind logPrefix getId parentRepairSession repairedNodes commonRange keyspace Arrays toString cfnames Tracing traceRepair commonRange if previewKind isPreview SystemDistributedKeyspace startRepairs getId parentRepairSession keyspace cfnames commonRange if commonRange endpoints isEmpty logger info previewKind logPrefix getId message String format commonRange Tracing traceRepair message set new RepairSessionResult id keyspace commonRange ranges Lists RepairResult newArrayList skippedReplicas if previewKind isPreview SystemDistributedKeyspace failRepairs getId keyspace cfnames new RuntimeException message return for InetAddressAndPort endpoint commonRange endpoints if FailureDetector instance isAlive endpoint skippedReplicas message String format endpoint
public void convict InetAddressAndPort endpoint double phi if commonRange endpoints contains endpoint return if phi DatabaseDescriptor getPhiConvictThreshold return if isFailed compareAndSet false true return Exception exception new IOException String format endpoint
public void onIRStateChange LocalSession session if previewKind PreviewKind REPAIRED session getState ConsistentSession State FINALIZED includesTables session tableIds for Range Token range session ranges if range intersects ranges
Override protected void startSync InetAddressAndPort local FBUtilities getBroadcastAddressAndPort SyncRequest request new SyncRequest desc local nodePair coordinator nodePair peer rangesToSync previewKind Preconditions checkArgument nodePair coordinator equals request src String message String format request ranges size request src request dst
public final void run startTime System currentTimeMillis String format String format previewKind logPrefix desc sessionId nodePair coordinator nodePair peer desc columnFamily if rangesToSync isEmpty
try validator prepare cfs tree while vi hasNext try UnfilteredRowIterator partition vi next validator add partition partitionCount validator complete finally estimatedTotalBytes vi getEstimatedBytes partitionCount vi estimatedPartitions finally cfs metric bytesValidated update estimatedTotalBytes cfs metric partitionsValidated update partitionCount if logger isDebugEnabled long duration TimeUnit NANOSECONDS toMillis System nanoTime start
public ListenableFuture execute Supplier ListenableFuture List RepairSessionResult sessionSubmitter AtomicBoolean hasFailure logger info sessionID sessionStart System currentTimeMillis ListenableFuture Boolean prepareResult prepare ListenableFuture List RepairSessionResult repairSessionResults Futures transformAsync prepareResult new AsyncFunction Boolean List RepairSessionResult public ListenableFuture List RepairSessionResult apply Boolean success throws Exception if success repairStart System currentTimeMillis if logger isDebugEnabled
public ListenableFuture List RepairSessionResult apply Boolean success throws Exception if success repairStart System currentTimeMillis if logger isDebugEnabled logger debug sessionID formatDuration sessionStart repairStart setRepairing return sessionSubmitter get else return Futures immediateFuture null MoreExecutors directExecutor ListenableFuture Boolean proposeFuture Futures transformAsync repairSessionResults new AsyncFunction List RepairSessionResult Boolean public ListenableFuture Boolean apply List RepairSessionResult results throws Exception if results null results isEmpty Iterables any results r r null finalizeStart System currentTimeMillis if logger isDebugEnabled
MoreExecutors directExecutor ListenableFuture Boolean proposeFuture Futures transformAsync repairSessionResults new AsyncFunction List RepairSessionResult Boolean public ListenableFuture Boolean apply List RepairSessionResult results throws Exception if results null results isEmpty Iterables any results r r null finalizeStart System currentTimeMillis if logger isDebugEnabled logger debug sessionID formatDuration repairStart finalizeStart return Futures immediateFailedFuture SomeRepairFailedException INSTANCE else return finalizePropose MoreExecutors directExecutor SettableFuture Boolean resultFuture SettableFuture create Futures addCallback proposeFuture new FutureCallback Boolean public void onSuccess Nullable Boolean result try
MoreExecutors directExecutor ListenableFuture Boolean proposeFuture Futures transformAsync repairSessionResults new AsyncFunction List RepairSessionResult Boolean public ListenableFuture Boolean apply List RepairSessionResult results throws Exception if results null results isEmpty Iterables any results r r null finalizeStart System currentTimeMillis if logger isDebugEnabled logger debug sessionID formatDuration repairStart finalizeStart return Futures immediateFailedFuture SomeRepairFailedException INSTANCE else return finalizePropose MoreExecutors directExecutor SettableFuture Boolean resultFuture SettableFuture create Futures addCallback proposeFuture new FutureCallback Boolean public void onSuccess Nullable Boolean result try
else return finalizePropose MoreExecutors directExecutor SettableFuture Boolean resultFuture SettableFuture create Futures addCallback proposeFuture new FutureCallback Boolean public void onSuccess Nullable Boolean result try if result null result if logger isDebugEnabled logger debug sessionID formatDuration finalizeStart System currentTimeMillis finalizeCommit if logger isDebugEnabled logger debug sessionID formatDuration sessionStart System currentTimeMillis else hasFailure set true
public void cancelSession UUID sessionID boolean force
logger trace if isNodeInitialized logger trace return Set LocalSession currentSessions new HashSet sessions values for LocalSession session currentSessions synchronized session int now FBUtilities nowInSeconds if shouldFail session now logger warn session failSession session sessionID false else if shouldDelete session now if session getState FINALIZED isSuperseded session logger info session sessionID else if sessionHasData session
public void failSession UUID sessionID boolean sendMessage LocalSession session getSession sessionID if session null synchronized session if session getState FAILED
public synchronized void deleteSession UUID sessionID
parentSession getParentRepairSession sessionID catch Throwable e logger error sessionID sendMessage coordinator Message out PREPARE_CONSISTENT_RSP new PrepareConsistentResponse sessionID getBroadcastAddressAndPort false return LocalSession session createSessionUnsafe sessionID parentSession peers putSessionUnsafe session logger info session ExecutorService executor Executors newFixedThreadPool parentSession getColumnFamilyStores size KeyspaceRepairManager repairManager parentSession getKeyspace getRepairManager RangesAtEndpoint tokenRanges filterLocalRanges parentSession getKeyspace getName parentSession getRanges ListenableFuture repairPreparation prepareSession repairManager sessionID parentSession getColumnFamilyStores tokenRanges executor session getState PREPARING Futures addCallback repairPreparation new FutureCallback Object public void onSuccess Nullable Object result try
logger info session ExecutorService executor Executors newFixedThreadPool parentSession getColumnFamilyStores size KeyspaceRepairManager repairManager parentSession getKeyspace getRepairManager RangesAtEndpoint tokenRanges filterLocalRanges parentSession getKeyspace getName parentSession getRanges ListenableFuture repairPreparation prepareSession repairManager sessionID parentSession getColumnFamilyStores tokenRanges executor session getState PREPARING Futures addCallback repairPreparation new FutureCallback Object public void onSuccess Nullable Object result try logger info sessionID if session getState FAILED setStateAndSave session PREPARED else logger info sessionID Message PrepareConsistentResponse message Message out PREPARE_CONSISTENT_RSP new PrepareConsistentResponse sessionID getBroadcastAddressAndPort session getState FAILED sendMessage coordinator message finally executor shutdown
public void maybeSetRepairing UUID sessionID LocalSession session getSession sessionID if session null session getState REPAIRING
public void handleFinalizeProposeMessage InetAddressAndPort from FinalizePropose propose logger trace propose from UUID sessionID propose sessionID LocalSession session getSession sessionID if session null
public void sendStatusRequest LocalSession session
private static void maybeScheduleSchemaPull final UUID theirVersion final InetAddressAndPort endpoint String releaseVersion String ourMajorVersion FBUtilities getReleaseVersionMajor if releaseVersion startsWith ourMajorVersion
logger debug ourMajorVersion releaseVersion return if Schema instance getVersion null logger debug endpoint SchemaMigrationDiagnostics unknownLocalSchemaVersion endpoint theirVersion return if Schema instance isSameVersion theirVersion logger debug endpoint Schema schemaVersionToString theirVersion SchemaMigrationDiagnostics versionMatch endpoint theirVersion return if shouldPullSchemaFrom endpoint logger debug endpoint Schema instance getVersion theirVersion SchemaMigrationDiagnostics skipPull endpoint theirVersion return if Schema instance isEmpty runtimeMXBean getUptime MIGRATION_DELAY_IN_MS
return if Schema instance isSameVersion theirVersion logger debug endpoint Schema schemaVersionToString theirVersion SchemaMigrationDiagnostics versionMatch endpoint theirVersion return if shouldPullSchemaFrom endpoint logger debug endpoint Schema instance getVersion theirVersion SchemaMigrationDiagnostics skipPull endpoint theirVersion return if Schema instance isEmpty runtimeMXBean getUptime MIGRATION_DELAY_IN_MS logger debug endpoint Schema schemaVersionToString Schema instance getVersion Schema schemaVersionToString theirVersion submitMigrationTask endpoint else Runnable runnable UUID epSchemaVersion Gossiper instance getSchemaVersion endpoint
logger debug endpoint Schema schemaVersionToString theirVersion SchemaMigrationDiagnostics versionMatch endpoint theirVersion return if shouldPullSchemaFrom endpoint logger debug endpoint Schema instance getVersion theirVersion SchemaMigrationDiagnostics skipPull endpoint theirVersion return if Schema instance isEmpty runtimeMXBean getUptime MIGRATION_DELAY_IN_MS logger debug endpoint Schema schemaVersionToString Schema instance getVersion Schema schemaVersionToString theirVersion submitMigrationTask endpoint else Runnable runnable UUID epSchemaVersion Gossiper instance getSchemaVersion endpoint if epSchemaVersion null logger debug endpoint
if shouldPullSchemaFrom endpoint logger debug endpoint Schema instance getVersion theirVersion SchemaMigrationDiagnostics skipPull endpoint theirVersion return if Schema instance isEmpty runtimeMXBean getUptime MIGRATION_DELAY_IN_MS logger debug endpoint Schema schemaVersionToString Schema instance getVersion Schema schemaVersionToString theirVersion submitMigrationTask endpoint else Runnable runnable UUID epSchemaVersion Gossiper instance getSchemaVersion endpoint if epSchemaVersion null logger debug endpoint return if Schema instance isSameVersion epSchemaVersion logger debug endpoint epSchemaVersion
public static void announceNewKeyspace KeyspaceMetadata ksm long timestamp boolean announceLocally throws ConfigurationException ksm validate if Schema instance getKeyspaceMetadata ksm name null throw new AlreadyExistsException ksm name
private static void announceNewTable TableMetadata cfm boolean throwOnDuplicate long timestamp cfm validate KeyspaceMetadata ksm Schema instance getKeyspaceMetadata cfm keyspace if ksm null throw new ConfigurationException String format cfm name cfm keyspace else if throwOnDuplicate ksm getTableOrViewNullable cfm name null throw new AlreadyExistsException cfm keyspace cfm name
static void announceKeyspaceUpdate KeyspaceMetadata ksm ksm validate KeyspaceMetadata oldKsm Schema instance getKeyspaceMetadata ksm name if oldKsm null throw new ConfigurationException String format ksm name
public static void announceTableUpdate TableMetadata updated boolean announceLocally updated validate TableMetadata current Schema instance getTableMetadata updated keyspace updated name if current null throw new ConfigurationException String format updated name updated keyspace KeyspaceMetadata ksm Schema instance getKeyspaceMetadata current keyspace updated validateCompatibility current long timestamp FBUtilities timestampMicros
static void announceKeyspaceDrop String ksName KeyspaceMetadata oldKsm Schema instance getKeyspaceMetadata ksName if oldKsm null throw new ConfigurationException String format ksName
public static void announceTableDrop String ksName String cfName boolean announceLocally TableMetadata tm Schema instance getTableMetadata ksName cfName if tm null throw new ConfigurationException String format cfName ksName KeyspaceMetadata ksm Schema instance getKeyspaceMetadata ksName
public static void resetLocalSchema logger info logger debug SchemaMigrationDiagnostics resetLocalSchema SchemaKeyspace truncate logger debug Schema instance clear Set InetAddressAndPort liveEndpoints Gossiper instance getLiveMembers liveEndpoints remove FBUtilities getBroadcastAddressAndPort for InetAddressAndPort node liveEndpoints if shouldPullSchemaFrom node
public void runMayThrow throws Exception if FailureDetector instance isAlive endpoint logger warn endpoint SchemaMigrationDiagnostics taskSendAborted endpoint return if MigrationManager shouldPullSchemaFrom endpoint logger info endpoint SchemaMigrationDiagnostics taskSendAborted endpoint return Message message Message out SCHEMA_PULL_REQ noPayload final CountDownLatch completionLatch new CountDownLatch RequestCallback Collection Mutation cb msg try Schema instance mergeAndAnnounceVersion msg payload catch ConfigurationException e
List AbstractType argTypes new ArrayList for String type row getFrozenList UTF8Type instance argTypes add CQLTypeParser parse ksName type types AbstractType returnType CQLTypeParser parse ksName row getString types String language row getString String body row getString boolean calledOnNullInput row getBoolean org apache cassandra cql3 functions Function existing Schema instance findFunction name argTypes orElse null if existing UDFunction UDFunction udf UDFunction existing if udf argNames equals argNames udf argTypes equals argTypes udf returnType equals returnType udf isAggregate udf language equals language udf body equals body udf isCalledOnNullInput calledOnNullInput logger trace name return udf try return UDFunction create name argNames argTypes returnType calledOnNullInput language body catch InvalidRequestException e
public static boolean verifyCompactionsPendingThreshold UUID parentRepairSession PreviewKind previewKind int pendingCompactions CompactionManager instance getPendingTasks int pendingThreshold ActiveRepairService instance getRepairPendingCompactionRejectThreshold if pendingCompactions pendingThreshold
private AutoSavingCache CounterCacheKey ClockAndCount initCounterCache logger info DatabaseDescriptor getCounterCacheSizeInMB long capacity DatabaseDescriptor getCounterCacheSizeInMB AutoSavingCache CounterCacheKey ClockAndCount cache new AutoSavingCache CaffeineCache create capacity CacheType COUNTER_CACHE new CounterCacheSerializer int keysToSave DatabaseDescriptor getCounterCacheKeysToSave
try startupChecks verify catch StartupException e exitOrFail e returnCode e getMessage e getCause try SystemKeyspace snapshotOnVersionChange catch IOException e exitOrFail e getMessage e getCause SystemKeyspace persistLocalMetadata Thread setDefaultUncaughtExceptionHandler CassandraDaemon :: uncaughtException SystemKeyspaceMigrator40 migrate StorageService instance populateTokenMetadata try Schema instance loadFromDisk catch Exception e
VisibleForTesting public static void uncaughtException Thread t Throwable e StorageMetrics uncaughtExceptions inc
public static RangesByEndpoint calculateRangesToStreamWithEndpoints RangesAtEndpoint streamRanges AbstractReplicationStrategy strat TokenMetadata tmdBefore TokenMetadata tmdAfter RangesByEndpoint Builder endpointRanges new RangesByEndpoint Builder for Replica toStream streamRanges EndpointsForRange oldEndpoints strat calculateNaturalReplicas toStream range right tmdBefore EndpointsForRange newEndpoints strat calculateNaturalReplicas toStream range right tmdAfter
public void calculateToFromStreams logger debug tokenMetaClone tokenMetaCloneAllSettled for String keyspace keyspaceNames AbstractReplicationStrategy strategy Keyspace open keyspace getReplicationStrategy
for String keyspace keyspaceNames AbstractReplicationStrategy strategy Keyspace open keyspace getReplicationStrategy logger info keyspace for Token newToken tokens Collection Token currentTokens tokenMetaClone getTokens localAddress if currentTokens size currentTokens isEmpty throw new AssertionError currentTokens Pair RangesAtEndpoint RangesAtEndpoint streamAndFetchOwnRanges if tokenMetaClone getTopology getDatacenterEndpoints get DatabaseDescriptor getEndpointSnitch getLocalDatacenter size RangesAtEndpoint currentReplicas strategy getAddressReplicas localAddress RangesAtEndpoint updatedReplicas strategy getPendingAddressRanges tokenMetaClone newToken localAddress streamAndFetchOwnRanges calculateStreamAndFetchRanges currentReplicas updatedReplicas else streamAndFetchOwnRanges Pair create RangesAtEndpoint empty localAddress RangesAtEndpoint empty localAddress RangesByEndpoint rangesToStream calculateRangesToStreamWithEndpoints streamAndFetchOwnRanges left strategy tokenMetaClone tokenMetaCloneAllSettled
logger info keyspace for Token newToken tokens Collection Token currentTokens tokenMetaClone getTokens localAddress if currentTokens size currentTokens isEmpty throw new AssertionError currentTokens Pair RangesAtEndpoint RangesAtEndpoint streamAndFetchOwnRanges if tokenMetaClone getTopology getDatacenterEndpoints get DatabaseDescriptor getEndpointSnitch getLocalDatacenter size RangesAtEndpoint currentReplicas strategy getAddressReplicas localAddress RangesAtEndpoint updatedReplicas strategy getPendingAddressRanges tokenMetaClone newToken localAddress streamAndFetchOwnRanges calculateStreamAndFetchRanges currentReplicas updatedReplicas else streamAndFetchOwnRanges Pair create RangesAtEndpoint empty localAddress RangesAtEndpoint empty localAddress RangesByEndpoint rangesToStream calculateRangesToStreamWithEndpoints streamAndFetchOwnRanges left strategy tokenMetaClone tokenMetaCloneAllSettled logger info rangesToStream for InetAddressAndPort address rangesToStream keySet
if tokenMetaClone getTopology getDatacenterEndpoints get DatabaseDescriptor getEndpointSnitch getLocalDatacenter size RangesAtEndpoint currentReplicas strategy getAddressReplicas localAddress RangesAtEndpoint updatedReplicas strategy getPendingAddressRanges tokenMetaClone newToken localAddress streamAndFetchOwnRanges calculateStreamAndFetchRanges currentReplicas updatedReplicas else streamAndFetchOwnRanges Pair create RangesAtEndpoint empty localAddress RangesAtEndpoint empty localAddress RangesByEndpoint rangesToStream calculateRangesToStreamWithEndpoints streamAndFetchOwnRanges left strategy tokenMetaClone tokenMetaCloneAllSettled logger info rangesToStream for InetAddressAndPort address rangesToStream keySet logger debug rangesToStream get address keyspace address RangesAtEndpoint ranges rangesToStream get address streamPlan transferRanges address keyspace ranges Multimap InetAddressAndPort RangeStreamer FetchReplica rangesToFetch calculateRangesToFetchWithPreferredEndpoints streamAndFetchOwnRanges right strategy keyspace tokenMetaClone tokenMetaCloneAllSettled rangesToFetch asMap forEach address sourceAndOurReplicas RangesAtEndpoint full sourceAndOurReplicas stream filter pair pair remote isFull map pair pair local collect RangesAtEndpoint collector localAddress
streamAndFetchOwnRanges calculateStreamAndFetchRanges currentReplicas updatedReplicas else streamAndFetchOwnRanges Pair create RangesAtEndpoint empty localAddress RangesAtEndpoint empty localAddress RangesByEndpoint rangesToStream calculateRangesToStreamWithEndpoints streamAndFetchOwnRanges left strategy tokenMetaClone tokenMetaCloneAllSettled logger info rangesToStream for InetAddressAndPort address rangesToStream keySet logger debug rangesToStream get address keyspace address RangesAtEndpoint ranges rangesToStream get address streamPlan transferRanges address keyspace ranges Multimap InetAddressAndPort RangeStreamer FetchReplica rangesToFetch calculateRangesToFetchWithPreferredEndpoints streamAndFetchOwnRanges right strategy keyspace tokenMetaClone tokenMetaCloneAllSettled rangesToFetch asMap forEach address sourceAndOurReplicas RangesAtEndpoint full sourceAndOurReplicas stream filter pair pair remote isFull map pair pair local collect RangesAtEndpoint collector localAddress RangesAtEndpoint trans sourceAndOurReplicas stream filter pair pair remote isTransient map pair pair local collect RangesAtEndpoint collector localAddress logger debug rangesToFetch get address keyspace address streamPlan requestRanges address keyspace full trans
public static Pair RangesAtEndpoint RangesAtEndpoint calculateStreamAndFetchRanges RangesAtEndpoint currentRanges RangesAtEndpoint updatedRanges RangesAtEndpoint Builder toStream RangesAtEndpoint builder currentRanges endpoint RangesAtEndpoint Builder toFetch RangesAtEndpoint builder currentRanges endpoint logger debug computeRanges currentRanges updatedRanges toStream logger debug computeRanges updatedRanges currentRanges toFetch
public static Pair RangesAtEndpoint RangesAtEndpoint calculateStreamAndFetchRanges RangesAtEndpoint currentRanges RangesAtEndpoint updatedRanges RangesAtEndpoint Builder toStream RangesAtEndpoint builder currentRanges endpoint RangesAtEndpoint Builder toFetch RangesAtEndpoint builder currentRanges endpoint logger debug computeRanges currentRanges updatedRanges toStream logger debug computeRanges updatedRanges currentRanges toFetch logger debug toStream
ReplicaPlan ForTokenWrite replicaPlan ReplicaPlans forLocalBatchlogWrite BatchlogCleanup cleanup new BatchlogCleanup mutations size asyncRemoveFromBatchlog replicaPlan batchUUID for Mutation mutation mutations String keyspaceName mutation getKeyspaceName Token tk mutation key getToken Optional Replica pairedEndpoint ViewUtils getViewNaturalEndpoint keyspaceName baseToken tk EndpointsForToken pendingReplicas StorageService instance getTokenMetadata pendingEndpointsForToken tk keyspaceName if pairedEndpoint isPresent if pendingReplicas isEmpty logger warn mutation key continue if pairedEndpoint get isSelf StorageService instance isJoined pendingReplicas isEmpty try mutation apply writeCommitLog nonLocalMutations remove mutation cleanup ackMutation
public static void truncateBlocking String keyspace String cfname throws UnavailableException TimeoutException
private static int getRingDelay String newdelay System getProperty if newdelay null
private synchronized UUID prepareForReplacement throws ConfigurationException if SystemKeyspace bootstrapComplete throw new RuntimeException if joinRing throw new ConfigurationException if DatabaseDescriptor isAutoBootstrap Boolean getBoolean throw new RuntimeException InetAddressAndPort replaceAddress DatabaseDescriptor getReplaceAddress
public void populateTokenMetadata if Boolean parseBoolean System getProperty logger info Multimap InetAddressAndPort Token loadedTokens SystemKeyspace loadTokens if shouldBootstrap loadedTokens putAll FBUtilities getBroadcastAddressAndPort SystemKeyspace getSavedTokens for InetAddressAndPort ep loadedTokens keySet tokenMetadata updateNormalTokens loadedTokens get ep ep
public void setRpcTimeout long value DatabaseDescriptor setRpcTimeout value
public void setReadRpcTimeout long value DatabaseDescriptor setReadRpcTimeout value
public void setRangeRpcTimeout long value DatabaseDescriptor setRangeRpcTimeout value
public void setWriteRpcTimeout long value DatabaseDescriptor setWriteRpcTimeout value
public void setInternodeTcpConnectTimeoutInMS int value DatabaseDescriptor setInternodeTcpConnectTimeoutInMS value
public void setInternodeTcpUserTimeoutInMS int value DatabaseDescriptor setInternodeTcpUserTimeoutInMS value
public void setCounterWriteRpcTimeout long value DatabaseDescriptor setCounterWriteRpcTimeout value
public void setCasContentionTimeout long value DatabaseDescriptor setCasContentionTimeout value
public void setTruncateRpcTimeout long value DatabaseDescriptor setTruncateRpcTimeout value
public void setStreamThroughputMbPerSec int value DatabaseDescriptor setStreamThroughputOutboundMegabitsPerSec value
public void setInterDCStreamThroughputMbPerSec int value DatabaseDescriptor setInterDCStreamThroughputOutboundMegabitsPerSec value
public void setConcurrentValidators int value int concurrentCompactors DatabaseDescriptor getConcurrentCompactors if value concurrentCompactors DatabaseDescriptor allowUnlimitedConcurrentValidations throw new IllegalArgumentException String format concurrentCompactors if value
else tokenMetadata updateNormalTokens tokens FBUtilities getBroadcastAddressAndPort SystemKeyspace removeEndpoint DatabaseDescriptor getReplaceAddress if Gossiper instance seenAnySeed throw new IllegalStateException if Boolean getBoolean logger info SystemKeyspace resetAvailableRanges invalidateDiskBoundaries setMode Mode JOINING true BootStrapper bootstrapper new BootStrapper FBUtilities getBroadcastAddressAndPort tokens tokenMetadata bootstrapper addProgressListener progressSupport ListenableFuture StreamState bootstrapStream bootstrapper bootstrap streamStateStore useStrictConsistency replacing try bootstrapStream get bootstrapFinished
progressSupport progress ProgressEvent createNotification finishJoiningRing true bootstrapTokens progressSupport progress new ProgressEvent ProgressEventType COMPLETE if isNativeTransportRunning daemon initializeNativeTransport daemon start logger info catch Exception e onFailure e throw e Override public void onFailure Throwable e String message if e ExecutionException e getCause null message e getCause getMessage else message e getMessage
case VersionedValue STATUS_NORMAL handleStateNormal endpoint VersionedValue STATUS_NORMAL break case VersionedValue SHUTDOWN handleStateNormal endpoint VersionedValue SHUTDOWN break case VersionedValue REMOVING_TOKEN case VersionedValue REMOVED_TOKEN handleStateRemoving endpoint pieces break case VersionedValue STATUS_LEAVING handleStateLeaving endpoint break case VersionedValue STATUS_LEFT handleStateLeft endpoint pieces break case VersionedValue STATUS_MOVING handleStateMoving endpoint pieces break else EndpointState epState Gossiper instance getEndpointStateForEndpoint endpoint if epState null Gossiper instance isDeadState epState
private void ensureUpToDateTokenMetadata String status InetAddressAndPort endpoint Set Token tokens new TreeSet getTokensFor endpoint if logger isDebugEnabled logger debug endpoint status tokens if tokenMetadata isMember endpoint
private void updateTokenMetadata InetAddressAndPort endpoint Iterable Token tokens Set InetAddressAndPort endpointsToRemove Set Token tokensToUpdateInMetadata new HashSet Set Token tokensToUpdateInSystemKeyspace new HashSet for final Token token tokens InetAddressAndPort currentOwner tokenMetadata getEndpoint token if currentOwner null
for final Token token tokens InetAddressAndPort currentOwner tokenMetadata getEndpoint token if currentOwner null logger debug endpoint token tokensToUpdateInMetadata add token tokensToUpdateInSystemKeyspace add token else if endpoint equals currentOwner tokensToUpdateInMetadata add token tokensToUpdateInSystemKeyspace add token else if Gossiper instance compareEndpointStartup endpoint currentOwner tokensToUpdateInMetadata add token tokensToUpdateInSystemKeyspace add token Multimap InetAddressAndPort Token epToTokenCopy getTokenMetadata getEndpointToTokenMapForReading epToTokenCopy get currentOwner remove token if epToTokenCopy get currentOwner isEmpty endpointsToRemove add currentOwner
if currentOwner null logger debug endpoint token tokensToUpdateInMetadata add token tokensToUpdateInSystemKeyspace add token else if endpoint equals currentOwner tokensToUpdateInMetadata add token tokensToUpdateInSystemKeyspace add token else if Gossiper instance compareEndpointStartup endpoint currentOwner tokensToUpdateInMetadata add token tokensToUpdateInSystemKeyspace add token Multimap InetAddressAndPort Token epToTokenCopy getTokenMetadata getEndpointToTokenMapForReading epToTokenCopy get currentOwner remove token if epToTokenCopy get currentOwner isEmpty endpointsToRemove add currentOwner logger info endpoint currentOwner token endpoint else
private void excise Collection Token tokens InetAddressAndPort endpoint
private void restoreReplicaCount InetAddressAndPort endpoint final InetAddressAndPort notifyEndpoint Map String Multimap InetAddressAndPort FetchReplica replicasToFetch new HashMap InetAddressAndPort myAddress FBUtilities getBroadcastAddressAndPort for String keyspaceName Schema instance getNonLocalStrategyKeyspaces
private void restoreReplicaCount InetAddressAndPort endpoint final InetAddressAndPort notifyEndpoint Map String Multimap InetAddressAndPort FetchReplica replicasToFetch new HashMap InetAddressAndPort myAddress FBUtilities getBroadcastAddressAndPort for String keyspaceName Schema instance getNonLocalStrategyKeyspaces logger debug keyspaceName EndpointsByReplica changedReplicas getChangedReplicasForLeaving keyspaceName endpoint tokenMetadata Keyspace open keyspaceName getReplicationStrategy Set LeavingReplica myNewReplicas new HashSet for Map Entry Replica Replica entry changedReplicas flattenEntries Replica replica entry getValue if replica endpoint equals myAddress myNewReplicas add new LeavingReplica entry getKey entry getValue logger debug changedReplicas myNewReplicas replicasToFetch put keyspaceName getNewSourceReplicas keyspaceName myNewReplicas StreamPlan stream new StreamPlan StreamOperation RESTORE_REPLICA_COUNT replicasToFetch forEach keyspaceName sources
InetAddressAndPort myAddress FBUtilities getBroadcastAddressAndPort for String keyspaceName Schema instance getNonLocalStrategyKeyspaces logger debug keyspaceName EndpointsByReplica changedReplicas getChangedReplicasForLeaving keyspaceName endpoint tokenMetadata Keyspace open keyspaceName getReplicationStrategy Set LeavingReplica myNewReplicas new HashSet for Map Entry Replica Replica entry changedReplicas flattenEntries Replica replica entry getValue if replica endpoint equals myAddress myNewReplicas add new LeavingReplica entry getKey entry getValue logger debug changedReplicas myNewReplicas replicasToFetch put keyspaceName getNewSourceReplicas keyspaceName myNewReplicas StreamPlan stream new StreamPlan StreamOperation RESTORE_REPLICA_COUNT replicasToFetch forEach keyspaceName sources logger debug keyspaceName sources asMap forEach sourceAddress fetchReplicas
public int verify boolean extendedVerify boolean checkVersion boolean diskFailurePolicy boolean mutateRepairStatus boolean checkOwnsTokens boolean quick String keyspaceName String tableNames throws IOException ExecutionException InterruptedException CompactionManager AllSSTableOpStatus status CompactionManager AllSSTableOpStatus SUCCESSFUL Verifier Options options Verifier options invokeDiskFailurePolicy diskFailurePolicy extendedVerification extendedVerify checkVersion checkVersion mutateRepairStatus mutateRepairStatus checkOwnsTokens checkOwnsTokens quick quick build
public void forceKeyspaceFlush String keyspaceName String tableNames throws IOException for ColumnFamilyStore cfStore getValidColumnFamilies true false keyspaceName tableNames
private void leaveRing SystemKeyspace setBootstrapState SystemKeyspace BootstrapState NEEDS_BOOTSTRAP tokenMetadata removeEndpoint FBUtilities getBroadcastAddressAndPort PendingRangeCalculatorService instance update Gossiper instance addLocalApplicationState ApplicationState STATUS_WITH_PORT valueFactory left getLocalTokens Gossiper computeExpireTime Gossiper instance addLocalApplicationState ApplicationState STATUS valueFactory left getLocalTokens Gossiper computeExpireTime int delay Math max RING_DELAY Gossiper intervalInMillis
if oldSnitch DynamicEndpointSnitch DynamicEndpointSnitch oldSnitch close IEndpointSnitch newSnitch try newSnitch DatabaseDescriptor createEndpointSnitch dynamic null dynamic epSnitchClassName catch ConfigurationException e throw new ClassNotFoundException e getMessage if newSnitch DynamicEndpointSnitch logger info DynamicEndpointSnitch newSnitch subsnitch getClass getName DatabaseDescriptor getDynamicUpdateInterval DatabaseDescriptor getDynamicResetInterval DatabaseDescriptor getDynamicBadnessThreshold else logger info newSnitch getClass getName DatabaseDescriptor setEndpointSnitch newSnitch for String ks Schema instance getKeyspaces Keyspace open ks getReplicationStrategy snitch newSnitch else if oldSnitch DynamicEndpointSnitch
private Future StreamState streamRanges Map String EndpointsByReplica rangesToStreamByKeyspace Map String RangesByEndpoint sessionsToStreamByKeyspace new HashMap for Map Entry String EndpointsByReplica entry rangesToStreamByKeyspace entrySet String keyspace entry getKey EndpointsByReplica rangesWithEndpoints entry getValue if rangesWithEndpoints isEmpty continue Map InetAddressAndPort Set Range Token transferredRangePerKeyspace SystemKeyspace getTransferredRanges keyspace StorageService instance getTokenMetadata partitioner RangesByEndpoint Builder replicasPerEndpoint new RangesByEndpoint Builder for Map Entry Replica Replica endPointEntry rangesWithEndpoints flattenEntries Replica local endPointEntry getKey Replica remote endPointEntry getValue Set Range Token transferredRanges transferredRangePerKeyspace get remote endpoint if transferredRanges null transferredRanges contains local range
public void setTombstoneWarnThreshold int threshold DatabaseDescriptor setTombstoneWarnThreshold threshold
public void setTombstoneFailureThreshold int threshold DatabaseDescriptor setTombstoneFailureThreshold threshold
public void setCachedReplicaRowsWarnThreshold int threshold DatabaseDescriptor setCachedReplicaRowsWarnThreshold threshold
public void setCachedReplicaRowsFailThreshold int threshold DatabaseDescriptor setCachedReplicaRowsFailThreshold threshold
public void setColumnIndexCacheSize int cacheSizeInKB DatabaseDescriptor setColumnIndexCacheSize cacheSizeInKB
public void setBatchSizeFailureThreshold int threshold DatabaseDescriptor setBatchSizeFailThresholdInKB threshold
public void setBatchSizeWarnThreshold int threshold DatabaseDescriptor setBatchSizeWarnThresholdInKB threshold
public void setHintedHandoffThrottleInKB int throttleInKB DatabaseDescriptor setHintedHandoffThrottleInKB throttleInKB
public void enableAuditLog String loggerName Map String String parameters String includedKeyspaces String excludedKeyspaces String includedCategories String excludedCategories String includedUsers String excludedUsers throws ConfigurationException IllegalStateException loggerName loggerName null loggerName DatabaseDescriptor getAuditLoggingOptions logger class_name Preconditions checkNotNull loggerName Preconditions checkState FBUtilities isAuditLoggerClassExists loggerName loggerName AuditLogOptions auditLogOptions new AuditLogOptions auditLogOptions enabled true auditLogOptions logger new ParameterizedClass loggerName parameters auditLogOptions included_keyspaces includedKeyspaces null includedKeyspaces DatabaseDescriptor getAuditLoggingOptions included_keyspaces auditLogOptions excluded_keyspaces excludedKeyspaces null excludedKeyspaces DatabaseDescriptor getAuditLoggingOptions excluded_keyspaces auditLogOptions included_categories includedCategories null includedCategories DatabaseDescriptor getAuditLoggingOptions included_categories auditLogOptions excluded_categories excludedCategories null excludedCategories DatabaseDescriptor getAuditLoggingOptions excluded_categories auditLogOptions included_users includedUsers null includedUsers DatabaseDescriptor getAuditLoggingOptions included_users auditLogOptions excluded_users excludedUsers null excludedUsers DatabaseDescriptor getAuditLoggingOptions excluded_users AuditLogManager instance enable auditLogOptions
public void setCorruptedTombstoneStrategy String strategy DatabaseDescriptor setCorruptedTombstoneStrategy Config CorruptedTombstoneStrategy valueOf strategy
private void incrementCachedRows currentRowsCached if currentRowsCached cachedRowsFailThreshold String message String format cachedRowsFailThreshold command toCQLString
public void doVerb Message msg StorageService instance confirmReplication msg from
private void startSession StreamSession session session start
public static synchronized StreamResultFuture createFollower int sessionIndex UUID planId StreamOperation streamOperation InetAddressAndPort from Channel channel UUID pendingRepair PreviewKind previewKind StreamResultFuture future StreamManager instance getReceivingStream planId if future null
void handleSessionPrepared StreamSession session SessionInfo sessionInfo session getSessionInfo
void handleSessionComplete StreamSession session
public synchronized Future onError Throwable e boolean isEofException e EOFException if isEofException if state finalState
private void logError Throwable e if e SocketTimeoutException
public void complete int sequenceNumber boolean signalComplete synchronized this ScheduledFuture timeout timeoutTasks remove sequenceNumber if timeout null timeout cancel false OutgoingStreamMessage stream streams remove sequenceNumber if stream null stream complete
java util concurrent Future onControlMessageComplete Future future StreamMessage msg ChannelFuture channelFuture ChannelFuture future Throwable cause future cause if cause null return null Channel channel channelFuture channel
if partition staticRow null if partition staticRow isEmpty serializeRow partition staticRow updatePosition Unfiltered unfiltered while partition hasNext unfiltered partition next if unfiltered Row serializeRow Row unfiltered else if unfiltered RangeTombstoneMarker serializeTombstone RangeTombstoneMarker unfiltered updatePosition json writeEndArray json writeEndObject catch IOException e String key metadata partitionKeyType getString partition partitionKey getKey
if cd column isSimple serializeCell Cell cd liveInfo else ComplexColumnData complexData ComplexColumnData cd if complexData complexDeletion isLive try objectIndenter setCompact true json writeStartObject json writeFieldName json writeString cd column name toCQLString serializeDeletion complexData complexDeletion objectIndenter setCompact true json writeEndObject objectIndenter setCompact false catch IOException e
limit Long MAX_VALUE if count limit noSpamLogger error limit count ctx close else long perIpLimit DatabaseDescriptor getNativeTransportMaxConcurrentConnectionsPerIp if perIpLimit InetAddress address InetSocketAddress ctx channel remoteAddress getAddress AtomicLong perIpCount connectionsPerClient get address if perIpCount null perIpCount new AtomicLong AtomicLong old connectionsPerClient putIfAbsent address perIpCount if old null perIpCount old if perIpCount incrementAndGet perIpLimit
public T decode ByteBuf body ProtocolVersion version if ProtocolVersion SUPPORTED contains version
public static InetAddress getJustLocalAddress if localInetAddress null if DatabaseDescriptor getListenAddress null try localInetAddress InetAddress getLocalHost
private static void inspectCommitLogError Throwable t if StorageService instance isDaemonSetupCompleted
public static List TreeRange difference MerkleTree ltree MerkleTree rtree if ltree fullRange equals rtree fullRange throw new IllegalArgumentException ltree fullRange rtree fullRange ltree fillInnerHashes rtree fillInnerHashes List TreeRange diff new ArrayList TreeRange active new TreeRange ltree fullRange left ltree fullRange right Node lnode ltree root Node rnode rtree root if lnode hashesDiffer rnode if lnode Leaf rnode Leaf
public static List TreeRange difference MerkleTree ltree MerkleTree rtree if ltree fullRange equals rtree fullRange throw new IllegalArgumentException ltree fullRange rtree fullRange ltree fillInnerHashes rtree fillInnerHashes List TreeRange diff new ArrayList TreeRange active new TreeRange ltree fullRange left ltree fullRange right Node lnode ltree root Node rnode rtree root if lnode hashesDiffer rnode if lnode Leaf rnode Leaf logger debug lnode rnode diff add active else logger debug ltree rtree if FULLY_INCONSISTENT differenceHelper ltree rtree diff active
VisibleForTesting static Difference differenceHelper MerkleTree ltree MerkleTree rtree List TreeRange diff TreeRange active if active depth Byte MAX_VALUE return CONSISTENT Token midpoint ltree partitioner midpoint active left active right if midpoint equals active left midpoint equals active right
if midpoint equals active left midpoint equals active right logger debug active depth midpoint active return FULLY_INCONSISTENT TreeRange left new TreeRange active left midpoint active depth TreeRange right new TreeRange midpoint active right active depth logger debug active depth left right active midpoint Node lnode rnode lnode ltree find left rnode rtree find left Difference ldiff CONSISTENT if null lnode null rnode lnode hashesDiffer rnode logger debug active depth left lnode rnode if lnode Leaf ldiff FULLY_INCONSISTENT else ldiff differenceHelper ltree rtree diff left else if null lnode null rnode
logger debug active depth left right active midpoint Node lnode rnode lnode ltree find left rnode rtree find left Difference ldiff CONSISTENT if null lnode null rnode lnode hashesDiffer rnode logger debug active depth left lnode rnode if lnode Leaf ldiff FULLY_INCONSISTENT else ldiff differenceHelper ltree rtree diff left else if null lnode null rnode logger debug active depth left ldiff FULLY_INCONSISTENT lnode ltree find right rnode rtree find right Difference rdiff CONSISTENT
Difference ldiff CONSISTENT if null lnode null rnode lnode hashesDiffer rnode logger debug active depth left lnode rnode if lnode Leaf ldiff FULLY_INCONSISTENT else ldiff differenceHelper ltree rtree diff left else if null lnode null rnode logger debug active depth left ldiff FULLY_INCONSISTENT lnode ltree find right rnode rtree find right Difference rdiff CONSISTENT if null lnode null rnode lnode hashesDiffer rnode logger debug active depth right lnode rnode if rnode Leaf rdiff FULLY_INCONSISTENT else rdiff differenceHelper ltree rtree diff right
if lnode Leaf ldiff FULLY_INCONSISTENT else ldiff differenceHelper ltree rtree diff left else if null lnode null rnode logger debug active depth left ldiff FULLY_INCONSISTENT lnode ltree find right rnode rtree find right Difference rdiff CONSISTENT if null lnode null rnode lnode hashesDiffer rnode logger debug active depth right lnode rnode if rnode Leaf rdiff FULLY_INCONSISTENT else rdiff differenceHelper ltree rtree diff right else if null lnode null rnode logger debug active depth right rdiff FULLY_INCONSISTENT
else if null lnode null rnode logger debug active depth left ldiff FULLY_INCONSISTENT lnode ltree find right rnode rtree find right Difference rdiff CONSISTENT if null lnode null rnode lnode hashesDiffer rnode logger debug active depth right lnode rnode if rnode Leaf rdiff FULLY_INCONSISTENT else rdiff differenceHelper ltree rtree diff right else if null lnode null rnode logger debug active depth right rdiff FULLY_INCONSISTENT if ldiff FULLY_INCONSISTENT rdiff FULLY_INCONSISTENT logger debug active depth left right
lnode ltree find right rnode rtree find right Difference rdiff CONSISTENT if null lnode null rnode lnode hashesDiffer rnode logger debug active depth right lnode rnode if rnode Leaf rdiff FULLY_INCONSISTENT else rdiff differenceHelper ltree rtree diff right else if null lnode null rnode logger debug active depth right rdiff FULLY_INCONSISTENT if ldiff FULLY_INCONSISTENT rdiff FULLY_INCONSISTENT logger debug active depth left right return FULLY_INCONSISTENT else if ldiff FULLY_INCONSISTENT logger debug active depth left
logger debug active depth right lnode rnode if rnode Leaf rdiff FULLY_INCONSISTENT else rdiff differenceHelper ltree rtree diff right else if null lnode null rnode logger debug active depth right rdiff FULLY_INCONSISTENT if ldiff FULLY_INCONSISTENT rdiff FULLY_INCONSISTENT logger debug active depth left right return FULLY_INCONSISTENT else if ldiff FULLY_INCONSISTENT logger debug active depth left diff add left return PARTIALLY_INCONSISTENT else if rdiff FULLY_INCONSISTENT logger debug active depth right
private static ByteBuffer allocate int innerNodeCount IPartitioner partitioner int size offHeapBufferSize innerNodeCount partitioner
private static void logStatus logger info String format for ThreadPoolMetrics tpool CassandraMetricsRegistry Metrics allThreadPoolMetrics
logger info String format for ThreadPoolMetrics tpool CassandraMetricsRegistry Metrics allThreadPoolMetrics logger info String format tpool poolName tpool activeTasks getValue tpool pendingTasks getValue tpool completedTasks getValue tpool currentBlocked getCount tpool totalBlocked getCount logger info String format CompactionManager instance getActiveCompactions CompactionManager instance getPendingTasks int pendingLargeMessages for int n MessagingService instance getLargeMessagePendingTasks values pendingLargeMessages n int pendingSmallMessages for int n MessagingService instance getSmallMessagePendingTasks values pendingSmallMessages n logger info String format pendingLargeMessages pendingSmallMessages AutoSavingCache KeyCacheKey RowIndexEntry keyCache CacheService instance keyCache AutoSavingCache RowCacheKey IRowCacheEntry rowCache CacheService instance rowCache int keyCacheKeysToSave DatabaseDescriptor getKeyCacheKeysToSave int rowCacheKeysToSave DatabaseDescriptor getRowCacheKeysToSave
for ThreadPoolMetrics tpool CassandraMetricsRegistry Metrics allThreadPoolMetrics logger info String format tpool poolName tpool activeTasks getValue tpool pendingTasks getValue tpool completedTasks getValue tpool currentBlocked getCount tpool totalBlocked getCount logger info String format CompactionManager instance getActiveCompactions CompactionManager instance getPendingTasks int pendingLargeMessages for int n MessagingService instance getLargeMessagePendingTasks values pendingLargeMessages n int pendingSmallMessages for int n MessagingService instance getSmallMessagePendingTasks values pendingSmallMessages n logger info String format pendingLargeMessages pendingSmallMessages AutoSavingCache KeyCacheKey RowIndexEntry keyCache CacheService instance keyCache AutoSavingCache RowCacheKey IRowCacheEntry rowCache CacheService instance rowCache int keyCacheKeysToSave DatabaseDescriptor getKeyCacheKeysToSave int rowCacheKeysToSave DatabaseDescriptor getRowCacheKeysToSave logger info String format
logger info String format tpool poolName tpool activeTasks getValue tpool pendingTasks getValue tpool completedTasks getValue tpool currentBlocked getCount tpool totalBlocked getCount logger info String format CompactionManager instance getActiveCompactions CompactionManager instance getPendingTasks int pendingLargeMessages for int n MessagingService instance getLargeMessagePendingTasks values pendingLargeMessages n int pendingSmallMessages for int n MessagingService instance getSmallMessagePendingTasks values pendingSmallMessages n logger info String format pendingLargeMessages pendingSmallMessages AutoSavingCache KeyCacheKey RowIndexEntry keyCache CacheService instance keyCache AutoSavingCache RowCacheKey IRowCacheEntry rowCache CacheService instance rowCache int keyCacheKeysToSave DatabaseDescriptor getKeyCacheKeysToSave int rowCacheKeysToSave DatabaseDescriptor getRowCacheKeysToSave logger info String format logger info String format keyCache weightedSize keyCache getCapacity keyCacheKeysToSave Integer MAX_VALUE keyCacheKeysToSave
logger info String format CompactionManager instance getActiveCompactions CompactionManager instance getPendingTasks int pendingLargeMessages for int n MessagingService instance getLargeMessagePendingTasks values pendingLargeMessages n int pendingSmallMessages for int n MessagingService instance getSmallMessagePendingTasks values pendingSmallMessages n logger info String format pendingLargeMessages pendingSmallMessages AutoSavingCache KeyCacheKey RowIndexEntry keyCache CacheService instance keyCache AutoSavingCache RowCacheKey IRowCacheEntry rowCache CacheService instance rowCache int keyCacheKeysToSave DatabaseDescriptor getKeyCacheKeysToSave int rowCacheKeysToSave DatabaseDescriptor getRowCacheKeysToSave logger info String format logger info String format keyCache weightedSize keyCache getCapacity keyCacheKeysToSave Integer MAX_VALUE keyCacheKeysToSave logger info String format rowCache weightedSize rowCache getCapacity rowCacheKeysToSave Integer MAX_VALUE rowCacheKeysToSave
public synchronized void onReleased int cycle File file chronicleStoreFiles offer file bytesInStoreFiles file length
public synchronized void onReleased int cycle File file chronicleStoreFiles offer file bytesInStoreFiles file length logger debug file getPath file length while bytesInStoreFiles maxLogSize chronicleStoreFiles isEmpty File toDelete chronicleStoreFiles poll long toDeleteLength toDelete length if toDelete delete
public void onReleased int cycle File file
private void archiveExisting Path path if path null return for File f path toFile listFiles f f isFile f getName endsWith SingleChronicleQueue SUFFIX try
private void archiveFile File f throws IOException String cmd PATH matcher archiveCommand replaceAll Matcher quoteReplacement f getAbsolutePath
private void fail String message Object params
private void fail String message Throwable t Object params
private void failinfo String message Object params
private String mkCasInsertQuery Function AtomicInteger Integer pkFunc int ck int v String query String format KEYSPACE pkFunc apply pkGen ck v
private void testLargeColumns int nodes int columnSize int rowCount throws Throwable Random random new Random long seed ThreadLocalRandom current nextLong
Test public void testBigInt int size IFilter bf getFilter size FilterTestHelper spec bucketsPerElement double fp testFalsePositives bf new KeyGenerator IntGenerator size new KeyGenerator IntGenerator size size
Test public void testBigRandom int size IFilter bf getFilter size FilterTestHelper spec bucketsPerElement double fp testFalsePositives bf new KeyGenerator RandomStringGenerator new Random nextInt size new KeyGenerator RandomStringGenerator new Random nextInt size
Test public void testConstrained int size try IFilter bf getFilter size double fp testFalsePositives bf new KeyGenerator IntGenerator size new KeyGenerator IntGenerator size size
for String summary summaries logger info summary List List String groups new ArrayList groups add Lists newArrayList groups add Lists newArrayList groups add Lists newArrayList Map String List String fullRows new HashMap for String workload Iterables concat groups CompactionSummary cs compactionSummaries get workload ReadSummary rs readSummaries get workload fullRows put workload Lists newArrayList Iterables concat cs null cs cells CompactionSummary EMPTY rs null rs cells ReadSummary EMPTY logger info logger info String header Joiner on join Iterables concat CompactionSummary HEADERS ReadSummary HEADERS for List String group groups logger info Joiner on join group
Test public void allocMeasuring long size ObjectSizes measure int numAlloc Measurement measurement createMeasurement measurement start for int i i numAlloc i new Integer i measurement stop
Test public void allocMeasuring long size ObjectSizes measure int numAlloc Measurement measurement createMeasurement measurement start for int i i numAlloc i new Integer i measurement stop logger info measurement prettyBytes
if PROFILING_READS compactionSampler start if PROFILING_COMPACTION workload name equals logger info Thread sleep for AbstractCompactionTask task tasks task execute active Thread sleep if PROFILING_COMPACTION workload name equals logger info Thread sleep compactionSampler stop Assert assertEquals cfs getLiveSSTables size int numPartitions Ints checkedCast Iterables getOnlyElement cfs getLiveSSTables getSSTableMetadata estimatedPartitionSize count int numRows Ints checkedCast Iterables getOnlyElement cfs getLiveSSTables getSSTableMetadata totalRows compactionSummary String format compactionSampler bytes compactionSampler bytes numPartitions compactionSampler bytes numRows compactionSampler cpu
if PROFILING_COMPACTION workload name equals logger info Thread sleep for AbstractCompactionTask task tasks task execute active Thread sleep if PROFILING_COMPACTION workload name equals logger info Thread sleep compactionSampler stop Assert assertEquals cfs getLiveSSTables size int numPartitions Ints checkedCast Iterables getOnlyElement cfs getLiveSSTables getSSTableMetadata estimatedPartitionSize count int numRows Ints checkedCast Iterables getOnlyElement cfs getLiveSSTables getSSTableMetadata totalRows compactionSummary String format compactionSampler bytes compactionSampler bytes numPartitions compactionSampler bytes numRows compactionSampler cpu compactionSummaries put workload name new CompactionSummary compactionSampler numPartitions numRows cfs truncateBlocking
logger info Thread sleep for AbstractCompactionTask task tasks task execute active Thread sleep if PROFILING_COMPACTION workload name equals logger info Thread sleep compactionSampler stop Assert assertEquals cfs getLiveSSTables size int numPartitions Ints checkedCast Iterables getOnlyElement cfs getLiveSSTables getSSTableMetadata estimatedPartitionSize count int numRows Ints checkedCast Iterables getOnlyElement cfs getLiveSSTables getSSTableMetadata totalRows compactionSummary String format compactionSampler bytes compactionSampler bytes numPartitions compactionSampler bytes numRows compactionSampler cpu compactionSummaries put workload name new CompactionSummary compactionSampler numPartitions numRows cfs truncateBlocking logger info
public static void flakyTest Runnable test int rerunsOnFailure String message AssertionError e runCatchingAssertionError test if e null return
public static void flakyTest Runnable test int rerunsOnFailure String message AssertionError e runCatchingAssertionError test if e null return logger info message e
public static void flakyTest Runnable test int rerunsOnFailure String message AssertionError e runCatchingAssertionError test if e null return logger info message e logger info rerunsOnFailure int rerunsFailed for int i i rerunsOnFailure i AssertionError t runCatchingAssertionError test if t null rerunsFailed e addSuppressed t
DatabaseDescriptor daemonInitialization DatabaseDescriptor setTransientReplicationEnabledUnsafe true CommitLog instance start try cleanupAndLeaveDirs catch IOException e logger error throw new RuntimeException e try remoteAddrs add InetAddressAndPort getByName catch UnknownHostException e logger error throw new RuntimeException e Thread setDefaultUncaughtExceptionHandler new Thread UncaughtExceptionHandler public void uncaughtException Thread t Throwable e
SystemKeyspace finishStartup VirtualKeyspaceRegistry instance register VirtualSchemaKeyspace instance StorageService instance initServer SchemaLoader startGossiper server new Server Builder withHost nativeAddr withPort nativePort build ClientMetrics instance init Collections singleton server server start for ProtocolVersion version PROTOCOL_VERSIONS if clusters containsKey version continue Cluster Builder builder Cluster builder withoutJMXReporting addContactPoints nativeAddr withClusterName withPort nativePort if version isBeta builder builder allowBetaProtocolVersion else builder builder withProtocolVersion com datastax driver core ProtocolVersion fromInt version asInt Cluster cluster builder build clusters put version cluster sessions put version cluster connect
protected String createType String query String typeName String format seqNumber getAndIncrement String fullQuery String format query KEYSPACE typeName types add typeName
protected void createFunctionOverload String functionName String argTypes String query throws Throwable String fullQuery String format query functionName functions add functionName argTypes
protected void createAggregateOverload String aggregateName String argTypes String query throws Throwable String fullQuery String format query aggregateName aggregates add aggregateName argTypes
protected String createKeyspace String query String currentKeyspace createKeyspaceName String fullQuery String format query currentKeyspace
protected void alterKeyspace String query String fullQuery String format query currentKeyspace
protected void alterKeyspaceMayThrow String query throws Throwable String fullQuery String format query currentKeyspace
protected String createTable String keyspace String query String currentTable createTableName String fullQuery formatQuery keyspace query
protected void createTableMayThrow String query throws Throwable String currentTable createTableName String fullQuery formatQuery query
protected void alterTable String query String fullQuery formatQuery query
protected void alterTableMayThrow String query throws Throwable String fullQuery formatQuery query
protected void dropFormattedTable String formattedQuery
protected String createFormattedIndex String formattedQuery
protected void createIndexMayThrow String query throws Throwable String fullQuery formatQuery query
protected void dropIndex String query throws Throwable String fullQuery String format query KEYSPACE
ByteBuffer actualValue actual getBytes column name toString if expectedByteValue null expectedByteValue expectedByteValue duplicate if Objects equal expectedByteValue actualValue Object actualValueDecoded actualValue null null column type getSerializer deserialize actualValue if Objects equal expected null expected j null actualValueDecoded Assert fail String format i j column name column type asCQL3Type formatValue expectedByteValue null expectedByteValue duplicate null column type formatValue actualValue column type i if iter hasNext while iter hasNext UntypedResultSet Row actual iter next i StringBuilder str new StringBuilder for int j j meta size j ColumnSpecification column meta get j ByteBuffer actualValue actual getBytes column name toString str append String format column name formatValue actualValue column type
Test public void testPartitionKeyFilteringUnrestrictedPart throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute
Test public void testPartitionKeyFilteringWithSlice throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute
Test public void testPartitionKeyRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute
Test public void testCompoundPartitionKeyRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute execute execute
Test public void testClusteringKeyEQRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute execute execute
Test public void testClusteringKeySliceRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute execute execute
Test public void testClusteringKeyINRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute execute execute execute
Test public void testClusteringKeyMultiColumnRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute execute execute execute
Test public void testClusteringKeyFilteringRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute execute execute execute
Test public void testPartitionKeyAndClusteringKeyFilteringRestrictions throws Throwable List String mvPrimaryKeys Arrays asList for int i i mvPrimaryKeys size i createTable execute keyspace executeNet protocolVersion keyspace execute execute execute execute execute execute execute execute execute
BeforeClass public static void setUp long seed System currentTimeMillis
private void expectCurrentCDCState CDCState expectedState CDCState currentState CommitLog instance segmentManager allocatingFrom getCDCState if currentState expectedState
public void testSSTablesAssignedToCorrectCompactionStrategy int numSSTables int numDisks MockCFS cfs createJBODMockCFS numDisks assertEquals numSSTables cfs getLiveSSTables size final Integer boundaries computeBoundaries numSSTables numDisks MockBoundaryManager mockBoundaryManager new MockBoundaryManager cfs boundaries
private int getSSTableIndex Integer boundaries SSTableReader reader int index int firstKey Integer parseInt new String ByteBufferUtil getArray reader first getKey while boundaries index firstKey index
BeforeClass public static void defineSchema throws ConfigurationException long seed System nanoTime
inserted add key cfs forceBlockingFlush CompactionsTest assertMaxTimestamp cfs maxTimestampExpected assertEquals inserted toString inserted size Util getAll Util cmd cfs build size Collection SSTableReader sstables cfs getLiveSSTables int currentSSTable for SSTableReader sstable sstables if currentSSTable SSTABLES_TO_CORRUPT break RandomAccessFile raf null try int corruptionSize raf new RandomAccessFile sstable getFilename assertNotNull raf assertTrue raf length corruptionSize long pos random nextInt int raf length corruptionSize
cfs disableAutoCompaction makeSSTables List SSTableReader sstables new ArrayList cfs getLiveSSTables List SSTableReader expected sstables subList Collection Range Token ranges new HashSet for SSTableReader sstable expected ranges add new Range sstable first getToken sstable last getToken PendingAntiCompaction AcquisitionCallable acquisitionCallable new PendingAntiCompaction AcquisitionCallable cfs ranges UUIDGen getTimeUUID logger info sstables logger info expected PendingAntiCompaction AcquireResult result acquisitionCallable call assertNotNull result logger info result txn originals assertEquals result txn originals size for SSTableReader sstable expected
public void deleteStaleEntry DecoratedKey indexKey Clustering indexClustering DeletionTime deletion WriteContext ctx doDelete indexKey indexClustering deletion ctx
private void insert ByteBuffer rowKey Clustering clustering Cell cell LivenessInfo info WriteContext ctx DecoratedKey valueKey getIndexKeyFor getIndexedValue rowKey clustering cell Row row BTreeRow noCellLiveRow buildIndexClustering rowKey clustering cell info PartitionUpdate upd partitionUpdate valueKey row indexCfs getWriteHandler write upd ctx UpdateTransaction NO_OP
private void doDelete DecoratedKey indexKey Clustering indexClustering DeletionTime deletion WriteContext ctx Row row BTreeRow emptyDeletedRow indexClustering Row Deletion regular deletion PartitionUpdate upd partitionUpdate indexKey row indexCfs getWriteHandler write upd ctx UpdateTransaction NO_OP
Test public void testMutateMetadata throws Exception for String legacyVersion legacyVersions
Test public void testMutateLevel throws Exception for String legacyVersion legacyVersions
private void doTestLegacyCqlTables throws Exception for String legacyVersion legacyVersions
Test public void testAutomaticUpgrade throws Exception for String legacyVersion legacyVersions
private void streamLegacyTables String legacyVersion throws Exception
private static void truncateLegacyTables String legacyVersion throws Exception
private static void compactLegacyTables String legacyVersion throws Exception
private static void loadLegacyTables String legacyVersion throws Exception
private static void verifyReads String legacyVersion for int ck ck ck String ckValue Integer toString ck longString for int pk pk pk
private static void readClusteringCounterTable String legacyVersion String ckValue String pkValue
private static void readClusteringTable String legacyVersion int ck String ckValue String pkValue
private static void readSimpleCounterTable String legacyVersion String pkValue
private static void readSimpleTable String legacyVersion String pkValue
private static void loadLegacyTable String tablePattern String legacyVersion throws IOException String table String format tablePattern legacyVersion
BeforeClass public static void setUp original DatabaseDescriptor getCorruptedTombstoneStrategy DatabaseDescriptor setCorruptedTombstoneStrategy Config CorruptedTombstoneStrategy disabled TableMetadata Builder cfm TableMetadata builder keyspace table addPartitionKeyColumn AsciiType instance addClusteringColumn AsciiType instance addClusteringColumn AsciiType instance addRegularColumn BytesType instance addRegularColumn BytesType instance compression CompressionParams noCompression SchemaLoader createKeyspace keyspace KeyspaceParams simple cfm cfs Keyspace open keyspace getColumnFamilyStore table cfs disableAutoCompaction maxValueSize DatabaseDescriptor getMaxValueSize DatabaseDescriptor setMaxValueSize long seed System nanoTime
private static ByteBuffer allocateBuffer int size ByteBuffer ret ByteBuffer allocate Ints checkedCast size long seed System nanoTime
int dcReplication new int IEndpointSnitch snitch new RackInferringSnitch DatabaseDescriptor setEndpointSnitch snitch TokenMetadata metadata new TokenMetadata Map String String configOptions new HashMap String String Multimap InetAddressAndPort Token tokens HashMultimap create int totalRF for int dc dc dcRacks length dc totalRF dcReplication dc configOptions put Integer toString dc Integer toString dcReplication dc for int rack rack dcRacks dc rack for int ep ep dcEndpoints dc dcRacks dc ep byte ipBytes new byte byte dc byte rack byte ep InetAddressAndPort address InetAddressAndPort getByAddress ipBytes StringToken token new StringToken String format ep rack dc
for int rack rack dcRacks dc rack for int ep ep dcEndpoints dc dcRacks dc ep byte ipBytes new byte byte dc byte rack byte ep InetAddressAndPort address InetAddressAndPort getByAddress ipBytes StringToken token new StringToken String format ep rack dc logger debug address token tokens put address token metadata updateNormalTokens tokens NetworkTopologyStrategy strategy new NetworkTopologyStrategy keyspaceName metadata snitch configOptions for String testToken new String EndpointsForRange replicas strategy calculateNaturalReplicas new StringToken testToken metadata Set InetAddressAndPort endpointSet replicas endpoints Assert assertEquals totalRF replicas size Assert assertEquals totalRF new HashSet replicas byEndpoint values size Assert assertEquals totalRF endpointSet size
private void doTestManual Settings settings ManualSendTest test throws Throwable InetAddressAndPort endpoint FBUtilities getBroadcastAddressAndPort InboundConnectionSettings inboundSettings settings inbound apply new InboundConnectionSettings withBindAddress endpoint withSocketFactory factory InboundSockets inbound new InboundSockets Collections singletonList inboundSettings OutboundConnectionSettings outboundTemplate settings outbound apply new OutboundConnectionSettings endpoint withDefaultReserveLimits withSocketFactory factory withDefaults ConnectionCategory MESSAGING ResourceLimits EndpointAndGlobal reserveCapacityInBytes new ResourceLimits EndpointAndGlobal new ResourceLimits Concurrent outboundTemplate applicationSendQueueReserveEndpointCapacityInBytes outboundTemplate applicationSendQueueReserveGlobalCapacityInBytes OutboundConnection outbound new OutboundConnection settings type outboundTemplate reserveCapacityInBytes try
Test public void testPendingOutboundConnectionUpdatesMessageVersionOnReconnectAttempt throws Throwable final String storagePortProperty Config PROPERTY_PREFIX final String originalStoragePort System getProperty storagePortProperty try final Settings settings Settings LARGE final InetAddressAndPort endpoint FBUtilities getBroadcastAddressAndPort MessagingService instance versions set FBUtilities getBroadcastAddressAndPort MessagingService VERSION_40 System setProperty storagePortProperty final InetAddressAndPort legacySSLAddrsAndPort endpoint withPort DatabaseDescriptor getSSLStoragePort InboundConnectionSettings inboundSettings settings inbound apply new InboundConnectionSettings withEncryption encryptionOptions withBindAddress legacySSLAddrsAndPort withAcceptMessaging new AcceptVersions VERSION_30 VERSION_3014 withSocketFactory factory InboundSockets inbound new InboundSockets Collections singletonList inboundSettings OutboundConnectionSettings outboundTemplate settings outbound apply new OutboundConnectionSettings endpoint withEncryption encryptionOptions withDefaultReserveLimits withSocketFactory factory withDefaults ConnectionCategory MESSAGING ResourceLimits EndpointAndGlobal reserveCapacityInBytes new ResourceLimits EndpointAndGlobal new ResourceLimits Concurrent outboundTemplate applicationSendQueueReserveEndpointCapacityInBytes outboundTemplate applicationSendQueueReserveGlobalCapacityInBytes OutboundConnection outbound new OutboundConnection settings type outboundTemplate reserveCapacityInBytes try
private static V void randomize List V list long seed ThreadLocalRandom current nextLong
private void testSomeFrames FrameEncoder encoder FrameDecoder decoder long seed new SecureRandom nextLong
private void burnRandomLegacy int count SecureRandom seed new SecureRandom Random random new Random for int i i count i long innerSeed seed nextLong float ratio seed nextFloat int version minimum_version random nextInt current_version minimum_version
private void testSomeMessages long seed int count float largeRatio int messagingVersion FrameDecoder decoder
private void testSomeMessages long seed int count float largeRatio int messagingVersion FrameDecoder decoder logger info seed count largeRatio messagingVersion decoder getClass getSimpleName Random random new Random seed for int i i count i long innerSeed random nextLong
private void invokeCalculateRangesToFetchWithPreferredEndpoints RangesAtEndpoint toFetch Pair TokenMetadata TokenMetadata tmds EndpointsByReplica expectedResult DatabaseDescriptor setTransientReplicationEnabledUnsafe true EndpointsByReplica result RangeStreamer calculateRangesToFetchWithPreferredEndpoints address replicas replicas sorted a b b endpoint compareTo a endpoint simpleStrategy tmds left toFetch true tmds left tmds right sourceFilters logger info
private void invokeCalculateRangesToStreamWithPreferredEndpoints RangesAtEndpoint toStream Pair TokenMetadata TokenMetadata tmds RangesByEndpoint expectedResult DatabaseDescriptor setTransientReplicationEnabledUnsafe true RangeRelocator relocator new RangeRelocator RangesByEndpoint result relocator calculateRangesToStreamWithEndpoints toStream simpleStrategy tmds left tmds left tmds right logger info
private boolean areDisjunctive List ILoggingEvent firstThreadEvents List ILoggingEvent secondThreadEvents Range Long firstThreadTimeRange timestampsRange firstThreadEvents Range Long secondThreadTimeRange timestampsRange secondThreadEvents boolean connected firstThreadTimeRange isConnected secondThreadTimeRange boolean disjunctive connected firstThreadTimeRange intersection secondThreadTimeRange isEmpty
private void verifyStatusWasPrintedAndBusyEventOccured List ILoggingEvent firstThreadEvents List ILoggingEvent secondThreadEvents if firstThreadEvents size secondThreadEvents size
Statement statement query toStatement for Session session sessions maybeSetKeyspace session query if logger isDebugEnabled logger debug query ListenableFuture ResultSet future session executeAsync statement results add handleErrors future ListenableFuture List ResultHandler ComparableResultSet resultList Futures allAsList results Futures addCallback resultList new FutureCallback List ResultHandler ComparableResultSet public void onSuccess List ResultHandler ComparableResultSet resultSets resultHandler handleResults query resultSets public void onFailure Throwable throwable throw new AssertionError throwable es FBUtilities waitOnFuture resultList catch Throwable t
